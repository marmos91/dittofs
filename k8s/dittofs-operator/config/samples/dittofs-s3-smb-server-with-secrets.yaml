# DittoFS configuration with SMB and JWT/admin secrets
# Infrastructure-only config - stores, shares, users managed via REST API
#
# This example shows how to configure:
# - JWT secret for API authentication
# - Admin password hash for initial admin user
# - PostgreSQL database (optional, via secret)
#
apiVersion: dittofs.dittofs.com/v1alpha1
kind: DittoServer
metadata:
  name: dittofs-s3-smb-server-with-secrets
  labels:
    app.kubernetes.io/name: dittofs-operator
    app.kubernetes.io/managed-by: kubectl
spec:
  image: marmos91c/dittofs:latest
  replicas: 1

  # Storage for internal server data
  storage:
    metadataSize: "1Gi"
    contentSize: "1Gi"

  # Control plane database - using PostgreSQL via secret
  database:
    type: postgres
    postgresSecretRef:
      name: postgres-credentials
      key: connection-string

  # WAL-backed cache
  cache:
    path: "/data/cache"
    size: "2GB"

  # Control plane REST API
  controlPlane:
    port: 8080

  # Identity configuration with JWT and admin secrets
  identity:
    type: memory
    jwt:
      secretRef:
        name: dittofs-jwt-secret
        key: jwt-signing-key
      accessTokenDuration: "15m"
      refreshTokenDuration: "168h"
      issuer: "dittofs"
    admin:
      username: "admin"
      passwordSecretRef:
        name: dittofs-admin-secret
        key: password-hash

  # Metrics enabled
  metrics:
    enabled: true
    port: 9090

  # NFS server port
  nfsPort: 2049

  # SMB configuration
  smb:
    enabled: true
    port: 12445
    maxConnections: 100
    maxRequestsPerConnection: 50
    timeouts:
      read: "5m"
      write: "30s"
      idle: "5m"
      shutdown: "30s"
    credits:
      strategy: "adaptive"
      minGrant: 16
      maxGrant: 8192
      initialGrant: 256
      maxSessionCredits: 65535
    metricsLogInterval: "5m"

  # Service configuration
  service:
    type: ClusterIP

  # Resource configuration
  resources:
    limits:
      cpu: "2"
      memory: "4Gi"
    requests:
      cpu: "500m"
      memory: "1Gi"

---
# Secret for PostgreSQL connection string
apiVersion: v1
kind: Secret
metadata:
  name: postgres-credentials
  labels:
    app.kubernetes.io/name: dittofs-operator
type: Opaque
data:
  # Base64 encoded PostgreSQL connection string
  # echo -n "postgres://user:password@host:5432/dittofs?sslmode=disable" | base64
  connection-string: cG9zdGdyZXM6Ly91c2VyOnBhc3N3b3JkQGhvc3Q6NTQzMi9kaXR0b2ZzP3NzbG1vZGU9ZGlzYWJsZQ==

---
# Secret for JWT signing key
apiVersion: v1
kind: Secret
metadata:
  name: dittofs-jwt-secret
  labels:
    app.kubernetes.io/name: dittofs-operator
type: Opaque
data:
  # Base64 encoded JWT signing key (at least 32 characters)
  # echo -n "your-super-secret-jwt-signing-key-at-least-32-chars" | base64
  jwt-signing-key: eW91ci1zdXBlci1zZWNyZXQtand0LXNpZ25pbmcta2V5LWF0LWxlYXN0LTMyLWNoYXJz

---
# Secret for admin password hash
apiVersion: v1
kind: Secret
metadata:
  name: dittofs-admin-secret
  labels:
    app.kubernetes.io/name: dittofs-operator
type: Opaque
data:
  # Base64 encoded bcrypt password hash
  # Generate hash: htpasswd -bnBC 10 "" adminpassword | tr -d ':\n'
  # Then encode: echo -n '$2y$10$...' | base64
  password-hash: JDJ5JDEwJHh5ei4uLg==
