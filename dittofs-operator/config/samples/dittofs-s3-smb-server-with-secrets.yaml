apiVersion: dittofs.dittofs.com/v1alpha1
kind: DittoServer
metadata:
  name: dittofs-s3-smb-server-with-secrets
  labels:
    app.kubernetes.io/name: dittofs-operator
    app.kubernetes.io/managed-by: kubectl
spec:
  image: marmos91c/dittofs:latest
  replicas: 1
  
  storage:
    metadataSize: "1Gi"
    contentSize: "1Gi"
  
  config:
    backends:
      - name: badger-metadata
        type: badger
        config:
          path: /data/metadata
      
      - name: s3-content
        type: s3
        config:
          bucket: dittofs-bucket
          region: us-east-1
        # Use secret references for sensitive data
        secretRefs:
          access_key_id:
            name: s3-credentials
            key: access-key-id
          secret_access_key:
            name: s3-credentials
            key: secret-access-key
    
    caches:
      - name: s3-cache
        type: memory
        memory:
          maxSize: "2Gi"
        prefetch:
          enabled: true
          maxFileSize: "100Mi"
          chunkSize: "512Ki"
        flusher:
          interval: "10s"
          flushTimeout: "30s"
          workers: 4
    
    shares:
      - name: s3-share
        exportPath: /s3
        metadataStore: badger-metadata
        contentStore: s3-content
        cache: s3-cache
        readOnly: false
        allowedClients: []
        requireAuth: false
        allowedAuthMethods: ["anonymous", "unix"]
        allowGuest: true
        defaultPermission: "read-write"
        rootDirectoryAttributes:
          mode: 0777
          uid: 0
          gid: 0
  
  nfsPort: 2049
  
  # SMB configuration
  smb:
    enabled: true
    port: 12445
    maxConnections: 100
    maxRequestsPerConnection: 50
    timeouts:
      read: "5m"
      write: "30s"
      idle: "5m"
      shutdown: "30s"
    credits:
      strategy: "adaptive"
      minGrant: 16
      maxGrant: 8192
      initialGrant: 256
      maxSessionCredits: 65535
    metricsLogInterval: "5m"
  
  # User management with secret references
  users:
    guest:
      enabled: true
      uid: 65534
      gid: 65534
      sharePermissions:
        "/s3": "read-write"
    users:
      - username: testuser
        # Use secret reference instead of inline password hash
        passwordSecretRef:
          name: user-credentials
          key: testuser-password-hash
        enabled: true
        uid: 1000
        gid: 1000
        sharePermissions:
          "/s3": "read-write"
      - username: alice
        passwordSecretRef:
          name: user-credentials
          key: alice-password-hash
        enabled: true
        uid: 1001
        gid: 1001
        sharePermissions:
          "/s3": "read-write"
  
  service:
    type: ClusterIP
  
  resources:
    limits:
      cpu: "2"
      memory: "4Gi"
    requests:
      cpu: "500m"
      memory: "1Gi"

---
# Secret for S3 credentials
apiVersion: v1
kind: Secret
metadata:
  name: s3-credentials
  labels:
    app.kubernetes.io/name: dittofs-operator
type: Opaque
data:
  # Base64 encoded values - REPLACE WITH YOUR ACTUAL CREDENTIALS
  # echo -n "YOUR_AWS_ACCESS_KEY_ID" | base64
  access-key-id: WU9VUl9BV1NfQUNDRVNTX0tFWV9JRA==
  # echo -n "YOUR_AWS_SECRET_ACCESS_KEY" | base64
  secret-access-key: WU9VUl9BV1NfU0VDUkVUX0FDQ0VTU19LRVk=

---
# Secret for user password hashes
apiVersion: v1
kind: Secret
metadata:
  name: user-credentials
  labels:
    app.kubernetes.io/name: dittofs-operator
type: Opaque
data:
  # Base64 encoded bcrypt password hashes
  # For password "testpass123": echo -n '$2y$05$R6mOPa8hawc24Vs16Dh91.TdEdC2amcdy3wLcOy/lJdZdJXViz0ia' | base64
  testuser-password-hash: JDJ5JDA1JFI2bU9QYThoYXdjMjRWczE2RGg5MS5UZEVkQzJhbWNkeTN3TGNPeS9sSmRaZEpYVml6MGlh
  # For password "alicepass": echo -n '$2y$10$xyz...' | base64 (replace with actual hash)
  alice-password-hash: JDJ5JDEwJHh5ei4uLg==
