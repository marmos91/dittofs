apiVersion: dittofs.dittofs.com/v1alpha1
kind: DittoServer
metadata:
  name: dittofs-s3-smb-server
  labels:
    app.kubernetes.io/name: dittofs-operator
    app.kubernetes.io/managed-by: kubectl
spec:
  image: dittofs:latest
  replicas: 1
  
  storage:
    metadataSize: "1Gi"
    contentSize: "1Gi"
  
  config:
    backends:
      - name: badger-metadata
        type: badger
        config:
          path: /data/metadata
      
      - name: s3-content
        type: s3
        config:
          bucket: dittofs-bucket
          region: us-east-1
          access_key_id: <access_key_id>
          secret_access_key: <secret_access_key>
    
    caches:
      - name: s3-cache
        type: memory
        memory:
          maxSize: "2Gi"
        prefetch:
          enabled: true
          maxFileSize: "100Mi"
          chunkSize: "512Ki"
        flusher:
          interval: "10s"
          flushTimeout: "30s"
          workers: 4
    
    shares:
      - name: s3-share
        exportPath: /s3
        metadataStore: badger-metadata
        contentStore: s3-content
        cache: s3-cache
        readOnly: false
        allowedClients: []
        requireAuth: false
        allowedAuthMethods: ["anonymous", "unix"]
        allowGuest: true
        defaultPermission: "read-write"
        rootDirectoryAttributes:
          mode: 0777  # Allow write for everyone
          uid: 0      # Root ownership
          gid: 0      # Root group
  
  # NFS configuration
  nfsPort: 2049
  
  # SMB configuration
  smb:
    enabled: true
    port: 12445
    maxConnections: 100
    maxRequestsPerConnection: 50
    timeouts:
      read: "5m"
      write: "30s"
      idle: "5m"
      shutdown: "30s"
    credits:
      strategy: "adaptive"
      minGrant: 16
      maxGrant: 8192
      initialGrant: 256
      maxSessionCredits: 65535
    metricsLogInterval: "5m"
  
  # User management for SMB
  users:
    guest:
      enabled: true
      uid: 65534
      gid: 65534
      sharePermissions:
        "/s3": "read-write"
    users:
      - username: testuser
        passwordHash: "$2y$05$R6mOPa8hawc24Vs16Dh91.TdEdC2amcdy3wLcOy/lJdZdJXViz0ia"
        enabled: true
        uid: 1000
        gid: 1000
        sharePermissions:
          "/s3": "read-write"
  
  service:
    type: ClusterIP
  
  resources:
    limits:
      cpu: "2"
      memory: "4Gi"
    requests:
      cpu: "500m"
      memory: "1Gi"
      memory: "1Gi"
