# DittoFS Benchmark Suite - Docker Compose
#
# Usage: docker compose --profile <profile> up -d
#
# Run one profile at a time (sequential benchmarking).
#
# Profiles:
#   dittofs-badger-s3    BadgerDB metadata + S3 payload (NFS)
#   dittofs-postgres-s3  PostgreSQL metadata + S3 payload (NFS)
#   dittofs-badger-fs    BadgerDB metadata + filesystem payload (NFS)
#   dittofs-smb          BadgerDB metadata + S3 payload (SMB)
#   ganesha              NFS-Ganesha with FSAL_VFS
#   kernel-nfs           Linux kernel NFS (baseline)
#   rclone               RClone NFS over S3
#   juicefs              JuiceFS FUSE mount (PostgreSQL + S3)
#   samba                Samba SMB server

services:
  # ---------------------------------------------------------------------------
  # Infrastructure (activated via depends_on)
  # ---------------------------------------------------------------------------

  localstack:
    image: localstack/localstack:4.13.1
    profiles:
      - dittofs-badger-s3
      - dittofs-postgres-s3
      - dittofs-smb
      - juicefs
      - rclone
    environment:
      SERVICES: s3
      EAGER_SERVICE_LOADING: "1"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:4566/_localstack/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: "${BENCH_CPU_LIMIT:-2}"
          memory: "${BENCH_MEM_LIMIT:-4g}"

  postgres:
    image: postgres:16-alpine
    profiles:
      - dittofs-postgres-s3
      - juicefs
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-bench}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-bench}
      POSTGRES_DB: ${POSTGRES_DB:-bench}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-bench}"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: "${BENCH_CPU_LIMIT:-2}"
          memory: "${BENCH_MEM_LIMIT:-4g}"

  # ---------------------------------------------------------------------------
  # DittoFS (one service per backend combination)
  # ---------------------------------------------------------------------------

  dittofs-badger-s3:
    build:
      context: ..
      dockerfile: bench/docker/Dockerfile.dittofs
    profiles:
      - dittofs-badger-s3
    ports:
      - "12049:12049"
      - "${BENCH_API_PORT:-8080}:8080"
      - "6060:6060"
    depends_on:
      localstack:
        condition: service_healthy
    volumes:
      - ./configs/dittofs/badger-s3.yaml:/config/config.yaml:ro
      - ./scripts/bootstrap-dittofs.sh:/app/bootstrap.sh:ro
      - dittofs-data:/data
      - ./results:/results
    environment:
      DITTOFS_CONTROLPLANE_SECRET: ${DITTOFS_CONTROLPLANE_SECRET:-BenchmarkInfrastructureSecret32ch!}
      DITTOFS_ADMIN_INITIAL_PASSWORD: ${DITTOFS_ADMIN_INITIAL_PASSWORD:-benchadmin}
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health/ready"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "${BENCH_CPU_LIMIT:-2}"
          memory: "${BENCH_MEM_LIMIT:-4g}"

  dittofs-postgres-s3:
    build:
      context: ..
      dockerfile: bench/docker/Dockerfile.dittofs
    profiles:
      - dittofs-postgres-s3
    ports:
      - "12049:12049"
      - "${BENCH_API_PORT:-8080}:8080"
      - "6060:6060"
    depends_on:
      localstack:
        condition: service_healthy
      postgres:
        condition: service_healthy
    volumes:
      - ./configs/dittofs/postgres-s3.yaml:/config/config.yaml:ro
      - ./scripts/bootstrap-dittofs.sh:/app/bootstrap.sh:ro
      - dittofs-data:/data
      - ./results:/results
    environment:
      DITTOFS_CONTROLPLANE_SECRET: ${DITTOFS_CONTROLPLANE_SECRET:-BenchmarkInfrastructureSecret32ch!}
      DITTOFS_ADMIN_INITIAL_PASSWORD: ${DITTOFS_ADMIN_INITIAL_PASSWORD:-benchadmin}
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health/ready"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "${BENCH_CPU_LIMIT:-2}"
          memory: "${BENCH_MEM_LIMIT:-4g}"

  dittofs-badger-fs:
    build:
      context: ..
      dockerfile: bench/docker/Dockerfile.dittofs
    profiles:
      - dittofs-badger-fs
    ports:
      - "12049:12049"
      - "${BENCH_API_PORT:-8080}:8080"
      - "6060:6060"
    volumes:
      - ./configs/dittofs/badger-fs.yaml:/config/config.yaml:ro
      - ./scripts/bootstrap-dittofs.sh:/app/bootstrap.sh:ro
      - dittofs-data:/data
      - ./results:/results
    environment:
      DITTOFS_CONTROLPLANE_SECRET: ${DITTOFS_CONTROLPLANE_SECRET:-BenchmarkInfrastructureSecret32ch!}
      DITTOFS_ADMIN_INITIAL_PASSWORD: ${DITTOFS_ADMIN_INITIAL_PASSWORD:-benchadmin}
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health/ready"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "${BENCH_CPU_LIMIT:-2}"
          memory: "${BENCH_MEM_LIMIT:-4g}"

  # Uses badger-s3 base config; the bootstrap script enables the SMB adapter
  dittofs-smb:
    build:
      context: ..
      dockerfile: bench/docker/Dockerfile.dittofs
    profiles:
      - dittofs-smb
    ports:
      - "12445:12445"
      - "${BENCH_API_PORT:-8080}:8080"
      - "6060:6060"
    depends_on:
      localstack:
        condition: service_healthy
    volumes:
      - ./configs/dittofs/badger-s3.yaml:/config/config.yaml:ro
      - ./scripts/bootstrap-dittofs.sh:/app/bootstrap.sh:ro
      - dittofs-data:/data
      - ./results:/results
    environment:
      DITTOFS_CONTROLPLANE_SECRET: ${DITTOFS_CONTROLPLANE_SECRET:-BenchmarkInfrastructureSecret32ch!}
      DITTOFS_ADMIN_INITIAL_PASSWORD: ${DITTOFS_ADMIN_INITIAL_PASSWORD:-benchadmin}
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/health/ready"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "${BENCH_CPU_LIMIT:-2}"
          memory: "${BENCH_MEM_LIMIT:-4g}"

  # ---------------------------------------------------------------------------
  # Competitors
  # ---------------------------------------------------------------------------

  ganesha:
    image: apnar/nfs-ganesha:latest
    profiles:
      - ganesha
    ports:
      - "22049:2049"
    volumes:
      - ./configs/ganesha/ganesha.conf:/etc/ganesha/ganesha.conf:ro
      - ganesha-data:/export
    cap_add:
      - SYS_ADMIN
    healthcheck:
      test: ["CMD", "showmount", "-e", "localhost"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: "${BENCH_CPU_LIMIT:-2}"
          memory: "${BENCH_MEM_LIMIT:-4g}"

  kernel-nfs:
    image: erichough/nfs-server:2.2.1
    profiles:
      - kernel-nfs
    ports:
      - "32049:2049"
      - "32111:111"
    volumes:
      - kernel-nfs-data:/export
    environment:
      NFS_EXPORT_0: "/export *(rw,no_subtree_check,no_root_squash,fsid=0)"
    cap_add:
      - SYS_ADMIN
    healthcheck:
      test: ["CMD", "showmount", "-e", "localhost"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "${BENCH_CPU_LIMIT:-2}"
          memory: "${BENCH_MEM_LIMIT:-4g}"

  rclone:
    image: rclone/rclone:1.73.1
    profiles:
      - rclone
    ports:
      - "42049:42049"
    volumes:
      - ./configs/rclone/rclone.conf:/config/rclone/rclone.conf:ro
      - rclone-cache:/tmp/rclone-cache
    command: >
      serve nfs localstack-s3:
      --addr 0.0.0.0:42049
      --vfs-cache-mode full
      --vfs-cache-max-size ${BENCH_CACHE_SIZE:-256M}
      --no-modtime
    depends_on:
      localstack:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "rclone rc noop 2>/dev/null || nc -z localhost 42049"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "${BENCH_CPU_LIMIT:-2}"
          memory: "${BENCH_MEM_LIMIT:-4g}"

  juicefs:
    image: juicedata/mount:ce-v1.3.0
    profiles:
      - juicefs
    privileged: true
    volumes:
      - /dev/fuse:/dev/fuse
      - juicefs-cache:/var/jfsCache
      - type: bind
        source: /mnt/juicefs
        target: /mnt/jfs
        bind:
          propagation: rshared
    depends_on:
      localstack:
        condition: service_healthy
      postgres:
        condition: service_healthy
    command:
      - sh
      - -c
      - |
        echo "Creating S3 bucket $${S3_BUCKET}..." &&
        curl -sf -X PUT "http://localstack:4566/$${S3_BUCKET}" || true &&
        META_URL="postgres://$${POSTGRES_USER}:$${POSTGRES_PASSWORD}@postgres:5432/$${POSTGRES_DB}?sslmode=disable" &&
        juicefs format \
          --storage s3 \
          --bucket "http://localstack:4566/$${S3_BUCKET}" \
          --access-key "$${AWS_ACCESS_KEY_ID}" \
          --secret-key "$${AWS_SECRET_ACCESS_KEY}" \
          "$$META_URL" \
          bench-vol &&
        exec juicefs mount \
          --cache-size "$${BENCH_CACHE_SIZE_MB}" \
          "$$META_URL" \
          /mnt/jfs
    environment:
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-test}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-test}
      S3_BUCKET: ${S3_BUCKET:-bench}
      POSTGRES_USER: ${POSTGRES_USER:-bench}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-bench}
      POSTGRES_DB: ${POSTGRES_DB:-bench}
      BENCH_CACHE_SIZE_MB: ${BENCH_CACHE_SIZE_MB:-256}
    healthcheck:
      test: ["CMD-SHELL", "stat /mnt/jfs/.stats 2>/dev/null || ls /mnt/jfs/ 2>/dev/null"]
      interval: 5s
      timeout: 3s
      retries: 15
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: "${BENCH_CPU_LIMIT:-2}"
          memory: "${BENCH_MEM_LIMIT:-4g}"

  samba:
    image: dperson/samba:latest
    profiles:
      - samba
    ports:
      - "22445:445"
    volumes:
      - ./configs/samba/smb.conf:/etc/samba/smb.conf:ro
      - samba-data:/export
    command: >
      -u "bench;bench"
      -s "export;/export;yes;no;no;bench"
      -p
    healthcheck:
      test: ["CMD-SHELL", "smbclient -L localhost -U bench%bench -N 2>/dev/null || nc -z localhost 445"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: "${BENCH_CPU_LIMIT:-2}"
          memory: "${BENCH_MEM_LIMIT:-4g}"

# -----------------------------------------------------------------------------
# Named volumes
# -----------------------------------------------------------------------------
volumes:
  dittofs-data:
  postgres-data:
  ganesha-data:
  kernel-nfs-data:
  rclone-cache:
  juicefs-cache:
  samba-data:
