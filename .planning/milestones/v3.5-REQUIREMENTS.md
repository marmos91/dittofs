# Requirements Archive: v3.5 Adapter + Core Refactoring

**Archived:** 2026-02-26
**Status:** SHIPPED

For current requirements, see `.planning/REQUIREMENTS.md`.

---

# Requirements: v3.5 Refactoring, v3.6 Windows, v3.7 Benchmarks & v3.8 SMB3

## v3.5 Adapter + Core Refactoring

### REF-01: Generic Lock Interface
**Priority**: High
**Source**: `docs/GENERIC_LOCK_INTERFACE_PLAN.md`

Unify the lock model so all protocols (NFS, SMB, NLM) share the same types with protocol-specific translation at the boundary.

- [x] REF-01.1: `EnhancedLock` renamed to `UnifiedLock` with cross-protocol semantics
- [x] REF-01.2: `LeaseInfo` renamed to `OpLock` with `OpLockState` bitmask (Read/Write/Handle)
- [x] REF-01.3: `ShareReservation` renamed to `AccessMode` (DenyNone/DenyRead/DenyWrite/DenyAll)
- [x] REF-01.4: `LeaseBreakScanner` renamed to `OpLockBreakScanner`, centralized break/recall
- [x] REF-01.5: Centralized `IsConflicting()` handles all conflict cases (oplock vs oplock, oplock vs byte-range, byte-range vs byte-range, access mode)
- [x] REF-01.6: `PersistedLock` and `LockStore` updated with new field names (OpLockGroupKey, ReclaimOpLock, IsOpLock)
- [x] REF-01.7: Manager API updated (`AddUnifiedLock`, `RemoveUnifiedLock`, `ListUnifiedLocks`)
- [ ] REF-01.8: SMB adapter has thin translation layer (`ToOpLock`, `ToAccessMode`) _(partial — exercised in v3.8)_
- [ ] REF-01.9: NFSv4 adapter has thin translation layer (delegation -> OpLock, OPEN4_SHARE_DENY -> AccessMode) _(partial — exercised in v3.8)_
- [x] REF-01.10: GracePeriodManager stays generic (used by NLM, NFSv4, SMB reconnect)

### REF-02: Protocol Leak Purge
**Priority**: High
**Source**: `docs/CORE_REFACTORING_PLAN.md` Phase 1

Remove protocol-specific code from generic layers (metadata, controlplane, lock).

- [x] REF-02.1: SMB lock types removed from `pkg/metadata/lock/` (ShareReservation, LeaseInfo, lease_break.go moved/renamed)
- [x] REF-02.2: SMB lease methods removed from MetadataService (CheckAndBreakLeases*, ReclaimLeaseSMB, OplockChecker)
- [x] REF-02.3: NLM methods moved from MetadataService to NFS adapter (LockFileNLM, TestLockNLM, UnlockFileNLM, CancelBlockingLock)
- [x] REF-02.4: Share model cleaned — NFS fields (AllowAuthSys, RequireKerberos, Squash, etc.) to NFSExportOptions JSON config
- [x] REF-02.5: Share model cleaned — SMB fields (GuestEnabled, GuestUID, GuestGID) to SMBShareOptions JSON config
- [x] REF-02.6: SquashMode moved to NFS adapter
- [x] REF-02.7: Netgroup operations (8 methods) removed from generic Store interface
- [x] REF-02.8: Identity mapping operations (4 methods) removed from generic Store interface
- [x] REF-02.9: NFS-specific runtime fields moved (mounts, dnsCache, nfsClientProvider)
- [x] REF-02.10: NFS-specific API handlers moved (clients.go, grace.go)
- [x] REF-02.11: `pkg/identity/` moved to NFS adapter internal

### REF-03: NFS Adapter Restructuring
**Priority**: High
**Source**: `docs/NFS_REFACTORING_PLAN.md`

Restructure NFS adapter directory layout and dispatch consolidation.

- [x] REF-03.1: `internal/protocol/` renamed to `internal/adapter/` (all imports updated)
- [x] REF-03.2: Generic XDR moved to `internal/adapter/nfs/xdr/core/`
- [x] REF-03.3: NLM, NSM, portmapper consolidated under `internal/adapter/nfs/`
- [x] REF-03.4: `internal/auth/` moved to `internal/adapter/smb/auth/`
- [x] REF-03.5: `pkg/adapter/nfs/` files renamed (remove `nfs_` prefix, split mixed-concern files)
- [x] REF-03.6: v4.1-specific handlers and types moved to `v4/v4_1/` nested hierarchy
- [x] REF-03.7: Dispatch consolidated: single `nfs.Dispatch()` entry point in `internal/adapter/nfs/`
- [x] REF-03.8: Connection code split by version (connection.go + connection_v4.go)
- [x] REF-03.9: Shared handler helpers extracted
- [x] REF-03.10: Handler documentation added (3-5 lines each, all v3/v4/mount handlers)
- [x] REF-03.11: Version negotiation tests added

### REF-04: SMB Adapter Restructuring
**Priority**: High
**Source**: `docs/SMB_REFACTORING_PLAN.md`

Restructure SMB adapter to mirror NFS pattern and extract shared infrastructure.

- [x] REF-04.1: `pkg/adapter/smb/` files renamed (remove `smb_` prefix)
- [x] REF-04.2: BaseAdapter extracted to `pkg/adapter/base.go` with shared lifecycle (accept, shutdown, connection tracking)
- [x] REF-04.3: Both NFS and SMB adapters embed BaseAdapter
- [x] REF-04.4: NetBIOS framing moved to `internal/adapter/smb/framing.go`
- [x] REF-04.5: Signing verification moved to `internal/adapter/smb/signing.go`
- [x] REF-04.6: Dispatch + response logic consolidated in `internal/adapter/smb/dispatch.go`
- [x] REF-04.7: Compound handling moved to `internal/adapter/smb/compound.go`
- [x] REF-04.8: `auth.Authenticator` interface defined, NTLM + Kerberos implementations
- [x] REF-04.9: Shared handler helpers extracted to `internal/adapter/smb/helpers.go`
- [x] REF-04.10: `pkg/adapter/smb/connection.go` reduced to thin read/dispatch/write loop
- [x] REF-04.11: Handler documentation added (3-5 lines each, all SMB2 commands)

### REF-05: Core Object Decomposition
**Priority**: Medium
**Source**: `docs/CORE_REFACTORING_PLAN.md` Phases 2-5

Decompose god objects into focused components.

- [x] REF-05.1: ControlPlane Store interface decomposed into 9 sub-interfaces
- [x] REF-05.2: API handlers narrowed to accept specific sub-interfaces
- [x] REF-05.3: AdapterManager extracted from Runtime (~300 lines)
- [x] REF-05.4: MetadataStoreManager extracted from Runtime (~70 lines)
- [x] REF-05.5: TransferManager renamed to Offloader, package to `pkg/payload/offloader/`
- [x] REF-05.6: Upload orchestrator extracted to `upload.go` (~450 lines)
- [x] REF-05.7: Download coordinator extracted to `download.go` (~250 lines)
- [x] REF-05.8: Dedup handler extracted to `dedup.go` (~150 lines)

### REF-06: Code Quality Improvements
**Priority**: Medium
**Source**: `docs/CORE_REFACTORING_PLAN.md` Phases 6-9

Error unification, boilerplate reduction, and file organization.

- [x] REF-06.1: Structured `PayloadError` type wrapping sentinels with context
- [x] REF-06.2: Shared error-to-status mapping for NFS/SMB
- [x] REF-06.3: Generic GORM helpers (`getByField[T]`, `listAll[T]`, `createWithID[T]`)
- [x] REF-06.4: Centralized API error mapping helper
- [x] REF-06.5: Generic API client helpers (`getResource[T]`, `listResources[T]`)
- [x] REF-06.6: Common transaction helpers in `pkg/metadata/store/txutil/`
- [x] REF-06.7: Shared transaction test suite in `pkg/metadata/store/storetest/`
- [x] REF-06.8: `pkg/metadata/file.go` split into file_create.go, file_modify.go, file_remove.go, file_helpers.go, file_types.go
- [x] REF-06.9: `pkg/metadata/authentication.go` split into auth_identity.go, auth_permissions.go

---

## v3.6 Windows Compatibility

### WIN-01: SMB Bug Fixes
**Priority**: High
**Source**: GitHub issues #180, #181

- [ ] WIN-01.1: Sparse file READ returns zeros for unwritten blocks (#180) — handle ErrBlockNotFound as sparse region in Offloader.downloadBlock()
- [ ] WIN-01.2: Cache layer reached for sparse reads (not short-circuited by transfer manager error)
- [ ] WIN-01.3: Renamed directories show as `<DIR>` in parent listing (#181) — update Path field in Move operation
- [ ] WIN-01.4: E2E tests for sparse file create + read (fsutil createnew equivalent)
- [ ] WIN-01.5: E2E tests for directory rename + listing verification

### WIN-02: Windows ACL Support
**Priority**: High
**Source**: GitHub issue #182, MS-DTYP, MS-SMB2

- [ ] WIN-02.1: NT Security Descriptor encoding (Owner SID, Group SID, DACL, optional SACL)
- [ ] WIN-02.2: Unix UID/GID to Windows SID mapping (well-known SIDs + S-1-22-1-UID / S-1-22-2-GID)
- [ ] WIN-02.3: Unix permissions (rwx) to Windows ACE translation in DACL
- [ ] WIN-02.4: QUERY_INFO SecurityInformation handler returns proper descriptors
- [ ] WIN-02.5: SET_INFO SecurityInformation handler accepts permission changes (best-effort Unix mapping)
- [ ] WIN-02.6: Directory inheritance flags (CONTAINER_INHERIT_ACE, OBJECT_INHERIT_ACE)
- [ ] WIN-02.7: `icacls` shows meaningful permissions on DittoFS shares
- [ ] WIN-02.8: NFSv4 ACL and SMB Security Descriptor interoperability maintained

### WIN-03: Windows Integration Testing
**Priority**: High
**Source**: User requirement, test suites

Comprehensive validation using open-source test suites and manual Windows 11 testing.

- [ ] WIN-03.1: Samba smbtorture SMB2 basic tests pass (connect, read, write, lock, oplock, lease)
- [ ] WIN-03.2: Samba smbtorture SMB2 ACL and directory tests pass
- [ ] WIN-03.3: Microsoft WindowsProtocolTestSuites File Server BVT suite (101 tests) passes
- [ ] WIN-03.4: Microsoft WindowsProtocolTestSuites selected feature tests pass (lease, oplock, lock, signing)
- [ ] WIN-03.5: Windows 11 Explorer validation (create, rename, delete, copy, move, drag-and-drop)
- [ ] WIN-03.6: Windows 11 cmd.exe validation (dir, type, copy, move, ren, del, mkdir, rmdir, icacls, fsutil)
- [ ] WIN-03.7: Windows 11 PowerShell validation (Get-Item, Set-Item, Get-Acl, Set-Acl)
- [ ] WIN-03.8: Issues #180, #181, #182 verified fixed on Windows
- [ ] WIN-03.9: No regressions on Linux/macOS NFS or SMB mounts

---

## v3.7 Benchmarking Suite

### BENCH-01: Core Infrastructure
**Priority**: High
**Source**: GitHub #194

Docker Compose infrastructure with per-system profiles, directory structure, and configuration files.

- [ ] BENCH-01.1: `bench/` directory structure (configs/, workloads/, scripts/, analysis/, results/)
- [ ] BENCH-01.2: `docker-compose.yml` with profiles for all systems (dittofs variants, juicefs, ganesha, rclone, kernel-nfs, samba, monitoring)
- [ ] BENCH-01.3: `.env.example` with S3, PostgreSQL, and benchmark configuration variables
- [ ] BENCH-01.4: DittoFS config files for each backend combination (badger+s3, postgres+s3, badger+fs)
- [ ] BENCH-01.5: `scripts/check-prerequisites.sh` validates all required tools
- [ ] BENCH-01.6: `results/` directory gitignored

### BENCH-02: Benchmark Workloads
**Priority**: High
**Source**: GitHub #195

fio job files for all I/O workloads and custom metadata benchmark script.

- [ ] BENCH-02.1: fio jobs — seq-read-large (1MB), seq-write-large (1MB), rand-read-4k, rand-write-4k, mixed-rw-70-30, large-file-1gb
- [ ] BENCH-02.2: Common fio parameters (runtime=60, time_based, json+ output, parameterized threads/mountpoint)
- [ ] BENCH-02.3: macOS variants (posixaio engine, direct=0)
- [ ] BENCH-02.4: `scripts/metadata-bench.sh` — create/stat/readdir/delete for 1K/10K files + deep tree benchmark
- [ ] BENCH-02.5: Metadata script outputs JSON with ops/sec and total time

### BENCH-03: Competitor Setup
**Priority**: High
**Source**: GitHub #198

Configuration and setup scripts for fair comparison against competitors.

- [ ] BENCH-03.1: JuiceFS config (PostgreSQL + S3, cache-size matched)
- [ ] BENCH-03.2: NFS-Ganesha config (FSAL_VFS, local FS baseline)
- [ ] BENCH-03.3: RClone config (S3 remote, vfs-cache-max-size matched)
- [ ] BENCH-03.4: Kernel NFS config (erichough/nfs-server, gold standard)
- [ ] BENCH-03.5: Samba config (SMB baseline)
- [ ] BENCH-03.6: DittoFS setup script (automated dfsctl store/share/adapter creation)
- [ ] BENCH-03.7: Fairness ensured — matched cache sizes, same S3 endpoints, symmetric Docker overhead

### BENCH-04: Orchestrator Scripts
**Priority**: High
**Source**: GitHub #196

Main benchmark orchestrator and helper scripts with platform variants.

- [ ] BENCH-04.1: `run-bench.sh` orchestrator with --systems, --tiers, --iterations, --threads, --output, --quick flags
- [ ] BENCH-04.2: Helper scripts (setup-systems, start/stop-system, mount-nfs/smb, umount-all, drop-caches, warmup, collect-metrics)
- [ ] BENCH-04.3: Between-test cleanup (sync, drop caches, 5s cooldown, volume prune)
- [ ] BENCH-04.4: `run-bench-macos.sh` variant
- [ ] BENCH-04.5: `run-bench-smb.sh` for Linux SMB and `run-bench-smb.ps1` for Windows

### BENCH-05: Analysis & Reporting
**Priority**: High
**Source**: GitHub #197

Python analysis pipeline for results parsing, chart generation, and report production.

- [ ] BENCH-05.1: `parse_fio.py` — throughput, IOPS, latency (p50/p95/p99/p99.9), mean/stddev
- [ ] BENCH-05.2: `parse_metadata.py` — create/stat/readdir/delete ops/sec
- [ ] BENCH-05.3: `generate_charts.py` — tier1-4 throughput/IOPS/latency/scaling charts + SMB comparison
- [ ] BENCH-05.4: `generate_report.py` with Jinja2 template → markdown report
- [ ] BENCH-05.5: `requirements.txt` (pandas, matplotlib, seaborn, jinja2)
- [ ] BENCH-05.6: Results organized in `results/YYYY-MM-DD_HHMMSS/` with raw/, metrics/, charts/, report.md, summary.csv

### BENCH-06: Profiling Integration
**Priority**: Medium
**Source**: GitHub #199

DittoFS observability integration for bottleneck identification during benchmarks.

- [ ] BENCH-06.1: DittoFS config with metrics + telemetry + profiling (when --with-profiling)
- [ ] BENCH-06.2: Monitoring stack — Prometheus (1s scrape), Pyroscope (continuous), Grafana (optional)
- [ ] BENCH-06.3: `collect-metrics.sh` — Prometheus range queries, pprof CPU/heap/mutex/goroutine
- [ ] BENCH-06.4: Bottleneck analysis — CPU flame graphs, S3 vs metadata latency, GC pauses, cache effectiveness
- [ ] BENCH-06.5: Benchmark-specific Grafana dashboard

---

## v3.8 SMB3 Protocol Upgrade

### SMB3-SEC: Security & Encryption
**Priority**: High
**Source**: feat/smb3 branch, MS-SMB2

SMB3 dialect negotiation, signing, and encryption.

- [ ] SMB3-SEC.1: SMB 3.0 dialect negotiation
- [ ] SMB3-SEC.2: SMB 3.0.2 dialect negotiation
- [ ] SMB3-SEC.3: SMB 3.1.1 dialect negotiation with negotiate contexts
- [ ] SMB3-SEC.4: Pre-authentication integrity (SHA-512 hash chain)
- [ ] SMB3-SEC.5: AES-CMAC signing (SMB 3.0+)
- [ ] SMB3-SEC.6: AES-GMAC signing (SMB 3.1.1)
- [ ] SMB3-SEC.7: AES-128-CCM encryption (SMB 3.0/3.0.2)
- [ ] SMB3-SEC.8: AES-128-GCM encryption (SMB 3.1.1 default)
- [ ] SMB3-SEC.9: AES-256-GCM encryption (Windows 11+)
- [ ] SMB3-SEC.10: AES-256-CCM encryption (Windows Server 2022+)
- [ ] SMB3-SEC.11: Secure dialect negotiation (prevent downgrade attacks)
- [ ] SMB3-SEC.12: Encryption configurable per share

### SMB3-LEASE: Leases & Locking
**Priority**: High
**Source**: feat/smb3 branch

SMB3 leases with Unified Lock Manager integration.

- [ ] SMB3-LEASE.1: Read lease support
- [ ] SMB3-LEASE.2: Write lease support
- [ ] SMB3-LEASE.3: Handle lease support
- [ ] SMB3-LEASE.4: Lease break notifications (server-initiated)
- [ ] SMB3-LEASE.5: Directory leases
- [ ] SMB3-LEASE.6: Lease integration with Unified Lock Manager
- [ ] SMB3-LEASE.7: SMB lease <-> NFS delegation coordination

### SMB3-AUTH: Authentication & ACLs
**Priority**: High
**Source**: feat/smb3 branch, MS-DTYP

SPNEGO/Kerberos authentication and Windows security descriptors.

- [ ] SMB3-AUTH.1: SPNEGO framework implementation
- [ ] SMB3-AUTH.2: Kerberos authentication via shared layer
- [ ] SMB3-AUTH.3: External KDC integration (Active Directory)
- [ ] SMB3-AUTH.4: Kerberos ticket validation
- [ ] SMB3-AUTH.5: NTLM fallback (enhanced)
- [ ] SMB3-AUTH.6: Guest/anonymous access (SMB3 compatible)
- [ ] SMB3-AUTH.7: Windows security descriptors (SID/ACE/DACL)
- [ ] SMB3-AUTH.8: Control plane -> SMB ACL translation
- [ ] SMB3-AUTH.9: SET_INFO/QUERY_INFO security descriptor handling
- [ ] SMB3-AUTH.10: Cross-protocol ACL consistency

### SMB3-RES: Resilience
**Priority**: Medium
**Source**: feat/smb3 branch

Durable handles for connection reliability.

- [ ] SMB3-RES.1: Durable handles v1 (survive brief disconnects)
- [ ] SMB3-RES.2: Durable handles v2 with create GUID
- [ ] SMB3-RES.3: Handle state tracking
- [ ] SMB3-RES.4: Reconnection with handle restoration

### SMB3-XPROTO: Cross-Protocol Integration
**Priority**: High
**Source**: feat/smb3 branch

Unified behavior across SMB3/NFSv3/NFSv4.

- [ ] SMB3-XPROTO.1: Cross-protocol visibility (write SMB -> read NFS immediate)
- [ ] SMB3-XPROTO.2: Cross-protocol lock coordination (bidirectional)
- [ ] SMB3-XPROTO.3: Cross-protocol ACL consistency

### SMB3-TEST: Per-Phase Testing
**Priority**: High
**Source**: feat/smb3 branch

E2E tests built alongside each implementation phase.

- [ ] SMB3-TEST.1: E2E tests for SMB3 encryption
- [ ] SMB3-TEST.2: E2E tests for SMB3 signing
- [ ] SMB3-TEST.3: E2E tests for SMB3 leases
- [ ] SMB3-TEST.4: E2E tests for Kerberos authentication
- [ ] SMB3-TEST.5: E2E tests for cross-protocol scenarios
- [ ] SMB3-TEST.6: Client compatibility tests (Windows 10/11, macOS, Linux)

### SMB3-CONF: Conformance Testing
**Priority**: High
**Source**: [Microsoft WindowsProtocolTestSuites](https://github.com/microsoft/WindowsProtocolTestSuites) (MIT), [Samba smbtorture](https://wiki.samba.org/index.php/Writing_Torture_Tests) (GPLv3), [hirochachacha/go-smb2](https://github.com/hirochachacha/go-smb2) (BSD-2-Clause)

Industry-standard conformance validation against the official Microsoft test suite, Samba torture tests, and Go-native integration tests.

- [ ] SMB3-CONF.1: Microsoft WindowsProtocolTestSuites FileServer BVT (101 core tests) — via Docker image `mcr.microsoft.com/windowsprotocoltestsuites:fileserver`
- [ ] SMB3-CONF.2: Microsoft WPTS SMB3 feature tests — Encryption (AES-128/256-CCM/GCM), Signing (CMAC/GMAC), Negotiate (dialect contexts, preauth integrity), DurableHandle (v1+v2 reconnect), Leasing (file+directory, break, upgrade/downgrade), Replay (SMB 3.0+), SessionMgmt (reauthentication, binding)
- [ ] SMB3-CONF.3: Microsoft WPTS dialect-specific tests — filter by `TestCategory=Smb30`, `TestCategory=Smb302`, `TestCategory=Smb311` to verify each dialect independently
- [ ] SMB3-CONF.4: Samba smbtorture SMB3 suites — smb2.durable_v2_open, smb2.lease, smb2.dirlease, smb2.replay, smb2.session, smb2.session_req_sign, smb2.compound, smb2.oplocks, smb2.lock, smb2.acls, smb2.create, smb2.getinfo, smb2.setinfo
- [ ] SMB3-CONF.5: Go integration tests (hirochachacha/go-smb2) — connect, authenticate (NTLM), read, write, create, delete with SMB 3.0/3.0.2/3.1.1 dialects
- [ ] SMB3-CONF.6: Client compatibility matrix — Windows 10 (3.0.2), Windows 11 (3.1.1), macOS Ventura+ (3.0.2), Linux cifs.ko 5.6+ (3.1.1)
- [ ] SMB3-CONF.7: No regressions on SMB2 clients or NFS mounts
- [ ] SMB3-CONF.8: Test infrastructure Dockerized for CI repeatability (WPTS Docker + smbtorture container + Go test runner)

---

## Traceability

| Requirement | Phase(s) | Status |
|-------------|----------|--------|
| REF-01: Generic Lock Interface | 26 | Complete (8/10 satisfied, 2 partial — adapter translations deferred to v3.8) |
| REF-02: Protocol Leak Purge | 26 | Complete (11/11) |
| REF-03: NFS Adapter Restructuring | 27 | Complete (11/11) |
| REF-04: SMB Adapter Restructuring | 28 | Complete (11/11) |
| REF-05: Core Object Decomposition | 29 | Complete (8/8) |
| REF-06: Code Quality Improvements | 29 | Complete (9/9) |
| WIN-01: SMB Bug Fixes | 30 | Not started |
| WIN-02: Windows ACL Support | 31 | Not started |
| WIN-03: Windows Integration Testing | 32 | Not started |
| BENCH-01: Core Infrastructure | 33 | Not started |
| BENCH-02: Benchmark Workloads | 34 | Not started |
| BENCH-03: Competitor Setup | 35 | Not started |
| BENCH-04: Orchestrator Scripts | 36 | Not started |
| BENCH-05: Analysis & Reporting | 37 | Not started |
| BENCH-06: Profiling Integration | 38 | Not started |
| SMB3-SEC: Security & Encryption | 39 | Not started |
| SMB3-LEASE: Leases & Locking | 40 | Not started |
| SMB3-AUTH: Authentication & ACLs | 41 | Not started |
| SMB3-RES: Resilience | 42 | Not started |
| SMB3-XPROTO: Cross-Protocol Integration | 43 | Not started |
| SMB3-TEST: Per-Phase Testing | 39-43 | Not started |
| SMB3-CONF: Conformance Testing | 44 | Not started |

---
*Requirements created: 2026-02-25*
*Updated: 2026-02-26 -- formal verification for REF-04, REF-05, REF-06 completed in Phase 29.4*
