---
phase: 22-backchannel-multiplexing
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - internal/protocol/nfs/v4/state/backchannel_metrics.go
  - internal/protocol/nfs/v4/state/backchannel_test.go
  - internal/protocol/nfs/v4/handlers/backchannel_ctl_handler_test.go
  - internal/protocol/nfs/v4/handlers/compound_test.go
  - internal/protocol/nfs/v4/state/manager.go
  - internal/protocol/nfs/v4/handlers/handler.go
  - internal/protocol/CLAUDE.md
autonomous: true
requirements: [BACK-01, BACK-03, BACK-04]

must_haves:
  truths:
    - "Prometheus metrics track backchannel callback operations (total, failures, duration)"
    - "Integration tests verify full wire-format callback flow with real TCP loopback"
    - "BACKCHANNEL_CTL handler tested for success, error, and edge cases"
    - "Protocol CLAUDE.md documents backchannel conventions for future phases"
  artifacts:
    - path: "internal/protocol/nfs/v4/state/backchannel_metrics.go"
      provides: "Prometheus counters and histograms for backchannel callbacks"
      exports: ["BackchannelMetrics"]
    - path: "internal/protocol/nfs/v4/state/backchannel_test.go"
      provides: "Integration tests with TCP loopback for full backchannel send path"
      min_lines: 100
    - path: "internal/protocol/nfs/v4/handlers/backchannel_ctl_handler_test.go"
      provides: "Unit tests for BACKCHANNEL_CTL handler"
      min_lines: 80
  key_links:
    - from: "internal/protocol/nfs/v4/state/backchannel_metrics.go"
      to: "internal/protocol/nfs/v4/state/backchannel.go"
      via: "BackchannelSender records metrics on send/fail/duration"
      pattern: "metrics\\.Record"
    - from: "internal/protocol/nfs/v4/state/backchannel_test.go"
      to: "internal/protocol/nfs/v4/state/backchannel.go"
      via: "Tests create BackchannelSender and send callbacks over TCP loopback"
      pattern: "BackchannelSender|sendCallback"
---

<objective>
Add Prometheus metrics for backchannel operations, comprehensive integration tests with real TCP loopback connections, BACKCHANNEL_CTL handler tests, and protocol documentation updates.

Purpose: Ensure the backchannel infrastructure from Plan 01 is observable, tested, and documented. Integration tests with real TCP validate the full wire format including record marking, CB_SEQUENCE encoding, and reply parsing.

Output: BackchannelMetrics, test files, updated protocol docs.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-backchannel-multiplexing/22-CONTEXT.md
@.planning/phases/22-backchannel-multiplexing/22-RESEARCH.md
@.planning/phases/22-backchannel-multiplexing/22-01-SUMMARY.md

Key source files:
@internal/protocol/nfs/v4/state/backchannel.go
@internal/protocol/nfs/v4/state/callback_common.go
@internal/protocol/nfs/v4/state/session_metrics.go
@internal/protocol/nfs/v4/state/connection_metrics.go
@internal/protocol/nfs/v4/state/sequence_metrics.go
@internal/protocol/nfs/v4/handlers/backchannel_ctl_handler.go
@internal/protocol/nfs/v4/handlers/bind_conn_to_session_handler_test.go
@internal/protocol/nfs/v4/handlers/compound_test.go
@internal/protocol/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prometheus backchannel metrics and handler/state wiring</name>
  <files>
    internal/protocol/nfs/v4/state/backchannel_metrics.go
    internal/protocol/nfs/v4/state/manager.go
    internal/protocol/nfs/v4/handlers/handler.go
  </files>
  <action>
    **1. Create `backchannel_metrics.go` following the SessionMetrics nil-safe receiver pattern (per locked decision):**
    - `BackchannelMetrics` struct with:
      - `callbackTotal` prometheus.Counter -- `dittofs_nfs_backchannel_callbacks_total`
      - `callbackFailures` prometheus.Counter -- `dittofs_nfs_backchannel_callback_failures_total`
      - `callbackDuration` prometheus.Histogram -- `dittofs_nfs_backchannel_callback_duration_seconds` (buckets: 0.001, 0.005, 0.01, 0.05, 0.1, 0.5, 1, 5, 10)
      - `callbackRetries` prometheus.Counter -- `dittofs_nfs_backchannel_callback_retries_total`
    - Nil-safe receiver methods:
      - `RecordCallback()` -- increments callbackTotal
      - `RecordFailure()` -- increments callbackFailures
      - `RecordRetry()` -- increments callbackRetries
      - `ObserveDuration(d time.Duration)` -- observes callbackDuration
    - `NewBackchannelMetrics(registerer prometheus.Registerer) *BackchannelMetrics` constructor with registerOrReuse pattern (same as ConnectionMetrics)
    - Use `dittofs_nfs_backchannel_` prefix for all metric names

    **2. Wire metrics into BackchannelSender:**
    - Add `SetBackchannelMetrics(m *BackchannelMetrics)` method on Handler
    - Pass metrics to BackchannelSender when creating it in StateManager.StartBackchannelSender
    - In `sendCallback()`: call `metrics.RecordCallback()` on attempt, `metrics.RecordFailure()` on failure, `metrics.ObserveDuration()` with elapsed time, `metrics.RecordRetry()` on retry

    **3. Wire metrics into Handler:**
    - Add `backchannelMetrics *BackchannelMetrics` field on Handler
    - Add `SetBackchannelMetrics(m *BackchannelMetrics)` method
    - StateManager should receive the metrics and pass them to senders
  </action>
  <verify>
    `cd /Users/marmos91/Projects/dittofs && go build ./...` compiles.
    `cd /Users/marmos91/Projects/dittofs && go vet ./...` passes.
    `cd /Users/marmos91/Projects/dittofs && go test ./internal/protocol/nfs/v4/state/... -race -count=1 -run TestBackchannel` passes.
  </verify>
  <done>
    BackchannelMetrics created with nil-safe receiver pattern matching SessionMetrics/ConnectionMetrics/SequenceMetrics.
    Metrics wired into BackchannelSender for send/fail/retry/duration tracking.
    Handler has SetBackchannelMetrics method for adapter initialization.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integration tests, handler tests, and protocol documentation</name>
  <files>
    internal/protocol/nfs/v4/state/backchannel_test.go
    internal/protocol/nfs/v4/handlers/backchannel_ctl_handler_test.go
    internal/protocol/nfs/v4/handlers/compound_test.go
    internal/protocol/CLAUDE.md
  </files>
  <action>
    **1. Create `backchannel_test.go` -- integration tests with real TCP loopback (per locked decision):**

    Test helper: create a mock NFS client that:
    - Listens on a TCP socket (loopback)
    - Accepts a connection
    - Reads RPC CALL messages (with record marking)
    - Validates CB_COMPOUND structure (tag, minorversion=1, callback_ident=0, op count)
    - Validates CB_SEQUENCE args (sessionID, seqID, slotID)
    - Validates CB_RECALL args (stateid, truncate, fh)
    - Sends back a valid RPC REPLY with CB_COMPOUND4res (NFS4_OK status)

    Tests:
    - `TestBackchannelSender_SendCallback`: Create BackchannelSender, mock client on TCP loopback, send a CB_RECALL callback, verify the mock received correct wire-format CB_COMPOUND with CB_SEQUENCE + CB_RECALL, verify sender receives success reply
    - `TestBackchannelSender_SendTimeout`: Mock client accepts but never replies, verify sender times out after callbackTimeout
    - `TestBackchannelSender_RetryOnFailure`: First connection fails (closed), sender retries on second back-bound connection, second succeeds
    - `TestBackchannelSender_QueueFull`: Fill the queue (64 items), verify Enqueue returns false
    - `TestBackchannelSender_Stop`: Start sender, send Stop(), verify goroutine exits cleanly
    - `TestBackchannelSender_SequenceIDIncrement`: Send two callbacks, verify seqID increments from 1 to 2
    - `TestPendingCBReplies_RegisterDeliverCancel`: Unit test for XID routing: register, deliver, verify channel receives data. Also test Cancel cleanup.
    - `TestEncodeCBCompoundV41`: Verify wire format: tag=empty, minorversion=1, callback_ident=0, correct op count and payload
    - `TestCallbackRouting_V41VsV40`: Create a StateManager with both a v4.0 client (with CallbackInfo) and a v4.1 client (with session+backchannel), trigger delegation recall for each, verify v4.1 goes through BackchannelSender and v4.0 goes through SendCBRecall path
    - `TestBackchannelMetrics_NilSafe`: Verify all metric methods can be called on nil *BackchannelMetrics without panicking

    **2. Create `backchannel_ctl_handler_test.go`:**
    Follow the pattern from `bind_conn_to_session_handler_test.go` and `destroy_session_handler_test.go`.
    Tests:
    - `TestBackchannelCtl_Success`: Valid args with AUTH_NONE security, session has backchannel, verify NFS4_OK and params stored
    - `TestBackchannelCtl_NoBackchannel`: Session created without CONN_BACK_CHAN flag, verify NFS4ERR_INVAL
    - `TestBackchannelCtl_BadXDR`: Invalid XDR input, verify NFS4ERR_BADXDR
    - `TestBackchannelCtl_NoAcceptableSecurity`: Only RPCSEC_GSS in sec_parms (no AUTH_NONE or AUTH_SYS), verify appropriate error
    - `TestBackchannelCtl_UpdatesProgram`: Send two BACKCHANNEL_CTL with different cb_program values, verify second overwrites first

    **3. Update compound_test.go:**
    - Update the existing BACKCHANNEL_CTL stub test (if it tests for NFS4ERR_NOTSUPP) to test the real handler returning NFS4_OK with valid session context
    - Add a compound integration test: SEQUENCE + BACKCHANNEL_CTL in a single COMPOUND, verify both succeed

    **4. Update `internal/protocol/CLAUDE.md` -- add backchannel section:**
    Add a "### Backchannel Multiplexing (Phase 22)" section documenting:
    - BackchannelSender lifecycle: lazy start, tied to session destruction
    - Wire format: v4.1 CB_COMPOUND uses minorversion=1, callback_ident=0
    - Read-loop demux: msg_type check before rpc.ReadCall, REPLY routes to PendingCBReplies
    - Callback routing: v4.1 uses BackchannelSender queue, v4.0 uses SendCBRecall dial-out
    - Lock ordering reminder: sm.mu before connMu, no locks during network I/O
    - Write serialization: backchannel writes use NFSConnection.writeMu
    - Metrics: BackchannelMetrics nil-safe pattern
    - Adding a new callback operation (e.g., CB_NOTIFY in Phase 24): encode the op, create a CallbackRequest, enqueue to BackchannelSender
  </action>
  <verify>
    `cd /Users/marmos91/Projects/dittofs && go test ./internal/protocol/nfs/v4/state/... -race -count=1 -v -run TestBackchannel` -- all backchannel tests pass.
    `cd /Users/marmos91/Projects/dittofs && go test ./internal/protocol/nfs/v4/handlers/... -race -count=1 -v -run TestBackchannelCtl` -- handler tests pass.
    `cd /Users/marmos91/Projects/dittofs && go test ./... -race -count=1 2>&1 | tail -5` -- full suite passes, no regressions.
  </verify>
  <done>
    10+ integration tests verify backchannel wire format over real TCP loopback.
    5+ BACKCHANNEL_CTL handler tests cover success, error, and edge cases.
    Compound test updated for real BACKCHANNEL_CTL handler.
    Protocol CLAUDE.md documents backchannel conventions for Phase 24 (CB_NOTIFY).
    All tests pass with -race flag.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` -- full codebase compiles
2. `go vet ./...` -- no static analysis issues
3. `go test ./internal/protocol/nfs/v4/state/... -race -count=1 -v` -- all state tests pass including backchannel tests
4. `go test ./internal/protocol/nfs/v4/handlers/... -race -count=1 -v` -- all handler tests pass including BACKCHANNEL_CTL tests
5. `go test ./... -race -count=1 2>&1 | tail -5` -- full suite green
</verification>

<success_criteria>
- BackchannelMetrics follows nil-safe receiver pattern (RecordCallback, RecordFailure, ObserveDuration all safe on nil receiver)
- Integration tests exercise full wire-format flow: BackchannelSender -> TCP write -> mock client receives CB_COMPOUND -> mock sends reply -> sender validates
- BACKCHANNEL_CTL handler tested for success, no-backchannel, bad-XDR, and security validation
- Protocol CLAUDE.md has backchannel section explaining conventions for future CB_NOTIFY work
- No E2E tests (per locked decision -- E2E delegation recall via backchannel comes in Phase 25)
- All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/22-backchannel-multiplexing/22-02-SUMMARY.md`
</output>
