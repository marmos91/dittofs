---
phase: 23-client-lifecycle-and-cleanup
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - internal/protocol/nfs/v4/handlers/destroy_clientid_handler.go
  - internal/protocol/nfs/v4/handlers/reclaim_complete_handler.go
  - internal/protocol/nfs/v4/handlers/free_stateid_handler.go
  - internal/protocol/nfs/v4/handlers/test_stateid_handler.go
  - internal/protocol/nfs/v4/handlers/handler.go
  - internal/protocol/nfs/v4/handlers/compound.go
  - internal/protocol/nfs/v4/handlers/sequence_handler.go
  - internal/protocol/nfs/v4/handlers/destroy_clientid_handler_test.go
  - internal/protocol/nfs/v4/handlers/reclaim_complete_handler_test.go
  - internal/protocol/nfs/v4/handlers/free_stateid_handler_test.go
  - internal/protocol/nfs/v4/handlers/test_stateid_handler_test.go
  - internal/protocol/nfs/v4/handlers/compound_test.go
autonomous: true
requirements:
  - LIFE-01
  - LIFE-02
  - LIFE-03
  - LIFE-04
  - LIFE-05

must_haves:
  truths:
    - "DESTROY_CLIENTID handler decodes XDR, delegates to StateManager, returns proper NFS4 status"
    - "RECLAIM_COMPLETE handler calls grace ReclaimComplete with per-client tracking"
    - "FREE_STATEID handler validates and frees individual stateids via StateManager"
    - "TEST_STATEID handler returns per-stateid status codes array (not fail-on-first)"
    - "v4.0-only operations (SETCLIENTID, SETCLIENTID_CONFIRM, RENEW, OPEN_CONFIRM, RELEASE_LOCKOWNER) return NFS4ERR_NOTSUPP in v4.1 COMPOUNDs"
    - "DESTROY_CLIENTID is session-exempt (works without SEQUENCE)"
    - "v4.0 rejection consumes XDR args to prevent stream desync"
    - "All handler tests pass with -race flag"
  artifacts:
    - path: "internal/protocol/nfs/v4/handlers/destroy_clientid_handler.go"
      provides: "DESTROY_CLIENTID V41OpHandler"
      contains: "handleDestroyClientID"
    - path: "internal/protocol/nfs/v4/handlers/reclaim_complete_handler.go"
      provides: "RECLAIM_COMPLETE V41OpHandler"
      contains: "handleReclaimComplete"
    - path: "internal/protocol/nfs/v4/handlers/free_stateid_handler.go"
      provides: "FREE_STATEID V41OpHandler"
      contains: "handleFreeStateid"
    - path: "internal/protocol/nfs/v4/handlers/test_stateid_handler.go"
      provides: "TEST_STATEID V41OpHandler"
      contains: "handleTestStateid"
    - path: "internal/protocol/nfs/v4/handlers/compound.go"
      provides: "v4.0-only operation rejection in v4.1 dispatch"
      contains: "v40OnlyOps"
  key_links:
    - from: "internal/protocol/nfs/v4/handlers/destroy_clientid_handler.go"
      to: "internal/protocol/nfs/v4/state/v41_client.go"
      via: "h.StateManager.DestroyV41ClientID(args.ClientID)"
      pattern: "DestroyV41ClientID"
    - from: "internal/protocol/nfs/v4/handlers/handler.go"
      to: "internal/protocol/nfs/v4/handlers/destroy_clientid_handler.go"
      via: "v41DispatchTable registration replacing stub"
      pattern: "OP_DESTROY_CLIENTID.*handleDestroyClientID"
    - from: "internal/protocol/nfs/v4/handlers/compound.go"
      to: "v4.0-only op map"
      via: "v40OnlyOps check before v4.0 fallback dispatch"
      pattern: "v40OnlyOps\\[opCode\\]"
---

<objective>
Implement all 4 NFSv4.1 handler files (DESTROY_CLIENTID, RECLAIM_COMPLETE, FREE_STATEID, TEST_STATEID), add v4.0-only operation rejection in v4.1 COMPOUNDs, add DESTROY_CLIENTID to session-exempt operations, and replace all stubs in the dispatch table. Full handler test coverage with race detection.

Purpose: Completes the NFS wire-level implementation for all Phase 23 operations. After this plan, clients can use all lifecycle operations via COMPOUND requests.
Output: 4 new handler files, updated dispatch tables, v4.0 rejection logic, and comprehensive handler tests.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-client-lifecycle-and-cleanup/23-RESEARCH.md
@.planning/phases/23-client-lifecycle-and-cleanup/23-01-SUMMARY.md

# Key source files to read:
@internal/protocol/nfs/v4/handlers/handler.go
@internal/protocol/nfs/v4/handlers/compound.go
@internal/protocol/nfs/v4/handlers/sequence_handler.go
@internal/protocol/nfs/v4/handlers/destroy_session_handler.go
@internal/protocol/nfs/v4/handlers/backchannel_ctl_handler.go
@internal/protocol/nfs/v4/handlers/compound_test.go
@internal/protocol/nfs/v4/handlers/destroy_session_handler_test.go
@internal/protocol/nfs/v4/types/destroy_clientid.go
@internal/protocol/nfs/v4/types/reclaim_complete.go
@internal/protocol/nfs/v4/types/free_stateid.go
@internal/protocol/nfs/v4/types/test_stateid.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement 4 handler files, v4.0 rejection, and dispatch table updates</name>
  <files>
    internal/protocol/nfs/v4/handlers/destroy_clientid_handler.go
    internal/protocol/nfs/v4/handlers/reclaim_complete_handler.go
    internal/protocol/nfs/v4/handlers/free_stateid_handler.go
    internal/protocol/nfs/v4/handlers/test_stateid_handler.go
    internal/protocol/nfs/v4/handlers/handler.go
    internal/protocol/nfs/v4/handlers/compound.go
    internal/protocol/nfs/v4/handlers/sequence_handler.go
  </files>
  <action>
**Read first:** `handlers/destroy_session_handler.go` and `handlers/backchannel_ctl_handler.go` for the exact V41OpHandler pattern to follow. Also read `types/destroy_clientid.go`, `types/reclaim_complete.go`, `types/free_stateid.go`, `types/test_stateid.go` for XDR type signatures.

**1. destroy_clientid_handler.go (NEW):**

Create handler following the destroy_session_handler.go pattern:
```go
func (h *Handler) handleDestroyClientID(
    ctx *types.CompoundContext,
    v41ctx *types.V41RequestContext,
    reader io.Reader,
) *types.CompoundResult
```
- Decode `DestroyClientidArgs` from reader. On decode error, return NFS4ERR_BADXDR.
- Call `h.StateManager.DestroyV41ClientID(args.ClientID)`.
- On error, use `mapStateError()` to convert to NFS4 status. Log at DEBUG level (locked decision: structured logging with client_id, nfs_status, client_addr).
- On success, log at INFO level: "DESTROY_CLIENTID: client destroyed" with client_id and client_addr (locked decision).
- Encode and return `DestroyClientidRes` with status.

**2. reclaim_complete_handler.go (NEW):**

Create handler:
```go
func (h *Handler) handleReclaimComplete(
    ctx *types.CompoundContext,
    v41ctx *types.V41RequestContext,
    reader io.Reader,
) *types.CompoundResult
```
- Decode `ReclaimCompleteArgs` from reader.
- Determine the client ID: if v41ctx is not nil, extract client ID from the session. If v41ctx is nil (exempt path -- though RECLAIM_COMPLETE is not exempt, handle gracefully), return NFS4ERR_OP_NOT_IN_SESSION.
- Call `h.StateManager.GraceState().ReclaimComplete(clientID)` (or equivalent path from Plan 01).
- On NFS4ERR_COMPLETE_ALREADY, return that status.
- On success, log at INFO level with client_id and rca_one_fs flag (locked decision: structured logging with reclaim duration).
- Note: Per RFC 8881, `rca_one_fs=true` and `rca_one_fs=false` behave the same for single-FS servers like DittoFS.

**3. free_stateid_handler.go (NEW):**

Create handler:
```go
func (h *Handler) handleFreeStateid(
    ctx *types.CompoundContext,
    v41ctx *types.V41RequestContext,
    reader io.Reader,
) *types.CompoundResult
```
- Decode `FreeStateidArgs` from reader.
- Extract client ID from v41ctx session for authorization.
- Call `h.StateManager.FreeStateid(clientID, &args.Stateid)`.
- On error, map to NFS4 status. Log at DEBUG for expected errors, INFO for success.
- Encode and return `FreeStateidRes`.
- Do NOT trigger cache flush (locked decision).

**4. test_stateid_handler.go (NEW):**

Create handler:
```go
func (h *Handler) handleTestStateid(
    ctx *types.CompoundContext,
    v41ctx *types.V41RequestContext,
    reader io.Reader,
) *types.CompoundResult
```
- Decode `TestStateidArgs` from reader.
- Call `h.StateManager.TestStateids(args.Stateids)` to get per-stateid status codes.
- Encode `TestStateidRes` with `Status: NFS4_OK` and the status codes array (locked decision: per-stateid error codes, not fail-on-first).
- Log at DEBUG level with count of stateids tested (locked decision: structured logging).

**5. Update handler.go dispatch table:**

Replace the 4 stubs with real handlers:
- `h.v41DispatchTable[types.OP_DESTROY_CLIENTID] = h.handleDestroyClientID` (was v41StubHandler)
- `h.v41DispatchTable[types.OP_RECLAIM_COMPLETE] = h.handleReclaimComplete` (was v41StubHandler)
- `h.v41DispatchTable[types.OP_FREE_STATEID] = h.handleFreeStateid` (was v41StubHandler)
- `h.v41DispatchTable[types.OP_TEST_STATEID] = h.handleTestStateid` (was v41StubHandler)

**6. Add DESTROY_CLIENTID to session-exempt ops in sequence_handler.go:**

Per RFC 8881 Section 18.50.3: "DESTROY_CLIENTID MAY be the only operation in the COMPOUND, or it MAY be preceded by a SEQUENCE operation." Add `types.OP_DESTROY_CLIENTID` to the `isSessionExemptOp()` switch statement (alongside EXCHANGE_ID, CREATE_SESSION, etc.). This allows it to work after the client's last session is destroyed.

**7. v4.0-only operation rejection in compound.go:**

Add a package-level map:
```go
var v40OnlyOps = map[uint32]bool{
    types.OP_SETCLIENTID:         true,  // op 35
    types.OP_SETCLIENTID_CONFIRM: true,  // op 36
    types.OP_RENEW:               true,  // op 30
    types.OP_OPEN_CONFIRM:        true,  // op 20
    types.OP_RELEASE_LOCKOWNER:   true,  // op 39
}
```

In `dispatchV41()` post-SEQUENCE dispatch loop (the `for i := uint32(1); i < numOps; i++` loop), add a check BEFORE the v4.1/v4.0 table dispatch:
```go
if v40OnlyOps[opCode] {
    // v4.0-only op: consume XDR args to prevent desync, then return NOTSUPP
    consumeV40OnlyArgs(opCode, reader)
    logger.Debug("NFSv4.1 COMPOUND rejected v4.0-only operation",
        "opcode", opCode, "op_name", types.OpName(opCode), "client", compCtx.ClientAddr)
    result = notSuppHandler(opCode)
}
```

Also add the same check in `dispatchV41Ops()` (the exempt op path) at the same position.

Create `consumeV40OnlyArgs(opCode uint32, reader io.Reader) error` helper function in compound.go. For each of the 5 ops, decode their XDR args using the existing type decoders to consume them from the reader without executing business logic. The safest approach: use existing XDR arg types if they exist, or manually decode known fields. Check if types exist for SETCLIENTID_CONFIRM, RENEW, OPEN_CONFIRM, RELEASE_LOCKOWNER in the types package. If they have Decode methods on their args structs, use those. If not, manually read the known number of bytes per op.

Log at DEBUG level for v4.0 rejections (locked decision: not noisy in production).
  </action>
  <verify>
Run `go build ./internal/protocol/nfs/v4/handlers/...` -- must compile with no errors.
Run `go vet ./internal/protocol/nfs/v4/handlers/...` -- must pass clean.
  </verify>
  <done>
All 4 handlers are implemented following V41OpHandler pattern. Stubs replaced in v41DispatchTable. DESTROY_CLIENTID added as session-exempt. v4.0-only ops rejected with NFS4ERR_NOTSUPP in v4.1 COMPOUNDs with proper XDR arg consumption. All files compile and vet clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add handler tests and v4.0 rejection tests with race detection</name>
  <files>
    internal/protocol/nfs/v4/handlers/destroy_clientid_handler_test.go
    internal/protocol/nfs/v4/handlers/reclaim_complete_handler_test.go
    internal/protocol/nfs/v4/handlers/free_stateid_handler_test.go
    internal/protocol/nfs/v4/handlers/test_stateid_handler_test.go
    internal/protocol/nfs/v4/handlers/compound_test.go
  </files>
  <action>
**Read first:** `handlers/destroy_session_handler_test.go`, `handlers/backchannel_ctl_handler_test.go`, `handlers/compound_test.go`, `handlers/sequence_handler_test.go` for test patterns. Tests must use real StateManager (locked decision: no mocks).

**1. destroy_clientid_handler_test.go (NEW):**

Test function `TestHandleDestroyClientID` with subtests:
- `success`: Set up client via ExchangeID (use StateManager directly), encode DestroyClientidArgs, call handler, verify NFS4_OK.
- `clientid_busy`: Set up client + session, call handler, verify NFS4ERR_CLIENTID_BUSY.
- `stale_clientid`: Call handler with non-existent client ID, verify NFS4ERR_STALE_CLIENTID.
- `bad_xdr`: Call handler with truncated reader, verify NFS4ERR_BADXDR.

Use the handler test pattern: create Handler with real StateManager, encode args to bytes.Reader, call handler method directly.

**2. reclaim_complete_handler_test.go (NEW):**

Test function `TestHandleReclaimComplete` with subtests:
- `success`: Set up client with session, start grace period, encode ReclaimCompleteArgs (OneFS=false), call handler via COMPOUND with SEQUENCE, verify NFS4_OK.
- `complete_already`: Call handler twice for same client, verify second returns NFS4ERR_COMPLETE_ALREADY.
- `bad_xdr`: Truncated reader, verify NFS4ERR_BADXDR.

Note: RECLAIM_COMPLETE requires SEQUENCE context (not session-exempt), so test via SEQUENCE-gated compound or by constructing v41ctx manually.

**3. free_stateid_handler_test.go (NEW):**

Test function `TestHandleFreeStateid` with subtests:
- `success`: Create open state, encode FreeStateidArgs with its stateid, call handler, verify NFS4_OK.
- `bad_stateid`: Encode with invalid stateid, verify NFS4ERR_BAD_STATEID.
- `bad_xdr`: Truncated reader, verify NFS4ERR_BADXDR.

**4. test_stateid_handler_test.go (NEW):**

Test function `TestHandleTestStateid` with subtests:
- `all_valid`: Create stateids, encode TestStateidArgs, call handler, verify NFS4_OK with all per-stateid codes NFS4_OK.
- `mixed`: Mix valid and invalid stateids, verify per-stateid error codes.
- `empty`: Empty stateid array, verify NFS4_OK with empty results.
- `bad_xdr`: Truncated reader, verify NFS4ERR_BADXDR.

**5. v4.0 rejection tests in compound_test.go:**

Add `TestCompound_V41_RejectsV40OnlyOps` test:
- For each of the 5 v4.0-only ops (SETCLIENTID, SETCLIENTID_CONFIRM, RENEW, OPEN_CONFIRM, RELEASE_LOCKOWNER):
  - Create a v4.1 COMPOUND (minorversion=1) with SEQUENCE + the v4.0-only op.
  - Verify the v4.0-only op returns NFS4ERR_NOTSUPP.
  - Verify SEQUENCE result is NFS4_OK (it should succeed before the v4.0 op).

Add `TestCompound_V40_AllowsV40Ops` to verify v4.0 compounds still work with these ops (no regression).

Add `TestCompound_V41_DestroyClientID_SessionExempt`:
- Send DESTROY_CLIENTID as only op in v4.1 COMPOUND (no SEQUENCE).
- Verify it works (session-exempt path).

Use the existing compound test helper patterns from compound_test.go (encode COMPOUND request, call ProcessCompound, decode response).
  </action>
  <verify>
Run `go test -race -v ./internal/protocol/nfs/v4/handlers/... -run "TestHandleDestroyClientID|TestHandleReclaimComplete|TestHandleFreeStateid|TestHandleTestStateid|TestCompound_V41_RejectsV40|TestCompound_V40_AllowsV40|TestCompound_V41_DestroyClientID_SessionExempt"` -- all tests pass with race detection.
Run `go test -race ./internal/protocol/nfs/v4/handlers/...` -- full handler package test suite passes (no regressions).
  </verify>
  <done>
All handler tests pass with -race. DESTROY_CLIENTID handler tested for success, busy, stale, and bad XDR. RECLAIM_COMPLETE handler tested for success, complete_already, and bad XDR. FREE_STATEID and TEST_STATEID handlers tested with real state. v4.0 rejection verified for all 5 ops in v4.1 COMPOUNDs. v4.0 COMPOUNDs still allow these ops (no regression). DESTROY_CLIENTID confirmed session-exempt.
  </done>
</task>

</tasks>

<verification>
1. `go build ./internal/protocol/nfs/v4/...` compiles without errors
2. `go vet ./internal/protocol/nfs/v4/...` passes clean
3. `go test -race ./internal/protocol/nfs/v4/handlers/...` -- all tests pass (new + existing)
4. `go test -race ./internal/protocol/nfs/v4/state/...` -- still passes (no regressions from handlers)
5. v4.0 COMPOUND with SETCLIENTID still works (regression check)
6. v4.1 COMPOUND with SETCLIENTID returns NFS4ERR_NOTSUPP
7. DESTROY_CLIENTID works as session-exempt (no SEQUENCE required)
8. All 4 stubs replaced in v41DispatchTable
</verification>

<success_criteria>
- 4 handler files created following V41OpHandler pattern (locked decision: per-operation files)
- Stubs replaced in dispatch table for all 4 operations
- DESTROY_CLIENTID added to session-exempt operations
- v4.0-only ops (5 ops) return NFS4ERR_NOTSUPP in v4.1 COMPOUNDs with proper XDR consumption
- Debug-level logging for v4.0 rejections (locked decision)
- All handler tests pass with -race flag
- No regressions in existing handler or state tests
</success_criteria>

<output>
After completion, create `.planning/phases/23-client-lifecycle-and-cleanup/23-02-SUMMARY.md`
</output>
