---
phase: 16-nfsv4-1-types-and-constants
plan: 03
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - internal/protocol/nfs/v4/types/free_stateid.go
  - internal/protocol/nfs/v4/types/free_stateid_test.go
  - internal/protocol/nfs/v4/types/test_stateid.go
  - internal/protocol/nfs/v4/types/test_stateid_test.go
  - internal/protocol/nfs/v4/types/destroy_clientid.go
  - internal/protocol/nfs/v4/types/destroy_clientid_test.go
  - internal/protocol/nfs/v4/types/reclaim_complete.go
  - internal/protocol/nfs/v4/types/reclaim_complete_test.go
  - internal/protocol/nfs/v4/types/secinfo_no_name.go
  - internal/protocol/nfs/v4/types/secinfo_no_name_test.go
  - internal/protocol/nfs/v4/types/set_ssv.go
  - internal/protocol/nfs/v4/types/set_ssv_test.go
  - internal/protocol/nfs/v4/types/want_delegation.go
  - internal/protocol/nfs/v4/types/want_delegation_test.go
  - internal/protocol/nfs/v4/types/get_dir_delegation.go
  - internal/protocol/nfs/v4/types/get_dir_delegation_test.go
  - internal/protocol/nfs/v4/types/layoutget.go
  - internal/protocol/nfs/v4/types/layoutget_test.go
  - internal/protocol/nfs/v4/types/layoutcommit.go
  - internal/protocol/nfs/v4/types/layoutcommit_test.go
  - internal/protocol/nfs/v4/types/layoutreturn.go
  - internal/protocol/nfs/v4/types/layoutreturn_test.go
  - internal/protocol/nfs/v4/types/getdeviceinfo.go
  - internal/protocol/nfs/v4/types/getdeviceinfo_test.go
  - internal/protocol/nfs/v4/types/getdevicelist.go
  - internal/protocol/nfs/v4/types/getdevicelist_test.go
autonomous: true
requirements:
  - SESS-05

must_haves:
  truths:
    - "All 13 remaining forward-channel v4.1 operations have args/res types with Encode/Decode"
    - "Trivial operations (FREE_STATEID, DESTROY_CLIENTID, RECLAIM_COMPLETE, SECINFO_NO_NAME) have correct minimal wire encoding"
    - "Variable-length array operations (TEST_STATEID) handle arbitrary-length stateid lists"
    - "pNFS layout operations (LAYOUTGET, LAYOUTCOMMIT, LAYOUTRETURN, GETDEVICEINFO, GETDEVICELIST) have complete types ready for future pNFS support"
    - "Union-based operations (WANT_DELEGATION, GET_DIR_DELEGATION, LAYOUTRETURN) handle discriminated unions"
  artifacts:
    - path: "internal/protocol/nfs/v4/types/free_stateid.go"
      provides: "FreeStateidArgs/Res"
      contains: "FreeStateidArgs"
    - path: "internal/protocol/nfs/v4/types/test_stateid.go"
      provides: "TestStateidArgs/Res with variable-length arrays"
      contains: "TestStateidArgs"
    - path: "internal/protocol/nfs/v4/types/layoutget.go"
      provides: "LayoutGetArgs/Res"
      contains: "LayoutGetArgs"
    - path: "internal/protocol/nfs/v4/types/get_dir_delegation.go"
      provides: "GetDirDelegationArgs/Res"
      contains: "GetDirDelegationArgs"
  key_links:
    - from: "internal/protocol/nfs/v4/types/test_stateid.go"
      to: "internal/protocol/nfs/v4/types/types.go"
      via: "Stateid4 reuse"
      pattern: "Stateid4"
    - from: "internal/protocol/nfs/v4/types/layoutget.go"
      to: "internal/protocol/nfs/v4/types/constants.go"
      via: "layout type constants"
      pattern: "LAYOUT4_"
---

<objective>
Define XDR request/response types for the 13 remaining forward-channel v4.1 operations: FREE_STATEID, TEST_STATEID, DESTROY_CLIENTID, RECLAIM_COMPLETE, SECINFO_NO_NAME, SET_SSV, WANT_DELEGATION, GET_DIR_DELEGATION, LAYOUTGET, LAYOUTCOMMIT, LAYOUTRETURN, GETDEVICEINFO, and GETDEVICELIST.

Purpose: Complete the forward-channel operation type set. Most of these are simpler than the core session ops (Plan 02). The 5 pNFS layout operations are included per locked decision for future pNFS readiness, even though pNFS is out of scope for v3.0.

Output: 13 operation files with args/res structs, Encode/Decode methods, String() implementations, and round-trip tests.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-nfsv4-1-types-and-constants/16-CONTEXT.md
@.planning/phases/16-nfsv4-1-types-and-constants/16-RESEARCH.md
@.planning/phases/16-nfsv4-1-types-and-constants/16-01-SUMMARY.md
@internal/protocol/nfs/v4/types/session_common.go
@internal/protocol/nfs/v4/types/fixtures_test.go
@internal/protocol/nfs/v4/types/constants.go
@internal/protocol/nfs/v4/types/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trivial and simple operation types (8 operations)</name>
  <files>
    internal/protocol/nfs/v4/types/free_stateid.go
    internal/protocol/nfs/v4/types/free_stateid_test.go
    internal/protocol/nfs/v4/types/test_stateid.go
    internal/protocol/nfs/v4/types/test_stateid_test.go
    internal/protocol/nfs/v4/types/destroy_clientid.go
    internal/protocol/nfs/v4/types/destroy_clientid_test.go
    internal/protocol/nfs/v4/types/reclaim_complete.go
    internal/protocol/nfs/v4/types/reclaim_complete_test.go
    internal/protocol/nfs/v4/types/secinfo_no_name.go
    internal/protocol/nfs/v4/types/secinfo_no_name_test.go
    internal/protocol/nfs/v4/types/set_ssv.go
    internal/protocol/nfs/v4/types/set_ssv_test.go
    internal/protocol/nfs/v4/types/want_delegation.go
    internal/protocol/nfs/v4/types/want_delegation_test.go
    internal/protocol/nfs/v4/types/get_dir_delegation.go
    internal/protocol/nfs/v4/types/get_dir_delegation_test.go
  </files>
  <action>
Create per-operation type files following the same pattern as Plan 02. Each file contains args struct, res struct, Encode/Decode/String methods. Each test file has round-trip tests.

**Trivial operations (status-only response or single-field args):**

1. **`free_stateid.go`** (RFC 8881 Section 18.38):
   - Args: `Stateid Stateid4` -- reuse existing Stateid4 from types.go. Use `DecodeStateid4(reader)` and `EncodeStateid4(buf, &s.Stateid)` from types.go.
   - Res: `Status uint32`

2. **`destroy_clientid.go`** (RFC 8881 Section 18.50):
   - Args: `ClientID uint64`
   - Res: `Status uint32`

3. **`reclaim_complete.go`** (RFC 8881 Section 18.51):
   - Args: `OneFS bool` -- XDR bool (true = reclaim complete for one FS, false = all)
   - Res: `Status uint32`

4. **`secinfo_no_name.go`** (RFC 8881 Section 18.45):
   - Args: `Style uint32` -- SECINFO_STYLE4_CURRENT_FH (0) or SECINFO_STYLE4_PARENT (1)
   - Res: `Status uint32` + `SecInfo []byte` (reuse raw SECINFO4res encoding for now -- the secinfo entries are complex and already handled by the existing SECINFO handler. Store as raw opaque for type definition purposes.)

**Simple operations (variable-length arrays):**

5. **`test_stateid.go`** (RFC 8881 Section 18.48):
   - Args: `Stateids []Stateid4` -- variable-length array of stateid4
   - Res: `Status uint32` + `StatusCodes []uint32` -- variable-length array of per-stateid status codes
   - Encode arrays as `uint32 count` + N elements

6. **`set_ssv.go`** (RFC 8881 Section 18.47):
   - Args: `SSV []byte` (opaque) + `Digest []byte` (opaque)
   - Res: `Status uint32` + `Digest []byte` (opaque, only if NFS4_OK)
   - Note: SSV is out of scope per REQUIREMENTS.md (SP4_SSV excluded). Types still needed for wire compat.

**Medium operations (unions):**

7. **`want_delegation.go`** (RFC 8881 Section 18.49):
   - Args: `Want uint32` (bitmap of delegation types wanted) + `Claim OpenClaimDelegCur4` -- union per open_claim_type4 but limited to CLAIM_PREVIOUS. For simplicity, encode Claim as a union with discriminant. Define `WantDelegationClaim` union with discriminant `ClaimType uint32` and arms: CLAIM_PREVIOUS = `DelegType uint32`, default = void.
   - Res: `Status uint32` + union switched on delegation_type: OPEN_DELEGATE_NONE = void (the server doesn't want to give a delegation -- just Status field), OPEN_DELEGATE_READ/WRITE = delegation struct. For the res union, define the result similarly to the existing v4.0 delegation pattern but store as a `DelegationType uint32` discriminant + raw opaque data for the delegation body. This keeps types self-contained without duplicating the complex delegation structures.

8. **`get_dir_delegation.go`** (RFC 8881 Section 18.39):
   - Args: `Signal bool` (client signal to server) + `NotificationTypes Bitmap4` (which changes to notify about) + `ChildAttrDelay NFS4Time` + `DirAttrDelay NFS4Time` + `ChildAttrs Bitmap4` + `DirAttrs Bitmap4`
   - Res: `Status uint32` + union: GDD4_OK case = `CookieVerf [8]byte` + `Stateid Stateid4` + `NotificationTypes Bitmap4` + `ChildAttrs Bitmap4` + `DirAttrs Bitmap4`; GDD4_UNAVAIL case = `WillSignalDelegAvail bool`. Define constants `GDD4_OK = 0`, `GDD4_UNAVAIL = 1`.

For each test file: at minimum one round-trip test for args and one for res (success + error cases where applicable). Use fixtures from fixtures_test.go.
  </action>
  <verify>
Run `go test ./internal/protocol/nfs/v4/types/ -run "TestFreeStateid|TestTestStateid|TestDestroyClientid|TestReclaimComplete|TestSecinfoNoName|TestSetSsv|TestWantDelegation|TestGetDirDelegation" -v`
Run `go build ./internal/protocol/...` for compilation check.
  </verify>
  <done>
All 8 trivial/simple/medium forward-channel operations have complete args/res types with working round-trip tests. TEST_STATEID handles variable-length stateid arrays. GET_DIR_DELEGATION handles its nested union response. WANT_DELEGATION handles delegation claim union.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create pNFS layout operation types (5 operations)</name>
  <files>
    internal/protocol/nfs/v4/types/layoutget.go
    internal/protocol/nfs/v4/types/layoutget_test.go
    internal/protocol/nfs/v4/types/layoutcommit.go
    internal/protocol/nfs/v4/types/layoutcommit_test.go
    internal/protocol/nfs/v4/types/layoutreturn.go
    internal/protocol/nfs/v4/types/layoutreturn_test.go
    internal/protocol/nfs/v4/types/getdeviceinfo.go
    internal/protocol/nfs/v4/types/getdeviceinfo_test.go
    internal/protocol/nfs/v4/types/getdevicelist.go
    internal/protocol/nfs/v4/types/getdevicelist_test.go
  </files>
  <action>
Create per-operation type files for the 5 pNFS layout operations. These are included per locked decision for future pNFS readiness. Per REQUIREMENTS.md, pNFS is out of scope, so these will return NFS4ERR_NOTSUPP at the handler level, but the types must be complete for wire compatibility.

**1. `layoutget.go`** (RFC 8881 Section 18.43):
- Args: `Signal bool` + `LayoutType uint32` (LAYOUT4_*) + `IOMode uint32` (LAYOUTIOMODE4_READ=1, LAYOUTIOMODE4_RW=2) + `Offset uint64` + `Length uint64` + `MinLength uint64` + `Stateid Stateid4` + `MaxCount uint32`
- Add layout IO mode constants: `LAYOUTIOMODE4_READ = 1`, `LAYOUTIOMODE4_RW = 2` (define in this file or in constants.go if not already added)
- Res: `Status uint32` + `ReturnOnClose bool` + `Stateid Stateid4` + `Layouts []Layout4` where `Layout4` = `Offset uint64` + `Length uint64` + `IOMode uint32` + `Type uint32` + `Body []byte` (opaque layout-type-specific data)

**2. `layoutcommit.go`** (RFC 8881 Section 18.42):
- Args: `Offset uint64` + `Length uint64` + `Reclaim bool` + `Stateid Stateid4` + `NewOffsetPresent bool` + `NewOffset uint64` (only if NewOffsetPresent) + `TimeModifyPresent bool` + `TimeModify NFS4Time` (only if present) + `LayoutUpdateType uint32` + `LayoutUpdate []byte` (opaque)
- PITFALL: This has 3 unions (offset, time, update). Encode conditionally based on the `Present` bool fields.
- Res: `Status uint32` + `NewSizePresent bool` + `NewSize uint64` (only if present)

**3. `layoutreturn.go`** (RFC 8881 Section 18.44):
- Args: `Reclaim bool` + `LayoutType uint32` + `IOMode uint32` + `ReturnType uint32`
  - If ReturnType == LAYOUTRETURN4_FILE (1): `Offset uint64` + `Length uint64` + `Stateid Stateid4` + `Body []byte` (opaque)
  - If ReturnType == LAYOUTRETURN4_FSID (2) or LAYOUTRETURN4_ALL (3): void
  - Define constants: `LAYOUTRETURN4_FILE = 1`, `LAYOUTRETURN4_FSID = 2`, `LAYOUTRETURN4_ALL = 3`
- Res: `Status uint32` + `StateidPresent bool` + `Stateid Stateid4` (only if present -- boolean union)

**4. `getdeviceinfo.go`** (RFC 8881 Section 18.40):
- Define `DeviceId4 [16]byte` type (or `[20]byte` -- check RFC: it's 16 bytes per `deviceid4` definition in RFC 8881 Section 3.3.14, a fixed 16-byte opaque). Encode as fixed 16 bytes, no length prefix.
- Args: `DeviceID DeviceId4` + `LayoutType uint32` + `MaxCount uint32` + `NotifyTypes Bitmap4`
- Res: `Status uint32` + `DeviceAddr []byte` (opaque device_addr4, layout-type-specific) + `Notification Bitmap4`

**5. `getdevicelist.go`** (RFC 8881 Section 18.41):
- Args: `LayoutType uint32` + `MaxDevices uint32` + `Cookie uint64` + `CookieVerf [8]byte`
- Res: `Status uint32` + `Cookie uint64` + `CookieVerf [8]byte` + `DeviceIDs []DeviceId4` + `EOF bool`

For each test file: round-trip tests for args and res. The pNFS types are tested in isolation -- handler logic is deferred.
  </action>
  <verify>
Run `go test ./internal/protocol/nfs/v4/types/ -run "TestLayoutGet|TestLayoutCommit|TestLayoutReturn|TestGetDeviceInfo|TestGetDeviceList" -v`
Run `go build ./internal/protocol/...` for compilation check.
Run `go test ./internal/protocol/nfs/v4/types/...` to verify all tests pass together (no conflicts with Task 1).
  </verify>
  <done>
All 5 pNFS layout operations have complete args/res types with working round-trip tests. LAYOUTCOMMIT handles its 3 conditional unions. LAYOUTRETURN handles the file/fsid/all discriminated union. GETDEVICEINFO and GETDEVICELIST handle DeviceId4 fixed-size opaque. All layout type constants (LAYOUT4_*, LAYOUTIOMODE4_*, LAYOUTRETURN4_*) are defined.
  </done>
</task>

</tasks>

<verification>
1. `go test ./internal/protocol/nfs/v4/types/...` -- all tests pass (Plan 01 + Plan 03)
2. `go build ./internal/protocol/...` compiles cleanly
3. All 13 remaining forward-channel operations have type files
4. `go vet ./internal/protocol/nfs/v4/types/` reports no issues
</verification>

<success_criteria>
- 13 operation type files exist with complete XDR codecs and tests
- Trivial operations (FREE_STATEID, DESTROY_CLIENTID, RECLAIM_COMPLETE, SECINFO_NO_NAME) are correctly minimal
- TEST_STATEID handles variable-length stateid arrays
- pNFS operations (LAYOUTGET, LAYOUTCOMMIT, LAYOUTRETURN, GETDEVICEINFO, GETDEVICELIST) are ready for future pNFS implementation
- All types implement XdrEncoder/XdrDecoder interfaces
</success_criteria>

<output>
After completion, create `.planning/phases/16-nfsv4-1-types-and-constants/16-03-SUMMARY.md`
</output>
