---
phase: 26-generic-lock-interface-protocol-leak-purge
plan: 04
type: execute
wave: 2
depends_on:
  - 26-01
  - 26-03
files_modified:
  - pkg/metadata/service.go
  - pkg/adapter/nfs/nlm_service.go
  - pkg/adapter/nfs/adapter.go
  - pkg/adapter/smb/adapter.go
  - pkg/metadata/lock_exports.go
autonomous: true
requirements:
  - REF-02

must_haves:
  truths:
    - "NLM methods (LockFileNLM, TestLockNLM, UnlockFileNLM, CancelBlockingLock) are NOT on MetadataService"
    - "NLM service in NFS adapter uses LockManager directly (no import cycle)"
    - "SMB lease methods (CheckAndBreakLeases*, ReclaimLeaseSMB, OplockChecker) are NOT on MetadataService"
    - "MetadataService is ~550 lines (down from 994) with only generic file operations"
    - "NFS adapter registers OnOpLockBreak callback for delegation recall"
    - "SMB adapter registers all 3 break callbacks and uses generic UnifiedLock only"
    - "No global OplockChecker variable exists"
  artifacts:
    - path: "pkg/adapter/nfs/nlm_service.go"
      provides: "NLM lock service using LockManager directly"
      contains: "type NLMService struct"
    - path: "pkg/metadata/service.go"
      provides: "Clean MetadataService without NLM/SMB-specific methods"
      min_lines: 400
  key_links:
    - from: "pkg/adapter/nfs/nlm_service.go"
      to: "pkg/metadata/lock/manager.go"
      via: "NLMService holds LockManager reference"
      pattern: "lockMgr.*LockManager"
    - from: "pkg/adapter/smb/adapter.go"
      to: "pkg/metadata/lock/manager.go"
      via: "SMB adapter registers BreakCallbacks with LockManager"
      pattern: "RegisterBreakCallbacks"
    - from: "pkg/adapter/nfs/adapter.go"
      to: "pkg/metadata/lock/manager.go"
      via: "NFS adapter registers OnOpLockBreak for delegation recall"
      pattern: "RegisterBreakCallbacks|OnOpLockBreak"
---

<objective>
Extract NLM methods from MetadataService to NFS adapter and remove SMB lease methods, wiring both adapters to the new LockManager.

Purpose: Remove protocol-specific lock operations from the generic MetadataService. NLM methods move to a dedicated NLMService in the NFS adapter (using LockManager directly to avoid import cycles). SMB lease methods are replaced by centralized break operations in LockManager. Both adapters register typed break callbacks.

Output: Slim MetadataService (~550 lines), NLMService in NFS adapter, SMB adapter using generic UnifiedLock, no OplockChecker global.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-generic-lock-interface-protocol-leak-purge/26-CONTEXT.md
@.planning/phases/26-generic-lock-interface-protocol-leak-purge/26-RESEARCH.md
@.planning/phases/26-generic-lock-interface-protocol-leak-purge/26-01-SUMMARY.md
@.planning/phases/26-generic-lock-interface-protocol-leak-purge/26-03-SUMMARY.md
@pkg/metadata/service.go
@pkg/adapter/nfs/
@pkg/adapter/smb/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract NLM methods to NFS adapter NLMService</name>
  <files>
    pkg/adapter/nfs/nlm_service.go
    pkg/metadata/service.go
    pkg/metadata/lock_exports.go
  </files>
  <action>
    **1. Create NLMService in NFS adapter:**
    Create `pkg/adapter/nfs/nlm_service.go`:
    - Define minimal `FileChecker` interface to avoid import cycle with `pkg/metadata`:
      ```go
      type FileChecker interface {
          GetFile(ctx context.Context, handle []byte) (exists bool, isDir bool, err error)
      }
      ```
    - Define `NLMService` struct:
      ```go
      type NLMService struct {
          lockMgr     lock.LockManager   // from pkg/metadata/lock
          fileChecker FileChecker
          onUnlock    func(handle []byte) // callback for async unlock notification
      }
      ```
    - Move these methods from `pkg/metadata/service.go` to NLMService with simplified signatures:
      - `LockFileNLM(ctx, handle, owner, offset, length, exclusive, reclaim) -> (*lock.LockResult, error)`
      - `TestLockNLM(ctx, handle, owner, offset, length, exclusive) -> (*lock.LockConflict, error)`
      - `UnlockFileNLM(ctx, handle, owner, offset, length) -> error`
      - `CancelBlockingLock(ctx, handle, owner, offset, length) -> error`
    - Per user decision: simplify signatures during move (not just copy). Remove MetadataService-specific boilerplate. The NLMService methods call `s.lockMgr.AddUnifiedLock()` directly.
    - Add `SetNLMUnlockCallback` method (moved from MetadataService)

    **2. Wire NLMService into NFS adapter:**
    - In the NFS adapter setup (likely `pkg/adapter/nfs/adapter.go` or connection handler):
      - Create NLMService when adapter starts, injecting LockManager from runtime
      - The `FileChecker` interface can be satisfied by a thin wrapper around MetadataService's GetFile or GetAttributes
      - Wire NLM handler dispatch to call NLMService methods instead of MetadataService

    **3. Update NLM protocol handlers:**
    - In `internal/protocol/nfs/v3/handlers/` or wherever NLM handlers live:
      - Update imports from `metadataService.LockFileNLM(...)` -> `nlmService.LockFileNLM(...)`
      - The handler still receives auth context and passes it through
    - In NLM mount handlers (if they call MetadataService for lock ops), update to use NLMService

    **4. Remove NLM methods from MetadataService:**
    - Delete `LockFileNLM`, `TestLockNLM`, `UnlockFileNLM`, `CancelBlockingLock`, `SetNLMUnlockCallback` from `pkg/metadata/service.go` (lines ~522-772, ~250 lines)
    - Remove any NLM-specific imports from service.go
    - Update `lock_exports.go` if it re-exports NLM-specific functions

    **5. Fix all callers:**
    - Grep for `LockFileNLM`, `TestLockNLM`, `UnlockFileNLM`, `CancelBlockingLock` across the codebase
    - Update each call site to use the new NLMService
    - If tests mock MetadataService for NLM methods, update mocks to use NLMService instead

    CRITICAL: The NLMService imports `pkg/metadata/lock` (for LockManager), NOT `pkg/metadata` (for MetadataService). This avoids the import cycle. The `FileChecker` interface is the boundary.
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build ./pkg/adapter/nfs/... && go build ./pkg/metadata/...</automated>
    <manual>Verify no import cycle. NLM methods gone from MetadataService. NLMService uses LockManager directly.</manual>
  </verify>
  <done>NLM methods extracted from MetadataService to NLMService in NFS adapter. No import cycle. NLMService uses LockManager directly. All NLM handlers updated to use NLMService.</done>
</task>

<task type="auto">
  <name>Task 2: Remove SMB lease methods and wire adapters to centralized breaks</name>
  <files>
    pkg/metadata/service.go
    pkg/adapter/smb/adapter.go
    pkg/adapter/nfs/adapter.go
    pkg/metadata/lock_exports.go
  </files>
  <action>
    **1. Remove SMB lease methods from MetadataService:**
    Delete from `pkg/metadata/service.go` (lines ~774-994, ~220 lines):
    - `OplockChecker` interface definition
    - `SetOplockChecker()` global setter
    - `GetOplockChecker()` global getter
    - `CheckAndBreakLeasesForWrite()`
    - `CheckAndBreakLeasesForRead()`
    - `CheckAndBreakLeasesForDelete()`
    - `ReclaimLeaseSMB()`
    - Any global `oplockChecker` variable

    These are replaced by centralized methods on LockManager:
    - `CheckAndBreakOpLocksForWrite()` / `ForRead()` / `ForDelete()` (from Plan 03)

    **2. Update all callers of removed methods:**
    Grep for each removed method across the entire codebase:
    - `CheckAndBreakLeasesForWrite` -> `lockManager.CheckAndBreakOpLocksForWrite(handleKey, &excludeOwner)`
    - `CheckAndBreakLeasesForRead` -> `lockManager.CheckAndBreakOpLocksForRead(handleKey, &excludeOwner)`
    - `CheckAndBreakLeasesForDelete` -> `lockManager.CheckAndBreakOpLocksForDelete(handleKey, &excludeOwner)`
    - `SetOplockChecker` / `GetOplockChecker` -> remove entirely
    - `ReclaimLeaseSMB` -> generalize to `lockManager.ReclaimOpLock()` or handle in adapter

    Key callers to update:
    - NFS v3 WRITE handler: calls CheckAndBreakLeasesForWrite before write
    - NFS v3 REMOVE handler: calls CheckAndBreakLeasesForDelete
    - NFS v4 handlers: may call through state manager
    - SMB handlers: already use lease operations

    **3. Wire SMB adapter to generic UnifiedLock:**
    Per user decision: SMB adapter uses generic UnifiedLock interface only, no SMB-specific lease wrapper.
    - SMB adapter registers all 3 `BreakCallbacks` with LockManager at setup:
      ```go
      lockMgr.RegisterBreakCallbacks(&smbBreakHandler{adapter: a})
      ```
    - `smbBreakHandler` implements:
      - `OnOpLockBreak(groupKey, targetState)` -> sends SMB OPLOCK_BREAK notification to client
      - `OnByteRangeRevoke(handle, offset, length)` -> sends SMB lock break notification
      - `OnAccessConflict(handle, mode)` -> handles share mode conflict
    - SMB open/lock operations use `lockMgr.AddUnifiedLock()` with OpLock/AccessMode set
    - SMB lease key `[16]byte` converted to string GroupKey: `hex.EncodeToString(leaseKey[:])`

    **4. Wire NFS adapter to break callbacks:**
    - NFS adapter registers `OnOpLockBreak` callback for delegation recall:
      ```go
      lockMgr.RegisterBreakCallbacks(&nfsBreakHandler{stateManager: sm})
      ```
    - `nfsBreakHandler` implements `OnOpLockBreak` -> triggers NFSv4 CB_RECALL
    - `OnByteRangeRevoke` and `OnAccessConflict` can be no-ops for NFS
    - NFSv4 delegation code that previously used `OplockChecker` now uses LockManager directly

    **5. Update lock_exports.go:**
    - Remove re-exports of deleted functions (`SetOplockChecker`, `GetOplockChecker`, `CheckAndBreakLeases*`, `ReclaimLeaseSMB`)
    - Add re-export for `LockManager` interface if needed by consumers

    **6. Run tests and fix failures:**
    - `go test ./pkg/metadata/...` -- verify MetadataService tests pass without NLM/SMB methods
    - `go test ./pkg/adapter/...` -- verify adapter tests pass with new wiring
    - `go test ./...` -- full test suite
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go test ./... 2>&1 | tail -30</automated>
    <manual>Verify MetadataService has no NLM/SMB methods. No OplockChecker global. Both adapters register BreakCallbacks.</manual>
  </verify>
  <done>SMB lease methods removed from MetadataService. OplockChecker global eliminated. SMB adapter uses generic UnifiedLock + BreakCallbacks. NFS adapter registers OnOpLockBreak for delegation recall. All callers updated to use centralized LockManager breaks. All tests pass.</done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles cleanly
2. `go test ./...` passes
3. `grep -rn 'LockFileNLM\|TestLockNLM\|UnlockFileNLM\|CancelBlockingLock' pkg/metadata/service.go` returns no results
4. `grep -rn 'OplockChecker\|SetOplockChecker\|GetOplockChecker' pkg/metadata/` returns no results
5. `grep -rn 'CheckAndBreakLeases' pkg/metadata/service.go` returns no results (these methods are gone)
6. `grep -rn 'type NLMService struct' pkg/adapter/nfs/nlm_service.go` confirms NLM extraction
7. `grep -rn 'RegisterBreakCallbacks' pkg/adapter/smb/ pkg/adapter/nfs/` confirms both adapters register
8. `wc -l pkg/metadata/service.go` shows ~550 lines (down from 994)
</verification>

<success_criteria>
- MetadataService has ~550 lines, containing only generic file operations
- NLMService in pkg/adapter/nfs/ with 4 lock methods using LockManager directly
- No import cycle between NFS adapter and metadata package
- OplockChecker global variable and interface completely removed
- SMB adapter registers BreakCallbacks and uses generic UnifiedLock
- NFS adapter registers OnOpLockBreak for delegation recall
- All callers of removed MetadataService methods updated
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/26-generic-lock-interface-protocol-leak-purge/26-04-SUMMARY.md`
</output>
