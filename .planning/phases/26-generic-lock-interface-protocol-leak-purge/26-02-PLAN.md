---
phase: 26-generic-lock-interface-protocol-leak-purge
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/controlplane/models/share_adapter_config.go
  - pkg/controlplane/models/share.go
  - pkg/controlplane/store/interface.go
  - pkg/controlplane/store/gorm.go
  - pkg/controlplane/store/shares.go
  - pkg/controlplane/store/netgroups.go
  - pkg/controlplane/store/identity_mappings.go
  - pkg/controlplane/store/adapter_configs.go
  - pkg/controlplane/runtime/share.go
autonomous: true
requirements:
  - REF-02

must_haves:
  truths:
    - "Share model has no NFS-specific fields (Squash, AnonymousUID/GID, AllowAuthSys, RequireKerberos, etc.)"
    - "Share model has no SMB-specific fields (GuestEnabled, GuestUID, GuestGID)"
    - "share_adapter_configs table stores per-adapter per-share typed JSON config"
    - "Netgroup and IdentityMapping methods are separate interfaces, not on main Store"
    - "GORM auto-migration creates new table and drops old columns"
  artifacts:
    - path: "pkg/controlplane/models/share_adapter_config.go"
      provides: "ShareAdapterConfig GORM model with share_id + adapter_type + config JSON"
      contains: "type ShareAdapterConfig struct"
    - path: "pkg/controlplane/store/interface.go"
      provides: "Store interface without netgroup/identity methods, plus NetgroupStore and IdentityMappingStore interfaces"
      contains: "type NetgroupStore interface"
    - path: "pkg/controlplane/store/adapter_configs.go"
      provides: "CRUD operations for ShareAdapterConfig"
      contains: "func.*AdapterConfig"
    - path: "pkg/controlplane/models/share.go"
      provides: "Clean Share model without protocol fields"
      contains: "type Share struct"
  key_links:
    - from: "pkg/controlplane/models/share_adapter_config.go"
      to: "pkg/controlplane/store/adapter_configs.go"
      via: "GORM CRUD operations on ShareAdapterConfig model"
      pattern: "ShareAdapterConfig"
    - from: "pkg/controlplane/store/interface.go"
      to: "pkg/controlplane/store/gorm.go"
      via: "GORMStore implements Store + NetgroupStore + IdentityMappingStore"
      pattern: "NetgroupStore|IdentityMappingStore"
---

<objective>
Clean the Share model and Store interface of protocol-specific code, create adapter config system.

Purpose: Remove NFS/SMB-specific fields from the Share model and Store interface, replacing them with a generic `share_adapter_configs` table for per-adapter typed JSON configuration. Extract Netgroup and IdentityMapping methods into separate interfaces that NFS adapter can type-assert.

Output: Clean Share model, ShareAdapterConfig GORM model, adapter config CRUD, narrower Store interface with separate NetgroupStore/IdentityMappingStore interfaces.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-generic-lock-interface-protocol-leak-purge/26-CONTEXT.md
@.planning/phases/26-generic-lock-interface-protocol-leak-purge/26-RESEARCH.md
@pkg/controlplane/models/share.go
@pkg/controlplane/store/interface.go
@pkg/controlplane/store/gorm.go
@pkg/controlplane/store/shares.go
@pkg/controlplane/runtime/share.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ShareAdapterConfig model and clean Share model</name>
  <files>
    pkg/controlplane/models/share_adapter_config.go
    pkg/controlplane/models/share.go
    pkg/controlplane/runtime/share.go
  </files>
  <action>
    **1. Create ShareAdapterConfig GORM model:**
    Create `pkg/controlplane/models/share_adapter_config.go`:
    ```go
    type ShareAdapterConfig struct {
        ID          string    `gorm:"primaryKey;size:36" json:"id"`
        ShareID     string    `gorm:"not null;size:36;uniqueIndex:idx_share_adapter" json:"share_id"`
        AdapterType string    `gorm:"not null;size:50;uniqueIndex:idx_share_adapter" json:"adapter_type"`
        Config      string    `gorm:"type:text" json:"config"`
        CreatedAt   time.Time `gorm:"autoCreateTime" json:"created_at"`
        UpdatedAt   time.Time `gorm:"autoUpdateTime" json:"updated_at"`
    }

    func (ShareAdapterConfig) TableName() string {
        return "share_adapter_configs"
    }
    ```
    Add helper methods: `ParseConfig(target interface{}) error` (json.Unmarshal) and `SetConfig(source interface{}) error` (json.Marshal).

    **2. Remove protocol-specific fields from Share model:**
    In `pkg/controlplane/models/share.go`, remove these NFS-specific fields:
    - `Squash` / `SquashMode`
    - `AnonymousUID`, `AnonymousGID`
    - `AllowAuthSys`, `RequireKerberos`, `MinKerberosLevel`
    - `NetgroupID`
    - `DisableReaddirplus`

    Remove these SMB-specific fields:
    - `GuestEnabled`, `GuestUID`, `GuestGID`

    Move `SquashMode` type definition to the NFS adapter package (it will be used in NFS export options). If `SquashMode` is defined in `models/`, move it. If it's referenced elsewhere generically, create a type alias temporarily.

    **3. Clean runtime Share struct:**
    In `pkg/controlplane/runtime/share.go`, remove NFS-specific fields:
    - `Squash`, `AnonymousUID`, `AnonymousGID`
    - `DisableReaddirplus`
    - `AllowAuthSys`, `RequireKerberos`, `MinKerberosLevel`, `NetgroupName`

    Keep generic fields: `Name`, `MetadataStoreName`, `PayloadStoreName`, `RootHandle`, `BlockedOperations`

    **4. Define typed adapter config structs:**
    Create NFS export options type (can be in `pkg/adapter/nfs/` or temporarily alongside ShareAdapterConfig):
    ```go
    type NFSExportOptions struct {
        Squash             string  `json:"squash"`
        AnonymousUID       *uint32 `json:"anonymous_uid,omitempty"`
        AnonymousGID       *uint32 `json:"anonymous_gid,omitempty"`
        AllowAuthSys       bool    `json:"allow_auth_sys"`
        RequireKerberos    bool    `json:"require_kerberos"`
        MinKerberosLevel   string  `json:"min_kerberos_level"`
        NetgroupID         *string `json:"netgroup_id,omitempty"`
        DisableReaddirplus bool    `json:"disable_readdirplus"`
    }
    ```
    Create SMB share options type:
    ```go
    type SMBShareOptions struct {
        GuestEnabled bool    `json:"guest_enabled"`
        GuestUID     *uint32 `json:"guest_uid,omitempty"`
        GuestGID     *uint32 `json:"guest_gid,omitempty"`
    }
    ```

    **5. Update all code that reads/writes removed Share fields:**
    - Search for every reference to the removed fields across the codebase
    - NFS adapter code that reads `share.Squash`, `share.AnonymousUID`, etc. should now load from ShareAdapterConfig
    - SMB adapter code that reads `share.GuestEnabled`, etc. should now load from ShareAdapterConfig
    - Add helper function to load adapter config: `func LoadAdapterConfig[T any](store Store, shareID string, adapterType string) (*T, error)`
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build ./pkg/controlplane/models/...</automated>
    <manual>Verify Share struct has no Squash/AnonymousUID/GuestEnabled/etc. fields. ShareAdapterConfig model exists.</manual>
  </verify>
  <done>Share model is clean of protocol-specific fields. ShareAdapterConfig model exists with JSON config. NFS/SMB typed config structs defined. SquashMode moved to NFS adapter.</done>
</task>

<task type="auto">
  <name>Task 2: Extract NetgroupStore/IdentityMappingStore interfaces and create adapter config CRUD</name>
  <files>
    pkg/controlplane/store/interface.go
    pkg/controlplane/store/gorm.go
    pkg/controlplane/store/adapter_configs.go
  </files>
  <action>
    **1. Split Store interface:**
    In `pkg/controlplane/store/interface.go`:
    - Remove these 9 netgroup methods from the main `Store` interface:
      `GetNetgroup`, `GetNetgroupByID`, `ListNetgroups`, `CreateNetgroup`, `DeleteNetgroup`, `AddNetgroupMember`, `RemoveNetgroupMember`, `GetNetgroupMembers`, `GetSharesByNetgroup`
    - Remove these 4 identity mapping methods from the main `Store` interface:
      `GetIdentityMapping`, `ListIdentityMappings`, `CreateIdentityMapping`, `DeleteIdentityMapping`
    - Create separate interfaces:
      ```go
      type NetgroupStore interface {
          GetNetgroup(name string) (*models.Netgroup, error)
          GetNetgroupByID(id string) (*models.Netgroup, error)
          ListNetgroups() ([]models.Netgroup, error)
          CreateNetgroup(netgroup *models.Netgroup) error
          DeleteNetgroup(id string) error
          AddNetgroupMember(netgroupID string, member *models.NetgroupMember) error
          RemoveNetgroupMember(netgroupID, memberID string) error
          GetNetgroupMembers(netgroupID string) ([]models.NetgroupMember, error)
          GetSharesByNetgroup(netgroupID string) ([]models.Share, error)
      }

      type IdentityMappingStore interface {
          GetIdentityMapping(id string) (*models.IdentityMapping, error)
          ListIdentityMappings() ([]models.IdentityMapping, error)
          CreateIdentityMapping(mapping *models.IdentityMapping) error
          DeleteIdentityMapping(id string) error
      }
      ```
    - Add adapter config methods to the main `Store` interface:
      ```go
      // Adapter config methods
      GetShareAdapterConfig(shareID, adapterType string) (*models.ShareAdapterConfig, error)
      SetShareAdapterConfig(config *models.ShareAdapterConfig) error
      DeleteShareAdapterConfig(shareID, adapterType string) error
      ListShareAdapterConfigs(shareID string) ([]models.ShareAdapterConfig, error)
      ```

    **2. Implement adapter config CRUD:**
    Create `pkg/controlplane/store/adapter_configs.go`:
    - Implement `GetShareAdapterConfig`, `SetShareAdapterConfig` (upsert), `DeleteShareAdapterConfig`, `ListShareAdapterConfigs` on GORMStore
    - Use GORM's `FirstOrCreate` / `Save` pattern for upsert

    **3. Update GORMStore to implement all interfaces:**
    - GORMStore already implements the netgroup and identity mapping methods (they stay on GORMStore)
    - Ensure GORMStore still satisfies the main `Store` interface (which no longer includes netgroup/identity methods)
    - Verify GORMStore also satisfies `NetgroupStore` and `IdentityMappingStore` interfaces
    - Add `var _ NetgroupStore = (*GORMStore)(nil)` compile-time assertions

    **4. Add GORM auto-migration:**
    - In the store initialization code (likely `gorm.go` or migration function), add `db.AutoMigrate(&models.ShareAdapterConfig{})`
    - Add explicit column drops for removed Share fields:
      ```go
      migrator := db.Migrator()
      // Drop NFS-specific columns
      for _, col := range []string{"squash", "anonymous_uid", "anonymous_gid", "allow_auth_sys", "require_kerberos", "min_kerberos_level", "netgroup_id", "disable_readdirplus"} {
          if migrator.HasColumn(&models.Share{}, col) {
              migrator.DropColumn(&models.Share{}, col)
          }
      }
      // Drop SMB-specific columns
      for _, col := range []string{"guest_enabled", "guest_uid", "guest_gid"} {
          if migrator.HasColumn(&models.Share{}, col) {
              migrator.DropColumn(&models.Share{}, col)
          }
      }
      ```

    **5. Update consumers of removed Store methods:**
    - NFS API handlers (`handlers/netgroups.go`, `handlers/identity_mappings.go`) that call these methods should type-assert `store.(NetgroupStore)` at handler setup
    - Update handler constructors to accept narrower interface where possible
    - Runtime code calling netgroup/identity methods should similarly type-assert
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build ./pkg/controlplane/...</automated>
    <manual>Verify Store interface no longer has netgroup/identity methods. NetgroupStore and IdentityMappingStore are separate interfaces. Adapter config CRUD exists.</manual>
  </verify>
  <done>Store interface is narrower (no netgroup/identity methods). NetgroupStore and IdentityMappingStore are separate interfaces. ShareAdapterConfig CRUD implemented. Auto-migration creates new table and drops old columns. NFS handlers type-assert for netgroup/identity store access.</done>
</task>

<task type="auto">
  <name>Task 3: Compile and test Share model + Store changes</name>
  <files>
    pkg/controlplane/store/adapter_configs.go
    pkg/controlplane/models/share_adapter_config.go
  </files>
  <action>
    **1. Fix all compilation errors from Share field removal:**
    - Search for every reference to removed Share fields across the entire codebase
    - NFS adapter code reading `share.Squash` should now call `store.GetShareAdapterConfig(shareID, "nfs")` and parse into NFSExportOptions
    - SMB adapter code reading `share.GuestEnabled` should now call `store.GetShareAdapterConfig(shareID, "smb")` and parse into SMBShareOptions
    - Share creation code that sets protocol-specific fields should now create corresponding ShareAdapterConfig records
    - API handlers for share create/update that accept protocol-specific fields should be updated to use adapter config API
    - dfsctl share commands that pass protocol-specific fields should be updated

    **2. Update share loading in runtime:**
    - When shares are loaded on startup, also load their adapter configs
    - Adapter-specific config is made available through the runtime to the respective adapter
    - NFS adapter retrieves its export options from the adapter config system, not from Share fields

    **3. Fix tests:**
    - Update Share model test fixtures (remove protocol-specific fields from literal construction)
    - Update store tests for shares (remove assertions on removed fields)
    - Add tests for ShareAdapterConfig CRUD
    - Add test for auto-migration (column drops work correctly)

    **4. Run full test suite:**
    - `go test ./pkg/controlplane/...`
    - `go test ./pkg/adapter/...`
    - `go test ./...`
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go test ./pkg/controlplane/... 2>&1 | tail -20</automated>
    <manual>Verify share tests pass without protocol-specific fields. Adapter config CRUD tests pass.</manual>
  </verify>
  <done>All compilation errors from Share field removal fixed. Adapter config system working. Store tests pass. Share creation/loading uses adapter config for protocol-specific settings.</done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles cleanly
2. `go test ./pkg/controlplane/...` passes
3. `grep -rn 'Squash\|AnonymousUID\|GuestEnabled' pkg/controlplane/models/share.go` returns no results
4. `grep -rn 'type ShareAdapterConfig struct' pkg/controlplane/models/share_adapter_config.go` confirms model exists
5. `grep -rn 'NetgroupStore\|IdentityMappingStore' pkg/controlplane/store/interface.go` confirms separate interfaces
6. Share model has no more than generic fields (name, metadata store, payload store, etc.)
</verification>

<success_criteria>
- Share model has zero NFS/SMB-specific fields
- share_adapter_configs table with ShareID + AdapterType unique index
- NetgroupStore and IdentityMappingStore are separate interfaces
- Main Store interface has 13 fewer methods (9 netgroup + 4 identity)
- Adapter config CRUD (get, set, delete, list) implemented
- Auto-migration drops old columns and creates new table
- All controlplane tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/26-generic-lock-interface-protocol-leak-purge/26-02-SUMMARY.md`
</output>
