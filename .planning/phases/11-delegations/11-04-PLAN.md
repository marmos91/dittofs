---
phase: 11-delegations
plan: 04
type: execute
wave: 4
depends_on: ["11-03"]
files_modified:
  - internal/protocol/nfs/v4/state/delegation.go
  - internal/protocol/nfs/v4/state/callback.go
  - internal/protocol/nfs/v4/state/manager.go
  - internal/protocol/nfs/v4/state/delegation_test.go
autonomous: true

must_haves:
  truths:
    - "Delegation is revoked after lease period expires since recall attempt"
    - "Revoked delegation returns NFS4ERR_BAD_STATEID on subsequent operations"
    - "Callback path verified via CB_NULL on SETCLIENTID_CONFIRM"
    - "Callback path status tracked per client (cbPathUp flag)"
    - "Recently-recalled files are not immediately re-granted delegations"
    - "Recall timer fires revocation after lease duration since RecallTime"
  artifacts:
    - path: "internal/protocol/nfs/v4/state/delegation.go"
      provides: "Recall timer, revocation logic, recently-recalled cache"
      min_lines: 50
    - path: "internal/protocol/nfs/v4/state/manager.go"
      provides: "RevokeDelegation, callback path tracking, recently-recalled check in ShouldGrantDelegation"
      min_lines: 40
    - path: "internal/protocol/nfs/v4/state/delegation_test.go"
      provides: "Tests for recall timeout, revocation, callback path, recently-recalled"
      min_lines: 200
  key_links:
    - from: "internal/protocol/nfs/v4/state/delegation.go"
      to: "internal/protocol/nfs/v4/state/manager.go"
      via: "Recall timer calls RevokeDelegation on expiry"
      pattern: "RevokeDelegation"
    - from: "internal/protocol/nfs/v4/state/manager.go"
      to: "internal/protocol/nfs/v4/state/callback.go"
      via: "CB_NULL sent on SETCLIENTID_CONFIRM for path verification"
      pattern: "SendCBNull"
    - from: "internal/protocol/nfs/v4/state/manager.go"
      to: "internal/protocol/nfs/v4/state/delegation.go"
      via: "ShouldGrantDelegation checks recentlyRecalled before granting"
      pattern: "recentlyRecalled"
---

<objective>
Implement delegation recall timeout with revocation, callback path health tracking, and recently-recalled anti-storm protection.

Purpose: This plan completes the delegation lifecycle by handling the failure cases: what happens when a client does not respond to CB_RECALL, when the callback path is unavailable, and when delegation grant-recall cycles happen too rapidly. After this plan, delegations are fully production-ready with proper timeout handling, revocation, and anti-storm protection.

Output: Recall timeout timers that fire revocation, callback path verification via CB_NULL, per-client cbPathUp tracking, recently-recalled file cache preventing re-grant storms, comprehensive tests.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-delegations/11-RESEARCH.md
@.planning/phases/11-delegations/11-01-SUMMARY.md
@.planning/phases/11-delegations/11-02-SUMMARY.md
@.planning/phases/11-delegations/11-03-SUMMARY.md
@internal/protocol/nfs/v4/state/manager.go
@internal/protocol/nfs/v4/state/delegation.go
@internal/protocol/nfs/v4/state/callback.go
@internal/protocol/nfs/v4/state/client.go
@internal/protocol/nfs/v4/state/lease.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Recall timer, revocation, callback path tracking, and recently-recalled cache</name>
  <files>
    internal/protocol/nfs/v4/state/delegation.go
    internal/protocol/nfs/v4/state/callback.go
    internal/protocol/nfs/v4/state/manager.go
  </files>
  <action>
1. **Add recall timer to DelegationState** in delegation.go:
   - Add `RecallTimer *time.Timer` field to DelegationState
   - This timer fires after the lease duration has elapsed since the recall was sent
   - Per RFC 7530 Section 10.4.6: "The server MUST NOT revoke the delegation before the lease period has expired"

2. **Add StartRecallTimer method** to delegation.go:
   - `func (d *DelegationState) StartRecallTimer(leaseDuration time.Duration, onExpiry func())`
   - Uses `time.AfterFunc(leaseDuration, onExpiry)` matching the LeaseState pattern from Phase 9
   - The onExpiry callback will call StateManager.RevokeDelegation
   - If a timer already exists, stop it first (idempotent)

3. **Add StopRecallTimer method** to delegation.go:
   - `func (d *DelegationState) StopRecallTimer()`
   - Stops the timer if it exists (called when delegation is returned voluntarily)

4. **Add RevokeDelegation method to StateManager** in manager.go:
   - `func (sm *StateManager) RevokeDelegation(delegOther [types.NFS4_OTHER_SIZE]byte)`
   - Acquires sm.mu.Lock
   - Look up delegation in delegByOther
   - If not found (already returned): do nothing
   - Set delegation.Revoked = true
   - Remove from delegByFile (other delegations on same file unaffected)
   - Do NOT remove from delegByOther yet (keep for stale stateid detection)
   - Log at WARN level: "delegation revoked due to recall timeout"
   - Add file handle to recentlyRecalled cache (see below)

5. **Modify ReturnDelegation** (from Plan 11-01) in manager.go or delegation.go:
   - When a delegation is returned successfully, call StopRecallTimer to cancel any pending revocation timer
   - This prevents revocation of a delegation that the client returned in time

6. **Modify sendRecall** (from Plan 11-03) in manager.go:
   - After sending CB_RECALL, start the recall timer:
     ```
     deleg.StartRecallTimer(sm.leaseDuration, func() {
         sm.RevokeDelegation(deleg.Stateid.Other)
     })
     ```
   - If CB_RECALL fails (error from SendCBRecall): start the timer immediately with a shorter timeout (e.g., 5 seconds) since the callback path is clearly down
   - Also mark client's cbPathUp = false on CB_RECALL failure

7. **Add callback path tracking to ClientRecord** in client.go:
   - Add `CBPathUp bool` field to ClientRecord
   - Default to false (not verified)

8. **Modify ConfirmClientID in manager.go:**
   - After confirming the client, launch an async goroutine to verify callback path:
     ```
     go func() {
         err := SendCBNull(context.Background(), record.Callback)
         sm.mu.Lock()
         defer sm.mu.Unlock()
         record.CBPathUp = (err == nil)
         if err != nil {
             logger.Warn("CB_NULL failed, delegations disabled for client",
                 "client_id", clientID, "error", err)
         } else {
             logger.Debug("CB_NULL succeeded, delegations enabled for client",
                 "client_id", clientID)
         }
     }()
     ```
   - This runs asynchronously so SETCLIENTID_CONFIRM returns immediately
   - If the client has no callback address, skip the check and leave cbPathUp = false

9. **Modify ShouldGrantDelegation** (from Plan 11-03):
   - Add check for CBPathUp: if !client.CBPathUp, return OPEN_DELEGATE_NONE, false
   - Add check for recently-recalled: if file is in recentlyRecalled cache, return OPEN_DELEGATE_NONE, false
   - The CBPathUp check replaces the simpler "Callback.Addr != empty" check

10. **Implement recently-recalled cache** in delegation.go:
    - Simple TTL-based map: `recentlyRecalled map[string]time.Time` on StateManager
      - Key: string(fileHandle)
      - Value: time when recall happened
    - `addRecentlyRecalled(fileHandle []byte)`: adds entry with current time
    - `isRecentlyRecalled(fileHandle []byte) bool`: returns true if entry exists and is less than 30 seconds old (configurable constant)
    - Clean up stale entries lazily on each check (if entry older than TTL, delete it)
    - This prevents grant-recall-grant-recall storms (Pitfall 7 from research)
    - 30 seconds is a reasonable TTL; matches approximately one third of the default lease duration

11. **Modify Shutdown in manager.go:**
    - Stop all active delegation recall timers during shutdown to prevent timer goroutines firing after shutdown
    - Iterate delegByOther, call StopRecallTimer on each

12. **Handle revoked stateid in ReturnDelegation:**
    - If the delegation is found but Revoked == true: return NFS4_OK anyway (client returning a revoked delegation is fine)
    - Clean up the delegation entry fully (remove from delegByOther too)

13. **Handle revoked stateid in ValidateDelegationStateid:**
    - If delegation exists but Revoked == true: return NFS4ERR_BAD_STATEID per RFC 7530 Section 10.4.6
  </action>
  <verify>
    `cd /Users/marmos91/Projects/dittofs && go build ./internal/protocol/nfs/v4/...` compiles cleanly.
    `go vet ./internal/protocol/nfs/v4/state/` passes.
  </verify>
  <done>
    Recall timer starts after CB_RECALL sent, fires RevokeDelegation after lease duration. Revoked delegations return NFS4ERR_BAD_STATEID. Callback path verified via CB_NULL on SETCLIENTID_CONFIRM. CBPathUp tracked per client. Recently-recalled cache prevents re-grant storms. Recall timers stopped on voluntary return and server shutdown.
  </done>
</task>

<task type="auto">
  <name>Task 2: Comprehensive tests for revocation, callback path, and recently-recalled</name>
  <files>
    internal/protocol/nfs/v4/state/delegation_test.go
  </files>
  <action>
Add the following tests to `delegation_test.go` (extending tests from Plan 11-01):

**Recall Timer and Revocation tests:**
- `TestRecallTimer_FiresRevocation`: Create StateManager with short lease (200ms for testing). Grant delegation. Start recall timer. Wait for timer to fire (250ms). Verify delegation is revoked (Revoked=true). Verify delegation is in delegByOther but not in delegByFile.
- `TestRecallTimer_CancelledOnReturn`: Grant delegation. Start recall timer. Return delegation before timer fires. Wait past timer duration. Verify delegation was NOT revoked (timer was cancelled).
- `TestRevokeDelegation_CleansState`: Grant delegation. Call RevokeDelegation. Verify delegation.Revoked == true. Verify removed from delegByFile. Verify still in delegByOther (for stale detection).
- `TestRevokeDelegation_AlreadyReturned`: Grant delegation, return it. Call RevokeDelegation. Should be a no-op (delegation already gone from delegByOther).
- `TestRevokedDelegation_BadStateidOnValidate`: Grant delegation, revoke it. Call ValidateDelegationStateid. Verify NFS4ERR_BAD_STATEID.
- `TestRevokedDelegation_ReturnSucceeds`: Grant delegation, revoke it. Client sends DELEGRETURN. Verify NFS4_OK (idempotent cleanup).

**Callback Path Tracking tests:**
- `TestCBPathUp_VerifiedOnConfirm`: Set up mock TCP listener that accepts CB_NULL. Create and confirm client with callback pointing to mock. Wait briefly for async CB_NULL. Verify CBPathUp == true.
- `TestCBPathUp_FailedOnConfirm`: Create and confirm client with callback pointing to unreachable address. Wait briefly. Verify CBPathUp == false.
- `TestCBPathUp_NoCallbackAddr`: Create and confirm client with empty callback address. Verify CBPathUp stays false. Verify ShouldGrantDelegation returns false.
- `TestShouldGrantDelegation_CBPathDown`: Set client.CBPathUp = false. Verify ShouldGrantDelegation returns OPEN_DELEGATE_NONE.

**Recently-Recalled Cache tests:**
- `TestRecentlyRecalled_BlocksGrant`: Grant delegation on file. Recall it (which adds to recently-recalled cache). After delegation is returned, try ShouldGrantDelegation for same file. Verify returns OPEN_DELEGATE_NONE (file is recently recalled).
- `TestRecentlyRecalled_ExpiresAfterTTL`: Add file to recently-recalled cache. Wait for TTL to expire (use a short TTL for testing, or manipulate the timestamp directly). Verify isRecentlyRecalled returns false.
- `TestRecentlyRecalled_DifferentFile`: Add file A to recently-recalled. Verify file B is not recently recalled.

**Shutdown tests:**
- `TestShutdown_StopsRecallTimers`: Grant delegation, start recall timer. Call Shutdown. Wait past timer duration. Verify delegation was NOT revoked (timer cancelled by shutdown).

Use short durations for timers in tests (100-300ms) to keep tests fast. Use `time.Sleep` judiciously or use channels/conditions for synchronization where possible. Run all tests with `-race` flag.
  </action>
  <verify>
    `cd /Users/marmos91/Projects/dittofs && go test -race -v ./internal/protocol/nfs/v4/state/ -run TestRecallTimer` passes recall timer tests.
    `go test -race -v ./internal/protocol/nfs/v4/state/ -run TestRevoke` passes revocation tests.
    `go test -race -v ./internal/protocol/nfs/v4/state/ -run TestCBPath` passes callback path tests.
    `go test -race -v ./internal/protocol/nfs/v4/state/ -run TestRecentlyRecalled` passes cache tests.
    `go test -race -v ./internal/protocol/nfs/v4/state/ -run TestShutdown` passes shutdown test.
    `go test -race ./internal/protocol/nfs/v4/state/` passes all state tests.
    `go test -race ./internal/protocol/nfs/v4/...` passes all v4 tests.
  </verify>
  <done>
    15+ tests pass with race detection covering: recall timer fires revocation after lease period, timer cancelled on voluntary return, revoked delegations return BAD_STATEID, callback path verified via CB_NULL, CBPathUp tracking controls delegation grants, recently-recalled cache prevents re-grant storms, shutdown stops all recall timers.
  </done>
</task>

</tasks>

<verification>
1. `go build ./internal/protocol/nfs/v4/...` compiles without errors
2. `go test -race ./internal/protocol/nfs/v4/state/` passes all tests (delegation + callback + revocation)
3. `go test -race ./internal/protocol/nfs/v4/handlers/` passes all handler tests
4. `go vet ./internal/protocol/nfs/v4/...` reports no issues
5. Recall timer fires revocation after lease period since CB_RECALL (verified in tests)
6. Revoked delegation returns NFS4ERR_BAD_STATEID (verified in tests)
7. CB_NULL verifies callback path on SETCLIENTID_CONFIRM (verified in tests)
8. Recently-recalled files not re-granted (verified in tests)
9. Shutdown cancels all recall timers (verified in tests)
</verification>

<success_criteria>
- Delegation revoked if client does not respond to CB_RECALL within lease period
- Revoked delegation stateid returns NFS4ERR_BAD_STATEID on validate
- DELEGRETURN of revoked delegation returns NFS4_OK (graceful cleanup)
- CB_NULL sent asynchronously on SETCLIENTID_CONFIRM to verify callback path
- CBPathUp=false prevents delegation grants
- Recently-recalled files not immediately re-granted (30s cooldown)
- Recall timers cancelled on voluntary DELEGRETURN and server Shutdown
- All tests pass with -race
</success_criteria>

<output>
After completion, create `.planning/phases/11-delegations/11-04-SUMMARY.md`
</output>
