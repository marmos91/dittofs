---
phase: 12-kerberos-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/auth/kerberos/kerberos.go
  - pkg/auth/kerberos/config.go
  - pkg/auth/kerberos/identity.go
  - internal/protocol/nfs/rpc/gss/types.go
  - internal/protocol/nfs/rpc/gss/sequence.go
  - internal/protocol/nfs/rpc/gss/types_test.go
  - internal/protocol/nfs/rpc/gss/sequence_test.go
  - pkg/config/config.go
  - pkg/config/defaults.go
autonomous: true

must_haves:
  truths:
    - "RPCSEC_GSS credential can be decoded from XDR wire format"
    - "Sequence window correctly tracks seen sequence numbers as bitmap"
    - "KerberosConfig parses keytab path and service principal from config"
    - "Identity mapper converts Kerberos principal to metadata.Identity"
  artifacts:
    - path: "pkg/auth/kerberos/kerberos.go"
      provides: "KerberosProvider interface and implementation"
      contains: "type Provider struct"
    - path: "pkg/auth/kerberos/config.go"
      provides: "KerberosConfig struct"
      contains: "type KerberosConfig struct"
    - path: "pkg/auth/kerberos/identity.go"
      provides: "IdentityMapper for principal-to-UID/GID conversion"
      contains: "type IdentityMapper interface"
    - path: "internal/protocol/nfs/rpc/gss/types.go"
      provides: "RPCSEC_GSS XDR types and constants"
      contains: "type RPCGSSCredV1 struct"
    - path: "internal/protocol/nfs/rpc/gss/sequence.go"
      provides: "Sliding window sequence number tracker"
      contains: "type SeqWindow struct"
  key_links:
    - from: "pkg/auth/kerberos/identity.go"
      to: "pkg/metadata/authentication.go"
      via: "Returns *metadata.Identity"
      pattern: "metadata\\.Identity"
    - from: "internal/protocol/nfs/rpc/gss/types.go"
      to: "internal/protocol/xdr"
      via: "Uses shared XDR decode helpers"
      pattern: "xdr\\.Decode"
---

<objective>
Create the foundation types and configuration for RPCSEC_GSS + Kerberos authentication.

Purpose: Establish all XDR wire types (rpc_gss_cred_t, rpc_gss_init_res), the sequence number window tracker, the shared Kerberos provider interface, identity mapping, and configuration schema. These are leaf-level types with no business logic dependencies, enabling parallel development of the context state machine and RPC integration in subsequent plans.

Output: pkg/auth/kerberos/ package, internal/protocol/nfs/rpc/gss/ types, KerberosConfig in pkg/config/
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-kerberos-authentication/12-RESEARCH.md
@internal/protocol/nfs/rpc/auth.go
@internal/protocol/nfs/rpc/constants.go
@internal/protocol/nfs/rpc/message.go
@internal/protocol/xdr/xdr.go
@pkg/metadata/authentication.go
@pkg/config/config.go
@pkg/config/defaults.go
@internal/auth/spnego/spnego.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: RPCSEC_GSS XDR Types and Sequence Window</name>
  <files>
    internal/protocol/nfs/rpc/gss/types.go
    internal/protocol/nfs/rpc/gss/sequence.go
    internal/protocol/nfs/rpc/gss/types_test.go
    internal/protocol/nfs/rpc/gss/sequence_test.go
  </files>
  <action>
Create `internal/protocol/nfs/rpc/gss/` package with RPCSEC_GSS wire protocol types.

**types.go:**
- Constants: AuthRPCSECGSS=6, RPCGSSVers1=1, RPCGSSData=0, RPCGSSInit=1, RPCGSSContinueInit=2, RPCGSSDestroy=3, RPCGSSSvcNone=1, RPCGSSSvcIntegrity=2, RPCGSSSvcPrivacy=3
- MAXSEQ = 0x80000000 per RFC 2203
- GSS major status codes: GSSComplete=0, GSSContinueNeeded=1, GSSDefectiveCredential
- KRB5 OID: 1.2.840.113554.1.2.2 (as []int for comparison)
- Pseudo-flavor constants: PseudoFlavorKrb5=390003, PseudoFlavorKrb5i=390004, PseudoFlavorKrb5p=390005
- RPCGSSCredV1 struct: GSSProc uint32, SeqNum uint32, Service uint32, Handle []byte
- DecodeGSSCred(body []byte) (*RPCGSSCredV1, error): XDR decode from credential body. Reads version first (must be 1), then GSSProc, SeqNum, Service, Handle (as opaque). Use bytes.NewReader + binary.BigEndian reads (matching existing XDR patterns in the project). Reject unknown versions.
- EncodeGSSCred(cred *RPCGSSCredV1) ([]byte, error): XDR encode for testing
- RPCGSSInitRes struct: Handle []byte, GSSMajor uint32, GSSMinor uint32, SeqWindow uint32, GSSToken []byte
- EncodeGSSInitRes(res *RPCGSSInitRes) ([]byte, error): XDR encode (used when building INIT reply)
- Add AuthRPCSECGSS constant to rpc/auth.go constants block (value 6) -- do NOT duplicate, add to existing file alongside AuthNull/AuthUnix/AuthShort/AuthDES

**sequence.go:**
- SeqWindow struct: size uint32, highest uint32, bitmap []uint64 (bit array), mu sync.Mutex
- NewSeqWindow(size uint32) *SeqWindow: creates window. Bitmap size = (size+63)/64 uint64s
- Accept(seqNum uint32) bool: thread-safe. Returns false for: seq > MAXSEQ, duplicate, below window (seq < highest-size). For valid seq: if seq > highest, slide window forward clearing old bits. Mark seq as seen. Return true.
- Silent discard semantics per RFC 2203 Section 5.3.3.1: no error replies for violations
- Reset() method for testing
- Key usage constants for RFC 4121: KeyUsageInitiatorSign=23, KeyUsageAcceptorSign=25, KeyUsageInitiatorSeal=24, KeyUsageAcceptorSeal=26

**types_test.go:**
- Test DecodeGSSCred with valid INIT credential (handle empty, gss_proc=1)
- Test DecodeGSSCred with valid DATA credential (handle non-empty, gss_proc=0)
- Test DecodeGSSCred rejects version != 1
- Test EncodeGSSCred roundtrip
- Test EncodeGSSInitRes produces valid XDR

**sequence_test.go:**
- Test Accept returns true for new sequence numbers
- Test Accept returns false for duplicates
- Test Accept returns false for seq below window
- Test window slides forward when higher seq received
- Test MAXSEQ boundary
- Test concurrent Accept calls (goroutine safety)
  </action>
  <verify>cd /Users/marmos91/Projects/dittofs && go test ./internal/protocol/nfs/rpc/gss/... -race -count=1</verify>
  <done>RPCSEC_GSS XDR types decode/encode correctly, sequence window accepts valid seqs and rejects duplicates/out-of-range, all tests pass with -race</done>
</task>

<task type="auto">
  <name>Task 2: Shared Kerberos Provider and Configuration</name>
  <files>
    pkg/auth/kerberos/kerberos.go
    pkg/auth/kerberos/config.go
    pkg/auth/kerberos/identity.go
    pkg/config/config.go
    pkg/config/defaults.go
  </files>
  <action>
Create `pkg/auth/kerberos/` package as the shared Kerberos layer.

**config.go:**
- KerberosConfig struct with fields:
  - Enabled bool (mapstructure:"enabled" yaml:"enabled")
  - KeytabPath string (mapstructure:"keytab_path" yaml:"keytab_path")
  - ServicePrincipal string (mapstructure:"service_principal" yaml:"service_principal")
  - Krb5Conf string (mapstructure:"krb5_conf" yaml:"krb5_conf") -- defaults to /etc/krb5.conf
  - MaxClockSkew time.Duration (mapstructure:"max_clock_skew" yaml:"max_clock_skew") -- default 5m
  - ContextTTL time.Duration (mapstructure:"context_ttl" yaml:"context_ttl") -- default 8h
  - MaxContexts int (mapstructure:"max_contexts" yaml:"max_contexts") -- default 10000
  - IdentityMapping IdentityMappingConfig (mapstructure:"identity_mapping" yaml:"identity_mapping")
- IdentityMappingConfig struct:
  - Strategy string (mapstructure:"strategy" yaml:"strategy") -- "static" initially
  - StaticMap map[string]StaticIdentity (mapstructure:"static_map" yaml:"static_map")
  - DefaultUID uint32 (mapstructure:"default_uid" yaml:"default_uid") -- 65534
  - DefaultGID uint32 (mapstructure:"default_gid" yaml:"default_gid") -- 65534
- StaticIdentity struct: UID uint32, GID uint32, GIDs []uint32

**kerberos.go:**
- Provider struct: keytab *keytab.Keytab, krb5Conf *config.Config (from gokrb5), servicePrincipal string, maxClockSkew time.Duration, mu sync.RWMutex
- NewProvider(cfg *KerberosConfig) (*Provider, error): loads keytab from KeytabPath (or DITTOFS_KERBEROS_KEYTAB env var), loads krb5.conf (or DITTOFS_KERBEROS_KRB5CONF env var), parses service principal. Returns error if keytab fails to parse.
- Keytab() *keytab.Keytab: returns current keytab (thread-safe read)
- ServicePrincipal() string: returns SPN
- MaxClockSkew() time.Duration: returns max clock skew
- Krb5Config() *config.Config: returns krb5 config
- ReloadKeytab() error: re-reads keytab file and atomically swaps (for hot-reload)
- Close() error: cleanup

**identity.go:**
- IdentityMapper interface: MapPrincipal(principal string, realm string) (*metadata.Identity, error)
- StaticMapper struct: implements IdentityMapper using KerberosConfig.IdentityMapping
- NewStaticMapper(cfg *IdentityMappingConfig) *StaticMapper
- MapPrincipal: looks up "principal@realm" in StaticMap. If found, returns Identity with UID/GID/GIDs. If not found, returns Identity with DefaultUID/DefaultGID and Username=principal, Domain=realm.

**Update pkg/config/config.go:**
- Add `Kerberos kerberos.KerberosConfig` field to Config struct (use forward reference or import pkg/auth/kerberos). If circular import would result, define KerberosConfig directly in pkg/config/ and have pkg/auth/kerberos accept it as a parameter instead. The config struct should be in pkg/config to follow the existing pattern.
- Actually, to avoid circular imports: define the KerberosConfig and IdentityMappingConfig structs in pkg/config/config.go (alongside LockConfig, CacheConfig, etc.) and have pkg/auth/kerberos accept *config.KerberosConfig. This follows the project pattern where all config structs live in pkg/config/.

**Update pkg/config/defaults.go:**
- Add Kerberos defaults: Enabled=false, Krb5Conf="/etc/krb5.conf", MaxClockSkew=5m, ContextTTL=8h, MaxContexts=10000, DefaultUID=65534, DefaultGID=65534, Strategy="static"
- Add env var support: DITTOFS_KERBEROS_KEYTAB overrides KeytabPath, DITTOFS_KERBEROS_PRINCIPAL overrides ServicePrincipal (document in config comments)

NOTE: Import gokrb5 packages that are already in go.mod: github.com/jcmturner/gokrb5/v8/keytab, github.com/jcmturner/gokrb5/v8/config. Do NOT add new dependencies.
  </action>
  <verify>cd /Users/marmos91/Projects/dittofs && go build ./pkg/auth/kerberos/... && go build ./pkg/config/... && go vet ./pkg/auth/kerberos/... ./pkg/config/...</verify>
  <done>KerberosConfig in pkg/config with defaults, Provider loads keytab and krb5.conf, StaticMapper resolves principals to Identity, env var overrides work, no circular imports, go build and vet pass</done>
</task>

</tasks>

<verification>
1. `go test ./internal/protocol/nfs/rpc/gss/... -race -count=1` -- all GSS type and sequence window tests pass
2. `go build ./pkg/auth/kerberos/...` -- Kerberos provider compiles
3. `go build ./pkg/config/...` -- Config with KerberosConfig compiles
4. `go vet ./...` -- no static analysis issues
5. `go build ./...` -- full project builds with new packages
</verification>

<success_criteria>
- RPCSEC_GSS credential decode/encode works for all gss_proc values
- Sequence window accepts valid sequences, rejects duplicates, handles window sliding
- KerberosProvider loads keytab file and krb5.conf
- StaticMapper maps "user@REALM" to metadata.Identity with UID/GID
- KerberosConfig added to main Config with proper defaults
- Environment variable overrides (DITTOFS_KERBEROS_KEYTAB, DITTOFS_KERBEROS_PRINCIPAL) supported
- No new dependencies added (uses existing gokrb5 v8.4.4)
</success_criteria>

<output>
After completion, create `.planning/phases/12-kerberos-authentication/12-01-SUMMARY.md`
</output>
