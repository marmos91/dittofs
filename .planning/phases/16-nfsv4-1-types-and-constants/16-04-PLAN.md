---
phase: 16-nfsv4-1-types-and-constants
plan: 04
type: execute
wave: 3
depends_on: ["16-01"]
files_modified:
  - internal/protocol/nfs/v4/types/cb_sequence.go
  - internal/protocol/nfs/v4/types/cb_sequence_test.go
  - internal/protocol/nfs/v4/types/cb_layoutrecall.go
  - internal/protocol/nfs/v4/types/cb_layoutrecall_test.go
  - internal/protocol/nfs/v4/types/cb_notify.go
  - internal/protocol/nfs/v4/types/cb_notify_test.go
  - internal/protocol/nfs/v4/types/cb_push_deleg.go
  - internal/protocol/nfs/v4/types/cb_push_deleg_test.go
  - internal/protocol/nfs/v4/types/cb_recall_any.go
  - internal/protocol/nfs/v4/types/cb_recall_any_test.go
  - internal/protocol/nfs/v4/types/cb_recall_slot.go
  - internal/protocol/nfs/v4/types/cb_recall_slot_test.go
  - internal/protocol/nfs/v4/types/cb_wants_cancelled.go
  - internal/protocol/nfs/v4/types/cb_wants_cancelled_test.go
  - internal/protocol/nfs/v4/types/cb_notify_lock.go
  - internal/protocol/nfs/v4/types/cb_notify_lock_test.go
  - internal/protocol/nfs/v4/types/cb_notify_deviceid.go
  - internal/protocol/nfs/v4/types/cb_notify_deviceid_test.go
autonomous: true
requirements:
  - SESS-05

must_haves:
  truths:
    - "CB_SEQUENCE args/res can be encoded/decoded including referring_call_lists"
    - "CB_LAYOUTRECALL handles the layout_type union (file/fsid/all recall)"
    - "CB_NOTIFY handles variable-length notification entry arrays"
    - "All 10 v4.1 callback operations (CB ops 5-14) have complete XDR types"
    - "Trivial CB operations (CB_RECALL_SLOT, CB_WANTS_CANCELLED, CB_RECALLABLE_OBJ_AVAIL) have correct minimal wire encoding"
  artifacts:
    - path: "internal/protocol/nfs/v4/types/cb_sequence.go"
      provides: "CbSequenceArgs/Res with referring_call_lists"
      contains: "CbSequenceArgs"
    - path: "internal/protocol/nfs/v4/types/cb_layoutrecall.go"
      provides: "CbLayoutRecallArgs/Res"
      contains: "CbLayoutRecallArgs"
    - path: "internal/protocol/nfs/v4/types/cb_notify.go"
      provides: "CbNotifyArgs/Res with notification entries"
      contains: "CbNotifyArgs"
  key_links:
    - from: "internal/protocol/nfs/v4/types/cb_sequence.go"
      to: "internal/protocol/nfs/v4/types/session_common.go"
      via: "SessionId4 and ReferringCallTriple"
      pattern: "SessionId4|ReferringCallTriple"
---

<objective>
Define XDR request/response types for all 10 NFSv4.1 callback operations: CB_SEQUENCE, CB_LAYOUTRECALL, CB_NOTIFY, CB_PUSH_DELEG, CB_RECALL_ANY, CB_RECALLABLE_OBJ_AVAIL, CB_RECALL_SLOT, CB_WANTS_CANCELLED, CB_NOTIFY_LOCK, and CB_NOTIFY_DEVICEID.

Purpose: These types are needed by the server to send callbacks to v4.1 clients over the backchannel (Phase 22). CB_SEQUENCE is the v4.1 equivalent of SEQUENCE but for callback compounds. CB_NOTIFY is needed for directory delegations (Phase 24).

Output: 10 callback operation files (9 new + cb_recallable_obj_avail is trivially a void-args/status-only op that can be included in one of the other files or get its own) with args/res structs, Encode/Decode methods, and round-trip tests.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-nfsv4-1-types-and-constants/16-CONTEXT.md
@.planning/phases/16-nfsv4-1-types-and-constants/16-RESEARCH.md
@.planning/phases/16-nfsv4-1-types-and-constants/16-01-SUMMARY.md
@internal/protocol/nfs/v4/types/session_common.go
@internal/protocol/nfs/v4/types/fixtures_test.go
@internal/protocol/nfs/v4/types/constants.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CB_SEQUENCE, CB_LAYOUTRECALL, and CB_NOTIFY types</name>
  <files>
    internal/protocol/nfs/v4/types/cb_sequence.go
    internal/protocol/nfs/v4/types/cb_sequence_test.go
    internal/protocol/nfs/v4/types/cb_layoutrecall.go
    internal/protocol/nfs/v4/types/cb_layoutrecall_test.go
    internal/protocol/nfs/v4/types/cb_notify.go
    internal/protocol/nfs/v4/types/cb_notify_test.go
  </files>
  <action>
**1. Create `cb_sequence.go`** per RFC 8881 Section 20.9:

`CbSequenceArgs` struct:
- `SessionID SessionId4`
- `SequenceID uint32`
- `SlotID uint32`
- `HighestSlotID uint32`
- `CacheThis bool`
- `ReferringCallLists []ReferringCallTriple` -- variable-length array. Each triple has SessionID + []ReferringCall4 (from session_common.go).

`CbSequenceRes` struct:
- `Status uint32`
- `SessionID SessionId4` (only if NFS4_OK)
- `SequenceID uint32`
- `SlotID uint32`
- `HighestSlotID uint32`
- `TargetHighestSlotID uint32`

Both: Encode/Decode/String methods. The referring_call_lists field is the distinguishing complexity -- it's an array of triples, each containing a session ID and an array of (seqid, slotid) pairs.

**2. Create `cb_layoutrecall.go`** per RFC 8881 Section 20.3:

`CbLayoutRecallArgs` struct:
- `LayoutType uint32`
- `IOMode uint32`
- `Changed bool`
- `RecallType uint32` -- LAYOUTRECALL4_FILE (1), LAYOUTRECALL4_FSID (2), LAYOUTRECALL4_ALL (3)
  - If FILE: `Offset uint64` + `Length uint64` + `Stateid Stateid4` + `FH []byte` (filehandle opaque)
  - If FSID: `FSID FSID4` (Major uint64 + Minor uint64)
  - If ALL: void

Define `LAYOUTRECALL4_FILE = 1`, `LAYOUTRECALL4_FSID = 2`, `LAYOUTRECALL4_ALL = 3` constants (either here or in constants.go).

Use a union pattern: store discriminant + arms in separate fields. Encode conditionally based on RecallType.

Store the file-recall fields as: `FileOffset uint64`, `FileLength uint64`, `FileStateid Stateid4`, `FileFH []byte`, and the fsid fields as `FsidMajor uint64`, `FsidMinor uint64`.

`CbLayoutRecallRes` struct:
- `Status uint32`

**3. Create `cb_notify.go`** per RFC 8881 Section 20.4:

`CbNotifyArgs` struct:
- `Stateid Stateid4` -- directory delegation stateid
- `FH []byte` -- filehandle of directory
- `Changes []Notify4` -- variable-length array of notification entries

`Notify4` struct:
- `Mask Bitmap4` -- notification types (NOTIFY4_* constants)
- `Values []NotifyEntry4` -- variable-length array of entries

`NotifyEntry4` struct:
- Encode as opaque per entry -- the actual entry format depends on notification type and is complex (notify_add4, notify_remove4, etc.). For the type definition phase, store each entry as `[]byte` (raw opaque). Full parsing of notification sub-types will be done in Phase 24 (directory delegations) when the handler logic is implemented.

`CbNotifyRes` struct:
- `Status uint32`

Tests for all three:
- `TestCbSequenceArgs_RoundTrip`: with referring calls
- `TestCbSequenceArgs_RoundTrip_NoReferringCalls`: empty list
- `TestCbSequenceRes_RoundTrip`: success and error
- `TestCbLayoutRecallArgs_RoundTrip_File`: FILE recall type
- `TestCbLayoutRecallArgs_RoundTrip_Fsid`: FSID recall type
- `TestCbLayoutRecallArgs_RoundTrip_All`: ALL recall type
- `TestCbNotifyArgs_RoundTrip`: with notification entries
  </action>
  <verify>
Run `go test ./internal/protocol/nfs/v4/types/ -run "TestCbSequence|TestCbLayoutRecall|TestCbNotify" -v`
Run `go build ./internal/protocol/...` for compilation check.
  </verify>
  <done>
CB_SEQUENCE handles referring_call_lists correctly. CB_LAYOUTRECALL handles all three recall types (file/fsid/all) via union encoding. CB_NOTIFY handles variable-length notification entries with opaque values for future Phase 24 parsing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create remaining 7 callback operation types</name>
  <files>
    internal/protocol/nfs/v4/types/cb_push_deleg.go
    internal/protocol/nfs/v4/types/cb_push_deleg_test.go
    internal/protocol/nfs/v4/types/cb_recall_any.go
    internal/protocol/nfs/v4/types/cb_recall_any_test.go
    internal/protocol/nfs/v4/types/cb_recall_slot.go
    internal/protocol/nfs/v4/types/cb_recall_slot_test.go
    internal/protocol/nfs/v4/types/cb_wants_cancelled.go
    internal/protocol/nfs/v4/types/cb_wants_cancelled_test.go
    internal/protocol/nfs/v4/types/cb_notify_lock.go
    internal/protocol/nfs/v4/types/cb_notify_lock_test.go
    internal/protocol/nfs/v4/types/cb_notify_deviceid.go
    internal/protocol/nfs/v4/types/cb_notify_deviceid_test.go
  </files>
  <action>
Create the remaining 7 callback operation types. Most are trivial or simple.

Note: CB_RECALLABLE_OBJ_AVAIL (CB op 9) has void args and status-only res. It can be included in the cb_recall_any.go file since they're thematically related, OR get its own 5-line file. Use Claude's discretion -- either approach is fine. If giving it its own file, create `cb_recallable_obj_avail.go` + `cb_recallable_obj_avail_test.go`.

**1. `cb_push_deleg.go`** (RFC 8881 Section 20.5):
- Args: `FH []byte` (filehandle) + `Delegation []byte` (open_delegation4 union -- store as raw opaque since delegation encoding already exists in v4.0; full re-encoding would be duplication)
- Res: `Status uint32`

**2. `cb_recall_any.go`** (RFC 8881 Section 20.6):
- Args: `ObjectsToKeep uint32` + `TypeMask Bitmap4`
- Define constants for type mask bits: `RCA4_TYPE_MASK_RDATA_DLG = 0`, `RCA4_TYPE_MASK_WDATA_DLG = 1`, `RCA4_TYPE_MASK_DIR_DLG = 2`, `RCA4_TYPE_MASK_FILE_LAYOUT = 3`, `RCA4_TYPE_MASK_BLK_LAYOUT = 4`, `RCA4_TYPE_MASK_OBJ_LAYOUT_MIN = 8`, `RCA4_TYPE_MASK_OBJ_LAYOUT_MAX = 9`
- Res: `Status uint32`

Also include **CB_RECALLABLE_OBJ_AVAIL** (RFC 8881 Section 20.7):
- Args: void (no fields)
- Res: `Status uint32`
If separate file, create it. If in cb_recall_any.go, add it there.

**3. `cb_recall_slot.go`** (RFC 8881 Section 20.8):
- Args: `TargetHighestSlotID uint32`
- Res: `Status uint32`
Trivial -- single uint32 arg and status-only res.

**4. `cb_wants_cancelled.go`** (RFC 8881 Section 20.10):
- Args: `ContendedWantsNotify bool` + `ResourcedWantsNotify bool`
- Res: `Status uint32`
Both bools are XDR bools (uint32).

**5. `cb_notify_lock.go`** (RFC 8881 Section 20.11):
- Args: `FH []byte` (filehandle) + `LockOwner LockOwner4`
- `LockOwner4` = `ClientID uint64` + `Owner []byte` (opaque). If this type already exists from v4.0 open/lock handlers, reference it. If not, define it inline.
- Res: `Status uint32`

**6. `cb_notify_deviceid.go`** (RFC 8881 Section 20.12):
- Args: `Changes []NotifyDeviceIdChange4` where `NotifyDeviceIdChange4` = `Type uint32` (NOTIFY_DEVICEID4_CHANGE=1, NOTIFY_DEVICEID4_DELETE=2) + `DeviceID DeviceId4` (from getdeviceinfo.go, or define [16]byte if not accessible from Plan 03 yet -- but since this is wave 3, Plan 03 is done). Use `DeviceId4` from getdeviceinfo.go if in the same package. Since all types are in the same `types` package, this works.
- Res: `Status uint32`
- Define: `NOTIFY_DEVICEID4_CHANGE = 1`, `NOTIFY_DEVICEID4_DELETE = 2`

For each test file: at minimum one round-trip test for args and one for res.
  </action>
  <verify>
Run `go test ./internal/protocol/nfs/v4/types/ -run "TestCbPush|TestCbRecallAny|TestCbRecallSlot|TestCbWants|TestCbNotifyLock|TestCbNotifyDeviceid|TestCbRecallableObj" -v`
Run `go test ./internal/protocol/nfs/v4/types/...` to verify ALL tests pass (plans 01-04 together).
Run `go build ./internal/protocol/...` for compilation check.
  </verify>
  <done>
All 10 v4.1 callback operation types (CB ops 5-14) have complete args/res types with working round-trip tests. CB_SEQUENCE (Task 1) handles referring_call_lists. CB_LAYOUTRECALL (Task 1) handles file/fsid/all unions. CB_NOTIFY (Task 1) handles notification entries. The remaining 7 trivial/simple CB operations are complete.
  </done>
</task>

</tasks>

<verification>
1. `go test ./internal/protocol/nfs/v4/types/...` -- all tests pass (Plans 01-04)
2. `go build ./internal/protocol/...` compiles cleanly
3. All 10 callback operation files exist with types and tests
4. `go vet ./internal/protocol/nfs/v4/types/` reports no issues
</verification>

<success_criteria>
- All 10 v4.1 callback operations (CB ops 5-14) have complete type files
- CB_SEQUENCE handles referring_call_lists for duplicate request detection
- CB_LAYOUTRECALL handles the file/fsid/all recall type union
- CB_NOTIFY stores notification entries as opaque for Phase 24 parsing
- All types implement XdrEncoder/XdrDecoder interfaces
- Round-trip tests verify encode/decode for all operations
</success_criteria>

<output>
After completion, create `.planning/phases/16-nfsv4-1-types-and-constants/16-04-SUMMARY.md`
</output>
