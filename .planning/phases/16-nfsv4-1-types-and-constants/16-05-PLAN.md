---
phase: 16-nfsv4-1-types-and-constants
plan: 05
type: execute
wave: 3
depends_on: ["16-02", "16-03"]
files_modified:
  - internal/protocol/nfs/v4/handlers/compound.go
  - internal/protocol/nfs/v4/handlers/compound_test.go
  - internal/protocol/nfs/v4/handlers/handler.go
  - internal/protocol/CLAUDE.md
autonomous: true
requirements:
  - SESS-05

must_haves:
  truths:
    - "COMPOUND with minorversion=1 routes to v4.1 dispatch table (not rejected)"
    - "COMPOUND with minorversion=0 continues to work exactly as before (regression-free)"
    - "COMPOUND with minorversion=2+ returns NFS4ERR_MINOR_VERS_MISMATCH"
    - "All 19 v4.1 operations return NFS4ERR_NOTSUPP when dispatched through v4.1 table"
    - "v4.1 stub handlers consume their XDR arguments to prevent stream desync"
    - "v4.1 handler signature includes V41RequestContext (distinct from v4.0)"
    - "internal/protocol/CLAUDE.md documents v4.0/v4.1 coexistence conventions"
  artifacts:
    - path: "internal/protocol/nfs/v4/handlers/compound.go"
      provides: "v4.1 minorversion branch in ProcessCompound"
      contains: "NFS4_MINOR_VERSION_1"
    - path: "internal/protocol/nfs/v4/handlers/handler.go"
      provides: "v4.1 dispatch table and V41OpHandler type"
      contains: "v41DispatchTable"
    - path: "internal/protocol/nfs/v4/handlers/compound_test.go"
      provides: "v4.1 COMPOUND dispatch tests"
      contains: "TestCompound_MinorVersion1"
    - path: "internal/protocol/CLAUDE.md"
      provides: "v4.0/v4.1 coexistence documentation"
      contains: "v4.1 Coexistence"
  key_links:
    - from: "internal/protocol/nfs/v4/handlers/compound.go"
      to: "internal/protocol/nfs/v4/types/constants.go"
      via: "NFS4_MINOR_VERSION_1 constant"
      pattern: "NFS4_MINOR_VERSION_1"
    - from: "internal/protocol/nfs/v4/handlers/handler.go"
      to: "internal/protocol/nfs/v4/types/types.go"
      via: "V41RequestContext type"
      pattern: "V41RequestContext"
    - from: "internal/protocol/nfs/v4/handlers/handler.go"
      to: "internal/protocol/nfs/v4/types/constants.go"
      via: "v4.1 OP_ constants for dispatch table"
      pattern: "OP_EXCHANGE_ID|OP_CREATE_SESSION|OP_SEQUENCE"
---

<objective>
Add v4.1 minorversion detection to the COMPOUND dispatcher, define the v4.1 dispatch table with NOTSUPP stub handlers, and update protocol documentation.

Purpose: This connects the type foundation (Plans 01-04) to the runtime. After this plan, the server accepts minorversion=1 COMPOUND requests and routes them to stub handlers. Real handler implementations come in Phases 17-24. The COMPOUND bifurcation is the critical integration point.

Output: Updated compound.go with v4.1 branch, updated handler.go with v4.1 dispatch table and handler type, tests proving v4.0 regression-free, and updated protocol CLAUDE.md.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-nfsv4-1-types-and-constants/16-CONTEXT.md
@.planning/phases/16-nfsv4-1-types-and-constants/16-RESEARCH.md
@.planning/phases/16-nfsv4-1-types-and-constants/16-02-SUMMARY.md
@.planning/phases/16-nfsv4-1-types-and-constants/16-03-SUMMARY.md
@internal/protocol/nfs/v4/handlers/compound.go
@internal/protocol/nfs/v4/handlers/compound_test.go
@internal/protocol/nfs/v4/handlers/handler.go
@internal/protocol/nfs/v4/handlers/stubs.go
@internal/protocol/nfs/v4/types/constants.go
@internal/protocol/nfs/v4/types/types.go
@internal/protocol/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add v4.1 dispatch table and COMPOUND minorversion branch</name>
  <files>
    internal/protocol/nfs/v4/handlers/handler.go
    internal/protocol/nfs/v4/handlers/compound.go
    internal/protocol/nfs/v4/handlers/compound_test.go
  </files>
  <action>
**1. Update `handler.go`** to add v4.1 dispatch infrastructure:

Define a new v4.1 handler type that is distinct from the v4.0 `OpHandler`:
```go
// V41OpHandler is the type signature for NFSv4.1 operation handlers.
// Unlike v4.0 OpHandler, it receives a V41RequestContext with session/slot info
// populated by SEQUENCE processing. For stub handlers, the context is nil.
type V41OpHandler func(ctx *types.CompoundContext, v41ctx *types.V41RequestContext, reader io.Reader) *types.CompoundResult
```

Add a `v41DispatchTable map[uint32]V41OpHandler` field to the `Handler` struct.

In `NewHandler()`, initialize the v4.1 dispatch table with stub handlers for ALL 19 v4.1 operations (OP_BACKCHANNEL_CTL through OP_RECLAIM_COMPLETE). Each stub handler must:
1. Decode its operation's args struct using the type's Decode method (to consume bytes and prevent XDR stream desync -- this is the CRITICAL pitfall from research)
2. Log the operation at Debug level
3. Return NFS4ERR_NOTSUPP with the correct OpCode

Use a helper function to create stub handlers:
```go
// v41StubHandler creates a v4.1 stub handler that decodes args and returns NOTSUPP.
// The decoder parameter consumes the operation's XDR args from the reader.
func v41StubHandler(opCode uint32, decoder func(io.Reader) error) V41OpHandler {
    return func(ctx *types.CompoundContext, v41ctx *types.V41RequestContext, reader io.Reader) *types.CompoundResult {
        if err := decoder(reader); err != nil {
            logger.Debug("NFSv4.1 stub decode error",
                "op", types.OpName(opCode), "error", err, "client", ctx.ClientAddr)
            return &types.CompoundResult{
                Status: types.NFS4ERR_BADXDR,
                OpCode: opCode,
                Data:   encodeStatusOnly(types.NFS4ERR_BADXDR),
            }
        }
        logger.Debug("NFSv4.1 operation not yet implemented",
            "op", types.OpName(opCode), "client", ctx.ClientAddr)
        return &types.CompoundResult{
            Status: types.NFS4ERR_NOTSUPP,
            OpCode: opCode,
            Data:   encodeStatusOnly(types.NFS4ERR_NOTSUPP),
        }
    }
}
```

Register each v4.1 operation with its typed decoder. For example:
```go
h.v41DispatchTable[types.OP_EXCHANGE_ID] = v41StubHandler(types.OP_EXCHANGE_ID, func(r io.Reader) error {
    var args types.ExchangeIdArgs
    return args.Decode(r)
})
h.v41DispatchTable[types.OP_CREATE_SESSION] = v41StubHandler(types.OP_CREATE_SESSION, func(r io.Reader) error {
    var args types.CreateSessionArgs
    return args.Decode(r)
})
// ... for all 19 operations
```

Also add `v41IsOperationBlocked` that checks the same blocklist for v4.1 ops. Note: blocked operations apply to both v4.0 and v4.1.

**2. Update `compound.go`** ProcessCompound:

Change the minorversion validation from rejecting non-zero to a switch:
```go
switch minorVersion {
case types.NFS4_MINOR_VERSION_0:
    // existing v4.0 dispatch loop (no changes)
case types.NFS4_MINOR_VERSION_1:
    // v4.1 dispatch loop (new)
default:
    return encodeCompoundResponse(types.NFS4ERR_MINOR_VERS_MISMATCH, tag, nil)
}
```

The v4.1 dispatch loop is VERY similar to the v4.0 loop but uses `h.v41DispatchTable` and passes `nil` for V41RequestContext (since SEQUENCE processing is Phase 20). The key differences:
- Uses v41DispatchTable instead of opDispatchTable
- Passes nil V41RequestContext (Phase 20 populates this)
- For unknown opcodes in v4.1 range (40-58), returns NFS4ERR_NOTSUPP (not OP_ILLEGAL)
- For opcodes < 3 or > OP_RECLAIM_COMPLETE (58) AND not in the v4.0 range (3-39), returns NFS4ERR_OP_ILLEGAL
- v4.0 operations (3-39) ALSO work in v4.1 compounds -- they use the existing opDispatchTable. Per RFC 8881, v4.1 COMPOUND can include both v4.0 and v4.1 operations (except v4.0-only ops like SETCLIENTID which Phase 23 will reject). For now, allow all v4.0 ops in v4.1 compounds.

So the v4.1 dispatch logic is:
```go
for each op in compound:
    if opCode in v41DispatchTable:
        result = v41DispatchTable[opCode](ctx, v41ctx, reader)
    else if opCode in opDispatchTable:
        result = opDispatchTable[opCode](ctx, reader)  // v4.0 op in v4.1 compound
    else:
        result = OP_ILLEGAL or NOTSUPP based on range
```

IMPORTANT: Extract the v4.0 dispatch loop into a helper method to avoid code duplication. Both v4.0 and v4.1 paths share the same loop structure (context check, opcode read, blocklist check, dispatch, log, break on error).

**3. Update `compound_test.go`**:

Check existing tests first. If there are tests that expect minorversion=1 to be rejected (return NFS4ERR_MINOR_VERS_MISMATCH), update them to test minorversion=2+ instead.

Add new tests:
- `TestCompound_MinorVersion1_Accepted`: minorversion=1 COMPOUND with a v4.0 PUTROOTFH + GETATTR succeeds (v4.0 ops work in v4.1 compound)
- `TestCompound_MinorVersion1_V41Op_NOTSUPP`: minorversion=1 COMPOUND with OP_EXCHANGE_ID returns NFS4ERR_NOTSUPP (stub behavior)
- `TestCompound_MinorVersion2_Rejected`: minorversion=2 returns NFS4ERR_MINOR_VERS_MISMATCH
- `TestCompound_MinorVersion0_Unchanged`: existing v4.0 COMPOUND still works (regression test)
- `TestCompound_V41_StubConsumesArgs`: send a v4.1 COMPOUND with EXCHANGE_ID + PUTROOTFH. Even though EXCHANGE_ID returns NOTSUPP (stopping the compound), verify the stub consumed args correctly (the XDR reader didn't desync).

Follow existing test patterns in compound_test.go for building COMPOUND requests.
  </action>
  <verify>
Run `go test ./internal/protocol/nfs/v4/handlers/ -run TestCompound -v` to verify all COMPOUND tests pass.
Run `go test ./internal/protocol/nfs/v4/handlers/...` to verify ALL handler tests pass (v4.0 regression).
Run `go build ./internal/protocol/...` for compilation check.
Run `go vet ./internal/protocol/nfs/v4/handlers/` for static analysis.
  </verify>
  <done>
COMPOUND dispatcher routes minorversion=0 to v4.0 path, minorversion=1 to v4.1 path, and minorversion=2+ to MINOR_VERS_MISMATCH. All 19 v4.1 operations have stub entries in v4.1 dispatch table that consume args and return NOTSUPP. v4.0 operations work in v4.1 compounds. All existing v4.0 tests pass unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update protocol CLAUDE.md with v4.0/v4.1 coexistence conventions</name>
  <files>
    internal/protocol/CLAUDE.md
  </files>
  <action>
Read the existing `internal/protocol/CLAUDE.md` and add a new section documenting v4.0/v4.1 coexistence conventions. This was a locked decision from CONTEXT.md.

Add the following section after the existing content:

```markdown
## NFSv4.0/v4.1 Coexistence

### Version Routing

COMPOUND dispatcher routes based on `minorversion`:
- `0` → v4.0 dispatch table (OpHandler signature)
- `1` → v4.1 dispatch table (V41OpHandler signature), with fallback to v4.0 table for shared ops
- `2+` → NFS4ERR_MINOR_VERS_MISMATCH

### Handler Signatures

v4.0 and v4.1 use different handler types:

```go
// v4.0: no session context
type OpHandler func(ctx *types.CompoundContext, reader io.Reader) *types.CompoundResult

// v4.1: includes session context from SEQUENCE
type V41OpHandler func(ctx *types.CompoundContext, v41ctx *types.V41RequestContext, reader io.Reader) *types.CompoundResult
```

### Dispatch Table Strategy

- **v4.0-only ops** (3-39): Only in `opDispatchTable`, accessible from both v4.0 and v4.1 compounds
- **v4.1-only ops** (40-58): Only in `v41DispatchTable`, return OP_ILLEGAL in v4.0 compounds
- **Shared ops** (PUTFH, GETATTR, READ, WRITE, etc.): In `opDispatchTable`, called from v4.1 compounds via fallback
- **v4.0-only rejected in v4.1**: SETCLIENTID, SETCLIENTID_CONFIRM, RENEW, OPEN_CONFIRM, RELEASE_LOCKOWNER → NFS4ERR_NOTSUPP in v4.1 (Phase 23)

### Type File Organization

- v4.0 types: `types.go` (compound structs, Stateid4, etc.)
- v4.1 per-op types: `exchange_id.go`, `create_session.go`, etc. (one file per operation)
- v4.1 shared types: `session_common.go` (types used by 2+ operations)
- Constants: `constants.go` (both v4.0 and v4.1, separated by comment blocks)
- Error codes: `errors.go` (both v4.0 and v4.1)

### Adding a New v4.1 Handler (Phases 17-24)

1. Create handler in `v4/handlers/` (e.g., `exchange_id_handler.go`)
2. Use V41OpHandler signature with V41RequestContext
3. Replace stub in v41DispatchTable with real handler in NewHandler()
4. The stub automatically consumed args -- the real handler replaces this
5. Test with compound_test.go pattern

### Common Mistakes

1. **XDR desync in v4.1 stubs** -- Stubs MUST decode args even when returning NOTSUPP. The COMPOUND reader position must advance past the current op's args.
2. **Wrong dispatch table** -- v4.1 ops go in v41DispatchTable, not opDispatchTable
3. **Missing fallback** -- v4.0 ops must be accessible from v4.1 compounds
4. **OP_ILLEGAL vs NFS4ERR_NOTSUPP** -- Unknown opcodes outside valid ranges get OP_ILLEGAL; known but unimplemented ops get NOTSUPP
```

Ensure the section integrates cleanly with existing content (proper heading levels, no duplicate sections).
  </action>
  <verify>
Read `internal/protocol/CLAUDE.md` to verify the new section was added correctly.
Run `go test ./internal/protocol/...` to verify everything still compiles (documentation change only).
  </verify>
  <done>
internal/protocol/CLAUDE.md documents v4.0/v4.1 coexistence conventions including version routing, handler signatures, dispatch table strategy, type file organization, and how to add new v4.1 handlers in future phases. This serves as the reference for Phases 17-24.
  </done>
</task>

</tasks>

<verification>
1. `go test ./internal/protocol/nfs/v4/handlers/...` -- all tests pass (v4.0 + v4.1)
2. `go test ./internal/protocol/nfs/v4/types/...` -- all type tests pass
3. `go test ./internal/protocol/...` -- full protocol package passes
4. `go build ./...` -- entire project compiles
5. `go vet ./internal/protocol/...` reports no issues
6. COMPOUND with minorversion=1 is accepted (not rejected)
7. All v4.1 ops return NFS4ERR_NOTSUPP through stub handlers
8. v4.0 COMPOUNDs work identically to before
</verification>

<success_criteria>
- COMPOUND dispatcher correctly bifurcates based on minorversion
- v4.1 dispatch table has entries for all 19 operations with arg-consuming stubs
- Zero regressions in v4.0 behavior (all existing tests pass)
- Protocol CLAUDE.md provides clear guidance for future v4.1 handler implementation
- The codebase is ready for Phase 17 (slot table) to start replacing stubs with real handlers
</success_criteria>

<output>
After completion, create `.planning/phases/16-nfsv4-1-types-and-constants/16-05-SUMMARY.md`
</output>
