---
phase: 16-nfsv4-1-types-and-constants
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - internal/protocol/nfs/v4/types/exchange_id.go
  - internal/protocol/nfs/v4/types/exchange_id_test.go
  - internal/protocol/nfs/v4/types/create_session.go
  - internal/protocol/nfs/v4/types/create_session_test.go
  - internal/protocol/nfs/v4/types/destroy_session.go
  - internal/protocol/nfs/v4/types/destroy_session_test.go
  - internal/protocol/nfs/v4/types/sequence.go
  - internal/protocol/nfs/v4/types/sequence_test.go
  - internal/protocol/nfs/v4/types/bind_conn_to_session.go
  - internal/protocol/nfs/v4/types/bind_conn_to_session_test.go
  - internal/protocol/nfs/v4/types/backchannel_ctl.go
  - internal/protocol/nfs/v4/types/backchannel_ctl_test.go
autonomous: true
requirements:
  - SESS-05

must_haves:
  truths:
    - "EXCHANGE_ID args and res can be encoded/decoded with all field variants (with/without impl_id, SP4_NONE/SP4_MACH_CRED)"
    - "CREATE_SESSION args and res can be encoded/decoded including channel attrs and callback security params"
    - "DESTROY_SESSION args and res encode/decode a SessionId4 correctly"
    - "SEQUENCE args and res encode/decode with all fields including status flags"
    - "BIND_CONN_TO_SESSION args and res handle direction enum correctly"
    - "BACKCHANNEL_CTL args encode cb_program and security params"
  artifacts:
    - path: "internal/protocol/nfs/v4/types/exchange_id.go"
      provides: "ExchangeIdArgs + ExchangeIdRes with Encode/Decode/String"
      contains: "ExchangeIdArgs"
    - path: "internal/protocol/nfs/v4/types/create_session.go"
      provides: "CreateSessionArgs + CreateSessionRes with Encode/Decode/String"
      contains: "CreateSessionArgs"
    - path: "internal/protocol/nfs/v4/types/sequence.go"
      provides: "SequenceArgs + SequenceRes with Encode/Decode/String"
      contains: "SequenceArgs"
    - path: "internal/protocol/nfs/v4/types/destroy_session.go"
      provides: "DestroySessionArgs + DestroySessionRes"
      contains: "DestroySessionArgs"
    - path: "internal/protocol/nfs/v4/types/bind_conn_to_session.go"
      provides: "BindConnToSessionArgs + BindConnToSessionRes"
      contains: "BindConnToSessionArgs"
    - path: "internal/protocol/nfs/v4/types/backchannel_ctl.go"
      provides: "BackchannelCtlArgs + BackchannelCtlRes"
      contains: "BackchannelCtlArgs"
  key_links:
    - from: "internal/protocol/nfs/v4/types/exchange_id.go"
      to: "internal/protocol/nfs/v4/types/session_common.go"
      via: "shared types"
      pattern: "ClientOwner4|StateProtect4A|NfsImplId4|ServerOwner4"
    - from: "internal/protocol/nfs/v4/types/create_session.go"
      to: "internal/protocol/nfs/v4/types/session_common.go"
      via: "shared types"
      pattern: "ChannelAttrs|CallbackSecParms4|SessionId4"
---

<objective>
Define XDR request/response types for the 6 core session operations: EXCHANGE_ID, CREATE_SESSION, DESTROY_SESSION, SEQUENCE, BIND_CONN_TO_SESSION, and BACKCHANNEL_CTL.

Purpose: These are the most complex and frequently-used v4.1 operations. EXCHANGE_ID is the largest type (complex nested unions), CREATE_SESSION has channel attribute negotiation, and SEQUENCE gates every v4.1 COMPOUND. Getting these right is critical for all subsequent phases.

Output: 6 operation files with args/res structs, Encode/Decode methods, String() implementations, and comprehensive round-trip tests.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-nfsv4-1-types-and-constants/16-CONTEXT.md
@.planning/phases/16-nfsv4-1-types-and-constants/16-RESEARCH.md
@.planning/phases/16-nfsv4-1-types-and-constants/16-01-SUMMARY.md
@internal/protocol/nfs/v4/types/session_common.go
@internal/protocol/nfs/v4/types/fixtures_test.go
@internal/protocol/nfs/v4/types/constants.go
@internal/protocol/xdr/union.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EXCHANGE_ID, CREATE_SESSION, and DESTROY_SESSION types</name>
  <files>
    internal/protocol/nfs/v4/types/exchange_id.go
    internal/protocol/nfs/v4/types/exchange_id_test.go
    internal/protocol/nfs/v4/types/create_session.go
    internal/protocol/nfs/v4/types/create_session_test.go
    internal/protocol/nfs/v4/types/destroy_session.go
    internal/protocol/nfs/v4/types/destroy_session_test.go
  </files>
  <action>
**1. Create `exchange_id.go`** per RFC 8881 Section 18.35:

`ExchangeIdArgs` struct:
- `ClientOwner ClientOwner4` -- from session_common.go
- `Flags uint32` -- EXCHGID4_FLAG_* bitmask
- `StateProtect StateProtect4A` -- union from session_common.go
- `ClientImplId []NfsImplId4` -- optional, max 1 (XDR array `<1>`, NOT optional)

PITFALL from research: `eia_client_impl_id<1>` is a variable-length array with max 1 element. Encode as `uint32 count` + 0 or 1 elements. Validate `count <= 1` on decode.

`ExchangeIdRes` struct (success case):
- `Status uint32`
- `ClientID uint64`
- `SequenceID uint32`
- `Flags uint32`
- `StateProtect StateProtect4R` -- response union from session_common.go
- `ServerOwner ServerOwner4`
- `ServerScope []byte` -- opaque
- `ServerImplId []NfsImplId4` -- optional, max 1

For the response, encode Status first. If Status != NFS4_OK, encode only Status. If NFS4_OK, encode all fields. Decode: read Status first, if NFS4_OK continue decoding remaining fields.

Both types: implement `Encode(*bytes.Buffer) error`, `Decode(io.Reader) error`, `String() string`. Follow the pattern from 16-RESEARCH.md "Pattern 1" example exactly.

**2. Create `create_session.go`** per RFC 8881 Section 18.36:

`CreateSessionArgs` struct:
- `ClientID uint64`
- `SequenceID uint32`
- `Flags uint32` -- CREATE_SESSION4_FLAG_*
- `ForeChannelAttrs ChannelAttrs`
- `BackChannelAttrs ChannelAttrs`
- `CbProgram uint32`
- `CbSecParms []CallbackSecParms4` -- variable-length array

`CreateSessionRes` struct:
- `Status uint32`
- `SessionID SessionId4` (only if Status == NFS4_OK)
- `SequenceID uint32`
- `Flags uint32`
- `ForeChannelAttrs ChannelAttrs`
- `BackChannelAttrs ChannelAttrs`

Both: Encode/Decode/String methods. Res encodes status-only on error.

**3. Create `destroy_session.go`** per RFC 8881 Section 18.37:

`DestroySessionArgs` struct:
- `SessionID SessionId4`

`DestroySessionRes` struct:
- `Status uint32`

Both: Encode/Decode/String methods. Trivial -- just SessionId4 and status.

**4. Create corresponding test files** with round-trip tests:

`exchange_id_test.go`:
- `TestExchangeIdArgs_RoundTrip`: with ClientOwner, flags, SP4_NONE, 1 impl_id
- `TestExchangeIdArgs_RoundTrip_NoImplId`: with 0 impl_ids
- `TestExchangeIdArgs_RoundTrip_MachCred`: with SP4_MACH_CRED state protect
- `TestExchangeIdRes_RoundTrip`: success response with all fields
- `TestExchangeIdRes_RoundTrip_Error`: error response (status-only)

`create_session_test.go`:
- `TestCreateSessionArgs_RoundTrip`: with channel attrs, cb_program, sec parms
- `TestCreateSessionRes_RoundTrip`: success with negotiated attrs
- `TestCreateSessionRes_RoundTrip_Error`: error response

`destroy_session_test.go`:
- `TestDestroySessionArgs_RoundTrip`
- `TestDestroySessionRes_RoundTrip`

Use fixtures from fixtures_test.go (ValidSessionId, ValidClientOwner, ValidChannelAttrs, etc.).
  </action>
  <verify>
Run `go test ./internal/protocol/nfs/v4/types/ -run TestExchangeId -v` to verify all EXCHANGE_ID tests pass.
Run `go test ./internal/protocol/nfs/v4/types/ -run TestCreateSession -v` to verify all CREATE_SESSION tests pass.
Run `go test ./internal/protocol/nfs/v4/types/ -run TestDestroySession -v` to verify DESTROY_SESSION tests pass.
Run `go build ./internal/protocol/...` for compilation check.
  </verify>
  <done>
EXCHANGE_ID, CREATE_SESSION, and DESTROY_SESSION have complete args/res types with working Encode/Decode round-trips. All edge cases tested (SP4_NONE/SP4_MACH_CRED, 0/1 impl_ids, success/error responses).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SEQUENCE, BIND_CONN_TO_SESSION, and BACKCHANNEL_CTL types</name>
  <files>
    internal/protocol/nfs/v4/types/sequence.go
    internal/protocol/nfs/v4/types/sequence_test.go
    internal/protocol/nfs/v4/types/bind_conn_to_session.go
    internal/protocol/nfs/v4/types/bind_conn_to_session_test.go
    internal/protocol/nfs/v4/types/backchannel_ctl.go
    internal/protocol/nfs/v4/types/backchannel_ctl_test.go
  </files>
  <action>
**1. Create `sequence.go`** per RFC 8881 Section 18.46:

`SequenceArgs` struct:
- `SessionID SessionId4`
- `SequenceID uint32`
- `SlotID uint32`
- `HighestSlotID uint32`
- `CacheThis bool` -- XDR bool (uint32 where 0=false, 1=true)

`SequenceRes` struct:
- `Status uint32`
- `SessionID SessionId4` (only if NFS4_OK)
- `SequenceID uint32`
- `SlotID uint32`
- `HighestSlotID uint32`
- `TargetHighestSlotID uint32`
- `StatusFlags uint32` -- SEQ4_STATUS_* bitmask

Both: Encode/Decode/String methods. This is the most frequently used v4.1 op (first in every COMPOUND).

**2. Create `bind_conn_to_session.go`** per RFC 8881 Section 18.34:

`BindConnToSessionArgs` struct:
- `SessionID SessionId4`
- `Dir uint32` -- CDFC4_FORE, CDFC4_BACK, CDFC4_FORE_OR_BOTH, CDFC4_BACK_OR_BOTH
- `UseConnInRDMAMode bool`

`BindConnToSessionRes` struct:
- `Status uint32`
- `SessionID SessionId4` (only if NFS4_OK)
- `Dir uint32` -- CDFS4_FORE, CDFS4_BACK, CDFS4_BOTH
- `UseConnInRDMAMode bool`

Both: Encode/Decode/String methods.

**3. Create `backchannel_ctl.go`** per RFC 8881 Section 18.33:

`BackchannelCtlArgs` struct:
- `CbProgram uint32`
- `SecParms []CallbackSecParms4` -- variable-length array of security params

`BackchannelCtlRes` struct:
- `Status uint32`

Both: Encode/Decode/String methods.

**4. Create corresponding test files** with round-trip tests:

`sequence_test.go`:
- `TestSequenceArgs_RoundTrip`: with session ID, slot 0, cache=true
- `TestSequenceArgs_RoundTrip_NoCaching`: cache=false
- `TestSequenceRes_RoundTrip`: success with status flags set
- `TestSequenceRes_RoundTrip_Error`: error status only
- `TestSequenceRes_RoundTrip_WithStatusFlags`: verify SEQ4_STATUS flags encode correctly

`bind_conn_to_session_test.go`:
- `TestBindConnToSessionArgs_RoundTrip`: with CDFC4_FORE_OR_BOTH direction
- `TestBindConnToSessionRes_RoundTrip`: with CDFS4_BOTH direction
- `TestBindConnToSessionRes_RoundTrip_Error`: error case

`backchannel_ctl_test.go`:
- `TestBackchannelCtlArgs_RoundTrip`: with cb_program and AUTH_NONE sec parms
- `TestBackchannelCtlRes_RoundTrip`: status-only

Use fixtures from fixtures_test.go.
  </action>
  <verify>
Run `go test ./internal/protocol/nfs/v4/types/ -run TestSequence -v` to verify SEQUENCE tests pass.
Run `go test ./internal/protocol/nfs/v4/types/ -run TestBindConn -v` to verify BIND_CONN_TO_SESSION tests pass.
Run `go test ./internal/protocol/nfs/v4/types/ -run TestBackchannel -v` to verify BACKCHANNEL_CTL tests pass.
Run `go test ./internal/protocol/nfs/v4/types/...` to verify all tests pass together.
  </verify>
  <done>
SEQUENCE, BIND_CONN_TO_SESSION, and BACKCHANNEL_CTL have complete args/res types with working round-trip tests. SEQUENCE handles CacheThis bool and StatusFlags correctly. BIND_CONN_TO_SESSION handles direction enums. BACKCHANNEL_CTL handles security param arrays.
  </done>
</task>

</tasks>

<verification>
1. `go test ./internal/protocol/nfs/v4/types/ -run "TestExchangeId|TestCreateSession|TestDestroySession|TestSequence|TestBindConn|TestBackchannel" -v` -- all pass
2. `go build ./internal/protocol/...` compiles cleanly
3. `go vet ./internal/protocol/nfs/v4/types/` reports no issues
4. All 6 operation types have args + res structs with Encode/Decode/String methods
5. All types satisfy XdrEncoder and XdrDecoder interfaces from xdr package
</verification>

<success_criteria>
- 6 core session operation type files exist with complete XDR codecs
- Round-trip tests verify encode/decode correctness for all field combinations
- Union types (StateProtect4A in EXCHANGE_ID, callback sec parms in CREATE_SESSION/BACKCHANNEL_CTL) are handled correctly
- String() methods provide useful debug output for logging
- All types properly reference shared types from session_common.go
</success_criteria>

<output>
After completion, create `.planning/phases/16-nfsv4-1-types-and-constants/16-02-SUMMARY.md`
</output>
