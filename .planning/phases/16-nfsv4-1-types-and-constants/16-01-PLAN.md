---
phase: 16-nfsv4-1-types-and-constants
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/protocol/nfs/v4/types/constants.go
  - internal/protocol/nfs/v4/types/constants_test.go
  - internal/protocol/nfs/v4/types/errors.go
  - internal/protocol/nfs/v4/types/types.go
  - internal/protocol/nfs/v4/types/session_common.go
  - internal/protocol/nfs/v4/types/session_common_test.go
  - internal/protocol/nfs/v4/types/fixtures_test.go
  - internal/protocol/xdr/union.go
autonomous: true
requirements:
  - SESS-05

must_haves:
  truths:
    - "All 19 NFSv4.1 operation numbers (ops 40-58) are defined as OP_ constants"
    - "All 10 NFSv4.1 callback operation numbers (CB ops 5-14) are defined as CB_ constants"
    - "All ~40 NFSv4.1 error codes (NFS4ERR_ 10049-10087) are defined"
    - "Shared session types (SessionId4, ChannelAttrs, StateProtect4A, ServerOwner4, NfsImplId4, ClientOwner4, CallbackSecParms4) exist with Encode/Decode methods"
    - "XdrEncoder and XdrDecoder interfaces exist in the xdr package"
    - "V41RequestContext struct is defined in the types package"
    - "NFS4_MINOR_VERSION_1 constant exists"
    - "OpName() and opNameToNum map include all v4.1 operations"
    - "Existing v4.0 tests still pass"
  artifacts:
    - path: "internal/protocol/nfs/v4/types/constants.go"
      provides: "v4.1 operation numbers, flags, session constants"
      contains: "OP_EXCHANGE_ID"
    - path: "internal/protocol/nfs/v4/types/errors.go"
      provides: "v4.1 error code mapping"
      contains: "NFS4ERR_BADSESSION"
    - path: "internal/protocol/nfs/v4/types/session_common.go"
      provides: "Shared session sub-types with Encode/Decode"
      contains: "SessionId4"
    - path: "internal/protocol/nfs/v4/types/types.go"
      provides: "V41RequestContext, NFS4_MINOR_VERSION_1"
      contains: "V41RequestContext"
    - path: "internal/protocol/xdr/union.go"
      provides: "XDR discriminated union helpers and XdrEncoder/XdrDecoder interfaces"
      contains: "XdrEncoder"
    - path: "internal/protocol/nfs/v4/types/fixtures_test.go"
      provides: "Reusable test fixtures for v4.1 types"
      contains: "ValidSessionId"
  key_links:
    - from: "internal/protocol/nfs/v4/types/session_common.go"
      to: "internal/protocol/xdr/"
      via: "import for Encode/Decode"
      pattern: "xdr\\.WriteUint32|xdr\\.DecodeUint32"
    - from: "internal/protocol/nfs/v4/types/constants.go"
      to: "internal/protocol/nfs/v4/types/constants.go"
      via: "v4.1 op constants appended after v4.0"
      pattern: "OP_BACKCHANNEL_CTL.*=.*40"
---

<objective>
Define all NFSv4.1 constants (operation numbers, error codes, flags), shared session XDR types, XDR union helpers, XdrEncoder/XdrDecoder interfaces, V41RequestContext, and test fixtures.

Purpose: This is the foundation layer that all subsequent plans depend on. Constants are referenced by every operation type file, shared types are embedded in operation args/res structs, and test fixtures are used by all per-operation test files.

Output: Extended constants.go/errors.go with v4.1 values, new session_common.go with shared types, new xdr/union.go with interfaces and union helpers, updated types.go with V41RequestContext, and fixtures_test.go for test reuse.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-nfsv4-1-types-and-constants/16-CONTEXT.md
@.planning/phases/16-nfsv4-1-types-and-constants/16-RESEARCH.md
@internal/protocol/nfs/v4/types/constants.go
@internal/protocol/nfs/v4/types/errors.go
@internal/protocol/nfs/v4/types/types.go
@internal/protocol/xdr/encode.go
@internal/protocol/xdr/decode.go
@internal/protocol/xdr/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add v4.1 constants, error codes, XDR interfaces, and union helpers</name>
  <files>
    internal/protocol/nfs/v4/types/constants.go
    internal/protocol/nfs/v4/types/constants_test.go
    internal/protocol/nfs/v4/types/errors.go
    internal/protocol/nfs/v4/types/types.go
    internal/protocol/xdr/union.go
  </files>
  <action>
**1. Extend `constants.go`** with all v4.1 constants separated by `// --- NFSv4.1 ... ---` comment blocks:

- Operation numbers (ops 40-58): `OP_BACKCHANNEL_CTL = 40` through `OP_RECLAIM_COMPLETE = 58`. Use exact values from RFC 8881 Section 18 (listed in 16-RESEARCH.md "Constants to Add" section).
- Callback operation numbers (CB ops 5-14): `CB_LAYOUTRECALL uint32 = 5` through `CB_NOTIFY_DEVICEID uint32 = 14`. Use `uint32` type annotations to match existing CB constants pattern.
- Minor version: `NFS4_MINOR_VERSION_1 = 1`
- Session constants: `NFS4_SESSIONID_SIZE = 16`
- EXCHANGE_ID flags: `EXCHGID4_FLAG_SUPP_MOVED_REFER = 0x00000001` through `EXCHGID4_FLAG_MASK_R = 0x80070103`. All values from 16-RESEARCH.md.
- CREATE_SESSION flags: `CREATE_SESSION4_FLAG_PERSIST = 0x00000001`, `CREATE_SESSION4_FLAG_CONN_BACK_CHAN = 0x00000002`, `CREATE_SESSION4_FLAG_CONN_RDMA = 0x00000004`
- State protection: `SP4_NONE = 0`, `SP4_MACH_CRED = 1`, `SP4_SSV = 2`
- Channel direction constants: `CDFC4_FORE = 0x1` through `CDFS4_BOTH = 0x3`
- SEQUENCE status flags: `SEQ4_STATUS_CB_PATH_DOWN = 0x00000001` through `SEQ4_STATUS_DEVID_DELETED = 0x00001000`
- Layout types: `LAYOUT4_NFSV4_1_FILES = 1`, `LAYOUT4_OSD2_OBJECTS = 2`, `LAYOUT4_BLOCK_VOLUME = 3`
- SECINFO_NO_NAME style: `SECINFO_STYLE4_CURRENT_FH = 0`, `SECINFO_STYLE4_PARENT = 1`
- Notification types for directory delegations: `NOTIFY4_CHANGE_CHILD_ATTRS = 0`, `NOTIFY4_CHANGE_DIR_ATTRS = 1`, `NOTIFY4_REMOVE_ENTRY = 2`, `NOTIFY4_ADD_ENTRY = 3`, `NOTIFY4_RENAME_ENTRY = 4`, `NOTIFY4_CHANGE_COOKIE_VERIFIER = 5`

**Update `OpName()`** to include all 19 v4.1 operations (OP_BACKCHANNEL_CTL through OP_RECLAIM_COMPLETE) with their human-readable names. Also add v4.1 CB operations to a new `CbOpName()` function following the same pattern.

**Update `opNameToNum` map** in init() with all 19 v4.1 operations.

**2. Extend `errors.go`** with v4.1 error codes:

Add all v4.1 error codes (10049-10087) in a new const block separated by `// --- NFSv4.1 Error Codes (RFC 8881 Section 15) ---`. Use exact names and values from 16-RESEARCH.md "Error Codes" section. Note: 10073 is intentionally skipped (no error code assigned at that value).

Add the v4.1 error codes to `MapMetadataErrorToNFS4()` if any new mappings are needed (most v4.1 errors are protocol-level, not store-level, so likely no new mappings needed -- just ensure the function compiles).

**3. Update `types.go`** to add:

- `V41RequestContext` struct:
  ```go
  type V41RequestContext struct {
      SessionID   SessionId4
      SlotID      uint32
      SequenceID  uint32
      HighestSlot uint32
      CacheThis   bool
  }
  ```
  Add a `String()` method for debug logging.

- Note: `SessionId4` type is defined in session_common.go (Task 2), but `V41RequestContext` references it. Since both are in the same package, this works fine.

**4. Create `internal/protocol/xdr/union.go`** with:

- `XdrEncoder` interface: `Encode(buf *bytes.Buffer) error` -- matches existing v4.0 Encode pattern
- `XdrDecoder` interface: `Decode(r io.Reader) error` -- matches existing v4.0 Decode pattern
- `EncodeUnionDiscriminant(buf *bytes.Buffer, disc uint32) error` -- alias for WriteUint32, makes union code self-documenting
- `DecodeUnionDiscriminant(r io.Reader) (uint32, error)` -- alias for DecodeUint32
- Import `bytes` and `io` packages

**5. Update `constants_test.go`** to add:

- Test that all v4.1 operation names are in OpName() (not "UNKNOWN")
- Test that OpNameToNum has entries for all v4.1 operations
- Test that v4.0 operations still work (regression)
  </action>
  <verify>
Run `go build ./internal/protocol/...` to verify no compilation errors.
Run `go test ./internal/protocol/nfs/v4/types/... -run TestOp` to verify OpName/OpNameToNum tests pass.
Run `go test ./internal/protocol/xdr/...` to verify xdr package compiles.
Run `go vet ./internal/protocol/...` for static analysis.
  </verify>
  <done>
All 19 v4.1 op constants, 10 CB constants, ~40 error codes, EXCHANGE_ID/CREATE_SESSION/SEQUENCE/channel direction flags, state protection enum, layout types, SECINFO_NO_NAME styles, and notification types are defined. OpName() returns human-readable names for all v4.1 ops. XdrEncoder/XdrDecoder interfaces exist. V41RequestContext is defined. XDR union helpers are in place. All existing v4.0 tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared session types and test fixtures</name>
  <files>
    internal/protocol/nfs/v4/types/session_common.go
    internal/protocol/nfs/v4/types/session_common_test.go
    internal/protocol/nfs/v4/types/fixtures_test.go
  </files>
  <action>
**1. Create `session_common.go`** with all shared sub-types used by 2+ operations. Each type gets Encode/Decode struct methods and a String() method per locked decisions. Follow the existing v4.0 codec pattern (xdr.WriteUint32/xdr.DecodeUint32 etc.):

Types to define (all per RFC 8881):

- **`SessionId4`**: `[NFS4_SESSIONID_SIZE]byte` -- fixed-size opaque (16 bytes). Encode as raw 16 bytes with NO length prefix (fixed-size XDR opaque). Decode by io.ReadFull of 16 bytes. String() as hex.

- **`ClientOwner4`**: `Verifier [8]byte` + `OwnerID []byte`. Encode verifier as raw 8 bytes, OwnerID as XDR opaque. Decode similarly.

- **`ServerOwner4`**: `MinorID uint64` + `MajorID []byte`. Encode MinorID as uint64, MajorID as XDR opaque. Decode similarly.

- **`NfsImplId4`**: `Domain string` + `Name string` + `Date NFS4Time`. Encode Domain/Name as XDR string, Date as int64 seconds + uint32 nseconds.

- **`ChannelAttrs`** (channel_attrs4): `HeaderPadSize uint32`, `MaxRequestSize uint32`, `MaxResponseSize uint32`, `MaxResponseSizeCached uint32`, `MaxOperations uint32`, `MaxRequests uint32`, `RdmaIrd []uint32` (optional, max 1). The RdmaIrd field is encoded as uint32 count followed by 0 or 1 uint32 values. PITFALL: ca_rdma_ird is `<1>` not a simple optional.

- **`StateProtect4A`** (state_protect4_a): union switched on `How uint32` (SP4_NONE, SP4_MACH_CRED, SP4_SSV). For SP4_NONE: nothing extra. For SP4_MACH_CRED: `MachOps Bitmap4` + `EnforceOps Bitmap4` where Bitmap4 is `[]uint32` encoded as XDR variable-length array. For SP4_SSV: `SsvOps SsvProtInfo4` (define as opaque bytes for now -- full SSV is out of scope per REQUIREMENTS.md).

- **`StateProtect4R`** (state_protect4_r): union switched on `How uint32`. SP4_NONE: nothing. SP4_MACH_CRED: `MachOps Bitmap4` + `EnforceOps Bitmap4`. SP4_SSV: `SsvInfo SsvProtInfo4` (opaque for now).

- **`CallbackSecParms4`**: union switched on `CbSecFlavor uint32`. Cases: AUTH_NONE (0) = void, AUTH_SYS (1) = store raw opaque bytes (defer full authsys_parms parsing to handler phase), RPCSEC_GSS (6) = store raw opaque bytes. Per RESEARCH.md open question 4.

- **`Bitmap4`** type alias: `type Bitmap4 []uint32` with Encode/Decode methods (XDR variable-length uint32 array).

- **`ReferringCallTriple`** and **`ReferringCall4`**: For CB_SEQUENCE referring_call_lists. `ReferringCallTriple` has `SessionID SessionId4` + `ReferringCalls []ReferringCall4`. `ReferringCall4` has `SequenceID uint32` + `SlotID uint32`.

For encode: use `xdr.WriteUint32`, `xdr.WriteUint64`, `xdr.WriteXDROpaque`, `xdr.WriteXDRString`, `xdr.WriteBool` from existing xdr package.
For decode: use `xdr.DecodeUint32`, `xdr.DecodeUint64`, `xdr.DecodeOpaque`, `xdr.DecodeString`, `xdr.DecodeBool`.
For unions: use `xdr.EncodeUnionDiscriminant` / `xdr.DecodeUnionDiscriminant` from union.go (Task 1).

All types should satisfy the `xdr.XdrEncoder` and `xdr.XdrDecoder` interfaces.

**2. Create `session_common_test.go`** with round-trip encode/decode tests for every type in session_common.go:

- `TestSessionId4_RoundTrip`: encode then decode, verify bytes match
- `TestClientOwner4_RoundTrip`: with verifier and owner ID
- `TestServerOwner4_RoundTrip`: with minor/major ID
- `TestNfsImplId4_RoundTrip`: with domain, name, date
- `TestChannelAttrs_RoundTrip`: test both with and without RdmaIrd (count=0 and count=1)
- `TestStateProtect4A_RoundTrip_None`: SP4_NONE case
- `TestStateProtect4A_RoundTrip_MachCred`: SP4_MACH_CRED case with bitmap
- `TestCallbackSecParms4_RoundTrip`: AUTH_NONE case
- `TestBitmap4_RoundTrip`: empty and non-empty bitmap
- `TestReferringCallTriple_RoundTrip`: with session ID and calls

Use `bytes.Buffer` for encoding and `bytes.NewReader(buf.Bytes())` for decoding.

**3. Create `fixtures_test.go`** with reusable test helpers:

- `ValidSessionId() SessionId4`: returns a non-zero session ID for testing
- `ValidChannelAttrs() ChannelAttrs`: returns reasonable defaults (MaxRequestSize: 1049620, MaxResponseSize: 1049620, MaxResponseSizeCached: 1049620, MaxOperations: 16, MaxRequests: 64, no RDMA)
- `ValidClientOwner() ClientOwner4`: returns a test client owner
- `ValidServerOwner() ServerOwner4`: returns a test server owner
- `ValidNfsImplId() NfsImplId4`: returns a test implementation ID with "dittofs.test" domain
- `ValidStateProtectNone() StateProtect4A`: returns SP4_NONE protect
- `ValidStateid() Stateid4`: returns a non-zero stateid for testing (reuses existing type)
- `ValidV41RequestContext() V41RequestContext`: returns a test context with valid session/slot/seq

These are package-level functions (test-only, in _test.go file) that later per-operation test files will use.
  </action>
  <verify>
Run `go test ./internal/protocol/nfs/v4/types/ -run TestSession -v` to verify all session common round-trip tests pass.
Run `go test ./internal/protocol/nfs/v4/types/ -run TestChannel -v` to verify ChannelAttrs tests pass.
Run `go test ./internal/protocol/nfs/v4/types/ -run TestBitmap -v` to verify Bitmap tests pass.
Run `go build ./internal/protocol/...` to verify no compilation errors.
  </verify>
  <done>
All shared session types (SessionId4, ChannelAttrs, StateProtect4A/4R, ServerOwner4, NfsImplId4, ClientOwner4, CallbackSecParms4, Bitmap4, ReferringCallTriple) are defined with Encode/Decode/String methods. Round-trip tests verify encode/decode correctness for all types including edge cases (empty RDMA, SP4_NONE, AUTH_NONE). Test fixtures provide reusable helpers for later phases.
  </done>
</task>

</tasks>

<verification>
1. `go build ./internal/protocol/...` compiles with no errors
2. `go test ./internal/protocol/nfs/v4/types/...` passes all tests (existing v4.0 + new v4.1)
3. `go test ./internal/protocol/xdr/...` passes (union.go compiles cleanly)
4. `go vet ./internal/protocol/...` reports no issues
5. OpName(OP_EXCHANGE_ID) returns "EXCHANGE_ID"
6. OpNameToNum("SEQUENCE") returns (53, true)
</verification>

<success_criteria>
- All v4.1 constants, error codes, and flags are accessible from the types package
- Shared session types have working round-trip Encode/Decode
- XdrEncoder/XdrDecoder interfaces are defined and implemented by all shared types
- V41RequestContext is ready for use by Phase 20+ handlers
- Test fixtures provide reusable helpers for per-operation tests in Plans 02-04
- Zero regressions in existing v4.0 code
</success_criteria>

<output>
After completion, create `.planning/phases/16-nfsv4-1-types-and-constants/16-01-SUMMARY.md`
</output>
