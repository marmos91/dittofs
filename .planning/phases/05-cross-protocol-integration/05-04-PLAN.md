---
phase: 05-cross-protocol-integration
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - test/e2e/cross_protocol_lock_test.go
  - test/e2e/framework/lock_helpers.go
  - test/e2e/grace_period_test.go
autonomous: true

must_haves:
  truths:
    - "E2E tests verify NLM lock blocks SMB Write lease"
    - "E2E tests verify SMB Write lease breaks for NFS lock request"
    - "E2E tests verify cross-protocol file integrity after lock operations"
    - "E2E tests verify grace period recovery for both protocols"
  artifacts:
    - path: "test/e2e/cross_protocol_lock_test.go"
      provides: "Cross-protocol lock conflict tests"
      contains: "TestCrossProtocolLocking"
    - path: "test/e2e/framework/lock_helpers.go"
      provides: "File locking helpers using fcntl/flock"
      exports: ["LockFile", "UnlockFile", "TryLock"]
    - path: "test/e2e/grace_period_test.go"
      provides: "Grace period recovery tests"
      contains: "TestGracePeriodRecovery"
  key_links:
    - from: "test/e2e/cross_protocol_lock_test.go"
      to: "test/e2e/framework/mount.go"
      via: "MountNFS, MountSMB"
      pattern: "framework\\.Mount"
    - from: "test/e2e/cross_protocol_lock_test.go"
      to: "test/e2e/framework/lock_helpers.go"
      via: "LockFile, UnlockFile"
      pattern: "framework\\.LockFile"
---

<objective>
Create comprehensive E2E tests for cross-protocol locking scenarios.

Purpose: Verify that NLM locks and SMB leases interact correctly across protocols. Tests use real kernel NFS and SMB mounts to validate actual cross-protocol behavior including conflict detection, lease breaks, and data integrity.

Output: E2E test suite covering all cross-protocol lock permutations per CONTEXT.md decisions.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-cross-protocol-integration/05-CONTEXT.md
@.planning/phases/05-cross-protocol-integration/05-RESEARCH.md
@.planning/phases/05-cross-protocol-integration/05-02-SUMMARY.md
@.planning/phases/05-cross-protocol-integration/05-03-SUMMARY.md
@test/e2e/cross_protocol_test.go
@test/e2e/framework/mount.go
@test/e2e/framework/helpers.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create file locking helpers for E2E tests</name>
  <files>test/e2e/framework/lock_helpers.go</files>
  <action>
Create `test/e2e/framework/lock_helpers.go` with build tag `//go:build e2e`:

1. **LockFile(t *testing.T, path string, exclusive bool) *os.File**:
   - Open file with O_RDWR
   - Use syscall.Flock() for advisory locking
   - LOCK_EX for exclusive, LOCK_SH for shared
   - Return file handle (caller must close to release lock)

2. **TryLockFile(t *testing.T, path string, exclusive bool) (*os.File, error)**:
   - Same as LockFile but with LOCK_NB (non-blocking)
   - Returns error if lock would block

3. **UnlockFile(t *testing.T, f *os.File)**:
   - Release lock via syscall.Flock(f.Fd(), LOCK_UN)
   - Close file handle

4. **LockFileRange(t *testing.T, path string, offset, length int64, exclusive bool) *os.File**:
   - Use syscall.FcntlFlock for byte-range locks
   - F_SETLK for non-blocking, F_SETLKW for blocking
   - F_WRLCK for exclusive, F_RDLCK for shared

5. **WaitForLockRelease(t *testing.T, path string, timeout time.Duration) bool**:
   - Poll with TryLockFile until lock acquired or timeout
   - Used for waiting on cross-protocol lock release

Platform handling:
- Use syscall.Flock on Linux
- Use syscall.Flock or syscall.FcntlFlock on macOS
- Log platform-specific behavior differences
  </action>
  <verify>
    go build -tags=e2e ./test/e2e/framework/...
  </verify>
  <done>
    E2E test framework includes file locking helpers for fcntl/flock operations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cross-protocol lock E2E tests</name>
  <files>test/e2e/cross_protocol_lock_test.go</files>
  <action>
Create `test/e2e/cross_protocol_lock_test.go` with build tag `//go:build e2e`:

1. **TestCrossProtocolLocking** - Main test setup:
   - Start server, create share with memory stores
   - Create SMB user with credentials
   - Enable NFS and SMB adapters
   - Mount both protocols (same share, actimeo=0 for NFS)
   - Run subtests sequentially (shared mounts)

2. **Subtest: XPRO-01 NFS lock blocks SMB Write lease** (testNFSLockBlocksSMBLease):
   - Create file via NFS
   - Acquire exclusive lock via NFS (fcntl)
   - Attempt to open file via SMB with Write lease request
   - Verify SMB receives STATUS_LOCK_NOT_GRANTED or lease downgrade
   - Release NFS lock
   - Verify SMB can now acquire lease

3. **Subtest: XPRO-02 SMB Write lease breaks for NFS lock** (testSMBLeaseBreaksForNFSLock):
   - Create file via SMB with Write lease
   - Verify lease acquired (if SMB client exposes this)
   - Request exclusive lock via NFS
   - Verify NFS eventually acquires lock (after break timeout or ack)
   - Verify SMB client sees lease break notification

4. **Subtest: XPRO-03 Cross-protocol lock conflict detection** (testCrossProtocolConflict):
   - Create file
   - Acquire shared lock via NFS
   - Acquire shared lock via SMB (should succeed - multiple readers)
   - Attempt exclusive lock via NFS (should fail - SMB shared exists)
   - Release SMB lock
   - Retry exclusive lock via NFS (should now succeed)

5. **Subtest: XPRO-04 Cross-protocol data integrity** (testCrossProtocolDataIntegrity):
   - NFS client writes data with exclusive lock
   - Release lock
   - SMB client reads same file
   - Verify content matches
   - Reverse: SMB writes, NFS reads and verifies

6. **Timeouts**: Use 5-second shortened timeout per CONTEXT.md for faster CI.
  </action>
  <verify>
    go build -tags=e2e ./test/e2e/...
    # Full test requires sudo and actual mounts
  </verify>
  <done>
    E2E tests verify NLM/SMB lease conflicts per XPRO requirements.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create grace period E2E tests</name>
  <files>test/e2e/grace_period_test.go</files>
  <action>
Create `test/e2e/grace_period_test.go` with build tag `//go:build e2e`:

1. **TestGracePeriodRecovery** - Test shared grace period:
   - Start server with grace period configured (shortened for testing)
   - Create NFS and SMB mounts
   - Acquire NFS lock on file1
   - Acquire SMB lock on file2 (if byte-range locks via SMB available)
   - Stop server gracefully
   - Restart server
   - Verify grace period is active (new locks blocked)
   - Reclaim NFS lock on file1 (should succeed)
   - Reclaim SMB lock on file2 (should succeed)
   - Wait for grace period to end
   - Verify new locks can be acquired

2. **TestGracePeriodUnclaimedLocks** - Test auto-deletion:
   - Start server, acquire lock via NFS
   - Stop server
   - Kill NFS client process (simulate crash)
   - Restart server
   - Wait for grace period to end without reclaim
   - Verify lock is auto-deleted
   - Verify new client can acquire lock

3. **TestCrossProtocolReclaim** - Test both protocols reclaim:
   - NFS holds lock during shutdown
   - SMB holds lease during shutdown
   - Restart server
   - Both NFS and SMB can reclaim
   - Grace period ends correctly

Per CONTEXT.md: Single shared 90-second grace period for both protocols.
Shortened to 10-15 seconds for test with env var override.
  </action>
  <verify>
    go build -tags=e2e ./test/e2e/...
  </verify>
  <done>
    E2E tests verify cross-protocol grace period recovery.
  </done>
</task>

</tasks>

<verification>
Build verification (no sudo required):

```bash
# Build E2E tests
go build -tags=e2e ./test/e2e/...

# Check test compilation
go test -tags=e2e -c ./test/e2e/ -o /dev/null
```

Full E2E execution (requires sudo):

```bash
# Run cross-protocol lock tests
cd test/e2e && sudo ./run-e2e.sh --test TestCrossProtocolLocking

# Run grace period tests
cd test/e2e && sudo ./run-e2e.sh --test TestGracePeriod
```
</verification>

<success_criteria>
- Lock helpers work on both Linux and macOS
- TestCrossProtocolLocking covers all XPRO requirements
- NFS lock blocking SMB lease is verified
- SMB lease break for NFS lock is verified
- Data integrity maintained across protocol boundaries
- Grace period recovery works for both protocols
- Tests use shortened timeouts (5s) for CI
- All tests compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-cross-protocol-integration/05-04-SUMMARY.md`
</output>
