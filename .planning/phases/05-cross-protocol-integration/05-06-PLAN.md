---
phase: 05-cross-protocol-integration
plan: 06
type: execute
wave: 2
depends_on: ["05-05"]
files_modified:
  - test/e2e/framework/mount.go
  - test/e2e/cross_protocol_lock_test.go
  - test/e2e/grace_period_test.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "E2E tests gracefully skip SMB when native CIFS client unavailable"
    - "Cross-protocol lock tests run with NFS mounts and skip SMB via SkipIfNoSMBMount"
    - "Grace period tests verify NFS lock reclaim and SMB lease reclaim when available"
  artifacts:
    - path: "test/e2e/framework/mount.go"
      provides: "SkipIfNoSMBMount and IsNativeSMBAvailable for graceful SMB test skipping"
      contains: "SkipIfNoSMBMount"
    - path: "test/e2e/cross_protocol_lock_test.go"
      provides: "Working cross-protocol lock tests"
      contains: "TestCrossProtocolLocking"
    - path: "test/e2e/grace_period_test.go"
      provides: "Working SMB lease grace period tests"
      contains: "TestGracePeriodWithSMBLeases"
  key_links:
    - from: "test/e2e/cross_protocol_lock_test.go"
      to: "test/e2e/framework/mount.go"
      via: "SkipIfNoSMBMount call"
      pattern: "framework\\.SkipIfNoSMBMount"
---

<objective>
Enable cross-protocol E2E tests to handle missing SMB mount capability gracefully.

Purpose: Close the verification gap where E2E tests exist but cannot be executed on systems without native SMB mount support. Uses native capability detection and graceful test skipping.

Output: Native SMB mount detection helpers, SkipIfNoSMBMount for graceful test skipping, working cross-protocol E2E tests on systems with native SMB support.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-cross-protocol-integration/05-VERIFICATION.md
@.planning/phases/05-cross-protocol-integration/05-CONTEXT.md
@.planning/phases/05-cross-protocol-integration/05-05-PLAN.md
@test/e2e/framework/mount.go
@test/e2e/cross_protocol_lock_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SkipIfNoSMBMount helper</name>
  <files>
    test/e2e/framework/mount.go
  </files>
  <action>
Add graceful SMB mount detection to `test/e2e/framework/mount.go`:

1. Add `IsNativeSMBAvailable()` function:
   - macOS: check for `/sbin/mount_smbfs` or `/usr/sbin/mount_smbfs`
   - Linux: check for `/sbin/mount.cifs` or `/usr/sbin/mount.cifs`
   - Windows: always true (SMB built-in)

2. Add `SkipIfNoSMBMount(t *testing.T)` function:
   - Calls `t.Helper()`
   - Skips test with informative message if no native SMB mount available

3. Add `fileExists(path string) bool` helper
  </action>
  <verify>
    `go build -tags=e2e ./test/e2e/framework/...` succeeds.
  </verify>
  <done>
    SkipIfNoSMBMount and IsNativeSMBAvailable exist in mount.go.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update cross-protocol tests with skip conditions</name>
  <files>
    test/e2e/cross_protocol_lock_test.go
  </files>
  <action>
Add skip conditions to cross-protocol locking tests:

1. `TestCrossProtocolLocking` - add `framework.SkipIfNoSMBMount(t)` at start
2. `TestCrossProtocolLockingByteRange` - add `framework.SkipIfNoSMBMount(t)` at start
3. NFS-only tests continue to run without skip conditions
  </action>
  <verify>
    `go build -tags=e2e ./test/e2e/...` succeeds.
    Tests skip gracefully on systems without native SMB mount.
  </verify>
  <done>
    Cross-protocol tests skip gracefully when SMB mount unavailable.
  </done>
</task>

</tasks>

<verification>
1. Build: `go build -tags=e2e ./test/e2e/...` succeeds
2. On macOS/Linux with SMB: tests run normally
3. On systems without SMB: tests skip gracefully with informative message
4. No Docker dependency
</verification>

<success_criteria>
1. SkipIfNoSMBMount provides graceful test skipping
2. Cross-protocol lock tests execute on systems with native SMB mount
3. Tests skip with clear message on systems without SMB mount
4. All existing E2E tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-cross-protocol-integration/05-06-SUMMARY.md`
</output>
