---
phase: 25-v3-integration-testing
plan: 03
type: execute
wave: 2
depends_on: [25-01]
files_modified:
  - test/e2e/nfsv41_session_test.go
  - test/e2e/nfsv4_delegation_test.go
  - test/e2e/nfsv41_dirdeleg_test.go
  - test/e2e/nfsv41_disconnect_test.go
autonomous: true
requirements: [TEST-02, TEST-03, TEST-05]

must_haves:
  truths:
    - "EOS replay is verified through server-side observability (log scraping for replay cache hit during v4.1 operations)"
    - "Backchannel CB_RECALL works for v4.1 clients (delegation recalled over fore-channel, not dial-out)"
    - "Directory delegation notifications tested for all mutation types (add, remove, rename, attr change)"
    - "Delegation state is properly cleaned up after recall/revocation"
    - "Disconnect tests verify no resource leaks after force-close during write, readdir, and session establishment"
  artifacts:
    - path: "test/e2e/nfsv41_session_test.go"
      provides: "EOS replay verification tests"
      min_lines: 80
      contains: "replay"
    - path: "test/e2e/nfsv4_delegation_test.go"
      provides: "v4.1 backchannel delegation recall tests"
      contains: "v4.1"
    - path: "test/e2e/nfsv41_dirdeleg_test.go"
      provides: "Directory delegation notification tests for all mutation types"
      min_lines: 100
      contains: "CB_NOTIFY"
    - path: "test/e2e/nfsv41_disconnect_test.go"
      provides: "Disconnect/robustness tests"
      min_lines: 80
      contains: "disconnect"
  key_links:
    - from: "test/e2e/nfsv41_session_test.go"
      to: "test/e2e/framework/mount.go"
      via: "MountNFSWithVersion for v4.1 mount"
      pattern: "MountNFSWithVersion.*4\\.1"
    - from: "test/e2e/nfsv4_delegation_test.go"
      to: "test/e2e/framework/mount.go"
      via: "v4.1 delegation tests use v4.1 mount"
      pattern: "MountNFSWithVersion.*4\\.1"
    - from: "test/e2e/nfsv41_dirdeleg_test.go"
      to: "test/e2e/framework/mount.go"
      via: "Directory delegation tests use v4.1 mount"
      pattern: "MountNFSWithVersion.*4\\.1"
---

<objective>
Add v4.1-specific E2E tests for EOS replay verification, backchannel delegation recall, directory delegation notifications, and disconnect robustness.

Purpose: Validates NFSv4.1-specific protocol features that cannot be tested through version-parametrized basic operations: exactly-once semantics, backchannel callbacks, directory delegation notifications, and graceful handling of client disconnects.
Output: Four new/extended test files covering all v4.1 protocol-specific verification requirements.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-v3-integration-testing/25-RESEARCH.md
@.planning/phases/25-v3-integration-testing/25-01-SUMMARY.md

@test/e2e/framework/mount.go
@test/e2e/framework/helpers.go
@test/e2e/nfsv4_delegation_test.go
@test/e2e/nfsv4_basic_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: EOS replay verification and backchannel delegation recall tests</name>
  <files>
    test/e2e/nfsv41_session_test.go
    test/e2e/nfsv4_delegation_test.go
  </files>
  <action>
1. Create `test/e2e/nfsv41_session_test.go` with build tag `//go:build e2e`:

   **EOS Replay Tests:**
   a. `TestNFSv41EOSReplayOnReconnect` -- Verify EOS behavior after TCP connection disruption:
      - Skip on macOS, skip if NFSv4.1 unsupported
      - Start server with memory/memory stores using `setupNFSv4TestServer(t)`
      - Mount v4.1 via `framework.MountNFSWithVersion(t, nfsPort, "4.1")`
      - Capture server log position (use `readLogFile` helper pattern from delegation tests)
      - Perform a write operation: create a file, write content, sync
      - After the write completes, read new server logs
      - Check for replay-related log messages: "replay cache hit", "SEQUENCE replay", "slot seqid"
      - Note: The Linux NFS client may not trigger replay during normal operation. The test should:
        (1) Perform heavy I/O (multiple concurrent file creates/writes) to increase the probability of a natural retry
        (2) Check server logs for ANY replay cache activity
        (3) If no replay detected, log a warning but do NOT fail -- the EOS machinery is validated by unit tests; this E2E test validates the integration
      - The test proves the EOS infrastructure is active and handling v4.1 sessions correctly

   b. `TestNFSv41EOSConnectionDisruption` -- Force a replay by disrupting the connection:
      - Start server, mount v4.1
      - Begin writing a large file (10MB) in a goroutine
      - While write is in progress, identify the NFS client's TCP connection to the server port
      - Use `ss` or `/proc/net/tcp` to find the connection, then cause disruption (e.g., `iptables` rule to drop packets briefly, or `tc netem` to add delay)
      - After disruption, the NFS client should retry with same slot+seqid
      - Check server logs for "replay cache hit" or equivalent
      - If disruption mechanism unavailable (no iptables, not root), skip with a message
      - Clean up any iptables rules in t.Cleanup

   c. `TestNFSv41SessionEstablishment` -- Verify basic session lifecycle:
      - Mount v4.1, verify mount succeeds (implicitly validates EXCHANGE_ID + CREATE_SESSION + SEQUENCE)
      - Perform a basic operation (create file, read, delete) to confirm session is functional
      - Unmount, verify server logs show clean session teardown (DESTROY_SESSION)

   **Log scraping helpers:**
   - Use the existing log scraping pattern from `nfsv4_delegation_test.go`:
     - `readLogFile(t, sp)` to capture log snapshot
     - Compare before/after logs to find new entries
     - `strings.Contains` for specific log messages
   - If the delegation test file already has these helpers as unexported functions, consider whether to duplicate or refactor. Since they're in the same package, they should be accessible. Check if they're already shared.

2. Extend `test/e2e/nfsv4_delegation_test.go` to add v4.1 backchannel delegation recall tests:

   **v4.1 Backchannel Delegation Recall:**
   Add a new test function `TestNFSv41BackchannelDelegationRecall`:
   - Skip on macOS, skip if NFSv4.1 unsupported
   - Start server with memory/memory stores
   - Mount TWO v4.1 clients to the same share (two separate mount points)
   - Client 1: open and write a file (should get delegation via OPEN)
   - Capture server logs
   - Client 2: open the same file for reading (triggers delegation recall on client 1)
   - Wait 2 seconds for callback delivery
   - Check server logs for:
     - "Delegation granted" (confirms delegation was issued)
     - "CB_RECALL" or "backchannel callback" (confirms recall via backchannel, NOT dial-out)
     - For v4.1 clients, the key distinction is that CB_RECALL goes over the fore-channel connection, not a separate TCP dial-out
   - Verify file content is consistent across both mounts
   - Verify delegation state cleanup: check logs for delegation return/revocation

   Follow the exact pattern from existing `TestNFSv4DelegationRecallOnConflict` but:
   - Use v4.1 mounts instead of v4.0
   - Verify backchannel-specific log messages (CB_SEQUENCE usage, not dial-out)
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build -tags=e2e ./test/e2e/...</automated>
    <manual>Verify nfsv41_session_test.go has EOS replay tests and nfsv4_delegation_test.go has v4.1 backchannel test</manual>
  </verify>
  <done>EOS replay tests verify session/slot machinery via log scraping after v4.1 operations. Backchannel delegation recall test confirms CB_RECALL delivered over fore-channel for v4.1 clients. Connection disruption test attempts to trigger actual replay. Session lifecycle test validates EXCHANGE_ID through DESTROY_SESSION.</done>
</task>

<task type="auto">
  <name>Task 2: Directory delegation notification and disconnect robustness tests</name>
  <files>
    test/e2e/nfsv41_dirdeleg_test.go
    test/e2e/nfsv41_disconnect_test.go
  </files>
  <action>
1. Create `test/e2e/nfsv41_dirdeleg_test.go` with build tag `//go:build e2e`:

   **Directory Delegation Notification Tests:**
   All tests skip on macOS and if NFSv4.1 unsupported. Use memory/memory stores.

   a. `TestNFSv41DirDelegationEntryAdded` -- CB_NOTIFY on file creation:
      - Mount v4.1 client 1, READDIR on a directory (triggers GET_DIR_DELEGATION request)
      - Wait 200ms for batching window
      - From client 2 (or server-side via control plane), create a new file in the directory
      - Wait 500ms for CB_NOTIFY delivery (50ms batch window + network time)
      - Check server logs for "CB_NOTIFY" or "directory notification" messages
      - If GET_DIR_DELEGATION was not requested by client (check logs), skip test with warning:
        "Linux NFS client did not request directory delegation -- client kernel may not support this"

   b. `TestNFSv41DirDelegationEntryRemoved` -- CB_NOTIFY on file removal:
      - Setup: create a file in directory via mount 1
      - Client 2 deletes the file
      - Verify CB_NOTIFY sent for entry removal

   c. `TestNFSv41DirDelegationEntryRenamed` -- CB_NOTIFY on rename:
      - Setup: create a file in directory via mount 1
      - Client 2 renames the file
      - Verify CB_NOTIFY sent for rename (may produce two notifications: remove from old dir + add to new)

   d. `TestNFSv41DirDelegationAttrChanged` -- CB_NOTIFY on attribute change:
      - Setup: create a file in directory via mount 1
      - Client 2 changes file permissions (chmod)
      - Verify CB_NOTIFY sent for attribute change
      - Per Phase 24 decision: only significant attr changes trigger notification (mode/owner/group/size, NOT atime/ctime)

   e. `TestNFSv41DirDelegationCleanup` -- Verify delegation state cleanup:
      - Grant directory delegation, then unmount the client
      - Check that server cleans up delegation state (log scraping for "delegation revoked" or similar)

   **Important timing:** Per Phase 24 research:
   - CB_NOTIFY batching window is 50ms with max batch size 100
   - Wait at least 200ms after mutation before checking logs
   - Use `time.Sleep(500 * time.Millisecond)` as a safe margin

   **Important:** The Linux NFS client may not consistently request GET_DIR_DELEGATION. If the client does not request it, the test should detect this via log scraping and skip with an informative message rather than fail.

2. Create `test/e2e/nfsv41_disconnect_test.go` with build tag `//go:build e2e`:

   **Disconnect/Robustness Tests:**
   All tests skip on macOS and if NFSv4.1 unsupported. Use memory/memory stores.

   a. `TestNFSv41DisconnectDuringLargeWrite` -- Force-close client during large file write:
      - Mount v4.1
      - Start writing a 10MB file in a goroutine
      - While write is in progress, force unmount (umount -f) or kill the NFS client connection
      - Verify server does not panic or leak goroutines
      - Remount and verify the server is still operational (can create and read files)
      - Check server logs for clean connection handling (no panics, no goroutine leaks)

   b. `TestNFSv41DisconnectDuringReadDir` -- Force-close during directory listing:
      - Create 100+ files in a directory to make READDIR take time
      - Mount v4.1
      - Start listing the directory in a goroutine (os.ReadDir)
      - Force unmount during listing
      - Remount and verify server still works

   c. `TestNFSv41DisconnectDuringSessionSetup` -- Force-close during session establishment:
      - Start mount command but kill it mid-way (using exec.CommandContext with short timeout)
      - Verify server handles the incomplete session gracefully
      - A subsequent full mount should succeed
      - Check server logs for no orphaned session state (session reaper should clean up)

   **Common pattern for disconnect tests:**
   - Use `exec.CommandContext` with a very short timeout to force-kill mount mid-operation
   - After disconnect, wait briefly for server cleanup (2 seconds)
   - Remount fresh and verify basic operations work
   - Check server logs for panic/goroutine leak indicators
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build -tags=e2e ./test/e2e/...</automated>
    <manual>Verify nfsv41_dirdeleg_test.go has all 4 notification type tests and cleanup test. Verify nfsv41_disconnect_test.go has 3 disconnect scenarios.</manual>
  </verify>
  <done>Directory delegation tests cover all CB_NOTIFY mutation types (add, remove, rename, attr change) with proper batching delays and graceful skip when client doesn't request delegation. Disconnect tests verify server robustness after force-close during write, readdir, and session setup. All test code compiles.</done>
</task>

</tasks>

<verification>
1. `go build -tags=e2e ./test/e2e/...` compiles without errors
2. `grep -r 'replay' test/e2e/nfsv41_session_test.go` shows EOS replay verification logic
3. `grep -r 'CB_RECALL\|backchannel' test/e2e/nfsv4_delegation_test.go` shows v4.1 backchannel test
4. `grep -r 'CB_NOTIFY\|dir.*deleg' test/e2e/nfsv41_dirdeleg_test.go` shows directory delegation tests
5. `grep -r 'disconnect\|force.*unmount' test/e2e/nfsv41_disconnect_test.go` shows disconnect tests
6. All new test functions have proper skip guards for macOS and NFSv4.1 unavailability
</verification>

<success_criteria>
- EOS replay tests verify session/slot machinery is active via log scraping
- Connection disruption test attempts to trigger actual EOS replay
- Backchannel delegation recall test confirms CB_RECALL over fore-channel for v4.1
- All four directory delegation notification types tested (add, remove, rename, attr change)
- Directory delegation cleanup verified after client unmount
- Three disconnect scenarios tested (write, readdir, session setup) without server crashes
- All tests skip gracefully on macOS and when v4.1 unavailable
- All code compiles with e2e build tag
</success_criteria>

<output>
After completion, create `.planning/phases/25-v3-integration-testing/25-03-SUMMARY.md`
</output>
