---
phase: 25-v3-integration-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - test/e2e/framework/mount.go
  - test/e2e/framework/helpers.go
  - test/e2e/nfsv4_basic_test.go
  - test/e2e/nfsv4_store_matrix_test.go
  - test/e2e/nfsv41_coexistence_test.go
autonomous: true
requirements: [TEST-01, TEST-04]

must_haves:
  truths:
    - "NFSv4.1 mount succeeds on Linux with vers=4.1 option using extended MountNFSExportWithVersion"
    - "NFSv4.1 mount skips on macOS with t.Skip (not t.Fatal)"
    - "Basic file operations (create, read, write, delete, mkdir, rmdir, rename) pass on v4.1 mount"
    - "Store matrix tests run against all backend combinations with v4.1 added to version slice"
    - "v4.0 and v4.1 clients coexist on the same share with cross-version visibility"
    - "Existing v3 and v4.0 tests continue to pass unchanged"
  artifacts:
    - path: "test/e2e/framework/mount.go"
      provides: "v4.1 case in MountNFSExportWithVersion switch"
      contains: "case \"4.1\""
    - path: "test/e2e/framework/helpers.go"
      provides: "SkipIfNFSv41Unsupported helper"
      contains: "SkipIfNFSv41Unsupported"
    - path: "test/e2e/nfsv4_basic_test.go"
      provides: "v4.1 added to versions slice"
      contains: "\"4.1\""
    - path: "test/e2e/nfsv4_store_matrix_test.go"
      provides: "v4.1 added to versions slice"
      contains: "\"4.1\""
    - path: "test/e2e/nfsv41_coexistence_test.go"
      provides: "v4.0+v4.1 simultaneous mount coexistence tests"
      min_lines: 80
  key_links:
    - from: "test/e2e/nfsv4_basic_test.go"
      to: "test/e2e/framework/mount.go"
      via: "MountNFSWithVersion(t, port, \"4.1\")"
      pattern: "MountNFSWithVersion.*4\\.1"
    - from: "test/e2e/nfsv41_coexistence_test.go"
      to: "test/e2e/framework/mount.go"
      via: "MountNFSWithVersion with both 4.0 and 4.1"
      pattern: "MountNFSWithVersion.*4\\.[01]"
---

<objective>
Extend the e2e framework to support NFSv4.1 mounts and parametrize existing tests to include v4.1, then add coexistence tests verifying v4.0+v4.1 simultaneous access.

Purpose: Establishes v4.1 mount capability needed by all subsequent v4.1-specific tests, and validates that basic file operations work transparently across all three NFS versions and all storage backends.
Output: Extended mount framework, v4.1-parametrized basic and store matrix tests, coexistence test file.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-v3-integration-testing/25-RESEARCH.md

@test/e2e/framework/mount.go
@test/e2e/framework/helpers.go
@test/e2e/nfsv4_basic_test.go
@test/e2e/nfsv4_store_matrix_test.go
@test/e2e/nfsv4_delegation_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend mount framework for NFSv4.1 and parametrize existing tests</name>
  <files>
    test/e2e/framework/mount.go
    test/e2e/framework/helpers.go
    test/e2e/nfsv4_basic_test.go
    test/e2e/nfsv4_store_matrix_test.go
  </files>
  <action>
1. In `test/e2e/framework/mount.go`, add a `case "4.1"` to the `MountNFSExportWithVersion` switch:
   - Mount options: `vers=4.1,port=%d,actimeo=0` (no mountport, stateful protocol like v4.0)
   - On macOS (`runtime.GOOS == "darwin"`): clean up mountPath and call `t.Skip("NFSv4.1 not supported on macOS")` (NOT t.Fatal)
   - On Linux: no additional options needed (kernel supports v4.1 since 2.6.38)
   - On other platforms: clean up and t.Fatalf
   - Update the Mount struct Version comment to include "4.1"
   - Update the default case error message to mention "4.1" as valid

2. In `test/e2e/framework/helpers.go`, add a `SkipIfNFSv41Unsupported` helper:
   - On macOS: `t.Skip("NFSv4.1 not reliably supported on macOS")`
   - On Linux: check if nfs kernel module supports v4.1 (best-effort, don't skip if check fails)
   - This is separate from SkipIfNFSv4Unsupported to allow v4.0 tests to run on macOS while v4.1 skips

3. In `test/e2e/nfsv4_basic_test.go`, add `"4.1"` to the `versions` slice in `TestNFSv4BasicOperations`:
   - Change `versions := []string{"3", "4.0"}` to `versions := []string{"3", "4.0", "4.1"}`
   - Add v4.1 skip guard alongside the v4.0 guard: `if ver == "4.1" { framework.SkipIfNFSv41Unsupported(t) }`
   - **Verify that all TestNFSv4BasicOperations subtests (create, read, write, delete, rename, mkdir, rmdir) run and pass for v4.1** by adding "4.1" to the versions slice. The parametrization ensures the same file operation assertions execute against a v4.1 mount, satisfying TEST-01 ("Linux NFS client mounts with vers=4.1 and performs basic file operations").
   - Also add v4.1 to any other version-parameterized test functions in this file (TestNFSv4AdvancedOperations, TestNFSv4PseudoFS, TestNFSv4ReadDirPagination, etc.) where it makes sense. For v4-specific tests (like pseudo-fs browsing, stale handles), v4.1 should work identically.

4. In `test/e2e/nfsv4_store_matrix_test.go`, add `"4.1"` to the `versions` slice:
   - Change `versions := []string{"3", "4.0"}` to `versions := []string{"3", "4.0", "4.1"}`
   - Add the v4.1 skip guard in the version loop: `if ver == "4.1" { framework.SkipIfNFSv41Unsupported(t) }`
   - This extends the store matrix to test v4.1 against all 9 backend combinations (memory, badger, postgres x memory, filesystem, s3)

Ensure the build tag `//go:build e2e` is present on all modified files.
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build -tags=e2e ./test/e2e/...</automated>
    <manual>Verify that mount.go has case "4.1", helpers.go has SkipIfNFSv41Unsupported, and test files include "4.1" in version slices</manual>
  </verify>
  <done>MountNFSExportWithVersion handles "4.1" with macOS skip and Linux support. SkipIfNFSv41Unsupported helper exists. Basic and store matrix tests include "4.1" in their version parametrization. Code compiles with e2e tag.</done>
</task>

<task type="auto">
  <name>Task 2: Add v4.0/v4.1 coexistence test</name>
  <files>
    test/e2e/nfsv41_coexistence_test.go
  </files>
  <action>
Create `test/e2e/nfsv41_coexistence_test.go` with build tag `//go:build e2e`:

1. `TestNFSv41v40Coexistence` -- mount BOTH v4.0 and v4.1 simultaneously on the SAME share:
   - Skip on macOS (v4.1 not supported) and if NFSv4 unavailable
   - Use `setupNFSv4TestServer(t)` for server setup (memory/memory, per existing pattern)
   - Mount v4.0 via `framework.MountNFSWithVersion(t, nfsPort, "4.0")`
   - Mount v4.1 via `framework.MountNFSWithVersion(t, nfsPort, "4.1")`
   - Subtests:
     a. `WriteV40ReadV41`: Write file from v4.0 mount, read from v4.1 mount (500ms sleep between for cache)
     b. `WriteV41ReadV40`: Write file from v4.1 mount, read from v4.0 mount
     c. `MkdirV40ListV41`: Create directory from v4.0, list from v4.1
     d. `MkdirV41ListV40`: Create directory from v4.1, list from v4.0
     e. `RenameV40SeeV41`: Rename file from v4.0 mount, verify renamed file visible from v4.1
     f. `DeleteV41SeeV40`: Delete file from v4.1 mount, verify file gone from v4.0

2. `TestNFSv41v3Coexistence` -- same pattern but v3 + v4.1:
   - Only if both v3 and v4.1 are supported
   - Write from v3, read from v4.1 and vice versa
   - Simpler subtests (just write/read cross-version visibility)

Use `time.Sleep(500 * time.Millisecond)` between write and cross-mount read per pitfall guidance.
Use `require.NoError` / `assert.Equal` from testify.
Clean up test files in each subtest via `t.Cleanup`.
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build -tags=e2e ./test/e2e/...</automated>
    <manual>Verify nfsv41_coexistence_test.go exists with TestNFSv41v40Coexistence and TestNFSv41v3Coexistence functions</manual>
  </verify>
  <done>Coexistence tests verify that v4.0+v4.1 and v3+v4.1 mounts can operate simultaneously on the same share with bidirectional cross-version visibility for files, directories, renames, and deletes.</done>
</task>

</tasks>

<verification>
1. `go build -tags=e2e ./test/e2e/...` compiles without errors
2. `grep -r '"4.1"' test/e2e/` shows v4.1 in mount.go, helpers.go, basic test, store matrix test, and coexistence test
3. `grep -r 'SkipIfNFSv41Unsupported' test/e2e/` shows the helper defined and used
4. No existing v3 or v4.0 test behavior is changed (only version slices extended)
</verification>

<success_criteria>
- MountNFSExportWithVersion handles version "4.1" correctly on both macOS (skip) and Linux
- SkipIfNFSv41Unsupported helper exists in framework/helpers.go
- All existing version-parametrized tests include "4.1" in their version slices
- Store matrix runs v4.1 against all backend combinations
- Coexistence tests verify simultaneous v4.0+v4.1 and v3+v4.1 access
- All code compiles with e2e build tag
</success_criteria>

<output>
After completion, create `.planning/phases/25-v3-integration-testing/25-01-SUMMARY.md`
</output>
