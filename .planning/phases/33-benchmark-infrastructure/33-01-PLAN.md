---
phase: 33-benchmark-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bench/.gitignore
  - bench/.env.example
  - bench/Makefile
  - bench/docker/Dockerfile.dittofs
  - bench/scripts/lib/common.sh
  - bench/scripts/check-prerequisites.sh
  - bench/scripts/clean-all.sh
autonomous: true
requirements: [BENCH-01]

must_haves:
  truths:
    - "bench/ directory structure exists with all required subdirectories"
    - "Shared script library provides logging, timer, and OS-detection utilities"
    - "Prerequisites check script validates all required tools and reports missing ones"
    - "Clean-all script safely tears down containers, volumes, and mounts"
    - "Dockerfile.dittofs builds DittoFS with both dfs and dfsctl binaries"
    - ".env.example provides sensible LocalStack/Postgres defaults that work without modification"
  artifacts:
    - path: "bench/.gitignore"
      provides: "Gitignore for results/, .env, Python artifacts"
    - path: "bench/.env.example"
      provides: "Environment variable template with S3, Postgres, resource limits, benchmark params"
    - path: "bench/Makefile"
      provides: "Convenience targets wrapping shell scripts with help target"
    - path: "bench/docker/Dockerfile.dittofs"
      provides: "Multi-stage Go build producing dfs+dfsctl Alpine image"
    - path: "bench/scripts/lib/common.sh"
      provides: "log_info, log_warn, log_error, die, timer_start, timer_stop, detect_os"
    - path: "bench/scripts/check-prerequisites.sh"
      provides: "Validates docker, fio, jq, bc, make, docker compose v2, python3 (optional)"
    - path: "bench/scripts/clean-all.sh"
      provides: "Stops containers, removes volumes, unmounts NFS/SMB, prunes Docker"
  key_links:
    - from: "bench/scripts/check-prerequisites.sh"
      to: "bench/scripts/lib/common.sh"
      via: "source import"
      pattern: "source.*lib/common.sh"
    - from: "bench/scripts/clean-all.sh"
      to: "bench/scripts/lib/common.sh"
      via: "source import"
      pattern: "source.*lib/common.sh"
    - from: "bench/Makefile"
      to: "bench/scripts/check-prerequisites.sh"
      via: "make target invocation"
      pattern: "check-prerequisites"
---

<objective>
Create the bench/ directory scaffolding with shared utilities, prerequisites check, cleanup script, DittoFS Dockerfile, environment template, Makefile, and gitignore.

Purpose: Establish the foundational directory structure and utility scripts that Plan 02 (Docker Compose + configs) will build upon.
Output: bench/ directory with scripts/lib/, docker/, and all supporting infrastructure files.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-benchmark-infrastructure/33-CONTEXT.md
@.planning/phases/33-benchmark-infrastructure/33-RESEARCH.md

<interfaces>
<!-- Reference patterns from existing project infrastructure -->

From test/smb-conformance/Makefile:
- `.DEFAULT_GOAL := help`
- `help:` target with grep/awk pattern for self-documenting targets
- Profile variable: `PROFILE ?= memory`

From test/smb-conformance/Dockerfile.dittofs:
- Multi-stage build: golang:1.25-alpine builder -> alpine:3.21 runtime
- Builds both `dfs` and `dfsctl` binaries
- Non-root user (65532:65532), healthcheck on :8080/health/ready
- `ENTRYPOINT ["/app/dfs"]` with `CMD ["start", "--foreground", "--config", "/config/config.yaml"]`

From test/e2e/run-e2e.sh:
- `set -euo pipefail` pattern
- Color codes: RED, GREEN, YELLOW, BLUE, NC
- Script directory detection: `SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"`
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create directory structure, .gitignore, .env.example, and common.sh</name>
  <files>
    bench/.gitignore
    bench/.env.example
    bench/scripts/lib/common.sh
  </files>
  <action>
Create the complete bench/ directory tree with empty placeholder subdirectories, then create three core files:

**Directory structure** (create all directories):
```
bench/
├── docker/
├── configs/
│   ├── dittofs/
│   ├── ganesha/
│   ├── rclone/
│   ├── kernel-nfs/
│   └── samba/
├── workloads/          (empty, Phase 34)
├── scripts/
│   └── lib/
├── analysis/           (empty, Phase 37)
└── results/            (gitignored)
```

Add `.gitkeep` files in empty directories (workloads/, analysis/) so they are tracked by git.

**bench/.gitignore:**
```
results/
.env
*.pyc
__pycache__/
```

**bench/.env.example** — organized into sections per research:
1. S3 Configuration (LocalStack defaults: endpoint=http://localhost:4566, bucket=bench, region=us-east-1, key=test/test)
2. PostgreSQL Configuration (user=bench, password=bench, db=bench)
3. DittoFS Configuration (DITTOFS_CONTROLPLANE_SECRET=BenchmarkInfrastructureSecret32ch!, BENCH_WAL_ENABLED=true)
4. Resource Limits (BENCH_CPU_LIMIT=2, BENCH_MEM_LIMIT=4g, BENCH_CACHE_SIZE=256MB, BENCH_CACHE_SIZE_MB=256)
5. Benchmark Parameters (BENCH_THREADS=4, BENCH_ITERATIONS=3, BENCH_RUNTIME=60)
6. Platform Configuration (FIO_ENGINE commented out, auto-detected by scripts)
7. Volume Configuration (BENCH_TMPFS commented out)

**bench/scripts/lib/common.sh** — shared script library, must pass ShellCheck:
- `set -euo pipefail`
- Color variables: RED, GREEN, YELLOW, BLUE, NC (with `\033[0;3Xm` escape codes)
- `log_info()`, `log_warn()`, `log_error()` (to stderr), `die()` (log_error + exit 1)
- `timer_start()` — outputs `date +%s`
- `timer_stop()` — takes start timestamp arg, outputs elapsed seconds
- `detect_os()` — returns "linux" or "macos" based on `uname -s`, dies on unsupported OS
- `require_docker_compose_v2()` — validates `docker compose version` works, dies if not
- `wait_healthy()` — takes service name, polls `docker compose ps` for healthy status with timeout
- Script should NOT call `set -euo pipefail` at the top since it's a sourced library (the sourcing script sets it)

All functions should be ShellCheck-clean (`set -euo pipefail` compatible, proper quoting).
  </action>
  <verify>
    <automated>
test -d bench/configs/dittofs && test -d bench/configs/ganesha && test -d bench/configs/rclone && test -d bench/configs/kernel-nfs && test -d bench/configs/samba && test -d bench/scripts/lib && test -d bench/docker && test -d bench/workloads && test -d bench/analysis && test -f bench/.gitignore && test -f bench/.env.example && test -f bench/scripts/lib/common.sh && echo "PASS: All directories and files exist" || echo "FAIL"
    </automated>
  </verify>
  <done>
    - bench/ directory tree exists with all subdirectories (docker/, configs/{dittofs,ganesha,rclone,kernel-nfs,samba}/, workloads/, scripts/lib/, analysis/, results/)
    - .gitignore excludes results/, .env, *.pyc, __pycache__/
    - .env.example has all 7 sections with LocalStack/Postgres defaults
    - common.sh exports log_info, log_warn, log_error, die, timer_start, timer_stop, detect_os, require_docker_compose_v2, wait_healthy
    - Empty directories have .gitkeep files
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Dockerfile.dittofs, check-prerequisites.sh, clean-all.sh, and Makefile</name>
  <files>
    bench/docker/Dockerfile.dittofs
    bench/scripts/check-prerequisites.sh
    bench/scripts/clean-all.sh
    bench/Makefile
  </files>
  <action>
**bench/docker/Dockerfile.dittofs** — Adapt from `test/smb-conformance/Dockerfile.dittofs`:
- Multi-stage build: `golang:1.25-alpine` builder, `alpine:3.21` runtime
- Build both `dfs` and `dfsctl` binaries (same pattern as smb-conformance)
- Runtime: `apk add --no-cache ca-certificates tzdata curl`
- Non-root user 65532:65532 (`dittofs` user/group)
- Create directories: `/data/metadata`, `/data/content`, `/data/cache`, `/config`
- EXPOSE ports: `12049/tcp 8080/tcp 6060/tcp` (NFS, API, pprof — different from smb-conformance which exposes 12445)
- HEALTHCHECK: `wget --no-verbose --tries=1 --spider http://localhost:8080/health/ready || exit 1` (interval=2s, timeout=5s, start-period=5s, retries=15)
- ENTRYPOINT: `["/app/dfs"]`
- CMD: `["start", "--foreground", "--config", "/config/config.yaml"]`
- Update labels for benchmark context (title="DittoFS (Benchmark)", description mentions benchmarking)

**bench/scripts/check-prerequisites.sh** — executable, sources lib/common.sh:
- `#!/usr/bin/env bash` + `set -euo pipefail`
- Source `lib/common.sh` using `SCRIPT_DIR` detection
- `MISSING=0` counter
- `check_required()` function: takes cmd name + install hint, increments MISSING if not found
- `check_optional()` function: takes cmd name + purpose, warns if not found
- Required tools: `docker`, `fio`, `jq`, `bc`, `make`, `curl`
- Optional tools: `python3` (for analysis pipeline, Phase 37), `smbclient` (for SMB benchmarks), `showmount` (for NFS mount verification)
- Special check: Docker Compose v2 via `docker compose version`
- Special check: Docker daemon running via `docker info`
- Print summary: total required, missing count
- `exit "$MISSING"` (0 = all good, >0 = missing tools)
- Must pass ShellCheck

**bench/scripts/clean-all.sh** — executable, sources lib/common.sh:
- `#!/usr/bin/env bash` + `set -euo pipefail`
- Source `lib/common.sh`
- Accepts `--force` flag to skip confirmation prompt
- Steps:
  1. Unmount any NFS/SMB mounts under `/mnt/bench*` or `/tmp/bench*` (detect OS, use `umount` or `umount -f`)
  2. Stop all bench Docker Compose profiles: `docker compose --profile '*' down -v --remove-orphans`
  3. Remove dangling bench volumes: `docker volume ls -q --filter name=bench | xargs docker volume rm` (if any)
  4. Optionally prune Docker build cache: only with `--force`
- Log each step with log_info
- Handle errors gracefully (continue even if unmount fails — mount may not exist)
- Must pass ShellCheck

**bench/Makefile** — mirrors smb-conformance Makefile pattern:
- `.DEFAULT_GOAL := help`
- `PROFILE ?= dittofs-badger-s3` (default profile)
- `COMPOSE := docker compose -f docker-compose.yml`
- Targets:
  - `help` — self-documenting with grep/awk (same pattern as smb-conformance)
  - `check` — runs `./scripts/check-prerequisites.sh`
  - `build` — builds DittoFS image: `$(COMPOSE) --profile $(PROFILE) build`
  - `up` — starts profile: `$(COMPOSE) --profile $(PROFILE) up -d`
  - `down` — stops profile: `$(COMPOSE) --profile $(PROFILE) down -v`
  - `logs` — follows logs: `$(COMPOSE) --profile $(PROFILE) logs -f`
  - `ps` — shows status: `$(COMPOSE) --profile $(PROFILE) ps`
  - `clean` — runs `./scripts/clean-all.sh --force`
  - `bootstrap` — runs bootstrap (placeholder: `@echo "Run: docker compose exec dittofs-$(PROFILE) /app/bootstrap.sh $(PROFILE)"`)
- All .PHONY declared
  </action>
  <verify>
    <automated>
test -f bench/docker/Dockerfile.dittofs && test -x bench/scripts/check-prerequisites.sh && test -x bench/scripts/clean-all.sh && test -f bench/Makefile && grep -q "ENTRYPOINT" bench/docker/Dockerfile.dittofs && grep -q "check_required" bench/scripts/check-prerequisites.sh && grep -q "docker compose" bench/scripts/clean-all.sh && grep -q "help:" bench/Makefile && echo "PASS: All files exist with expected content" || echo "FAIL"
    </automated>
  </verify>
  <done>
    - Dockerfile.dittofs builds dfs+dfsctl, exposes 12049/8080/6060, healthcheck on :8080/health/ready
    - check-prerequisites.sh validates docker, fio, jq, bc, make, curl, docker compose v2; reports missing with install hints; exits with count of missing tools
    - clean-all.sh unmounts, stops containers, removes volumes, optionally prunes; handles missing mounts gracefully
    - Makefile has help, check, build, up, down, logs, ps, clean, bootstrap targets
    - All scripts use set -euo pipefail and source common.sh
  </done>
</task>

</tasks>

<verification>
1. Run `ls -R bench/` and verify complete directory structure matches the plan
2. Verify `bench/.gitignore` contains `results/`, `.env`, `*.pyc`, `__pycache__/`
3. Verify `bench/.env.example` has all 7 sections with correct defaults
4. Verify `bench/scripts/lib/common.sh` defines all required functions
5. Verify `bench/docker/Dockerfile.dittofs` has multi-stage build, non-root user, healthcheck
6. Verify `bench/scripts/check-prerequisites.sh` checks all required tools
7. Verify `bench/scripts/clean-all.sh` handles unmount + docker cleanup
8. Verify `bench/Makefile` has help target with self-documenting pattern
9. Run ShellCheck on all .sh files if available: `shellcheck bench/scripts/*.sh bench/scripts/lib/*.sh`
</verification>

<success_criteria>
- bench/ directory tree is complete with all subdirectories
- All 7 files are created and properly formatted
- Scripts are executable and ShellCheck-clean
- .env.example works as-is with LocalStack defaults (copy to .env, no edits needed)
- Makefile help target lists all available commands
- Dockerfile.dittofs follows same pattern as test/smb-conformance/Dockerfile.dittofs
</success_criteria>

<output>
After completion, create `.planning/phases/33-benchmark-infrastructure/33-01-SUMMARY.md`
</output>
