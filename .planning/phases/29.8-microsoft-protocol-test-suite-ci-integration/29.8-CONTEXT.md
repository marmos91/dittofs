# Phase 29.8: Microsoft Protocol Test Suite CI Integration - Context

**Gathered:** 2026-02-26
**Status:** Ready for planning

<domain>
## Phase Boundary

Integrate Microsoft WindowsProtocolTestSuites (WPTS) FileServer test suite into CI, running MS-SMB2 BVT tests against DittoFS. Delivers: Docker Compose setup, DittoFS bootstrap, test runner script, known failures tracking, GitHub Actions workflow. Does NOT implement SMB3 features, fix SMB bugs, or extend WPTS beyond BVT category.

</domain>

<decisions>
## Implementation Decisions

### Docker Orchestration
- **Dual mode**: Docker Compose for self-contained local runs (macOS/Windows), plus local mode where DittoFS runs natively and only WPTS is containerized (Linux/CI)
- **Reuse existing Dockerfile** (`Dockerfile` at repo root) for DittoFS container — multi-stage Alpine build already production-ready
- **Include dfsctl** in the DittoFS Docker image (build both binaries in multi-stage build) for bootstrap
- **Full POSIX matrix profiles**: memory/memory, memory/filesystem, badger/filesystem, memory/s3, badger/s3 — matching existing E2E store matrix
- **Localstack as Compose service** with health check for S3 profiles. PostgreSQL as Compose service for postgres profiles
- **Docker Compose V2 format** (no `version:` key)
- **Service name networking** in Compose (WPTS connects to `dittofs:port`), host IP in local mode
- **--keep flag** to leave containers running after tests for debugging
- **Script builds and starts DittoFS** in local mode (go build, start in background, wait for health, run WPTS, cleanup)
- **Minimal observability**: No Prometheus/Grafana. Logs to stdout/stderr. DittoFS debug logs always captured
- **Bash script + Makefile convenience targets**: run.sh does the real work, Makefile wraps common invocations
- **--dry-run mode**: Shows containers, config, WPTS categories, ptfconfig values without running
- **Docker volumes** for BadgerDB data directories (not tmpfs)
- **WPTS image from MCR**: Pull `mcr.microsoft.com/windowsprotocoltestsuites:fileserver` directly, pinned to specific tag

### DittoFS Bootstrap
- **Match WPTS share names**: Create shares named exactly as WPTS expects (SMBBasic, SMBEncrypted, etc.)
- **SMBEncrypted share created** even though encryption isn't implemented (SMB3 = phase 39). Expect test failures, document in KNOWN_FAILURES.md. Infrastructure ready for future phases
- **Hardcoded test credentials**: Fixed username/password in bootstrap and ptfconfig. Deterministic, only used in test containers
- **Default admin + DITTOFS_CONTROLPLANE_SECRET env var**: DittoFS creates admin on first start. Bootstrap logs in as admin, creates WPTS test users
- **WPTS-compatible settings**: signing=enabled (not required), debug logging. Configured via DittoFS config.yaml
- **Same shares/users across all profiles**: Only metadata/payload store types differ per profile
- **30-second health timeout**: Poll /health/ready every 1s, fail fast if server won't start
- **Standalone bootstrap script**: Separate from Docker entrypoint. Runs after DittoFS is healthy. Works in both Compose and local mode

### Test Result Handling
- **Summary table with all test names**: List every test with pass/fail/skip status. Color-coded: RED for new failures, YELLOW for known failures, GREEN for passes
- **KNOWN_FAILURES.md**: Markdown file listing test names, failure reason, and linked GitHub issue. Script compares results against this list
- **Exit 0 when only known failures**: CI passes (green) as long as no NEW unexpected failures appear
- **Timestamped results directory**: `results/YYYY-MM-DD_HHMMSS/` with NUnit XML, DittoFS logs, summary. Gitignored
- **DittoFS logs always captured**: Copied to results directory regardless of pass/fail
- **GitHub Actions artifacts**: Upload full results directory (XML + logs + summary)
- **NUnit XML parsing**: Parse WPTS output to generate terminal summary table
- **Full BVT by default**: Run all BVT tests unless --filter or --category passed

### CI Trigger Scope
- **Separate workflow file**: `.github/workflows/smb-conformance.yml`
- **Path-scoped PR triggers**: `pkg/adapter/smb/**`, `internal/adapter/smb/**`, `test/smb-conformance/**`, `pkg/adapter/base.go`, `.github/workflows/smb-conformance.yml`
- **Tiered profiles**: memory/memory in PR checks, full matrix on push to develop
- **Weekly cron**: Full matrix run against develop for regression detection
- **30-minute timeout**
- **ubuntu-latest runner**
- **Docker Compose mode in CI**: docker compose up, self-contained and reproducible
- **cancel-in-progress concurrency**: New push cancels running suite for same PR
- **GH Actions Docker layer cache**: Using actions/cache or docker/build-push-action cache
- **PR comment on failure only**: Post summary table when new failures detected
- **Auto-create GH issue on regression**: Weekly run creates issue when new failures not in KNOWN_FAILURES.md

### Code Structure & Documentation
- **Location**: `test/smb-conformance/` (parallel to test/e2e/ and test/posix/)
- **Documentation**: README.md (setup, running locally, dev guide for iterating on failures) + KNOWN_FAILURES.md
- **ptfconfig template**: `ptfconfig.template` with `${DITTOFS_HOST}`, `${SMB_PORT}`, etc. Bootstrap generates final ptfconfig
- **Static config files per profile**: `configs/memory.yaml`, `configs/badger-fs.yaml`, etc. Script selects by --profile flag
- **--profile flag with PROFILE env fallback**: `--profile memory|badger-fs|badger-s3|postgres-s3`. Default: memory
- **WPTS image pinned to specific tag**: Reproducible builds, explicit version bumps
- **Phase 44 updated**: Add note that SMB3 conformance testing extends this infrastructure

### Claude's Discretion
- SMB port selection (12445 vs 445) within container network
- Bootstrap script placement (standalone vs entrypoint wrapper) — user said "whatever is cleaner"
- Exact Makefile target names and flags
- NUnit XML parsing approach (bash/awk vs lightweight tool)
- Docker Compose service names and network configuration details

</decisions>

<specifics>
## Specific Ideas

- Reuse the existing production `Dockerfile` at repo root rather than creating a new one
- Match the full POSIX test matrix (5 store combinations) for backend profiles
- "We should apply the same identical rules to NFS posix tests" — captured as #207 for future work
- WPTS expects specific share names — create shares matching WPTS expectations directly rather than mapping via ptfconfig
- SMBEncrypted share should be created even without encryption support — infrastructure forward-compatible with phase 39

</specifics>

<deferred>
## Deferred Ideas

- **Makefile targets for all test suites** (e2e, posix, smb-conformance) — captured as GitHub issue #206
- **NFS E2E/POSIX CI optimization** (scoped triggers + tiered matrix matching this pattern) — captured as GitHub issue #207
- **SMB3 encryption support** — Phase 39 (SMB3 Security & Encryption)
- **SMB3 conformance testing** — Phase 44 (extends this infrastructure)

</deferred>

---

*Phase: 29.8-microsoft-protocol-test-suite-ci-integration*
*Context gathered: 2026-02-26*
