---
phase: 29-core-layer-decomposition
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/payload/errors.go
  - pkg/adapter/errors.go
  - pkg/controlplane/store/helpers.go
  - pkg/controlplane/store/gorm.go
  - pkg/controlplane/store/users.go
  - pkg/controlplane/store/groups.go
  - pkg/controlplane/store/shares.go
  - pkg/controlplane/store/permissions.go
  - pkg/controlplane/store/adapters.go
  - pkg/controlplane/store/metadata_stores.go
  - pkg/controlplane/store/payload_stores.go
  - pkg/controlplane/store/settings.go
  - pkg/controlplane/store/health.go
  - pkg/controlplane/store/identity_mappings.go
  - pkg/controlplane/store/netgroups.go
  - pkg/apiclient/helpers.go
autonomous: true
requirements:
  - REF-06.1
  - REF-06.2
  - REF-06.3
  - REF-06.5
must_haves:
  truths:
    - "PayloadError wraps sentinel errors with structured debugging context and errors.Is() works"
    - "ProtocolError interface allows NFS and SMB to implement protocol-specific error types"
    - "Generic GORM helpers reduce CRUD boilerplate in controlplane store methods"
    - "Generic API client helpers reduce HTTP boilerplate in apiclient methods"
  artifacts:
    - path: "pkg/payload/errors.go"
      provides: "PayloadError structured type with Op, Share, PayloadID, BlockIdx, Size, Duration, Retries, Backend, Err fields"
      contains: "PayloadError"
    - path: "pkg/adapter/errors.go"
      provides: "ProtocolError interface with Code(), Message(), Unwrap()"
      contains: "ProtocolError"
    - path: "pkg/controlplane/store/helpers.go"
      provides: "Generic GORM helpers: getByField[T], listAll[T], createWithID[T]"
      contains: "getByField"
    - path: "pkg/apiclient/helpers.go"
      provides: "Generic API client helpers: getResource[T], listResources[T]"
      contains: "getResource"
  key_links:
    - from: "pkg/payload/errors.go"
      to: "existing sentinel errors"
      via: "PayloadError.Unwrap() returns wrapped sentinel"
      pattern: "func.*Unwrap.*error"
    - from: "pkg/controlplane/store/users.go"
      to: "pkg/controlplane/store/helpers.go"
      via: "store methods call generic helpers"
      pattern: "getByField|listAll|createWithID"
---

<objective>
Create foundational error types and generic helpers that all subsequent plans depend on.

Purpose: These are zero-dependency additions that form the leaf layer of the decomposition. Error types provide structured debugging context for payload operations and protocol-level error translation. Generic helpers eliminate CRUD boilerplate in both the GORM store and API client packages.

Output: PayloadError type, ProtocolError interface, GORM generic helpers, API client generic helpers. All existing store methods refactored to use generic helpers where applicable.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-core-layer-decomposition/29-CONTEXT.md
@.planning/phases/29-core-layer-decomposition/29-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs -->

From pkg/payload/errors.go (existing sentinel errors to wrap):
```go
var (
    ErrContentNotFound    = errors.New("content not found")
    ErrBlockNotFound      = errors.New("block not found")
    ErrPayloadIDRequired  = errors.New("payload ID required")
    // ... ~12 sentinel errors total
)
```

From pkg/adapter/adapter.go (existing adapter interface):
```go
type ProtocolAdapter interface {
    Protocol() string
    Port() int
    Serve(ctx context.Context) error
    Stop(ctx context.Context) error
    SetRuntime(runtime adapter.Runtime)
}
```

From pkg/controlplane/store/gorm.go (existing GORMStore):
```go
type GORMStore struct {
    db *gorm.DB
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PayloadError and ProtocolError types</name>
  <files>
    pkg/payload/errors.go
    pkg/adapter/errors.go
  </files>
  <action>
**PayloadError** — Update `pkg/payload/errors.go`:
1. Add `PayloadError` struct with fields: `Op string` (upload/download/dedup/gc), `Share string`, `PayloadID string`, `BlockIdx uint32`, `Size int64`, `Duration time.Duration`, `Retries int`, `Backend string` (s3/memory/filesystem), `Err error` (wrapped sentinel).
2. Implement `Error() string` with format: `payload {Op}: {Err} (share={Share}, payload={PayloadID}, block={BlockIdx}, backend={Backend}): {Err}`
3. Implement `Unwrap() error` returning `e.Err` so `errors.Is(payloadErr, ErrContentNotFound)` works.
4. Add constructor `NewPayloadError(op, share, payloadID string, blockIdx uint32, backend string, err error) *PayloadError` for convenience.
5. Keep all existing sentinel errors unchanged — PayloadError wraps them, does not replace them.

**ProtocolError** — Create `pkg/adapter/errors.go`:
1. Define `ProtocolError` interface: `error` + `Code() uint32` + `Message() string` + `Unwrap() error`.
2. Add `MapError(err error) ProtocolError` to the `ProtocolAdapter` interface definition in `adapter.go`. This forces every adapter to implement error translation. Note: do NOT add implementations yet (NFS/SMB will implement in later phases) — add the method to the interface and implement stub returns (`return nil`) in both existing adapters so they compile.
3. Add doc comment explaining the ProtocolError contract: "ProtocolError represents a protocol-specific error with a numeric status code. Each protocol adapter implements MapError to translate domain errors into wire-format error codes."

Do NOT add ProtocolError implementations for NFS or SMB in this task — just the interface and adapter stub.
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build ./pkg/payload/... && go build ./pkg/adapter/... && go test ./pkg/payload/... -count=1 -run TestPayload 2>&1 | head -50</automated>
  </verify>
  <done>PayloadError struct exists with Unwrap() support; ProtocolError interface defined in pkg/adapter/errors.go; MapError added to ProtocolAdapter interface; both NFS and SMB adapters compile with stub MapError implementations; errors.Is() works through PayloadError wrapping.</done>
</task>

<task type="auto">
  <name>Task 2: Create generic GORM helpers and refactor store methods</name>
  <files>
    pkg/controlplane/store/helpers.go
    pkg/controlplane/store/users.go
    pkg/controlplane/store/groups.go
    pkg/controlplane/store/shares.go
    pkg/controlplane/store/permissions.go
    pkg/controlplane/store/adapters.go
    pkg/controlplane/store/metadata_stores.go
    pkg/controlplane/store/payload_stores.go
    pkg/controlplane/store/settings.go
    pkg/controlplane/store/health.go
    pkg/controlplane/store/identity_mappings.go
    pkg/controlplane/store/netgroups.go
  </files>
  <action>
**Create generic helpers** — New file `pkg/controlplane/store/helpers.go`:
1. `func getByField[T any](db *gorm.DB, ctx context.Context, field string, value any, notFoundErr error, preloads ...string) (*T, error)` — executes `db.WithContext(ctx).Where(field+" = ?", value).First(&result)`, applies preloads, converts gorm.ErrRecordNotFound to the provided notFoundErr.
2. `func listAll[T any](db *gorm.DB, ctx context.Context, preloads ...string) ([]*T, error)` — executes `db.WithContext(ctx).Find(&results)`, applies preloads.
3. `func createWithID[T any](db *gorm.DB, ctx context.Context, entity *T, idSetter func(*T, string), dupErr error) (string, error)` — generates UUID via `uuid.New().String()`, calls idSetter, handles unique constraint violation by returning dupErr.
4. `func deleteByField[T any](db *gorm.DB, ctx context.Context, field string, value any, notFoundErr error) error` — deletes with WHERE clause, returns notFoundErr if no rows affected.
5. Add `convertNotFoundError(err, notFoundErr error) error` private helper to wrap gorm.ErrRecordNotFound.
6. Each helper must be unexported (lowercase) since they are internal to the store package.

**Refactor store methods** — For each store file, identify repetitive get/list/create/delete patterns and replace with generic helper calls where the pattern matches cleanly. Focus on the clearly repetitive patterns (e.g., GetUser, GetUserByID, ListUsers, CreateUser follow the same pattern as GetGroup, GetGroupByID, ListGroups, CreateGroup). Do not force-fit methods with complex custom logic (e.g., ValidateCredentials, ResolveSharePermission) into generic helpers.

**API client helpers** — New file `pkg/apiclient/helpers.go`:
1. `func getResource[T any](c *Client, ctx context.Context, path string) (*T, error)` — GET request, JSON decode to T.
2. `func listResources[T any](c *Client, ctx context.Context, path string) ([]*T, error)` — GET request, JSON decode to slice of T.
3. `func createResource[T any](c *Client, ctx context.Context, path string, body any) (*T, error)` — POST request with JSON body, decode response to T.
4. `func deleteResource(c *Client, ctx context.Context, path string) error` — DELETE request.
5. Refactor existing API client files to use these helpers where patterns match cleanly.

All helpers must be well-documented with Godoc comments explaining purpose, parameters, and error behavior.
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build ./pkg/controlplane/store/... && go build ./pkg/apiclient/... && go vet ./pkg/controlplane/store/... && go vet ./pkg/apiclient/... && go test ./pkg/controlplane/store/... -count=1 2>&1 | tail -10</automated>
  </verify>
  <done>Generic GORM helpers exist in helpers.go and are used by at least 3 store files; generic API client helpers exist in apiclient/helpers.go and are used by at least 3 client files; all existing tests pass; go vet clean.</done>
</task>

</tasks>

<verification>
```bash
# All packages compile
cd /Users/marmos91/Projects/dittofs && go build ./...

# All tests pass
go test ./pkg/payload/... ./pkg/adapter/... ./pkg/controlplane/store/... ./pkg/apiclient/... -count=1

# No vet issues
go vet ./...
```
</verification>

<success_criteria>
- PayloadError wraps sentinels and errors.Is() works correctly
- ProtocolError interface defined, adapters compile with MapError stub
- Generic GORM helpers reduce repetitive CRUD patterns in store package
- Generic API client helpers reduce HTTP boilerplate in apiclient package
- All existing tests pass unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/29-core-layer-decomposition/29-01-SUMMARY.md`
</output>
