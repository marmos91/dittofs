---
phase: 29-core-layer-decomposition
plan: 06
type: execute
wave: 3
depends_on:
  - 29-04
  - 29-05
files_modified:
  - pkg/controlplane/runtime/adapters/service.go
  - pkg/controlplane/runtime/shares/service.go
  - pkg/controlplane/runtime/stores/service.go
  - pkg/controlplane/runtime/mounts/service.go
  - pkg/controlplane/runtime/lifecycle/service.go
  - pkg/controlplane/runtime/identity/service.go
  - pkg/controlplane/runtime/runtime.go
  - pkg/controlplane/runtime/init.go
  - pkg/controlplane/runtime/mounts.go
  - pkg/controlplane/runtime/share.go
autonomous: true
requirements:
  - REF-05.3
  - REF-05.4
must_haves:
  truths:
    - "AdapterManager extracted from Runtime into pkg/controlplane/runtime/adapters/ (~350 lines)"
    - "MetadataStoreManager extracted into pkg/controlplane/runtime/stores/ (~70 lines)"
    - "Runtime reduced to ~500 lines composing 6 sub-services"
    - "Each sub-service has its own Service type and interface in its own sub-package"
    - "All existing tests pass after decomposition"
  artifacts:
    - path: "pkg/controlplane/runtime/adapters/service.go"
      provides: "AdapterManager: CreateAdapter, DeleteAdapter, StartAdapter, StopAdapter, etc."
      contains: "type Service struct"
    - path: "pkg/controlplane/runtime/stores/service.go"
      provides: "MetadataStoreManager: RegisterMetadataStore, GetMetadataStore, etc."
      contains: "type Service struct"
    - path: "pkg/controlplane/runtime/shares/service.go"
      provides: "ShareManager: AddShare, RemoveShare, GetShare, etc."
      contains: "type Service struct"
    - path: "pkg/controlplane/runtime/mounts/service.go"
      provides: "MountManager: RecordMount, RemoveMount, ListMounts, etc."
      contains: "type Service struct"
    - path: "pkg/controlplane/runtime/lifecycle/service.go"
      provides: "Lifecycle: Serve, shutdown, SetShutdownTimeout"
      contains: "type Service struct"
    - path: "pkg/controlplane/runtime/identity/service.go"
      provides: "IdentityMapper: ApplyIdentityMapping"
      contains: "type Service struct"
    - path: "pkg/controlplane/runtime/runtime.go"
      provides: "Runtime composing all sub-services (~500 lines)"
      contains: "adapters.*adapters\\.Service"
  key_links:
    - from: "pkg/controlplane/runtime/runtime.go"
      to: "pkg/controlplane/runtime/adapters/"
      via: "Runtime holds reference to adapters.Service"
      pattern: "adapters\\.Service"
    - from: "pkg/controlplane/runtime/runtime.go"
      to: "pkg/controlplane/runtime/stores/"
      via: "Runtime holds reference to stores.Service"
      pattern: "stores\\.Service"
---

<objective>
Decompose the 1203-line Runtime into 6 focused sub-services, each in its own sub-package with its own interface.

Purpose: The Runtime is a god object managing adapter lifecycle, share configuration, metadata store registration, mount tracking, server lifecycle, and identity mapping. Extracting each concern into its own sub-service makes each independently testable and navigable. The Runtime becomes a thin composition layer (~500 lines).

Output: 6 new sub-packages under pkg/controlplane/runtime/, reduced runtime.go, all existing functionality preserved.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-core-layer-decomposition/29-CONTEXT.md
@.planning/phases/29-core-layer-decomposition/29-RESEARCH.md
@.planning/phases/29-core-layer-decomposition/29-04-SUMMARY.md

<interfaces>
<!-- Runtime decomposition method mapping from research -->

adapters/ (~350 lines):
  CreateAdapter, DeleteAdapter, UpdateAdapter, EnableAdapter, DisableAdapter,
  startAdapter, stopAdapter, StopAllAdapters, LoadAdaptersFromStore,
  ListRunningAdapters, IsAdapterRunning, AddAdapter, registerAndRunAdapterLocked,
  SetAdapterFactory

stores/ (~70 lines):
  RegisterMetadataStore, GetMetadataStore, GetMetadataStoreForShare,
  ListMetadataStores, CountMetadataStores, CloseMetadataStores

shares/ (~200 lines):
  AddShare, RemoveShare, UpdateShare, GetShare, GetRootHandle, ListShares,
  ShareExists, OnShareChange, notifyShareChange, GetShareNameForHandle,
  CountShares

mounts/ (~50 lines):
  Mounts, RecordMount, RemoveMount, RemoveAllMounts, ListMounts

lifecycle/ (~100 lines):
  Serve, serve, shutdown, SetShutdownTimeout, SetAPIServer

identity/ (~70 lines):
  ApplyIdentityMapping, applyAnonymousIdentity, applyRootIdentity

Remaining in runtime.go (~500 lines):
  Runtime struct, New(), Store(), GetMetadataService(), GetPayloadService(),
  SetPayloadService(), SetCacheConfig(), GetCacheConfig(), SetCache(), GetCache(),
  GetUserStore(), GetIdentityStore(), GetBlockService(), GetSettingsWatcher(),
  GetNFSSettings(), GetSMBSettings(), SetAdapterProvider(), GetAdapterProvider(),
  SetNFSClientProvider(), NFSClientProvider()
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract adapters, stores, and shares sub-services</name>
  <files>
    pkg/controlplane/runtime/adapters/service.go
    pkg/controlplane/runtime/stores/service.go
    pkg/controlplane/runtime/shares/service.go
    pkg/controlplane/runtime/runtime.go
  </files>
  <action>
1. Create sub-package directories: `adapters/`, `stores/`, `shares/` under `pkg/controlplane/runtime/`.

2. **adapters/service.go** (~350 lines):
   - Define `Service` interface with exported adapter management methods.
   - Define `ServiceImpl` struct holding: adapter registry (map), adapter factory, ControlPlane store (as `store.AdapterStore` sub-interface), mutex for thread safety, error channel for adapter failures.
   - Move all adapter management methods from runtime.go: CreateAdapter, DeleteAdapter, UpdateAdapter, EnableAdapter, DisableAdapter, startAdapter, stopAdapter, StopAllAdapters, LoadAdaptersFromStore, ListRunningAdapters, IsAdapterRunning, AddAdapter, registerAndRunAdapterLocked, SetAdapterFactory.
   - Constructor: `New(store store.AdapterStore, ...) *ServiceImpl`.
   - The sub-package must NOT import the parent `runtime` package. Define any needed types locally or accept via interfaces.
   - Settings fold into adapters: per-adapter settings access (GetNFSSettings, GetSMBSettings) can stay in adapters or remain in Runtime.

3. **stores/service.go** (~70 lines):
   - Define `Service` interface for metadata store management.
   - Move: RegisterMetadataStore, GetMetadataStore, GetMetadataStoreForShare, ListMetadataStores, CountMetadataStores, CloseMetadataStores.
   - Struct holds: metadata store registry (map[string]MetadataStore), mutex.
   - Constructor: `New() *ServiceImpl`.

4. **shares/service.go** (~200 lines):
   - Define `Service` interface for share management.
   - Move: AddShare, RemoveShare, UpdateShare, GetShare, GetRootHandle, ListShares, ShareExists, OnShareChange, notifyShareChange, GetShareNameForHandle, CountShares.
   - Struct holds: share registry (map), change callbacks, mutex.
   - Constructor: `New() *ServiceImpl`.
   - The `Share` type (currently in `share.go`) can stay in the parent package or move here. If it stays in parent, shares/ sub-package uses it via interface or the parent imports it from a shared location. Evaluate and pick the approach that avoids import cycles.

5. **Update runtime.go**:
   - Runtime struct now holds `*adapters.ServiceImpl`, `*stores.ServiceImpl`, `*shares.ServiceImpl`.
   - Constructor creates sub-services and injects dependencies.
   - Delegation methods: Runtime's public methods that previously had inline logic now delegate to sub-services. For frequently called methods, keep thin forwarding wrappers (e.g., `func (r *Runtime) GetShare(name string) (*Share, error) { return r.shares.GetShare(name) }`).
   - Remove all adapter/store/share method bodies from runtime.go — only forwarding remains.

6. Add `doc.go` to each sub-package.
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build ./pkg/controlplane/runtime/... && go build ./...</automated>
  </verify>
  <done>Three sub-services extracted (adapters, stores, shares); Runtime holds references to all three; all forwarding methods work; go build ./... succeeds.</done>
</task>

<task type="auto">
  <name>Task 2: Extract mounts, lifecycle, identity sub-services + finalize Runtime</name>
  <files>
    pkg/controlplane/runtime/mounts/service.go
    pkg/controlplane/runtime/lifecycle/service.go
    pkg/controlplane/runtime/identity/service.go
    pkg/controlplane/runtime/runtime.go
    pkg/controlplane/runtime/init.go
    pkg/controlplane/runtime/mounts.go
    pkg/controlplane/runtime/share.go
  </files>
  <action>
1. **mounts/service.go** (~50 lines):
   - Define `Service` interface for mount tracking.
   - Move: Mounts (accessor), RecordMount, RemoveMount, RemoveAllMounts, ListMounts.
   - Struct holds: mount records (map or sync.Map), mutex.
   - Constructor: `New() *ServiceImpl`.
   - The existing `mounts.go` content in the parent is absorbed into this sub-package. Delete `mounts.go` from parent after extraction.

2. **lifecycle/service.go** (~100 lines):
   - Define `Service` interface for server lifecycle.
   - Move: Serve, serve (private), shutdown (private), SetShutdownTimeout, SetAPIServer.
   - Struct holds: shutdown timeout, API server reference, context.
   - Constructor: `New(shutdownTimeout time.Duration) *ServiceImpl`.
   - The `Serve` method needs to start adapters and API server — it receives these as dependencies (via interfaces or callbacks) rather than importing sibling sub-packages.

3. **identity/service.go** (~70 lines):
   - Define `Service` interface for identity mapping.
   - Move: ApplyIdentityMapping, applyAnonymousIdentity, applyRootIdentity.
   - Struct holds: identity store reference, settings watcher reference.
   - Constructor: `New(identityStore store.IdentityMappingStore, ...) *ServiceImpl`.

4. **Finalize runtime.go**:
   - Runtime struct now composes all 6 sub-services:
     ```go
     type Runtime struct {
         adapters  *adapters.ServiceImpl
         shares    *shares.ServiceImpl
         stores    *stores.ServiceImpl
         mounts    *mounts.ServiceImpl
         lifecycle *lifecycle.ServiceImpl
         identity  *identity.ServiceImpl

         // Cross-cutting dependencies
         store           store.Store
         metadataService *metadata.MetadataService
         payloadService  *payload.PayloadService
         // ...
     }
     ```
   - Keep getters/setters for cross-cutting dependencies in runtime.go.
   - Update `init.go` to initialize all sub-services.
   - Delete absorbed files: `mounts.go` (content moved to mounts/ sub-package).
   - Keep `share.go` (the Share type definition) in the parent — it's a shared type used by multiple sub-packages.
   - Keep `settings_watcher.go` and `netgroups.go` in the parent — they can be extracted in future if needed.
   - Verify runtime.go is now ~500 lines or less.

5. **Update runtime tests**:
   - `runtime_test.go` tests should still pass. If tests create a Runtime and call methods, the forwarding wrappers handle delegation.
   - Add sub-service specific tests in each sub-package if time permits.

6. Run full test suite to verify no regressions.
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build ./... && go test ./pkg/controlplane/runtime/... -count=1 2>&1 | tail -20</automated>
  </verify>
  <done>All 6 sub-services extracted; Runtime is ~500 lines; mounts.go absorbed into mounts/ sub-package; all runtime tests pass; go build ./... succeeds; no import cycles.</done>
</task>

</tasks>

<verification>
```bash
# Full build succeeds
cd /Users/marmos91/Projects/dittofs && go build ./...

# All tests pass
go test ./pkg/controlplane/runtime/... -count=1

# Runtime size check
wc -l pkg/controlplane/runtime/runtime.go
# Should be ~500 lines or less

# Sub-packages exist
ls pkg/controlplane/runtime/adapters/ pkg/controlplane/runtime/stores/ pkg/controlplane/runtime/shares/ pkg/controlplane/runtime/mounts/ pkg/controlplane/runtime/lifecycle/ pkg/controlplane/runtime/identity/

# No vet issues
go vet ./...
```
</verification>

<success_criteria>
- 6 sub-services extracted into their own sub-packages
- Runtime reduced to ~500 lines of composition and cross-cutting accessors
- Each sub-service has its own Service type and interface
- No circular imports between sub-packages
- All existing tests pass
- go build ./... succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/29-core-layer-decomposition/29-06-SUMMARY.md`
</output>
