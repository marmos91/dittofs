---
phase: 29-core-layer-decomposition
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/payload/offloader/offloader.go
  - pkg/payload/offloader/upload.go
  - pkg/payload/offloader/download.go
  - pkg/payload/offloader/dedup.go
  - pkg/payload/offloader/queue.go
  - pkg/payload/offloader/entry.go
  - pkg/payload/offloader/types.go
  - pkg/payload/offloader/wal_replay.go
  - pkg/payload/offloader/offloader_test.go
  - pkg/payload/offloader/queue_test.go
  - pkg/payload/offloader/entry_test.go
  - pkg/payload/offloader/wal_replay_test.go
  - pkg/payload/gc/gc.go
  - pkg/payload/gc/gc_test.go
  - pkg/payload/gc/gc_integration_test.go
  - pkg/payload/service.go
  - pkg/payload/types.go
  - pkg/config/stores.go
autonomous: true
requirements:
  - REF-05.5
  - REF-05.6
  - REF-05.7
  - REF-05.8
must_haves:
  truths:
    - "TransferManager is renamed to Offloader everywhere"
    - "pkg/payload/transfer/ no longer exists, replaced by pkg/payload/offloader/"
    - "manager.go is split into offloader.go, upload.go, download.go, dedup.go"
    - "GC is extracted to standalone pkg/payload/gc/ package"
    - "All existing tests pass after rename and split"
  artifacts:
    - path: "pkg/payload/offloader/offloader.go"
      provides: "Offloader struct, constructor, Flush(), Close(), Start(), orchestration methods"
      contains: "type Offloader struct"
    - path: "pkg/payload/offloader/upload.go"
      provides: "Upload orchestration methods"
      contains: "func.*Offloader.*upload"
    - path: "pkg/payload/offloader/download.go"
      provides: "Download coordination methods"
      contains: "func.*Offloader.*download"
    - path: "pkg/payload/offloader/dedup.go"
      provides: "Dedup handler methods"
      contains: "handleUploadSuccess"
    - path: "pkg/payload/gc/gc.go"
      provides: "CollectGarbage standalone function"
      contains: "func CollectGarbage"
  key_links:
    - from: "pkg/payload/service.go"
      to: "pkg/payload/offloader/"
      via: "import path update from transfer to offloader"
      pattern: "payload/offloader"
    - from: "pkg/config/stores.go"
      to: "pkg/payload/offloader/"
      via: "creates Offloader instead of TransferManager"
      pattern: "offloader\\.New"
---

<objective>
Rename TransferManager to Offloader, move from pkg/payload/transfer/ to pkg/payload/offloader/, split manager.go into focused files, and extract GC to standalone package.

Purpose: The TransferManager is a 1361-line god object. Splitting it into focused files (upload, download, dedup, orchestration) makes each concern independently testable and navigable. Extracting GC to its own package removes coupling to the Offloader. The rename from "TransferManager" to "Offloader" better describes what it does (offloading cache to persistent storage).

Output: New pkg/payload/offloader/ directory with split files, new pkg/payload/gc/ package, old pkg/payload/transfer/ removed. All importers updated.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-core-layer-decomposition/29-CONTEXT.md
@.planning/phases/29-core-layer-decomposition/29-RESEARCH.md

<interfaces>
<!-- Key file split mapping from research -->

From pkg/payload/transfer/manager.go (1361 lines) → split into:

offloader.go (~200 lines): Offloader struct (renamed from TransferManager),
  New(), SetFinalizationCallback(), Flush(), flushSmallFileSync(),
  WaitForEagerUploads(), WaitForAllUploads(), canProcess(), Start(), Close(),
  HealthCheck(), GetFileSize(), Exists(), Truncate(), Delete()

upload.go (~450 lines): OnWriteComplete(), tryEagerUpload(),
  startBlockUpload(), uploadRemainingBlocks(), uploadBlock()

download.go (~300 lines): downloadBlock(), EnsureAvailable(),
  enqueueDownload(), enqueuePrefetch(), isBlockInCache(), isRangeInCache(),
  waitForDownloads()

dedup.go (~200 lines): handleUploadSuccess(), getOrCreateUploadState(),
  getUploadState(), getOrderedBlockHashes(), invokeFinalizationCallback(),
  DeleteWithRefCount()

queue.go (existing): TransferQueue — keep TransferQueue name (Transfer prefix describes the action)
entry.go (existing): TransferQueueEntry — keep name
types.go (existing): Config, FlushResult, TransferType, etc.
wal_replay.go (renamed from recovery.go): WAL recovery functions

From pkg/payload/transfer/gc.go → pkg/payload/gc/gc.go:
  CollectGarbage function (standalone, zero coupling to Offloader)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move transfer/ to offloader/, rename TransferManager to Offloader, split manager.go</name>
  <files>
    pkg/payload/offloader/offloader.go
    pkg/payload/offloader/upload.go
    pkg/payload/offloader/download.go
    pkg/payload/offloader/dedup.go
    pkg/payload/offloader/queue.go
    pkg/payload/offloader/entry.go
    pkg/payload/offloader/types.go
    pkg/payload/offloader/wal_replay.go
  </files>
  <action>
1. Create `pkg/payload/offloader/` directory.
2. Split `manager.go` into the files listed in the interfaces section above. The struct is renamed from `TransferManager` to `Offloader`. The package declaration is `package offloader`.
3. Move `queue.go` to `pkg/payload/offloader/queue.go` — keep `TransferQueue` name (Transfer describes the action, not the old package).
4. Move `entry.go` to `pkg/payload/offloader/entry.go` — keep `TransferQueueEntry` name.
5. Move `types.go` to `pkg/payload/offloader/types.go` — update any `TransferManager` references in type names or comments. Keep `TransferType`, `TransferRequest` names.
6. Move `recovery.go` to `pkg/payload/offloader/wal_replay.go` — rename as per CONTEXT.md decision.
7. All methods that were on `*TransferManager` now go on `*Offloader`.
8. The `New()` constructor returns `*Offloader` instead of `*TransferManager`.
9. Add `doc.go` with package documentation explaining the offloader's purpose: cache-to-store transfer orchestration.

**Critical**: Ensure the package name is `offloader` and the import path is `github.com/marmos91/dittofs/pkg/payload/offloader`.

**Do NOT delete `pkg/payload/transfer/` yet** — that happens after all importers are updated in Task 2.
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build ./pkg/payload/offloader/...</automated>
  </verify>
  <done>pkg/payload/offloader/ exists with split files; Offloader struct replaces TransferManager; package compiles independently; all methods from manager.go distributed across offloader.go, upload.go, download.go, dedup.go.</done>
</task>

<task type="auto">
  <name>Task 2: Extract GC, update all importers, remove old transfer/ package</name>
  <files>
    pkg/payload/gc/gc.go
    pkg/payload/gc/gc_test.go
    pkg/payload/gc/gc_integration_test.go
    pkg/payload/offloader/offloader_test.go
    pkg/payload/offloader/queue_test.go
    pkg/payload/offloader/entry_test.go
    pkg/payload/offloader/wal_replay_test.go
    pkg/payload/service.go
    pkg/payload/types.go
    pkg/config/stores.go
  </files>
  <action>
1. Create `pkg/payload/gc/` directory.
2. Move `gc.go` from `pkg/payload/transfer/gc.go` to `pkg/payload/gc/gc.go`. The `CollectGarbage` function is standalone — update package declaration to `package gc`. Adjust imports as needed.
3. Move `gc_test.go` and `gc_integration_test.go` to `pkg/payload/gc/`.
4. Move test files from `pkg/payload/transfer/` to `pkg/payload/offloader/`:
   - `manager_test.go` → `offloader_test.go` (rename test functions from `TestTransferManager_*` to `TestOffloader_*`)
   - `queue_test.go` → `queue_test.go`
   - `entry_test.go` → `entry_test.go`
   - `recovery_test.go` → `wal_replay_test.go`
5. Update `pkg/payload/service.go`: change import from `transfer` to `offloader`, update all `*transfer.TransferManager` references to `*offloader.Offloader`.
6. Update `pkg/payload/types.go`: change any type aliases referencing `transfer.` to `offloader.`.
7. Update `pkg/config/stores.go`: change `transfer.New(...)` to `offloader.New(...)` and update import.
8. Search entire codebase for remaining `"github.com/marmos91/dittofs/pkg/payload/transfer"` imports and update them all to `"github.com/marmos91/dittofs/pkg/payload/offloader"`. Also search for `TransferManager` type references in other packages and update to `Offloader`.
9. Delete `pkg/payload/transfer/` directory entirely.
10. Run `go build ./...` to verify no broken imports remain.
11. Add `doc.go` to `pkg/payload/gc/` with package documentation.
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build ./... && go test ./pkg/payload/... -count=1 2>&1 | tail -20</automated>
  </verify>
  <done>pkg/payload/transfer/ is fully removed; all imports point to pkg/payload/offloader/ and pkg/payload/gc/; all tests pass including GC tests; go build ./... succeeds with zero errors.</done>
</task>

</tasks>

<verification>
```bash
# Full build succeeds
cd /Users/marmos91/Projects/dittofs && go build ./...

# All payload tests pass
go test ./pkg/payload/... -count=1

# No references to old package
grep -r "payload/transfer" --include="*.go" . | grep -v "_test.go" | head -5
# Should return empty

# Old directory is gone
ls pkg/payload/transfer/ 2>&1
# Should show "No such file or directory"
```
</verification>

<success_criteria>
- TransferManager renamed to Offloader throughout codebase
- manager.go split into 4 focused files (offloader.go, upload.go, download.go, dedup.go)
- GC extracted to standalone pkg/payload/gc/ package
- All existing tests pass after rename and split
- No references to pkg/payload/transfer/ remain
- go build ./... succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/29-core-layer-decomposition/29-02-SUMMARY.md`
</output>
