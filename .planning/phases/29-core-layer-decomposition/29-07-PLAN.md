---
phase: 29-core-layer-decomposition
plan: 07
type: execute
wave: 4
depends_on:
  - 29-06
files_modified:
  - pkg/auth/auth.go
  - pkg/auth/identity.go
  - pkg/auth/kerberos/provider.go
  - pkg/adapter/adapter.go
  - pkg/adapter/nfs/adapter.go
  - pkg/adapter/smb/adapter.go
  - internal/controlplane/api/handlers/helpers.go
  - internal/controlplane/api/handlers/response.go
  - pkg/controlplane/api/router.go
  - docs/ARCHITECTURE.md
  - CLAUDE.md
autonomous: true
requirements:
  - REF-06.2
  - REF-06.4
must_haves:
  truths:
    - "pkg/auth/ has auth.go with Authenticator interface and identity.go with IdentityMapper interface"
    - "ProtocolAdapter interface includes IdentityMapper embedding for protocol-specific identity mapping"
    - "API error mapping centralized via middleware helpers"
    - "API handlers return structured responses without manual JSON encoding"
    - "ARCHITECTURE.md and CLAUDE.md updated to reflect new package structure"
  artifacts:
    - path: "pkg/auth/auth.go"
      provides: "DittoFS Authenticator interface, AuthResult, AuthProvider chain"
      contains: "type Authenticator interface"
    - path: "pkg/auth/identity.go"
      provides: "IdentityMapper interface, Identity model"
      contains: "type IdentityMapper interface"
    - path: "pkg/auth/kerberos/provider.go"
      provides: "Kerberos auth provider"
      contains: "type Provider struct"
    - path: "internal/controlplane/api/handlers/helpers.go"
      provides: "Centralized API error mapping and response helpers"
      contains: "WriteJSON|MapError"
  key_links:
    - from: "pkg/adapter/adapter.go"
      to: "pkg/auth/identity.go"
      via: "ProtocolAdapter embeds IdentityMapper"
      pattern: "auth\\.IdentityMapper"
    - from: "pkg/auth/kerberos/provider.go"
      to: "pkg/auth/auth.go"
      via: "Kerberos implements AuthProvider interface"
      pattern: "auth\\.AuthProvider"
---

<objective>
Centralize authentication abstractions in pkg/auth/, add IdentityMapper to adapter interface, centralize API error mapping, and update documentation to reflect all Phase 29 changes.

Purpose: Auth centralization creates a single home for all authentication abstractions (currently scattered across pkg/adapter/auth.go, pkg/auth/kerberos/, and various adapter-specific code). API error mapping centralization removes per-handler error translation boilerplate. Documentation update ensures ARCHITECTURE.md and CLAUDE.md reflect the new decomposed package structure.

Output: Expanded pkg/auth/ package, updated adapter interface, centralized API error helpers, updated documentation.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-core-layer-decomposition/29-CONTEXT.md
@.planning/phases/29-core-layer-decomposition/29-RESEARCH.md
@.planning/phases/29-core-layer-decomposition/29-06-SUMMARY.md

<interfaces>
<!-- Auth centralization from CONTEXT.md decisions -->

pkg/auth/auth.go:
- DittoFS Authenticator interface (authenticate a request)
- AuthResult (outcome of authentication)
- AuthProvider interface: CanHandle(token) bool + Authenticate()
- Provider chain: Authenticator chains providers

pkg/auth/identity.go:
- Identity model (generic: Unix creds, Kerberos principal, anonymous, NTLM session)
- IdentityMapper interface (shared for protocol-specific identity mapping)

pkg/auth/kerberos/:
- provider.go (renamed from kerberos.go)
- keytab.go (existing)
- config.go (existing)

Adapter interface changes:
- ProtocolAdapter embeds auth.IdentityMapper
- MapError(err error) ProtocolError method (added in Plan 01)

<!-- API error mapping from CONTEXT.md decisions -->

Unified Response: { Status int, Data any, Err error }
Error middleware: handlers return *Response, middleware handles JSON encoding
Centralized error mapping via middleware helpers
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Centralize auth abstractions and update adapter interface</name>
  <files>
    pkg/auth/auth.go
    pkg/auth/identity.go
    pkg/auth/kerberos/provider.go
    pkg/adapter/adapter.go
    pkg/adapter/auth.go
    pkg/adapter/nfs/adapter.go
    pkg/adapter/smb/adapter.go
  </files>
  <action>
1. **Create pkg/auth/auth.go** — define DittoFS authentication abstractions:
   - `AuthProvider` interface: `CanHandle(token []byte) bool`, `Authenticate(ctx context.Context, token []byte) (*AuthResult, error)`.
   - `AuthResult` struct: `Identity Identity`, `Authenticated bool`, `Provider string` (which provider handled it).
   - `Authenticator` struct: chains multiple AuthProvider implementations, tries each in order. Constructor `NewAuthenticator(providers ...AuthProvider)`.
   - `Authenticate(ctx context.Context, token []byte) (*AuthResult, error)` — iterates providers, returns first successful result.
   - Standard error types: `ErrAuthFailed`, `ErrUnsupportedMechanism`, `ErrInvalidCredentials`.

2. **Create pkg/auth/identity.go** — define identity model:
   - `Identity` struct: generic enough for all auth outcomes. Fields: `Username string`, `UID uint32`, `GID uint32`, `Groups []uint32`, `Principal string` (Kerberos), `SessionID string` (NTLM/SMB), `Anonymous bool`, `Attributes map[string]string` (extensible).
   - `IdentityMapper` interface: `MapIdentity(ctx context.Context, authResult *AuthResult) (*Identity, error)`. Each protocol adapter implements this to convert auth results into protocol-specific identity contexts.

3. **Rename pkg/auth/kerberos/kerberos.go to provider.go** — update the Kerberos implementation:
   - The existing Kerberos authenticator should implement the `AuthProvider` interface.
   - Rename the struct from `KerberosAuthenticator` to `Provider` (it's in the `kerberos` package, so `kerberos.Provider` is clear).
   - Implement `CanHandle(token) bool` — returns true if token is a Kerberos/SPNEGO token.
   - Implement `Authenticate(ctx, token) (*auth.AuthResult, error)` — wraps existing logic.

4. **Update pkg/adapter/adapter.go**:
   - The existing `pkg/adapter/auth.go` may already have some auth types. Consolidate: move DittoFS-level auth abstractions to `pkg/auth/`, keep adapter-specific auth concerns in `pkg/adapter/auth.go`.
   - Do NOT embed `auth.IdentityMapper` into `ProtocolAdapter` interface yet if it would break too many things — instead add a separate `IdentityMappingAdapter` interface that extends ProtocolAdapter with the mapping method. Adapters can implement both.
   - Alternatively, if the existing adapter interface already has auth-related methods, add `MapIdentity` as a method on the existing interface with stub implementations in NFS and SMB adapters.

5. **Update NFS and SMB adapter stubs** — add `MapIdentity` stub implementations returning nil/error if not yet fully implemented. These are placeholders for the actual NFS/SMB identity mapping logic.

6. **Preserve backward compatibility** — existing auth code in `pkg/adapter/auth.go` should delegate to the new `pkg/auth/` types where possible. Keep forwarding aliases if needed to avoid breaking changes.
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build ./pkg/auth/... && go build ./pkg/adapter/... && go build ./... && go test ./pkg/auth/... -count=1 2>&1 | tail -10</automated>
  </verify>
  <done>pkg/auth/ has auth.go with Authenticator/AuthProvider and identity.go with IdentityMapper/Identity; Kerberos provider implements AuthProvider; adapter interface updated with identity mapping capability; all adapters compile.</done>
</task>

<task type="auto">
  <name>Task 2: Centralize API error mapping and update documentation</name>
  <files>
    internal/controlplane/api/handlers/helpers.go
    internal/controlplane/api/handlers/response.go
    pkg/controlplane/api/router.go
    docs/ARCHITECTURE.md
    CLAUDE.md
  </files>
  <action>
**API Error Mapping Centralization:**

1. **Update `internal/controlplane/api/handlers/response.go`** — define unified response type:
   - `Response` struct: `Status int`, `Data any`, `Error string` (for JSON output).
   - `WriteJSON(w http.ResponseWriter, status int, data any)` — centralized JSON response writer.
   - `WriteError(w http.ResponseWriter, status int, msg string)` — centralized error response writer.

2. **Update `internal/controlplane/api/handlers/helpers.go`** — centralize error mapping:
   - `MapStoreError(err error) (int, string)` — maps store errors to HTTP status codes:
     - `ErrNotFound` → 404
     - `ErrAlreadyExists` → 409
     - `ErrInvalidInput` → 400
     - `ErrUnauthorized` → 401
     - `ErrForbidden` → 403
     - Default → 500
   - `HandleStoreError(w http.ResponseWriter, err error)` — convenience function that calls MapStoreError and WriteError.
   - Refactor existing handlers that have per-handler error mapping to use this centralized helper. Focus on the most common pattern: check err, map to status, write error response.

3. **Do NOT introduce full error middleware in this plan** — the CONTEXT.md mentions error middleware, but fully refactoring all handlers to return `*Response` and adding middleware wrapper is too large for this task. Instead, provide the centralized helpers and demonstrate usage in 2-3 handlers. Full middleware adoption can be a future improvement.

**Documentation Update:**

4. **Update `docs/ARCHITECTURE.md`**:
   - Update the package structure diagram to reflect new sub-packages:
     - `pkg/payload/offloader/` (was `pkg/payload/transfer/`)
     - `pkg/payload/gc/` (extracted from transfer)
     - `pkg/payload/io/` (extracted from service.go)
     - `pkg/metadata/file/` (extracted from file.go)
     - `pkg/metadata/auth/` (extracted from authentication.go)
     - `pkg/metadata/storetest/` (new conformance suite)
     - `pkg/controlplane/runtime/{adapters,shares,stores,mounts,lifecycle,identity}/`
     - `pkg/auth/` (expanded)
   - Update the data flow description to mention sub-services.
   - Update the Store interface section to mention sub-interfaces.

5. **Update `CLAUDE.md`**:
   - Update the directory structure to reflect all package moves/renames.
   - Update the "Architecture" section with new sub-package descriptions.
   - Update the "Key Interfaces" section to mention sub-interfaces and composites.
   - Update the TransferManager references to Offloader.
   - Add entries for new packages (auth, storetest, gc, io, file, auth sub-packages, runtime sub-services).
   - Ensure all file path references are accurate.

6. Add `doc.go` files to any new packages that don't have them yet.
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build ./... && go test ./internal/controlplane/api/handlers/... -count=1 2>&1 | tail -10</automated>
  </verify>
  <done>API error mapping centralized via helpers; at least 2-3 handlers use centralized error mapping; ARCHITECTURE.md updated with new package structure; CLAUDE.md updated with all Phase 29 changes; all tests pass.</done>
</task>

</tasks>

<verification>
```bash
# Full build succeeds
cd /Users/marmos91/Projects/dittofs && go build ./...

# All tests pass
go test ./... -count=1 2>&1 | tail -30

# No vet issues
go vet ./...

# Documentation updated
grep -l "offloader" docs/ARCHITECTURE.md CLAUDE.md
# Both files should be found
```
</verification>

<success_criteria>
- pkg/auth/ package centralized with Authenticator, AuthProvider, IdentityMapper, Identity
- Kerberos provider implements AuthProvider interface
- Centralized API error mapping helpers in handlers package
- ARCHITECTURE.md reflects all Phase 29 package changes
- CLAUDE.md reflects all Phase 29 package changes
- All tests pass across entire codebase
- go build ./... succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/29-core-layer-decomposition/29-07-SUMMARY.md`
</output>
