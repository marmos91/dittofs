---
phase: 27-nfs-adapter-restructuring
plan: 03
type: execute
wave: 2
depends_on:
  - 27-01
files_modified:
  - internal/adapter/nfs/dispatch.go (new, consolidated dispatch entry point)
  - internal/adapter/nfs/dispatch_test.go (new, version negotiation tests)
  - internal/adapter/nfs/helpers.go (new or refactored, shared handler helpers)
  - internal/adapter/nfs/middleware/auth.go (new, extracted from current dispatch.go)
  - internal/adapter/nfs/connection.go (new, shared connection logic)
  - internal/adapter/nfs/v4/connection.go (new, v4-specific connection logic)
  - internal/adapter/nfs/v3/dispatch.go (version-specific dispatch)
  - internal/adapter/nfs/v4/dispatch.go (version-specific dispatch)
  - pkg/adapter/nfs/connection.go (split, thin wrapper)
autonomous: true
requirements:
  - REF-03

must_haves:
  truths:
    - "A single `Dispatch()` function in `internal/adapter/nfs/dispatch.go` routes by program -> version -> procedure"
    - "Auth context extraction lives in `internal/adapter/nfs/middleware/` separate from dispatch logic"
    - "Version negotiation returns correct RPC errors: PROG_UNAVAIL for unknown programs, PROG_MISMATCH for unsupported NFS versions (range 3-4), NFS4ERR_MINOR_VERS_MISMATCH for unsupported minor versions"
    - "Connection code is split: shared logic in `nfs/connection.go`, v4-specific (backchannel, session unbinding) in `v4/connection.go`"
    - "Shared handler helpers (handleRequest generic, response builders) in `internal/adapter/nfs/helpers.go`"
    - "Table-driven version negotiation tests cover v2 reject, v5 reject, minor=2 reject, unknown program"
    - "`go build ./...` and `go test ./...` pass with zero failures"
  artifacts:
    - path: "internal/adapter/nfs/dispatch.go"
      provides: "Top-level program switch (NFS/Mount/NLM/NSM/Portmap)"
      contains: "func Dispatch"
    - path: "internal/adapter/nfs/dispatch_test.go"
      provides: "Version negotiation table-driven tests"
      contains: "TestDispatch"
    - path: "internal/adapter/nfs/middleware/auth.go"
      provides: "Auth context extraction"
      contains: "ExtractAuthContext"
    - path: "internal/adapter/nfs/helpers.go"
      provides: "Cross-version shared handler helpers"
    - path: "internal/adapter/nfs/connection.go"
      provides: "Shared NFS connection logic (TCP framing, request reading)"
    - path: "internal/adapter/nfs/v4/connection.go"
      provides: "v4-specific connection logic (backchannel demux, session unbinding)"
  key_links:
    - from: "pkg/adapter/nfs/handlers.go"
      to: "internal/adapter/nfs/dispatch.go"
      via: "Dispatch() function call"
      pattern: "nfs_internal\\.Dispatch|dispatch\\.Dispatch"
    - from: "internal/adapter/nfs/dispatch.go"
      to: "internal/adapter/nfs/v3/dispatch.go"
      via: "dispatchNFS -> v3.Dispatch()"
      pattern: "v3\\.Dispatch"
    - from: "internal/adapter/nfs/dispatch.go"
      to: "internal/adapter/nfs/v4/dispatch.go"
      via: "dispatchNFS -> v4.Dispatch()"
      pattern: "v4\\.Dispatch"
---

<objective>
Consolidate NFS dispatch into a single hierarchical entry point, extract auth middleware, split connection code by version, and extract shared handler helpers. Add version negotiation tests.

Purpose: Replace the current dispatch split across 4+ files in 2 packages with a clean program -> version -> procedure chain. This is the core structural improvement of the refactoring.
Output: Consolidated dispatch with proper version negotiation, auth middleware, split connection code, and comprehensive tests.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-nfs-adapter-restructuring/27-CONTEXT.md
@.planning/phases/27-nfs-adapter-restructuring/27-RESEARCH.md
@.planning/phases/27-nfs-adapter-restructuring/27-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract auth middleware and shared helpers, create consolidated dispatch</name>
  <files>
    internal/adapter/nfs/dispatch.go (new)
    internal/adapter/nfs/middleware/auth.go (new)
    internal/adapter/nfs/helpers.go (new)
    internal/adapter/nfs/v3/dispatch.go (new or refactored from existing)
    internal/adapter/nfs/v4/dispatch.go (new or refactored from existing)
  </files>
  <action>
    This task refactors the dispatch architecture. ZERO behavior changes -- same routing, same error handling, new organization.

    **Step A: Extract auth middleware**

    1. Examine `internal/adapter/nfs/dispatch.go` (the file from the old `internal/protocol/nfs/dispatch.go` after Plan 01 rename). It currently contains `ExtractHandlerContext()` / `ExtractAuthContext()` along with dispatch types and helpers.
    2. Create `internal/adapter/nfs/middleware/` package.
    3. Move auth context extraction logic to `internal/adapter/nfs/middleware/auth.go`. This includes:
       - `ExtractAuthContext()` (or `ExtractHandlerContext()`)
       - Related types (`AuthContext`, `HandlerContext` if defined here)
       - Any auth validation helpers
    4. Package declaration: `package middleware`
    5. Update imports in consumers (dispatch files, connection handlers).
    6. Verify: `go build ./...`

    **Step B: Extract shared handler helpers**

    1. Examine the existing shared helpers:
       - `internal/adapter/nfs/utils.go` has `handleRequest` generic helper + type unions
       - v3 has `utils.go`, `auth_helper.go`, `nfs_context.go`, `nfs_response.go`, `verf.go`
       - v4 has `helpers.go`, `context.go`
    2. Create `internal/adapter/nfs/helpers.go` for cross-version shared helpers:
       - The `handleRequest[Req, Resp]` generic template (if it's used by both v3 and mount)
       - Response/reply building helpers shared across versions
       - Common type definitions used by dispatch
    3. Keep version-specific helpers in their respective packages (v3/utils.go, v4/helpers.go).
    4. Verify: `go build ./...`

    **Step C: Create consolidated dispatch entry point**

    1. Create `internal/adapter/nfs/dispatch.go` with the single `Dispatch()` entry point.
    2. Design: Accept `context.Context` as first parameter (per CONTEXT.md decision). Use a `DispatchDeps` struct for dependencies (per RESEARCH.md recommendation):
       ```go
       type DispatchDeps struct {
           V3Handler   *v3.Handler  // or interface
           V4Handler   *v4.Handler
           MountHandler *mount.Handler
           NLMHandler  *nlm.Handler
           NSMHandler  *nsm.Handler
           PortmapHandler *portmap.Handler
           Metrics     MetricsCollector // optional
           RateLimiter RateLimiter      // optional
       }
       ```
    3. Top-level switch on program number:
       - 100003 (NFS) -> `dispatchNFS()` -> switch on version (3 -> v3.Dispatch, 4 -> v4.Dispatch, else PROG_MISMATCH Low=3 High=4)
       - 100005 (Mount) -> `dispatchMount()`
       - 100021 (NLM) -> `dispatchNLM()`
       - 100024 (NSM) -> `dispatchNSM()`
       - 100000 (Portmap) -> `dispatchPortmap()`
       - default -> PROG_UNAVAIL
    4. Create version-specific dispatch files if they don't already exist:
       - `v3/dispatch.go`: switches on procedure number, calls appropriate handler
       - `v4/dispatch.go`: switches on version (0 -> v4.0 compound, 1 -> v4.1 compound, else MINOR_VERS_MISMATCH), routes to handler
    5. Wire the consolidated `Dispatch()` into the connection handling code. The `pkg/adapter/nfs/handlers.go` (was `nfs_connection_handlers.go`) `handleRPCCall()` method should become a thin wrapper: (1) GSS interception, (2) call `nfs.Dispatch()`, (3) write reply.
    6. Use existing `rpc.MakeProgMismatchReply()` and `rpc.MakeErrorReply()` for error responses.
    7. Verify: `go build ./...`

    IMPORTANT per Pitfall 6: The current dispatch is tightly coupled to `NFSConnection` struct. The consolidated `Dispatch()` should NOT import `pkg/adapter/nfs`. It accepts dependencies via the `DispatchDeps` struct. The `NFSConnection.handleRPCCall()` constructs `DispatchDeps` from its fields and calls `Dispatch()`.
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build ./... && go test ./...</automated>
    <manual>Verify dispatch.go has single Dispatch() entry, middleware/ has auth extraction, helpers.go has shared helpers</manual>
  </verify>
  <done>Single `Dispatch()` entry point routes by program -> version -> procedure. Auth middleware extracted. Shared helpers consolidated. Existing tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Split connection code by version and add version negotiation tests</name>
  <files>
    internal/adapter/nfs/connection.go (shared connection logic)
    internal/adapter/nfs/v4/connection.go (v4-specific connection logic)
    internal/adapter/nfs/dispatch_test.go (new, version negotiation tests)
    pkg/adapter/nfs/connection.go (updated, thinner)
  </files>
  <action>
    **Step A: Split connection code**

    1. Examine `pkg/adapter/nfs/connection.go` (was `nfs_connection.go`, 388 lines per research). It contains:
       - `NFSConnection` struct with v4 backchannel fields
       - `Serve()` method with v4 backchannel demux logic
       - `readRequest()` with v4 REPLY message routing
       - `processRequest()` (generic)
       - `readFragmentHeader()`, `readRPCMessage()` (generic RPC framing)
       - `handleUnsupportedVersion()` (generic)
       - `handleConnectionClose()` (generic with v4.1 connection unbinding)
    2. Per research recommendation, extract shared connection logic to `internal/adapter/nfs/connection.go`:
       - RPC fragment header reading
       - RPC message parsing
       - Generic request processing loop
       - These are pure protocol utilities that don't depend on adapter state
    3. Extract v4-specific connection logic to `internal/adapter/nfs/v4/connection.go`:
       - Backchannel demux (reading replies to CB calls)
       - `SetPendingCBReplies()`
       - v4.1 session connection unbinding on close
    4. `pkg/adapter/nfs/connection.go` becomes thinner -- it keeps the `NFSConnection` struct, `Serve()` loop, and delegates to internal packages for framing and v4 specifics.
    5. Per research: A separate `v3/connection.go` is NOT needed (v3 has no version-specific connection logic).
    6. Watch for circular imports: `pkg/adapter/nfs/` -> `internal/adapter/nfs/` is allowed. Reverse is NOT.
    7. Verify: `go build ./...`

    **Step B: Add version negotiation tests**

    1. Create `internal/adapter/nfs/dispatch_test.go` with table-driven subtests:
       ```go
       func TestDispatch_VersionNegotiation(t *testing.T) {
           tests := []struct {
               name       string
               program    uint32
               version    uint32
               wantStatus uint32
               wantLow    uint32 // For PROG_MISMATCH
               wantHigh   uint32
           }{
               {"NFS v2 rejected with PROG_MISMATCH", ProgramNFS, 2, RPCProgMismatch, 3, 4},
               {"NFS v5 rejected with PROG_MISMATCH", ProgramNFS, 5, RPCProgMismatch, 3, 4},
               {"Unknown program rejected with PROG_UNAVAIL", 999999, 1, RPCProgUnavail, 0, 0},
               {"NFS v3 NULL accepted", ProgramNFS, 3, RPCSuccess, 0, 0},
               {"NFS v4 NULL accepted", ProgramNFS, 4, RPCSuccess, 0, 0},
           }
           // ...
       }
       ```
    2. Also test NFS v4 minor version rejection:
       ```go
       func TestDispatch_MinorVersionMismatch(t *testing.T) {
           // v4.1 COMPOUND with minorversion=2 should get NFS4ERR_MINOR_VERS_MISMATCH
       }
       ```
    3. Tests should call `Dispatch()` with parsed structs (function-level tests), not raw wire bytes (per CONTEXT.md decision).
    4. Use minimal mock/stub dependencies in `DispatchDeps` -- only what's needed for NULL procedure and version checks.
    5. Verify: `go test ./internal/adapter/nfs/ -v -run TestDispatch`

    **Step C: Run full test suite**
    ```bash
    go test ./...
    ```
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build ./... && go test ./... && go test ./internal/adapter/nfs/ -v -run TestDispatch -count=1</automated>
    <manual>Verify version negotiation tests cover all 4 cases: v2 reject, v5 reject, minor=2 reject, unknown program</manual>
  </verify>
  <done>Connection code split by version concern. Version negotiation tests pass covering v2 reject, v5 reject, minor=2 reject, unknown program. Full test suite passes.</done>
</task>

</tasks>

<verification>
1. `internal/adapter/nfs/dispatch.go` contains `func Dispatch()` as single entry point
2. `internal/adapter/nfs/middleware/auth.go` contains auth context extraction
3. `internal/adapter/nfs/helpers.go` contains shared handler helpers
4. `internal/adapter/nfs/connection.go` contains shared connection logic
5. `internal/adapter/nfs/v4/connection.go` contains v4-specific connection logic
6. Version negotiation tests exist and pass for: v2 reject, v5 reject, minor=2 reject, unknown program
7. `go build ./...` passes
8. `go test ./...` passes
</verification>

<success_criteria>
- Single dispatch entry point with hierarchical program -> version -> procedure routing
- Auth middleware separated from dispatch
- Connection code split by version concern
- Version negotiation tests comprehensive and passing
- Full build and test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/27-nfs-adapter-restructuring/27-03-SUMMARY.md`
</output>
