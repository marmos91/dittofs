---
phase: 27-nfs-adapter-restructuring
plan: 02
type: execute
wave: 2
depends_on:
  - 27-01
files_modified:
  - pkg/adapter/nfs/ (file renames, remove nfs_ prefix)
  - internal/adapter/nfs/v4/v41/ (new directory for v4.1-only handlers and types)
  - internal/adapter/nfs/v4/handlers/ (v4.1 handlers removed after move)
autonomous: true
requirements:
  - REF-03

must_haves:
  truths:
    - "No file in `pkg/adapter/nfs/` has the `nfs_` prefix"
    - "The `.disabled` test file is removed"
    - "v4.1-only handlers (11 files + tests) live in `internal/adapter/nfs/v4/v41/handlers/`"
    - "v4.0 dispatch table imports v4.1 handlers from `v41/handlers/` and registers them"
    - "`go build ./...` and `go test ./...` pass with zero failures"
  artifacts:
    - path: "pkg/adapter/nfs/adapter.go"
      provides: "Renamed from nfs_adapter.go"
    - path: "pkg/adapter/nfs/connection.go"
      provides: "Renamed from nfs_connection.go"
    - path: "pkg/adapter/nfs/dispatch.go"
      provides: "Renamed from nfs_connection_dispatch.go"
    - path: "pkg/adapter/nfs/handlers.go"
      provides: "Renamed from nfs_connection_handlers.go"
    - path: "pkg/adapter/nfs/reply.go"
      provides: "Renamed from nfs_connection_reply.go"
    - path: "pkg/adapter/nfs/settings.go"
      provides: "Renamed from nfs_adapter_settings.go"
    - path: "pkg/adapter/nfs/shutdown.go"
      provides: "Renamed from nfs_adapter_shutdown.go"
    - path: "internal/adapter/nfs/v4/v41/handlers/"
      provides: "v4.1-only operation handlers"
    - path: "internal/adapter/nfs/v4/v41/types/"
      provides: "v4.1-only XDR types (if split)"
  key_links:
    - from: "internal/adapter/nfs/v4/handlers/handler.go"
      to: "internal/adapter/nfs/v4/v41/handlers/"
      via: "import and registration in v41DispatchTable"
      pattern: "v41handlers"
---

<objective>
Rename `pkg/adapter/nfs/` files to drop the `nfs_` prefix and split v4.1-specific handlers/types into a `v4/v41/` nested hierarchy.

Purpose: Clean up file naming to follow Go idioms (package name serves as prefix) and establish clear version boundaries between v4.0 and v4.1.
Output: Idiomatic file names in `pkg/adapter/nfs/`, v4.1 code isolated in `v4/v41/`.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-nfs-adapter-restructuring/27-CONTEXT.md
@.planning/phases/27-nfs-adapter-restructuring/27-RESEARCH.md
@.planning/phases/27-nfs-adapter-restructuring/27-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename pkg/adapter/nfs/ files to drop nfs_ prefix and remove disabled tests</name>
  <files>
    pkg/adapter/nfs/nfs_adapter.go -> pkg/adapter/nfs/adapter.go
    pkg/adapter/nfs/nfs_connection.go -> pkg/adapter/nfs/connection.go
    pkg/adapter/nfs/nfs_connection_dispatch.go -> pkg/adapter/nfs/dispatch.go
    pkg/adapter/nfs/nfs_connection_handlers.go -> pkg/adapter/nfs/handlers.go
    pkg/adapter/nfs/nfs_connection_reply.go -> pkg/adapter/nfs/reply.go
    pkg/adapter/nfs/nfs_adapter_settings.go -> pkg/adapter/nfs/settings.go
    pkg/adapter/nfs/nfs_adapter_shutdown.go -> pkg/adapter/nfs/shutdown.go
    pkg/adapter/nfs/nfs_adapter_nlm.go -> pkg/adapter/nfs/nlm.go
    pkg/adapter/nfs/nfs_adapter_portmap.go -> pkg/adapter/nfs/portmap.go
    pkg/adapter/nfs/nlm_service.go -> pkg/adapter/nfs/nlm_service.go (keep, service integration)
    pkg/adapter/nfs/nfs_adapter_test.go.disabled -> DELETE
  </files>
  <action>
    Rename all files to drop the `nfs_` prefix. These are intra-package renames (no import paths change since the package path stays `pkg/adapter/nfs`). Use `git mv` for each:

    1. Rename files:
       ```bash
       cd pkg/adapter/nfs
       git mv nfs_adapter.go adapter.go
       git mv nfs_connection.go connection.go
       git mv nfs_connection_dispatch.go dispatch.go
       git mv nfs_connection_handlers.go handlers.go
       git mv nfs_connection_reply.go reply.go
       git mv nfs_adapter_settings.go settings.go
       git mv nfs_adapter_shutdown.go shutdown.go
       git mv nfs_adapter_nlm.go nlm.go
       git mv nfs_adapter_portmap.go portmap.go
       ```
    2. Remove the `.disabled` test file:
       `git rm nfs_adapter_test.go.disabled`
    3. `nlm_service.go` stays as-is (no `nfs_` prefix to remove). Per research, NLM/portmap service integration code stays in `pkg/adapter/nfs/` because it references `NFSAdapter` struct. Only the protocol-level code moved in Plan 01.
    4. Verify: `go build ./...` (these are just renames within the same package, no import changes needed)
    5. Verify: `go test ./...`

    IMPORTANT: No import paths change in this task. All files remain in `pkg/adapter/nfs/` package. The rename is cosmetic within the package.
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build ./... && go test ./... && ! ls pkg/adapter/nfs/nfs_*.go 2>/dev/null | grep -q . && ! ls pkg/adapter/nfs/*.disabled 2>/dev/null | grep -q .</automated>
    <manual>Verify pkg/adapter/nfs/ has no files with nfs_ prefix and no .disabled files</manual>
  </verify>
  <done>All files in `pkg/adapter/nfs/` have clean names without `nfs_` prefix. The `.disabled` test file is removed. Build and tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Split v4.1-only handlers and types into v4/v41/ nested hierarchy</name>
  <files>
    internal/adapter/nfs/v4/v41/handlers/ (new, receives 11 handler files + test files)
    internal/adapter/nfs/v4/v41/types/ (new, receives v4.1-only type files if applicable)
    internal/adapter/nfs/v4/handlers/handler.go (updated imports)
  </files>
  <action>
    Move v4.1-only handlers from `internal/adapter/nfs/v4/handlers/` to `internal/adapter/nfs/v4/v41/handlers/`.

    **Step A: Create target directories**
    ```bash
    mkdir -p internal/adapter/nfs/v4/v41/handlers
    ```

    **Step B: Move v4.1-only handler files**

    The v4.1-only handlers are identified by the `_handler.go` suffix (per RESEARCH.md). Move each with `git mv`:
    ```bash
    git mv internal/adapter/nfs/v4/handlers/exchange_id_handler.go internal/adapter/nfs/v4/v41/handlers/exchange_id.go
    git mv internal/adapter/nfs/v4/handlers/exchange_id_handler_test.go internal/adapter/nfs/v4/v41/handlers/exchange_id_test.go
    git mv internal/adapter/nfs/v4/handlers/create_session_handler.go internal/adapter/nfs/v4/v41/handlers/create_session.go
    git mv internal/adapter/nfs/v4/handlers/create_session_handler_test.go internal/adapter/nfs/v4/v41/handlers/create_session_test.go
    git mv internal/adapter/nfs/v4/handlers/destroy_session_handler.go internal/adapter/nfs/v4/v41/handlers/destroy_session.go
    git mv internal/adapter/nfs/v4/handlers/destroy_session_handler_test.go internal/adapter/nfs/v4/v41/handlers/destroy_session_test.go
    git mv internal/adapter/nfs/v4/handlers/destroy_clientid_handler.go internal/adapter/nfs/v4/v41/handlers/destroy_clientid.go
    git mv internal/adapter/nfs/v4/handlers/destroy_clientid_handler_test.go internal/adapter/nfs/v4/v41/handlers/destroy_clientid_test.go
    git mv internal/adapter/nfs/v4/handlers/bind_conn_to_session_handler.go internal/adapter/nfs/v4/v41/handlers/bind_conn_to_session.go
    git mv internal/adapter/nfs/v4/handlers/bind_conn_to_session_handler_test.go internal/adapter/nfs/v4/v41/handlers/bind_conn_to_session_test.go
    git mv internal/adapter/nfs/v4/handlers/backchannel_ctl_handler.go internal/adapter/nfs/v4/v41/handlers/backchannel_ctl.go
    git mv internal/adapter/nfs/v4/handlers/backchannel_ctl_handler_test.go internal/adapter/nfs/v4/v41/handlers/backchannel_ctl_test.go
    git mv internal/adapter/nfs/v4/handlers/sequence_handler.go internal/adapter/nfs/v4/v41/handlers/sequence.go
    git mv internal/adapter/nfs/v4/handlers/sequence_handler_test.go internal/adapter/nfs/v4/v41/handlers/sequence_test.go
    git mv internal/adapter/nfs/v4/handlers/reclaim_complete_handler.go internal/adapter/nfs/v4/v41/handlers/reclaim_complete.go
    git mv internal/adapter/nfs/v4/handlers/reclaim_complete_handler_test.go internal/adapter/nfs/v4/v41/handlers/reclaim_complete_test.go
    git mv internal/adapter/nfs/v4/handlers/free_stateid_handler.go internal/adapter/nfs/v4/v41/handlers/free_stateid.go
    git mv internal/adapter/nfs/v4/handlers/free_stateid_handler_test.go internal/adapter/nfs/v4/v41/handlers/free_stateid_test.go
    git mv internal/adapter/nfs/v4/handlers/get_dir_delegation_handler.go internal/adapter/nfs/v4/v41/handlers/get_dir_delegation.go
    git mv internal/adapter/nfs/v4/handlers/get_dir_delegation_handler_test.go internal/adapter/nfs/v4/v41/handlers/get_dir_delegation_test.go
    git mv internal/adapter/nfs/v4/handlers/test_stateid_handler.go internal/adapter/nfs/v4/v41/handlers/test_stateid.go
    git mv internal/adapter/nfs/v4/handlers/test_stateid_handler_test.go internal/adapter/nfs/v4/v41/handlers/test_stateid_test.go
    ```

    Note: Drop the `_handler` suffix from filenames (align with v3 pattern per CONTEXT.md decision).

    **Step C: Update package declarations**

    All moved handler files need `package handlers` (the directory name). They are likely already `package handlers` since they were in `v4/handlers/`. Verify and keep as-is. But note this creates a naming conflict: both `v4/handlers/` and `v4/v41/handlers/` declare `package handlers`. Importers must use aliases.

    **Step D: Update handler registration in v4/handlers/handler.go**

    In `internal/adapter/nfs/v4/handlers/handler.go`, the `NewHandler()` function registers v4.1 handlers in `v41DispatchTable`. After the move, these handler functions are now in a different package. Update the imports:

    ```go
    import (
        v41handlers "github.com/marmos91/dittofs/internal/adapter/nfs/v4/v41/handlers"
    )
    ```

    Then update all references from e.g. `h.handleExchangeID` to `v41handlers.HandleExchangeID` (or whatever the exported name is). Check if the handlers are methods on `*Handler` or standalone functions. If they are methods, they need access to the handler struct -- may need to pass it or use a factory pattern. The research says: "`v4/v41/handlers/` exports handler functions. `v4/handlers/handler.go:NewHandler()` imports them and registers in `v41DispatchTable`."

    Examine each handler function signature. If they are methods on `*Handler`, they must be adapted: either make them standalone functions that accept dependencies, or keep a thin method wrapper in v4/handlers/ that delegates to v41/ functions. Choose the approach that minimizes code changes while maintaining clean separation.

    **Step E: Handle v4.1-only types (if applicable)**

    Audit `internal/adapter/nfs/v4/types/` for v4.1-only type files. The research identifies these by content (v4.1 session types, EXCHANGE_ID types, etc.). If there are clear v4.1-only types files:
    ```bash
    mkdir -p internal/adapter/nfs/v4/v41/types
    ```
    Move v4.1-only types. Update imports. This is optional -- only do if files are clearly v4.1-only and the split reduces confusion. If types are mixed or shared, leave them in `v4/types/` (per CONTEXT.md: "version-specific types live in `v3/types/` and `v4/types/`").

    **Step F: Verify**
    ```bash
    go build ./...
    go test ./...
    ```

    CAUTION per research Pitfall 3: Only move handlers that are clearly v4.1-only (the 11 `_handler.go` files). Shared handlers (access.go, read.go, write.go, etc.) MUST stay in `v4/handlers/`.
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build ./... && go test ./... && ls internal/adapter/nfs/v4/v41/handlers/*.go | wc -l | tr -d ' '</automated>
    <manual>Verify v4.1 handlers exist in v41/handlers/ and v4/handlers/ retains shared handlers only</manual>
  </verify>
  <done>v4.1-only handlers live in `v4/v41/handlers/` with `_handler` suffix dropped. v4 handler registration imports from `v41/handlers/`. No v4.1-only handler files remain in `v4/handlers/`. Build and tests pass.</done>
</task>

</tasks>

<verification>
1. No files in `pkg/adapter/nfs/` have `nfs_` prefix
2. No `.disabled` test files exist
3. `internal/adapter/nfs/v4/v41/handlers/` contains 11 handler files (+ test files)
4. Handler file names in `v41/handlers/` do not have `_handler` suffix
5. `v4/handlers/handler.go` imports and registers v4.1 handlers from `v41/handlers/`
6. `go build ./...` passes
7. `go test ./...` passes
</verification>

<success_criteria>
- `pkg/adapter/nfs/` files follow idiomatic naming (no `nfs_` prefix)
- v4.1-only handlers isolated in `v4/v41/handlers/`
- Registration chain intact: v4 handler init -> v4.1 handler imports
- Full build and test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/27-nfs-adapter-restructuring/27-02-SUMMARY.md`
</output>
