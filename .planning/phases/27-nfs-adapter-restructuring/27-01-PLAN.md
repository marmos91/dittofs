---
phase: 27-nfs-adapter-restructuring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/adapter/ (renamed from internal/protocol/)
  - internal/adapter/nfs/nlm/ (moved from internal/adapter/nlm/)
  - internal/adapter/nfs/nsm/ (moved from internal/adapter/nsm/)
  - internal/adapter/nfs/portmap/ (moved from internal/adapter/portmap/)
  - internal/adapter/nfs/xdr/core/ (moved from internal/adapter/xdr/)
  - internal/adapter/pool/bufpool.go (moved from internal/bufpool/)
autonomous: true
requirements:
  - REF-03

must_haves:
  truths:
    - "`internal/protocol/` directory no longer exists; all code lives under `internal/adapter/`"
    - "NLM, NSM, and portmapper are children of `internal/adapter/nfs/`, not peers"
    - "Generic XDR primitives live at `internal/adapter/nfs/xdr/core/` with `package xdr` declaration preserved"
    - "Buffer pool lives at `internal/adapter/pool/` and both NFS and SMB adapters import it"
    - "`go build ./...` and `go test ./...` pass with zero failures after all moves"
  artifacts:
    - path: "internal/adapter/nfs/"
      provides: "NFS adapter internal implementation"
    - path: "internal/adapter/nfs/nlm/"
      provides: "NLM protocol under NFS namespace"
    - path: "internal/adapter/nfs/nsm/"
      provides: "NSM protocol under NFS namespace"
    - path: "internal/adapter/nfs/portmap/"
      provides: "Portmapper under NFS namespace"
    - path: "internal/adapter/nfs/xdr/core/"
      provides: "Generic XDR primitives with package xdr"
    - path: "internal/adapter/pool/bufpool.go"
      provides: "Shared buffer pool utility"
    - path: "internal/adapter/smb/"
      provides: "SMB adapter (path renamed, no restructuring)"
  key_links:
    - from: "all Go files in repo (~312)"
      to: "internal/adapter/"
      via: "sed-based import path rewrite"
      pattern: "github.com/marmos91/dittofs/internal/adapter"
    - from: "internal/adapter/nfs/xdr/core/*.go"
      to: "package xdr declaration"
      via: "package name preserved despite directory name change"
      pattern: "^package xdr$"
---

<objective>
Rename `internal/protocol/` to `internal/adapter/`, consolidate NLM/NSM/portmapper under `internal/adapter/nfs/`, move generic XDR to `internal/adapter/nfs/xdr/core/`, and move buffer pool to `internal/adapter/pool/`.

Purpose: Establish the target directory hierarchy before any per-file reorganization. All subsequent plans depend on this foundation rename.
Output: Fully compiling codebase with new directory layout and all import paths updated.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-nfs-adapter-restructuring/27-CONTEXT.md
@.planning/phases/27-nfs-adapter-restructuring/27-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename internal/protocol/ to internal/adapter/ and rewrite all imports</name>
  <files>
    internal/protocol/ -> internal/adapter/
    All ~312 Go files referencing internal/protocol
  </files>
  <action>
    Execute the top-level directory rename and bulk import rewrite:

    1. `git mv internal/protocol internal/adapter`
    2. Rewrite ALL imports in the entire repo:
       `find . -name '*.go' -not -path './vendor/*' -exec sed -i '' 's|github.com/marmos91/dittofs/internal/protocol/|github.com/marmos91/dittofs/internal/adapter/|g' {} +`
       Also rewrite any exact matches without trailing slash:
       `find . -name '*.go' -not -path './vendor/*' -exec sed -i '' 's|github.com/marmos91/dittofs/internal/protocol"|github.com/marmos91/dittofs/internal/adapter"|g' {} +`
    3. Check for any remaining references: `grep -r 'internal/protocol' --include='*.go' .`
    4. Run `go build ./...` to verify. If import alias conflicts arise (two packages named `nfs`), fix with explicit aliases.
    5. Run `go vet ./...` for static analysis.
    6. Run `go test ./...` to verify all tests pass.

    IMPORTANT: This is a pure rename with zero logic changes. The `internal/auth/` directory is NOT moved (deferred to Phase 28 per CONTEXT.md decision).

    After this step, the directory structure should be:
    ```
    internal/adapter/
    ├── nfs/       (was internal/protocol/nfs/)
    ├── nlm/       (was internal/protocol/nlm/)
    ├── nsm/       (was internal/protocol/nsm/)
    ├── portmap/   (was internal/protocol/portmap/)
    ├── smb/       (was internal/protocol/smb/)
    └── xdr/       (was internal/protocol/xdr/)
    ```
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build ./... && go vet ./... && ! grep -r 'internal/protocol' --include='*.go' . 2>/dev/null | grep -v 'Binary'</automated>
    <manual>Verify internal/protocol/ directory no longer exists</manual>
  </verify>
  <done>All `internal/protocol` references replaced with `internal/adapter`. Build and vet pass. No Go files reference the old path.</done>
</task>

<task type="auto">
  <name>Task 2: Consolidate NLM/NSM/portmapper under nfs/ and move generic XDR and bufpool</name>
  <files>
    internal/adapter/nlm/ -> internal/adapter/nfs/nlm/
    internal/adapter/nsm/ -> internal/adapter/nfs/nsm/
    internal/adapter/portmap/ -> internal/adapter/nfs/portmap/
    internal/adapter/xdr/ -> internal/adapter/nfs/xdr/core/
    internal/bufpool/ -> internal/adapter/pool/
  </files>
  <action>
    Execute three sub-moves in sequence, verifying build after each:

    **Step A: Move NLM, NSM, portmapper under nfs/**

    1. `git mv internal/adapter/nlm internal/adapter/nfs/nlm`
    2. `git mv internal/adapter/nsm internal/adapter/nfs/nsm`
    3. `git mv internal/adapter/portmap internal/adapter/nfs/portmap`
    4. Rewrite imports:
       ```bash
       find . -name '*.go' -not -path './vendor/*' -exec sed -i '' \
         's|github.com/marmos91/dittofs/internal/adapter/nlm|github.com/marmos91/dittofs/internal/adapter/nfs/nlm|g; s|github.com/marmos91/dittofs/internal/adapter/nsm|github.com/marmos91/dittofs/internal/adapter/nfs/nsm|g; s|github.com/marmos91/dittofs/internal/adapter/portmap|github.com/marmos91/dittofs/internal/adapter/nfs/portmap|g' {} +
       ```
    5. Verify: `go build ./...`

    **Step B: Move generic XDR to nfs/xdr/core/**

    1. Create target: `mkdir -p internal/adapter/nfs/xdr/core`
    2. Move files: `git mv internal/adapter/xdr/decode.go internal/adapter/xdr/encode.go internal/adapter/xdr/types.go internal/adapter/xdr/union.go internal/adapter/nfs/xdr/core/`
    3. CRITICAL: Verify each moved file still declares `package xdr` (not `package core`). Go allows package name to differ from directory name. This preserves all `xdr.DecodeUint32()` call sites.
    4. If there are test files in `internal/adapter/xdr/`, move those too.
    5. Remove the now-empty `internal/adapter/xdr/` directory.
    6. Rewrite imports:
       `find . -name '*.go' -not -path './vendor/*' -exec sed -i '' 's|github.com/marmos91/dittofs/internal/adapter/xdr|github.com/marmos91/dittofs/internal/adapter/nfs/xdr/core|g' {} +`
    7. Verify: `go build ./...`

    **Step C: Move bufpool to internal/adapter/pool/**

    1. `mkdir -p internal/adapter/pool`
    2. `git mv internal/bufpool/bufpool.go internal/adapter/pool/bufpool.go`
    3. If `internal/bufpool/bufpool_test.go` exists, move it too.
    4. Update package declaration in moved files: change `package bufpool` to `package pool` (or keep as `package bufpool` -- check what the import alias pattern is in consumers). The package name should be `pool` since that matches the directory.
    5. Rewrite imports:
       `find . -name '*.go' -not -path './vendor/*' -exec sed -i '' 's|github.com/marmos91/dittofs/internal/bufpool|github.com/marmos91/dittofs/internal/adapter/pool|g' {} +`
    6. If consumers used `bufpool.GetBuffer()`, they will now need `pool.GetBuffer()` (since package renamed to `pool`). Update all call sites. Alternatively, keep `package bufpool` and consumers use the aliased import. Check the 4 consumers: `v3/handlers/read_payload.go`, `v3/handlers/read.go`, `pkg/adapter/nfs/nfs_connection.go`, `pkg/adapter/smb/smb_connection.go`.
    7. Verify: `go build ./...` and `go test ./...`

    After all moves, verify no remaining references to old paths and run full test suite.
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build ./... && go test ./... && ! grep -rE 'internal/adapter/(nlm|nsm|portmap|xdr)"|internal/bufpool' --include='*.go' . 2>/dev/null | grep -v 'internal/adapter/nfs/'</automated>
    <manual>Verify internal/adapter/ only contains nfs/, smb/, and pool/ directories (plus any CLAUDE.md files)</manual>
  </verify>
  <done>NLM/NSM/portmapper are children of `internal/adapter/nfs/`. Generic XDR lives at `internal/adapter/nfs/xdr/core/` with `package xdr`. Bufpool lives at `internal/adapter/pool/`. All imports updated. Full build and test pass.</done>
</task>

</tasks>

<verification>
1. `internal/protocol/` directory no longer exists
2. `internal/adapter/nfs/nlm/`, `internal/adapter/nfs/nsm/`, `internal/adapter/nfs/portmap/` exist
3. `internal/adapter/nfs/xdr/core/` exists with `package xdr` declaration
4. `internal/adapter/pool/bufpool.go` exists
5. `internal/adapter/xdr/` directory no longer exists
6. `internal/bufpool/` directory no longer exists
7. Zero grep hits for old import paths in Go files
8. `go build ./...` passes
9. `go test ./...` passes
</verification>

<success_criteria>
- All import paths updated from `internal/protocol` to `internal/adapter`
- NFS ecosystem protocols consolidated under `internal/adapter/nfs/`
- Generic XDR at `internal/adapter/nfs/xdr/core/` with preserved `package xdr`
- Buffer pool at `internal/adapter/pool/`
- Full build and test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/27-nfs-adapter-restructuring/27-01-SUMMARY.md`
</output>
