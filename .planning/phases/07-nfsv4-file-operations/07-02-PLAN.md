---
phase: 07-nfsv4-file-operations
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - internal/protocol/nfs/v4/handlers/create.go
  - internal/protocol/nfs/v4/handlers/remove.go
  - internal/protocol/nfs/v4/handlers/handler.go
  - internal/protocol/nfs/v4/types/constants.go
  - internal/protocol/nfs/v4/handlers/create_remove_test.go
autonomous: true

must_haves:
  truths:
    - "NFSv4 CREATE creates directories and symlinks (NOT regular files)"
    - "NFSv4 REMOVE deletes files and empty directories"
    - "CREATE returns change_info4 for parent directory cache invalidation"
    - "REMOVE returns change_info4 for parent directory cache invalidation"
  artifacts:
    - path: "internal/protocol/nfs/v4/handlers/create.go"
      provides: "CREATE operation handler for dirs, symlinks, special files"
      contains: "func.*handleCreate"
    - path: "internal/protocol/nfs/v4/handlers/remove.go"
      provides: "REMOVE operation handler for files and directories"
      contains: "func.*handleRemove"
    - path: "internal/protocol/nfs/v4/types/constants.go"
      provides: "createtype4 constants (NF4DIR, NF4LNK, etc.) for CREATE"
      contains: "CREATETYPE"
  key_links:
    - from: "internal/protocol/nfs/v4/handlers/create.go"
      to: "pkg/metadata"
      via: "MetadataService.CreateDirectory/CreateSymlink"
      pattern: "metaSvc\\.(CreateDirectory|CreateSymlink)"
    - from: "internal/protocol/nfs/v4/handlers/remove.go"
      to: "pkg/metadata"
      via: "MetadataService.RemoveFile/RemoveDirectory"
      pattern: "metaSvc\\.(RemoveFile|RemoveDirectory)"
---

<objective>
Implement NFSv4 CREATE (directories, symlinks, special files) and REMOVE (files, directories) operations.

Purpose: Enables NFSv4 clients to create and delete filesystem entries. Note that NFSv4 CREATE does NOT create regular files -- that happens through OPEN with OPEN4_CREATE (Plan 07-03).

Output: create.go and remove.go handlers, createtype4 constants, change_info4 encoding, comprehensive tests.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-nfsv4-file-operations/07-RESEARCH.md
@.planning/phases/07-nfsv4-file-operations/07-01-SUMMARY.md
@internal/protocol/nfs/v4/handlers/handler.go
@internal/protocol/nfs/v4/handlers/helpers.go
@internal/protocol/nfs/v4/attrs/encode.go
@internal/protocol/nfs/v4/types/constants.go
@internal/protocol/nfs/v4/types/types.go
@pkg/metadata/file.go
@pkg/metadata/directory.go
@internal/protocol/nfs/v3/handlers/create.go
@internal/protocol/nfs/v3/handlers/mkdir.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: CREATE and REMOVE handlers with constants and tests</name>
  <files>
    internal/protocol/nfs/v4/handlers/create.go
    internal/protocol/nfs/v4/handlers/remove.go
    internal/protocol/nfs/v4/handlers/handler.go
    internal/protocol/nfs/v4/types/constants.go
    internal/protocol/nfs/v4/handlers/create_remove_test.go
  </files>
  <action>
**Add constants to `internal/protocol/nfs/v4/types/constants.go`:**

Add createtype4 constants and related values at the end of the file:

```go
// createtype4 values for CREATE operation (RFC 7530 Section 16.4)
// Note: NF4REG is NOT valid for CREATE -- regular files are created via OPEN
const (
    CREATETYPE4_LNK  = 5  // Symbolic link (same as NF4LNK)
    CREATETYPE4_BLK  = 3  // Block device (same as NF4BLK)
    CREATETYPE4_CHR  = 4  // Character device (same as NF4CHR)
    CREATETYPE4_SOCK = 6  // Socket (same as NF4SOCK)
    CREATETYPE4_FIFO = 7  // Named pipe (same as NF4FIFO)
    CREATETYPE4_DIR  = 2  // Directory (same as NF4DIR)
)

// createmode4 values for how attributes are set during creation
const (
    UNCHECKED4 = 0 // Set attrs; if exists, no error
    GUARDED4   = 1 // Set attrs; if exists, error
    EXCLUSIVE4 = 2 // Use verifier for exclusive create
)

// OPEN share_access/share_deny constants (RFC 7530 Section 16.16.2)
const (
    OPEN4_SHARE_ACCESS_READ  = 0x01
    OPEN4_SHARE_ACCESS_WRITE = 0x02
    OPEN4_SHARE_ACCESS_BOTH  = 0x03

    OPEN4_SHARE_DENY_NONE  = 0x00
    OPEN4_SHARE_DENY_READ  = 0x01
    OPEN4_SHARE_DENY_WRITE = 0x02
    OPEN4_SHARE_DENY_BOTH  = 0x03
)

// OPEN create type
const (
    OPEN4_NOCREATE = 0
    OPEN4_CREATE   = 1
)

// OPEN claim types (RFC 7530 Section 16.16.4)
const (
    CLAIM_NULL          = 0
    CLAIM_PREVIOUS      = 1
    CLAIM_DELEGATE_CUR  = 2
    CLAIM_DELEGATE_PREV = 3
)

// OPEN result flags (rflags)
const (
    OPEN4_RESULT_CONFIRM   = 0x02
    OPEN4_RESULT_LOCKTYPE_POSIX = 0x04
)

// OPEN delegation types
const (
    OPEN_DELEGATE_NONE  = 0
    OPEN_DELEGATE_READ  = 1
    OPEN_DELEGATE_WRITE = 2
)

// Write stability levels (stable_how4) for NFSv4
const (
    UNSTABLE4  = 0
    DATA_SYNC4 = 1
    FILE_SYNC4 = 2
)
```

**Create `internal/protocol/nfs/v4/handlers/create.go`:**

Implement `handleCreate`:
- `RequireCurrentFH` guard
- If pseudo-fs handle: return `NFS4ERR_ROFS` (pseudo-fs is read-only)
- Decode CREATE4args:
  1. `objtype` (uint32): the createtype4 value
  2. Type-specific data:
     - For NF4LNK (symlink): decode `linkdata` as XDR string (the symlink target)
     - For NF4BLK/NF4CHR: decode `specdata` as two uint32s (major, minor) -- return NFS4ERR_NOTSUPP for now
     - For NF4SOCK/NF4FIFO: no type-specific data -- return NFS4ERR_NOTSUPP for now
     - For NF4DIR: no type-specific data
  3. `objname` (component4 = XDR string): name of the new entry
  4. `createattrs` (fattr4): bitmap + opaque attr values -- decode bitmap, skip opaque for now (use default attrs)
- Validate UTF-8 filename via `types.ValidateUTF8Filename(objname)`
- Build auth context via `h.buildV4AuthContext(ctx, ctx.CurrentFH)`
- Get pre-operation parent attributes for change_info (call `metaSvc.GetFile` for parent ctime before create)
- For NF4DIR: call `metaSvc.CreateDirectory(authCtx, metadata.FileHandle(ctx.CurrentFH), objname, defaultAttr)` where defaultAttr has mode 0o755 and UID/GID from auth context
- For NF4LNK: call `metaSvc.CreateSymlink(authCtx, metadata.FileHandle(ctx.CurrentFH), objname, linkTarget, defaultAttr)` where defaultAttr has mode 0o777
- Get post-operation parent attributes for change_info
- Set `ctx.CurrentFH` to the new entry's file handle (copy-on-set)
- Encode CREATE4resok:
  1. NFS4_OK status
  2. change_info4 via `encodeChangeInfo4(buf, true, beforeCtime, afterCtime)` using parent dir ctime as changeid
  3. attrset (bitmap4): encode empty bitmap (no attrs set by server from createattrs)
- Map errors via `types.MapMetadataErrorToNFS4`

**Create `internal/protocol/nfs/v4/handlers/remove.go`:**

Implement `handleRemove`:
- `RequireCurrentFH` guard
- If pseudo-fs handle: return `NFS4ERR_ROFS`
- Decode REMOVE4args: `target` component4 (XDR string)
- Validate UTF-8 via `types.ValidateUTF8Filename(target)`
- Build auth context via `h.buildV4AuthContext(ctx, ctx.CurrentFH)`
- Get pre-operation parent attributes for change_info
- First try `metaSvc.RemoveFile(authCtx, metadata.FileHandle(ctx.CurrentFH), target)`:
  - If succeeds: file was removed
  - If error is "is a directory" or similar: try `metaSvc.RemoveDirectory(authCtx, metadata.FileHandle(ctx.CurrentFH), target)` instead
- Get post-operation parent attributes for change_info
- Encode REMOVE4resok:
  1. NFS4_OK status
  2. change_info4 via `encodeChangeInfo4(buf, true, beforeCtime, afterCtime)`
- Map errors via `types.MapMetadataErrorToNFS4`

**Update `handler.go`:** Register both handlers:
```go
h.opDispatchTable[types.OP_CREATE] = h.handleCreate
h.opDispatchTable[types.OP_REMOVE] = h.handleRemove
```

**Create `internal/protocol/nfs/v4/handlers/create_remove_test.go`:**
- Test CREATE directory (NF4DIR): verify success, new FH set, change_info present
- Test CREATE symlink (NF4LNK): verify success with link target
- Test CREATE on pseudo-fs: verify NFS4ERR_ROFS
- Test CREATE with invalid name: verify NFS4ERR_BADCHAR or NFS4ERR_BADNAME
- Test CREATE unsupported type (NF4BLK): verify NFS4ERR_NOTSUPP
- Test REMOVE file: verify success, change_info present
- Test REMOVE directory: verify success
- Test REMOVE on pseudo-fs: verify NFS4ERR_ROFS
- Test REMOVE nonexistent: verify NFS4ERR_NOENT
  </action>
  <verify>
Run `go build ./...` and `go test ./internal/protocol/nfs/v4/... -count=1 -race -v` -- all pass including create_remove_test.go.
  </verify>
  <done>
CREATE handler creates directories and symlinks via MetadataService delegation. REMOVE handler deletes files and directories. Both return change_info4 for cache coherency. Block/char/socket/fifo types return NOTSUPP (not supported by DittoFS metadata layer). Constants for OPEN, stability, delegation, and claim types added for Plan 07-03.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` succeeds
2. `go test ./internal/protocol/nfs/v4/... -count=1 -race` passes
3. `go vet ./internal/protocol/nfs/v4/...` reports no issues
4. CREATE correctly rejects regular file creation (NF4REG) -- regular files go through OPEN
5. REMOVE handles both files and directories
6. change_info4 encoded correctly in both responses
</verification>

<success_criteria>
- CREATE with NF4DIR type creates a directory via MetadataService.CreateDirectory
- CREATE with NF4LNK type creates a symlink via MetadataService.CreateSymlink
- CREATE on pseudo-fs returns NFS4ERR_ROFS
- REMOVE deletes files via MetadataService.RemoveFile
- REMOVE deletes empty directories via MetadataService.RemoveDirectory
- REMOVE on pseudo-fs returns NFS4ERR_ROFS
- Both operations return change_info4 with before/after changeid
- Constants for OPEN, stateid, stability added (used by Plan 07-03)
</success_criteria>

<output>
After completion, create `.planning/phases/07-nfsv4-file-operations/07-02-SUMMARY.md`
</output>
