---
phase: 29.8-ms-protocol-test-suite-ci
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - test/smb-conformance/Dockerfile.dittofs
  - test/smb-conformance/docker-compose.yml
  - test/smb-conformance/bootstrap.sh
  - test/smb-conformance/configs/memory.yaml
  - test/smb-conformance/configs/memory-fs.yaml
  - test/smb-conformance/configs/badger-fs.yaml
  - test/smb-conformance/configs/badger-s3.yaml
  - test/smb-conformance/configs/postgres-s3.yaml
  - test/smb-conformance/ptfconfig/CommonTestSuite.deployment.ptfconfig.template
  - test/smb-conformance/ptfconfig/MS-SMB2_ServerTestSuite.deployment.ptfconfig.template
  - .gitignore
autonomous: true
requirements:
  - WIN-00

must_haves:
  truths:
    - "Docker Compose brings up a DittoFS container with dfs+dfsctl binaries and a healthy SMB adapter on port 12445"
    - "ptfconfig templates produce valid XML with correct DittoFS host, port, credentials, share names, and capability flags when rendered"
    - "Bootstrap script creates WPTS-required shares (SMBBasic, SMBEncrypted) and test users via dfsctl against a running DittoFS instance"
    - "All five storage profiles (memory, memory-fs, badger-fs, badger-s3, postgres-s3) have valid DittoFS config files"
  artifacts:
    - path: "test/smb-conformance/Dockerfile.dittofs"
      provides: "Multi-stage Docker build producing dfs+dfsctl in Alpine image"
      contains: "dfsctl"
    - path: "test/smb-conformance/docker-compose.yml"
      provides: "Compose V2 services: dittofs, wpts, localstack, postgres with profiles"
      contains: "fileserver-v8"
    - path: "test/smb-conformance/bootstrap.sh"
      provides: "DittoFS share/user provisioning script for WPTS"
      contains: "SMBBasic"
    - path: "test/smb-conformance/ptfconfig/CommonTestSuite.deployment.ptfconfig.template"
      provides: "WPTS common ptfconfig template with variable placeholders"
      contains: "DITTOFS_HOST"
  key_links:
    - from: "test/smb-conformance/docker-compose.yml"
      to: "test/smb-conformance/Dockerfile.dittofs"
      via: "build context referencing Dockerfile.dittofs"
      pattern: "dockerfile.*Dockerfile.dittofs"
    - from: "test/smb-conformance/docker-compose.yml"
      to: "test/smb-conformance/configs/"
      via: "volume mount of config file"
      pattern: "configs/"
    - from: "test/smb-conformance/bootstrap.sh"
      to: "DittoFS API"
      via: "dfsctl commands to create stores, shares, users"
      pattern: "dfsctl.*share create"
---

<objective>
Create the Docker infrastructure, ptfconfig templates, bootstrap script, and DittoFS configuration files needed to run Microsoft WindowsProtocolTestSuites (WPTS) FileServer BVT tests against DittoFS.

Purpose: Establishes the foundational containers, configuration, and provisioning that the test runner (Plan 02) will orchestrate.
Output: Complete `test/smb-conformance/` directory with Docker Compose, Dockerfile, ptfconfig templates, bootstrap script, and per-profile DittoFS configs.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29.8-ms-protocol-test-suite-ci/29.8-RESEARCH.md

Key reference files:
@Dockerfile (existing production Dockerfile to extend)
@test/posix/setup-posix.sh (bootstrap pattern to follow for wait_for_api, dfsctl commands)
@test/posix/configs/config.yaml (DittoFS config file format reference)

<interfaces>
<!-- Existing DittoFS config structure (from test/posix/configs/config.yaml and docs/CONFIGURATION.md):
The DittoFS config.yaml follows this pattern:

```yaml
logging:
  level: DEBUG
  format: text

server:
  shutdown_timeout: 30s

database:
  type: sqlite
  sqlite:
    path: /data/controlplane.db

cache:
  max_size: "512MB"
  path: /data/cache
```

Stores, shares, and adapters are created at runtime via dfsctl API calls, not in config.yaml.
-->

<!-- WPTS Docker image contract:
- Image: mcr.microsoft.com/windowsprotocoltestsuites:fileserver-v8
- Volume mount: /data/fileserver (ptfconfig files + TRX output)
- Args: $filter (e.g., "TestCategory=BVT"), $dryRun ("" or "y")
- Output: .trx files written to /data/fileserver
- Hostname: must be set (--hostname FS-CLI)
-->

<!-- ptfconfig required properties (from research):
- SutComputerName, SutIPAddress, TransportPort (network)
- AdminUserName, NonAdminUserName, PasswordForAllUsers (auth)
- BasicFileShare, EncryptedFileShare (shares)
- MaxSmbVersionSupported=Smb21, Platform=NonWindows (capabilities)
- SupportedSecurityPackage=Ntlm, DomainName=SutComputerName (workgroup mode)
-->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dockerfile.dittofs, Docker Compose, and DittoFS config files</name>
  <files>
    test/smb-conformance/Dockerfile.dittofs
    test/smb-conformance/docker-compose.yml
    test/smb-conformance/configs/memory.yaml
    test/smb-conformance/configs/memory-fs.yaml
    test/smb-conformance/configs/badger-fs.yaml
    test/smb-conformance/configs/badger-s3.yaml
    test/smb-conformance/configs/postgres-s3.yaml
    .gitignore
  </files>
  <action>
    **Dockerfile.dittofs** — Create `test/smb-conformance/Dockerfile.dittofs` extending the production Dockerfile pattern:
    - Multi-stage build: `golang:1.25-alpine` builder + `alpine:3.21` runtime
    - Builder stage: `go mod download`, then build BOTH `dfs` and `dfsctl` binaries (`CGO_ENABLED=0`)
    - Runtime stage: copy both binaries to `/app/`, install `ca-certificates tzdata curl`
    - Create non-root user (65532:65532 dittofs), data dirs `/data/metadata /data/content /data/cache /config`
    - EXPOSE `12445/tcp 8080/tcp`
    - HEALTHCHECK using `wget --no-verbose --tries=1 --spider http://localhost:8080/health/ready` (interval=2s, timeout=5s, start_period=5s, retries=15)
    - ENTRYPOINT `["/app/dfs"]`, CMD `["start", "--foreground", "--config", "/config/config.yaml"]`
    - Build context is `../..` (repo root) so all Go sources are available

    **docker-compose.yml** — Create `test/smb-conformance/docker-compose.yml` (Compose V2 format, NO `version:` key):

    Services:
    1. `dittofs`: Build from Dockerfile.dittofs (context: `../..`, dockerfile: `test/smb-conformance/Dockerfile.dittofs`). Mount `./configs/${PROFILE:-memory}.yaml:/config/config.yaml:ro`, named volume `dittofs-data:/data`. Ports `12445:12445`, `8080:8080`. Environment: `DITTOFS_LOGGING_LEVEL=DEBUG`, `DITTOFS_CONTROLPLANE_SECRET=${DITTOFS_CONTROLPLANE_SECRET:-TestPassword01!}`. Healthcheck: wget to `http://localhost:8080/health/ready` (interval=2s, timeout=5s, retries=15, start_period=5s).

    2. `wpts`: Image `mcr.microsoft.com/windowsprotocoltestsuites:fileserver-v8`. `depends_on: dittofs: condition: service_healthy`. Volumes: `./ptfconfig-generated:/data/fileserver`. Use `network_mode: "service:dittofs"` to share network namespace (so localhost in ptfconfig points to DittoFS). Command: `["${WPTS_FILTER:-TestCategory=BVT}", ""]`. Profiles: `["test"]` (only started when explicitly requested via `--profile test`).

    3. `localstack`: Image `localstack/localstack:4.13.1`. Environment: `SERVICES=s3`, `EAGER_SERVICE_LOADING=1`. Healthcheck: curl to `http://localhost:4566/_localstack/health`. Profiles: `["s3"]`.

    4. `postgres`: Image `postgres:16-alpine`. Environment: standard postgres vars (user=dittofs, password=dittofs, database=dittofs_test). Healthcheck: pg_isready. Profiles: `["postgres"]`.

    Define named volume `dittofs-data`.

    **DittoFS config files** — Create 5 profile configs under `test/smb-conformance/configs/`:
    - All share: `logging.level: DEBUG`, `logging.format: text`, `server.shutdown_timeout: 30s`, `database.type: sqlite`, `database.sqlite.path: /data/controlplane.db`, `cache.max_size: "256MB"`, `cache.path: /data/cache`
    - `memory.yaml`: No special store config (bootstrap creates memory/memory stores via API)
    - `memory-fs.yaml`: Same base (bootstrap creates memory metadata + filesystem payload via API)
    - `badger-fs.yaml`: Same base (bootstrap creates badger metadata + filesystem payload via API)
    - `badger-s3.yaml`: Same base (bootstrap creates badger metadata + S3 payload via API)
    - `postgres-s3.yaml`: Same base (bootstrap creates postgres metadata + S3 payload via API)
    Note: Stores are created at runtime via dfsctl, NOT in config.yaml. The config files only differ in documentation comments about which stores the bootstrap will create.

    **.gitignore** — Append to the project `.gitignore` (if not already present):
    ```
    # SMB Conformance test results
    test/smb-conformance/results/
    test/smb-conformance/ptfconfig-generated/
    ```
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs-smb-suite && test -f test/smb-conformance/Dockerfile.dittofs && test -f test/smb-conformance/docker-compose.yml && test -f test/smb-conformance/configs/memory.yaml && test -f test/smb-conformance/configs/memory-fs.yaml && test -f test/smb-conformance/configs/badger-fs.yaml && test -f test/smb-conformance/configs/badger-s3.yaml && test -f test/smb-conformance/configs/postgres-s3.yaml && grep -q "smb-conformance/results" .gitignore && echo "PASS"</automated>
  </verify>
  <done>Dockerfile.dittofs builds both dfs+dfsctl. docker-compose.yml defines dittofs, wpts, localstack, postgres services with profiles. Five DittoFS config files exist for all storage profiles. Results and generated ptfconfig directories are gitignored.</done>
</task>

<task type="auto">
  <name>Task 2: Create ptfconfig templates and bootstrap script</name>
  <files>
    test/smb-conformance/ptfconfig/CommonTestSuite.deployment.ptfconfig.template
    test/smb-conformance/ptfconfig/MS-SMB2_ServerTestSuite.deployment.ptfconfig.template
    test/smb-conformance/bootstrap.sh
  </files>
  <action>
    **ptfconfig templates** — Create two XML template files under `test/smb-conformance/ptfconfig/`:

    1. `CommonTestSuite.deployment.ptfconfig.template`:
    XML with namespace `http://schemas.microsoft.com/windows/ProtocolsTest/2007/07/TestConfig`. Key properties with `${VARIABLE}` placeholders:
    - Network: `SutComputerName=${DITTOFS_HOST}`, `SutIPAddress=${DITTOFS_HOST}`, `TransportPort=${SMB_PORT}`, `ClientNic1IPAddress=${CLIENT_IP}`, `ClientNic2IPAddress=`
    - Authentication (workgroup mode): `DomainName=${DITTOFS_HOST}` (same as SUT for workgroup), `DCServerComputerName=` (empty), `AdminUserName=${ADMIN_USER}`, `NonAdminUserName=${TEST_USER}`, `GuestUserName=`, `PasswordForAllUsers=${TEST_PASSWORD}`, `SupportedSecurityPackage=Ntlm`, `UseServerGssToken=true`
    - Shares: `BasicFileShare=SMBBasic`, `EncryptedFileShare=SMBEncrypted`
    - Capabilities: `Platform=NonWindows`, `MaxSmbVersionSupported=Smb21`, `MaxSmbVersionClientSupported=Smb311`, `IsEncryptionSupported=false`, `IsLeasingSupported=true`, `IsDirectoryLeasingSupported=false`, `IsPersistentHandlesSupported=false`, `IsMultiChannelCapable=false`, `IsMultiCreditSupported=true`, `IsRequireMessageSigning=false`, `SendSignedRequest=true`, `DisableVerifySignature=true`

    2. `MS-SMB2_ServerTestSuite.deployment.ptfconfig.template`:
    XML that includes CommonTestSuite via `<Include>` element. Set any SMB2-specific overrides. This is largely a wrapper around the common config. Include placeholders for any SMB2-specific properties as needed.

    **Use `envsubst` for rendering**: The run.sh script (Plan 02) will set environment variables and run `envsubst < template > output` to produce the final ptfconfig files in `ptfconfig-generated/`.

    **bootstrap.sh** — Create `test/smb-conformance/bootstrap.sh` (chmod +x):
    - `set -euo pipefail`
    - Accept env vars: `DFSCTL` (default: `dfsctl`), `API_URL` (default: `http://localhost:8080`), `ADMIN_PASSWORD` (default: from `DITTOFS_CONTROLPLANE_SECRET`), `TEST_PASSWORD` (default: `TestPassword01!`), `PROFILE` (default: `memory`)
    - `wait_for_ready()`: Poll `${API_URL}/health/ready` every 1s for up to 30 seconds (matching posix setup-posix.sh pattern)
    - `wait_for_smb()`: After stores/shares/adapters are created, poll the SMB port (12445) with `nc` or `/dev/tcp` for up to 15 seconds to confirm SMB adapter is listening
    - Login as admin: `$DFSCTL login --server "$API_URL" --username admin --password "$ADMIN_PASSWORD"`
    - Create metadata store based on PROFILE:
      - `memory*`: `--type memory`
      - `badger*`: `--type badger --config '{"db_path":"/data/metadata"}'`
      - `postgres*`: `--type postgres --config '{"host":"postgres","port":5432,"user":"dittofs","password":"dittofs","database":"dittofs_test","sslmode":"disable"}'`
    - Create payload store based on PROFILE:
      - `*memory` (memory profile): `--type memory`
      - `*-fs`: `--type filesystem --config '{"path":"/data/content"}'`
      - `*-s3`: `--type s3 --config '{"bucket":"dittofs-test","region":"us-east-1","endpoint":"http://localstack:4566","force_path_style":true}'`
    - Create WPTS-required shares: `$DFSCTL share create --name /SMBBasic --metadata default --payload default` and `$DFSCTL share create --name /SMBEncrypted --metadata default --payload default`
    - Create test users: `$DFSCTL user create --username wpts-admin --password "$TEST_PASSWORD"` and `$DFSCTL user create --username nonadmin --password "$TEST_PASSWORD"`
    - Enable SMB adapter: `$DFSCTL adapter enable smb --port 12445`
    - Call `wait_for_smb()` to confirm SMB port is accepting connections
    - Print summary: "Bootstrap complete: shares=SMBBasic,SMBEncrypted users=wpts-admin,nonadmin adapter=smb:12445"
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs-smb-suite && test -f test/smb-conformance/ptfconfig/CommonTestSuite.deployment.ptfconfig.template && test -f test/smb-conformance/ptfconfig/MS-SMB2_ServerTestSuite.deployment.ptfconfig.template && test -x test/smb-conformance/bootstrap.sh && grep -q 'DITTOFS_HOST' test/smb-conformance/ptfconfig/CommonTestSuite.deployment.ptfconfig.template && grep -q 'SMBBasic' test/smb-conformance/bootstrap.sh && grep -q 'wait_for_ready' test/smb-conformance/bootstrap.sh && echo "PASS"</automated>
  </verify>
  <done>ptfconfig templates contain all required WPTS properties with variable placeholders for network, auth, shares, and capabilities. Bootstrap script creates stores, shares, and users matching WPTS expectations, works in both Docker Compose mode (dfsctl inside container) and local mode (dfsctl on host).</done>
</task>

</tasks>

<verification>
1. All files exist under `test/smb-conformance/`: Dockerfile.dittofs, docker-compose.yml, bootstrap.sh, 5 config files, 2 ptfconfig templates
2. docker-compose.yml is valid YAML (no `version:` key, proper service definitions)
3. ptfconfig templates contain all required WPTS properties from the research (SutComputerName, TransportPort, auth, shares, capabilities)
4. bootstrap.sh is executable and contains all required dfsctl commands (store, share, user, adapter)
5. .gitignore contains entries for results/ and ptfconfig-generated/
</verification>

<success_criteria>
- Docker infrastructure ready for test runner to orchestrate (Dockerfile builds both binaries, Compose defines all services)
- ptfconfig templates can be rendered with envsubst to produce valid WPTS configuration
- Bootstrap script provisions DittoFS with WPTS-compatible shares, users, and SMB adapter
- All five storage profiles have valid DittoFS configuration files
</success_criteria>

<output>
After completion, create `.planning/phases/29.8-ms-protocol-test-suite-ci/29.8-01-SUMMARY.md`
</output>
