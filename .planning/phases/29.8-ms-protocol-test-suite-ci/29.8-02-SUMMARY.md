---
phase: 29.8-ms-protocol-test-suite-ci
plan: 02
subsystem: testing
tags: [smb, wpts, ci, github-actions, trx-parser, conformance, xmlstarlet]

# Dependency graph
requires:
  - phase: 29.8-01
    provides: Docker infrastructure (Dockerfile.dittofs, docker-compose.yml, bootstrap.sh, ptfconfig templates, config profiles)
provides:
  - Test orchestrator (run.sh) for compose and local execution modes
  - TRX result parser (parse-results.sh) with known failure classification
  - GitHub Actions CI workflow with tiered matrix and regression detection
  - Known failures tracking (KNOWN_FAILURES.md) for intelligent CI pass/fail
  - Makefile with convenience targets for all common operations
  - README.md documenting setup, profiles, flags, results, and CI integration
affects: [smb-conformance, phase-44-smb3-conformance]

# Tech tracking
tech-stack:
  added: [xmlstarlet, github-actions-matrix]
  patterns: [tiered-ci-matrix, known-failure-classification, trx-xml-parsing, compose-local-dual-mode]

key-files:
  created:
    - test/smb-conformance/run.sh
    - test/smb-conformance/parse-results.sh
    - test/smb-conformance/KNOWN_FAILURES.md
    - test/smb-conformance/Makefile
    - test/smb-conformance/README.md
    - .github/workflows/smb-conformance.yml
  modified:
    - test/smb-conformance/docker-compose.yml

key-decisions:
  - "bootstrap.sh mounted into dittofs container as /app/bootstrap.sh:ro (docker compose exec approach)"
  - "Tiered CI matrix: memory-only on PRs, full 5-profile matrix on develop push and weekly cron"
  - "parse-results.sh exits with count of new failures (0=green, >0 = new unexpected failures)"
  - "KNOWN_FAILURES.md uses pipe-separated markdown table parsed by parse-results.sh"
  - "Weekly cron auto-creates GitHub issues on regression via gh issue create"

patterns-established:
  - "Dual-mode runner: compose (fully containerized) and local (native DittoFS + Docker WPTS)"
  - "TRX XML parsing via xmlstarlet with namespace-aware XPath queries"
  - "Known failure classification: PASS/KNOWN/FAIL/SKIP status with color coding"
  - "CI tiered matrix via fromJson conditional: fast on PR, comprehensive on push"

requirements-completed: [WIN-00]

# Metrics
duration: 4min
completed: 2026-02-26
---

# Phase 29.8 Plan 02: Test Runner, Result Parser, CI Workflow, and Documentation Summary

**run.sh orchestrator with compose/local modes, parse-results.sh TRX parser with known failure classification, GitHub Actions tiered CI matrix, and comprehensive documentation**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-26T12:59:38Z
- **Completed:** 2026-02-26T13:04:34Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments

- Test runner (run.sh) supporting compose and local modes with --profile, --filter, --keep, --dry-run, --verbose flags
- TRX XML parser (parse-results.sh) using xmlstarlet to classify test outcomes as PASS/KNOWN/FAIL/SKIP with colored output
- GitHub Actions workflow with tiered matrix (memory on PRs, all 5 profiles on develop/cron), weekly regression detection with auto-issue creation
- KNOWN_FAILURES.md with initial expected failures for SMB3 negotiation, encryption, multi-channel, durable handles, and QUIC
- Makefile with 9 convenience targets and comprehensive README.md

## Task Commits

Each task was committed atomically:

1. **Task 1: run.sh orchestrator and parse-results.sh TRX parser** - `f83fd88b` (feat)
2. **Task 2: KNOWN_FAILURES.md, Makefile, README.md, and CI workflow** - `9a809f64` (feat)

## Files Created/Modified

- `test/smb-conformance/run.sh` - Main orchestrator with compose/local modes and all CLI flags
- `test/smb-conformance/parse-results.sh` - TRX XML parser with known failure classification
- `test/smb-conformance/KNOWN_FAILURES.md` - Expected test failures tracking (9 initial entries)
- `test/smb-conformance/Makefile` - Convenience targets (test, test-quick, test-full, build, clean, etc.)
- `test/smb-conformance/README.md` - Setup guide, profiles, flags, results interpretation, CI docs
- `.github/workflows/smb-conformance.yml` - Tiered CI with path triggers, matrix, weekly cron
- `test/smb-conformance/docker-compose.yml` - Added bootstrap.sh volume mount to dittofs service

## Decisions Made

- Mount bootstrap.sh into dittofs container as read-only volume for docker compose exec bootstrap approach
- Tiered CI: memory-only on PRs (fast feedback), full 5-profile matrix on develop push and weekly cron
- parse-results.sh exit code is the count of new failures (0 = CI green)
- KNOWN_FAILURES.md uses markdown table format parsed by pipe-separated field extraction
- Weekly cron failures auto-create GitHub issues with bug/smb/conformance labels

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Added bootstrap.sh volume mount to docker-compose.yml**
- **Found during:** Task 1 (run.sh orchestrator)
- **Issue:** Plan noted docker-compose.yml needed `./bootstrap.sh:/app/bootstrap.sh:ro` mount for run.sh exec approach
- **Fix:** Added volume mount to dittofs service in docker-compose.yml
- **Files modified:** test/smb-conformance/docker-compose.yml
- **Verification:** Volume mount present in compose file
- **Committed in:** f83fd88b (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Necessary for run.sh to bootstrap DittoFS via docker compose exec. No scope creep.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Complete SMB conformance test infrastructure ready for use
- Run `make test` or `./run.sh --profile memory` for first test execution
- KNOWN_FAILURES.md will need updating after first WPTS run with actual test names
- GitHub Actions workflow will trigger on next PR touching SMB adapter paths

## Self-Check: PASSED

All 7 files verified present. Both task commits (f83fd88b, 9a809f64) verified in git log.

---
*Phase: 29.8-ms-protocol-test-suite-ci*
*Completed: 2026-02-26*
