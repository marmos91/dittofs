---
phase: 29.8-ms-protocol-test-suite-ci
plan: 01
subsystem: testing
tags: [docker, compose, smb, wpts, ptfconfig, conformance]

# Dependency graph
requires: []
provides:
  - Docker infrastructure for running WPTS SMB conformance tests
  - Dockerfile building both dfs and dfsctl binaries
  - Docker Compose with DittoFS, WPTS, Localstack, PostgreSQL services
  - ptfconfig templates for WPTS configuration via envsubst
  - Bootstrap script provisioning stores, shares, users, SMB adapter
  - Five storage profile configurations (memory, memory-fs, badger-fs, badger-s3, postgres-s3)
affects: [29.8-02, smb-conformance]

# Tech tracking
tech-stack:
  added: [mcr.microsoft.com/windowsprotocoltestsuites:fileserver-v8, localstack:4.13.1, postgres:16-alpine]
  patterns: [docker-compose-profiles, ptfconfig-envsubst-templates, profile-based-store-creation]

key-files:
  created:
    - test/smb-conformance/Dockerfile.dittofs
    - test/smb-conformance/docker-compose.yml
    - test/smb-conformance/bootstrap.sh
    - test/smb-conformance/configs/memory.yaml
    - test/smb-conformance/configs/memory-fs.yaml
    - test/smb-conformance/configs/badger-fs.yaml
    - test/smb-conformance/configs/badger-s3.yaml
    - test/smb-conformance/configs/postgres-s3.yaml
    - test/smb-conformance/ptfconfig/CommonTestSuite.deployment.ptfconfig.template
    - test/smb-conformance/ptfconfig/MS-SMB2_ServerTestSuite.deployment.ptfconfig.template
  modified:
    - .gitignore

key-decisions:
  - "network_mode: service:dittofs for WPTS to share DittoFS network namespace (localhost resolution)"
  - "Compose profiles (test, s3, postgres) for optional service activation"
  - "envsubst-based ptfconfig template rendering (variables: DITTOFS_HOST, SMB_PORT, CLIENT_IP, etc.)"
  - "DITTOFS_CONTROLPLANE_SECRET env var for deterministic admin password (no log parsing)"
  - "Bootstrap creates stores at runtime via dfsctl API (config.yaml only has base settings)"

patterns-established:
  - "Profile-based bootstrap: PROFILE env var selects metadata/payload store type combinations"
  - "ptfconfig template pattern: XML templates with ${VAR} placeholders rendered by envsubst"
  - "wait_for_smb: post-adapter-enable port polling to confirm SMB readiness"

requirements-completed: [WIN-00]

# Metrics
duration: 3min
completed: 2026-02-26
---

# Phase 29.8 Plan 01: Docker Infrastructure and WPTS Configuration Summary

**Docker Compose orchestration with Dockerfile.dittofs (dfs+dfsctl), WPTS fileserver-v8, ptfconfig templates, and profile-aware bootstrap for SMB conformance testing**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-26T12:53:16Z
- **Completed:** 2026-02-26T12:56:36Z
- **Tasks:** 2
- **Files modified:** 11

## Accomplishments

- Multi-stage Dockerfile producing both dfs and dfsctl binaries in Alpine runtime image with healthcheck
- Docker Compose V2 with four services (dittofs, wpts, localstack, postgres) using profiles for optional activation
- Two ptfconfig XML templates with full WPTS property coverage (network, auth, shares, capabilities) using envsubst variables
- Bootstrap script handling profile-aware store creation, WPTS share provisioning, user creation, and SMB adapter enablement with readiness polling
- Five DittoFS config files covering all storage profile combinations

## Task Commits

Each task was committed atomically:

1. **Task 1: Dockerfile.dittofs, Docker Compose, and DittoFS config files** - `d92a27fa` (feat)
2. **Task 2: ptfconfig templates and bootstrap script** - `918eeeba` (feat)

## Files Created/Modified

- `test/smb-conformance/Dockerfile.dittofs` - Multi-stage Docker build for dfs+dfsctl
- `test/smb-conformance/docker-compose.yml` - Compose V2 with DittoFS, WPTS, Localstack, PostgreSQL
- `test/smb-conformance/bootstrap.sh` - DittoFS provisioning script (stores, shares, users, adapter)
- `test/smb-conformance/configs/memory.yaml` - Memory/memory profile config
- `test/smb-conformance/configs/memory-fs.yaml` - Memory/filesystem profile config
- `test/smb-conformance/configs/badger-fs.yaml` - BadgerDB/filesystem profile config
- `test/smb-conformance/configs/badger-s3.yaml` - BadgerDB/S3 profile config
- `test/smb-conformance/configs/postgres-s3.yaml` - PostgreSQL/S3 profile config
- `test/smb-conformance/ptfconfig/CommonTestSuite.deployment.ptfconfig.template` - Common WPTS settings
- `test/smb-conformance/ptfconfig/MS-SMB2_ServerTestSuite.deployment.ptfconfig.template` - SMB2-specific settings
- `.gitignore` - Added entries for results/ and ptfconfig-generated/

## Decisions Made

- Used `network_mode: "service:dittofs"` for WPTS container so localhost in ptfconfig resolves to DittoFS (shared network namespace)
- Compose profiles (`test`, `s3`, `postgres`) keep optional services inactive by default
- envsubst template rendering chosen for ptfconfig (simple, no extra dependencies)
- DITTOFS_CONTROLPLANE_SECRET env var used for deterministic admin password in Docker
- Config YAML files are identical (base settings only); profile-specific stores created via bootstrap API calls

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Docker infrastructure ready for Plan 02 (test runner script, results parser, GitHub Actions workflow)
- ptfconfig templates ready for envsubst rendering in run.sh
- Bootstrap script ready for orchestration by run.sh in both Docker Compose and local modes

## Self-Check: PASSED

All 11 created files verified present. Both task commits (d92a27fa, 918eeeba) verified in git log.

---
*Phase: 29.8-ms-protocol-test-suite-ci*
*Completed: 2026-02-26*
