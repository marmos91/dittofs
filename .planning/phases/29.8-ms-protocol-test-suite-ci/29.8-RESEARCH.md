# Phase 29.8: Microsoft Protocol Test Suite CI Integration - Research

**Researched:** 2026-02-26
**Domain:** CI/CD, Docker orchestration, Microsoft WindowsProtocolTestSuites, SMB2 conformance testing
**Confidence:** HIGH

## Summary

This phase integrates the Microsoft WindowsProtocolTestSuites (WPTS) FileServer Docker image into DittoFS CI, running MS-SMB2 BVT (Build Verification Tests) against DittoFS on a custom SMB port. The core deliverables are: a `test/smb-conformance/` directory with Docker Compose orchestration, a bootstrap script, ptfconfig templates, a test runner (`run.sh`), a GitHub Actions workflow, and a known-failures tracking mechanism.

The WPTS FileServer Docker image is available at `mcr.microsoft.com/windowsprotocoltestsuites:fileserver` (and versioned tags like `fileserver-v8`). It accepts a volume mount at `/data/fileserver` containing pre-configured ptfconfig XML files, an optional filter string (e.g., `"TestCategory=BVT"`), and produces TRX (Visual Studio Test Results) XML output in the same mounted directory. The image runs on Ubuntu 20.04 with .NET and `dotnet vstest` internally.

**Primary recommendation:** Build the test infrastructure using the existing project patterns from `test/posix/` (setup/run/teardown scripts, per-profile configs, known-failures files) adapted for Docker Compose orchestration and WPTS ptfconfig XML templates with variable substitution.

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions
- **Dual mode**: Docker Compose for self-contained local runs (macOS/Windows), plus local mode where DittoFS runs natively and only WPTS is containerized (Linux/CI)
- **Reuse existing Dockerfile** (`Dockerfile` at repo root) for DittoFS container -- multi-stage Alpine build already production-ready
- **Include dfsctl** in the DittoFS Docker image (build both binaries in multi-stage build) for bootstrap
- **Full POSIX matrix profiles**: memory/memory, memory/filesystem, badger/filesystem, memory/s3, badger/s3 -- matching existing E2E store matrix
- **Localstack as Compose service** with health check for S3 profiles. PostgreSQL as Compose service for postgres profiles
- **Docker Compose V2 format** (no `version:` key)
- **Service name networking** in Compose (WPTS connects to `dittofs:port`), host IP in local mode
- **--keep flag** to leave containers running after tests for debugging
- **Script builds and starts DittoFS** in local mode (go build, start in background, wait for health, run WPTS, cleanup)
- **Minimal observability**: No Prometheus/Grafana. Logs to stdout/stderr. DittoFS debug logs always captured
- **Bash script + Makefile convenience targets**: run.sh does the real work, Makefile wraps common invocations
- **--dry-run mode**: Shows containers, config, WPTS categories, ptfconfig values without running
- **Docker volumes** for BadgerDB data directories (not tmpfs)
- **WPTS image from MCR**: Pull `mcr.microsoft.com/windowsprotocoltestsuites:fileserver` directly, pinned to specific tag
- **Match WPTS share names**: Create shares named exactly as WPTS expects (SMBBasic, SMBEncrypted, etc.)
- **SMBEncrypted share created** even though encryption isn't implemented (SMB3 = phase 39). Expect test failures, document in KNOWN_FAILURES.md. Infrastructure ready for future phases
- **Hardcoded test credentials**: Fixed username/password in bootstrap and ptfconfig. Deterministic, only used in test containers
- **Default admin + DITTOFS_CONTROLPLANE_SECRET env var**: DittoFS creates admin on first start. Bootstrap logs in as admin, creates WPTS test users
- **WPTS-compatible settings**: signing=enabled (not required), debug logging. Configured via DittoFS config.yaml
- **Same shares/users across all profiles**: Only metadata/payload store types differ per profile
- **30-second health timeout**: Poll /health/ready every 1s, fail fast if server won't start
- **Standalone bootstrap script**: Separate from Docker entrypoint. Runs after DittoFS is healthy. Works in both Compose and local mode
- **Summary table with all test names**: List every test with pass/fail/skip status. Color-coded: RED for new failures, YELLOW for known failures, GREEN for passes
- **KNOWN_FAILURES.md**: Markdown file listing test names, failure reason, and linked GitHub issue. Script compares results against this list
- **Exit 0 when only known failures**: CI passes (green) as long as no NEW unexpected failures appear
- **Timestamped results directory**: `results/YYYY-MM-DD_HHMMSS/` with TRX file, DittoFS logs, summary. Gitignored
- **DittoFS logs always captured**: Copied to results directory regardless of pass/fail
- **GitHub Actions artifacts**: Upload full results directory (TRX + logs + summary)
- **TRX XML parsing**: Parse WPTS output to generate terminal summary table
- **Full BVT by default**: Run all BVT tests unless --filter or --category passed
- **Separate workflow file**: `.github/workflows/smb-conformance.yml`
- **Path-scoped PR triggers**: `pkg/adapter/smb/**`, `internal/adapter/smb/**`, `test/smb-conformance/**`, `pkg/adapter/base.go`, `.github/workflows/smb-conformance.yml`
- **Tiered profiles**: memory/memory in PR checks, full matrix on push to develop
- **Weekly cron**: Full matrix run against develop for regression detection
- **30-minute timeout**
- **ubuntu-latest runner**
- **Docker Compose mode in CI**: docker compose up, self-contained and reproducible
- **cancel-in-progress concurrency**: New push cancels running suite for same PR
- **GH Actions Docker layer cache**: Using actions/cache or docker/build-push-action cache
- **PR comment on failure only**: Post summary table when new failures detected
- **Auto-create GH issue on regression**: Weekly run creates issue when new failures not in KNOWN_FAILURES.md
- **Location**: `test/smb-conformance/` (parallel to test/e2e/ and test/posix/)
- **Documentation**: README.md (setup, running locally, dev guide for iterating on failures) + KNOWN_FAILURES.md
- **ptfconfig template**: `ptfconfig.template` with `${DITTOFS_HOST}`, `${SMB_PORT}`, etc. Bootstrap generates final ptfconfig
- **Static config files per profile**: `configs/memory.yaml`, `configs/badger-fs.yaml`, etc. Script selects by --profile flag
- **--profile flag with PROFILE env fallback**: `--profile memory|badger-fs|badger-s3|postgres-s3`. Default: memory
- **WPTS image pinned to specific tag**: Reproducible builds, explicit version bumps
- **Phase 44 updated**: Add note that SMB3 conformance testing extends this infrastructure

### Claude's Discretion
- SMB port selection (12445 vs 445) within container network
- Bootstrap script placement (standalone vs entrypoint wrapper) -- user said "whatever is cleaner"
- Exact Makefile target names and flags
- NUnit XML parsing approach (bash/awk vs lightweight tool) -- note: WPTS actually outputs TRX, not NUnit
- Docker Compose service names and network configuration details

### Deferred Ideas (OUT OF SCOPE)
- **Makefile targets for all test suites** (e2e, posix, smb-conformance) -- captured as GitHub issue #206
- **NFS E2E/POSIX CI optimization** (scoped triggers + tiered matrix matching this pattern) -- captured as GitHub issue #207
- **SMB3 encryption support** -- Phase 39 (SMB3 Security & Encryption)
- **SMB3 conformance testing** -- Phase 44 (extends this infrastructure)
</user_constraints>

<phase_requirements>
## Phase Requirements

| ID | Description | Research Support |
|----|-------------|-----------------|
| WIN-00 | Test infrastructure for SMB conformance validation | Full research: Docker image details, ptfconfig structure, filter syntax, TRX output parsing, CI patterns from existing posix/e2e workflows |
</phase_requirements>

## Standard Stack

### Core

| Tool | Version | Purpose | Why Standard |
|------|---------|---------|--------------|
| `mcr.microsoft.com/windowsprotocoltestsuites:fileserver` | `fileserver-v8` (pin this) | MS-SMB2 BVT conformance tests | Official Microsoft Docker image, MIT license, industry standard for SMB2/3 conformance |
| Docker Compose V2 | Latest (no `version:` key) | Multi-container orchestration | Project decision; standard for local + CI test orchestration |
| Bash | 5.x | Test runner script | Consistent with existing `test/posix/run-posix.sh` and `test/e2e/run-e2e.sh` patterns |
| GitHub Actions | ubuntu-latest | CI execution | Existing project CI platform (posix-tests.yml, e2e-tests.yml patterns) |

### Supporting

| Tool | Version | Purpose | When to Use |
|------|---------|---------|-------------|
| xmllint / xmlstarlet | System package | TRX XML parsing for summary table | Parsing test results from WPTS output |
| `dorny/test-reporter` | v1 | GitHub PR check annotations | Optional: for rendering TRX results as GitHub Check Run annotations |
| `actions/cache` | v4 | Docker layer caching in CI | Every CI run to speed up DittoFS image builds |
| Localstack | 4.13.1 | S3 emulation for S3-profile tests | S3 store profiles only (memory/s3, badger/s3) |
| PostgreSQL | 16-alpine | Control plane database for postgres profiles | PostgreSQL store profiles only |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| xmllint for TRX parsing | Python script with xml.etree | More capable but adds Python dependency; xmllint is lighter and available via apt |
| `fileserver` (latest) tag | `fileserver-v8` (pinned) | Latest tracks HEAD and can break CI unexpectedly; pinning ensures reproducibility |
| Host networking in Docker | Bridge network with port mapping | Host network simpler but conflicts if port 445 already in use; bridge with custom port is safer |

## Architecture Patterns

### Recommended Project Structure

```
test/smb-conformance/
├── run.sh                          # Main orchestrator (bash)
├── bootstrap.sh                    # DittoFS setup: login, create stores/shares/users
├── parse-results.sh                # TRX XML parser -> summary table
├── Makefile                        # Convenience targets
├── docker-compose.yml              # Compose V2 (DittoFS + WPTS + optional services)
├── Dockerfile.dittofs              # Extended from root Dockerfile, adds dfsctl
├── ptfconfig/
│   ├── CommonTestSuite.deployment.ptfconfig.template   # Template with variable substitution
│   └── MS-SMB2_ServerTestSuite.deployment.ptfconfig.template
├── configs/
│   ├── memory.yaml                 # DittoFS config for memory/memory profile
│   ├── badger-fs.yaml              # DittoFS config for badger/filesystem profile
│   ├── badger-s3.yaml              # DittoFS config for badger/s3 profile
│   └── memory-fs.yaml              # DittoFS config for memory/filesystem profile
├── results/                        # Gitignored timestamped results
├── KNOWN_FAILURES.md               # Expected failures with issue references
└── README.md                       # Setup guide, local run instructions
```

### Pattern 1: Docker Compose Dual-Mode Orchestration

**What:** The `run.sh` script supports two modes: Docker Compose (all containers) and local (DittoFS native + WPTS container only).

**When to use:** Docker Compose for CI and cross-platform local testing. Local mode for rapid iteration when developing DittoFS.

**Example:**
```bash
# Docker Compose mode (default in CI)
./run.sh --profile memory --mode compose

# Local mode (DittoFS built and run natively)
./run.sh --profile memory --mode local

# With filter
./run.sh --profile memory --filter "TestCategory=BVT"

# Dry run
./run.sh --profile memory --dry-run

# Keep containers running for debugging
./run.sh --profile memory --keep
```

### Pattern 2: ptfconfig Template Variable Substitution

**What:** The WPTS ptfconfig files are XML with property values that must match the test environment. Use template files with shell variable markers, then `envsubst` or `sed` to generate final ptfconfig.

**When to use:** Always. The ptfconfig must reflect the current DittoFS host, port, credentials, and share names.

**Key ptfconfig properties that MUST be configured** (from source analysis of `CommonTestSuite.deployment.ptfconfig`):
```xml
<!-- Network -->
<Property name="SutComputerName" value="${DITTOFS_HOST}"/>
<Property name="SutIPAddress" value="${DITTOFS_HOST}"/>
<Property name="TransportPort" value="${SMB_PORT}"/>
<Property name="ClientNic1IPAddress" value="${CLIENT_IP}"/>
<Property name="ClientNic2IPAddress" value=""/>

<!-- Authentication (Workgroup mode) -->
<Property name="DomainName" value="${DITTOFS_HOST}"/>  <!-- Set to SutComputerName for workgroup -->
<Property name="DCServerComputerName" value=""/>       <!-- Empty for workgroup -->
<Property name="AdminUserName" value="${ADMIN_USER}"/>
<Property name="NonAdminUserName" value="${TEST_USER}"/>
<Property name="GuestUserName" value=""/>
<Property name="PasswordForAllUsers" value="${TEST_PASSWORD}"/>
<Property name="SupportedSecurityPackage" value="Ntlm"/>  <!-- NTLM for workgroup -->

<!-- Shares -->
<Property name="BasicFileShare" value="SMBBasic"/>
<Property name="EncryptedFileShare" value="SMBEncrypted"/>

<!-- Capabilities (match DittoFS current state) -->
<Property name="Platform" value="NonWindows"/>
<Property name="MaxSmbVersionSupported" value="Smb21"/>   <!-- DittoFS current: SMB 2.1 -->
<Property name="MaxSmbVersionClientSupported" value="Smb311"/>
<Property name="IsEncryptionSupported" value="false"/>
<Property name="IsLeasingSupported" value="true"/>
<Property name="IsDirectoryLeasingSupported" value="false"/>
<Property name="IsPersistentHandlesSupported" value="false"/>
<Property name="IsMultiChannelCapable" value="false"/>
<Property name="IsMultiCreditSupported" value="true"/>
<Property name="IsRequireMessageSigning" value="false"/>  <!-- signing=enabled but not required -->
<Property name="SendSignedRequest" value="true"/>
<Property name="DisableVerifySignature" value="true"/>
```

### Pattern 3: Known Failures Tracking

**What:** A KNOWN_FAILURES.md file that doubles as machine-readable data. The parse-results script reads it to distinguish expected vs unexpected failures.

**When to use:** Always. CI exits 0 when all failures are known, exits 1 on new regressions.

**Format** (matching posix test pattern):
```markdown
# Known Failures - SMB Conformance (WPTS BVT)

| Test Name | Category | Reason | Issue |
|-----------|----------|--------|-------|
| BVT_Encryption_... | Encryption | SMB3 encryption not implemented (Phase 39) | #NNN |
| BVT_SMB2Basic_QuicTransport_... | QUIC | QUIC transport not supported | #NNN |
```

The script extracts test names from column 1 and compares against TRX results.

### Pattern 4: TRX Result Parsing

**What:** WPTS produces TRX (Visual Studio Test Results) XML files. Parse the `<Counters>` element for totals and iterate `<UnitTestResult>` elements for per-test outcomes.

**TRX XML structure:**
```xml
<TestRun xmlns="http://microsoft.com/schemas/VisualStudio/TeamTest/2010">
  <ResultSummary outcome="Failed">
    <Counters total="101" passed="42" failed="30" error="0"
              timeout="0" aborted="0" inconclusive="5"
              notRunnable="0" notExecuted="24"/>
  </ResultSummary>
  <Results>
    <UnitTestResult testName="BVT_SMB2Basic_QueryAndSet_FileInfo"
                    outcome="Passed" duration="00:00:03.456"/>
    <UnitTestResult testName="BVT_Encryption_..."
                    outcome="Failed" duration="00:00:01.234">
      <Output><ErrorInfo><Message>...</Message></ErrorInfo></Output>
    </UnitTestResult>
  </Results>
</TestRun>
```

**Parsing approach (xmlstarlet recommended):**
```bash
# Extract counters
xmlstarlet sel -N t="http://microsoft.com/schemas/VisualStudio/TeamTest/2010" \
  -t -v "//t:Counters/@total" -o " " \
  -v "//t:Counters/@passed" -o " " \
  -v "//t:Counters/@failed" results.trx

# Extract per-test results
xmlstarlet sel -N t="http://microsoft.com/schemas/VisualStudio/TeamTest/2010" \
  -t -m "//t:UnitTestResult" \
  -v "@testName" -o "|" -v "@outcome" -n results.trx
```

### Anti-Patterns to Avoid

- **Using `--network host` in Docker Compose for all services**: This breaks container-to-container name resolution. Use a shared bridge network with service names instead. Only the WPTS container needs to reach DittoFS via service name.
- **Parsing TRX with grep/sed**: TRX is namespaced XML. Regex parsing will break on multi-line attributes or namespace prefixes. Use xmlstarlet or xmllint with XPath.
- **Hardcoding the WPTS image as `:fileserver` (latest)**: Tags shift. Pin to `fileserver-v8` for reproducibility. Document the pinned version and how to bump it.
- **Running WPTS tests without waiting for DittoFS SMB adapter**: The bootstrap must confirm the SMB port is accepting connections, not just that the health API is up.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| TRX XML parsing | Custom regex parser | `xmlstarlet` (apt package) | TRX has XML namespaces; regex will fail on edge cases |
| Docker layer caching | Manual docker save/load | `actions/cache` + `docker/build-push-action` | Mature, handles cache keys, invalidation |
| PR comments | Custom `gh api` calls | `peter-evans/create-or-update-comment@v4` | Handles idempotent update, markdown formatting |
| Test result visualization | Custom HTML report | `dorny/test-reporter@v1` with `dotnet-trx` reporter | Creates GitHub Check Run with per-test annotations |
| Health check polling | Custom curl loop | Existing pattern from `test/posix/setup-posix.sh` `wait_for_api()` | Already proven, handles timeouts correctly |

**Key insight:** The existing `test/posix/` infrastructure provides battle-tested patterns for server lifecycle (start, health-wait, configure-via-API, test, teardown). Reuse these patterns rather than inventing new ones. The main novelty is Docker Compose orchestration and ptfconfig XML generation.

## Common Pitfalls

### Pitfall 1: WPTS Workgroup Mode Authentication

**What goes wrong:** WPTS tests fail at session setup because the authentication configuration doesn't match workgroup mode expectations.
**Why it happens:** WPTS defaults assume a domain environment (Kerberos via SPNEGO). In workgroup mode, you must explicitly configure `SupportedSecurityPackage` to `Ntlm` and set `DomainName` to the SUT computer name (not a domain). Leaving `DCServerComputerName` non-empty causes Kerberos ticket requests that fail.
**How to avoid:** Set `DomainName` = `SutComputerName`, `DCServerComputerName` = blank, `SupportedSecurityPackage` = `Ntlm`. Ensure `UseServerGssToken` = `true` for server-initiated SPNEGO.
**Warning signs:** "KRB5 error" or "SPNEGO negotiate failed" in WPTS output; all tests failing at session setup.

### Pitfall 2: WPTS Container Networking in Docker Compose

**What goes wrong:** WPTS container cannot reach DittoFS on the expected hostname/port.
**Why it happens:** Docker Compose service names resolve to container IPs within the Compose network, but `ClientNic1IPAddress` in ptfconfig must be the WPTS container's own IP (not the host IP). The `SutComputerName`/`SutIPAddress` must resolve to DittoFS from inside the WPTS container.
**How to avoid:** Use Docker Compose service name `dittofs` as `SutComputerName`. For `ClientNic1IPAddress`, use the WPTS container's IP within the Compose network (or use `--network host` for the WPTS container with `host.docker.internal` for DittoFS -- but bridge with service names is cleaner).
**Warning signs:** Connection timeouts in all tests; "No route to host" errors.

### Pitfall 3: TRX Output Location

**What goes wrong:** After running the WPTS container, the TRX file is not found where expected.
**Why it happens:** The WPTS Docker image writes TRX results into the `/data/fileserver` mount point (same directory as ptfconfig). The exact filename includes a timestamp and may vary between versions.
**How to avoid:** Mount the ptfconfig directory and look for `*.trx` files after the run completes. Use `find /path -name "*.trx" -newer /path/start_marker` to reliably locate the output.
**Warning signs:** Empty results directory; script reports 0 tests.

### Pitfall 4: DittoFS SMB Port vs TransportPort

**What goes wrong:** WPTS connects to port 445 (default) but DittoFS listens on 12445.
**Why it happens:** The default `TransportPort` in the ptfconfig is `445`. If not overridden, the test client tries the standard SMB port.
**How to avoid:** Explicitly set `TransportPort` to `12445` (or whatever DittoFS is configured to use) in the ptfconfig template.
**Warning signs:** Connection refused errors on all tests.

### Pitfall 5: MaxSmbVersionSupported Mismatch

**What goes wrong:** BVT tests targeting SMB 3.x features fail because DittoFS only supports SMB 2.1.
**Why it happens:** If `MaxSmbVersionSupported` is set to `Smb311` but DittoFS only speaks 2.1, tests will attempt SMB 3.x negotiate and fail at protocol level, not at feature level.
**How to avoid:** Set `MaxSmbVersionSupported` to the highest version DittoFS actually supports (currently `Smb21`). Many BVT tests are tagged with both `BVT` and a version category (e.g., `Smb2002`, `Smb30`). Tests tagged `Smb30`+ will still run but fail at negotiate if the server doesn't support that version -- these should be in KNOWN_FAILURES.md.
**Warning signs:** Mass failures with "STATUS_NOT_SUPPORTED" or negotiate errors.

### Pitfall 6: Dockerfile Must Build Both Binaries

**What goes wrong:** Bootstrap script cannot find `dfsctl` inside the DittoFS container.
**Why it happens:** The existing `Dockerfile` only builds `dfs` (server binary). For the bootstrap to work inside the container (Docker Compose mode), `dfsctl` must also be available.
**How to avoid:** Either extend the existing Dockerfile with a second `go build` for `dfsctl`, or create a test-specific `Dockerfile.dittofs` that builds both. The CONTEXT.md decision says "Include dfsctl in the DittoFS Docker image."
**Warning signs:** "dfsctl: not found" during bootstrap phase.

## Code Examples

### Docker Compose V2 Configuration

```yaml
# test/smb-conformance/docker-compose.yml
services:
  dittofs:
    build:
      context: ../..
      dockerfile: test/smb-conformance/Dockerfile.dittofs
    ports:
      - "12445:12445"
      - "8080:8080"
    volumes:
      - ./configs/${PROFILE:-memory}.yaml:/config/config.yaml:ro
      - dittofs-data:/data
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health/ready"]
      interval: 2s
      timeout: 5s
      retries: 15
      start_period: 5s
    environment:
      - DITTOFS_LOGGING_LEVEL=DEBUG

  wpts:
    image: mcr.microsoft.com/windowsprotocoltestsuites:fileserver-v8
    depends_on:
      dittofs:
        condition: service_healthy
    volumes:
      - ./ptfconfig-generated:/data/fileserver
      - ./results:/results
    network_mode: "service:dittofs"  # Share network namespace with dittofs
    # Filter: BVT tests only by default
    command: ["TestCategory=BVT"]
    profiles:
      - test  # Only start when explicitly requested

  localstack:
    image: localstack/localstack:4.13.1
    environment:
      SERVICES: s3
      EAGER_SERVICE_LOADING: "1"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:4566/_localstack/health"]
      interval: 5s
      timeout: 3s
      retries: 10
    profiles:
      - s3

volumes:
  dittofs-data:
```

**Note on network_mode:** Using `network_mode: "service:dittofs"` makes the WPTS container share the DittoFS network namespace, so `localhost` in ptfconfig resolves to DittoFS. Alternatively, use a shared bridge network and set `SutComputerName=dittofs` / `SutIPAddress=dittofs`.

### Dockerfile.dittofs (Extended)

```dockerfile
# test/smb-conformance/Dockerfile.dittofs
# Extends the production Dockerfile to include dfsctl for bootstrap

FROM --platform=$BUILDPLATFORM golang:1.25-alpine AS builder

ARG TARGETOS
ARG TARGETARCH
ARG VERSION=dev

RUN apk add --no-cache git ca-certificates tzdata

WORKDIR /build
COPY go.mod go.sum ./
RUN go mod download
COPY . .

# Build BOTH binaries
RUN CGO_ENABLED=0 GOOS=${TARGETOS:-linux} GOARCH=${TARGETARCH:-amd64} go build \
    -ldflags="-w -s" -o dfs cmd/dfs/main.go
RUN CGO_ENABLED=0 GOOS=${TARGETOS:-linux} GOARCH=${TARGETARCH:-amd64} go build \
    -ldflags="-w -s" -o dfsctl cmd/dfsctl/main.go

FROM alpine:3.21
RUN apk add --no-cache ca-certificates tzdata curl && \
    addgroup -g 65532 -S dittofs && \
    adduser -u 65532 -S -G dittofs -h /app dittofs

WORKDIR /app
COPY --from=builder /build/dfs /app/dfs
COPY --from=builder /build/dfsctl /app/dfsctl

RUN mkdir -p /data/metadata /data/content /data/cache /config && \
    chown -R 65532:65532 /data /config

USER 65532:65532
EXPOSE 12445/tcp 8080/tcp

HEALTHCHECK --interval=2s --timeout=5s --start-period=5s --retries=15 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8080/health/ready || exit 1

ENTRYPOINT ["/app/dfs"]
CMD ["start", "--foreground", "--config", "/config/config.yaml"]
```

### Bootstrap Script Pattern

```bash
#!/usr/bin/env bash
# test/smb-conformance/bootstrap.sh
# Configures DittoFS with WPTS-required shares and users
# Works in both Docker Compose mode (dfsctl inside container) and local mode

set -euo pipefail

DFSCTL="${DFSCTL:-dfsctl}"
API_URL="${API_URL:-http://localhost:8080}"
ADMIN_PASSWORD="${ADMIN_PASSWORD:-}"
TEST_PASSWORD="${TEST_PASSWORD:-Password01!}"
PROFILE="${PROFILE:-memory}"

# Wait for API
wait_for_ready() {
    local max=30 attempt=1
    while [ $attempt -le $max ]; do
        if curl -sf "${API_URL}/health/ready" >/dev/null 2>&1; then return 0; fi
        sleep 1; ((attempt++))
    done
    echo "ERROR: DittoFS not ready after ${max}s"; return 1
}

wait_for_ready

# Extract admin password from server log (first boot generates one)
if [ -z "$ADMIN_PASSWORD" ] && [ -f /tmp/dittofs-server.log ]; then
    ADMIN_PASSWORD=$(grep -o 'password: [^ ]*' /tmp/dittofs-server.log | head -1 | awk '{print $2}')
fi

# Login as admin
$DFSCTL login --server "$API_URL" --username admin --password "$ADMIN_PASSWORD"

# Create metadata store (profile-dependent is handled by config.yaml; API creates runtime stores)
$DFSCTL store metadata add --name default --type memory

# Create payload store
$DFSCTL store payload add --name default --type memory

# Create WPTS-required shares
$DFSCTL share create --name /SMBBasic --metadata default --payload default
$DFSCTL share create --name /SMBEncrypted --metadata default --payload default

# Create test users (password same for all, matching WPTS ptfconfig)
$DFSCTL user create --username wpts-admin --password "$TEST_PASSWORD"
$DFSCTL user create --username nonadmin --password "$TEST_PASSWORD"

# Enable SMB adapter
$DFSCTL adapter enable smb --port 12445

echo "Bootstrap complete: shares=SMBBasic,SMBEncrypted users=wpts-admin,nonadmin"
```

### TRX Parsing Script

```bash
#!/usr/bin/env bash
# test/smb-conformance/parse-results.sh
# Parses TRX file and produces colored summary table

set -euo pipefail

TRX_FILE="$1"
KNOWN_FAILURES="${2:-KNOWN_FAILURES.md}"

NS="http://microsoft.com/schemas/VisualStudio/TeamTest/2010"

# Extract counters
TOTAL=$(xmlstarlet sel -N t="$NS" -t -v "//t:Counters/@total" "$TRX_FILE")
PASSED=$(xmlstarlet sel -N t="$NS" -t -v "//t:Counters/@passed" "$TRX_FILE")
FAILED=$(xmlstarlet sel -N t="$NS" -t -v "//t:Counters/@failed" "$TRX_FILE")

echo "=== SMB Conformance Results ==="
echo "Total: $TOTAL  Passed: $PASSED  Failed: $FAILED"
echo ""

# Load known failures into array
declare -A KNOWN
while IFS='|' read -r _ name _ _ _; do
    name=$(echo "$name" | xargs)  # trim whitespace
    [ -n "$name" ] && KNOWN["$name"]=1
done < <(grep '^|' "$KNOWN_FAILURES" | tail -n +3)  # skip header rows

# Print per-test results
NEW_FAILURES=0
xmlstarlet sel -N t="$NS" -t -m "//t:UnitTestResult" \
    -v "@testName" -o "|" -v "@outcome" -n "$TRX_FILE" | \
while IFS='|' read -r name outcome; do
    if [ "$outcome" = "Passed" ]; then
        printf "\033[32m  PASS\033[0m %s\n" "$name"
    elif [ "${KNOWN[$name]+_}" ]; then
        printf "\033[33m  KNOWN\033[0m %s\n" "$name"
    else
        printf "\033[31m  FAIL\033[0m %s\n" "$name"
        NEW_FAILURES=$((NEW_FAILURES + 1))
    fi
done

exit $NEW_FAILURES  # 0 if only known failures
```

## WPTS Docker Image Details

### Available Tags (verified from MCR API)

| Tag | Description | Recommendation |
|-----|-------------|----------------|
| `fileserver` | Latest (mutable) | Do NOT use in CI |
| `fileserver-v8` | Latest stable versioned | **Use this** -- pin for reproducibility |
| `fileserver-v7` | Previous stable | Fallback if v8 has issues |
| `fileserverV2`-`fileserverV6` | Older versions | Avoid unless compatibility required |

### Docker Run Command

```bash
docker run \
  --hostname FS-CLI \
  --network host \
  -v /path/to/ptfconfig:/data/fileserver \
  -i mcr.microsoft.com/windowsprotocoltestsuites:fileserver-v8 \
  "TestCategory=BVT" \
  ""   # dryRun: empty=run, "y"=list only
```

**Arguments (positional):**
1. `$filter` (optional): Test category filter expression, e.g., `"TestCategory=BVT"`, `"TestCategory=BVT&TestCategory=Smb2002"`, or `"TestCategory=BVT|TestCategory=Negotiate"`
2. `$dryRun` (optional): If `"y"`, lists matching tests without executing

**Volume mount:** ptfconfig files must be at `/data/fileserver/`. TRX results are written back to this same directory.

**Output:** `.trx` file in the mounted `/data/fileserver` directory.

### Required ptfconfig Files

The WPTS FileServer Docker image expects these files in `/data/fileserver/`:

1. `CommonTestSuite.deployment.ptfconfig` -- Shared settings (network, auth, shares, capabilities)
2. `MS-SMB2_ServerTestSuite.deployment.ptfconfig` -- SMB2-specific settings (includes CommonTestSuite via `<Include>`)

The MS-SMB2 deployment ptfconfig includes `CommonTestSuite.deployment.ptfconfig` via XML include, so both files must be present.

### BVT Test Categories

From source analysis of the SMB2 test suite, BVT tests span these areas:
- **Basic**: Query/set file info, lock/unlock, query dir, change notify
- **Negotiate**: Protocol version negotiation
- **Session Management**: Session setup, logoff
- **Tree Management**: Tree connect, disconnect
- **Create/Close**: File create and close operations
- **Signing**: HMAC-SHA256 signing
- **Encryption**: AES encryption (will mostly fail for DittoFS currently)
- **Leasing**: File lease operations
- **OpLock**: Opportunistic locks
- **Durable Handle**: Durable handle v1/v2
- **IOCTL**: Validate negotiate info
- **Multiple Channel**: Multi-channel operations (will fail -- not supported)
- **App Instance ID**: Application instance ID operations
- **Compound**: Compound request handling

Tests tagged with `DomainRequired` category will fail in workgroup mode and should be in KNOWN_FAILURES.md.

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Manual Windows VM setup for WPTS | Docker image from MCR | ~2022 | No Windows license/VM needed for test driver |
| .NET Framework on Windows only | .NET 8 cross-platform | v4.24.4.0 (April 2024) | Linux Docker image works natively |
| PTM GUI for test configuration | PtmCli + ptfconfig files | v4.21+ | Enables headless CI runs |
| NUnit XML output | TRX (Visual Studio Test Results) format | Native | Default output format; use `--logger` for alternatives |

**Deprecated/outdated:**
- The CONTEXT.md mentions "NUnit XML" -- the actual output format is **TRX** (Visual Studio Test Results XML), not NUnit. The TRX format uses the namespace `http://microsoft.com/schemas/VisualStudio/TeamTest/2010`. This is a critical correction for the parsing scripts.

## Open Questions

1. **DittoFS SMB 2.1 vs WPTS BVT scope**
   - What we know: DittoFS currently supports SMB 2.1. WPTS BVT tests span SMB 2.0.2 through 3.1.1.
   - What's unclear: Exactly how many BVT tests are tagged `Smb2002` (which covers 2.0.2+, i.e., tests that should pass on 2.1) vs tests tagged `Smb30`/`Smb302`/`Smb311` (which require SMB 3.x and will fail).
   - Recommendation: Run WPTS with `--dryRun "y"` first to list all BVT tests and their categories. Categorize each as "should pass" or "expected fail" based on DittoFS capabilities. Populate KNOWN_FAILURES.md from this analysis. This can be done as an initial task.

2. **WPTS fileserver-v8 container base OS**
   - What we know: The wiki says the image is based on Ubuntu 20.04. The image uses .NET internally.
   - What's unclear: Whether `fileserver-v8` has been rebased on a newer Ubuntu. This matters for any compatibility issues.
   - Recommendation: Accept `fileserver-v8` as-is; pin the tag for reproducibility.

3. **WPTS share path format**
   - What we know: DittoFS shares are created as `/SMBBasic`, `/SMBEncrypted`. WPTS ptfconfig uses `BasicFileShare=SMBBasic` (no leading slash).
   - What's unclear: Whether WPTS constructs UNC paths as `\\host\SMBBasic` automatically or expects a different format.
   - Recommendation: Create DittoFS shares with names matching WPTS expectations. Test locally first. The ptfconfig property `BasicFileShare` is just the share name, and WPTS builds the UNC path `\\SutComputerName\BasicFileShare` internally.

4. **DittoFS share naming convention**
   - What we know: Existing DittoFS shares use `/export` format. WPTS expects `SMBBasic`.
   - What's unclear: Whether DittoFS share names can be created without the leading `/` or whether the SMB adapter strips it when presenting to clients.
   - Recommendation: Investigate by checking how the SMB adapter presents share names in TreeConnect. The bootstrap may need to create shares as `/SMBBasic` if that's the DittoFS convention, relying on the SMB adapter to present them as `SMBBasic` to clients.

5. **DittoFS admin password extraction in Docker Compose mode**
   - What we know: DittoFS generates a random admin password on first start and logs it. In local mode, scripts extract it from the log file.
   - What's unclear: How to reliably extract the password when DittoFS runs inside a Docker container (logs may be buffered, timing issues).
   - Recommendation: Use the `DITTOFS_CONTROLPLANE_SECRET` env var to set a deterministic admin password in the DittoFS container. This avoids log parsing entirely and is the approach specified in the CONTEXT.md decisions.

## Sources

### Primary (HIGH confidence)
- [Microsoft WindowsProtocolTestSuites GitHub](https://github.com/microsoft/WindowsProtocolTestSuites) -- repository structure, release versions, test suite organization
- [MCR tags API](https://mcr.microsoft.com/v2/windowsprotocoltestsuites/tags/list) -- verified available Docker image tags (fileserver, fileserver-v7, fileserver-v8)
- [CommonTestSuite.deployment.ptfconfig](https://github.com/microsoft/WindowsProtocolTestSuites/blob/main/TestSuites/FileServer/src/Common/TestSuite/CommonTestSuite.deployment.ptfconfig) -- actual ptfconfig property names and values (fetched via GitHub API)
- [MS-SMB2_ServerTestSuite.deployment.ptfconfig](https://github.com/microsoft/WindowsProtocolTestSuites/blob/main/TestSuites/FileServer/src/SMB2/TestSuite/MS-SMB2_ServerTestSuite.deployment.ptfconfig) -- SMB2-specific ptfconfig (fetched via GitHub API)
- [WPTS Docker wiki](https://github.com/microsoft/WindowsProtocolTestSuites/wiki/How-to-Run-Test-Suites-with-Docker) -- Docker run command, filter syntax, dry run option
- [Run FileServer on Multiple Platforms wiki](https://github.com/microsoft/WindowsProtocolTestSuites/wiki/Run-File-Server-Test-Suite-on-Multiple-Platforms) -- Linux setup, ptfconfig location, dotnet vstest commands
- [PtmCli wiki](https://github.com/Microsoft/WindowsProtocolTestSuites/wiki/PtmCli) -- CLI parameters, profile/filter/report options
- Existing DittoFS codebase: `test/posix/setup-posix.sh`, `test/posix/run-posix.sh`, `.github/workflows/posix-tests.yml`, `.github/workflows/e2e-tests.yml`, `Dockerfile`

### Secondary (MEDIUM confidence)
- [FileServerUserGuide.md](https://github.com/microsoft/WindowsProtocolTestSuites/blob/main/TestSuites/FileServer/docs/FileServerUserGuide.md) -- share names (SMBBasic, SMBEncrypted, ShareForceLevel2), workgroup mode notes
- [dorny/test-reporter](https://github.com/dorny/test-reporter) -- GitHub Action for TRX result visualization
- [gfoidl/trx2junit](https://github.com/gfoidl/trx2junit) -- TRX to JUnit conversion if needed

### Tertiary (LOW confidence)
- TRX XML namespace/structure -- verified via multiple sources but exact field names in WPTS output may vary from standard TRX
- BVT test count ("101 tests" from requirements) -- not independently verified; actual count depends on WPTS version

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH -- Docker image tags verified from MCR API, ptfconfig structure verified from source code
- Architecture: HIGH -- patterns adapted from existing test/posix/ infrastructure in the same project
- Pitfalls: HIGH -- ptfconfig properties verified from actual source files, networking patterns verified from Docker documentation
- TRX parsing: MEDIUM -- TRX structure from multiple sources but not tested against actual WPTS output

**Research date:** 2026-02-26
**Valid until:** 2026-04-26 (WPTS releases quarterly; Docker tags are stable once published)
