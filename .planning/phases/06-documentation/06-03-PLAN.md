---
phase: 06-documentation
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Operator deploys successfully on Scaleway dittofs-demo cluster"
    - "DittoServer CR creates working StatefulSet with Ready condition"
    - "NFS mount succeeds from within cluster"
    - "Documentation accurately describes observed behavior"
  artifacts: []
  key_links:
    - from: "kubectl context"
      to: "dittofs-demo cluster"
      via: "kubeconfig"
      pattern: "dittofs-demo"
---

<objective>
Validate operator deployment and documentation on Scaleway dittofs-demo cluster.

Purpose: Ensure documentation matches real-world behavior and operator works on target platform
Output: Validation report confirming end-to-end functionality
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-documentation/06-CONTEXT.md
@k8s/dittofs-operator/docs/INSTALL.md
@k8s/dittofs-operator/config/samples/dittofs_v1alpha1_dittofs_memory.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy operator to Scaleway cluster</name>
  <files></files>
  <action>
    1. Switch to Scaleway cluster context:
       ```bash
       kubectl config use-context dittofs-demo
       kubectl cluster-info
       ```

    2. Verify cluster prerequisites:
       ```bash
       # Check StorageClass
       kubectl get storageclass

       # Check existing CRDs (should NOT have dittoservers yet if fresh)
       kubectl get crd | grep dittofs || echo "No DittoFS CRD - good"
       ```

    3. Build and deploy operator using INSTALL.md instructions:
       ```bash
       cd k8s/dittofs-operator

       # Generate install.yaml
       make build-installer IMG=controller:latest

       # Install CRDs
       kubectl apply -f config/crd/bases/dittofs.dittofs.com_dittoservers.yaml

       # Deploy operator (using Kustomize)
       kubectl apply -k config/default
       ```

    4. Verify operator is running:
       ```bash
       kubectl get pods -n dittofs-operator-system
       kubectl logs -n dittofs-operator-system deployment/dittofs-operator-controller-manager --tail=20
       ```

    5. Check CRD is installed:
       ```bash
       kubectl get crd dittoservers.dittofs.dittofs.com
       kubectl api-resources | grep dittofs
       ```

    If operator fails to start, check:
    - RBAC issues (ServiceAccount, ClusterRole binding)
    - Image pull errors (if using custom image)
    - Webhook certificate issues
  </action>
  <verify>
    ```bash
    # Operator pod running
    kubectl get pods -n dittofs-operator-system -l control-plane=controller-manager | grep Running

    # CRD exists
    kubectl get crd dittoservers.dittofs.dittofs.com

    # Operator logs show no errors
    kubectl logs -n dittofs-operator-system deployment/dittofs-operator-controller-manager --tail=10 | grep -v "error" || true
    ```
  </verify>
  <done>
    - Operator pod is Running in dittofs-operator-system namespace
    - dittoservers CRD is installed and recognized
    - Operator logs show successful startup
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy DittoServer CR and verify resources</name>
  <files></files>
  <action>
    1. Create a test namespace:
       ```bash
       kubectl create namespace dittofs-test || true
       ```

    2. Deploy minimal DittoServer CR:
       ```bash
       kubectl apply -f - <<'EOF'
       apiVersion: dittofs.dittofs.com/v1alpha1
       kind: DittoServer
       metadata:
         name: scaleway-test
         namespace: dittofs-test
       spec:
         image: marmos91c/dittofs:latest
         storage:
           metadataSize: "5Gi"
           cacheSize: "2Gi"
         service:
           type: LoadBalancer
       EOF
       ```

    3. Wait for resources to be created (timeout 5 minutes):
       ```bash
       # Watch DittoServer status
       kubectl get dittoserver scaleway-test -n dittofs-test -w &
       WATCH_PID=$!
       sleep 120
       kill $WATCH_PID 2>/dev/null || true

       # Check status
       kubectl get dittoserver scaleway-test -n dittofs-test -o yaml
       ```

    4. Verify all managed resources:
       ```bash
       # ConfigMap
       kubectl get configmap -n dittofs-test | grep scaleway-test

       # StatefulSet and Pods
       kubectl get statefulset -n dittofs-test
       kubectl get pods -n dittofs-test

       # Services
       kubectl get svc -n dittofs-test

       # PVCs
       kubectl get pvc -n dittofs-test
       ```

    5. Check status conditions:
       ```bash
       kubectl get dittoserver scaleway-test -n dittofs-test -o jsonpath='{.status.conditions}' | jq .
       ```

    Expected: ConfigReady=True, Available=True (or Progressing if still starting), Ready=True eventually.

    NOTE: Pod may be in CrashLoopBackOff if DittoFS image isn't compatible with generated config. This is a known limitation documented in STATE.md pending todos. For validation purposes, focus on operator behavior (does it create the right resources?).
  </action>
  <verify>
    ```bash
    # StatefulSet exists
    kubectl get statefulset scaleway-test -n dittofs-test

    # ConfigMap exists with config.yaml
    kubectl get configmap scaleway-test -n dittofs-test -o jsonpath='{.data.config\.yaml}' | head -20

    # PVCs created
    kubectl get pvc -n dittofs-test | grep -E "metadata|cache"

    # Services created (file service with LoadBalancer)
    kubectl get svc scaleway-test-file -n dittofs-test
    ```
  </verify>
  <done>
    - DittoServer CR accepted and reconciled
    - StatefulSet, ConfigMap, Services, PVCs all created
    - Status conditions populated
    - LoadBalancer Service gets external IP (or pending if Scaleway CCM slow)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Operator deployed to Scaleway dittofs-demo cluster with test DittoServer CR.
    All managed Kubernetes resources created (StatefulSet, ConfigMap, Services, PVCs).
  </what-built>
  <how-to-verify>
    1. Check DittoServer status:
       ```bash
       kubectl get dittoserver -n dittofs-test -o wide
       kubectl describe dittoserver scaleway-test -n dittofs-test
       ```

    2. Verify LoadBalancer got external IP:
       ```bash
       kubectl get svc scaleway-test-file -n dittofs-test
       # EXTERNAL-IP should show an IP address (may take 2-5 minutes on Scaleway)
       ```

    3. Check pod status:
       ```bash
       kubectl get pods -n dittofs-test
       kubectl logs -n dittofs-test scaleway-test-0 --tail=30
       ```

    4. If pod is Running, try NFS mount from within cluster:
       ```bash
       # Create test pod
       kubectl run nfs-test --image=busybox -n dittofs-test --rm -it --restart=Never -- sh -c "
         mkdir -p /mnt/test
         mount -t nfs -o port=2049,nfsvers=3 scaleway-test-file.dittofs-test.svc.cluster.local:/export /mnt/test
         ls -la /mnt/test
         echo 'Mount successful!'
       "
       ```

    5. Review documentation matches observed behavior:
       - Does INSTALL.md kubectl flow work?
       - Does CRD_REFERENCE.md match actual fields?
       - Are there any issues not covered in TROUBLESHOOTING.md?

    **Expected outcomes:**
    - Operator creates all resources correctly
    - LoadBalancer gets external IP
    - Pod either Running (if image works) or CrashLoopBackOff (known limitation)
    - NFS mount works if pod is Running

    **Known limitation:** DittoFS image may not be compatible with new config format yet. This is documented in STATE.md. If pod crashes, that's expected - we're validating the operator creates correct resources.
  </how-to-verify>
  <resume-signal>
    Type "approved" if operator correctly creates all resources (even if pod crashes due to image issue).
    Type "issues: [description]" if operator itself has problems (RBAC, resources not created, etc.)
  </resume-signal>
</task>

</tasks>

<verification>
Scaleway deployment validation:
```bash
# Context is correct
kubectl config current-context | grep -q dittofs-demo

# Operator running
kubectl get pods -n dittofs-operator-system | grep Running

# Test CR resources exist
kubectl get statefulset,configmap,svc,pvc -n dittofs-test | grep scaleway-test
```
</verification>

<success_criteria>
1. Operator deploys successfully on Scaleway dittofs-demo cluster
2. DittoServer CR creates all expected resources (StatefulSet, ConfigMap, Services, PVCs)
3. Status conditions are populated correctly
4. LoadBalancer Service gets external IP from Scaleway
5. Documentation reflects actual deployment experience
</success_criteria>

<output>
After completion, create `.planning/phases/06-documentation/06-03-SUMMARY.md`
</output>
