---
phase: 06-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - k8s/dittofs-operator/docs/INSTALL.md
  - k8s/dittofs-operator/docs/CRD_REFERENCE.md
  - k8s/dittofs-operator/chart/Chart.yaml
  - k8s/dittofs-operator/chart/values.yaml
  - k8s/dittofs-operator/chart/templates/_helpers.tpl
  - k8s/dittofs-operator/chart/templates/deployment.yaml
  - k8s/dittofs-operator/chart/templates/service.yaml
  - k8s/dittofs-operator/chart/templates/serviceaccount.yaml
  - k8s/dittofs-operator/chart/templates/rbac.yaml
  - k8s/dittofs-operator/chart/crds/dittoservers.yaml
  - k8s/dittofs-operator/Makefile
autonomous: true

must_haves:
  truths:
    - "User can install operator via kubectl apply -f install.yaml"
    - "User can install operator via helm install"
    - "User can look up any CRD field and find its type, default, validation, and example"
    - "User can see architecture diagram of what operator creates"
  artifacts:
    - path: "k8s/dittofs-operator/docs/INSTALL.md"
      provides: "Installation guide for kubectl and Helm"
      contains: "helm install"
    - path: "k8s/dittofs-operator/docs/CRD_REFERENCE.md"
      provides: "Complete CRD field documentation"
      contains: "spec.storage.metadataSize"
    - path: "k8s/dittofs-operator/chart/Chart.yaml"
      provides: "Helm chart metadata"
      contains: "dittofs-operator"
    - path: "k8s/dittofs-operator/chart/values.yaml"
      provides: "Helm chart defaults"
      contains: "image:"
  key_links:
    - from: "k8s/dittofs-operator/docs/INSTALL.md"
      to: "chart/"
      via: "Helm install instructions"
      pattern: "helm install.*dittofs-operator"
    - from: "k8s/dittofs-operator/docs/CRD_REFERENCE.md"
      to: "api/v1alpha1/dittoserver_types.go"
      via: "Field documentation matches types"
      pattern: "metadataSize|cacheSize|nfsPort"
---

<objective>
Create CRD reference documentation and installation guide with Helm chart for the DittoFS operator.

Purpose: Enable users to install the operator and understand all CRD configuration options
Output: Complete INSTALL.md, CRD_REFERENCE.md, and working Helm chart
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-documentation/06-CONTEXT.md
@.planning/phases/06-documentation/06-RESEARCH.md
@k8s/dittofs-operator/api/v1alpha1/dittoserver_types.go
@k8s/dittofs-operator/Makefile
@k8s/dittofs-operator/config/crd/bases/dittofs.dittofs.com_dittoservers.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate Helm chart using helmify and add Makefile target</name>
  <files>
    k8s/dittofs-operator/chart/Chart.yaml
    k8s/dittofs-operator/chart/values.yaml
    k8s/dittofs-operator/chart/templates/_helpers.tpl
    k8s/dittofs-operator/chart/templates/deployment.yaml
    k8s/dittofs-operator/chart/templates/service.yaml
    k8s/dittofs-operator/chart/templates/serviceaccount.yaml
    k8s/dittofs-operator/chart/templates/rbac.yaml
    k8s/dittofs-operator/chart/crds/dittoservers.yaml
    k8s/dittofs-operator/Makefile
  </files>
  <action>
    1. Install helmify tool if not present:
       ```
       go install github.com/arttor/helmify/cmd/helmify@latest
       ```

    2. Generate Helm chart from Kustomize manifests:
       ```
       cd k8s/dittofs-operator
       $(KUSTOMIZE) build config/default | helmify chart
       ```

    3. Add Makefile targets for Helm chart generation (append to Dependencies section):
       ```makefile
       ## Helm Chart
       HELMIFY ?= $(LOCALBIN)/helmify

       .PHONY: helmify
       helmify: $(HELMIFY)
       $(HELMIFY): $(LOCALBIN)
       	$(call go-install-tool,$(HELMIFY),github.com/arttor/helmify/cmd/helmify,latest)

       .PHONY: helm
       helm: manifests kustomize helmify ## Generate Helm chart from kustomize manifests
       	"$(KUSTOMIZE)" build config/default | "$(HELMIFY)" chart
       ```

    4. Review and customize generated chart:
       - Update Chart.yaml with proper metadata (name: dittofs-operator, version: 0.1.0, appVersion: 0.1.0)
       - Ensure values.yaml has sensible defaults for image, resources, replicas
       - Verify CRD is in crds/ directory (Helm installs CRDs first)
       - Check RBAC templates are properly templated

    5. Validate Helm chart renders correctly:
       ```
       helm template dittofs-operator ./chart --debug
       ```

    DO NOT manually create chart from scratch - use helmify to maintain consistency with Kustomize manifests.
  </action>
  <verify>
    ```bash
    cd k8s/dittofs-operator
    # Check chart structure exists
    ls chart/Chart.yaml chart/values.yaml chart/templates/ chart/crds/
    # Verify chart renders without errors
    helm template test ./chart --debug 2>&1 | head -50
    # Check Makefile has helm target
    grep -q "helm:" Makefile
    ```
  </verify>
  <done>
    - Helm chart in chart/ directory with Chart.yaml, values.yaml, templates/, crds/
    - `make helm` target regenerates chart from Kustomize
    - `helm template` renders valid YAML without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CRD_REFERENCE.md with complete field documentation</name>
  <files>k8s/dittofs-operator/docs/CRD_REFERENCE.md</files>
  <action>
    Create comprehensive CRD reference documentation in k8s/dittofs-operator/docs/CRD_REFERENCE.md.

    Structure:
    1. **Overview** - Brief intro to DittoServer CRD, API version, short names

    2. **Spec Fields** - Document ALL fields from dittoserver_types.go in table format:
       | Field | Type | Default | Required | Description |
       Include validation rules inline after each section.

       Group by logical sections:
       - Core fields (image, replicas)
       - Storage configuration (storage.*)
       - Database configuration (database.*)
       - Cache configuration (cache.*)
       - Service configuration (service.*, nfsPort)
       - SMB configuration (smb.*)
       - Metrics configuration (metrics.*)
       - Control plane configuration (controlPlane.*)
       - Identity configuration (identity.*)
       - S3 configuration (s3.*)
       - Percona PostgreSQL (percona.*)
       - Resources and security (resources, securityContext, podSecurityContext)

    3. **Status Fields** - Document all status fields and conditions table:
       | Condition | Status | Meaning |
       Include: Ready, Available, ConfigReady, DatabaseReady, Progressing

    4. **Complete Examples** - Embed full CR examples directly:
       - Minimal (memory stores)
       - With S3 payload store
       - With Percona PostgreSQL
       - With SMB enabled

    Extract field details from api/v1alpha1/dittoserver_types.go kubebuilder markers.
    Use Mermaid diagram for architecture overview showing CR -> managed resources.

    DO NOT use placeholders like "TODO" - document every field completely.
  </action>
  <verify>
    ```bash
    # Check file exists and has content
    wc -l k8s/dittofs-operator/docs/CRD_REFERENCE.md
    # Verify key fields are documented
    grep -c "metadataSize\|cacheSize\|nfsPort\|percona" k8s/dittofs-operator/docs/CRD_REFERENCE.md
    # Check examples are included
    grep -c "kind: DittoServer" k8s/dittofs-operator/docs/CRD_REFERENCE.md
    ```
  </verify>
  <done>
    - CRD_REFERENCE.md exists with 300+ lines
    - Every spec field from types.go is documented with type, default, validation
    - All 5 status conditions documented in table
    - At least 3 complete CR examples embedded
  </done>
</task>

<task type="auto">
  <name>Task 3: Create INSTALL.md with kubectl and Helm installation methods</name>
  <files>k8s/dittofs-operator/docs/INSTALL.md</files>
  <action>
    Create installation guide in k8s/dittofs-operator/docs/INSTALL.md.

    Structure:
    1. **Prerequisites**
       - Kubernetes 1.25+ cluster
       - kubectl configured
       - (For Helm) helm 3.x installed
       - (For Percona) Percona operator installed (link to PERCONA.md)
       - StorageClass available (show `kubectl get storageclass`)

    2. **Installation via kubectl** (Primary method)
       ```bash
       # Install CRDs first
       kubectl apply -f https://raw.githubusercontent.com/marmos91/dittofs/main/k8s/dittofs-operator/config/crd/bases/dittofs.dittofs.com_dittoservers.yaml

       # Install operator
       kubectl apply -f https://raw.githubusercontent.com/marmos91/dittofs/main/k8s/dittofs-operator/dist/install.yaml
       ```
       Note: CRD installation order matters - apply CRD before operator.

    3. **Installation via Helm** (Alternative)
       ```bash
       # Add repository (if published) or use local chart
       helm install dittofs-operator ./chart -n dittofs-system --create-namespace

       # With custom values
       helm install dittofs-operator ./chart -n dittofs-system \
         --set manager.resources.limits.memory=256Mi
       ```

    4. **Verify Installation**
       ```bash
       kubectl get pods -n dittofs-system
       kubectl get crd dittoservers.dittofs.dittofs.com
       ```

    5. **Quick Start** - Deploy first DittoServer
       Show minimal CR, apply it, verify it's running.

    6. **Uninstallation**
       Both kubectl and Helm methods.

    7. **Upgrading**
       Note about Helm CRD limitations - must manually apply CRD updates.

    Include Mermaid diagram showing deployment flow.
  </action>
  <verify>
    ```bash
    # Check file exists
    test -f k8s/dittofs-operator/docs/INSTALL.md
    # Verify both methods documented
    grep -c "kubectl apply\|helm install" k8s/dittofs-operator/docs/INSTALL.md
    # Check prerequisites section exists
    grep -q "Prerequisites" k8s/dittofs-operator/docs/INSTALL.md
    ```
  </verify>
  <done>
    - INSTALL.md exists with complete installation guide
    - kubectl method documented with CRD-first order
    - Helm method documented with custom values example
    - Prerequisites section lists requirements
    - Verification commands included
  </done>
</task>

</tasks>

<verification>
All documentation artifacts exist and are complete:
```bash
cd k8s/dittofs-operator
# Documentation files exist
ls docs/INSTALL.md docs/CRD_REFERENCE.md

# Helm chart is valid
helm lint ./chart
helm template test ./chart > /dev/null

# Makefile has helm target
make help | grep -q helm
```
</verification>

<success_criteria>
1. Helm chart in chart/ generates valid Kubernetes YAML
2. CRD_REFERENCE.md documents every field from dittoserver_types.go
3. INSTALL.md provides working kubectl and Helm installation steps
4. All documentation uses consistent formatting (tables, code blocks)
5. Mermaid diagrams render in GitHub markdown preview
</success_criteria>

<output>
After completion, create `.planning/phases/06-documentation/06-01-SUMMARY.md`
</output>
