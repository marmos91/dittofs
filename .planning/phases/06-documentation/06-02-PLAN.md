---
phase: 06-documentation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - k8s/dittofs-operator/docs/PERCONA.md
  - k8s/dittofs-operator/docs/TROUBLESHOOTING.md
  - k8s/dittofs-operator/README.md
autonomous: true

must_haves:
  truths:
    - "User can enable PostgreSQL metadata store using Percona by following guide"
    - "User can diagnose LoadBalancer pending issue using troubleshooting guide"
    - "User can diagnose PVC stuck pending using troubleshooting guide"
    - "User can get started quickly from README.md overview"
  artifacts:
    - path: "k8s/dittofs-operator/docs/PERCONA.md"
      provides: "Percona PostgreSQL integration guide"
      contains: "PerconaPGCluster"
    - path: "k8s/dittofs-operator/docs/TROUBLESHOOTING.md"
      provides: "Common issues and solutions"
      contains: "LoadBalancer"
    - path: "k8s/dittofs-operator/README.md"
      provides: "Overview and quick start"
      contains: "Quick Start"
  key_links:
    - from: "k8s/dittofs-operator/README.md"
      to: "docs/"
      via: "Links to detailed documentation"
      pattern: "docs/INSTALL.md|docs/CRD_REFERENCE.md"
    - from: "k8s/dittofs-operator/docs/PERCONA.md"
      to: "config/samples/"
      via: "References sample CR"
      pattern: "dittofs_v1alpha1_dittoserver_percona.yaml"
---

<objective>
Create Percona integration guide, troubleshooting documentation, and update README with overview.

Purpose: Enable users to integrate PostgreSQL via Percona and diagnose common issues
Output: PERCONA.md, TROUBLESHOOTING.md, and updated README.md with proper overview
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-documentation/06-CONTEXT.md
@.planning/phases/06-documentation/06-RESEARCH.md
@k8s/dittofs-operator/api/v1alpha1/dittoserver_types.go
@k8s/dittofs-operator/config/samples/dittofs_v1alpha1_dittoserver_percona.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PERCONA.md integration guide</name>
  <files>k8s/dittofs-operator/docs/PERCONA.md</files>
  <action>
    Create Percona PostgreSQL integration guide in k8s/dittofs-operator/docs/PERCONA.md.

    Structure:
    1. **Overview**
       - What Percona operator does (managed PostgreSQL)
       - Why use it (persistent metadata store for production)
       - How DittoFS operator integrates (auto-creates PerconaPGCluster)

    2. **Prerequisites**
       - Percona operator must be installed first
       - Verify: `kubectl get crd perconapgclusters.pgv2.percona.com`
       - Installation: `kubectl apply -f https://raw.githubusercontent.com/percona/percona-postgresql-operator/main/deploy/bundle.yaml`

    3. **Enabling Percona Integration**
       Show CRD spec with percona.enabled=true:
       ```yaml
       spec:
         percona:
           enabled: true
           replicas: 1
           storageSize: "10Gi"
           databaseName: "dittofs"
       ```

    4. **How It Works**
       - Operator creates PerconaPGCluster owned by DittoServer
       - Percona operator creates PostgreSQL pods and Secrets
       - DittoFS operator extracts DATABASE_URL from Percona Secret
       - Init container waits for PostgreSQL readiness
       - DATABASE_URL injected into DittoFS container

       Include Mermaid diagram showing the flow.

    5. **Backup Configuration** (optional)
       Document percona.backup.* fields for S3 backup:
       ```yaml
       percona:
         enabled: true
         backup:
           enabled: true
           bucket: "my-backups"
           endpoint: "https://s3.cubbit.eu"
           credentialsSecretRef:
             name: "pgbackrest-s3-credentials"
       ```

    6. **deleteWithServer Flag**
       - Explain the danger of deleteWithServer=true (data loss)
       - Default is false (PostgreSQL preserved on DittoServer deletion)
       - When to use true: dev/test environments

    7. **Troubleshooting Percona Issues**
       - Percona CRD not found (operator not installed)
       - PerconaPGCluster stuck (check Percona operator logs)
       - Init container timeout (PostgreSQL slow to start)
       - Secret not found (Percona hasn't created it yet)

    8. **Complete Example**
       Reference config/samples/dittofs_v1alpha1_dittoserver_percona.yaml
  </action>
  <verify>
    ```bash
    # Check file exists and has content
    wc -l k8s/dittofs-operator/docs/PERCONA.md
    # Verify key sections
    grep -c "Prerequisites\|enabled: true\|deleteWithServer\|DATABASE_URL" k8s/dittofs-operator/docs/PERCONA.md
    # Check Mermaid diagram exists
    grep -q "mermaid" k8s/dittofs-operator/docs/PERCONA.md
    ```
  </verify>
  <done>
    - PERCONA.md exists with 150+ lines
    - Prerequisites section with Percona operator installation
    - CRD configuration examples with all percona.* fields
    - Explanation of deleteWithServer flag with warning
    - Troubleshooting section for common Percona issues
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TROUBLESHOOTING.md with common issues</name>
  <files>k8s/dittofs-operator/docs/TROUBLESHOOTING.md</files>
  <action>
    Create troubleshooting guide in k8s/dittofs-operator/docs/TROUBLESHOOTING.md.

    Use Symptom/Cause/Solution format for each issue. Include 7 issues minimum:

    **Issue 1: LoadBalancer External IP Pending**
    - Symptom: `kubectl get svc` shows EXTERNAL-IP as `<pending>`
    - Cause: No cloud controller or MetalLB in cluster
    - Solution: Use NodePort, install MetalLB, or use port-forward
    - Debug: `kubectl describe svc`, check cloud-controller-manager logs

    **Issue 2: PVC Stuck in Pending**
    - Symptom: StatefulSet pods stuck in Pending, PVC not bound
    - Cause: No matching StorageClass, CSI driver missing, capacity issues
    - Solution: Verify StorageClass exists, check CSI driver, check capacity
    - Debug: `kubectl describe pvc`, `kubectl get storageclass`

    **Issue 3: Operator CrashLoopBackOff**
    - Symptom: Operator pod in CrashLoopBackOff
    - Cause: CRD not installed, RBAC issues, missing webhooks
    - Solution: Install CRD first, check RBAC, verify webhook cert-manager
    - Debug: `kubectl logs -n dittofs-system deployment/dittofs-operator-controller-manager`

    **Issue 4: DittoServer Stuck in Pending**
    - Symptom: DittoServer CR shows phase Pending forever
    - Cause: PVC stuck, Percona not ready, image pull error
    - Solution: Check PVC status, check Percona status, check pod events
    - Debug: `kubectl describe dittoserver`, `kubectl describe pod`

    **Issue 5: Percona CRD Not Found**
    - Symptom: `no matches for kind "PerconaPGCluster"` in operator logs
    - Cause: Percona operator not installed
    - Solution: Install Percona operator before enabling percona.enabled
    - Debug: `kubectl get crd | grep percona`

    **Issue 6: NFS Mount Fails**
    - Symptom: mount command fails with "Connection refused" or "No route to host"
    - Cause: Service not exposed, firewall, wrong port
    - Solution: Verify service type, check LoadBalancer IP, use correct port
    - Debug: `kubectl get svc`, `nc -zv <IP> 2049`

    **Issue 7: ConfigMap Not Updating Pod**
    - Symptom: CRD changes don't affect running pod
    - Cause: Checksum annotation not triggering restart
    - Solution: Delete pod to force restart, check checksum annotation
    - Debug: `kubectl get pod -o yaml | grep checksum`

    Format each issue with:
    ```markdown
    ### Issue Title

    **Symptom:**
    Description and example command showing the problem

    **Cause:**
    Why this happens

    **Solution:**
    Step-by-step fix

    **Debug commands:**
    ```bash
    commands here
    ```
    ```
  </action>
  <verify>
    ```bash
    # Check file exists and has content
    wc -l k8s/dittofs-operator/docs/TROUBLESHOOTING.md
    # Verify all 7 issues documented
    grep -c "^### " k8s/dittofs-operator/docs/TROUBLESHOOTING.md
    # Check key issues are covered
    grep -c "LoadBalancer\|PVC.*Pending\|CrashLoopBackOff\|Percona" k8s/dittofs-operator/docs/TROUBLESHOOTING.md
    ```
  </verify>
  <done>
    - TROUBLESHOOTING.md exists with 200+ lines
    - At least 7 issues documented in Symptom/Cause/Solution format
    - Debug commands included inline with each issue
    - Covers LoadBalancer, PVC, operator, Percona, NFS issues
  </done>
</task>

<task type="auto">
  <name>Task 3: Update README.md with overview, quick start, and doc links</name>
  <files>k8s/dittofs-operator/README.md</files>
  <action>
    Rewrite k8s/dittofs-operator/README.md to be a concise overview with links to detailed docs.

    Structure (keep it brief - this is NOT the detailed reference):

    1. **Title and badges** (if any)
       # DittoFS Kubernetes Operator

    2. **One-paragraph description**
       What it does, why you'd use it.

    3. **Architecture diagram** (Mermaid)
       Show DittoServer CR -> StatefulSet, ConfigMap, Services, PVCs, optional Percona.
       Keep it simple - detailed diagrams go in specific docs.

    4. **Quick Start** (5 steps max)
       ```bash
       # 1. Install CRDs
       kubectl apply -f ...

       # 2. Install operator
       kubectl apply -f ...

       # 3. Create DittoServer
       kubectl apply -f - <<EOF
       apiVersion: dittofs.dittofs.com/v1alpha1
       kind: DittoServer
       metadata:
         name: my-dittofs
       spec:
         storage:
           metadataSize: "10Gi"
           cacheSize: "5Gi"
       EOF

       # 4. Wait for ready
       kubectl wait --for=condition=Ready dittoserver/my-dittofs

       # 5. Mount NFS
       kubectl get svc my-dittofs-file -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
       mount -t nfs <IP>:/export /mnt/dittofs
       ```

    5. **Documentation** (link table)
       | Guide | Description |
       |-------|-------------|
       | [Installation](docs/INSTALL.md) | kubectl and Helm installation |
       | [CRD Reference](docs/CRD_REFERENCE.md) | All configuration options |
       | [Percona Integration](docs/PERCONA.md) | PostgreSQL metadata store |
       | [Troubleshooting](docs/TROUBLESHOOTING.md) | Common issues |

    6. **Features** (bullet list, brief)
       - Declarative DittoFS deployment
       - Automatic ConfigMap, StatefulSet, Service management
       - PVC management for metadata and cache
       - S3 credentials injection
       - Optional Percona PostgreSQL integration
       - Status conditions and events

    7. **License**
       Apache 2.0

    Remove the detailed SMB examples, user management examples, and S3 configuration examples - those belong in CRD_REFERENCE.md now.

    Keep README under 150 lines - it's an entry point, not a reference.
  </action>
  <verify>
    ```bash
    # Check file exists
    test -f k8s/dittofs-operator/README.md
    # Verify it's concise (under 200 lines is good)
    wc -l k8s/dittofs-operator/README.md
    # Check it links to docs
    grep -c "docs/INSTALL.md\|docs/CRD_REFERENCE.md\|docs/PERCONA.md\|docs/TROUBLESHOOTING.md" k8s/dittofs-operator/README.md
    # Check Quick Start exists
    grep -q "Quick Start" k8s/dittofs-operator/README.md
    # Check Mermaid diagram exists
    grep -q "mermaid" k8s/dittofs-operator/README.md
    ```
  </verify>
  <done>
    - README.md is concise (under 200 lines)
    - Has architecture Mermaid diagram
    - Has Quick Start section with 5 steps
    - Links to all 4 docs files
    - Features list is bullet points, not detailed examples
  </done>
</task>

</tasks>

<verification>
All documentation is complete and linked:
```bash
cd k8s/dittofs-operator

# All doc files exist
ls docs/INSTALL.md docs/CRD_REFERENCE.md docs/PERCONA.md docs/TROUBLESHOOTING.md

# README links to all docs
grep -E "docs/(INSTALL|CRD_REFERENCE|PERCONA|TROUBLESHOOTING).md" README.md

# PERCONA.md covers key topics
grep -q "deleteWithServer" docs/PERCONA.md

# TROUBLESHOOTING.md has enough issues
test $(grep -c "^### " docs/TROUBLESHOOTING.md) -ge 7
```
</verification>

<success_criteria>
1. PERCONA.md explains complete Percona integration workflow
2. TROUBLESHOOTING.md documents 7+ common issues with debug commands
3. README.md is concise (<200 lines) and links to detailed docs
4. All documentation renders correctly in GitHub (Mermaid diagrams)
5. No TODO or placeholder text in any documentation
</success_criteria>

<output>
After completion, create `.planning/phases/06-documentation/06-02-SUMMARY.md`
</output>
