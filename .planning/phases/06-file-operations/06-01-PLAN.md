---
phase: 06-file-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - test/e2e/file_operations_nfs_test.go
autonomous: true

must_haves:
  truths:
    - "Files can be read via NFS mount"
    - "Files can be written via NFS mount"
    - "Files can be deleted via NFS mount"
    - "Directories can be listed via NFS mount"
    - "Directories can be created via NFS mount"
    - "File permissions can be changed via NFS mount"
  artifacts:
    - path: "test/e2e/file_operations_nfs_test.go"
      provides: "NFS file operation E2E tests"
      exports: ["TestNFSFileOperations"]
      min_lines: 150
  key_links:
    - from: "test/e2e/file_operations_nfs_test.go"
      to: "test/e2e/helpers/server.go"
      via: "StartServerProcess"
      pattern: "helpers\\.StartServerProcess"
    - from: "test/e2e/file_operations_nfs_test.go"
      to: "test/e2e/framework/mount.go"
      via: "MountNFS"
      pattern: "framework\\.MountNFS"
---

<objective>
Implement NFS file operation E2E tests covering requirements NFS-01 through NFS-06.

Purpose: Validate that basic file operations (read, write, delete, mkdir, list, chmod) work correctly through the NFS protocol adapter using CLI-driven server setup.

Output: `test/e2e/file_operations_nfs_test.go` with comprehensive NFS operation tests.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-file-operations/06-RESEARCH.md

# Reference implementations
@test/e2e/adapters_test.go
@test/e2e/helpers/server.go
@test/e2e/helpers/cli.go
@test/e2e/helpers/adapters.go
@test/e2e/helpers/stores.go
@test/e2e/helpers/shares.go
@test/e2e/framework/mount.go
@test/e2e/framework/helpers.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NFS file operations test file</name>
  <files>test/e2e/file_operations_nfs_test.go</files>
  <action>
Create `test/e2e/file_operations_nfs_test.go` with the following structure:

1. Package declaration with `//go:build e2e` build tag
2. Import helpers and framework packages
3. TestNFSFileOperations function that:
   - Skips in short mode
   - Starts server via `helpers.StartServerProcess(t, "")`
   - Logs in as admin via `helpers.LoginAsAdmin(t, sp.APIURL())`
   - Creates memory metadata store via `cli.CreateMetadataStore()`
   - Creates memory payload store via `cli.CreatePayloadStore()`
   - Creates share "/export" via `cli.CreateShare()`
   - Enables NFS adapter on dynamic port via `cli.EnableAdapter("nfs", helpers.WithAdapterPort(port))`
   - Waits for adapter via `framework.WaitForServer(t, port, 10*time.Second)`
   - Mounts NFS share via `framework.MountNFS(t, port)`
   - Runs subtests for each requirement

4. Subtests covering:
   - NFS-01: Read files - write file, verify can read it back
   - NFS-02: Write files - write file, verify it exists and content matches
   - NFS-03: Delete files - create file, delete it, verify it's gone
   - NFS-04: List directories - create dir with files, list and verify entries
   - NFS-05: Create directories - create dir, verify it exists
   - NFS-06: Change permissions - create file, chmod, verify mode changed

Key patterns to follow:
- Use `helpers.UniqueTestName()` for resource names to avoid conflicts
- Use `defer sp.ForceKill()` for cleanup
- Use `defer mount.Cleanup()` for mount cleanup
- Use `framework.WriteFile()`, `framework.ReadFile()`, etc. for file operations
- Use `os.Remove()`, `os.Mkdir()`, `os.Chmod()` for operations not in framework
- Use `require.NoError()` for fatal assertions, `assert` for soft assertions
- Clean up stores/shares in t.Cleanup() or deferred functions

Do NOT run tests in parallel (t.Parallel()) - they share the same mount.
  </action>
  <verify>
Run `go build -tags=e2e ./test/e2e/...` to verify compilation.
Run `go vet -tags=e2e ./test/e2e/file_operations_nfs_test.go` to check for issues.
  </verify>
  <done>
test/e2e/file_operations_nfs_test.go exists, compiles without errors, and contains TestNFSFileOperations with 6 subtests covering NFS-01 through NFS-06.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run and verify NFS tests pass</name>
  <files>test/e2e/file_operations_nfs_test.go</files>
  <action>
Execute the NFS file operations tests to verify they pass:

1. Build the server and CLI binaries:
   ```
   go build -o dittofs ./cmd/dittofs/
   go build -o dittofsctl ./cmd/dittofsctl/
   ```

2. Run the NFS file operations tests:
   ```
   sudo go test -tags=e2e -v -run TestNFSFileOperations ./test/e2e/
   ```
   (sudo required for NFS mount operations)

3. If tests fail:
   - Check server logs (test output includes logs on failure)
   - Verify mount succeeded (check for mount-related errors)
   - Fix any issues in the test file

4. Ensure all 6 subtests pass:
   - NFS-01 Read files
   - NFS-02 Write files
   - NFS-03 Delete files
   - NFS-04 List directories
   - NFS-05 Create directories
   - NFS-06 Change permissions
  </action>
  <verify>
Test output shows "PASS" for TestNFSFileOperations and all 6 subtests.
No test failures or panics.
  </verify>
  <done>
All 6 NFS file operation tests (NFS-01 through NFS-06) pass successfully.
  </done>
</task>

</tasks>

<verification>
1. File exists: `test/e2e/file_operations_nfs_test.go`
2. Build succeeds: `go build -tags=e2e ./test/e2e/...`
3. Tests pass: `sudo go test -tags=e2e -v -run TestNFSFileOperations ./test/e2e/`
4. All 6 requirements covered: NFS-01 through NFS-06
</verification>

<success_criteria>
1. test/e2e/file_operations_nfs_test.go exists and compiles
2. TestNFSFileOperations function with 6 subtests
3. All tests use CLI-driven setup (helpers.StartServerProcess, helpers.LoginAsAdmin)
4. All tests use framework mount helpers (framework.MountNFS)
5. All 6 tests pass when run with sudo
</success_criteria>

<output>
After completion, create `.planning/phases/06-file-operations/06-01-SUMMARY.md`
</output>
