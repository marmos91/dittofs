---
phase: 06-file-operations
plan: 04
type: execute
wave: 2
depends_on: ["06-02"]
files_modified:
  - test/e2e/permission_enforcement_test.go
  - test/e2e/framework/mount.go
autonomous: true

must_haves:
  truths:
    - "Read-only user cannot write files via SMB"
    - "No-access user cannot read files via SMB"
    - "User removed from group loses group permissions"
    - "Permission change takes effect immediately"
  artifacts:
    - path: "test/e2e/permission_enforcement_test.go"
      provides: "Permission enforcement E2E tests"
      exports: ["TestPermissionEnforcement"]
      min_lines: 200
    - path: "test/e2e/framework/mount.go"
      provides: "MountSMBWithError helper for permission testing"
      contains: "MountSMBWithError"
  key_links:
    - from: "test/e2e/permission_enforcement_test.go"
      to: "test/e2e/helpers/shares.go"
      via: "GrantUserPermission, RevokeUserPermission"
      pattern: "cli\\.(Grant|Revoke)UserPermission"
    - from: "test/e2e/permission_enforcement_test.go"
      to: "test/e2e/framework/mount.go"
      via: "MountSMB, MountSMBWithError"
      pattern: "framework\\.MountSMB"
---

<objective>
Implement permission enforcement E2E tests covering requirements ENF-01 through ENF-04.

Purpose: Validate that DittoFS correctly enforces access permissions at the protocol level. Per RESEARCH.md, use SMB for permission tests since NFS AUTH_UNIX is UID-based (not user-based) and doesn't enforce DittoFS user permissions.

Output: `test/e2e/permission_enforcement_test.go` with comprehensive permission enforcement tests.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-file-operations/06-RESEARCH.md

# Reference implementations
@test/e2e/permissions_test.go
@test/e2e/helpers/server.go
@test/e2e/helpers/cli.go
@test/e2e/helpers/adapters.go
@test/e2e/helpers/stores.go
@test/e2e/helpers/shares.go
@test/e2e/helpers/users.go
@test/e2e/helpers/groups.go
@test/e2e/framework/mount.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MountSMBWithError helper to framework</name>
  <files>test/e2e/framework/mount.go</files>
  <action>
Add a new function `MountSMBWithError` to `test/e2e/framework/mount.go` that:
- Has same signature as MountSMB but returns (*Mount, error) instead of *Mount
- Does NOT call t.Fatal on mount failure
- Returns error if mount fails (for testing "mount should fail" scenarios)
- Returns nil error and valid Mount if mount succeeds

This is needed for ENF-02 (no-access user cannot read) and ENF-04 (permission change) where we need to test that mount or operations fail for users without permission.

Implementation pattern:
```go
func MountSMBWithError(t *testing.T, port int, creds SMBCredentials) (*Mount, error) {
    // Same implementation as MountSMB but:
    // 1. Don't call t.Fatalf on failures
    // 2. Return error instead of failing test
    // 3. Return nil error on success
}
```

Add the function after the existing MountSMB function.
  </action>
  <verify>
Run `go build -tags=e2e ./test/e2e/framework/...` to verify compilation.
Verify function signature: `func MountSMBWithError(t *testing.T, port int, creds SMBCredentials) (*Mount, error)`
  </verify>
  <done>
MountSMBWithError function added to mount.go, compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create permission enforcement test file</name>
  <files>test/e2e/permission_enforcement_test.go</files>
  <action>
Create `test/e2e/permission_enforcement_test.go` with the following structure:

1. Package declaration with `//go:build e2e` build tag
2. Import helpers and framework packages
3. TestPermissionEnforcement function that:
   - Skips in short mode
   - Starts server via `helpers.StartServerProcess(t, "")`
   - Logs in as admin via `helpers.LoginAsAdmin(t, sp.APIURL())`
   - Creates memory metadata and payload stores
   - Creates share "/export" with `default_permission: "none"` (deny by default)
   - Creates multiple test users with different permission levels
   - Creates test group for group permission tests
   - Enables SMB adapter on dynamic port
   - Runs subtests for each requirement

4. Subtests covering:
   - ENF-01: Read-only user cannot write files
     * Create user with "read" permission on share
     * As admin via NFS: create a test file
     * Mount SMB as read-only user
     * Try to write file -> should fail with permission error
     * Reading should succeed

   - ENF-02: No-access user cannot read files
     * Create user with NO permission (default "none" applies)
     * As admin via NFS: create a test file
     * Try to mount SMB as no-access user -> should fail OR
     * If mount succeeds, read operation should fail
     * Use MountSMBWithError to handle mount failure gracefully

   - ENF-03: User removed from group loses group permissions
     * Create group with "read-write" permission on share
     * Create user and add to group
     * Mount as user, verify write works (via group permission)
     * Unmount, remove user from group
     * Re-mount, verify write now fails (no longer has group permission)

   - ENF-04: Permission change takes effect immediately
     * Create user with "read" permission
     * Mount as user, verify write fails
     * Keep mount, grant user "read-write" permission
     * Verify write now works (no remount needed, or with fresh mount)

Key patterns:
- Use `helpers.WithShareDefaultPermission("none")` when creating share
- Create users with explicit permissions via `cli.GrantUserPermission()`
- Use NFS mount as admin to create test files (avoids auth complexity)
- Test permission enforcement via SMB mounts
- Use `MountSMBWithError()` for "expected to fail" scenarios
- Add small delays after permission changes for propagation
  </action>
  <verify>
Run `go build -tags=e2e ./test/e2e/...` to verify compilation.
Run `go vet -tags=e2e ./test/e2e/permission_enforcement_test.go` to check for issues.
  </verify>
  <done>
test/e2e/permission_enforcement_test.go exists, compiles without errors, and contains TestPermissionEnforcement with 4 subtests covering ENF-01 through ENF-04.
  </done>
</task>

<task type="auto">
  <name>Task 3: Run and verify permission enforcement tests pass</name>
  <files>test/e2e/permission_enforcement_test.go</files>
  <action>
Execute the permission enforcement tests to verify they pass:

1. Build the server and CLI binaries if not already built:
   ```
   go build -o dittofs ./cmd/dittofs/
   go build -o dittofsctl ./cmd/dittofsctl/
   ```

2. Run the permission enforcement tests:
   ```
   sudo go test -tags=e2e -v -run TestPermissionEnforcement ./test/e2e/
   ```
   (sudo required for mount operations)

3. If tests fail:
   - Check that share has default_permission: "none"
   - Check that users have correct explicit permissions
   - Check that SMB auth is working (correct username/password)
   - For ENF-02, check if mount fails vs operations fail (both are valid)
   - For ENF-03, ensure clean unmount before group removal
   - Check server logs for permission-related messages
   - Fix any issues in the test file

4. Ensure all 4 subtests pass:
   - ENF-01 Read-only user cannot write
   - ENF-02 No-access user cannot read
   - ENF-03 User removed from group loses permissions
   - ENF-04 Permission change takes effect immediately
  </action>
  <verify>
Test output shows "PASS" for TestPermissionEnforcement and all 4 subtests.
No test failures or panics.
  </verify>
  <done>
All 4 permission enforcement tests (ENF-01 through ENF-04) pass successfully.
  </done>
</task>

</tasks>

<verification>
1. File exists: `test/e2e/permission_enforcement_test.go`
2. MountSMBWithError added to `test/e2e/framework/mount.go`
3. Build succeeds: `go build -tags=e2e ./test/e2e/...`
4. Tests pass: `sudo go test -tags=e2e -v -run TestPermissionEnforcement ./test/e2e/`
5. All 4 requirements covered: ENF-01 through ENF-04
</verification>

<success_criteria>
1. test/e2e/framework/mount.go has MountSMBWithError function
2. test/e2e/permission_enforcement_test.go exists and compiles
3. TestPermissionEnforcement function with 4 subtests
4. Tests use SMB for permission enforcement (not NFS)
5. Tests use default_permission: "none" and explicit grants
6. All 4 tests pass when run with sudo
</success_criteria>

<output>
After completion, create `.planning/phases/06-file-operations/06-04-SUMMARY.md`
</output>
