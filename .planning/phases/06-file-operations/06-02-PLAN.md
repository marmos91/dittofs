---
phase: 06-file-operations
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - test/e2e/file_operations_smb_test.go
autonomous: true

must_haves:
  truths:
    - "Files can be read via SMB mount"
    - "Files can be written via SMB mount"
    - "Files can be deleted via SMB mount"
    - "Directories can be listed via SMB mount"
    - "Directories can be created via SMB mount"
    - "File permissions can be changed via SMB mount"
  artifacts:
    - path: "test/e2e/file_operations_smb_test.go"
      provides: "SMB file operation E2E tests"
      exports: ["TestSMBFileOperations"]
      min_lines: 180
  key_links:
    - from: "test/e2e/file_operations_smb_test.go"
      to: "test/e2e/helpers/server.go"
      via: "StartServerProcess"
      pattern: "helpers\\.StartServerProcess"
    - from: "test/e2e/file_operations_smb_test.go"
      to: "test/e2e/framework/mount.go"
      via: "MountSMB"
      pattern: "framework\\.MountSMB"
---

<objective>
Implement SMB file operation E2E tests covering requirements SMB-01 through SMB-06.

Purpose: Validate that basic file operations (read, write, delete, mkdir, list, chmod) work correctly through the SMB protocol adapter using CLI-driven server setup with user authentication.

Output: `test/e2e/file_operations_smb_test.go` with comprehensive SMB operation tests.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-file-operations/06-RESEARCH.md

# Reference implementations
@test/e2e/adapters_test.go
@test/e2e/helpers/server.go
@test/e2e/helpers/cli.go
@test/e2e/helpers/adapters.go
@test/e2e/helpers/stores.go
@test/e2e/helpers/shares.go
@test/e2e/helpers/users.go
@test/e2e/framework/mount.go
@test/e2e/framework/helpers.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SMB file operations test file</name>
  <files>test/e2e/file_operations_smb_test.go</files>
  <action>
Create `test/e2e/file_operations_smb_test.go` with the following structure:

1. Package declaration with `//go:build e2e` build tag
2. Import helpers and framework packages
3. TestSMBFileOperations function that:
   - Skips in short mode
   - Starts server via `helpers.StartServerProcess(t, "")`
   - Logs in as admin via `helpers.LoginAsAdmin(t, sp.APIURL())`
   - Creates memory metadata store via `cli.CreateMetadataStore()`
   - Creates memory payload store via `cli.CreatePayloadStore()`
   - Creates share "/export" with default permission "read-write" via `cli.CreateShare()`
   - Creates a test user with password for SMB authentication via `cli.CreateUser()`
   - Grants user "read-write" permission on share via `cli.GrantUserPermission()`
   - Enables SMB adapter on dynamic port via `cli.EnableAdapter("smb", helpers.WithAdapterPort(port))`
   - Waits for adapter via `framework.WaitForServer(t, port, 10*time.Second)`
   - Mounts SMB share with credentials via `framework.MountSMB(t, port, creds)`
   - Runs subtests for each requirement

4. Subtests covering:
   - SMB-01: Read files - write file, verify can read it back
   - SMB-02: Write files - write file, verify it exists and content matches
   - SMB-03: Delete files - create file, delete it, verify it's gone
   - SMB-04: List directories - create dir with files, list and verify entries
   - SMB-05: Create directories - create dir, verify it exists
   - SMB-06: Change permissions - create file, chmod, verify mode changed

Key patterns to follow:
- Use `helpers.UniqueTestName()` for resource names
- Use `defer sp.ForceKill()` for cleanup
- Use `defer mount.Cleanup()` for mount cleanup
- SMB credentials: create user with known password, use framework.SMBCredentials
- Create user BEFORE enabling SMB adapter
- Grant user read-write permission on the share
- Use 200ms delay after SMB unmount on macOS (framework handles this)
- Use `framework.WriteFile()`, `framework.ReadFile()`, etc. for file operations

SMB-specific considerations:
- SMB requires authenticated user (unlike NFS AUTH_UNIX)
- Password must meet minimum requirements (8+ chars)
- User must have explicit permission on share
  </action>
  <verify>
Run `go build -tags=e2e ./test/e2e/...` to verify compilation.
Run `go vet -tags=e2e ./test/e2e/file_operations_smb_test.go` to check for issues.
  </verify>
  <done>
test/e2e/file_operations_smb_test.go exists, compiles without errors, and contains TestSMBFileOperations with 6 subtests covering SMB-01 through SMB-06.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run and verify SMB tests pass</name>
  <files>test/e2e/file_operations_smb_test.go</files>
  <action>
Execute the SMB file operations tests to verify they pass:

1. Build the server and CLI binaries if not already built:
   ```
   go build -o dittofs ./cmd/dittofs/
   go build -o dittofsctl ./cmd/dittofsctl/
   ```

2. Run the SMB file operations tests:
   ```
   sudo go test -tags=e2e -v -run TestSMBFileOperations ./test/e2e/
   ```
   (sudo required for SMB mount operations)

3. If tests fail:
   - Check server logs (test output includes logs on failure)
   - Verify SMB authentication succeeded (check for auth-related errors)
   - Verify user has correct permissions
   - Verify mount succeeded (check for mount-related errors)
   - Fix any issues in the test file

4. Ensure all 6 subtests pass:
   - SMB-01 Read files
   - SMB-02 Write files
   - SMB-03 Delete files
   - SMB-04 List directories
   - SMB-05 Create directories
   - SMB-06 Change permissions
  </action>
  <verify>
Test output shows "PASS" for TestSMBFileOperations and all 6 subtests.
No test failures or panics.
  </verify>
  <done>
All 6 SMB file operation tests (SMB-01 through SMB-06) pass successfully.
  </done>
</task>

</tasks>

<verification>
1. File exists: `test/e2e/file_operations_smb_test.go`
2. Build succeeds: `go build -tags=e2e ./test/e2e/...`
3. Tests pass: `sudo go test -tags=e2e -v -run TestSMBFileOperations ./test/e2e/`
4. All 6 requirements covered: SMB-01 through SMB-06
</verification>

<success_criteria>
1. test/e2e/file_operations_smb_test.go exists and compiles
2. TestSMBFileOperations function with 6 subtests
3. All tests use CLI-driven setup (helpers.StartServerProcess, helpers.LoginAsAdmin)
4. All tests create SMB user with proper authentication
5. All tests use framework mount helpers (framework.MountSMB with credentials)
6. All 6 tests pass when run with sudo
</success_criteria>

<output>
After completion, create `.planning/phases/06-file-operations/06-02-SUMMARY.md`
</output>
