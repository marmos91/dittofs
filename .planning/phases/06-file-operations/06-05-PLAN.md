---
phase: 06-file-operations
plan: 05
type: execute
wave: 3
depends_on: ["06-01", "06-02", "06-03"]
files_modified:
  - test/e2e/store_matrix_test.go
autonomous: true

must_haves:
  truths:
    - "All operations work with memory/memory stores"
    - "All operations work with memory/filesystem stores"
    - "All operations work with memory/s3 stores"
    - "All operations work with badger/memory stores"
    - "All operations work with badger/filesystem stores"
    - "All operations work with badger/s3 stores"
    - "All operations work with postgres/memory stores"
    - "All operations work with postgres/filesystem stores"
    - "All operations work with postgres/s3 stores"
  artifacts:
    - path: "test/e2e/store_matrix_test.go"
      provides: "Store matrix validation E2E tests"
      exports: ["TestStoreMatrixOperations"]
      min_lines: 250
  key_links:
    - from: "test/e2e/store_matrix_test.go"
      to: "test/e2e/helpers/stores.go"
      via: "CreateMetadataStore, CreatePayloadStore"
      pattern: "cli\\.Create(Metadata|Payload)Store"
    - from: "test/e2e/store_matrix_test.go"
      to: "test/e2e/framework/containers.go"
      via: "CheckPostgresAvailable, CheckLocalstackAvailable"
      pattern: "framework\\.Check(Postgres|Localstack)Available"
---

<objective>
Implement store matrix validation E2E tests covering requirements MTX-01 through MTX-09.

Purpose: Validate that all 9 combinations of metadata stores (memory, badger, postgres) and payload stores (memory, filesystem, s3) work correctly with file operations.

Output: `test/e2e/store_matrix_test.go` with comprehensive store combination tests.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-file-operations/06-RESEARCH.md

# Reference implementations
@test/e2e/interop_v2_test.go
@test/e2e/helpers/server.go
@test/e2e/helpers/cli.go
@test/e2e/helpers/adapters.go
@test/e2e/helpers/stores.go
@test/e2e/helpers/shares.go
@test/e2e/framework/mount.go
@test/e2e/framework/helpers.go
@test/e2e/framework/config.go
@test/e2e/framework/containers.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create store matrix test file</name>
  <files>test/e2e/store_matrix_test.go</files>
  <action>
Create `test/e2e/store_matrix_test.go` with the following structure:

1. Package declaration with `//go:build e2e` build tag
2. Import helpers and framework packages

3. Define store matrix configuration:
```go
type storeConfig struct {
    metadataType string  // "memory", "badger", "postgres"
    payloadType  string  // "memory", "filesystem", "s3"
}

var storeMatrix = []storeConfig{
    {"memory", "memory"},      // MTX-01
    {"memory", "filesystem"},  // MTX-02
    {"memory", "s3"},          // MTX-03
    {"badger", "memory"},      // MTX-04
    {"badger", "filesystem"},  // MTX-05
    {"badger", "s3"},          // MTX-06
    {"postgres", "memory"},    // MTX-07
    {"postgres", "filesystem"}, // MTX-08
    {"postgres", "s3"},        // MTX-09
}
```

4. TestStoreMatrixOperations function that:
   - Loops over storeMatrix
   - For each combination, runs a subtest named "{metadata}/{payload}"
   - Skips postgres combinations if `!framework.CheckPostgresAvailable(t)`
   - Skips s3 combinations if `!framework.CheckLocalstackAvailable(t)`
   - Starts server via `helpers.StartServerProcess(t, "")`
   - Creates metadata store with appropriate type and options:
     * memory: no options needed
     * badger: `helpers.WithMetaDBPath(t.TempDir() + "/badger")`
     * postgres: `helpers.WithMetaRawConfig(postgresConfigJSON)` - get from framework.NewPostgresHelper
   - Creates payload store with appropriate type and options:
     * memory: no options needed
     * filesystem: `helpers.WithPayloadPath(t.TempDir() + "/payload")`
     * s3: `helpers.WithPayloadS3Config(bucket, region, endpoint, accessKey, secretKey)` - get from framework.NewLocalstackHelper
   - Creates share, enables NFS adapter, mounts NFS
   - Runs core file operation tests

5. Core operations to test for each combination:
   - Create file, write content, read back, verify match
   - Create directory, create files inside
   - List directory, verify entries
   - Delete file, verify deleted
   - Large file test (1MB) with checksum verification

Key patterns:
- Use `t.Skip()` for unavailable containers, NOT t.Fatal()
- Each subtest gets fresh server (clean isolation)
- Use `t.TempDir()` for badger and filesystem paths
- For postgres: get config from framework.NewPostgresHelper().GetConfig()
- For s3: get config from framework.NewLocalstackHelper()
- Create unique bucket per test using test name
- Only test NFS (not both protocols) - cross-protocol already tested in 06-03
- Keep operations focused: create, read, write, delete, list
  </action>
  <verify>
Run `go build -tags=e2e ./test/e2e/...` to verify compilation.
Run `go vet -tags=e2e ./test/e2e/store_matrix_test.go` to check for issues.
  </verify>
  <done>
test/e2e/store_matrix_test.go exists, compiles without errors, and contains TestStoreMatrixOperations with 9 subtests for all store combinations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run local store matrix tests (no containers)</name>
  <files>test/e2e/store_matrix_test.go</files>
  <action>
Execute the store matrix tests for local store combinations (no Docker needed):

1. Build the server and CLI binaries:
   ```
   go build -o dittofs ./cmd/dittofs/
   go build -o dittofsctl ./cmd/dittofsctl/
   ```

2. Run just the local combinations (memory/memory, memory/filesystem, badger/memory, badger/filesystem):
   ```
   sudo go test -tags=e2e -v -run "TestStoreMatrixOperations/(memory|badger)/(memory|filesystem)" ./test/e2e/
   ```

3. If tests fail:
   - Check that stores are created correctly
   - Verify paths exist for badger/filesystem
   - Check server logs for store-related errors
   - Fix any issues in the test file

4. Verify 4 subtests pass:
   - memory/memory (MTX-01)
   - memory/filesystem (MTX-02)
   - badger/memory (MTX-04)
   - badger/filesystem (MTX-05)
  </action>
  <verify>
Test output shows "PASS" for the 4 local store combinations.
Postgres and S3 combinations are skipped (expected).
  </verify>
  <done>
4 local store combination tests pass (MTX-01, MTX-02, MTX-04, MTX-05).
  </done>
</task>

<task type="auto">
  <name>Task 3: Run full store matrix tests (with containers)</name>
  <files>test/e2e/store_matrix_test.go</files>
  <action>
Execute the full store matrix tests including postgres and S3:

1. Ensure Docker is available for testcontainers

2. Run all store matrix tests:
   ```
   sudo go test -tags=e2e -v -run TestStoreMatrixOperations ./test/e2e/ -timeout 10m
   ```
   (10 minute timeout for container startup)

3. If container-dependent tests fail:
   - For postgres: Check testcontainers logs, verify postgres is healthy
   - For S3: Check Localstack is running, verify bucket creation succeeds
   - Increase timeout if containers take long to start
   - Check that store config JSON is valid

4. All 9 subtests should pass (or skip gracefully if containers unavailable):
   - MTX-01: memory/memory
   - MTX-02: memory/filesystem
   - MTX-03: memory/s3
   - MTX-04: badger/memory
   - MTX-05: badger/filesystem
   - MTX-06: badger/s3
   - MTX-07: postgres/memory
   - MTX-08: postgres/filesystem
   - MTX-09: postgres/s3

Note: If Docker is unavailable, postgres and S3 tests should SKIP not FAIL.
  </action>
  <verify>
Test output shows "PASS" or "SKIP" (not FAIL) for all 9 store combinations.
At minimum, all 4 local combinations pass.
  </verify>
  <done>
All 9 store matrix tests (MTX-01 through MTX-09) pass when containers are available, or skip gracefully when unavailable.
  </done>
</task>

</tasks>

<verification>
1. File exists: `test/e2e/store_matrix_test.go`
2. Build succeeds: `go build -tags=e2e ./test/e2e/...`
3. Local tests pass: `sudo go test -tags=e2e -v -run "TestStoreMatrixOperations/(memory|badger)/(memory|filesystem)" ./test/e2e/`
4. Full tests pass or skip: `sudo go test -tags=e2e -v -run TestStoreMatrixOperations ./test/e2e/ -timeout 10m`
5. All 9 requirements covered: MTX-01 through MTX-09
</verification>

<success_criteria>
1. test/e2e/store_matrix_test.go exists and compiles
2. TestStoreMatrixOperations with 9 subtest configurations
3. Proper skip logic for unavailable containers
4. Each combination tests: create, read, write, delete, list
5. All 4 local combinations pass (no containers needed)
6. All 9 combinations pass when containers available
</success_criteria>

<output>
After completion, create `.planning/phases/06-file-operations/06-05-SUMMARY.md`
</output>
