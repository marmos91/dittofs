---
phase: 06-file-operations
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - test/e2e/cross_protocol_test.go
autonomous: true

must_haves:
  truths:
    - "File created via NFS is readable via SMB"
    - "File created via SMB is readable via NFS"
    - "File created via NFS is deletable via SMB"
    - "File created via SMB is deletable via NFS"
    - "Directory created via NFS is listable via SMB"
    - "Directory created via SMB is listable via NFS"
  artifacts:
    - path: "test/e2e/cross_protocol_test.go"
      provides: "Cross-protocol interoperability E2E tests"
      exports: ["TestCrossProtocolInterop"]
      min_lines: 200
  key_links:
    - from: "test/e2e/cross_protocol_test.go"
      to: "test/e2e/framework/mount.go"
      via: "MountNFS and MountSMB"
      pattern: "framework\\.Mount(NFS|SMB)"
    - from: "test/e2e/cross_protocol_test.go"
      to: "test/e2e/helpers/server.go"
      via: "StartServerProcess"
      pattern: "helpers\\.StartServerProcess"
---

<objective>
Implement cross-protocol interoperability E2E tests covering requirements XPR-01 through XPR-06.

Purpose: Validate that files and directories created via one protocol (NFS or SMB) are accessible via the other protocol, proving the shared metadata/content store architecture works correctly.

Output: `test/e2e/cross_protocol_test.go` with comprehensive cross-protocol tests.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-file-operations/06-RESEARCH.md

# Reference implementations
@test/e2e/interop_v2_test.go
@test/e2e/helpers/server.go
@test/e2e/helpers/cli.go
@test/e2e/helpers/adapters.go
@test/e2e/helpers/stores.go
@test/e2e/helpers/shares.go
@test/e2e/helpers/users.go
@test/e2e/framework/mount.go
@test/e2e/framework/helpers.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cross-protocol interop test file</name>
  <files>test/e2e/cross_protocol_test.go</files>
  <action>
Create `test/e2e/cross_protocol_test.go` with the following structure:

1. Package declaration with `//go:build e2e` build tag
2. Import helpers and framework packages
3. TestCrossProtocolInterop function that:
   - Skips in short mode
   - Starts server via `helpers.StartServerProcess(t, "")`
   - Logs in as admin via `helpers.LoginAsAdmin(t, sp.APIURL())`
   - Creates memory metadata store
   - Creates memory payload store
   - Creates share "/export" with default permission "read-write"
   - Creates SMB test user and grants read-write permission
   - Enables BOTH NFS and SMB adapters on dynamic ports
   - Waits for both adapters
   - Mounts BOTH NFS and SMB shares
   - Runs subtests for each cross-protocol requirement

4. Subtests covering:
   - XPR-01: File created via NFS readable via SMB
     * Write file via NFS mount
     * Wait 100-200ms for metadata sync
     * Read file via SMB mount, verify content matches
   - XPR-02: File created via SMB readable via NFS
     * Write file via SMB mount
     * Wait 100-200ms for metadata sync
     * Read file via NFS mount, verify content matches
   - XPR-03: File created via NFS deletable via SMB
     * Create file via NFS
     * Wait for sync
     * Delete via SMB (os.Remove)
     * Verify deleted via NFS
   - XPR-04: File created via SMB deletable via NFS
     * Create file via SMB
     * Wait for sync
     * Delete via NFS (os.Remove)
     * Verify deleted via SMB
   - XPR-05: Directory created via NFS listable via SMB
     * Create dir via NFS with files inside
     * Wait for sync
     * List via SMB, verify entries match
   - XPR-06: Directory created via SMB listable via NFS
     * Create dir via SMB with files inside
     * Wait for sync
     * List via NFS, verify entries match

Key patterns to follow:
- Use `helpers.UniqueTestName()` for resource names
- Use `defer sp.ForceKill()` and `defer mount.Cleanup()` for cleanup
- Add 100-200ms `time.Sleep()` between write via one protocol and read via other
- Use longer delay (500ms) for delete operations (attribute cache invalidation)
- Use `framework.WriteFile()`, `framework.ReadFile()`, `framework.CreateDir()`, etc.
- Both mounts share the SAME stores - changes are visible cross-protocol
  </action>
  <verify>
Run `go build -tags=e2e ./test/e2e/...` to verify compilation.
Run `go vet -tags=e2e ./test/e2e/cross_protocol_test.go` to check for issues.
  </verify>
  <done>
test/e2e/cross_protocol_test.go exists, compiles without errors, and contains TestCrossProtocolInterop with 6 subtests covering XPR-01 through XPR-06.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run and verify cross-protocol tests pass</name>
  <files>test/e2e/cross_protocol_test.go</files>
  <action>
Execute the cross-protocol tests to verify they pass:

1. Build the server and CLI binaries if not already built:
   ```
   go build -o dittofs ./cmd/dittofs/
   go build -o dittofsctl ./cmd/dittofsctl/
   ```

2. Run the cross-protocol tests:
   ```
   sudo go test -tags=e2e -v -run TestCrossProtocolInterop ./test/e2e/
   ```
   (sudo required for mount operations)

3. If tests fail:
   - Check if both NFS and SMB adapters started successfully
   - Check if both mounts succeeded
   - If "file not found" errors, increase sync delays (100ms -> 200ms -> 500ms)
   - Check server logs for errors
   - Fix any issues in the test file

4. Ensure all 6 subtests pass:
   - XPR-01 File created via NFS readable via SMB
   - XPR-02 File created via SMB readable via NFS
   - XPR-03 File created via NFS deletable via SMB
   - XPR-04 File created via SMB deletable via NFS
   - XPR-05 Directory created via NFS listable via SMB
   - XPR-06 Directory created via SMB listable via NFS
  </action>
  <verify>
Test output shows "PASS" for TestCrossProtocolInterop and all 6 subtests.
No test failures or panics.
  </verify>
  <done>
All 6 cross-protocol tests (XPR-01 through XPR-06) pass successfully.
  </done>
</task>

</tasks>

<verification>
1. File exists: `test/e2e/cross_protocol_test.go`
2. Build succeeds: `go build -tags=e2e ./test/e2e/...`
3. Tests pass: `sudo go test -tags=e2e -v -run TestCrossProtocolInterop ./test/e2e/`
4. All 6 requirements covered: XPR-01 through XPR-06
</verification>

<success_criteria>
1. test/e2e/cross_protocol_test.go exists and compiles
2. TestCrossProtocolInterop function with 6 subtests
3. Both NFS and SMB adapters enabled in same test
4. Both NFS and SMB mounts created
5. Proper sync delays between cross-protocol operations
6. All 6 tests pass when run with sudo
</success_criteria>

<output>
After completion, create `.planning/phases/06-file-operations/06-03-SUMMARY.md`
</output>
