---
phase: 30-smb-bug-fixes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/adapter/smb/v2/handlers/create.go
  - internal/adapter/smb/v2/handlers/converters.go
  - internal/adapter/smb/v2/handlers/create_test.go
  - internal/adapter/smb/v2/handlers/converters_test.go
autonomous: true
requirements:
  - BUG-03
  - BUG-05

must_haves:
  truths:
    - "Multi-component paths with '..' segments navigate to the correct parent directory"
    - "FileStandardInfo.NumberOfLinks reports the actual link count from metadata, not hardcoded 1"
    - "Paths like 'a/b/../c' resolve correctly to 'a/c'"
  artifacts:
    - path: "internal/adapter/smb/v2/handlers/create.go"
      provides: "Parent directory navigation in walkPath"
      contains: "metaSvc.Lookup(authCtx, currentHandle"
    - path: "internal/adapter/smb/v2/handlers/converters.go"
      provides: "Dynamic NumberOfLinks from attr.Nlink"
      contains: "attr.Nlink"
  key_links:
    - from: "internal/adapter/smb/v2/handlers/create.go"
      to: "pkg/metadata/service.go"
      via: "metaSvc.Lookup for '..' parent resolution"
      pattern: "Lookup.*\\.\\."
    - from: "internal/adapter/smb/v2/handlers/converters.go"
      to: "pkg/metadata/store.go"
      via: "FileAttr.Nlink field"
      pattern: "Nlink"
---

<objective>
Fix parent directory navigation in SMB paths (#214) and hardcoded NumberOfLinks (#221).

Purpose: (1) The `walkPath()` function in `create.go` silently skips `..` path segments with a TODO comment, breaking multi-component paths like `a/b/../c`. Windows clients use these paths regularly. (2) `FileAttrToFileStandardInfo()` hardcodes `NumberOfLinks: 1` instead of using the actual `attr.Nlink` value that all store implementations already populate correctly.

Output: Fixed walkPath with parent directory resolution + dynamic link count + tests
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-smb-bug-fixes/30-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs -->

From pkg/metadata/service.go:
```go
// Lookup resolves a name within a directory.
// When name is "..", returns the parent directory.
func (s *MetadataService) Lookup(ctx *AuthContext, dirHandle FileHandle, name string) (*File, error)
```

From pkg/metadata/store.go:
```go
type FileAttr struct {
    // ...
    Nlink uint32  // Number of hard links (already populated by all stores)
    // ...
}
```

From internal/adapter/smb/v2/handlers/create.go (walkPath, line 760-789):
```go
func walkPath(metaSvc *metadata.MetadataService, authCtx *metadata.AuthContext, rootHandle metadata.FileHandle, pathStr string) (*metadata.File, error) {
    currentHandle := rootHandle
    // ...
    for _, part := range parts {
        if part == ".." {
            // TODO: Handle parent directory navigation
            continue  // <-- BUG: silently skips parent navigation
        }
        // ...
    }
}
```

From internal/adapter/smb/v2/handlers/converters.go (line 159-165):
```go
func FileAttrToFileStandardInfo(attr *metadata.FileAttr, isDeletePending bool) *FileStandardInfo {
    return &FileStandardInfo{
        // ...
        NumberOfLinks: 1, // TODO: Track actual link count when available
        // ...
    }
}
```

From pkg/metadata/object.go:
```go
func EncodeFileHandle(file *File) (FileHandle, error)
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix walkPath parent directory navigation and NumberOfLinks</name>
  <files>internal/adapter/smb/v2/handlers/create.go, internal/adapter/smb/v2/handlers/converters.go</files>
  <action>
**Fix 1: Parent directory navigation in `create.go`, function `walkPath()` (line 768-770):**

Replace the TODO block:
```go
if part == ".." {
    // TODO: Handle parent directory navigation
    continue
}
```

With actual parent resolution using the existing `Lookup` method which already handles `..`:
```go
if part == ".." {
    // Navigate to parent directory
    parentFile, err := metaSvc.Lookup(authCtx, currentHandle, "..")
    if err != nil {
        // If parent lookup fails (e.g., at root), stay at current directory
        logger.Debug("walkPath: parent navigation failed, staying at current",
            "error", err)
        continue
    }
    currentHandle, err = metadata.EncodeFileHandle(parentFile)
    if err != nil {
        return nil, fmt.Errorf("encode parent handle: %w", err)
    }
    continue
}
```

Note: `metaSvc.Lookup` already handles the `..` case by looking up the parent reference. If we're at the root, Lookup for `..` typically returns the root itself (POSIX behavior). The `logger` import should already be available.

**Fix 2: NumberOfLinks in `converters.go`, function `FileAttrToFileStandardInfo()` (line 162):**

Replace:
```go
NumberOfLinks: 1, // TODO: Track actual link count when available
```

With:
```go
NumberOfLinks: max(attr.Nlink, 1), // Use actual link count, minimum 1 for safety
```

The `max` builtin is available in Go 1.21+. If the project uses an older Go version, use an inline conditional:
```go
nlinks := attr.Nlink
if nlinks == 0 {
    nlinks = 1  // Default to 1 if not tracked (safety for legacy data)
}
// ...
NumberOfLinks: nlinks,
```

This uses `attr.Nlink` which is already populated by all store implementations (memory, BadgerDB, PostgreSQL). The `0 -> 1` fallback protects against uninitialized metadata.
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs-phase-30 && go build ./internal/adapter/smb/...</automated>
  </verify>
  <done>walkPath resolves `..` segments by calling metaSvc.Lookup for parent directory. FileStandardInfo.NumberOfLinks reads actual attr.Nlink with minimum-1 fallback.</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for parent navigation and NumberOfLinks</name>
  <files>internal/adapter/smb/v2/handlers/create_test.go, internal/adapter/smb/v2/handlers/converters_test.go</files>
  <action>
**In `converters_test.go`** (add to existing or create):

1. **TestFileAttrToFileStandardInfo_NumberOfLinks**: Test that:
   - `Nlink=3` produces `NumberOfLinks=3`
   - `Nlink=1` produces `NumberOfLinks=1`
   - `Nlink=0` produces `NumberOfLinks=1` (safety fallback)
   - Directory with `Nlink=2` (standard . and ..) produces `NumberOfLinks=2`

```go
func TestFileAttrToFileStandardInfo_NumberOfLinks(t *testing.T) {
    tests := []struct {
        name     string
        nlink    uint32
        expected uint32
    }{
        {"normal file", 1, 1},
        {"hard linked file", 3, 3},
        {"uninitialized (zero)", 0, 1},
        {"directory with dot-dot", 2, 2},
    }
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            attr := &metadata.FileAttr{Nlink: tt.nlink}
            info := FileAttrToFileStandardInfo(attr, false)
            assert.Equal(t, tt.expected, info.NumberOfLinks)
        })
    }
}
```

**In `create_test.go`** (add to existing or create):

Test `walkPath` with `..` segments. This requires mocking the MetadataService. If direct testing is impractical due to MetadataService dependencies, write a focused integration-style test:

1. **TestWalkPath_ParentNavigation**: Set up a memory metadata store with `/root/a/b` hierarchy. Call walkPath with path `a/b/../../a` and verify it resolves to `/root/a`.

2. **TestWalkPath_DotDotAtRoot**: Call walkPath with path `..` from root. Verify it stays at root (no error).

3. **TestWalkPath_MixedSegments**: Call walkPath with path `a/./b/../c` and verify it resolves correctly (`.` skipped, `..` navigates up, `c` resolved).

If MetadataService mocking is too complex (since it requires a full store), create the tests using the memory store directly for a lightweight integration test:
```go
func setupTestMetadataService(t *testing.T) (*metadata.MetadataService, metadata.FileHandle) {
    store := memory.NewMemoryStore()
    svc := metadata.NewMetadataService()
    rootHandle := svc.RegisterStore("test", store)
    // Create test directory hierarchy...
    return svc, rootHandle
}
```

Use `github.com/stretchr/testify/assert` and `github.com/stretchr/testify/require`.
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs-phase-30 && go test -v ./internal/adapter/smb/v2/handlers/ -run "NumberOfLinks|WalkPath|walkPath|ParentNav"</automated>
  </verify>
  <done>Tests verify: (1) NumberOfLinks uses actual Nlink with zero-fallback, (2) walkPath resolves `..` to parent directory, (3) `..` at root stays at root, (4) mixed path segments resolve correctly.</done>
</task>

</tasks>

<verification>
1. `go build ./internal/adapter/smb/...` compiles cleanly
2. `go test ./internal/adapter/smb/v2/handlers/` passes (including new tests)
3. `go vet ./internal/adapter/smb/...` reports no issues
4. Existing handler tests still pass
</verification>

<success_criteria>
- Paths with `..` segments navigate to the correct parent directory in SMB CREATE
- NumberOfLinks reports actual link count from metadata, minimum 1
- Unit tests cover parent navigation edge cases and link count scenarios
- No regressions in existing SMB handler tests
</success_criteria>

<output>
After completion, create `.planning/phases/30-smb-bug-fixes/30-03-SUMMARY.md`
</output>
