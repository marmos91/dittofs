---
phase: 09-state-management
plan: 04
type: execute
wave: 4
depends_on: ["09-03"]
files_modified:
  - internal/protocol/nfs/v4/state/grace.go
  - internal/protocol/nfs/v4/state/grace_test.go
  - internal/protocol/nfs/v4/state/manager.go
  - internal/protocol/nfs/v4/handlers/open.go
  - internal/protocol/nfs/v4/handlers/handler.go
autonomous: true

must_haves:
  truths:
    - "Server enters grace period on startup, blocking new OPEN requests"
    - "OPEN with CLAIM_PREVIOUS allowed during grace period for state reclaim"
    - "Non-reclaim operations return NFS4ERR_GRACE during grace period"
    - "Grace period ends automatically after configured duration"
    - "Grace period ends early when all known clients have reclaimed"
  artifacts:
    - path: "internal/protocol/nfs/v4/state/grace.go"
      provides: "NFSv4 grace period state machine with CLAIM_PREVIOUS support"
      exports: ["GracePeriodState", "NewGracePeriodState", "IsInGrace", "ClientReclaimed"]
    - path: "internal/protocol/nfs/v4/state/grace_test.go"
      provides: "Tests for grace period lifecycle"
      contains: "TestGracePeriod"
  key_links:
    - from: "internal/protocol/nfs/v4/handlers/open.go"
      to: "internal/protocol/nfs/v4/state/manager.go"
      via: "StateManager.IsInGrace() check before new OPEN, bypass for CLAIM_PREVIOUS"
      pattern: "IsInGrace|CLAIM_PREVIOUS"
    - from: "internal/protocol/nfs/v4/state/grace.go"
      to: "internal/protocol/nfs/v4/state/manager.go"
      via: "Grace period notifies StateManager when complete"
      pattern: "GracePeriodState|onGraceEnd"
---

<objective>
Implement NFSv4 grace period handling for server restart recovery, with CLAIM_PREVIOUS support in OPEN for state reclaim.

Purpose: When the server restarts, clients need a window to reclaim their previously-held state (open files, locks). During this grace period, new state-creating operations are blocked (NFS4ERR_GRACE) while reclaim operations (OPEN with CLAIM_PREVIOUS) are allowed. This is required by RFC 7530 Section 9.6 and satisfies STATE-09.

Output: Grace period state machine, CLAIM_PREVIOUS support in OPEN, NFS4ERR_GRACE blocking, and basic client record persistence for reclaim detection.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-state-management/09-RESEARCH.md
@.planning/phases/09-state-management/09-03-SUMMARY.md

@internal/protocol/nfs/v4/state/manager.go
@internal/protocol/nfs/v4/state/client.go
@internal/protocol/nfs/v4/state/lease.go
@internal/protocol/nfs/v4/handlers/open.go
@internal/protocol/nfs/v4/handlers/handler.go
@pkg/metadata/lock/grace.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement grace period state machine and integrate with StateManager</name>
  <files>
    internal/protocol/nfs/v4/state/grace.go
    internal/protocol/nfs/v4/state/grace_test.go
    internal/protocol/nfs/v4/state/manager.go
  </files>
  <action>
**state/grace.go** -- NFSv4 grace period (inspired by pkg/metadata/lock/grace.go pattern but NFSv4-specific):
- `GracePeriodState` struct:
  - `mu sync.Mutex`
  - `active bool`
  - `duration time.Duration`
  - `timer *time.Timer`
  - `expectedClients map[uint64]bool` -- client IDs that existed before restart (for early exit)
  - `reclaimedClients map[uint64]bool` -- clients that have completed reclaim
  - `onGraceEnd func()` -- callback when grace period ends
- `NewGracePeriodState(duration time.Duration, onGraceEnd func()) *GracePeriodState`
- `StartGrace(expectedClientIDs []uint64)`:
  - Sets active=true, populates expectedClients map
  - Starts timer for automatic grace period exit after duration
  - If expectedClientIDs is empty, skip grace period entirely (no clients to reclaim)
- `IsInGrace() bool` -- returns active state
- `ClientReclaimed(clientID uint64)`:
  - Marks clientID as reclaimed
  - If ALL expected clients have reclaimed, call endGrace() early
- `endGrace()`:
  - Sets active=false, stops timer, calls onGraceEnd callback
  - Idempotent (multiple calls are safe)
- `Stop()` -- clean shutdown (stops timer)

**state/manager.go** modifications:
- Add `gracePeriod *GracePeriodState` field to StateManager
- Add `graceDuration time.Duration` config field (default: reuse leaseDuration, or separate config)
- Update `NewStateManager` to accept `graceDuration time.Duration` parameter
- Add `StartGracePeriod(previousClientIDs []uint64)`:
  - Creates and starts a GracePeriodState
  - Called by the NFS adapter on server startup if there were previous clients
  - The onGraceEnd callback logs "NFSv4 grace period ended"
- Add `IsInGrace() bool` -- delegates to gracePeriod.IsInGrace()
- Add `CheckGraceForNewState() error`:
  - If in grace period, returns NFS4ERR_GRACE via NFS4StateError
  - If not in grace, returns nil
- Modify `OpenFile()` to check grace period:
  - If claimType == CLAIM_NULL (new open) and IsInGrace() -> return NFS4ERR_GRACE
  - If claimType == CLAIM_PREVIOUS (reclaim) and IsInGrace() -> allow, call gracePeriod.ClientReclaimed(clientID)
  - If claimType == CLAIM_PREVIOUS and NOT in grace -> return NFS4ERR_NO_GRACE
- Add basic client record persistence for reclaim:
  - `GetConfirmedClientIDs() []uint64` -- returns list of all confirmed client IDs (for saving before shutdown)
  - `LoadPreviousClients(clientIDs []uint64)` -- populates expectedClients list for grace period startup
  - For Phase 9, persistence is IN-MEMORY ONLY: the NFS adapter saves client IDs to a file on graceful shutdown and reads them on startup. Full database persistence (STATE-08) deferred per research recommendation.
- Add `SaveClientState() []ClientSnapshot` and `ClientSnapshot` struct:
  - ClientSnapshot: ClientID (uint64), ClientIDString (string), Verifier ([8]byte), ClientAddr (string)
  - Used for graceful shutdown serialization

**state/grace_test.go** tests:
- `TestGracePeriod_Active` -- starts active, becomes inactive after duration
- `TestGracePeriod_BlocksNewOpen` -- CheckGraceForNewState returns NFS4ERR_GRACE during grace
- `TestGracePeriod_AllowsReclaim` -- CLAIM_PREVIOUS allowed during grace
- `TestGracePeriod_EarlyExit` -- all expected clients reclaim, grace ends early
- `TestGracePeriod_EmptyClients` -- no expected clients, grace period skipped
- `TestGracePeriod_AutoExpiry` -- grace ends after duration even if not all clients reclaim
- `TestGracePeriod_NoGraceForReclaim` -- CLAIM_PREVIOUS outside grace returns NFS4ERR_NO_GRACE
- `TestSaveClientState` -- SaveClientState returns snapshots of all confirmed clients
- `TestConcurrentGracePeriod` -- concurrent reclaim calls are race-free

All tests use short durations (50-100ms) for speed. Run with `go test -race -v ./internal/protocol/nfs/v4/state/`.
  </action>
  <verify>
Run `go test -race -v ./internal/protocol/nfs/v4/state/` -- all grace period tests pass.
Run `go build ./internal/protocol/nfs/v4/state/` -- compiles.
  </verify>
  <done>Grace period state machine works with automatic and early expiry. StateManager blocks new OPENs during grace, allows CLAIM_PREVIOUS for reclaim. Client snapshot save/load for shutdown persistence exists.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate grace period into OPEN handler and NFS adapter lifecycle</name>
  <files>
    internal/protocol/nfs/v4/handlers/open.go
    internal/protocol/nfs/v4/handlers/handler.go
  </files>
  <action>
**handlers/open.go** modifications:
- The OPEN handler already decodes claim_type. After decoding claim_type:
  - If claim_type == CLAIM_NULL (0) -- this is a NEW open:
    - Before the existing file creation/lookup logic, check `h.StateManager.CheckGraceForNewState()`
    - If returns NFS4ERR_GRACE error, return that status immediately
    - If nil, proceed with existing logic
  - If claim_type == CLAIM_PREVIOUS (1) -- this is a RECLAIM open:
    - This is a new code path. The client is requesting to reclaim previously-held state.
    - Decode the delegation type (uint32) from the reader (CLAIM_PREVIOUS args per RFC 7530)
    - Call `h.StateManager.OpenFile()` with claimType = CLAIM_PREVIOUS
    - The StateManager handles grace period check and client reclaim notification internally
    - On success, return a new stateid for the reclaimed open (same as normal OPEN response)
    - Encode response same as CLAIM_NULL success path
  - If claim_type == CLAIM_DELEGATE_CUR (2) or CLAIM_DELEGATE_PREV (3):
    - Return NFS4ERR_NOTSUPP (delegation claims deferred to Phase 11)
  - Existing CLAIM_NULL handling remains the primary path

**handlers/handler.go** modifications:
- Update `NewHandler` to also accept `graceDuration time.Duration` or let the caller pass these via the StateManager config
- Actually, the StateManager is already constructed externally and passed in. No changes needed here unless we need to start the grace period from the handler level.
- Add a comment documenting that the NFS adapter should call `handler.StateManager.StartGracePeriod(previousClientIDs)` on startup if previous clients exist, and `handler.StateManager.SaveClientState()` on shutdown.

Also ensure that other state-modifying operations respect grace period:
- LOCK operations (Phase 10) will need grace checks -- add a comment in state/manager.go
- For Phase 9, OPEN is the only operation that needs grace checking (RENEW works during grace, CLOSE works during grace, READ/WRITE with existing stateids work during grace)

Run all handler and state tests to verify no regressions.
  </action>
  <verify>
Run `go test -race ./internal/protocol/nfs/v4/state/` -- all state tests pass.
Run `go test -race ./internal/protocol/nfs/v4/handlers/` -- all handler tests pass.
Run `go build ./...` -- entire project compiles.
Run `go vet ./...` -- no static analysis issues.
  </verify>
  <done>OPEN handler respects grace period: CLAIM_NULL blocked during grace (NFS4ERR_GRACE), CLAIM_PREVIOUS allowed for reclaim. Grace period lifecycle documented for NFS adapter integration. All tests pass.</done>
</task>

</tasks>

<verification>
1. `go test -race ./internal/protocol/nfs/v4/state/` -- all state tests pass (client + stateid + openowner + lease + grace)
2. `go test -race ./internal/protocol/nfs/v4/handlers/` -- all handler tests pass
3. `go build ./...` -- entire project compiles
4. `go vet ./...` -- clean static analysis
5. OPEN with CLAIM_NULL returns NFS4ERR_GRACE during grace period
6. OPEN with CLAIM_PREVIOUS works during grace period
7. Grace period ends automatically or early when all clients reclaim
</verification>

<success_criteria>
- Grace period blocks new OPEN (CLAIM_NULL) with NFS4ERR_GRACE
- Grace period allows OPEN with CLAIM_PREVIOUS for state reclaim
- Grace period ends automatically after configured duration
- Grace period ends early when all expected clients have reclaimed
- Empty client list skips grace period entirely
- CLAIM_PREVIOUS outside grace period returns NFS4ERR_NO_GRACE
- Client snapshot save/load enables future persistence
- 9+ grace period tests pass with race detection
- All existing handler and state tests remain green
</success_criteria>

<output>
After completion, create `.planning/phases/09-state-management/09-04-SUMMARY.md`
</output>
