---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cmd/dittofsctl/commands/share/mount.go
  - cmd/dittofsctl/commands/share/unmount.go
  - cmd/dittofsctl/commands/share/share.go
autonomous: true

must_haves:
  truths:
    - "User can mount a share via NFS using dittofsctl share mount --protocol nfs"
    - "User can mount a share via SMB using dittofsctl share mount --protocol smb"
    - "User can unmount any mounted share using dittofsctl share unmount"
    - "Mount errors include actionable suggestions"
  artifacts:
    - path: "cmd/dittofsctl/commands/share/mount.go"
      provides: "Mount subcommand with NFS and SMB support"
      exports: ["mountCmd"]
      min_lines: 100
    - path: "cmd/dittofsctl/commands/share/unmount.go"
      provides: "Unmount subcommand"
      exports: ["unmountCmd"]
      min_lines: 50
  key_links:
    - from: "cmd/dittofsctl/commands/share/share.go"
      to: "cmd/dittofsctl/commands/share/mount.go"
      via: "Cmd.AddCommand(mountCmd)"
      pattern: "AddCommand.*mountCmd"
    - from: "cmd/dittofsctl/commands/share/share.go"
      to: "cmd/dittofsctl/commands/share/unmount.go"
      via: "Cmd.AddCommand(unmountCmd)"
      pattern: "AddCommand.*unmountCmd"
---

<objective>
Implement mount and unmount CLI commands for DittoFS shares.

Purpose: Enable users to mount shares via NFS or SMB protocol using a simple CLI interface, replacing the need to manually construct platform-specific mount commands.

Output: Two new subcommands under `dittofsctl share`: `mount` and `unmount`.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md

# Reference existing patterns
@cmd/dittofsctl/commands/share/share.go
@cmd/dittofsctl/commands/share/create.go
@test/e2e/framework/mount.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement mount command with NFS and SMB support</name>
  <files>
    cmd/dittofsctl/commands/share/mount.go
    cmd/dittofsctl/commands/share/share.go
  </files>
  <action>
Create `cmd/dittofsctl/commands/share/mount.go` implementing the mount subcommand:

1. **Command structure:**
   - Use: `mount [share] [mountpoint]`
   - Args: ExactArgs(2) - share path and mount point
   - Required flag: `--protocol, -p` (nfs or smb)
   - Optional flags for SMB: `--username, -u` and `--password, -P`

2. **Mount point validation:**
   - Check mount point exists (os.Stat)
   - Check mount point is a directory
   - Check mount point is empty (os.ReadDir should return no entries)
   - Return helpful error with hint: "Create the directory first with 'mkdir %s'"

3. **NFS mount implementation (copy pattern from test/e2e/framework/mount.go):**
   - macOS: `mount -t nfs -o nfsvers=3,tcp,port=PORT,mountport=PORT,resvport,actimeo=0 localhost:SHARE MOUNTPOINT`
   - Linux: `mount -t nfs -o nfsvers=3,tcp,port=PORT,mountport=PORT,nolock,actimeo=0 localhost:SHARE MOUNTPOINT`
   - Get NFS port from server via API client: fetch adapter list, find NFS adapter, get port (default 12049)

4. **SMB mount implementation (copy pattern from test/e2e/framework/mount.go):**
   - macOS: `mount_smbfs //USER:PASS@localhost:PORT/SHARE MOUNTPOINT`
   - Linux: `mount -t cifs //localhost/SHARE MOUNTPOINT -o port=PORT,username=USER,password=PASS,vers=2.1`
   - If username not provided, use current dittofsctl login username
   - If password not provided and username is specified, prompt interactively
   - Get SMB port from server via API client (default 12445)

5. **Error handling with actionable suggestions:**
   - "connection refused" -> "Hint: Is the NFS/SMB adapter running? Check with 'dittofsctl adapter list'"
   - "not found" -> "Hint: Does the share exist? Check with 'dittofsctl share list'"
   - "permission denied" -> "Hint: Mount commands may require sudo privileges"
   - "unsupported platform" -> "Hint: Supported platforms are macOS and Linux"

6. **Success output:** `Mounted /myshare at /mnt/myshare`

7. **Update share.go:** Add `Cmd.AddCommand(mountCmd)` in init()
  </action>
  <verify>
1. `go build ./cmd/dittofsctl/...` succeeds without errors
2. `./dittofsctl share mount --help` shows usage with --protocol flag
3. `./dittofsctl share mount --protocol invalid /share /mnt` returns error with hint
  </verify>
  <done>
- mount.go exists with mountCmd exported
- NFS mount works on both macOS and Linux
- SMB mount works on both macOS and Linux
- Error messages include actionable hints
- share.go imports and registers mountCmd
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement unmount command</name>
  <files>
    cmd/dittofsctl/commands/share/unmount.go
    cmd/dittofsctl/commands/share/share.go
  </files>
  <action>
Create `cmd/dittofsctl/commands/share/unmount.go` implementing the unmount subcommand:

1. **Command structure:**
   - Use: `unmount [mountpoint]`
   - Args: ExactArgs(1) - mount point path
   - Optional flag: `--force, -f` to force unmount

2. **Mount point validation:**
   - Check mount point exists
   - Verify it's actually mounted (check if path is in mount output or use os.Stat for mount point characteristics)

3. **Unmount implementation (copy pattern from test/e2e/framework/mount.go):**
   - macOS normal: `diskutil unmount MOUNTPOINT`
   - macOS force: `diskutil unmount force MOUNTPOINT`
   - Linux normal: `umount MOUNTPOINT`
   - Linux force: `umount -f MOUNTPOINT`

4. **Error handling:**
   - "not mounted" -> "Hint: The path does not appear to be a mount point"
   - "busy" -> "Hint: Files may be in use. Close applications and try again, or use --force"
   - "permission denied" -> "Hint: Unmount may require sudo privileges"

5. **Success output:** `Unmounted /mnt/myshare`

6. **Update share.go:** Add `Cmd.AddCommand(unmountCmd)` in init()
  </action>
  <verify>
1. `go build ./cmd/dittofsctl/...` succeeds without errors
2. `./dittofsctl share unmount --help` shows usage with --force flag
3. `./dittofsctl share unmount /nonexistent` returns appropriate error
  </verify>
  <done>
- unmount.go exists with unmountCmd exported
- Unmount works on both macOS and Linux
- Force flag works correctly
- Error messages include actionable hints
- share.go imports and registers unmountCmd
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Build verification:
   ```bash
   go build ./cmd/dittofsctl/...
   ```

2. Help text verification:
   ```bash
   ./dittofsctl share --help  # Shows mount and unmount subcommands
   ./dittofsctl share mount --help  # Shows --protocol flag
   ./dittofsctl share unmount --help  # Shows --force flag
   ```

3. Error handling verification:
   ```bash
   ./dittofsctl share mount --protocol invalid /share /mnt  # Shows protocol hint
   ./dittofsctl share mount --protocol nfs /share /nonexistent  # Shows directory hint
   ```
</verification>

<success_criteria>
1. `dittofsctl share mount --protocol nfs /share /mnt` command exists and builds
2. `dittofsctl share mount --protocol smb /share /mnt` command exists and builds
3. `dittofsctl share unmount /mnt` command exists and builds
4. All commands have platform-specific implementations for macOS and Linux
5. Error messages include actionable hints
6. `go build ./cmd/dittofsctl/...` passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
