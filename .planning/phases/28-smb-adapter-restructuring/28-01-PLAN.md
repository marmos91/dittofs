---
phase: 28-smb-adapter-restructuring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/adapter/smb/adapter.go
  - pkg/adapter/smb/connection.go
  - pkg/adapter/smb/connection_test.go
  - pkg/adapter/smb/config.go
  - internal/adapter/smb/auth/ntlm.go
  - internal/adapter/smb/auth/ntlm_test.go
  - internal/adapter/smb/auth/spnego.go
  - internal/adapter/smb/auth/spnego_test.go
  - internal/adapter/smb/helpers.go
autonomous: true
requirements: [REF-04]

must_haves:
  truths:
    - "No files with smb_ prefix exist in pkg/adapter/smb/"
    - "SMBAdapter renamed to Adapter, SMBConnection to Connection, NewSMBConnection to NewConnection in pkg/adapter/smb/"
    - "internal/auth/ directory no longer exists; all auth code lives in internal/adapter/smb/auth/"
    - "utils.go renamed to helpers.go in internal/adapter/smb/"
    - "All existing tests pass with zero failures"
  artifacts:
    - path: "pkg/adapter/smb/adapter.go"
      provides: "Renamed Adapter struct (was SMBAdapter) in smb package"
    - path: "pkg/adapter/smb/connection.go"
      provides: "Renamed Connection struct (was SMBConnection)"
    - path: "pkg/adapter/smb/connection_test.go"
      provides: "Connection tests with updated type names"
    - path: "internal/adapter/smb/auth/ntlm.go"
      provides: "NTLM auth (moved from internal/auth/ntlm/)"
    - path: "internal/adapter/smb/auth/spnego.go"
      provides: "SPNEGO parsing (moved from internal/auth/spnego/)"
    - path: "internal/adapter/smb/helpers.go"
      provides: "Handler helpers (renamed from utils.go)"
  key_links:
    - from: "internal/adapter/smb/v2/handlers/session_setup.go"
      to: "internal/adapter/smb/auth/"
      via: "import path update from internal/auth/ntlm to internal/adapter/smb/auth"
      pattern: "internal/adapter/smb/auth"
    - from: "cmd/dfs/commands/start.go"
      to: "pkg/adapter/smb/"
      via: "smb.New() using renamed types"
      pattern: "smb\\.New"
---

<objective>
Rename SMB adapter files (drop smb_ prefix), rename structs (SMBAdapter->Adapter, SMBConnection->Connection), move internal/auth/ to internal/adapter/smb/auth/, and rename utils.go to helpers.go.

Purpose: Establish consistent naming conventions matching the NFS adapter pattern from Phase 27. Clear old directory structure before subsequent plans modify these files.
Output: Clean file names, struct names, and auth package location. All imports updated. All tests passing.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-smb-adapter-restructuring/28-RESEARCH.md

<interfaces>
<!-- Key types the executor needs to know about for renames -->

From pkg/adapter/smb/smb_adapter.go:
- type SMBAdapter struct { ... } -> rename to Adapter
- func New(config SMBConfig) *SMBAdapter -> rename to New(config Config) *Adapter
- type SMBConfig struct { ... } -> rename to Config
- type SMBTimeoutsConfig struct { ... } -> rename to TimeoutsConfig

From pkg/adapter/smb/smb_connection.go:
- type SMBConnection struct { ... } -> rename to Connection
- func NewSMBConnection(...) *SMBConnection -> rename to NewConnection(...) *Connection

From pkg/adapter/smb/config.go:
- References to SMBConfig, SMBTimeoutsConfig -> Config, TimeoutsConfig

From internal/adapter/smb/utils.go:
- Rename file to helpers.go (no content changes)

Auth packages to move:
- internal/auth/ntlm/ntlm.go (838 lines) -> internal/adapter/smb/auth/ntlm.go
- internal/auth/ntlm/ntlm_test.go (710 lines) -> internal/adapter/smb/auth/ntlm_test.go
- internal/auth/spnego/spnego.go (193 lines) -> internal/adapter/smb/auth/spnego.go
- internal/auth/spnego/spnego_test.go (347 lines) -> internal/adapter/smb/auth/spnego_test.go

Consumers of old types (from grep analysis in research):
- 13 files reference SMBAdapter/SMBConnection/SMBConfig
- 2 files import internal/auth/ntlm or internal/auth/spnego (session_setup.go, session_setup_test.go)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename pkg/adapter/smb/ files and structs</name>
  <files>
    pkg/adapter/smb/adapter.go
    pkg/adapter/smb/connection.go
    pkg/adapter/smb/connection_test.go
    pkg/adapter/smb/config.go
  </files>
  <action>
    1. Use `git mv` to rename files in pkg/adapter/smb/:
       - smb_adapter.go -> adapter.go
       - smb_connection.go -> connection.go
       - smb_connection_test.go -> connection_test.go

    2. In all Go files across the codebase, perform struct renames using sed:
       - SMBAdapter -> Adapter (but ONLY in contexts where it refers to the smb package type, i.e., `smb.SMBAdapter` -> `smb.Adapter` and within pkg/adapter/smb/ itself)
       - SMBConnection -> Connection (same scoping)
       - NewSMBConnection -> NewConnection
       - SMBConfig -> Config (within pkg/adapter/smb/ and its consumers)
       - SMBTimeoutsConfig -> TimeoutsConfig

    3. IMPORTANT: Config rename must be scoped carefully. The struct is `SMBConfig` in `pkg/adapter/smb/config.go`. Consumers reference it as `smb.SMBConfig{}` which becomes `smb.Config{}`. Internal references in the smb package are just `SMBConfig` -> `Config`.

    4. Verify with `go build ./...` immediately after renames.

    5. Run `go test ./pkg/adapter/smb/...` to verify connection tests pass.

    Note: Do NOT rename the package itself (it stays `package smb`). Only files and struct names.
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build ./... && go test ./pkg/adapter/smb/...</automated>
  </verify>
  <done>No smb_ prefix files exist in pkg/adapter/smb/. All struct references updated. Build and SMB tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Move auth packages and rename utils.go</name>
  <files>
    internal/adapter/smb/auth/ntlm.go
    internal/adapter/smb/auth/ntlm_test.go
    internal/adapter/smb/auth/spnego.go
    internal/adapter/smb/auth/spnego_test.go
    internal/adapter/smb/helpers.go
  </files>
  <action>
    1. Create the target directory: `mkdir -p internal/adapter/smb/auth/`

    2. Use `git mv` to move auth files (preserving history):
       - `git mv internal/auth/ntlm/ntlm.go internal/adapter/smb/auth/ntlm.go`
       - `git mv internal/auth/ntlm/ntlm_test.go internal/adapter/smb/auth/ntlm_test.go`
       - `git mv internal/auth/spnego/spnego.go internal/adapter/smb/auth/spnego.go`
       - `git mv internal/auth/spnego/spnego_test.go internal/adapter/smb/auth/spnego_test.go`

    3. Delete the now-empty `internal/auth/` directory tree (git rm empty dirs).

    4. Flatten package declarations: Both ntlm.go and spnego.go currently declare separate packages (`package ntlm`, `package spnego`). Change ALL four files to declare `package auth`. This is critical -- they are now in a single package.

    5. After flattening, resolve any naming conflicts between ntlm and spnego types. Based on research, the types don't conflict (ntlm has NTLMAuthenticator/NTLMChallenge, spnego has SPNEGOParser/Token).

    6. Update import paths in consumers:
       - `internal/adapter/smb/v2/handlers/session_setup.go`: change `internal/auth/ntlm` -> `internal/adapter/smb/auth`
       - `internal/adapter/smb/v2/handlers/session_setup_test.go`: change both `internal/auth/ntlm` and `internal/auth/spnego` -> `internal/adapter/smb/auth`
       - Update any other consumers found via grep for `"github.com/marmos91/dittofs/internal/auth/`

    7. After package flatten, callers that used `ntlm.NTLMAuthenticator` now use `auth.NTLMAuthenticator` (or just the type name if importing as `auth`). Update all call sites.

    8. Rename utils.go to helpers.go: `git mv internal/adapter/smb/utils.go internal/adapter/smb/helpers.go`

    9. Verify with `go build ./...` and `go test ./internal/adapter/smb/...`
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs && go build ./... && go test ./internal/adapter/smb/... && test ! -d internal/auth</automated>
  </verify>
  <done>Auth code lives in internal/adapter/smb/auth/ with flat package auth. Old internal/auth/ deleted. utils.go renamed to helpers.go. All tests pass.</done>
</task>

</tasks>

<verification>
1. `ls pkg/adapter/smb/` shows: adapter.go, config.go, connection.go, connection_test.go (NO smb_ prefix files)
2. `ls internal/adapter/smb/auth/` shows: ntlm.go, ntlm_test.go, spnego.go, spnego_test.go
3. `ls internal/auth/` returns error (directory deleted)
4. `ls internal/adapter/smb/helpers.go` exists (utils.go is gone)
5. `go build ./...` succeeds
6. `go test ./...` passes with zero failures
7. `go vet ./...` passes
</verification>

<success_criteria>
- All SMB adapter files follow consistent naming (no prefix, package provides context)
- Auth packages live under the adapter that owns them
- No stale directories remain
- Full test suite green
</success_criteria>

<output>
After completion, create `.planning/phases/28-smb-adapter-restructuring/28-01-SUMMARY.md`
</output>
