---
phase: 08-nfsv4-advanced-operations
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/protocol/nfs/v4/attrs/decode.go
  - internal/protocol/nfs/v4/attrs/decode_test.go
  - internal/protocol/nfs/v4/attrs/encode.go
  - internal/protocol/nfs/v4/handlers/setattr.go
  - internal/protocol/nfs/v4/handlers/setattr_test.go
  - internal/protocol/nfs/v4/handlers/handler.go
autonomous: true

must_haves:
  truths:
    - "SETATTR modifies file mode, owner, group, size, atime, and mtime"
    - "SETATTR returns attrsset bitmap listing which attributes were actually set"
    - "SETATTR returns NFS4ERR_ROFS on pseudo-fs handles"
    - "SETATTR accepts special stateids for size changes (Phase 9 tightens)"
    - "SETATTR supports both SET_TO_SERVER_TIME and SET_TO_CLIENT_TIME for timestamps"
    - "Owner strings in 'uid@domain' format are parsed to numeric UIDs"
    - "Mode validation rejects values > 07777"
    - "SUID/SGID bits are cleared on ownership change (via MetadataService)"
    - "Unsupported writable attributes return NFS4ERR_ATTRNOTSUPP"
  artifacts:
    - path: "internal/protocol/nfs/v4/attrs/decode.go"
      provides: "fattr4 decode infrastructure (DecodeFattr4ToSetAttrs, ParseOwnerString, ParseGroupString, WritableAttrs)"
      contains: "DecodeFattr4ToSetAttrs"
    - path: "internal/protocol/nfs/v4/attrs/decode_test.go"
      provides: "Tests for fattr4 decode functions"
      min_lines: 150
    - path: "internal/protocol/nfs/v4/handlers/setattr.go"
      provides: "SETATTR operation handler"
      contains: "handleSetAttr"
    - path: "internal/protocol/nfs/v4/handlers/setattr_test.go"
      provides: "Tests for SETATTR handler"
      min_lines: 200
  key_links:
    - from: "internal/protocol/nfs/v4/handlers/setattr.go"
      to: "internal/protocol/nfs/v4/attrs/decode.go"
      via: "attrs.DecodeFattr4ToSetAttrs"
      pattern: "DecodeFattr4ToSetAttrs"
    - from: "internal/protocol/nfs/v4/handlers/setattr.go"
      to: "pkg/metadata (MetadataService.SetFileAttributes)"
      via: "metaSvc.SetFileAttributes"
      pattern: "SetFileAttributes"
    - from: "internal/protocol/nfs/v4/handlers/handler.go"
      to: "internal/protocol/nfs/v4/handlers/setattr.go"
      via: "opDispatchTable[OP_SETATTR]"
      pattern: "OP_SETATTR.*handleSetAttr"
---

<objective>
Implement SETATTR handler and fattr4 decode infrastructure for decoding client-provided attribute values into metadata.SetAttrs.

Purpose: SETATTR is the most complex new operation in Phase 8, requiring new infrastructure to decode NFSv4 fattr4 attribute values (the reverse of the existing encode path). This enables clients to modify file attributes (mode, owner, size, timestamps) via the NFSv4 protocol.

Output: New fattr4 decode module (attrs/decode.go), owner/group string parser, SETATTR handler, and comprehensive tests for both the decode infrastructure and handler.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-nfsv4-advanced-operations/08-RESEARCH.md
@internal/protocol/nfs/v4/attrs/encode.go
@internal/protocol/nfs/v4/attrs/bitmap.go
@internal/protocol/nfs/v4/handlers/handler.go
@internal/protocol/nfs/v4/handlers/helpers.go
@internal/protocol/nfs/v4/handlers/realfs_test.go
@internal/protocol/nfs/v4/types/constants.go
@internal/protocol/nfs/v4/types/types.go
@internal/protocol/nfs/v4/types/errors.go
@pkg/metadata/service.go
@pkg/metadata/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: fattr4 decode infrastructure with owner string parsing</name>
  <files>
    internal/protocol/nfs/v4/attrs/decode.go
    internal/protocol/nfs/v4/attrs/decode_test.go
    internal/protocol/nfs/v4/attrs/encode.go
  </files>
  <action>
Add new constants to `encode.go` (or a new section at the bottom of the existing constants):
```go
FATTR4_TIME_ACCESS_SET = 48  // settime4 for setting atime
FATTR4_TIME_MODIFY_SET = 54  // settime4 for setting mtime
```
Also add time_how4 constants:
```go
SET_TO_SERVER_TIME4 = 0
SET_TO_CLIENT_TIME4 = 1
```

Create `decode.go` with the following functions:

**WritableAttrs() []uint32** - Returns bitmap of attributes valid for SETATTR:
- FATTR4_SIZE (bit 4)
- FATTR4_MODE (bit 33)
- FATTR4_OWNER (bit 36)
- FATTR4_OWNER_GROUP (bit 37)
- FATTR4_TIME_ACCESS_SET (bit 48)
- FATTR4_TIME_MODIFY_SET (bit 54)

**ParseOwnerString(owner string) (uint32, error)** - Parse NFSv4 "user@domain" to numeric UID:
- Try parsing as "N@domain" where N is numeric (e.g., "1000@localdomain" -> 1000)
- Try parsing as "N" (bare numeric, e.g., "0" -> 0)
- Handle well-known names: "root@localdomain" -> 0, "nobody@localdomain" -> 65534
- Return error wrapping fmt "invalid owner string: %s" for unrecognized names

**ParseGroupString(group string) (uint32, error)** - Same pattern as ParseOwnerString:
- "N@domain" -> N
- "N" -> N
- "root@localdomain" -> 0, "nogroup@localdomain" -> 65534, "nobody@localdomain" -> 65534
- Return error for unrecognized

**DecodeFattr4ToSetAttrs(reader io.Reader) (*metadata.SetAttrs, []uint32, error)** - Decode fattr4 to SetAttrs:
1. Decode bitmap4 via `DecodeBitmap4(reader)`
2. Read attr_vals as opaque data (XDR opaque: uint32 length + bytes)
3. Create a bytes.Reader for the attr_vals
4. Iterate through bits in bitmap in ascending bit-number order
5. For each set bit, decode the appropriate type:
   - FATTR4_SIZE (bit 4): read uint64 -> SetAttrs.Size (as *uint64)
   - FATTR4_MODE (bit 33): read uint32 -> validate <= 07777 -> SetAttrs.Mode (as *uint32)
   - FATTR4_OWNER (bit 36): read XDR string -> ParseOwnerString -> SetAttrs.UID (as *uint32)
   - FATTR4_OWNER_GROUP (bit 37): read XDR string -> ParseGroupString -> SetAttrs.GID (as *uint32)
   - FATTR4_TIME_ACCESS_SET (bit 48): read time_how4 (uint32). If SET_TO_SERVER_TIME4 -> SetAttrs.AtimeNow=true. If SET_TO_CLIENT_TIME4 -> read nfstime4 (int64 seconds + uint32 nseconds) -> SetAttrs.Atime as *time.Time
   - FATTR4_TIME_MODIFY_SET (bit 54): same pattern -> SetAttrs.Mtime / SetAttrs.MtimeNow
   - Any other bit in the writable range: return NFS4ERR_ATTRNOTSUPP error
   - Any bit NOT in WritableAttrs: return error indicating unsupported attribute
6. Return the populated SetAttrs and the bitmap of requested attributes (for attrsset response)

Create `decode_test.go` with tests:
- TestParseOwnerString: numeric@domain, bare numeric, root@localdomain, nobody, invalid
- TestParseGroupString: same patterns
- TestDecodeFattr4ToSetAttrs_Mode: encode mode=0755 in fattr4 format, decode, verify SetAttrs.Mode
- TestDecodeFattr4ToSetAttrs_Size: encode size, verify SetAttrs.Size
- TestDecodeFattr4ToSetAttrs_Owner: encode owner string, verify UID
- TestDecodeFattr4ToSetAttrs_ServerTime: encode SET_TO_SERVER_TIME4, verify AtimeNow/MtimeNow
- TestDecodeFattr4ToSetAttrs_ClientTime: encode SET_TO_CLIENT_TIME4 with nfstime4, verify Atime/Mtime
- TestDecodeFattr4ToSetAttrs_MultipleAttrs: set mode + owner + mtime in single fattr4
- TestDecodeFattr4ToSetAttrs_UnsupportedAttr: bit for read-only attr set -> error
- TestDecodeFattr4ToSetAttrs_InvalidMode: mode > 07777 -> error

Helper approach for tests: manually build the XDR bytes (bitmap + opaque with encoded values) and pass as io.Reader.
  </action>
  <verify>
Run `go test -race -v ./internal/protocol/nfs/v4/attrs/ -run "TestParse|TestDecode"` -- all tests pass.
Run `go vet ./internal/protocol/nfs/v4/attrs/` -- no issues.
  </verify>
  <done>
fattr4 decode infrastructure supports all six writable attributes. Owner/group string parsing handles numeric@domain, bare numeric, and well-known names. Unsupported attributes correctly rejected. All decode tests pass with -race.
  </done>
</task>

<task type="auto">
  <name>Task 2: SETATTR handler with stateid, dispatch registration, and tests</name>
  <files>
    internal/protocol/nfs/v4/handlers/setattr.go
    internal/protocol/nfs/v4/handlers/setattr_test.go
    internal/protocol/nfs/v4/handlers/handler.go
  </files>
  <action>
Create `setattr.go` implementing `handleSetAttr`:
1. Require CurrentFH via `types.RequireCurrentFH(ctx)`
2. Check pseudo-fs: `pseudofs.IsPseudoFSHandle(ctx.CurrentFH)` -> NFS4ERR_ROFS
3. Read stateid4 from reader via `types.DecodeStateid4(reader)` (16 bytes: seqid uint32 + other[12]). Accept any special stateid for now (Phase 9 validates). Log stateid at DEBUG level.
4. Decode fattr4 via `attrs.DecodeFattr4ToSetAttrs(reader)`. On error (including NFS4ERR_ATTRNOTSUPP), return appropriate error status.
5. Build auth context via `buildV4AuthContext(ctx, ctx.CurrentFH)`
6. Get MetadataService via `getMetadataServiceForCtx`
7. Call `metaSvc.SetFileAttributes(authCtx, metadata.FileHandle(ctx.CurrentFH), setAttrs)` where setAttrs is the decoded *metadata.SetAttrs
8. Map errors via `types.MapMetadataErrorToNFS4(err)`. On error, return status with empty attrsset bitmap.
9. On success, encode response: status (NFS4_OK) + attrsset bitmap (the same bitmap from the decode, indicating all requested attrs were set -- all-or-nothing semantics)
10. Encode the attrsset bitmap using `attrs.EncodeBitmap4()` (use the bitmap returned from DecodeFattr4ToSetAttrs)

Register in `handler.go`:
```go
h.opDispatchTable[types.OP_SETATTR] = h.handleSetAttr
```
Add under a comment "// Attribute operations".

Create `setattr_test.go` with tests using `newRealFSTestFixture`:
- TestHandleSetAttr_Mode: set mode to 0644 on a file, verify GETATTR returns new mode
- TestHandleSetAttr_Size: truncate file to 0 via SETATTR, verify size changed
- TestHandleSetAttr_Owner: set owner by "1000@localdomain", verify UID
- TestHandleSetAttr_Group: set group by "1000@localdomain", verify GID
- TestHandleSetAttr_TimeServerTime: set atime/mtime to server time (SET_TO_SERVER_TIME4)
- TestHandleSetAttr_TimeClientTime: set mtime to specific client time
- TestHandleSetAttr_MultipleAttrs: set mode + owner together, verify both changed
- TestHandleSetAttr_NoCurrentFH: -> NFS4ERR_NOFILEHANDLE
- TestHandleSetAttr_PseudoFS: -> NFS4ERR_ROFS
- TestHandleSetAttr_UnsupportedAttr: request unsupported attribute -> NFS4ERR_ATTRNOTSUPP
- TestHandleSetAttr_InvalidMode: mode > 07777 -> error (NFS4ERR_INVAL)
- TestHandleSetAttr_BadOwner: unparseable owner string -> NFS4ERR_BADOWNER
- TestHandleSetAttr_AttrssetBitmap: verify response attrsset bitmap matches requested attrs on success, and is empty on failure

Tests build SETATTR args by manually encoding: stateid4 (16 zero bytes for special stateid) + fattr4 (bitmap + opaque attr values). Use `attrs.EncodeBitmap4()` and XDR encoding helpers to build the request bytes.
  </action>
  <verify>
Run `go test -race -v ./internal/protocol/nfs/v4/handlers/ -run "TestHandleSetAttr"` -- all tests pass.
Run `go test -race ./internal/protocol/nfs/v4/handlers/` -- all existing tests still pass.
Run `go vet ./internal/protocol/nfs/v4/...` -- no issues.
  </verify>
  <done>
SETATTR handler decodes stateid + fattr4, applies attributes via MetadataService.SetFileAttributes, returns attrsset bitmap. Supports mode, owner, group, size, atime, mtime with server/client time. All-or-nothing semantics. Registered in dispatch table. 13+ tests pass with -race.
  </done>
</task>

</tasks>

<verification>
1. `go test -race -v ./internal/protocol/nfs/v4/attrs/` -- all decode tests pass
2. `go test -race -v ./internal/protocol/nfs/v4/handlers/ -run "TestHandleSetAttr"` -- all handler tests pass
3. `go test -race ./internal/protocol/nfs/v4/handlers/` -- full handler suite passes (no regressions)
4. `go vet ./internal/protocol/nfs/v4/...` -- clean
5. Verify SETATTR registered in handler.go dispatch table
</verification>

<success_criteria>
- DecodeFattr4ToSetAttrs correctly decodes all 6 writable attributes from XDR fattr4 format
- Owner/group string parser handles numeric@domain, bare numeric, and well-known names
- SETATTR handler wires decode -> MetadataService.SetFileAttributes -> attrsset response
- Stateid consumed from args (accepted without validation per Phase 7 pattern)
- Unsupported attributes return NFS4ERR_ATTRNOTSUPP
- 20+ tests across decode infrastructure and handler, all passing with -race
</success_criteria>

<output>
After completion, create `.planning/phases/08-nfsv4-advanced-operations/08-02-SUMMARY.md`
</output>
