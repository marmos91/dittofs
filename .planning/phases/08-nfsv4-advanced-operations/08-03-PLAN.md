---
phase: 08-nfsv4-advanced-operations
plan: 03
type: execute
wave: 2
depends_on: ["08-02"]
files_modified:
  - internal/protocol/nfs/v4/handlers/verify.go
  - internal/protocol/nfs/v4/handlers/nverify.go
  - internal/protocol/nfs/v4/handlers/secinfo.go
  - internal/protocol/nfs/v4/handlers/stubs.go
  - internal/protocol/nfs/v4/handlers/verify_test.go
  - internal/protocol/nfs/v4/handlers/stubs_test.go
  - internal/protocol/nfs/v4/handlers/handler.go
autonomous: true

must_haves:
  truths:
    - "VERIFY returns NFS4_OK when server attributes match client-provided fattr4"
    - "VERIFY returns NFS4ERR_NOT_SAME when attributes do not match"
    - "NVERIFY returns NFS4_OK when attributes do NOT match"
    - "NVERIFY returns NFS4ERR_SAME when attributes match"
    - "VERIFY/NVERIFY work on pseudo-fs and real-fs handles"
    - "SECINFO returns both AUTH_SYS and AUTH_NONE flavors"
    - "SECINFO clears CurrentFH after execution (per RFC 7530)"
    - "OPENATTR returns NFS4ERR_NOTSUPP"
    - "OPEN_DOWNGRADE returns NFS4ERR_NOTSUPP"
    - "RELEASE_LOCKOWNER returns NFS4_OK (no-op success)"
  artifacts:
    - path: "internal/protocol/nfs/v4/handlers/verify.go"
      provides: "VERIFY operation handler with byte-exact XDR comparison"
      contains: "handleVerify"
    - path: "internal/protocol/nfs/v4/handlers/nverify.go"
      provides: "NVERIFY operation handler"
      contains: "handleNVerify"
    - path: "internal/protocol/nfs/v4/handlers/stubs.go"
      provides: "OPENATTR, OPEN_DOWNGRADE, RELEASE_LOCKOWNER stub handlers"
      contains: "handleOpenAttr"
    - path: "internal/protocol/nfs/v4/handlers/verify_test.go"
      provides: "Tests for VERIFY and NVERIFY operations"
      min_lines: 150
    - path: "internal/protocol/nfs/v4/handlers/stubs_test.go"
      provides: "Tests for stub operations"
      min_lines: 50
  key_links:
    - from: "internal/protocol/nfs/v4/handlers/verify.go"
      to: "internal/protocol/nfs/v4/attrs/encode.go"
      via: "attrs.EncodeRealFileAttrs for server-side attribute encoding"
      pattern: "EncodeRealFileAttrs"
    - from: "internal/protocol/nfs/v4/handlers/handler.go"
      to: "internal/protocol/nfs/v4/handlers/verify.go"
      via: "opDispatchTable[OP_VERIFY]"
      pattern: "OP_VERIFY.*handleVerify"
---

<objective>
Implement VERIFY/NVERIFY conditional operations using byte-exact XDR comparison, upgrade SECINFO to return both AUTH_SYS and AUTH_NONE, and add stub handlers for OPENATTR, OPEN_DOWNGRADE, and RELEASE_LOCKOWNER.

Purpose: VERIFY/NVERIFY enable conditional compound sequences (e.g., VERIFY+SETATTR as a guard pattern). SECINFO upgrade provides correct security information to clients. Stubs prevent NFS4ERR_NOTSUPP for operations clients may probe.

Output: Four new handler files, upgraded secinfo.go, dispatch table registration, and tests covering comparison logic, conditional failures, and stub behavior.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-nfsv4-advanced-operations/08-RESEARCH.md
@.planning/phases/08-nfsv4-advanced-operations/08-02-SUMMARY.md
@internal/protocol/nfs/v4/attrs/encode.go
@internal/protocol/nfs/v4/attrs/bitmap.go
@internal/protocol/nfs/v4/handlers/handler.go
@internal/protocol/nfs/v4/handlers/helpers.go
@internal/protocol/nfs/v4/handlers/realfs_test.go
@internal/protocol/nfs/v4/handlers/secinfo.go
@internal/protocol/nfs/v4/handlers/getattr.go
@internal/protocol/nfs/v4/types/constants.go
@internal/protocol/nfs/v4/pseudofs/pseudofs.go
@pkg/metadata/service.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: VERIFY/NVERIFY handlers with byte-exact XDR comparison</name>
  <files>
    internal/protocol/nfs/v4/handlers/verify.go
    internal/protocol/nfs/v4/handlers/nverify.go
    internal/protocol/nfs/v4/handlers/verify_test.go
    internal/protocol/nfs/v4/handlers/handler.go
  </files>
  <action>
Create a shared internal helper function `verifyAttributes` in `verify.go` (unexported) that both VERIFY and NVERIFY call:

**verifyAttributes(h *Handler, ctx *CompoundContext, reader io.Reader) (match bool, status uint32)**:
1. Require CurrentFH -> NFS4ERR_NOFILEHANDLE
2. Decode client-provided fattr4: bitmap4 via `attrs.DecodeBitmap4(reader)` + opaque attr_vals (uint32 length + bytes) via XDR opaque decode
3. Determine if CurrentFH is pseudo-fs or real-fs:
   - **Pseudo-fs**: Get the pseudo-fs node via `h.PseudoFS.GetNodeByHandle(ctx.CurrentFH)`. If not found -> NFS4ERR_STALE. Encode server attrs using `attrs.EncodePseudoFSAttrs()` with the client's bitmap (intersected with supported attrs). Extract the opaque data portion from the encoded result.
   - **Real-fs**: Build auth context, get MetadataService, call `metaSvc.GetFile(authCtx, fileHandle)`. If not found -> NFS4ERR_STALE. Encode server attrs using `attrs.EncodeRealFileAttrs()` with the client's bitmap (intersected with supported). Extract opaque data.
4. Compare client opaque data vs server opaque data using `bytes.Equal()`
5. Return match=true/false and status=NFS4_OK (no error in comparison itself)

**Note on extracting opaque data from encode**: The encode functions (`EncodeRealFileAttrs`, `EncodePseudoFSAttrs`) write bitmap + opaque to a buffer. For comparison, we need ONLY the opaque portion. Strategy: call the encode function with the client's bitmap (to encode only the requested attributes), then skip the bitmap in the output to get to the opaque data. Alternatively, add a helper that encodes only the attr_vals without the bitmap wrapper. Choose the simplest approach that works.

Create `verify.go` with `handleVerify`:
- Call `verifyAttributes(h, ctx, reader)`
- If status != NFS4_OK, return error
- If match == true: return NFS4_OK
- If match == false: return NFS4ERR_NOT_SAME
- Response is status-only (no additional data)

Create `nverify.go` with `handleNVerify`:
- Call `verifyAttributes(h, ctx, reader)`
- If status != NFS4_OK, return error
- If match == false: return NFS4_OK (attributes are different, which is what NVERIFY wants)
- If match == true: return NFS4ERR_SAME
- Response is status-only

Register in `handler.go`:
```go
h.opDispatchTable[types.OP_VERIFY] = h.handleVerify
h.opDispatchTable[types.OP_NVERIFY] = h.handleNVerify
```
Add under a comment "// Conditional verification".

Create `verify_test.go` with tests:
- TestHandleVerify_Match: get file attrs via GETATTR, use same values in VERIFY -> NFS4_OK
- TestHandleVerify_Mismatch: provide wrong size in VERIFY -> NFS4ERR_NOT_SAME
- TestHandleVerify_NoCurrentFH: -> NFS4ERR_NOFILEHANDLE
- TestHandleVerify_StaleHandle: invalid handle -> NFS4ERR_STALE
- TestHandleVerify_PseudoFS: verify on pseudo-fs node works (NFS4_OK when matching)
- TestHandleNVerify_Match: attrs match -> NFS4ERR_SAME
- TestHandleNVerify_Mismatch: attrs differ -> NFS4_OK
- TestHandleNVerify_NoCurrentFH: -> NFS4ERR_NOFILEHANDLE
- TestVerifyNVerify_CompoundSequence: VERIFY+SETATTR pattern in compound -- VERIFY matches -> SETATTR executes; VERIFY fails -> SETATTR skipped

Test approach for encoding client fattr4: Use `attrs.EncodeBitmap4()` to write the bitmap, then manually encode the attribute values in the same format the server uses. For "match" tests, first call `EncodeRealFileAttrs()` (or read the file and encode) to get the expected bytes, then use those as client data.
  </action>
  <verify>
Run `go test -race -v ./internal/protocol/nfs/v4/handlers/ -run "TestHandleVerify|TestHandleNVerify|TestVerifyNVerify"` -- all tests pass.
Run `go vet ./internal/protocol/nfs/v4/handlers/` -- no issues.
  </verify>
  <done>
VERIFY returns NFS4_OK on match and NFS4ERR_NOT_SAME on mismatch. NVERIFY returns NFS4_OK on mismatch and NFS4ERR_SAME on match. Both support pseudo-fs and real-fs handles. Byte-exact XDR comparison used. 9+ tests pass with -race.
  </done>
</task>

<task type="auto">
  <name>Task 2: SECINFO upgrade, stub handlers, dispatch registration, and tests</name>
  <files>
    internal/protocol/nfs/v4/handlers/secinfo.go
    internal/protocol/nfs/v4/handlers/stubs.go
    internal/protocol/nfs/v4/handlers/stubs_test.go
    internal/protocol/nfs/v4/handlers/handler.go
  </files>
  <action>
Upgrade `secinfo.go`:
- Keep existing structure but return TWO security flavors instead of one
- Change array length from 1 to 2
- First entry: AUTH_SYS (flavor 1) -- strongest first per context decision
- Second entry: AUTH_NONE (flavor 0)
- Update the log message from "SECINFO stub" to "SECINFO"
- Keep the CurrentFH clearing behavior (per RFC 7530)
- Keep the name reading and validation
- If CurrentFH is a real-fs handle, optionally validate the component name exists via MetadataService.Lookup. On NFS4ERR_NOENT, still return flavors (SECINFO is about security, not file existence). For now, just return flavors regardless -- full name validation is optional per RFC.
- If CurrentFH is pseudo-fs, return the same flavors (pseudo-fs is public)

Create `stubs.go` with three handlers:

**handleOpenAttr** (OP_OPENATTR = 19):
- Read the `createdir` bool (uint32) from args to avoid XDR desync
- Return NFS4ERR_NOTSUPP
- Log at DEBUG: "OPENATTR not supported (named attributes deferred)"

**handleOpenDowngrade** (OP_OPEN_DOWNGRADE = 21):
- Consume args to avoid XDR desync: stateid4 (4+12=16 bytes via DecodeStateid4) + seqid (uint32) + share_access (uint32) + share_deny (uint32)
- Return NFS4ERR_NOTSUPP
- Log at DEBUG: "OPEN_DOWNGRADE not supported (state management deferred)"

**handleReleaseLockOwner** (OP_RELEASE_LOCKOWNER = 39):
- Consume args: lock_owner4 = clientid (uint64) + owner (XDR opaque: uint32 length + bytes)
- Return NFS4_OK (no-op success per context decision -- prevents NOTSUPP errors from clients)
- Log at DEBUG: "RELEASE_LOCKOWNER no-op (lock state management deferred)"

Register all in `handler.go`:
```go
// Stub operations (deferred to later phases)
h.opDispatchTable[types.OP_OPENATTR] = h.handleOpenAttr
h.opDispatchTable[types.OP_OPEN_DOWNGRADE] = h.handleOpenDowngrade
h.opDispatchTable[types.OP_RELEASE_LOCKOWNER] = h.handleReleaseLockOwner
```

Create `stubs_test.go`:
- TestHandleOpenAttr_NotSupp: send createdir=false, verify NFS4ERR_NOTSUPP
- TestHandleOpenDowngrade_NotSupp: send valid args, verify NFS4ERR_NOTSUPP
- TestHandleReleaseLockOwner_Success: send lock_owner4, verify NFS4_OK
- TestHandleSecInfo_TwoFlavors: verify SECINFO returns 2 entries (AUTH_SYS, AUTH_NONE)
- TestHandleSecInfo_ClearsFH: verify CurrentFH is nil after SECINFO
  </action>
  <verify>
Run `go test -race -v ./internal/protocol/nfs/v4/handlers/ -run "TestHandleOpenAttr|TestHandleOpenDowngrade|TestHandleReleaseLockOwner|TestHandleSecInfo"` -- all tests pass.
Run `go test -race ./internal/protocol/nfs/v4/handlers/` -- full suite passes (no regressions).
Run `go vet ./internal/protocol/nfs/v4/...` -- clean.
  </verify>
  <done>
SECINFO returns AUTH_SYS + AUTH_NONE. OPENATTR returns NFS4ERR_NOTSUPP. OPEN_DOWNGRADE returns NFS4ERR_NOTSUPP. RELEASE_LOCKOWNER returns NFS4_OK (no-op). All registered in dispatch table. All args consumed to prevent XDR desync. 5+ tests pass with -race.
  </done>
</task>

</tasks>

<verification>
1. `go test -race -v ./internal/protocol/nfs/v4/handlers/ -run "TestHandleVerify|TestHandleNVerify|TestVerifyNVerify"` -- VERIFY/NVERIFY tests pass
2. `go test -race -v ./internal/protocol/nfs/v4/handlers/ -run "TestHandleOpenAttr|TestHandleOpenDowngrade|TestHandleReleaseLockOwner|TestHandleSecInfo"` -- stub and SECINFO tests pass
3. `go test -race ./internal/protocol/nfs/v4/handlers/` -- full handler suite passes
4. `go vet ./internal/protocol/nfs/v4/...` -- clean
5. Verify all 5 new ops registered in handler.go dispatch table (VERIFY, NVERIFY, OPENATTR, OPEN_DOWNGRADE, RELEASE_LOCKOWNER)
</verification>

<success_criteria>
- VERIFY/NVERIFY use byte-exact XDR comparison against server-encoded attributes
- Both work on pseudo-fs and real-fs handles
- SECINFO upgraded from 1 flavor (AUTH_SYS) to 2 flavors (AUTH_SYS + AUTH_NONE)
- All three stub handlers correctly consume args to prevent XDR stream desync
- RELEASE_LOCKOWNER returns NFS4_OK (not NOTSUPP) per context decision
- 14+ tests across verification, SECINFO, and stubs, all passing with -race
</success_criteria>

<output>
After completion, create `.planning/phases/08-nfsv4-advanced-operations/08-03-SUMMARY.md`
</output>
