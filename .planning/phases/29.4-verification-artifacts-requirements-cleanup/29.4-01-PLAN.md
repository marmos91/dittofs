---
phase: 29.4-verification-artifacts-requirements-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/28-smb-adapter-restructuring/28-VERIFICATION.md
  - .planning/phases/29-core-layer-decomposition/29-VERIFICATION.md
  - .planning/REQUIREMENTS.md
autonomous: true
requirements:
  - REF-04
  - REF-05
  - REF-06
  - traceability

must_haves:
  truths:
    - "Phase 28 has a VERIFICATION.md with per-requirement evidence for all 11 REF-04 sub-requirements"
    - "Phase 29 has a VERIFICATION.md with per-requirement evidence for all 8 REF-05 and 9 REF-06 sub-requirements"
    - "REQUIREMENTS.md traceability table shows Complete (without 'pending formal verification') for REF-04, REF-05, REF-06"
    - "All evidence in VERIFICATION.md files is confirmed against current codebase (file existence, type/interface grep)"
  artifacts:
    - path: ".planning/phases/28-smb-adapter-restructuring/28-VERIFICATION.md"
      provides: "Formal verification for Phase 28 REF-04 (SMB Adapter Restructuring)"
      contains: "REF-04.11"
    - path: ".planning/phases/29-core-layer-decomposition/29-VERIFICATION.md"
      provides: "Formal verification for Phase 29 REF-05 + REF-06"
      contains: "REF-06.9"
    - path: ".planning/REQUIREMENTS.md"
      provides: "Updated traceability table with completion status"
      contains: "Complete (11/11)"
  key_links:
    - from: ".planning/phases/28-smb-adapter-restructuring/28-VERIFICATION.md"
      to: ".planning/REQUIREMENTS.md"
      via: "REF-04 sub-requirement IDs match between verification and requirements"
      pattern: "REF-04\\."
    - from: ".planning/phases/29-core-layer-decomposition/29-VERIFICATION.md"
      to: ".planning/REQUIREMENTS.md"
      via: "REF-05 and REF-06 sub-requirement IDs match between verification and requirements"
      pattern: "REF-0[56]\\."
---

<objective>
Create formal verification artifacts for Phases 28 and 29 and update REQUIREMENTS.md traceability to close audit gaps from the v3.5 milestone audit.

Purpose: Phases 28 (SMB Adapter Restructuring) and 29 (Core Layer Decomposition) are functionally complete with all SUMMARY files claiming completion, but lack formal VERIFICATION.md files. The REQUIREMENTS.md traceability table still says "pending formal verification in 29.4" for REF-04, REF-05, REF-06. This plan closes those gaps.

Output: Two VERIFICATION.md files (one in phase 28 directory, one in phase 29 directory) and an updated REQUIREMENTS.md.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/29.4-verification-artifacts-requirements-cleanup/29.4-RESEARCH.md

# Format reference (established VERIFICATION.md pattern)
@.planning/phases/26-generic-lock-interface-protocol-leak-purge/26-VERIFICATION.md

# Evidence sources for Phase 28
@.planning/phases/28-smb-adapter-restructuring/28-01-SUMMARY.md
@.planning/phases/28-smb-adapter-restructuring/28-02-SUMMARY.md
@.planning/phases/28-smb-adapter-restructuring/28-03-SUMMARY.md
@.planning/phases/28-smb-adapter-restructuring/28-04-SUMMARY.md
@.planning/phases/28-smb-adapter-restructuring/28-05-SUMMARY.md

# Evidence sources for Phase 29
@.planning/phases/29-core-layer-decomposition/29-01-SUMMARY.md
@.planning/phases/29-core-layer-decomposition/29-02-SUMMARY.md
@.planning/phases/29-core-layer-decomposition/29-03-SUMMARY.md
@.planning/phases/29-core-layer-decomposition/29-04-SUMMARY.md
@.planning/phases/29-core-layer-decomposition/29-05-SUMMARY.md
@.planning/phases/29-core-layer-decomposition/29-06-SUMMARY.md
@.planning/phases/29-core-layer-decomposition/29-07-SUMMARY.md

<interfaces>
<!-- No code interfaces needed. This plan creates documentation only. -->
<!-- The executor needs: -->
<!-- 1. The VERIFICATION.md format from Phase 26 (referenced above) -->
<!-- 2. The sub-requirement to SUMMARY mapping from 29.4-RESEARCH.md -->
<!-- 3. grep/glob access to verify file existence and type/interface presence -->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Phase 28 VERIFICATION.md for REF-04</name>
  <files>.planning/phases/28-smb-adapter-restructuring/28-VERIFICATION.md</files>
  <action>
Create `.planning/phases/28-smb-adapter-restructuring/28-VERIFICATION.md` following the exact format established in Phase 26's verification file (`26-VERIFICATION.md`).

**YAML frontmatter:**
- phase: 28-smb-adapter-restructuring
- verified: current ISO timestamp
- status: passed
- score: 11/11 must-haves verified
- requirements_completed: REF-04 (all 11 sub-requirements)

**Observable Truths (11 items from ROADMAP.md Phase 28 success criteria):**
For each truth, verify against the CURRENT codebase using grep/glob:
1. `internal/auth/` (ntlm+spnego) moved to `internal/adapter/smb/auth/` -- verify `internal/adapter/smb/auth/` exists and `internal/auth/` does not
2. `pkg/adapter/smb/` files renamed (no smb_ prefix) -- `ls pkg/adapter/smb/*.go` should show adapter.go, connection.go, config.go
3. BaseAdapter extracted to `pkg/adapter/base.go` -- grep for `type BaseAdapter struct` in base.go
4. NetBIOS framing in `internal/adapter/smb/framing.go` -- verify file exists with ReadRequest, WriteNetBIOSFrame
5. Signing verification in internal/adapter/smb/ -- grep for `NewSessionSigningVerifier` in framing.go (per 28-03 decision)
6. Dispatch + response in `internal/adapter/smb/dispatch.go` + `response.go` -- verify both exist (deviation documented: split for separation of concerns)
7. Compound handling in `internal/adapter/smb/compound.go` -- verify ProcessCompoundRequest exists
8. Authenticator interface defined -- grep for `type Authenticator interface` in `pkg/adapter/auth.go`
9. Shared handler helpers in `internal/adapter/smb/helpers.go` -- verify file exists
10. `pkg/adapter/smb/connection.go` reduced to thin loop -- verify file is < 300 lines
11. Handler documentation added -- spot-check 2-3 handler files for MS-SMB2 spec references in Godoc

**Required Artifacts table:** List key files from each 28-0X-SUMMARY with their verification status.

**Key Link Verification table:** At minimum:
- BaseAdapter in base.go -> embedded by NFS adapter.go and SMB adapter.go
- Authenticator in pkg/adapter/auth.go -> implemented by internal/adapter/smb/auth/ and internal/adapter/nfs/auth/
- framing.go -> used by connection.go serve loop
- dispatch.go -> called by connection.go for command routing

**Requirements Coverage table:** All 11 REF-04 sub-requirements (REF-04.1 through REF-04.11) with source plan, description, status, and evidence.

**Verification Summary:** Overall PASSED status with build/test confirmation.

Run `go build ./...` and `go test ./pkg/adapter/...` to confirm build and tests pass. Include results in summary.

**Key deviations to note (from RESEARCH.md):**
- REF-04.5: Signing verification landed in framing.go (not separate signing.go) -- mark as SATISFIED with deviation note
- REF-04.6: Dispatch split into dispatch.go + response.go -- mark as SATISFIED with deviation note
  </action>
  <verify>
    <automated>grep -c "REF-04" .planning/phases/28-smb-adapter-restructuring/28-VERIFICATION.md | test $(cat) -ge 11 && grep -q "PASSED" .planning/phases/28-smb-adapter-restructuring/28-VERIFICATION.md && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>28-VERIFICATION.md exists in phase 28 directory with YAML frontmatter, all 11 REF-04 sub-requirements covered in Requirements Coverage table, Observable Truths verified against codebase with specific file paths and line numbers, PASSED status in summary</done>
</task>

<task type="auto">
  <name>Task 2: Create Phase 29 VERIFICATION.md for REF-05 and REF-06</name>
  <files>.planning/phases/29-core-layer-decomposition/29-VERIFICATION.md</files>
  <action>
Create `.planning/phases/29-core-layer-decomposition/29-VERIFICATION.md` following the exact format established in Phase 26's verification file.

**YAML frontmatter:**
- phase: 29-core-layer-decomposition
- verified: current ISO timestamp
- status: passed
- score: 10/10 must-haves verified (from ROADMAP.md Phase 29 success criteria)
- requirements_completed: REF-05 (8 sub-requirements), REF-06 (9 sub-requirements)

**Observable Truths (10 items from ROADMAP.md Phase 29 success criteria):**
For each truth, verify against the CURRENT codebase using grep/glob:
1. ControlPlane Store interface decomposed into sub-interfaces -- grep `interface.go` for UserStore, GroupStore, ShareStore, etc.
2. API handlers accept narrowest interface -- spot-check 2-3 handler files (e.g., groups.go, users.go) for specific sub-interface parameters
3. Runtime split: sub-services extracted -- verify directories exist under `pkg/controlplane/runtime/` (adapters/, stores/, shares/, mounts/, lifecycle/, identity/)
4. TransferManager renamed to Offloader -- verify `pkg/payload/offloader/` exists and no TransferManager type references remain
5. Offloader split into upload.go, download.go, dedup.go -- verify files exist with ~expected line counts
6. Structured PayloadError type -- grep for `type PayloadError struct` in `pkg/payload/errors.go`
7. Generic GORM helpers -- grep for `getByField` in `pkg/controlplane/store/helpers.go`
8. API error mapping centralized -- grep for `MapStoreError` in `internal/controlplane/api/handlers/helpers.go`
9. `pkg/metadata/file.go` split -- verify file_create.go, file_modify.go, file_remove.go, file_helpers.go, file_types.go exist in `pkg/metadata/`
10. `pkg/metadata/authentication.go` split -- verify auth_identity.go, auth_permissions.go exist in `pkg/metadata/`

**Required Artifacts table:** Key files from each 29-0X-SUMMARY:
- `pkg/controlplane/store/interface.go` (12 sub-interfaces)
- `pkg/controlplane/store/helpers.go` (generic GORM helpers)
- `pkg/payload/offloader/offloader.go`, `upload.go`, `download.go`, `dedup.go`, `queue.go`, `entry.go`, `types.go`, `wal_replay.go`
- `pkg/payload/errors.go` (PayloadError)
- `pkg/payload/io/reader.go`, `writer.go` (extracted I/O)
- `pkg/payload/gc/` (extracted GC)
- `pkg/metadata/file_create.go`, `file_modify.go`, `file_remove.go`, `file_helpers.go`, `file_types.go`
- `pkg/metadata/auth_identity.go`, `auth_permissions.go`
- `pkg/metadata/storetest/` (conformance test suite)
- `pkg/controlplane/runtime/adapters/`, `stores/`, `shares/`, `mounts/`, `lifecycle/`, `identity/`
- `pkg/adapter/errors.go` (ProtocolError)
- `pkg/apiclient/helpers.go` (generic API client helpers)
- `internal/controlplane/api/handlers/helpers.go` (MapStoreError, HandleStoreError)
- `pkg/auth/` (centralized auth abstractions)

**Key Link Verification table:** At minimum:
- Store sub-interfaces in interface.go -> implemented by gorm.go (GORMStore)
- API handlers -> accept narrow sub-interfaces (e.g., users.go accepts UserStore)
- Runtime composition -> sub-services in adapters/, stores/, shares/, mounts/, lifecycle/, identity/
- PayloadError in errors.go -> used by service.go, io/reader.go, io/writer.go
- MapStoreError in handlers/helpers.go -> used by handler files (e.g., groups.go)
- Offloader -> uses io/ sub-package for cache I/O

**Requirements Coverage table:** All 17 sub-requirements:
- REF-05.1 through REF-05.8 (8 items from Core Object Decomposition)
- REF-06.1 through REF-06.9 (9 items from Code Quality Improvements)
Each with source plan, description, status (SATISFIED), and specific evidence.

Use the mapping table from 29.4-RESEARCH.md to ensure completeness.

**Key notes from RESEARCH.md:**
- REF-06.6 (txutil): If `txutil` does not exist as a separate package, note that the intent (shared transaction test patterns) was satisfied via the storetest conformance suite
- REF-05.3/5.4: Research says AdapterManager (352 lines) and MetadataStoreManager (111 lines) -- verify actual directory names are adapters/ and stores/ sub-services under runtime/

Run `go build ./...` and `go test ./pkg/payload/... ./pkg/controlplane/... ./pkg/metadata/...` to confirm build and tests pass.
  </action>
  <verify>
    <automated>grep -c "REF-05\|REF-06" .planning/phases/29-core-layer-decomposition/29-VERIFICATION.md | test $(cat) -ge 17 && grep -q "PASSED" .planning/phases/29-core-layer-decomposition/29-VERIFICATION.md && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>29-VERIFICATION.md exists in phase 29 directory with YAML frontmatter, all 8 REF-05 and 9 REF-06 sub-requirements covered in Requirements Coverage table, Observable Truths verified against codebase, PASSED status in summary</done>
</task>

<task type="auto">
  <name>Task 3: Update REQUIREMENTS.md traceability table</name>
  <files>.planning/REQUIREMENTS.md</files>
  <action>
Update `.planning/REQUIREMENTS.md` traceability table to remove "pending formal verification in 29.4" notes:

1. Find the Traceability table (section at bottom of file).
2. Change REF-04 status from `Complete (11/11, pending formal verification in 29.4)` to `Complete (11/11)`
3. Change REF-05 status from `Complete (8/8, pending formal verification in 29.4)` to `Complete (8/8)`
4. Change REF-06 status from `Complete (9/9, pending formal verification in 29.4)` to `Complete (9/9)`
5. Update the `*Updated:*` line at the bottom to the current date: `*Updated: 2026-02-26 -- formal verification for REF-04, REF-05, REF-06 completed in Phase 29.4*`

**Do NOT change any checkboxes** -- they are already `[x]` for all REF-04 through REF-06 sub-requirements.
**Do NOT change any other sections** -- only the traceability table Status column and the Updated line.

After editing, verify:
- `grep "pending formal verification" .planning/REQUIREMENTS.md` returns zero matches
- `grep "Complete (11/11)" .planning/REQUIREMENTS.md` matches REF-04 row
- `grep "Complete (8/8)" .planning/REQUIREMENTS.md` matches REF-05 row
- `grep "Complete (9/9)" .planning/REQUIREMENTS.md` matches REF-06 row
  </action>
  <verify>
    <automated>grep -c "pending formal verification" .planning/REQUIREMENTS.md | test $(cat) -eq 0 && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>REQUIREMENTS.md traceability table shows "Complete (11/11)" for REF-04, "Complete (8/8)" for REF-05, "Complete (9/9)" for REF-06 with no "pending formal verification" text remaining. Updated date reflects Phase 29.4 completion.</done>
</task>

</tasks>

<verification>
Phase-level verification:
1. `ls .planning/phases/28-smb-adapter-restructuring/28-VERIFICATION.md` -- file exists
2. `ls .planning/phases/29-core-layer-decomposition/29-VERIFICATION.md` -- file exists
3. `grep "PASSED" .planning/phases/28-smb-adapter-restructuring/28-VERIFICATION.md` -- Phase 28 verified as passed
4. `grep "PASSED" .planning/phases/29-core-layer-decomposition/29-VERIFICATION.md` -- Phase 29 verified as passed
5. `grep -c "pending formal verification" .planning/REQUIREMENTS.md` returns 0 -- no pending verification notes remain
6. `grep "Complete (11/11)" .planning/REQUIREMENTS.md` -- REF-04 marked complete
7. `grep "Complete (8/8)" .planning/REQUIREMENTS.md` -- REF-05 marked complete
8. `grep "Complete (9/9)" .planning/REQUIREMENTS.md` -- REF-06 marked complete
</verification>

<success_criteria>
- Phase 28 VERIFICATION.md exists with 11/11 REF-04 sub-requirements verified with codebase evidence
- Phase 29 VERIFICATION.md exists with 8/8 REF-05 and 9/9 REF-06 sub-requirements verified with codebase evidence
- REQUIREMENTS.md traceability table has no "pending formal verification" entries
- All evidence references confirmed against current codebase state (not stale SUMMARY claims)
- `go build ./...` passes (confirmed in verification files)
</success_criteria>

<output>
After completion, create `.planning/phases/29.4-verification-artifacts-requirements-cleanup/29.4-01-SUMMARY.md`
</output>
