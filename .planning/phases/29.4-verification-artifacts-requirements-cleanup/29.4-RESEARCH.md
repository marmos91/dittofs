# Phase 29.4: Verification Artifacts & Requirements Cleanup - Research

**Researched:** 2026-02-26
**Domain:** Documentation verification and requirements traceability
**Confidence:** HIGH

## Summary

Phase 29.4 is a documentation-only phase that closes procedural gaps identified by the v3.5 milestone audit. The audit found that Phases 28 (SMB Adapter Restructuring) and 29 (Core Layer Decomposition) are functionally complete with all SUMMARY files claiming completion and integration wiring confirmed, but they lack formal VERIFICATION.md files. Additionally, the REQUIREMENTS.md traceability table has not been updated to reflect the completion of REF-01 through REF-06.

This phase requires no code changes. All work is verification and documentation: creating two VERIFICATION.md files (one for Phase 28, one for Phase 29) and updating REQUIREMENTS.md checkboxes and traceability table status fields.

The evidence already exists across 12 SUMMARY files (5 for Phase 28, 7 for Phase 29). The task is to cross-reference SUMMARY claims against the actual codebase (file existence, grep for types/interfaces, build/test pass) and produce formal verification documents in the established format.

**Primary recommendation:** Follow the exact VERIFICATION.md format established in Phase 26 (26-VERIFICATION.md) -- YAML frontmatter, Observable Truths table, Required Artifacts table, Key Link Verification table, Requirements Coverage table, and Summary section with build/test status.

<phase_requirements>
## Phase Requirements

| ID | Description | Research Support |
|----|-------------|-----------------|
| REF-04 (verification) | SMB Adapter Restructuring -- 11 sub-requirements (REF-04.1 through REF-04.11) need formal verification | Phase 28 SUMMARY files (28-01 through 28-05) provide complete evidence trail. Each sub-requirement maps to specific files and commits. Verification requires confirming file existence, type names, and wiring. |
| REF-05 (verification) | Core Object Decomposition -- 8 sub-requirements (REF-05.1 through REF-05.8) need formal verification | Phase 29 SUMMARY files (29-02, 29-04, 29-06) provide evidence. Key artifacts: 12 store sub-interfaces, 6 runtime sub-services, offloader package split. |
| REF-06 (verification) | Code Quality Improvements -- 9 sub-requirements (REF-06.1 through REF-06.9) need formal verification | Phase 29 SUMMARY files (29-01, 29-03, 29-05, 29-07) provide evidence. Key artifacts: PayloadError type, generic helpers, file splits, API error mapping. |
| Traceability | REQUIREMENTS.md checkboxes and traceability table must reflect current completion state | All REF-01 through REF-06 sub-requirements need checkbox updates. Traceability table status column needs "Complete" for REF-01 through REF-06. |
</phase_requirements>

## Standard Stack

This phase uses no libraries or tools beyond what already exists in the project. It is purely a documentation and verification exercise.

### Core

| Tool | Purpose | Why Standard |
|------|---------|--------------|
| `go build ./...` | Verify codebase compiles | Standard Go build verification |
| `go test ./...` | Verify all tests pass | Standard Go test verification |
| `grep`/`Glob` | Locate specific files, types, interfaces | Verify artifact existence |
| Markdown | VERIFICATION.md and REQUIREMENTS.md format | Established project documentation format |

### Alternatives Considered

None -- this is a documentation-only phase with no technology choices.

## Architecture Patterns

### VERIFICATION.md Structure (Established Pattern)

The project has a well-established VERIFICATION.md format from Phases 26, 27, and 29.8. The pattern is:

```markdown
---
phase: {phase-name}
verified: {ISO timestamp}
status: passed|failed
score: {N/N} must-haves verified
requirements_completed:
  - REF-XX.Y
---

# Phase {N}: {Name} Verification Report

**Phase Goal:** {one-line goal}
**Verified:** {timestamp}
**Status:** {passed|failed}

## Goal Achievement

### Observable Truths
| # | Truth | Status | Evidence |

### Required Artifacts
| Artifact | Expected | Status | Details |

### Key Link Verification
| From | To | Via | Status | Details |

### Requirements Coverage
| Requirement | Source Plan | Description | Status | Evidence |

### Anti-Patterns Found
{scan results}

### Human Verification Required
{items needing manual testing, if any}

## Verification Summary
**Status:** {PASSED|FAILED}
{numbered list of success criteria}
**Requirements Completed:** {list}
**Artifacts:** {count}
**Key Links:** {count}
**Build Status:** {result}
**Test Status:** {result}
```

### Requirements Coverage Mapping

Each VERIFICATION.md must map every sub-requirement to its evidence source. The mapping is already established in SUMMARY files:

**Phase 28 (REF-04) Sub-Requirement to SUMMARY Mapping:**

| Sub-Req | Description | Source SUMMARY | Key Evidence |
|---------|-------------|----------------|--------------|
| REF-04.1 | SMB files renamed (drop smb_ prefix) | 28-01 | `pkg/adapter/smb/adapter.go`, `connection.go`, `config.go` |
| REF-04.2 | BaseAdapter extracted to `pkg/adapter/base.go` | 28-02 | `pkg/adapter/base.go` (ConnectionFactory, ConnectionHandler, MetricsRecorder) |
| REF-04.3 | Both NFS and SMB embed BaseAdapter | 28-02 | `*adapter.BaseAdapter` embedding in both adapter.go files |
| REF-04.4 | NetBIOS framing in `internal/adapter/smb/framing.go` | 28-03 | ReadRequest, WriteNetBIOSFrame, SendRawMessage |
| REF-04.5 | Signing verification in `internal/adapter/smb/signing.go` or `framing.go` | 28-03 | NewSessionSigningVerifier in framing.go |
| REF-04.6 | Dispatch + response consolidated in `internal/adapter/smb/dispatch.go` | 28-03 | dispatch.go + response.go (deviation: split for separation of concerns) |
| REF-04.7 | Compound handling in `internal/adapter/smb/compound.go` | 28-03 | ProcessCompoundRequest, ParseCompoundCommand |
| REF-04.8 | `auth.Authenticator` interface defined | 28-04 | `pkg/adapter/auth.go` with NTLM + Kerberos implementations |
| REF-04.9 | Shared handler helpers in `internal/adapter/smb/helpers.go` | 28-01 | Renamed from utils.go |
| REF-04.10 | connection.go reduced to thin serve loop | 28-03 | 1071 lines reduced to 238 lines |
| REF-04.11 | Handler documentation (3-5 lines each) | 28-05 | 7 handler files updated with MS-SMB2 spec references |

**Phase 29 REF-05 Sub-Requirement to SUMMARY Mapping:**

| Sub-Req | Description | Source SUMMARY | Key Evidence |
|---------|-------------|----------------|--------------|
| REF-05.1 | ControlPlane Store interface decomposed into 9+ sub-interfaces | 29-04 | 12 named sub-interfaces in `pkg/controlplane/store/interface.go` |
| REF-05.2 | API handlers narrowed to accept specific sub-interfaces | 29-04 | 8 handlers narrowed (auth, users, groups, shares, etc.) |
| REF-05.3 | AdapterManager extracted from Runtime | 29-06 | `pkg/controlplane/runtime/adapters/service.go` (352 lines) |
| REF-05.4 | MetadataStoreManager extracted from Runtime | 29-06 | `pkg/controlplane/runtime/stores/service.go` (111 lines) |
| REF-05.5 | TransferManager renamed to Offloader | 29-02 | `pkg/payload/offloader/` package (8 files) |
| REF-05.6 | Upload orchestrator extracted to upload.go | 29-02 | `pkg/payload/offloader/upload.go` |
| REF-05.7 | Download coordinator extracted to download.go | 29-02 | `pkg/payload/offloader/download.go` |
| REF-05.8 | Dedup handler extracted to dedup.go | 29-02 | `pkg/payload/offloader/dedup.go` |

**Phase 29 REF-06 Sub-Requirement to SUMMARY Mapping:**

| Sub-Req | Description | Source SUMMARY | Key Evidence |
|---------|-------------|----------------|--------------|
| REF-06.1 | Structured PayloadError type | 29-01 | `pkg/payload/errors.go` with Op/Share/PayloadID/Err fields |
| REF-06.2 | Shared error-to-status mapping for NFS/SMB | 29-01, 29-07 | ProtocolError in `pkg/adapter/errors.go`, MapStoreError in handlers/helpers.go |
| REF-06.3 | Generic GORM helpers | 29-01 | `pkg/controlplane/store/helpers.go` (getByField, listAll, createWithID, deleteByField) |
| REF-06.4 | Centralized API error mapping helper | 29-07 | `internal/controlplane/api/handlers/helpers.go` (MapStoreError, HandleStoreError) |
| REF-06.5 | Generic API client helpers | 29-01 | `pkg/apiclient/helpers.go` (getResource, listResources, etc.) |
| REF-06.6 | Common transaction helpers in txutil | 29-05 | Part of storetest/conformance suite infrastructure |
| REF-06.7 | Shared transaction test suite in storetest | 29-05 | `pkg/metadata/storetest/` (suite.go, file_ops.go, dir_ops.go, permissions.go) |
| REF-06.8 | file.go split into operation files | 29-03 | file_create.go, file_modify.go, file_remove.go, file_helpers.go, file_types.go |
| REF-06.9 | authentication.go split into focused files | 29-03 | auth_identity.go, auth_permissions.go |

### REQUIREMENTS.md Update Pattern

The REQUIREMENTS.md file uses:
- `[x]` checkboxes for completed sub-requirements (currently only REF-01.1-7, REF-01.10 need `[x]`, REF-04 through REF-06 already have `[x]`)
- Traceability table with Status column values: "Complete (N/N)", "Not started"
- Status values with parenthetical notes: "Complete (11/11, pending formal verification in 29.4)"

**Current state of checkboxes:** REF-04 through REF-06 already have `[x]` on all sub-requirements in REQUIREMENTS.md. The traceability table status column says "pending formal verification in 29.4" for REF-04, REF-05, REF-06.

**Required updates:**
1. REF-04 traceability: Change from "Complete (11/11, pending formal verification in 29.4)" to "Complete (11/11)"
2. REF-05 traceability: Change from "Complete (8/8, pending formal verification in 29.4)" to "Complete (8/8)"
3. REF-06 traceability: Change from "Complete (9/9, pending formal verification in 29.4)" to "Complete (9/9)"
4. Update the `*Updated:*` date at the bottom

### Anti-Pattern: Observable Truths

Observable truths must be verifiable with concrete evidence -- file paths with line numbers, grep results, or command output. Do NOT use vague evidence like "confirmed present" without specifying the exact file and location.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| VERIFICATION.md format | Custom format | Copy Phase 26's format exactly | Consistency across all phase verifications |
| Evidence gathering | Manual file reading | `go build ./...`, `go test ./...`, grep for types/interfaces | Reproducible verification |
| Checkbox syntax | Freeform text | Exact `[x]`/`[ ]` markdown checkbox syntax | Machine-readable traceability |

**Key insight:** This phase creates no new patterns. It applies existing verification patterns to existing evidence.

## Common Pitfalls

### Pitfall 1: Incomplete Sub-Requirement Coverage
**What goes wrong:** VERIFICATION.md misses one or more sub-requirements, leaving gaps in the traceability chain.
**Why it happens:** With 28 sub-requirements across 3 requirement groups, it is easy to skip one.
**How to avoid:** Use the mapping tables above as a checklist. Every row must appear in the VERIFICATION.md Requirements Coverage table.
**Warning signs:** Sub-requirement count in VERIFICATION.md does not match REQUIREMENTS.md (REF-04: 11, REF-05: 8, REF-06: 9).

### Pitfall 2: Stale Evidence References
**What goes wrong:** VERIFICATION.md cites files or line numbers that have changed since the SUMMARY was written.
**Why it happens:** Code refactoring between plans within the same phase can move code.
**How to avoid:** Verify evidence against the current codebase state, not SUMMARY claims. Use grep/glob to confirm current file locations and types.
**Warning signs:** Referenced file does not exist or referenced type/function not found at stated location.

### Pitfall 3: Forgetting to Update Traceability Table
**What goes wrong:** VERIFICATION.md files are created but REQUIREMENTS.md traceability table still says "pending formal verification."
**Why it happens:** The REQUIREMENTS.md update is a separate task that can be overlooked.
**How to avoid:** Make the REQUIREMENTS.md update a separate, explicit plan task with its own verification step.
**Warning signs:** Traceability table still contains "pending formal verification in 29.4" after phase completion.

### Pitfall 4: Creating VERIFICATION.md in Wrong Directory
**What goes wrong:** VERIFICATION.md placed in phase 29.4 directory instead of phases 28 and 29 directories.
**Why it happens:** Confusion between where the work is planned (29.4) and where the verification artifacts belong (28, 29).
**How to avoid:** VERIFICATION.md files go in their respective phase directories:
- `.planning/phases/28-smb-adapter-restructuring/28-VERIFICATION.md`
- `.planning/phases/29-core-layer-decomposition/29-VERIFICATION.md`
**Warning signs:** No VERIFICATION.md in phase 28 or 29 directories after this phase completes.

### Pitfall 5: Over-Scoping Verification
**What goes wrong:** Attempting to re-verify Phase 26 or Phase 27 requirements (already verified).
**Why it happens:** REF-01 and REF-02 are mentioned in the audit context.
**How to avoid:** Phase 29.4 scope is only REF-04, REF-05, REF-06 verification + REQUIREMENTS.md updates. Phases 26 and 27 already have VERIFICATION.md files. Do not duplicate or re-verify them.
**Warning signs:** Creating verification artifacts for phases that already have them.

## Code Examples

### Phase 28 VERIFICATION.md Observable Truth Example

```markdown
| 1 | pkg/adapter/smb/ files have no smb_ prefix | VERIFIED | `ls pkg/adapter/smb/*.go` shows adapter.go, connection.go, connection_test.go, config.go (no smb_ prefix). Old files confirmed absent. |
| 2 | BaseAdapter defined in pkg/adapter/base.go with ConnectionFactory interface | VERIFIED | `pkg/adapter/base.go` defines `type BaseAdapter struct` with `ConnectionFactory`, `ConnectionHandler`, and `MetricsRecorder` interfaces |
| 3 | Both NFS and SMB adapters embed *adapter.BaseAdapter | VERIFIED | `pkg/adapter/nfs/adapter.go` contains `*adapter.BaseAdapter` field; `pkg/adapter/smb/adapter.go` contains `*adapter.BaseAdapter` field |
```

### Phase 29 VERIFICATION.md Observable Truth Example

```markdown
| 1 | Store interface decomposed into 12 sub-interfaces with composite Store | VERIFIED | `pkg/controlplane/store/interface.go` defines UserStore, GroupStore, ShareStore, PermissionStore, MetadataStoreConfigStore, PayloadStoreConfigStore, AdapterStore, SettingsStore, AdminStore, HealthStore, NetgroupStore, IdentityMappingStore |
| 2 | Runtime decomposed into 6 sub-services under runtime/ | VERIFIED | Directories exist: `runtime/adapters/`, `runtime/stores/`, `runtime/shares/`, `runtime/mounts/`, `runtime/lifecycle/`, `runtime/identity/` |
```

### REQUIREMENTS.md Traceability Update Example

```markdown
| REF-04: SMB Adapter Restructuring | 28 | Complete (11/11) |
| REF-05: Core Object Decomposition | 29 | Complete (8/8) |
| REF-06: Code Quality Improvements | 29 | Complete (9/9) |
```

## State of the Art

Not applicable -- this phase applies existing documentation patterns to existing evidence. No technology evolution to track.

## Open Questions

1. **REF-04.5 (signing verification) location ambiguity**
   - What we know: Plan 28-03 SUMMARY says signing was moved to `framing.go` as `NewSessionSigningVerifier`, not to a separate `signing.go` file
   - What's unclear: Whether this deviation from REF-04.5's literal wording ("moved to signing.go") should be flagged as partial or satisfied
   - Recommendation: Mark as SATISFIED with note explaining the deviation -- the intent (extracting signing verification to internal/) was achieved, just in a different file. The 28-03 SUMMARY documents this as a deliberate decision.

2. **REF-04.6 (dispatch + response consolidation) deviation**
   - What we know: Plan 28-03 created `response.go` separate from `dispatch.go` instead of consolidating both in `dispatch.go`
   - What's unclear: Whether this should be flagged as deviation
   - Recommendation: Mark as SATISFIED -- the 28-03 SUMMARY documents this as a deliberate improvement (better separation of concerns). Both dispatch and response logic are in `internal/adapter/smb/`.

3. **REF-06.6 (transaction helpers in txutil) implementation form**
   - What we know: 29-05 SUMMARY mentions conformance test suite but does not explicitly call out a `txutil` sub-package
   - What's unclear: Whether `txutil` exists as a separate package or the functionality is embedded in storetest
   - Recommendation: Verify during implementation. If txutil does not exist as a separate package, note in VERIFICATION.md that the intent (shared transaction test patterns) was satisfied via the storetest conformance suite.

## Sources

### Primary (HIGH confidence)
- `.planning/v3.5-MILESTONE-AUDIT.md` -- identifies exact gaps to close
- `.planning/REQUIREMENTS.md` -- defines all sub-requirements and current checkbox state
- `.planning/phases/26-*/26-VERIFICATION.md` -- format template (established pattern)
- `.planning/phases/27-*/27-VERIFICATION.md` -- format template (established pattern)
- `.planning/phases/29.8-*/29.8-VERIFICATION.md` -- format template (latest example)
- `.planning/phases/28-*/28-01-SUMMARY.md` through `28-05-SUMMARY.md` -- Phase 28 evidence
- `.planning/phases/29-*/29-01-SUMMARY.md` through `29-07-SUMMARY.md` -- Phase 29 evidence

### Secondary (MEDIUM confidence)
- None needed -- all evidence is in the codebase and planning documents

### Tertiary (LOW confidence)
- None

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - no technology choices, documentation only
- Architecture: HIGH - follows established VERIFICATION.md format exactly
- Pitfalls: HIGH - based on actual audit findings and codebase review
- Evidence mapping: HIGH - all SUMMARY files read and cross-referenced

**Research date:** 2026-02-26
**Valid until:** No expiry -- this is a documentation task with no external dependencies
