---
phase: 04-shares-permissions
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - test/e2e/helpers/cli.go
  - test/e2e/permissions_test.go
autonomous: true

must_haves:
  truths:
    - "Admin can grant read permission to a user on a share"
    - "Admin can grant read-write permission to a user on a share"
    - "Admin can grant read permission to a group on a share"
    - "Admin can grant read-write permission to a group on a share"
    - "Admin can revoke permission from a user"
    - "Admin can revoke permission from a group"
    - "Permission list shows all configured permissions for a share"
  artifacts:
    - path: "test/e2e/helpers/cli.go"
      provides: "SharePermission type and permission CRUD methods"
      contains: "func (r *CLIRunner) GrantUserPermission"
    - path: "test/e2e/permissions_test.go"
      provides: "E2E tests for permission management"
      contains: "func TestSharePermissions"
  key_links:
    - from: "test/e2e/permissions_test.go"
      to: "test/e2e/helpers/cli.go"
      via: "Permission grant/revoke/list methods"
      pattern: "cli\\.(Grant|Revoke|List).*Permission"
---

<objective>
Add permission management support to CLIRunner and create comprehensive E2E tests for share permissions.

Purpose: Validate that permissions can be granted and revoked for users and groups on shares via the dittofsctl CLI. This enables Phase 6 permission enforcement tests.

Output:
- SharePermission type in helpers/cli.go
- Permission management methods: GrantUserPermission, GrantGroupPermission, RevokeUserPermission, RevokeGroupPermission, ListSharePermissions
- E2E test file covering PRM-01 through PRM-07
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-shares-permissions/04-RESEARCH.md
@test/e2e/helpers/cli.go
@test/e2e/groups_test.go
@cmd/dittofsctl/commands/share/permission/grant.go
@cmd/dittofsctl/commands/share/permission/revoke.go
@cmd/dittofsctl/commands/share/permission/list.go
@pkg/apiclient/shares.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SharePermission type and permission methods to CLIRunner</name>
  <files>test/e2e/helpers/cli.go</files>
  <action>
Add permission management types and methods to cli.go.

1. Add SharePermission type (matches API response):
```go
// SharePermission represents a permission on a share.
type SharePermission struct {
    Type  string `json:"type"`  // "user" or "group"
    Name  string `json:"name"`  // username or group name
    Level string `json:"level"` // "none", "read", "read-write", "admin"
}
```

2. Add GrantUserPermission(shareName, username, level string) error:
- Runs `share permission grant <shareName> --user <username> --level <level>`
- Level must be one of: "none", "read", "read-write", "admin"
- Returns error on failure

3. Add GrantGroupPermission(shareName, groupName, level string) error:
- Runs `share permission grant <shareName> --group <groupName> --level <level>`
- Returns error on failure

4. Add RevokeUserPermission(shareName, username string) error:
- Runs `share permission revoke <shareName> --user <username>`
- Returns error on failure

5. Add RevokeGroupPermission(shareName, groupName string) error:
- Runs `share permission revoke <shareName> --group <groupName>`
- Returns error on failure

6. Add ListSharePermissions(shareName string) ([]*SharePermission, error):
- Runs `share permission list <shareName>`
- Parses JSON output into []*SharePermission
- Returns empty slice (not error) if no permissions

Note: Permission levels are case-sensitive. Always use lowercase: "read", "read-write", "admin", "none".
</action>
  <verify>
Run: `go build ./test/e2e/helpers/...` - should compile without errors
Grep: `grep -n "func.*CLIRunner.*Permission" test/e2e/helpers/cli.go` - should show 5 methods
  </verify>
  <done>
- SharePermission type defined with Type, Name, Level fields
- GrantUserPermission method implemented
- GrantGroupPermission method implemented
- RevokeUserPermission method implemented
- RevokeGroupPermission method implemented
- ListSharePermissions method implemented
  </done>
</task>

<task type="auto">
  <name>Task 2: Create permissions E2E test file</name>
  <files>test/e2e/permissions_test.go</files>
  <action>
Create comprehensive E2E tests for permission management covering PRM-01 through PRM-07.

1. File structure:
```go
//go:build e2e

package e2e

import (
    "testing"

    "github.com/marmos91/dittofs/test/e2e/helpers"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"
)
```

2. Add helper function at file level:
```go
// findPermission searches for a permission in the list.
// If level is empty string, matches any level for that type/name.
func findPermission(perms []*helpers.SharePermission, permType, name, level string) bool {
    for _, p := range perms {
        if p.Type == permType && p.Name == name {
            if level == "" || p.Level == level {
                return true
            }
        }
    }
    return false
}
```

3. TestSharePermissions main test function:
- Skip in short mode
- Start server with helpers.StartServerProcess
- Login as admin
- Create shared stores (memory meta and payload) for all subtests
- Cleanup stores after all tests

4. Subtests (all use t.Parallel() where safe):

a) "PRM-01 grant read permission to user":
   - Create share, create user
   - Grant "read" to user
   - List permissions, verify user has "read"

b) "PRM-02 grant read-write permission to user":
   - Create share, create user
   - Grant "read-write" to user
   - List permissions, verify user has "read-write"

c) "PRM-03 grant read permission to group":
   - Create share, create group
   - Grant "read" to group
   - List permissions, verify group has "read"

d) "PRM-04 grant read-write permission to group":
   - Create share, create group
   - Grant "read-write" to group
   - List permissions, verify group has "read-write"

e) "PRM-05 revoke permission from user":
   - Create share, create user
   - Grant permission, then revoke
   - List permissions, verify user NOT in list

f) "PRM-06 revoke permission from group":
   - Create share, create group
   - Grant permission, then revoke
   - List permissions, verify group NOT in list

g) "PRM-07 list permissions for share":
   - Create share, create user, create group
   - Grant different permissions to user and group
   - List permissions, verify both appear with correct levels

h) "empty permissions list for new share":
   - Create share
   - List permissions
   - Should return empty list (not error)

i) "permission override replaces previous level":
   - Create share, create user
   - Grant "read" to user
   - Grant "read-write" to user (should replace, not add)
   - List permissions, verify only one entry with "read-write"

5. Test naming: Use "/" + helpers.UniqueTestName("share_prmXX") for shares
   Use helpers.UniqueTestName("user_prmXX") or "group_prmXX" for users/groups

6. Cleanup order in each test:
   - Delete share first (removes permission references)
   - Then delete user/group
   - Stores deleted at suite level
</action>
  <verify>
Run: `go build -tags=e2e ./test/e2e/...` - should compile
Run: `go test -tags=e2e -v -run TestSharePermissions ./test/e2e/ -short` - should skip
  </verify>
  <done>
- test/e2e/permissions_test.go created with build tag
- TestSharePermissions function with 9 subtests
- Covers PRM-01 through PRM-07 plus edge cases
- Uses findPermission helper for clean assertions
- Proper cleanup order (shares before users/groups)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Build verification:
   ```bash
   go build ./test/e2e/helpers/...
   go build -tags=e2e ./test/e2e/...
   ```

2. Code structure verification:
   ```bash
   # SharePermission type exists
   grep -n "type SharePermission struct" test/e2e/helpers/cli.go

   # Permission methods exist
   grep -n "func.*CLIRunner.*Permission" test/e2e/helpers/cli.go

   # Test file structure
   grep -n "func TestSharePermissions" test/e2e/permissions_test.go
   grep -n "PRM-0" test/e2e/permissions_test.go
   ```

3. Test count: At least 9 subtests in TestSharePermissions
</verification>

<success_criteria>
- [ ] SharePermission type defined with Type, Name, Level fields
- [ ] GrantUserPermission method implemented
- [ ] GrantGroupPermission method implemented
- [ ] RevokeUserPermission method implemented
- [ ] RevokeGroupPermission method implemented
- [ ] ListSharePermissions method implemented
- [ ] permissions_test.go created with e2e build tag
- [ ] TestSharePermissions covers PRM-01 through PRM-07
- [ ] Edge cases tested (empty list, permission override)
- [ ] All code compiles with `go build -tags=e2e ./test/e2e/...`
</success_criteria>

<output>
After completion, create `.planning/phases/04-shares-permissions/04-02-SUMMARY.md`
</output>
