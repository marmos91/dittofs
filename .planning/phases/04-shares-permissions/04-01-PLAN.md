---
phase: 04-shares-permissions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - test/e2e/helpers/cli.go
  - test/e2e/shares_test.go
autonomous: true

must_haves:
  truths:
    - "Admin can create a share with metadata and payload store assignments"
    - "Admin can list all shares via CLI"
    - "Admin can edit share configuration (read-only, default permission)"
    - "Admin can delete a share via CLI"
    - "Duplicate share name is rejected with clear error"
  artifacts:
    - path: "test/e2e/helpers/cli.go"
      provides: "Share type and full CRUD methods on CLIRunner"
      contains: "func (r *CLIRunner) CreateShare"
    - path: "test/e2e/shares_test.go"
      provides: "E2E tests for share CRUD operations"
      contains: "func TestSharesCRUD"
  key_links:
    - from: "test/e2e/shares_test.go"
      to: "test/e2e/helpers/cli.go"
      via: "CLIRunner.CreateShare, EditShare, DeleteShare, ListShares"
      pattern: "cli\\.(Create|Edit|Delete|List|Get)Share"
---

<objective>
Add full Share CRUD support to CLIRunner and create comprehensive E2E tests for share management.

Purpose: Validate that shares can be created with store assignments, listed, edited, and deleted via the dittofsctl CLI. This enables Phase 6 file operation tests which require shares to exist.

Output:
- Share type with ShareOption functional options in helpers/cli.go
- Expanded CreateShare (replacing minimal Phase 3 helper) with full options support
- GetShare, ListShares, EditShare methods
- E2E test file covering SHR-01 through SHR-04 (soft delete SHR-05/SHR-06 deferred - not implemented in server)
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-shares-permissions/04-RESEARCH.md
@test/e2e/helpers/cli.go
@test/e2e/metadata_stores_test.go
@cmd/dittofsctl/commands/share/create.go
@cmd/dittofsctl/commands/share/edit.go
@pkg/apiclient/shares.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Share type and CLIRunner CRUD methods</name>
  <files>test/e2e/helpers/cli.go</files>
  <action>
Expand the existing minimal share helpers in cli.go to full CRUD support.

1. Add Share type (matches API response structure):
```go
// Share represents a share returned from the API.
type Share struct {
    Name              string `json:"name"`
    MetadataStoreID   string `json:"metadata_store_id"`
    PayloadStoreID    string `json:"payload_store_id"`
    ReadOnly          bool   `json:"read_only"`
    DefaultPermission string `json:"default_permission"`
    Description       string `json:"description,omitempty"`
}
```

2. Add ShareOption functional options:
- `WithShareReadOnly(bool)` - sets read-only flag
- `WithShareDefaultPermission(string)` - valid: "none", "read", "read-write", "admin"
- `WithShareDescription(string)` - sets description

3. Replace the minimal CreateShare helper (from Phase 3) with full version:
- Takes name, metadataStore, payloadStore, and variadic ShareOption
- Builds args with `--name`, `--metadata`, `--payload`
- Adds `--read-only`, `--default-permission`, `--description` if options set
- Returns *Share (not error only)

4. Add ListShares() ([]*Share, error):
- Runs `share list`
- Parses JSON output into []*Share

5. Add GetShare(name string) (*Share, error):
- Uses ListShares and filters by name (no dedicated CLI get command)
- Returns error if not found

6. Add EditShare(name string, opts ...ShareOption) (*Share, error):
- Builds args from options provided
- Returns error if no options given
- Returns updated *Share

7. Keep existing DeleteShare (already has --force)

Important: Share names MUST have leading slash (e.g., "/myshare"). The CLI normalizes this.
</action>
  <verify>
Run: `go build ./test/e2e/helpers/...` - should compile without errors
Grep: `grep -n "func.*CLIRunner.*Share" test/e2e/helpers/cli.go` - should show CreateShare, GetShare, ListShares, EditShare, DeleteShare
  </verify>
  <done>
- Share type defined with all fields from API response
- ShareOption pattern with 3 options (ReadOnly, DefaultPermission, Description)
- 5 CRUD methods: CreateShare (expanded), GetShare, ListShares, EditShare, DeleteShare
- All methods follow established CLIRunner pattern with JSON output parsing
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shares E2E test file</name>
  <files>test/e2e/shares_test.go</files>
  <action>
Create comprehensive E2E tests for share CRUD operations covering SHR-01 through SHR-04.

1. File structure following Phase 3 pattern:
```go
//go:build e2e

package e2e

import (
    "strings"
    "testing"

    "github.com/marmos91/dittofs/test/e2e/helpers"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"
)
```

2. TestSharesCRUD main test function:
- Skip in short mode
- Start server with helpers.StartServerProcess
- Login as admin
- Create shared stores (memory meta and payload) for all subtests
- Cleanup stores after all tests

3. Subtests (all use t.Parallel() for speed):

a) "SHR-01 create share with assigned stores":
   - Create share with unique name (prefix with "/")
   - Verify Name, MetadataStoreID, PayloadStoreID match
   - Verify DefaultPermission is "read-write" (default)

b) "SHR-01 create share with options":
   - Create share with WithShareReadOnly(true), WithShareDefaultPermission("read")
   - Verify ReadOnly=true, DefaultPermission="read"

c) "SHR-02 list shares":
   - Create 2 shares with unique names
   - List shares
   - Verify both appear in list

d) "SHR-03 edit share configuration":
   - Create share
   - Edit with WithShareReadOnly(true), WithShareDefaultPermission("admin")
   - Verify changes persisted

e) "SHR-04 delete share":
   - Create share
   - Delete share
   - GetShare should return error (not found)

f) "duplicate share name rejected":
   - Create share
   - Attempt to create with same name
   - Should fail with error containing "exists", "conflict", or "duplicate"

g) "create share with nonexistent store fails":
   - Try to create share with fake metadata store name
   - Should fail with clear error

4. Test naming convention: Use "/" + helpers.UniqueTestName("share_xxx")

5. Cleanup order in each test: Delete share BEFORE stores would be deleted (cleanup registered in reverse order)

Note: SHR-05/SHR-06 (soft delete with deferred cleanup) are NOT testable - server implements hard delete. Document this in test file comment.
</action>
  <verify>
Run: `go build -tags=e2e ./test/e2e/...` - should compile
Run: `go test -tags=e2e -v -run TestSharesCRUD ./test/e2e/ -short` - should skip (we're testing compilation)
  </verify>
  <done>
- test/e2e/shares_test.go created with build tag
- TestSharesCRUD function with 7+ subtests
- Covers SHR-01, SHR-02, SHR-03, SHR-04
- Documents that SHR-05/SHR-06 deferred (soft delete not implemented)
- Uses shared stores across subtests with proper cleanup
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Build verification:
   ```bash
   go build ./test/e2e/helpers/...
   go build -tags=e2e ./test/e2e/...
   ```

2. Code structure verification:
   ```bash
   # Share type and options exist
   grep -n "type Share struct" test/e2e/helpers/cli.go
   grep -n "ShareOption" test/e2e/helpers/cli.go

   # CRUD methods exist
   grep -n "func.*CLIRunner.*Share" test/e2e/helpers/cli.go

   # Test file structure
   grep -n "func TestSharesCRUD" test/e2e/shares_test.go
   grep -n "SHR-0" test/e2e/shares_test.go
   ```

3. Test count: At least 7 subtests in TestSharesCRUD
</verification>

<success_criteria>
- [ ] Share type matches API response (Name, MetadataStoreID, PayloadStoreID, ReadOnly, DefaultPermission, Description)
- [ ] ShareOption functional options: WithShareReadOnly, WithShareDefaultPermission, WithShareDescription
- [ ] CreateShare expanded with options (returns *Share, not just error)
- [ ] GetShare, ListShares, EditShare methods added
- [ ] DeleteShare preserved with --force
- [ ] shares_test.go created with e2e build tag
- [ ] TestSharesCRUD covers SHR-01 through SHR-04
- [ ] SHR-05/SHR-06 documented as deferred (soft delete not implemented)
- [ ] All code compiles with `go build -tags=e2e ./test/e2e/...`
</success_criteria>

<output>
After completion, create `.planning/phases/04-shares-permissions/04-01-SUMMARY.md`
</output>
