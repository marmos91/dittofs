---
phase: 13-nfsv4-acls
plan: 04
type: execute
wave: 2
depends_on: ["13-01", "13-02"]
files_modified:
  - internal/protocol/nfs/v4/attrs/acl.go
  - internal/protocol/nfs/v4/attrs/acl_test.go
  - internal/protocol/nfs/v4/attrs/encode.go
  - internal/protocol/nfs/v4/attrs/decode.go
  - internal/protocol/nfs/v4/handlers/setattr.go
  - internal/protocol/nfs/v4/handlers/handler.go
autonomous: true

must_haves:
  truths:
    - "FATTR4_ACL encodes ACL to XDR in GETATTR response"
    - "FATTR4_ACL decodes ACL from XDR in SETATTR request"
    - "FATTR4_ACLSUPPORT returns all 4 ACE type support flags"
    - "SupportedAttrs bitmap includes bits 12 (ACL) and 13 (ACLSUPPORT)"
    - "WritableAttrs bitmap includes bit 12 (ACL)"
    - "SETATTR with FATTR4_ACL validates and stores ACL on file"
    - "Identity mapper used for FATTR4_OWNER/OWNER_GROUP encoding"
  artifacts:
    - path: "internal/protocol/nfs/v4/attrs/acl.go"
      provides: "ACL XDR encoding and decoding for FATTR4_ACL and FATTR4_ACLSUPPORT"
      exports: ["EncodeACLAttr", "DecodeACLAttr", "EncodeACLSupportAttr"]
    - path: "internal/protocol/nfs/v4/attrs/encode.go"
      provides: "Updated SupportedAttrs and WritableAttrs with ACL bits, identity mapper for owner"
      contains: "FATTR4_ACL|FATTR4_ACLSUPPORT"
    - path: "internal/protocol/nfs/v4/attrs/decode.go"
      provides: "FATTR4_ACL decoding in DecodeFattr4ToSetAttrs"
      contains: "DecodeACLAttr"
  key_links:
    - from: "internal/protocol/nfs/v4/attrs/acl.go"
      to: "pkg/metadata/acl/types.go"
      via: "imports ACE/ACL types for encoding/decoding"
      pattern: "acl\\.ACE|acl\\.ACL"
    - from: "internal/protocol/nfs/v4/attrs/encode.go"
      to: "internal/protocol/nfs/v4/attrs/acl.go"
      via: "calls EncodeACLAttr in encodeRealFileAttr"
      pattern: "EncodeACLAttr"
    - from: "internal/protocol/nfs/v4/handlers/setattr.go"
      to: "internal/protocol/nfs/v4/attrs/decode.go"
      via: "SETATTR handler reads decoded ACL from SetAttrs"
      pattern: "setAttrs\\.ACL"
---

<objective>
Implement NFSv4 ACL wire format encoding/decoding for GETATTR and SETATTR operations, including FATTR4_ACL and FATTR4_ACLSUPPORT attributes.

Purpose: NFS clients need to read and write ACLs via the standard NFSv4 attribute mechanism. This integrates the ACL package with the NFS protocol layer.
Output: ACL XDR encoding/decoding, updated attribute bitmaps, and SETATTR ACL support.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-nfsv4-acls/13-CONTEXT.md
@.planning/phases/13-nfsv4-acls/13-RESEARCH.md
@.planning/phases/13-nfsv4-acls/13-01-SUMMARY.md
@.planning/phases/13-nfsv4-acls/13-02-SUMMARY.md
@internal/protocol/nfs/v4/attrs/encode.go
@internal/protocol/nfs/v4/attrs/decode.go
@internal/protocol/nfs/v4/handlers/setattr.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: ACL XDR Encoding/Decoding</name>
  <files>
    internal/protocol/nfs/v4/attrs/acl.go
    internal/protocol/nfs/v4/attrs/acl_test.go
  </files>
  <action>
Create `internal/protocol/nfs/v4/attrs/acl.go`:

**EncodeACLAttr(buf *bytes.Buffer, fileACL *acl.ACL) error:**
- NFSv4 ACL XDR format per RFC 7531:
  1. uint32: number of ACEs (acecount)
  2. For each ACE (nfsace4):
     - uint32: type (acetype4)
     - uint32: flag (aceflag4)
     - uint32: access_mask (acemask4)
     - opaque<>: who (utf8str_mixed, XDR string format: uint32 length + padded data)
- Use `xdr.WriteUint32(buf, ...)` for integers
- Use `xdr.WriteXDRString(buf, ace.Who)` for the who string
- If fileACL is nil, encode 0 ACEs (empty list)

**DecodeACLAttr(reader io.Reader) (*acl.ACL, error):**
- Read uint32 acecount
- If acecount > acl.MaxACECount (128), return error (prevent resource exhaustion)
- For each ACE:
  - Read uint32 type, uint32 flag, uint32 access_mask
  - Read XDR string who (uint32 length, then padded data)
  - Construct acl.ACE{Type, Flag, AccessMask, Who}
- Return &acl.ACL{ACEs: aces}

**EncodeACLSupportAttr(buf *bytes.Buffer) error:**
- Write uint32 with all four ACL support bits OR'd: ACL4_SUPPORT_ALLOW_ACL | ACL4_SUPPORT_DENY_ACL | ACL4_SUPPORT_AUDIT_ACL | ACL4_SUPPORT_ALARM_ACL
- This is the FATTR4_ACLSUPPORT value per locked decision "Full FATTR4_ACLSUPPORT bitmap in GETATTR (all 4 ACE types reported)"

**Tests (acl_test.go):**
- Encode then decode round-trip for ACL with multiple ACEs (DENY+ALLOW+INHERIT)
- Encode nil ACL produces 0 ACEs
- Decode 0 ACEs produces empty ACL (not nil -- wire format explicitly says "0 ACEs")
- Encode ACE with special identifier (OWNER@, GROUP@, EVERYONE@)
- Encode ACE with user@domain who string
- Decode ACL with more than 128 ACEs returns error
- Round-trip preserves all fields exactly (type, flag, mask, who)
- EncodeACLSupportAttr produces correct uint32 value (0x0F)
  </action>
  <verify>
cd /Users/marmos91/Projects/dittofs && go test -race -v ./internal/protocol/nfs/v4/attrs/... -run "ACL" | tail -20
go vet ./internal/protocol/nfs/v4/attrs/...
  </verify>
  <done>
ACL XDR encoding and decoding implemented. Round-trip tests confirm all fields preserved. FATTR4_ACLSUPPORT encodes all four ACE type support flags. Excessive ACE count rejected during decode.
  </done>
</task>

<task type="auto">
  <name>Task 2: Attribute Bitmap Updates and SETATTR Integration</name>
  <files>
    internal/protocol/nfs/v4/attrs/encode.go
    internal/protocol/nfs/v4/attrs/decode.go
    internal/protocol/nfs/v4/handlers/setattr.go
    internal/protocol/nfs/v4/handlers/handler.go
  </files>
  <action>
**encode.go changes:**

1. Add FATTR4_ACL (12) and FATTR4_ACLSUPPORT (13) constants if not already defined (they should be in this file or types.go -- check what Plan 01 created in pkg/metadata/acl/types.go and use those or define protocol-layer constants here).

2. Update `SupportedAttrs()` function (or the supported attrs bitmap) to include bits 12 and 13. This tells NFS clients that the server supports ACL attributes. Find where the bitmap is constructed and add:
```go
bm.SetBit(FATTR4_ACL)        // bit 12
bm.SetBit(FATTR4_ACLSUPPORT) // bit 13
```

3. Update `WritableAttrs()` bitmap to include bit 12 (FATTR4_ACL). ACLSUPPORT (bit 13) is read-only.

4. Update `encodeRealFileAttr()` (or equivalent function that encodes per-file attributes) to handle FATTR4_ACL and FATTR4_ACLSUPPORT:
- For FATTR4_ACL (bit 12): if requested and file has ACL, call `EncodeACLAttr(buf, file.ACL)`. If file has no ACL (nil), encode 0 ACEs.
- For FATTR4_ACLSUPPORT (bit 13): if requested, call `EncodeACLSupportAttr(buf)`.

5. Update FATTR4_OWNER (bit 36) encoding to use identity mapper when available. Currently the code likely hardcodes "root@localdomain" or uses UID. Instead:
- If the handler has an identity mapper reference, reverse-resolve UID to user@domain
- Fallback: format as "uid@localdomain" if no mapper available
- This integrates the identity mapper into owner/group display
- NOTE: This may require the Handler struct to carry an IdentityMapper reference. If so, add it to the Handler struct in handlers/handler.go.

**decode.go changes:**

1. In `DecodeFattr4ToSetAttrs()` (the function that parses writable attributes from SETATTR), add handling for FATTR4_ACL (bit 12):
```go
case FATTR4_ACL:
    decodedACL, err := DecodeACLAttr(reader)
    if err != nil {
        return nil, 0, &nfs4StatusError{Status: v4types.NFS4ERR_BADXDR, Msg: "invalid ACL encoding"}
    }
    // Validate the decoded ACL
    if err := acl.ValidateACL(decodedACL); err != nil {
        return nil, 0, &nfs4StatusError{Status: v4types.NFS4ERR_INVAL, Msg: err.Error()}
    }
    result.ACL = decodedACL
```

2. This requires the SetAttrs struct in pkg/metadata/file.go to have the ACL field (added in Plan 03). If Plan 03 runs before Plan 04 executes, this is available. If Plan 04 executes concurrently with Plan 03, the code should still compile since both are Wave 2 -- but conceptually, the SetAttrs.ACL field from Plan 03 must exist.

**handlers/setattr.go changes:**

- The SETATTR handler already calls DecodeFattr4ToSetAttrs and passes the result to MetadataService.SetFileAttributes. Since Plan 03 adds ACL handling to SetFileAttributes, no handler changes may be needed IF the decoded ACL flows through SetAttrs correctly.
- Verify that the SETATTR handler's attrsset bitmap response includes bit 12 when ACL was set. The existing code likely echoes the requested bitmap on success -- confirm this behavior covers FATTR4_ACL.

**handlers/handler.go changes:**

- Add an optional `IdentityMapper` field to the Handler struct (or the CompoundContext). This will be used by GETATTR for owner/group encoding. Use the `pkg/identity` IdentityMapper interface.
- If adding to Handler: `IdentityMapper identity.IdentityMapper` field. Set during adapter initialization.
- If identity mapper is nil (not configured), fall back to existing behavior (numeric UID format).
  </action>
  <verify>
cd /Users/marmos91/Projects/dittofs && go build ./internal/protocol/nfs/...
go test -race -v ./internal/protocol/nfs/v4/attrs/... | tail -20
go test -race -v ./internal/protocol/nfs/v4/handlers/... -run "SETATTR|GETATTR" 2>&1 | tail -20
go vet ./internal/protocol/nfs/...
  </verify>
  <done>
FATTR4_ACL and FATTR4_ACLSUPPORT in SupportedAttrs bitmap. FATTR4_ACL in WritableAttrs bitmap. GETATTR encodes ACL and ACLSUPPORT. SETATTR decodes and validates ACL from XDR, passes to MetadataService. Identity mapper wired for FATTR4_OWNER encoding. All NFS tests pass.
  </done>
</task>

</tasks>

<verification>
- `go build ./internal/protocol/nfs/...` -- NFS protocol compiles
- `go test -race ./internal/protocol/nfs/v4/attrs/...` -- attribute tests pass
- `go test -race ./internal/protocol/nfs/v4/handlers/...` -- handler tests pass
- GETATTR with FATTR4_ACL bit returns encoded ACL
- GETATTR with FATTR4_ACLSUPPORT returns 0x0F (all four types)
- SETATTR with FATTR4_ACL validates and stores ACL
</verification>

<success_criteria>
- FATTR4_ACL encodes ACL to XDR wire format in GETATTR
- FATTR4_ACL decodes ACL from XDR wire format in SETATTR
- FATTR4_ACLSUPPORT returns all four ACE type support flags
- SupportedAttrs includes bits 12 and 13
- WritableAttrs includes bit 12
- ACL validation on SETATTR rejects invalid ACLs (bad ordering, >128 ACEs)
- Identity mapper optionally used for OWNER/OWNER_GROUP encoding
- All existing NFS tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-nfsv4-acls/13-04-SUMMARY.md`
</output>
