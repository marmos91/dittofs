---
phase: 13-nfsv4-acls
plan: 05
type: execute
wave: 3
depends_on: ["13-03", "13-04"]
files_modified:
  - internal/protocol/smb/v2/handlers/security.go
  - internal/protocol/smb/v2/handlers/security_test.go
  - internal/protocol/smb/v2/handlers/query_info.go
  - internal/protocol/smb/v2/handlers/set_info.go
  - pkg/metadata/acl/metrics.go
  - cmd/dittofsctl/commands/idmap/idmap.go
  - cmd/dittofsctl/commands/idmap/add.go
  - cmd/dittofsctl/commands/idmap/list.go
  - cmd/dittofsctl/commands/idmap/remove.go
  - cmd/dittofsctl/commands/root.go
  - pkg/apiclient/identity_mappings.go
  - internal/controlplane/api/handlers/identity_mappings.go
  - pkg/controlplane/api/server.go
autonomous: true

must_haves:
  truths:
    - "SMB QUERY_INFO returns Security Descriptor with Owner SID, Group SID, and DACL"
    - "DACL contains translated NFSv4 ACEs with SIDs instead of user@domain"
    - "Well-known SIDs mapped correctly (EVERYONE@ = S-1-1-0)"
    - "SMB SET_INFO parses Security Descriptor and translates to NFSv4 ACL"
    - "Security Descriptor uses self-relative format with 4-byte alignment"
    - "dittofsctl idmap add/list/remove commands work against REST API"
    - "ACL metrics track evaluation duration and deny counts"
  artifacts:
    - path: "internal/protocol/smb/v2/handlers/security.go"
      provides: "Security Descriptor encoding/decoding with SID and DACL"
      exports: ["BuildSecurityDescriptor", "ParseSecurityDescriptor"]
    - path: "internal/protocol/smb/v2/handlers/query_info.go"
      provides: "Updated buildSecurityInfo with real Owner/Group/DACL from file ACL"
      contains: "BuildSecurityDescriptor"
    - path: "pkg/metadata/acl/metrics.go"
      provides: "Prometheus metrics for ACL operations"
      contains: "acl_evaluation_duration"
    - path: "cmd/dittofsctl/commands/idmap/idmap.go"
      provides: "dittofsctl idmap subcommand group"
      contains: "idmap"
    - path: "internal/controlplane/api/handlers/identity_mappings.go"
      provides: "REST API handlers for identity mapping CRUD"
      contains: "HandleCreateIdentityMapping"
  key_links:
    - from: "internal/protocol/smb/v2/handlers/query_info.go"
      to: "internal/protocol/smb/v2/handlers/security.go"
      via: "buildSecurityInfo calls BuildSecurityDescriptor"
      pattern: "BuildSecurityDescriptor"
    - from: "internal/protocol/smb/v2/handlers/security.go"
      to: "pkg/metadata/acl/types.go"
      via: "translates ACL ACEs to DACL ACEs"
      pattern: "acl\\.ACE|acl\\.ACL"
    - from: "cmd/dittofsctl/commands/idmap/add.go"
      to: "pkg/apiclient/identity_mappings.go"
      via: "CLI calls API client for mapping operations"
      pattern: "client\\.CreateIdentityMapping"
---

<objective>
Implement SMB Security Descriptor encoding for ACL interoperability, identity mapping REST API with dittofsctl commands, and ACL Prometheus metrics.

Purpose: Windows clients need to see and modify ACLs via the Security tab. Identity mappings need to be manageable via the CLI. Metrics enable operational monitoring of ACL operations.
Output: Full SMB ACL interop, identity mapping REST API + CLI, ACL metrics.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-nfsv4-acls/13-CONTEXT.md
@.planning/phases/13-nfsv4-acls/13-RESEARCH.md
@.planning/phases/13-nfsv4-acls/13-01-SUMMARY.md
@.planning/phases/13-nfsv4-acls/13-02-SUMMARY.md
@.planning/phases/13-nfsv4-acls/13-03-SUMMARY.md
@.planning/phases/13-nfsv4-acls/13-04-SUMMARY.md
@internal/protocol/smb/v2/handlers/query_info.go
@internal/protocol/smb/v2/handlers/set_info.go
@cmd/dittofsctl/commands/root.go
@pkg/apiclient/client.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: SMB Security Descriptor Encoding and QUERY_INFO/SET_INFO Integration</name>
  <files>
    internal/protocol/smb/v2/handlers/security.go
    internal/protocol/smb/v2/handlers/security_test.go
    internal/protocol/smb/v2/handlers/query_info.go
    internal/protocol/smb/v2/handlers/set_info.go
  </files>
  <action>
Create `internal/protocol/smb/v2/handlers/security.go`:

**SID Types and Helpers:**
- `SID` struct: Revision (uint8, always 1), SubAuthorityCount (uint8), IdentifierAuthority ([6]byte, big-endian), SubAuthorities ([]uint32).
- `EncodeSID(buf *bytes.Buffer, sid *SID)`: Write binary SID per MS-DTYP Section 2.4.2 (Revision, SubAuthCount, Authority[6], SubAuthorities as little-endian uint32s).
- `SIDSize(sid *SID) int`: Returns binary size (8 + 4*SubAuthorityCount).
- `ParseSIDString(s string) (*SID, error)`: Parse "S-1-5-21-..." format into SID struct.
- `FormatSID(sid *SID) string`: Format SID struct back to "S-1-5-..." string.

**Well-Known SID Mapping (Claude's discretion):**
```go
var wellKnownPrincipalToSID = map[string]*SID{
    "EVERYONE@": ParseSIDMust("S-1-1-0"),      // Everyone
}
var wellKnownSIDToPrincipal = map[string]string{
    "S-1-1-0":     "EVERYONE@",
    "S-1-3-0":     "OWNER@",      // CREATOR OWNER
    "S-1-3-1":     "GROUP@",      // CREATOR GROUP
}
```

- `PrincipalToSID(who string, fileOwnerUID, fileOwnerGID uint32) *SID`:
  - If who == "OWNER@": construct user SID from fileOwnerUID (S-1-5-21-0-0-0-{UID})
  - If who == "GROUP@": construct group SID from fileOwnerGID (S-1-5-21-0-0-0-{GID})
  - If who == "EVERYONE@": return S-1-1-0
  - Otherwise: construct user SID from principal (hash or use UID if numeric)

- `SIDToPrincipal(sid *SID) string`:
  - Check wellKnownSIDToPrincipal
  - For user SIDs (S-1-5-21-...), extract RID as UID and format as "{uid}@localdomain"
  - Fallback: return SID string representation

**Security Descriptor Building:**
- `BuildSecurityDescriptor(file *metadata.File, additionalSecInfo uint32) ([]byte, error)`:
  - Build self-relative Security Descriptor per MS-DTYP Section 2.4.6:
    1. Header: Revision=1, Sbz1=0, Control=SE_SELF_RELATIVE(0x8000)|SE_DACL_PRESENT(0x0004)
    2. Compute Owner SID from file.UID (S-1-5-21-0-0-0-{UID})
    3. Compute Group SID from file.GID (S-1-5-21-0-0-0-{GID})
    4. Build DACL from file.ACL:
       - ACL header: AclRevision=2, AclSize (computed), AceCount
       - For each ACE in file.ACL.ACEs:
         - Map ACE type: ALLOWED(0)->ACCESS_ALLOWED(0), DENIED(1)->ACCESS_DENIED(1), AUDIT(2)->SYSTEM_AUDIT(2)
         - Map ACE flags: inheritance flags map directly (same bit positions per research)
         - AccessMask: same bit positions per research (no translation needed!)
         - SID: call PrincipalToSID(ace.Who, file.UID, file.GID)
         - Encode: AceType(1), AceFlags(1), AceSize(2), Mask(4), SID(variable)
       - If file.ACL is nil, build minimal DACL granting Everyone full access
    5. Compute offsets: OffsetOwner, OffsetGroup, OffsetSacl=0, OffsetDacl
    6. Write header (20 bytes), then Owner SID, Group SID, DACL
    7. Pad SIDs to 4-byte boundaries
  - additionalSecInfo bitmask controls which sections are included:
    - OWNER_SECURITY_INFORMATION (0x01): include Owner SID
    - GROUP_SECURITY_INFORMATION (0x02): include Group SID
    - DACL_SECURITY_INFORMATION (0x04): include DACL

- `ParseSecurityDescriptor(data []byte) (ownerUID *uint32, ownerGID *uint32, fileACL *acl.ACL, err error)`:
  - Parse self-relative SD header
  - Extract Owner SID -> convert to UID
  - Extract Group SID -> convert to GID
  - Parse DACL -> convert each Windows ACE to NFSv4 ACE using SIDToPrincipal

**query_info.go changes:**
- Update `buildSecurityInfo()` to accept the file metadata and call `BuildSecurityDescriptor`:
  - Change signature to `buildSecurityInfo(file *metadata.File, secInfo uint32) ([]byte, error)`
  - The secInfo parameter comes from the QUERY_INFO request's AdditionalInformation field
  - Replace the existing minimal 20-byte stub with the real implementation
  - Update the call site in HandleQueryInfo to pass the file and secInfo

**set_info.go changes:**
- In the SET_INFO handler for security info type, call `ParseSecurityDescriptor` to extract owner/group/ACL from the client-provided SD
- Create a SetAttrs with the parsed values and call MetadataService.SetFileAttributes
- If only DACL is provided (most common case), set only the ACL field

**Tests (security_test.go):**
- SID encode/decode round-trip for various SIDs (S-1-1-0, S-1-5-21-xxx)
- BuildSecurityDescriptor with real ACL (DENY+ALLOW ACEs)
- BuildSecurityDescriptor with nil ACL (everyone full access)
- ParseSecurityDescriptor round-trip (build then parse, compare)
- PrincipalToSID for OWNER@, GROUP@, EVERYONE@, user@domain
- SIDToPrincipal for well-known SIDs and user SIDs
- 4-byte alignment verification in output
- Security Descriptor with only DACL requested (no owner/group)
  </action>
  <verify>
cd /Users/marmos91/Projects/dittofs && go test -race -v ./internal/protocol/smb/v2/handlers/... -run "Security|SID|Descriptor" 2>&1 | tail -20
go build ./internal/protocol/smb/...
go vet ./internal/protocol/smb/...
  </verify>
  <done>
Security Descriptor encoding produces valid self-relative SD with Owner SID, Group SID, and DACL. NFSv4 ACEs translated to Windows ACEs with SID mapping. QUERY_INFO returns full security info. SET_INFO parses SD and updates file ACL. Well-known SID mapping works. All tests pass with -race.
  </done>
</task>

<task type="auto">
  <name>Task 2: Identity Mapping REST API, dittofsctl Commands, and ACL Metrics</name>
  <files>
    internal/controlplane/api/handlers/identity_mappings.go
    pkg/controlplane/api/server.go
    pkg/apiclient/identity_mappings.go
    cmd/dittofsctl/commands/idmap/idmap.go
    cmd/dittofsctl/commands/idmap/add.go
    cmd/dittofsctl/commands/idmap/list.go
    cmd/dittofsctl/commands/idmap/remove.go
    cmd/dittofsctl/commands/root.go
    pkg/metadata/acl/metrics.go
  </files>
  <action>
**REST API Handlers (internal/controlplane/api/handlers/identity_mappings.go):**
- `HandleListIdentityMappings(w, r)` - GET /api/v1/identity-mappings
  - Calls store.ListIdentityMappings(ctx)
  - Returns JSON array of mappings
  - Requires admin auth
- `HandleCreateIdentityMapping(w, r)` - POST /api/v1/identity-mappings
  - Parse JSON body: {principal, username}
  - Validate: principal non-empty, username non-empty
  - Calls store.CreateIdentityMapping(ctx, mapping)
  - Returns 201 with created mapping
  - Returns 409 on duplicate
  - Requires admin auth
- `HandleDeleteIdentityMapping(w, r)` - DELETE /api/v1/identity-mappings/{principal}
  - Extract principal from URL path
  - Calls store.DeleteIdentityMapping(ctx, principal)
  - Returns 204 on success
  - Returns 404 if not found
  - Requires admin auth

**API Server Routes (pkg/controlplane/api/server.go):**
- Add routes under /api/v1/:
  - GET    /identity-mappings -> HandleListIdentityMappings
  - POST   /identity-mappings -> HandleCreateIdentityMapping
  - DELETE /identity-mappings/{principal} -> HandleDeleteIdentityMapping
- All routes require admin authentication (same middleware as user/group management)

**API Client (pkg/apiclient/identity_mappings.go):**
- `ListIdentityMappings(ctx) ([]*IdentityMappingResponse, error)` - GET request
- `CreateIdentityMapping(ctx, principal, username string) (*IdentityMappingResponse, error)` - POST request
- `DeleteIdentityMapping(ctx, principal string) error` - DELETE request
- `IdentityMappingResponse` struct matching the API response

**dittofsctl Commands:**

`cmd/dittofsctl/commands/idmap/idmap.go`:
- Create "idmap" command group: `dittofsctl idmap [add|list|remove]`
- Short description: "Manage identity mappings (NFSv4 principal to control plane user)"

`cmd/dittofsctl/commands/idmap/add.go`:
- `dittofsctl idmap add --principal alice@EXAMPLE.COM --username alice`
- Calls client.CreateIdentityMapping
- Output: "Identity mapping created: alice@EXAMPLE.COM -> alice"
- Supports -o json/yaml/table output formats

`cmd/dittofsctl/commands/idmap/list.go`:
- `dittofsctl idmap list`
- Calls client.ListIdentityMappings
- Table output: PRINCIPAL | USERNAME | CREATED
- Supports -o json/yaml/table

`cmd/dittofsctl/commands/idmap/remove.go`:
- `dittofsctl idmap remove --principal alice@EXAMPLE.COM`
- Calls client.DeleteIdentityMapping
- Output: "Identity mapping removed: alice@EXAMPLE.COM"
- Supports --force to skip confirmation

`cmd/dittofsctl/commands/root.go`:
- Add idmap command to root command's subcommands

**ACL Metrics (pkg/metadata/acl/metrics.go):**
- `ACLMetrics` struct with Prometheus collectors:
  - `acl_evaluation_duration_seconds` (histogram): Time to evaluate ACL for access decision
  - `acl_evaluation_total` (counter, labels: result=allowed|denied): Total ACL evaluations
  - `acl_evaluation_deny_total` (counter): ACL evaluations that resulted in denial
  - `acl_inheritance_duration_seconds` (histogram): Time to compute inherited ACL
  - `acl_validation_errors_total` (counter): ACL validation failures (bad ordering, too many ACEs)
- `NewACLMetrics(registerer prometheus.Registerer) *ACLMetrics`
- All methods nil-safe (no-op when metrics is nil, matching the pattern from Phase 12 GSSMetrics)
- `ObserveEvaluation(duration time.Duration, allowed bool)`
- `ObserveInheritance(duration time.Duration)`
- `ObserveValidationError()`
- NOTE: Actual metric instrumentation points are in pkg/metadata/authentication.go (evaluateACLPermissions) and pkg/metadata/file.go (createEntry inheritance). These can be instrumented later or as part of this task if the MetadataService has access to an ACLMetrics instance. For now, create the metrics types and registration. Wiring to MetadataService can be done via a SetACLMetrics method.
  </action>
  <verify>
cd /Users/marmos91/Projects/dittofs && go build ./cmd/dittofsctl/...
go build ./internal/controlplane/...
go build ./pkg/apiclient/...
go build ./pkg/metadata/acl/...
go vet ./cmd/dittofsctl/... ./internal/controlplane/... ./pkg/apiclient/... ./pkg/metadata/acl/...
  </verify>
  <done>
SMB Security Descriptor complete. Identity mapping REST API with GET/POST/DELETE endpoints. dittofsctl idmap add/list/remove commands. API client methods for identity mapping operations. ACL Prometheus metrics defined with nil-safe methods. All packages build successfully.
  </done>
</task>

</tasks>

<verification>
- `go build ./...` -- entire project builds
- `go test -race ./internal/protocol/smb/v2/handlers/...` -- SMB handler tests pass
- `go test -race ./pkg/metadata/acl/...` -- ACL package tests pass
- `go vet ./...` -- no issues
- `./dittofsctl idmap --help` shows add/list/remove subcommands
- Security Descriptor encoding produces valid self-relative SD
- ACL metrics registered with Prometheus
</verification>

<success_criteria>
- SMB QUERY_INFO returns real Security Descriptor with Owner/Group/DACL
- SMB SET_INFO parses Security Descriptor and updates file ACL
- Well-known SIDs correctly mapped (EVERYONE@=S-1-1-0)
- Bidirectional ACL translation works (set via NFS, read via SMB)
- dittofsctl idmap add/list/remove commands functional
- REST API for identity mapping CRUD with admin auth
- ACL Prometheus metrics defined and registered
- All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/13-nfsv4-acls/13-05-SUMMARY.md`
</output>
