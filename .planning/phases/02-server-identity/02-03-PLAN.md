---
phase: 02-server-identity
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - test/e2e/helpers/cli.go
  - test/e2e/groups_test.go
autonomous: true

must_haves:
  truths:
    - "Admin can create, list, edit, and delete groups via CLI"
    - "Users can be added to and removed from groups"
    - "Group membership is bidirectional (group lists members, user shows groups)"
    - "System groups (admins, users) cannot be deleted"
    - "Idempotent membership operations succeed silently"
    - "Deleting a user removes them from all groups"
  artifacts:
    - path: "test/e2e/helpers/cli.go"
      provides: "Group CRUD and membership methods on CLIRunner"
      exports: ["CreateGroup", "GetGroup", "ListGroups", "EditGroup", "DeleteGroup", "AddGroupMember", "RemoveGroupMember"]
    - path: "test/e2e/groups_test.go"
      provides: "Group management E2E tests"
      contains: "func TestGroupManagement"
  key_links:
    - from: "test/e2e/groups_test.go"
      to: "test/e2e/helpers/cli.go"
      via: "CLIRunner group methods"
      pattern: "cli\\.(CreateGroup|AddGroupMember|RemoveGroupMember)"
    - from: "test/e2e/helpers/cli.go"
      to: "dittofsctl group"
      via: "exec.Command subprocess"
      pattern: "\"group\"|cmd.*group"
---

<objective>
Create comprehensive E2E tests for group management via the dittofsctl CLI, covering CRUD operations, membership management, and system group protection.

Purpose: Validate that group management works correctly through the CLI interface, including membership operations and proper protection of system groups.

Output:
- Enhanced `test/e2e/helpers/cli.go` with group CRUD and membership methods
- `test/e2e/groups_test.go` with comprehensive group management tests
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-server-identity/02-CONTEXT.md
@.planning/phases/02-server-identity/02-RESEARCH.md
@.planning/phases/02-server-identity/02-01-SUMMARY.md

# CLI commands for reference
@cmd/dittofsctl/commands/group/create.go
@cmd/dittofsctl/commands/group/list.go
@cmd/dittofsctl/commands/group/edit.go
@cmd/dittofsctl/commands/group/delete.go
@cmd/dittofsctl/commands/group/add_user.go
@cmd/dittofsctl/commands/group/remove_user.go

# API client types
@pkg/apiclient/groups.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add group CRUD methods to CLIRunner</name>
  <files>
    test/e2e/helpers/cli.go
  </files>
  <action>
Extend `test/e2e/helpers/cli.go` with group management methods on CLIRunner.

Add Group type struct matching API response:
```go
type Group struct {
    ID          string   `json:"id"`
    Name        string   `json:"name"`
    GID         uint32   `json:"gid"`
    Description string   `json:"description,omitempty"`
    Members     []string `json:"members,omitempty"`
    CreatedAt   string   `json:"created_at"`
    UpdatedAt   string   `json:"updated_at"`
}
```

Add methods to CLIRunner:

**CreateGroup(name string, opts ...GroupOption) (*Group, error)**
- Runs: `dittofsctl group create --name X [opts]`
- GroupOption pattern for optional flags: WithDescription, WithGID
- Parse JSON response into Group struct

**GetGroup(name string) (*Group, error)**
- Runs: `dittofsctl group get <name>` (or equivalent - check CLI)
- Parse JSON response
- Note: Check if this command exists, may need `dittofsctl group list` + filter

**ListGroups() ([]*Group, error)**
- Runs: `dittofsctl group list`
- Parse JSON array response

**EditGroup(name string, opts ...GroupOption) (*Group, error)**
- Runs: `dittofsctl group edit <name> [opts]`
- GroupOption for: WithDescription, WithName (rename)

**DeleteGroup(name string) error**
- Runs: `dittofsctl group delete <name> --yes`
- Return nil on success, error with output on failure

**AddGroupMember(groupName, username string) error**
- Runs: `dittofsctl group add-user <group> <user>`
- Return nil on success

**RemoveGroupMember(groupName, username string) error**
- Runs: `dittofsctl group remove-user <group> <user>`
- Return nil on success

Note: Per CONTEXT.md, idempotent membership operations should succeed silently (add user already in group = success, remove user not in group = success). The CLI may already handle this, but tests should verify.

Refer to cmd/dittofsctl/commands/group/ for exact command structure and flag names.
  </action>
  <verify>
`go build -tags=e2e ./test/e2e/helpers/...` compiles without errors
  </verify>
  <done>
CLIRunner has methods for full group management: CreateGroup, GetGroup, ListGroups, EditGroup, DeleteGroup, AddGroupMember, RemoveGroupMember
  </done>
</task>

<task type="auto">
  <name>Task 2: Create group management tests</name>
  <files>
    test/e2e/groups_test.go
  </files>
  <action>
Create `test/e2e/groups_test.go` with comprehensive group management tests.

**Test structure:**
```go
//go:build e2e

package e2e

func TestGroupManagement(t *testing.T) {
    // Get admin CLI runner
    // Each subtest creates unique groups with UniqueTestName()

    t.Run("create group", func(t *testing.T) { ... })
    t.Run("create group with description", func(t *testing.T) { ... })
    t.Run("list groups", func(t *testing.T) { ... })
    t.Run("edit group", func(t *testing.T) { ... })
    t.Run("delete group", func(t *testing.T) { ... })
    t.Run("duplicate group name rejected", func(t *testing.T) { ... })
    t.Run("add user to group", func(t *testing.T) { ... })
    t.Run("remove user from group", func(t *testing.T) { ... })
    t.Run("bidirectional membership", func(t *testing.T) { ... })
    t.Run("idempotent membership operations", func(t *testing.T) { ... })
    t.Run("multi-group membership", func(t *testing.T) { ... })
    t.Run("system groups cannot be deleted", func(t *testing.T) { ... })
    t.Run("user deletion removes from groups", func(t *testing.T) { ... })
    t.Run("empty group can be deleted", func(t *testing.T) { ... })
}
```

**Subtests to implement:**

1. **create group** - Create group with name only. Verify GID auto-assigned.

2. **create group with description** - Create group with description. Verify description in response.

3. **list groups** - Create 2 groups, list all, verify both appear plus system groups (admins, users).

4. **edit group** - Create group, edit description, verify change persisted.

5. **delete group** - Create group, delete, verify no longer in list.

6. **duplicate group name rejected** - Create group, try create again. Verify error.

7. **add user to group** - Create group, create user, add user to group. Verify user in group members list.

8. **remove user from group** - Create group, create user, add to group, remove from group. Verify user not in members.

9. **bidirectional membership** - Per CONTEXT.md: create group, create user, add user. Verify: group.Members contains user AND user.Groups contains group.

10. **idempotent membership operations** - Add user twice (should succeed both times). Remove user twice (should succeed both times). No errors.

11. **multi-group membership** - Create 2 groups, create user, add user to both. Verify user.Groups has both groups.

12. **system groups cannot be deleted** - Try to delete "admins" and "users" groups. Verify errors, verify groups still exist.

13. **user deletion removes from groups** - Create group, create user, add to group, delete user. Verify user no longer in group members.

14. **empty group can be deleted** - Create group with no members, delete. Verify success.

**Important per CONTEXT.md:**
- Use unique test prefixes: `UniqueTestName("e2e_grp")`
- Register cleanup: `t.Cleanup(func() { _ = cli.DeleteGroup(name) })`
- Most subtests can use `t.Parallel()`
- Tests needing users should create them fresh with cleanup

**Cleanup order matters:**
- Remove user from group before deleting user
- Delete user before deleting group (if user was only member)
- Or just ignore cleanup errors for deleted entities
  </action>
  <verify>
`go test -tags=e2e -v -run TestGroupManagement ./test/e2e/` runs and passes (requires running server)
  </verify>
  <done>
Group tests verify: create, list, edit, delete, duplicate rejection, membership add/remove, bidirectional membership, idempotency, multi-group, system group protection, user deletion cascade, empty group deletion
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Helpers compile:
   ```bash
   go build -tags=e2e ./test/e2e/helpers/...
   ```

2. Group tests run (requires running dittofs server):
   ```bash
   # In terminal 1: start server
   ./dittofs start -f

   # In terminal 2: run tests
   go test -tags=e2e -v -run TestGroupManagement ./test/e2e/
   ```

3. All tests pass including edge cases
</verification>

<success_criteria>
- [ ] CLIRunner has CreateGroup, GetGroup, ListGroups, EditGroup, DeleteGroup methods
- [ ] CLIRunner has AddGroupMember, RemoveGroupMember methods
- [ ] Group struct matches API response format
- [ ] Create group test verifies fields and GID assignment
- [ ] List groups shows created groups plus system groups
- [ ] Edit group test verifies description changes persist
- [ ] Delete group test verifies removal from list
- [ ] Add/remove user from group works correctly
- [ ] Bidirectional membership verified (group.Members and user.Groups)
- [ ] Idempotent membership operations succeed without error
- [ ] System groups (admins, users) cannot be deleted
- [ ] Deleting user removes them from groups
- [ ] All tests use unique names and cleanup properly
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-identity/02-03-SUMMARY.md`
</output>
