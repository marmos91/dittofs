---
phase: 02-server-identity
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - test/e2e/helpers/cli.go
  - test/e2e/users_test.go
autonomous: true

must_haves:
  truths:
    - "Admin can create a new user with all fields via CLI"
    - "Admin can list all users via CLI"
    - "Admin can get, edit, and delete users via CLI"
    - "User can change their own password via CLI"
    - "Admin user cannot be deleted"
    - "Duplicate usernames are rejected with clear error"
    - "Password change invalidates existing tokens"
  artifacts:
    - path: "test/e2e/helpers/cli.go"
      provides: "User CRUD methods on CLIRunner"
      exports: ["CreateUser", "GetUser", "ListUsers", "EditUser", "DeleteUser", "ChangePassword"]
    - path: "test/e2e/users_test.go"
      provides: "User management E2E tests"
      contains: "func TestUserCRUD"
  key_links:
    - from: "test/e2e/users_test.go"
      to: "test/e2e/helpers/cli.go"
      via: "CLIRunner methods"
      pattern: "cli\\.(CreateUser|GetUser|DeleteUser)"
    - from: "test/e2e/helpers/cli.go"
      to: "dittofsctl user"
      via: "exec.Command subprocess"
      pattern: "\"user\"|cmd.*user"
---

<objective>
Create comprehensive E2E tests for user management via the dittofsctl CLI, covering full CRUD operations, password management, and error scenarios.

Purpose: Validate that user management works correctly through the CLI interface, including all fields, password operations, and proper error handling for edge cases.

Output:
- Enhanced `test/e2e/helpers/cli.go` with user CRUD methods
- `test/e2e/users_test.go` with comprehensive user management tests
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-server-identity/02-CONTEXT.md
@.planning/phases/02-server-identity/02-RESEARCH.md
@.planning/phases/02-server-identity/02-01-SUMMARY.md

# CLI commands for reference
@cmd/dittofsctl/commands/user/create.go
@cmd/dittofsctl/commands/user/list.go
@cmd/dittofsctl/commands/user/get.go
@cmd/dittofsctl/commands/user/edit.go
@cmd/dittofsctl/commands/user/delete.go
@cmd/dittofsctl/commands/user/change_password.go
@cmd/dittofsctl/commands/user/password.go

# API client types
@pkg/apiclient/users.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add user CRUD methods to CLIRunner</name>
  <files>
    test/e2e/helpers/cli.go
  </files>
  <action>
Extend `test/e2e/helpers/cli.go` with user management methods on CLIRunner.

Add User type struct matching API response:
```go
type User struct {
    ID        string   `json:"id"`
    Username  string   `json:"username"`
    Email     string   `json:"email,omitempty"`
    Role      string   `json:"role"`
    UID       uint32   `json:"uid"`
    Groups    []string `json:"groups,omitempty"`
    Enabled   bool     `json:"enabled"`
    CreatedAt string   `json:"created_at"`
    UpdatedAt string   `json:"updated_at"`
}
```

Add methods to CLIRunner:

**CreateUser(username, password string, opts ...UserOption) (*User, error)**
- Runs: `dittofsctl user create --username X --password Y [opts]`
- UserOption pattern for optional flags: WithEmail, WithRole, WithUID, WithGroups, WithEnabled
- Parse JSON response into User struct
- Return error with CLI output on failure

**GetUser(username string) (*User, error)**
- Runs: `dittofsctl user get <username>`
- Parse JSON response

**ListUsers() ([]*User, error)**
- Runs: `dittofsctl user list`
- Parse JSON array response

**EditUser(username string, opts ...UserOption) (*User, error)**
- Runs: `dittofsctl user edit <username> [opts]`
- UserOption for: WithEmail, WithRole, WithEnabled

**DeleteUser(username string) error**
- Runs: `dittofsctl user delete <username> --yes` (non-interactive)
- Return nil on success, error with output on failure

**ChangeOwnPassword(oldPassword, newPassword string) (*TokenResponse, error)**
- Runs: `dittofsctl user change-password --old-password X --new-password Y`
- May return new tokens - check API response structure

**ResetPassword(username, newPassword string) error**
- Runs: `dittofsctl user password <username> --password X` (admin resets user password)

**Login(serverURL, username, password string) (string, error)**
- Runs: `dittofsctl login --server X --username Y --password Z`
- Returns token from response or credential file

Note: Refer to existing CLI commands in cmd/dittofsctl/commands/user/ for exact flag names and behavior. Use `--output json` consistently.
  </action>
  <verify>
`go build -tags=e2e ./test/e2e/helpers/...` compiles without errors
  </verify>
  <done>
CLIRunner has methods for full user CRUD: CreateUser, GetUser, ListUsers, EditUser, DeleteUser, ChangeOwnPassword, ResetPassword, Login
  </done>
</task>

<task type="auto">
  <name>Task 2: Create user management tests</name>
  <files>
    test/e2e/users_test.go
  </files>
  <action>
Create `test/e2e/users_test.go` with comprehensive user CRUD tests.

**Test structure:**
```go
//go:build e2e

package e2e

func TestUserCRUD(t *testing.T) {
    // Get shared server and admin CLI runner
    // Each subtest creates unique users with UniqueTestName()
    // Parallel subtests where safe

    t.Run("create user with all fields", func(t *testing.T) { ... })
    t.Run("create user minimal", func(t *testing.T) { ... })
    t.Run("list users", func(t *testing.T) { ... })
    t.Run("get user", func(t *testing.T) { ... })
    t.Run("edit user", func(t *testing.T) { ... })
    t.Run("delete user", func(t *testing.T) { ... })
    t.Run("duplicate username rejected", func(t *testing.T) { ... })
    t.Run("admin cannot be deleted", func(t *testing.T) { ... })
    t.Run("password change invalidates token", func(t *testing.T) { ... })
    t.Run("self-service password change", func(t *testing.T) { ... })
    t.Run("admin reset user password", func(t *testing.T) { ... })
}
```

**Subtests to implement:**

1. **create user with all fields** - Create user with username, password, email, role, groups. Verify all fields in response. Use `t.Parallel()`, cleanup via `t.Cleanup()`.

2. **create user minimal** - Create user with only required fields (username, password). Verify defaults applied (role=user, enabled=true).

3. **list users** - Create 2 users, list all, verify both appear in list plus admin.

4. **get user** - Create user, get by username, verify all fields match.

5. **edit user** - Create user, edit email and role, verify changes persisted.

6. **delete user** - Create user, delete, verify get returns not found.

7. **duplicate username rejected** - Create user, try create again with same username. Verify error contains "already exists" or similar.

8. **admin cannot be deleted** - Try to delete "admin" user. Verify error, verify admin still exists.

9. **password change invalidates token** - Create user, login as user, change password, verify old CLI runner fails with auth error, re-login works with new password.

10. **self-service password change** - Create user, login, user changes own password via change-password command, verify can login with new password.

11. **admin reset user password** - Create user, admin resets password via `user password` command, verify user can login with new password.

**Important per CONTEXT.md:**
- Use unique test prefixes: `UniqueTestName("e2e_user")`
- Register cleanup with `t.Cleanup(func() { _ = cli.DeleteUser(username) })`
- Most subtests can use `t.Parallel()` since they create unique users
- Verify admin user intact after test suite (implicit via admin cannot be deleted test)

**Test isolation:**
- Tests that modify shared state (like admin tests) should NOT be parallel
- Tests creating independent users CAN be parallel
  </action>
  <verify>
`go test -tags=e2e -v -run TestUserCRUD ./test/e2e/` runs and passes (requires running server)
  </verify>
  <done>
User tests verify: create (full/minimal), list, get, edit, delete, duplicate rejection, admin protection, password change token invalidation, self-service password change, admin password reset
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Helpers compile:
   ```bash
   go build -tags=e2e ./test/e2e/helpers/...
   ```

2. User tests run (requires running dittofs server):
   ```bash
   # In terminal 1: start server
   ./dittofs start -f

   # In terminal 2: run tests
   go test -tags=e2e -v -run TestUserCRUD ./test/e2e/
   ```

3. All tests pass including error scenarios
</verification>

<success_criteria>
- [ ] CLIRunner has CreateUser, GetUser, ListUsers, EditUser, DeleteUser methods
- [ ] CLIRunner has ChangeOwnPassword, ResetPassword, Login methods
- [ ] User struct matches API response format
- [ ] Create user test verifies all fields stored correctly
- [ ] List users test verifies multiple users appear
- [ ] Edit user test verifies changes persist
- [ ] Delete user test verifies user no longer accessible
- [ ] Duplicate username returns clear error
- [ ] Admin user deletion is rejected
- [ ] Password change invalidates old token
- [ ] All tests use unique names and cleanup properly
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-identity/02-02-SUMMARY.md`
</output>
