---
phase: 15-v2-0-testing
plan: 03
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - test/e2e/nfsv4_acl_test.go
  - test/e2e/nfsv4_kerberos_test.go
autonomous: true
requirements:
  - TEST2-04
  - TEST2-05

must_haves:
  truths:
    - "NFSv4 ACLs set via nfs4_setfacl are readable via nfs4_getfacl"
    - "ACL enforcement blocks access for denied users on NFSv4 mount"
    - "ACL inheritance applies to newly created files in ACL-protected directory"
    - "Cross-protocol ACL interop: ACL set via NFSv4 visible as Security Descriptor via SMB (skipped if SMB mount unavailable -- test logs skip reason)"
    - "Kerberos krb5/krb5i/krb5p all work with explicit vers=4.0 mounts (not vers=4)"
    - "Unauthorized Kerberos user gets EACCES/EPERM on NFSv4 mount"
  artifacts:
    - path: "test/e2e/nfsv4_acl_test.go"
      provides: "NFSv4 ACL E2E tests"
      contains: "TestNFSv4ACL"
    - path: "test/e2e/nfsv4_kerberos_test.go"
      provides: "NFSv4 Kerberos extended E2E tests"
      contains: "TestNFSv4KerberosExtended"
  key_links:
    - from: "test/e2e/nfsv4_acl_test.go"
      to: "test/e2e/framework/mount.go"
      via: "MountNFSWithVersion"
      pattern: "framework\\.MountNFSWithVersion"
    - from: "test/e2e/nfsv4_kerberos_test.go"
      to: "test/e2e/framework/kerberos.go"
      via: "KDCHelper for Kerberos test infrastructure"
      pattern: "framework\\.NewKDCHelper"
---

<objective>
Implement E2E tests for NFSv4 ACL lifecycle (set/read/enforce/inherit) and extended Kerberos v4 authentication scenarios.

Purpose: Validates that NFSv4 ACLs work end-to-end through real NFS mounts (set ACL, read back, verify enforcement, test inheritance) and that Kerberos authentication works with all three security flavors on explicit NFSv4.0 mounts including authorization denial scenarios.

Output: nfsv4_acl_test.go with ACL lifecycle and cross-protocol tests, nfsv4_kerberos_test.go with extended Kerberos v4 tests using vers=4.0 explicitly.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-v2-0-testing/15-CONTEXT.md
@.planning/phases/15-v2-0-testing/15-RESEARCH.md
@.planning/phases/15-v2-0-testing/15-01-SUMMARY.md
@test/e2e/framework/mount.go
@test/e2e/framework/kerberos.go
@test/e2e/kerberos_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: NFSv4 ACL E2E tests</name>
  <files>test/e2e/nfsv4_acl_test.go</files>
  <action>
Create test/e2e/nfsv4_acl_test.go with `//go:build e2e` tag, package `e2e`.

ACL tests are NFSv4 ONLY (NFSv3 has no ACL wire format). Use `framework.SkipIfDarwin(t)` and `framework.SkipIfNoNFS4ACLTools(t)` at top. Use memory/memory stores.

ACL operations via NFS mount use `nfs4_setfacl` and `nfs4_getfacl` CLI tools (from nfs4-acl-tools package). These tools communicate via the NFSv4 SETATTR/GETATTR FATTR4_ACL attribute.

Implement:

1. `TestNFSv4ACLLifecycle(t *testing.T)` -- full ACL lifecycle:
   - Start server, create share, enable NFS, mount v4
   - Create a test file
   - Set ACL: `nfs4_setfacl -s "A::OWNER@:rwatTnNcCoy A::EVERYONE@:rtncy" <file>`
   - Read ACL back: `nfs4_getfacl <file>` -- parse output, verify ACEs match
   - Verify OWNER@ can read/write (current user)
   - Create another user context (different UID) -- verify EVERYONE@ has read access
   - Set deny ACE: `nfs4_setfacl -a "D::EVERYONE@:w" <file>` -- verify write blocked for non-owner

2. `TestNFSv4ACLInheritance(t *testing.T)`:
   - Mount v4, create directory
   - Set ACL on directory with FILE_INHERIT and DIRECTORY_INHERIT flags:
     `nfs4_setfacl -s "A:fd:OWNER@:rwaDxtTnNcCoy A:fd:EVERYONE@:rxtncy" <dir>`
   - Create file inside directory
   - Read ACL on new file -- verify inherited ACEs are present
   - Create subdirectory -- verify ACL inherited with DIRECTORY_INHERIT

3. `TestNFSv4ACLAccessEnforcement(t *testing.T)`:
   - Mount v4, create file as root, write content
   - Set restrictive ACL: only OWNER@ can read/write
   - Drop privileges (if possible) or verify via stat/access that permissions are restricted
   - Verify chmod interop: chmod 0644 on ACL-protected file adjusts OWNER@/GROUP@/EVERYONE@ ACEs

4. `TestNFSv4ACLCrossProtocol(t *testing.T)`:
   - Skip if no SMB mount available: `framework.SkipIfNoSMBMount(t)` -- log skip reason: "Cross-protocol ACL interop test skipped: SMB mount not available"
   - Start server, create share, enable NFS and SMB adapters
   - Mount share via NFSv4
   - Set ACL on file via nfs4_setfacl
   - Mount same share via SMB
   - Read Security Descriptor via SMB (stat or getfattr) -- verify DACL contains corresponding ACEs
   - This validates the NFSv4 ACE -> SMB Security Descriptor translation
   - NOTE: This test will almost always be skipped in CI unless SMB mount is available. The test exists for manual validation and future CI capability.

For running nfs4_setfacl/nfs4_getfacl: use exec.Command, check error codes, parse stdout. Create helper functions:
- `nfs4SetACL(t, path, aclSpec string)` -- runs nfs4_setfacl -s
- `nfs4AddACE(t, path, aceSpec string)` -- runs nfs4_setfacl -a
- `nfs4GetACL(t, path string) []string` -- runs nfs4_getfacl, returns ACE lines
  </action>
  <verify>
`go build -tags=e2e ./test/e2e/...` compiles.
`go vet -tags=e2e ./test/e2e/...` passes.
  </verify>
  <done>
nfsv4_acl_test.go contains 4 test functions covering ACL lifecycle (set/read), inheritance (file_inherit/dir_inherit), access enforcement, and cross-protocol interop (with explicit skip and reason when SMB unavailable). Helper functions nfs4SetACL, nfs4AddACE, nfs4GetACL encapsulate CLI tool calls. All compile with -tags=e2e. Tests skip gracefully when nfs4-acl-tools or SMB mount are unavailable.
  </done>
</task>

<task type="auto">
  <name>Task 2: NFSv4 Kerberos extended E2E tests with explicit vers=4.0</name>
  <files>test/e2e/nfsv4_kerberos_test.go</files>
  <action>
Create test/e2e/nfsv4_kerberos_test.go with `//go:build e2e` tag, package `e2e`.

CRITICAL -- vers=4.0 requirement (locked decision #3, #5):
The existing kerberos_test.go uses `vers=4` (line 230) which is ambiguous (could negotiate v4.0 or v4.1+). Per locked decisions, all NFSv4 mounts in this phase MUST use `vers=4.0` explicitly. This new test file is the PRIMARY coverage for Kerberos with vers=4.0, since the existing kerberos_test.go uses `vers=4`.

The `MultiFlavorV4` subtest below is the authoritative test that all three Kerberos flavors (krb5, krb5i, krb5p) work with `vers=4.0` specifically. This satisfies locked decision #5.

Use `framework.SkipIfDarwin(t)` (Kerberos NFS requires Linux with rpc.gssd). Use memory/memory stores.

Implement:

1. `TestNFSv4KerberosExtended(t *testing.T)` -- Linux only:
   - Check Kerberos prereqs (kinit, mount.nfs in PATH)
   - Start KDC container using framework.NewKDCHelper
   - Add principals: alice (mapped to uid 1001), bob (mapped to uid 1002), unauthorized_user (not in identity mapping)
   - Start server with Kerberos config (reuse createKerberosConfig pattern from kerberos_test.go)
   - Create two shares: /krb-v4 (Kerberos-protected) and /auth-sys-v4 (allows AUTH_SYS)

   Subtests:
   a. `AuthorizationDenial`: kinit as unauthorized_user, mount /krb-v4 with sec=krb5 vers=4.0 -- mount should succeed (Kerberos auth passes) but file operations should fail with EACCES/EPERM since user maps to nobody (uid 65534) and share has restrictive permissions. Or alternatively, the mount itself may fail if the server rejects the principal. Test the observable behavior.

   b. `FileOwnershipMapping`: kinit as alice, mount with sec=krb5 vers=4.0, create file, stat file -- verify uid=1001 (alice's mapped uid from identity mapping config).

   c. `MultiFlavorV4`: Test all three flavors with vers=4.0 explicitly (this is the PRIMARY test for locked decision #5):
     - sec=krb5 with vers=4.0: create file, read back -- verify basic auth works
     - sec=krb5i with vers=4.0: create file, read back -- verify integrity protection works
     - sec=krb5p with vers=4.0: create file, read back -- verify privacy protection works
     - IMPORTANT: Mount option string MUST contain `vers=4.0` (NOT `vers=4`). Verify in the mount command construction.

   d. `KerberosWithAuthSysFallback`: Mount /auth-sys-v4 with sec=sys vers=4.0 -- should work since share allows AUTH_SYS. Create file, verify accessible.

   e. `ConcurrentKerberosV4Users`: Two users (alice, bob) mount same share with vers=4.0, each writes a file, verify cross-visibility.

Reuse patterns from kerberos_test.go: kinitWithCC for separate credential caches, installSystemKeytab for rpc.gssd, checkKerberosPrereqs for tool availability.
  </action>
  <verify>
`go build -tags=e2e ./test/e2e/...` compiles.
`go vet -tags=e2e ./test/e2e/...` passes.
Grep for `vers=4.0` in the new file -- must appear (not `vers=4` without `.0`).
  </verify>
  <done>
nfsv4_kerberos_test.go contains TestNFSv4KerberosExtended with 5 subtests: authorization denial, file ownership mapping, multi-flavor v4 (krb5/krb5i/krb5p all with explicit vers=4.0), AUTH_SYS fallback, and concurrent users. MultiFlavorV4 is the primary test for locked decision #5. All mounts use vers=4.0 explicitly (never vers=4). Tests use existing KDC testcontainer infrastructure. All compile with -tags=e2e. Tests skip on macOS and when Kerberos prereqs are missing.
  </done>
</task>

</tasks>

<verification>
- `go build -tags=e2e ./test/e2e/...` compiles successfully
- `go vet -tags=e2e ./test/e2e/...` passes
- ACL tests use nfs4_setfacl/nfs4_getfacl CLI tools with graceful skip
- Cross-protocol ACL test has explicit skip reason when SMB unavailable
- Kerberos v4 tests use `vers=4.0` explicitly in all mount options (grep confirms)
- Kerberos v4 tests cover authorization denial, identity mapping, all three flavors with vers=4.0, AUTH_SYS fallback, concurrent users
</verification>

<success_criteria>
- NFSv4 ACL lifecycle (set, read, enforce, inherit) validated through real NFS mount
- Cross-protocol ACL interop (NFSv4 -> SMB) tested with clear skip reason when unavailable
- Kerberos authentication with all three security flavors verified on explicit NFSv4.0 mounts (vers=4.0, not vers=4)
- Authorization denial for unmapped/unauthorized users verified
</success_criteria>

<output>
After completion, create `.planning/phases/15-v2-0-testing/15-03-SUMMARY.md`
</output>
