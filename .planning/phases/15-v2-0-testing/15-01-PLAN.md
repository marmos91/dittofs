---
phase: 15-v2-0-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - test/e2e/framework/mount.go
  - test/e2e/framework/helpers.go
  - test/e2e/nfsv4_basic_test.go
autonomous: true
requirements:
  - TEST2-01
  - TEST2-06

must_haves:
  truths:
    - "NFSv4.0 mount succeeds with vers=4.0 option on Linux"
    - "Files created via NFSv4 mount can be read back with correct content"
    - "Directories, symlinks, hard links work via NFSv4 mount"
    - "SETATTR operations (chmod, chown, truncate, touch) work via NFSv4"
    - "RENAME (within dir, across dirs, overwrite) works via NFSv4"
    - "READDIR with ~100 files verifies pagination via NFSv4"
    - "Pseudo-filesystem browsing shows share junctions via NFSv4 root"
    - "Existing NFSv3 tests still compile and run (backward compat)"
    - "Golden path smoke test passes: server start, create user, create share, mount v4, write/read file, unmount"
    - "Full v1.0 E2E test suite compiles with -tags=e2e and no existing test file signatures are broken"
  artifacts:
    - path: "test/e2e/framework/mount.go"
      provides: "MountNFSWithVersion helper for v3/v4 parameterized mounts"
      contains: "MountNFSWithVersion"
    - path: "test/e2e/framework/helpers.go"
      provides: "SkipIfDarwin, SkipIfNoNFS4ACLTools helpers"
      contains: "SkipIfDarwin"
    - path: "test/e2e/nfsv4_basic_test.go"
      provides: "NFSv4 basic operations E2E tests"
      contains: "TestNFSv4BasicOperations"
  key_links:
    - from: "test/e2e/nfsv4_basic_test.go"
      to: "test/e2e/framework/mount.go"
      via: "MountNFSWithVersion call"
      pattern: "framework\\.MountNFSWithVersion"
---

<objective>
Extend the E2E test framework with NFSv4.0 mount support and implement comprehensive basic NFSv4 operation tests.

Purpose: All subsequent plans depend on the NFSv4 mount helper. This plan also validates the foundational NFSv4 operations (mount, file I/O, directory ops, metadata ops, pseudo-fs) and confirms NFSv3 backward compatibility.

Output: MountNFSWithVersion helper, platform skip helpers, and nfsv4_basic_test.go with ~20 subtests covering all basic operations.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-v2-0-testing/15-CONTEXT.md
@.planning/phases/15-v2-0-testing/15-RESEARCH.md
@test/e2e/framework/mount.go
@test/e2e/framework/helpers.go
@test/e2e/main_test.go
@test/e2e/store_matrix_test.go
@test/e2e/helpers/server.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: NFSv4 mount helper and platform skip utilities</name>
  <files>test/e2e/framework/mount.go, test/e2e/framework/helpers.go</files>
  <action>
Add to test/e2e/framework/mount.go:

1. `MountNFSWithVersion(t *testing.T, port int, version string) *Mount` -- version is "3" or "4.0":
   - For version "3": same as existing MountNFS (nfsvers=3,tcp,port=PORT,mountport=PORT,actimeo=0,nolock on Linux; add resvport on macOS)
   - For version "4.0": use `vers=4.0,port=PORT,actimeo=0` (NO mountport, NO nolock -- NFSv4 is stateful). On macOS, skip NFSv4 features gracefully.
   - Both: create temp dir with pattern `dittofs-e2e-nfs-*`, retry up to 3 times with 1s sleep, 30s mount timeout.
   - Set `Mount.Version` field (add new string field to Mount struct).
   - Return *Mount or t.Fatal on failure.

2. `MountNFSExportWithVersion(t *testing.T, port int, exportPath string, version string) *Mount` -- same as above but with custom export path (for multi-share tests). Reuse `mountNFSExport` pattern from store_matrix_test.go but version-aware.

3. Update `CleanupStaleMounts()` to also clean `dittofs-e2e-nfsv4-*` patterns.

Add to test/e2e/framework/helpers.go:

4. `SkipIfDarwin(t *testing.T)` -- skips test on macOS with message "NFSv4 feature tests require Linux"
5. `SkipIfNoNFS4ACLTools(t *testing.T)` -- checks for `nfs4_setfacl` and `nfs4_getfacl` in PATH, skips if not found
6. `SkipIfNFSv4Unsupported(t *testing.T)` -- on macOS, skips if NFSv4 mount is not reliable (Darwin NFSv4 has known issues)

IMPORTANT: Do NOT break existing `MountNFS()` function -- it must continue working for all existing v1.0 tests (backward compat requirement TEST2-06). MountNFSWithVersion with version="3" should produce identical behavior to MountNFS.
  </action>
  <verify>
`go vet ./test/e2e/framework/...` passes.
`go build -tags=e2e ./test/e2e/...` compiles without errors.
Existing tests that use `MountNFS` still compile.
  </verify>
  <done>
MountNFSWithVersion helper exists, supports both v3 and v4.0. Mount struct has Version field. SkipIfDarwin, SkipIfNoNFS4ACLTools, SkipIfNFSv4Unsupported helpers exist. Existing MountNFS unchanged and all existing E2E test files still compile.
  </done>
</task>

<task type="auto">
  <name>Task 2: NFSv4 basic operations E2E tests and v1.0 backward compat validation</name>
  <files>test/e2e/nfsv4_basic_test.go</files>
  <action>
Create test/e2e/nfsv4_basic_test.go with `//go:build e2e` tag, package `e2e`.

Pattern: Each top-level test starts its own server process (per-test isolation, existing pattern). Use table-driven subtests with NFS version as parameter where applicable.

Implement these test functions:

1. `TestNFSv4BasicOperations(t *testing.T)` -- main test that starts one server and runs subtests for both v3 and v4:
   - Start server, create memory/memory stores, create /export share, enable NFS adapter
   - For each version in ["3", "4.0"]:
     - `CreateReadWriteFile`: write file, read back, verify content match
     - `Overwrite`: overwrite file, verify new content
     - `CreateDirectory`: mkdir, verify exists, create files inside
     - `DeleteFile`: create then delete, verify gone
     - `DeleteDirectory`: rmdir on empty dir
     - `ListDirectory`: create 3 files + 1 subdir, verify listing
     - `LargeFile1MB`: 1MB random file with checksum verification

2. `TestNFSv4AdvancedFileOps(t *testing.T)` -- starts own server, subtests for v3 and v4:
   - `Symlink`: create symlink, readlink, follow symlink to read content
   - `HardLink`: create hard link, verify link count=2, delete original, verify data survives
   - `Chmod`: create file, chmod 0755, verify mode changed
   - `Chown`: create file, chown (may need root or skip), verify uid/gid changed
   - `Truncate`: write 1KB, truncate to 512 bytes, verify size
   - `Touch`: create file, sleep 1s, touch, verify mtime changed
   - `RenameWithinDir`: create file, rename within same dir, verify old gone and new exists
   - `RenameAcrossDir`: create file in dir1, rename to dir2, verify moved
   - `RenameOverwrite`: create two files, rename src over dst, verify only one file remains with src content

3. `TestNFSv4OpenCreateModes(t *testing.T)` -- NFSv4 only (v4 subtests):
   - `Unchecked`: O_CREAT on existing file succeeds (overwrites)
   - `Guarded`: O_CREAT|O_EXCL on existing file fails with EEXIST
   - `CreateNew`: O_CREAT|O_EXCL on new file succeeds

4. `TestNFSv4PseudoFSBrowsing(t *testing.T)` -- NFSv4 only:
   - Mount NFSv4 root (just "/"), list contents, verify share junction appears
   - Create second share /archive, verify both /export and /archive appear in pseudo-fs

5. `TestNFSv4READDIRPagination(t *testing.T)` -- v3 and v4:
   - Create ~100 files in a directory, list directory, verify all 100 entries returned

6. `TestNFSv4GoldenPathSmoke(t *testing.T)` -- full golden path:
   - Start server, create user via API, create share, mount v4, write file, read file, unmount
   - This is the dedicated golden path test per locked decision #12

7. `TestNFSv4StaleHandle(t *testing.T)`:
   - Start server with memory backend, mount v4, create file, get fd
   - Stop server, start new server (new state), try to access fd -- expect ESTALE or EIO

8. `TestBackwardCompatNFSv3Full(t *testing.T)`:
   - IMPORTANT: This test validates locked decision #9 (re-run full v1.0 E2E suite for backward compat)
   - Start server, mount v3 using existing MountNFS(), run the same basic file ops as TestNFSv4BasicOperations but v3-only
   - Confirms existing v1.0 test pattern still works (regression guard)
   - Additionally verify: `go build -tags=e2e ./test/e2e/...` must succeed without errors to confirm no existing test file signatures changed. This is validated at the verify step below.

Use `framework.SkipIfDarwin(t)` for NFSv4-specific tests. Use `framework.SkipIfNFSv4Unsupported(t)` at top of v4 subtests.
  </action>
  <verify>
`go build -tags=e2e ./test/e2e/...` compiles without errors -- this confirms ALL existing v1.0 test files still compile alongside the new tests (backward compat requirement TEST2-06).
`go vet -tags=e2e ./test/e2e/...` passes.
Test names follow convention: `TestNFSv4*` and `TestBackwardCompatNFSv3Full`.
Grep for `MountNFS(` in existing test files (store_matrix_test.go, cross_protocol_lock_test.go, grace_period_test.go, kerberos_test.go) -- confirm no signature changes.
  </verify>
  <done>
nfsv4_basic_test.go contains 8 test functions covering: basic file I/O (v3+v4), advanced file ops (symlink, hardlink, SETATTR, RENAME), OPEN create modes (v4), pseudo-fs browsing (v4), READDIR pagination (v3+v4), golden path smoke (v4), stale handle (v4), and backward compat (v3). Full v1.0 E2E suite compiles without changes. All compile with -tags=e2e.
  </done>
</task>

</tasks>

<verification>
- `go build -tags=e2e ./test/e2e/...` compiles successfully (validates both new tests AND all existing v1.0 tests)
- `go vet -tags=e2e ./test/e2e/...` passes
- All existing E2E test files still compile (no broken imports/signatures)
- Mount struct has Version field
- MountNFSWithVersion exists with v3 and v4.0 support
- SkipIfDarwin, SkipIfNoNFS4ACLTools, SkipIfNFSv4Unsupported helpers exist
- nfsv4_basic_test.go has 8+ test functions
- Golden path smoke test is a dedicated test function
</verification>

<success_criteria>
- Framework mount helper supports both NFSv3 and NFSv4.0 mounts with version parameter
- Basic NFSv4 operation tests cover mount/read/write/create/delete/symlink/hardlink/SETATTR/RENAME/OPEN modes/pseudo-fs/READDIR pagination/golden path/stale handle
- Full v1.0 E2E test suite compiles without any changes (backward compat verified structurally)
- TestBackwardCompatNFSv3Full explicitly exercises v3 path as regression guard
- Tests are parameterized by NFS version where applicable
</success_criteria>

<output>
After completion, create `.planning/phases/15-v2-0-testing/15-01-SUMMARY.md`
</output>
