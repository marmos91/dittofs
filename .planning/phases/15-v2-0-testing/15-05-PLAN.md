---
phase: 15-v2-0-testing
plan: 05
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - test/posix/setup-posix.sh
  - test/posix/run-posix.sh
  - test/posix/known_failures_v4.txt
  - test/posix/README.md
  - test/e2e/nfsv4_controlplane_test.go
  - test/e2e/nfsv4_stress_test.go
  - test/e2e/run-e2e.sh
autonomous: true
requirements:
  - TEST2-01
  - TEST2-05
  - TEST2-06

must_haves:
  truths:
    - "pjdfstest runs against NFSv4 mount with --nfs-version parameter"
    - "known_failures_v4.txt documents NFSv4-specific pjdfstest failures"
    - "Control plane v2.0 changes (blocked ops, netgroup) observable via NFS mount"
    - "Stress tests with 100+ files and delegations gated behind -tags=stress"
    - "run-e2e.sh supports --coverage flag that passes -coverprofile to go test"
  artifacts:
    - path: "test/posix/setup-posix.sh"
      provides: "NFSv4 mount support for POSIX tests"
      contains: "nfs-version"
    - path: "test/posix/known_failures_v4.txt"
      provides: "NFSv4-specific pjdfstest known failures"
      min_lines: 5
    - path: "test/e2e/nfsv4_controlplane_test.go"
      provides: "Control plane v2.0 mount-level E2E tests"
      contains: "TestNFSv4ControlPlane"
    - path: "test/e2e/nfsv4_stress_test.go"
      provides: "Stress tests gated behind build tag"
      contains: "go:build stress"
    - path: "test/e2e/run-e2e.sh"
      provides: "E2E test runner script with --coverage support"
      contains: "coverprofile"
  key_links:
    - from: "test/posix/setup-posix.sh"
      to: "test/posix/run-posix.sh"
      via: "mount setup for pjdfstest execution"
      pattern: "nfs-version"
    - from: "test/e2e/nfsv4_controlplane_test.go"
      to: "test/e2e/helpers/controlplane.go"
      via: "API client for settings manipulation"
      pattern: "helpers\\.(GetNFSSettings|PatchNFSSetting)"
---

<objective>
Implement POSIX compliance testing for NFSv4 (issue #122), control plane v2.0 mount-level E2E tests, stress tests with build tag gating, and E2E coverage profile support.

Purpose: Extends pjdfstest POSIX compliance suite to NFSv4, validates that control plane v2.0 settings changes (blocked operations, netgroup access) are observable through real NFS mounts, provides gated stress tests for CI flexibility, and adds -coverprofile support to the E2E test runner.

Output: Updated POSIX test scripts with NFSv4 support, known_failures_v4.txt, control plane mount-level tests, stress test file, run-e2e.sh with --coverage flag.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-v2-0-testing/15-CONTEXT.md
@.planning/phases/15-v2-0-testing/15-RESEARCH.md
@.planning/phases/15-v2-0-testing/15-01-SUMMARY.md
@test/posix/setup-posix.sh
@test/posix/run-posix.sh
@test/posix/known_failures.txt
@test/posix/README.md
@test/e2e/controlplane_v2_test.go
@test/e2e/helpers/controlplane.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: pjdfstest NFSv4 support (issue #122)</name>
  <files>test/posix/setup-posix.sh, test/posix/run-posix.sh, test/posix/known_failures_v4.txt, test/posix/README.md</files>
  <action>
Per issue #122 and CONTEXT.md decisions, extend POSIX compliance tests to support NFSv4.

1. Update test/posix/setup-posix.sh:
   - Add `--nfs-version` parameter (default: "3" for backward compat)
   - Accept values: "3", "4", "4.0"
   - When version is "3": use existing mount options (nfsvers=3,tcp,port=PORT,mountport=PORT,nolock,noac,sync,lookupcache=none)
   - When version is "4" or "4.0": use `vers=4.0,port=PORT,noac,sync,lookupcache=none` (NO mountport, NO nolock)
   - Update usage help text to document --nfs-version parameter
   - Update variable: `NFS_VERSION="${2:-3}"` (second positional arg after config-type, or use getopt for named params)
   - Actually use getopts or manual parsing: `./setup-posix.sh [config-type] [--nfs-version 3|4]`

2. Update test/posix/run-posix.sh:
   - Accept optional `--nfs-version` parameter for informational purposes (logging which version is being tested)
   - Log the NFS version at the start of test output

3. Create test/posix/known_failures_v4.txt:
   - Copy structure from known_failures.txt (existing v3 known failures)
   - Document initial set of expected NFSv4 failures. Based on known NFSv4 differences:
     - Tests that rely on NLM-specific behavior may fail (NFSv4 uses integrated locking)
     - Tests that check specific error codes may get different NFS4ERR_ codes
     - Tests involving mandatory locking (not supported in NFSv4)
     - Add header comment explaining this is for NFSv4.0 and should be updated as failures are identified
   - Start with known v3 failures PLUS additional entries:
     - `# NFSv4-specific known failures`
     - `# NFSv4 uses integrated locking (no NLM), some lock tests may differ`
     - `# NFSv4 may return different error codes than NFSv3 for some operations`
     - Copy the existing known_failures.txt entries and add v4-specific notes

4. Update test/posix/README.md:
   - Add section: "## NFSv4 Testing"
   - Document: `sudo ./setup-posix.sh memory --nfs-version 4`
   - Document: `sudo env PATH="$PATH" ./run-posix.sh`
   - Note that known_failures_v4.txt tracks NFSv4-specific failures
   - Document the initial pass/fail expectations

NOTE on t.Parallel() / port isolation (locked decision #16):
POSIX tests are SEQUENTIAL by design -- they run pjdfstest against a single mount point with stateful filesystem operations (create, delete, rename sequences that depend on prior state). Parallelizing pjdfstest scripts within a single mount would cause test interference. The --nfs-version parameter allows running the v3 and v4 POSIX suites sequentially (different runs) or with different server instances on different ports for parallel execution at the CI level (not within the test suite itself).
  </action>
  <verify>
`bash -n test/posix/setup-posix.sh` (syntax check passes).
`bash -n test/posix/run-posix.sh` (syntax check passes).
`test -f test/posix/known_failures_v4.txt` (file exists).
README.md contains "NFSv4 Testing" section.
  </verify>
  <done>
setup-posix.sh accepts --nfs-version parameter and mounts with appropriate NFS version options. run-posix.sh logs NFS version. known_failures_v4.txt exists with initial known failure set. README.md documents NFSv4 testing workflow. POSIX tests are sequential by design with port isolation documented for CI-level parallelism.
  </done>
</task>

<task type="auto">
  <name>Task 2: Control plane v2.0 mount-level E2E tests</name>
  <files>test/e2e/nfsv4_controlplane_test.go</files>
  <action>
Create test/e2e/nfsv4_controlplane_test.go with `//go:build e2e` tag, package `e2e`.

Per CONTEXT.md: "Control plane v2.0 mount-level testing: change adapter settings via API, verify NFS behavior changes (blocked ops fail, netgroup denies access)"

PREREQUISITE CHECK: Before using helpers.GetNFSSettings and helpers.PatchNFSSetting, verify these functions exist in test/e2e/helpers/controlplane.go. They DO exist (confirmed during planning: GetNFSSettings at line 34, PatchNFSSetting at line 44). If for any reason they are missing at execution time, add them following the existing pattern in that file.

Implement:

a. `TestNFSv4ControlPlaneBlockedOps(t *testing.T)`:
   - Start server, create share, enable NFS, mount v4
   - Verify basic operations work (write, read)
   - Get API client: `client := helpers.GetAPIClient(t, serverURL)`
   - Block WRITE operation via API: `helpers.PatchNFSSetting(t, client, &apiclient.PatchNFSSettingsRequest{BlockedOperations: &[]string{"WRITE"}})`
   - Wait for settings watcher to pick up change: `helpers.WaitForSettingsReload(t)` (~12s)
   - Try to write file -- should fail with ENOTSUPP or EPERM (server returns NFS4ERR_NOTSUPP per Phase 14 decision)
   - Unblock by resetting blocked_operations to []
   - Wait for settings watcher to pick up change
   - Verify write works again

b. `TestNFSv4ControlPlaneNetgroup(t *testing.T)`:
   - Start server, create share, enable NFS
   - Create netgroup with localhost (127.0.0.1) via API: `helpers.CreateNetgroup(t, client, "test-ng")` + `helpers.AddNetgroupMember(t, client, "test-ng", "ip", "127.0.0.1")`
   - Assign netgroup to share via API
   - Mount v4 from localhost -- should succeed
   - Update netgroup to NOT include localhost (remove member or create netgroup with different IP)
   - Wait for settings watcher to pick up change
   - Try new operations -- should fail (access denied by netgroup check)
   - Per CONTEXT.md: verify netgroup denies access

c. `TestNFSv4ControlPlaneSettingsHotReload(t *testing.T)`:
   - Start server, mount v4
   - Update lease_time via API
   - Read GETATTR on mount to check if lease_time attribute changes (may not be directly observable from client)
   - Alternative: update delegation policy (disable delegations), verify no delegations granted on new opens
  </action>
  <verify>
`go build -tags=e2e ./test/e2e/...` compiles.
`go vet -tags=e2e ./test/e2e/...` passes.
Verify helpers exist: `grep -c 'func GetNFSSettings\|func PatchNFSSetting' test/e2e/helpers/controlplane.go` returns >= 2.
  </verify>
  <done>
nfsv4_controlplane_test.go contains 3 tests: blocked ops, netgroup access, settings hot-reload. Tests use existing helpers.GetNFSSettings, helpers.PatchNFSSetting, helpers.CreateNetgroup, helpers.WaitForSettingsReload from test/e2e/helpers/controlplane.go (confirmed to exist). Control plane tests validate mount-level behavior changes from API.
  </done>
</task>

<task type="auto">
  <name>Task 3: Stress tests and E2E coverage profile support</name>
  <files>test/e2e/nfsv4_stress_test.go, test/e2e/run-e2e.sh</files>
  <action>
1. Create test/e2e/nfsv4_stress_test.go with `//go:build e2e && stress` tag, package `e2e`.

Per CONTEXT.md: "Stress tests gated behind -tags=stress build tag"

Implement:

a. `TestStressLargeDirectory(t *testing.T)`:
   - Start server, mount v4
   - Create 500 files in one directory
   - List directory, verify all 500 entries present
   - Delete all 500 files
   - Test for both v3 and v4

b. `TestStressConcurrentDelegations(t *testing.T)`:
   - Start server, mount v4 from 3 mount points
   - All three mounts open the same file
   - Rapidly open/close from different mounts to trigger delegation grant/recall cycles
   - Verify data consistency after stress

c. `TestStressConcurrentFileCreation(t *testing.T)`:
   - Start server, mount v4
   - 10 goroutines each creating 100 files concurrently
   - Verify all 1000 files exist after completion
   - Verify no data corruption (each file has unique content)

IMPORTANT: The stress test file uses build tag `e2e && stress` so it's excluded from normal `go test -tags=e2e` runs. Run with: `sudo go test -tags='e2e stress' -v ./test/e2e/ -run TestStress`

2. Create test/e2e/run-e2e.sh -- E2E test runner script with --coverage support (locked decision #20):

The script should:
- Be executable (chmod +x)
- Accept flags: --s3, --test PATTERN, --verbose, --keep-localstack, --coverage, --stress, --nfs-version VERSION
- Default: run all E2E tests with `go test -tags=e2e -v -timeout 30m ./test/e2e/...`
- --coverage flag: adds `-coverprofile=coverage-e2e.out` to go test command
- --stress flag: adds `stress` to the build tags (`-tags='e2e,stress'`)
- --s3 flag: starts Localstack container before tests, stops after (unless --keep-localstack)
- --test PATTERN: passes `-run PATTERN` to go test
- --verbose: passes `-v` to go test
- --nfs-version: sets DITTOFS_E2E_NFS_VERSION env var for tests to pick up
- Requires sudo (check at start, exit with error if not root)
- Print summary at end (pass/fail count if possible)

This satisfies locked decision #20 (E2E coverage profile).
  </action>
  <verify>
`go build -tags=e2e ./test/e2e/...` compiles (stress tests excluded without stress tag).
`go build -tags='e2e,stress' ./test/e2e/...` compiles (stress tests included).
`go vet -tags='e2e,stress' ./test/e2e/...` passes.
`bash -n test/e2e/run-e2e.sh` (syntax check passes).
`grep -c 'coverprofile' test/e2e/run-e2e.sh` returns >= 1.
  </verify>
  <done>
nfsv4_stress_test.go contains 3 stress tests behind `-tags=stress`: large directory, concurrent delegations, concurrent file creation. run-e2e.sh supports --coverage flag that passes -coverprofile=coverage-e2e.out to go test. Stress tests are excluded from normal CI runs. Coverage profile can be generated for merge with unit test coverage.
  </done>
</task>

</tasks>

<verification>
- `bash -n test/posix/setup-posix.sh` passes (valid shell syntax)
- `bash -n test/posix/run-posix.sh` passes
- `test/posix/known_failures_v4.txt` exists
- `go build -tags=e2e ./test/e2e/...` compiles (stress excluded)
- `go build -tags='e2e,stress' ./test/e2e/...` compiles (stress included)
- `go vet -tags='e2e,stress' ./test/e2e/...` passes
- README.md documents NFSv4 POSIX testing
- run-e2e.sh exists with --coverage flag support
- helpers.GetNFSSettings and helpers.PatchNFSSetting confirmed to exist
</verification>

<success_criteria>
- pjdfstest POSIX compliance suite supports NFSv4 via --nfs-version parameter
- known_failures_v4.txt documents expected NFSv4-specific failures
- Control plane v2.0 settings changes (blocked ops, netgroup) observable via NFS mount
- Stress tests gated behind `-tags=stress` for CI flexibility
- run-e2e.sh supports --coverage flag for E2E coverage profile generation
- All 6 phase requirements covered across the 5 plans
</success_criteria>

<output>
After completion, create `.planning/phases/15-v2-0-testing/15-05-SUMMARY.md`
</output>
