---
phase: 03-storage-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - k8s/dittofs-operator/api/v1alpha1/dittoserver_types.go
  - k8s/dittofs-operator/api/v1alpha1/zz_generated.deepcopy.go
  - k8s/dittofs-operator/internal/controller/dittoserver_controller.go
autonomous: true

must_haves:
  truths:
    - "Cache volume persists across pod restarts"
    - "User can configure cache PVC size via CRD spec"
    - "PVCs are retained when DittoServer is deleted (data safety)"
  artifacts:
    - path: "k8s/dittofs-operator/api/v1alpha1/dittoserver_types.go"
      provides: "CacheSize field in StorageSpec"
      contains: "CacheSize string"
    - path: "k8s/dittofs-operator/internal/controller/dittoserver_controller.go"
      provides: "Cache VolumeClaimTemplate and retention policy"
      contains: "PersistentVolumeClaimRetentionPolicy"
  key_links:
    - from: "dittoserver_types.go"
      to: "dittoserver_controller.go"
      via: "CacheSize field used in buildVolumeClaimTemplates"
      pattern: "dittoServer\\.Spec\\.Storage\\.CacheSize"
---

<objective>
Convert cache from EmptyDir to VolumeClaimTemplate for WAL persistence across pod restarts

Purpose: Cache data contains WAL (Write-Ahead Log) for crash recovery. EmptyDir loses data on pod restart, breaking crash recovery. This is a critical bug fix identified in Phase 3 research.

Output:
- CacheSize field added to StorageSpec in CRD
- Cache VolumeClaimTemplate in StatefulSet (replaces EmptyDir)
- PVC retention policy set to Retain/Retain for data safety
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-storage-management/03-RESEARCH.md
@k8s/dittofs-operator/api/v1alpha1/dittoserver_types.go
@k8s/dittofs-operator/internal/controller/dittoserver_controller.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CacheSize field to StorageSpec</name>
  <files>k8s/dittofs-operator/api/v1alpha1/dittoserver_types.go</files>
  <action>
Add CacheSize field to StorageSpec struct between ContentSize and StorageClassName:

```go
// Size for cache PVC (mounted at /data/cache)
// Required for WAL persistence - enables crash recovery
// +kubebuilder:validation:Required
// +kubebuilder:validation:Pattern=`^[0-9]+(Gi|Mi|Ti)$`
// +kubebuilder:default="5Gi"
// +kubebuilder:example="5Gi"
CacheSize string `json:"cacheSize"`
```

The field should be:
- Required (kubebuilder:validation:Required)
- Pattern validated for Gi/Mi/Ti suffix
- Default value "5Gi"
- Has example for documentation

After modification, run `make generate manifests` to update zz_generated.deepcopy.go and CRD manifests.
  </action>
  <verify>
Run:
```bash
cd k8s/dittofs-operator && make generate manifests
grep -A5 "CacheSize" api/v1alpha1/dittoserver_types.go
grep "cacheSize" config/crd/bases/dittofs.dittofs.com_dittoservers.yaml
```
All commands should succeed. CacheSize should appear in types file and cacheSize should appear in CRD YAML.
  </verify>
  <done>CacheSize field exists in StorageSpec, CRD manifest includes cacheSize with validation pattern and default</done>
</task>

<task type="auto">
  <name>Task 2: Convert cache from EmptyDir to VolumeClaimTemplate</name>
  <files>k8s/dittofs-operator/internal/controller/dittoserver_controller.go</files>
  <action>
In reconcileStatefulSet function, modify to:

1. **Parse cacheSize**: Add parsing after contentSize parsing:
```go
// Cache PVC (ALWAYS required for WAL persistence)
cacheSize, err := resource.ParseQuantity(dittoServer.Spec.Storage.CacheSize)
if err != nil {
    return fmt.Errorf("invalid cache size: %w", err)
}
```

2. **Add cache VolumeClaimTemplate**: Add to volumeClaimTemplates slice (after metadata and optional content):
```go
// Cache VolumeClaimTemplate - always required for WAL persistence
volumeClaimTemplates = append(volumeClaimTemplates, corev1.PersistentVolumeClaim{
    ObjectMeta: metav1.ObjectMeta{
        Name: "cache",
    },
    Spec: corev1.PersistentVolumeClaimSpec{
        AccessModes: []corev1.PersistentVolumeAccessMode{
            corev1.ReadWriteOnce,
        },
        StorageClassName: dittoServer.Spec.Storage.StorageClassName,
        Resources: corev1.VolumeResourceRequirements{
            Requests: corev1.ResourceList{
                corev1.ResourceStorage: cacheSize,
            },
        },
    },
})
```

3. **Remove EmptyDir cache volume**: Delete this from Volumes slice:
```go
// REMOVE THIS BLOCK
{
    Name: "cache",
    VolumeSource: corev1.VolumeSource{
        EmptyDir: &corev1.EmptyDirVolumeSource{},
    },
},
```

The Volumes slice should only contain the "config" ConfigMap volume after this change.

4. **Add PVC retention policy**: In the StatefulSetSpec, add:
```go
PersistentVolumeClaimRetentionPolicy: &appsv1.StatefulSetPersistentVolumeClaimRetentionPolicy{
    WhenDeleted: appsv1.RetainPersistentVolumeClaimRetentionPolicyType,
    WhenScaled:  appsv1.RetainPersistentVolumeClaimRetentionPolicyType,
},
```
Add this field right before or after `VolumeClaimTemplates`.

Note: Need to import `appsv1 "k8s.io/api/apps/v1"` (already imported in file).
  </action>
  <verify>
Run:
```bash
cd k8s/dittofs-operator && go build ./...
grep -A10 "cache VolumeClaimTemplate" internal/controller/dittoserver_controller.go
grep "EmptyDir" internal/controller/dittoserver_controller.go  # Should return nothing
grep "RetainPersistentVolumeClaimRetentionPolicyType" internal/controller/dittoserver_controller.go
```
Build should succeed, cache VolumeClaimTemplate should exist, EmptyDir should NOT exist, retention policy should exist.
  </verify>
  <done>Cache uses VolumeClaimTemplate (not EmptyDir), parses CacheSize from spec, retention policy is Retain/Retain</done>
</task>

<task type="auto">
  <name>Task 3: Update sample CR and run tests</name>
  <files>k8s/dittofs-operator/config/samples/dittofs_v1alpha1_dittofs_memory.yaml</files>
  <action>
1. Update the sample CR to include cacheSize field in storage section:
```yaml
storage:
  metadataSize: "10Gi"
  contentSize: "50Gi"  # if present
  cacheSize: "5Gi"     # ADD THIS LINE
  storageClassName: "standard"  # or whatever is currently there
```

2. Run the full test suite:
```bash
cd k8s/dittofs-operator && make test
```

3. If tests fail due to missing CacheSize in test fixtures, update the test fixtures in:
- `internal/controller/dittoserver_controller_test.go`
- `api/v1alpha1/dittoserver_webhook_test.go`

Each test DittoServer should have Storage.CacheSize set (e.g., "5Gi").
  </action>
  <verify>
Run:
```bash
cd k8s/dittofs-operator && make test
grep "cacheSize" config/samples/dittofs_v1alpha1_dittofs_memory.yaml
```
Tests should pass, cacheSize should appear in sample CR.
  </verify>
  <done>Sample CR includes cacheSize, all tests pass</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **CRD schema check**:
```bash
cd k8s/dittofs-operator
grep -A20 "cacheSize:" config/crd/bases/dittofs.dittofs.com_dittoservers.yaml
```
Should show cacheSize field with pattern validation and default.

2. **Build check**:
```bash
cd k8s/dittofs-operator && go build ./...
```
Must succeed.

3. **Test check**:
```bash
cd k8s/dittofs-operator && make test
```
All tests must pass.

4. **No EmptyDir for cache**:
```bash
grep -r "EmptyDir" k8s/dittofs-operator/internal/
```
Should NOT find EmptyDir for cache volume (only possibly in test mocks if any).
</verification>

<success_criteria>
- CacheSize field exists in StorageSpec with validation and default
- Cache volume uses VolumeClaimTemplate (not EmptyDir)
- StatefulSet has PersistentVolumeClaimRetentionPolicy set to Retain/Retain
- Sample CR includes cacheSize
- All tests pass
- `make generate manifests` produces updated CRD
</success_criteria>

<output>
After completion, create `.planning/phases/03-storage-management/03-01-SUMMARY.md` using summary template.
</output>
