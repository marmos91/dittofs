---
phase: 14-control-plane-v2-0
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pkg/controlplane/models/adapter_settings.go
  - pkg/controlplane/models/netgroup.go
  - pkg/controlplane/models/share.go
  - pkg/controlplane/models/models.go
  - pkg/controlplane/models/errors.go
  - pkg/controlplane/store/interface.go
  - pkg/controlplane/store/adapter_settings.go
  - pkg/controlplane/store/netgroups.go
  - pkg/controlplane/store/shares.go
  - pkg/controlplane/store/gorm.go
autonomous: true

must_haves:
  truths:
    - "NFSAdapterSettings and SMBAdapterSettings GORM models exist with all typed fields"
    - "Netgroup and NetgroupMember GORM models exist as first-class resources"
    - "Share model has security policy fields (allow_auth_sys, require_kerberos, min_kerberos_level, netgroup_id, blocked_operations)"
    - "Store interface has CRUD operations for adapter settings and netgroups"
    - "GORM auto-migrate creates all new tables and columns"
    - "Existing shares get default security policy values via migration"
    - "Existing adapters get default settings records via migration"
  artifacts:
    - path: "pkg/controlplane/models/adapter_settings.go"
      provides: "NFSAdapterSettings and SMBAdapterSettings GORM models"
      contains: "NFSAdapterSettings"
    - path: "pkg/controlplane/models/netgroup.go"
      provides: "Netgroup and NetgroupMember GORM models"
      contains: "NetgroupMember"
    - path: "pkg/controlplane/models/share.go"
      provides: "Share with security policy fields"
      contains: "AllowAuthSys"
    - path: "pkg/controlplane/store/interface.go"
      provides: "Extended Store interface with adapter settings + netgroup operations"
      contains: "GetNFSAdapterSettings"
    - path: "pkg/controlplane/store/adapter_settings.go"
      provides: "GORM adapter settings CRUD implementation"
      exports: ["GetNFSAdapterSettings", "UpdateNFSAdapterSettings"]
    - path: "pkg/controlplane/store/netgroups.go"
      provides: "GORM netgroup CRUD implementation"
      exports: ["CreateNetgroup", "ListNetgroups", "DeleteNetgroup"]
  key_links:
    - from: "pkg/controlplane/store/adapter_settings.go"
      to: "pkg/controlplane/models/adapter_settings.go"
      via: "GORM operations on NFSAdapterSettings/SMBAdapterSettings"
      pattern: "db\\..*NFSAdapterSettings"
    - from: "pkg/controlplane/store/netgroups.go"
      to: "pkg/controlplane/models/netgroup.go"
      via: "GORM operations on Netgroup/NetgroupMember"
      pattern: "db\\..*Netgroup"
    - from: "pkg/controlplane/models/models.go"
      to: "pkg/controlplane/models/adapter_settings.go"
      via: "AllModels() registration"
      pattern: "NFSAdapterSettings"
---

<objective>
Create all GORM models, store operations, and database migration for Phase 14.

Purpose: Establish the data layer foundation that all subsequent plans (API, CLI, runtime) depend on. Without models and store operations, nothing else can be built.
Output: GORM models for adapter settings, netgroups, share security policy; Store interface extensions; GORM implementations; auto-migration for existing data.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-control-plane-v2-0/14-CONTEXT.md
@.planning/phases/14-control-plane-v2-0/14-RESEARCH.md
@pkg/controlplane/models/adapter.go
@pkg/controlplane/models/share.go
@pkg/controlplane/models/models.go
@pkg/controlplane/models/errors.go
@pkg/controlplane/store/interface.go
@pkg/controlplane/store/gorm.go
@pkg/controlplane/store/adapters.go
@pkg/controlplane/store/shares.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: GORM Models for Adapter Settings, Netgroups, and Share Security</name>
  <files>
    pkg/controlplane/models/adapter_settings.go
    pkg/controlplane/models/netgroup.go
    pkg/controlplane/models/share.go
    pkg/controlplane/models/models.go
    pkg/controlplane/models/errors.go
  </files>
  <action>
Create three new model files and extend existing ones:

**1. `adapter_settings.go`** - NFSAdapterSettings and SMBAdapterSettings:

NFSAdapterSettings (1:1 with NFS adapter):
- ID (UUID primary key), AdapterID (unique index, FK to adapters)
- Version: MinVersion string (default "3"), MaxVersion string (default "4.0")
- Timeouts (int seconds): LeaseTime (90), GracePeriod (90), DelegationRecallTimeout (90), CallbackTimeout (5), LeaseBreakTimeout (35)
- Limits: MaxConnections (0=unlimited), MaxClients (10000), MaxCompoundOps (50)
- Transport: MaxReadSize (1048576), MaxWriteSize (1048576), PreferredTransferSize (1048576)
- DelegationsEnabled bool (default true)
- BlockedOperations string (JSON array in text field, e.g. `["LOCK","DELEGPURGE"]`)
- Version int (monotonic counter for change detection, starts at 1, incremented on every update) -- use this instead of UpdatedAt for settings polling per research recommendation
- CreatedAt, UpdatedAt timestamps

SMBAdapterSettings (1:1 with SMB adapter):
- ID, AdapterID (same pattern)
- MinDialect string (default "SMB2.0"), MaxDialect string (default "SMB3.1.1")
- SessionTimeout int (default 900 seconds = 15min), OplockBreakTimeout int (default 35)
- MaxConnections (0), MaxSessions (10000)
- EnableEncryption bool (default false) -- stub, logs "not yet implemented"
- BlockedOperations string (JSON array)
- Version int (monotonic counter)
- CreatedAt, UpdatedAt

Add helper methods:
- `GetBlockedOperations() []string` -- parse JSON array
- `SetBlockedOperations(ops []string)` -- serialize to JSON array
- `NewDefaultNFSSettings(adapterID string) *NFSAdapterSettings` -- creates with all defaults
- `NewDefaultSMBSettings(adapterID string) *SMBAdapterSettings` -- creates with all defaults
- Validation structs: `NFSSettingsValidRange` and `SMBSettingsValidRange` with min/max for each numeric field

**2. `netgroup.go`** - Netgroup and NetgroupMember:

Netgroup: ID (UUID), Name (unique index), Members (hasMany), CreatedAt, UpdatedAt
NetgroupMember: ID (UUID), NetgroupID (index, FK), Type string ("ip", "cidr", "hostname"), Value string, CreatedAt

Add `ValidateMemberType(memberType string) bool` and `ValidateMemberValue(memberType, value string) error` that validates:
- "ip": net.ParseIP must succeed
- "cidr": net.ParseCIDR must succeed
- "hostname": must not be empty, wildcards like "*.example.com" allowed

Add error variables: ErrNetgroupNotFound, ErrDuplicateNetgroup, ErrNetgroupInUse (when referenced by shares)

**3. Extend `share.go`** - Add security policy fields directly on Share struct:
- AllowAuthSys bool `gorm:"default:true"` -- default AUTH_SYS allowed per locked decision
- RequireKerberos bool `gorm:"default:false"`
- MinKerberosLevel string `gorm:"default:krb5;size:20"` -- krb5, krb5i, krb5p
- NetgroupID *string `gorm:"size:36"` -- nullable FK to netgroups
- BlockedOperations string `gorm:"type:text"` -- JSON array, per-share operation blocklist

Add helper methods `GetBlockedOps() []string` and `SetBlockedOps(ops []string)` on Share.

**4. Update `models.go`** - Add NFSAdapterSettings, SMBAdapterSettings, Netgroup, NetgroupMember to AllModels()

**5. Update `errors.go`** - Add ErrNetgroupNotFound, ErrDuplicateNetgroup, ErrNetgroupInUse sentinel errors

IMPORTANT: For the Share security policy fields, use `gorm:"default:true"` for AllowAuthSys. The GORM zero-value boolean trap (Pitfall 1 from research) will be handled in the store migration step, not in the model definition.
  </action>
  <verify>
`go build ./pkg/controlplane/models/...` compiles without errors.
`go vet ./pkg/controlplane/models/...` passes.
  </verify>
  <done>
All new GORM models compile. NFSAdapterSettings has all 15+ typed fields. SMBAdapterSettings has all 7+ typed fields. Netgroup/NetgroupMember models exist with validation. Share has 5 new security policy fields. AllModels() includes all new types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Store Interface Extension and GORM Implementation</name>
  <files>
    pkg/controlplane/store/interface.go
    pkg/controlplane/store/adapter_settings.go
    pkg/controlplane/store/netgroups.go
    pkg/controlplane/store/shares.go
    pkg/controlplane/store/gorm.go
  </files>
  <action>
**1. Extend `interface.go`** with new Store interface sections:

```
// ADAPTER SETTINGS OPERATIONS
GetNFSAdapterSettings(ctx, adapterID) (*NFSAdapterSettings, error)
UpdateNFSAdapterSettings(ctx, settings *NFSAdapterSettings) error
ResetNFSAdapterSettings(ctx, adapterID string) error  // reset to defaults
GetSMBAdapterSettings(ctx, adapterID) (*SMBAdapterSettings, error)
UpdateSMBAdapterSettings(ctx, settings *SMBAdapterSettings) error
ResetSMBAdapterSettings(ctx, adapterID string) error
EnsureAdapterSettings(ctx) error  // create default settings for adapters that lack them

// NETGROUP OPERATIONS
GetNetgroup(ctx, name) (*Netgroup, error)
GetNetgroupByID(ctx, id) (*Netgroup, error)
ListNetgroups(ctx) ([]*Netgroup, error)
CreateNetgroup(ctx, netgroup *Netgroup) (string, error)
DeleteNetgroup(ctx, name) error  // fails if referenced by shares (ErrNetgroupInUse)
AddNetgroupMember(ctx, netgroupName string, member *NetgroupMember) error
RemoveNetgroupMember(ctx, netgroupName, memberID string) error
GetNetgroupMembers(ctx, netgroupName) ([]*NetgroupMember, error)
GetSharesByNetgroup(ctx, netgroupName) ([]*Share, error)  // for ErrNetgroupInUse check
```

**2. Create `adapter_settings.go`** - GORM implementation:
- GetNFSAdapterSettings: query by adapter_id with Preload, return ErrAdapterNotFound if adapter missing
- UpdateNFSAdapterSettings: increment Version field atomically (`UPDATE ... SET version = version + 1, ...`), use GORM `Save` with explicit version increment
- ResetNFSAdapterSettings: delete existing record and create with NewDefaultNFSSettings
- Same pattern for SMB
- EnsureAdapterSettings: list all adapters, for each check if settings exist, create defaults if missing. This handles migration for existing adapters.

**3. Create `netgroups.go`** - GORM implementation:
- Standard CRUD following the groups.go pattern
- CreateNetgroup: generate UUID, check uniqueness
- DeleteNetgroup: check GetSharesByNetgroup first, return ErrNetgroupInUse if any shares reference it
- AddNetgroupMember: validate member type/value using model validators, generate UUID
- RemoveNetgroupMember: delete by ID within netgroup
- GetNetgroup: preload Members

**4. Modify `shares.go`** - The existing share CRUD already handles all fields via GORM. No changes needed to share store methods because GORM auto-handles new columns. BUT add a post-migration step.

**5. Modify `gorm.go`** (New() function) - After AutoMigrate, add data migration:
- Call `EnsureAdapterSettings(ctx)` to create default settings for existing adapters
- Run `UPDATE shares SET allow_auth_sys = 1 WHERE allow_auth_sys = 0 AND blocked_operations IS NULL AND require_kerberos = 0` to set defaults for existing shares that got zero-values from column addition (Pitfall 4 from research). Use raw SQL: `db.Exec("UPDATE shares SET allow_auth_sys = ? WHERE ...")`.

Note: The Version counter approach for change detection (research Open Question 1) is used instead of timestamp comparison. Each update increments version atomically.
  </action>
  <verify>
`go build ./pkg/controlplane/store/...` compiles.
`go test ./pkg/controlplane/store/... -count=1` passes (existing tests still work).
`go vet ./pkg/controlplane/store/...` passes.
  </verify>
  <done>
Store interface has 15+ new methods for adapter settings and netgroups. GORM implementations compile and handle all CRUD operations. Data migration populates defaults for existing adapters and shares. Existing store tests pass (no regressions).
  </done>
</task>

</tasks>

<verification>
- `go build ./pkg/controlplane/...` compiles without errors
- `go test ./pkg/controlplane/store/... -count=1` passes (existing tests, no regressions)
- `go vet ./pkg/controlplane/...` clean
- New model files exist with correct GORM tags
- Store interface extended with adapter settings + netgroup operations
</verification>

<success_criteria>
Data layer complete: all GORM models, store interface, GORM implementations, and migration logic for adapter settings, netgroups, and share security policy.
</success_criteria>

<output>
After completion, create `.planning/phases/14-control-plane-v2-0/14-01-SUMMARY.md`
</output>
