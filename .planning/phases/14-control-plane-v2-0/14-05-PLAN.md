---
phase: 14-control-plane-v2-0
plan: 05
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - cmd/dittofsctl/commands/adapter/settings.go
  - cmd/dittofsctl/commands/adapter/adapter.go
  - cmd/dittofsctl/commands/netgroup/netgroup.go
  - cmd/dittofsctl/commands/netgroup/create.go
  - cmd/dittofsctl/commands/netgroup/list.go
  - cmd/dittofsctl/commands/netgroup/delete.go
  - cmd/dittofsctl/commands/netgroup/show.go
  - cmd/dittofsctl/commands/netgroup/add_member.go
  - cmd/dittofsctl/commands/netgroup/remove_member.go
  - cmd/dittofsctl/commands/root.go
autonomous: true

must_haves:
  truths:
    - "dittofsctl adapter nfs settings show displays grouped key-values with '*' for non-defaults"
    - "dittofsctl adapter nfs settings update --lease-time 120 applies partial updates"
    - "dittofsctl adapter nfs settings reset resets all settings to defaults"
    - "dittofsctl adapter nfs settings reset --setting lease_time resets specific setting"
    - "--dry-run flag validates without applying"
    - "--force flag bypasses range validation"
    - "dittofsctl netgroup create/list/delete/show work"
    - "dittofsctl netgroup add-member/remove-member manage members"
    - "All commands support -o json output format"
  artifacts:
    - path: "cmd/dittofsctl/commands/adapter/settings.go"
      provides: "Adapter settings CLI commands"
      contains: "settingsShowCmd"
    - path: "cmd/dittofsctl/commands/netgroup/netgroup.go"
      provides: "Netgroup parent command"
      contains: "netgroupCmd"
    - path: "cmd/dittofsctl/commands/netgroup/create.go"
      provides: "Netgroup create command"
      contains: "createCmd"
  key_links:
    - from: "cmd/dittofsctl/commands/adapter/settings.go"
      to: "pkg/apiclient/adapter_settings.go"
      via: "API client calls for settings"
      pattern: "client\\..*AdapterSettings"
    - from: "cmd/dittofsctl/commands/netgroup/create.go"
      to: "pkg/apiclient/netgroups.go"
      via: "API client calls for netgroups"
      pattern: "client\\.CreateNetgroup"
    - from: "cmd/dittofsctl/commands/root.go"
      to: "cmd/dittofsctl/commands/netgroup/netgroup.go"
      via: "Subcommand registration"
      pattern: "netgroupCmd"
---

<objective>
Build the dittofsctl CLI commands for adapter settings management and netgroup management.

Purpose: Provide the user-facing CLI for all control plane v2.0 operations per the locked CLI design decisions.
Output: `dittofsctl adapter {nfs|smb} settings show/update/reset` and `dittofsctl netgroup create/list/show/delete/add-member/remove-member` commands.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-control-plane-v2-0/14-CONTEXT.md
@.planning/phases/14-control-plane-v2-0/14-RESEARCH.md
@.planning/phases/14-control-plane-v2-0/14-01-SUMMARY.md
@cmd/dittofsctl/commands/adapter/adapter.go
@cmd/dittofsctl/commands/adapter/list.go
@cmd/dittofsctl/commands/adapter/edit.go
@cmd/dittofsctl/commands/root.go
@cmd/dittofsctl/cmdutil/util.go
@internal/cli/output/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Adapter Settings CLI Commands</name>
  <files>
    cmd/dittofsctl/commands/adapter/settings.go
    cmd/dittofsctl/commands/adapter/adapter.go
  </files>
  <action>
**1. Create `settings.go`** - Adapter settings subcommands:

The existing adapter command (`adapter.go`) has subcommands like `list`, `enable`, `disable`, `edit`. Add a new `settings` subgroup under adapter.

Command structure per locked decision:
- `dittofsctl adapter nfs settings show` -- show current settings
- `dittofsctl adapter nfs settings update [flags]` -- update settings
- `dittofsctl adapter nfs settings reset [--setting <name>]` -- reset

The adapter type ("nfs" or "smb") is specified as a positional argument or via the parent command context.

**settingsCmd** (parent): `adapter settings` with subcommands show/update/reset
- Actually, the CLI structure is: `dittofsctl adapter nfs settings show` where "nfs" is the adapter type arg and "settings" is a subcommand group.
- Look at how the existing adapter commands work in `adapter.go`. The adapter type is likely a subcommand or arg.
- Implementation: Create `settingsCmd` with `Use: "settings"` and add show/update/reset as subcommands. The adapter type comes from the parent command's args (e.g., `dittofsctl adapter nfs settings show` where `nfs` is captured by the adapter parent).
- Actually, looking at the existing commands, adapter type is likely `{type}` in the command. Follow the existing pattern for `edit` command which takes adapter type as arg.

**settingsShowCmd**:
- Get authenticated client via `cmdutil.GetAuthenticatedClient()`
- Call `client.GetAdapterSettings(adapterType)` and `client.GetAdapterSettingsDefaults(adapterType)`
- Display in config-style grouped output (per locked decision):
  ```
  # Version Negotiation
    min_version = 3
  * max_version = 4.0      (default: 4.1)

  # Timeouts
    lease_time = 90s
  * grace_period = 120s     (default: 90s)
  ...
  ```
- '*' marks non-default values per locked decision
- Support `-o json` for JSON output (check `cmdutil` for output format flag pattern)
- Group sections: Version Negotiation, Timeouts, Connection Limits, Transport, Delegation, Operations

**settingsUpdateCmd**:
- Flags for each setting: `--lease-time`, `--grace-period`, `--delegation-recall-timeout`, `--callback-timeout`, `--lease-break-timeout`, `--max-connections`, `--max-clients`, `--max-compound-ops`, `--max-read-size`, `--max-write-size`, `--preferred-transfer-size`, `--min-version`, `--max-version`, `--delegations-enabled`, `--blocked-operations` (comma-separated)
- `--dry-run` flag per locked decision
- `--force` flag per locked decision
- Only include changed flags in the PATCH request (check `cmd.Flags().Changed("flag-name")`)
- Build PatchNFSSettingsRequest with only changed fields as non-nil
- Call `client.PatchAdapterSettings(adapterType, req, opts...)` with force/dry_run options
- On success, display updated settings in config-style
- On validation error, display per-field errors

**settingsResetCmd**:
- `--setting <name>` flag -- reset specific setting (optional)
- If no --setting, reset all to defaults
- Call `client.ResetAdapterSettings(adapterType, settingName)`
- Confirm before reset (use `prompt.Confirm` from internal/cli/prompt)
- On success, display reset settings

**2. Modify `adapter.go`** - Register the settings subcommand on the adapter parent command. The structure should work as: `adapter {type} settings {show|update|reset}`.

Look at the existing adapter command structure. If adapter type is a positional arg on the parent, then settings is a subcommand that reads the adapter type from args[0]. Follow the same pattern as `edit.go` which takes the adapter type.
  </action>
  <verify>
`go build ./cmd/dittofsctl/...` compiles.
`dittofsctl adapter --help` shows settings subcommand.
  </verify>
  <done>
Settings show displays grouped config with '*' for non-defaults. Update applies partial changes via PATCH with --dry-run and --force. Reset restores defaults for all or specific settings. All commands support -o json.
  </done>
</task>

<task type="auto">
  <name>Task 2: Netgroup CLI Commands</name>
  <files>
    cmd/dittofsctl/commands/netgroup/netgroup.go
    cmd/dittofsctl/commands/netgroup/create.go
    cmd/dittofsctl/commands/netgroup/list.go
    cmd/dittofsctl/commands/netgroup/show.go
    cmd/dittofsctl/commands/netgroup/delete.go
    cmd/dittofsctl/commands/netgroup/add_member.go
    cmd/dittofsctl/commands/netgroup/remove_member.go
    cmd/dittofsctl/commands/root.go
  </files>
  <action>
**1. Create `netgroup/` directory** with the following commands following the group/ command pattern:

**netgroup.go** (parent):
```go
var netgroupCmd = &cobra.Command{
    Use:   "netgroup",
    Short: "Manage netgroups (IP access control)",
    Long:  "Create and manage netgroups for IP-based share access control.",
}
func init() {
    netgroupCmd.AddCommand(createCmd, listCmd, showCmd, deleteCmd, addMemberCmd, removeMemberCmd)
}
func Command() *cobra.Command { return netgroupCmd }
```

**create.go**: `dittofsctl netgroup create --name <name>`
- Takes --name flag (required)
- Calls `client.CreateNetgroup(name)`
- Outputs created netgroup (table or JSON based on -o flag)

**list.go**: `dittofsctl netgroup list`
- Calls `client.ListNetgroups()`
- Table output: NAME | MEMBERS | CREATED
- Shows member count per netgroup

**show.go**: `dittofsctl netgroup show <name>` (name as positional arg)
- Calls `client.GetNetgroup(name)`
- Displays netgroup details with all members
- Table: TYPE | VALUE | ID for each member

**delete.go**: `dittofsctl netgroup delete <name>`
- Calls `client.DeleteNetgroup(name)`
- Confirm before delete (use prompt.Confirm)
- Handle 409 Conflict (ErrNetgroupInUse) with clear message about which shares reference it

**add_member.go**: `dittofsctl netgroup add-member <name> --type <ip|cidr|hostname> --value <value>`
- Takes netgroup name as positional arg
- --type flag: "ip", "cidr", or "hostname" (required)
- --value flag: the IP, CIDR, or hostname (required)
- Client-side validation of type/value before API call
- Calls `client.AddNetgroupMember(name, type, value)`
- Shows success message with added member

**remove_member.go**: `dittofsctl netgroup remove-member <name> --member-id <id>`
- Takes netgroup name as positional arg
- --member-id flag (required) -- the UUID of the member to remove (shown in `show` output)
- Calls `client.RemoveNetgroupMember(name, memberID)`

**2. Modify `root.go`** - Register netgroup command:
```go
rootCmd.AddCommand(netgroup.Command())
```

Follow the exact same patterns as the existing `group/` commands for:
- Error handling (cmdutil patterns)
- Output formatting (internal/cli/output for table, -o json for JSON)
- Authentication (cmdutil.GetAuthenticatedClient)
- Help text style
  </action>
  <verify>
`go build ./cmd/dittofsctl/...` compiles.
`dittofsctl netgroup --help` shows create/list/show/delete/add-member/remove-member.
`dittofsctl --help` shows netgroup as a top-level command.
  </verify>
  <done>
All netgroup CLI commands compile and are registered. Create, list, show, delete, add-member, remove-member all follow existing CLI patterns. Table and JSON output supported. Confirmation prompts on destructive operations.
  </done>
</task>

</tasks>

<verification>
- `go build ./cmd/dittofsctl/...` compiles
- `dittofsctl adapter --help` shows settings commands
- `dittofsctl netgroup --help` shows all subcommands
- `dittofsctl --help` shows netgroup as top-level command
</verification>

<success_criteria>
Full CLI for adapter settings (show with grouped key-values and '*' markers, update with --dry-run/--force, reset with --setting). Full CLI for netgroup CRUD with member management. All commands follow existing dittofsctl patterns.
</success_criteria>

<output>
After completion, create `.planning/phases/14-control-plane-v2-0/14-05-SUMMARY.md`
</output>
