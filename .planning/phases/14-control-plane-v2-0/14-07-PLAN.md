---
phase: 14-control-plane-v2-0
plan: 07
type: execute
wave: 4
depends_on: ["14-04", "14-05", "14-06"]
files_modified:
  - test/e2e/controlplane_v2_test.go
  - test/e2e/helpers_controlplane.go
autonomous: true

must_haves:
  truths:
    - "Full lifecycle E2E test: create adapter -> set settings -> create share with security policy -> mount -> verify"
    - "Settings update takes effect for new connections (hot-reload)"
    - "Netgroup IP restriction blocks unauthorized clients"
    - "Operation blocklist returns NFS4ERR_NOTSUPP for disabled operations"
    - "E2E tests pass with real NFS mounts"
    - "Tests are fast enough for CI (< 5 minutes total)"
  artifacts:
    - path: "test/e2e/controlplane_v2_test.go"
      provides: "Control plane v2.0 E2E test suite"
      contains: "TestControlPlaneV2"
    - path: "test/e2e/helpers_controlplane.go"
      provides: "E2E test helpers for control plane operations"
      contains: "setupControlPlane"
  key_links:
    - from: "test/e2e/controlplane_v2_test.go"
      to: "pkg/controlplane/api/router.go"
      via: "REST API calls via HTTP client"
      pattern: "api/v1/adapters"
    - from: "test/e2e/controlplane_v2_test.go"
      to: "pkg/adapter/nfs/nfs_adapter.go"
      via: "NFS mount testing"
      pattern: "mount"
---

<objective>
Write E2E tests that validate the full control plane v2.0 functionality with real NFS mounts.

Purpose: Verify that adapter settings, share security policy, and netgroups work end-to-end with actual protocol operations. Per locked decision: "Full E2E tests with real NFS + SMB mounts."
Output: E2E test file with lifecycle test and focused scenario tests.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-control-plane-v2-0/14-CONTEXT.md
@.planning/phases/14-control-plane-v2-0/14-RESEARCH.md
@.planning/phases/14-control-plane-v2-0/14-04-SUMMARY.md
@.planning/phases/14-control-plane-v2-0/14-05-SUMMARY.md
@.planning/phases/14-control-plane-v2-0/14-06-SUMMARY.md
@test/e2e/adapters_test.go
@test/e2e/helpers.go
@test/e2e/README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: E2E Test Helpers for Control Plane v2.0</name>
  <files>
    test/e2e/helpers_controlplane.go
  </files>
  <action>
Create helper functions for control plane v2.0 E2E testing. Use the `//go:build e2e` build tag matching existing E2E tests.

Helpers needed:

1. **API Client Setup**: Create authenticated API client connected to the test server.
```go
func getAPIClient(t *testing.T, serverURL string) *apiclient.Client {
    client := apiclient.New(serverURL)
    tokens, err := client.Login("admin", testAdminPassword)
    require.NoError(t, err)
    return client.WithToken(tokens.AccessToken)
}
```

2. **Settings Management**:
```go
func updateNFSSetting(t *testing.T, client *apiclient.Client, field string, value any) {
    // Build PATCH request with just the one field
    // Call PatchAdapterSettings
}

func getNFSSettings(t *testing.T, client *apiclient.Client) *apiclient.NFSAdapterSettingsResponse {
    settings, err := client.GetAdapterSettings("nfs")
    require.NoError(t, err)
    return settings
}

func resetNFSSettings(t *testing.T, client *apiclient.Client) {
    err := client.ResetAdapterSettings("nfs", "")
    require.NoError(t, err)
}
```

3. **Netgroup Management**:
```go
func createNetgroup(t *testing.T, client *apiclient.Client, name string) *apiclient.Netgroup
func addNetgroupMember(t *testing.T, client *apiclient.Client, name, memberType, value string)
func deleteNetgroup(t *testing.T, client *apiclient.Client, name string)
```

4. **Share with Security Policy**:
```go
func createShareWithPolicy(t *testing.T, client *apiclient.Client, name string, policy SharePolicy) string
type SharePolicy struct {
    AllowAuthSys    *bool
    RequireKerberos *bool
    NetgroupID      *string
    BlockedOps      []string
}
```

5. **Wait for Settings Reload**:
```go
func waitForSettingsReload(t *testing.T) {
    // Wait slightly longer than the polling interval (10s)
    // to ensure the adapter picks up changes
    time.Sleep(12 * time.Second)
}
```

Follow the existing E2E helper patterns from `helpers.go` (or similar) in the test/e2e directory.
  </action>
  <verify>
`go build -tags=e2e ./test/e2e/...` compiles.
  </verify>
  <done>
E2E helper functions compile and are available for test functions.
  </done>
</task>

<task type="auto">
  <name>Task 2: E2E Test Scenarios</name>
  <files>
    test/e2e/controlplane_v2_test.go
  </files>
  <action>
Create E2E test file with `//go:build e2e` build tag.

**Test 1: Full Lifecycle** (per locked decision: "create adapter -> set settings -> create share with security policy -> mount -> verify behavior"):
```go
func TestControlPlaneV2_FullLifecycle(t *testing.T) {
    // 1. Start server with default config
    // 2. Get API client
    // 3. Verify default NFS settings match expectations
    // 4. Update lease_time to 120s
    // 5. Create a share with security policy (allow_auth_sys=true)
    // 6. Mount via NFS
    // 7. Verify mount works and basic file operations succeed
    // 8. Unmount
    // 9. Verify settings persisted across API calls
}
```

**Test 2: Settings Hot-Reload**:
```go
func TestControlPlaneV2_SettingsHotReload(t *testing.T) {
    // 1. Start server, mount share
    // 2. Update a visible setting via API (e.g., max_read_size)
    // 3. Wait for reload interval
    // 4. New mount/connection should use new settings
    // Note: Testing that existing connections are grandfathered is hard to observe
    // from E2E. Focus on verifying new connections pick up changes.
}
```

**Test 3: Settings Validation**:
```go
func TestControlPlaneV2_SettingsValidation(t *testing.T) {
    // 1. Try PATCH with invalid lease_time (too low) -> expect 422 with per-field error
    // 2. Try PATCH with --force -> expect 200 (validation bypassed)
    // 3. Try --dry-run -> expect 200 response but settings unchanged in DB
    // 4. Try reset -> expect settings back to defaults
}
```

**Test 4: Settings PATCH vs PUT**:
```go
func TestControlPlaneV2_PatchVsPut(t *testing.T) {
    // 1. PATCH only lease_time -> other settings unchanged
    // 2. PUT with all fields -> all settings replaced
}
```

**Test 5: Netgroup CRUD**:
```go
func TestControlPlaneV2_NetgroupCRUD(t *testing.T) {
    // 1. Create netgroup "office"
    // 2. Add members: IP, CIDR, hostname
    // 3. List netgroups -> verify "office" with 3 members
    // 4. Remove a member
    // 5. Delete netgroup
}
```

**Test 6: Netgroup In-Use Protection**:
```go
func TestControlPlaneV2_NetgroupInUse(t *testing.T) {
    // 1. Create netgroup "internal"
    // 2. Create share referencing netgroup
    // 3. Try delete netgroup -> expect 409 Conflict
    // 4. Delete share
    // 5. Delete netgroup -> expect success
}
```

**Test 7: Share Security Policy**:
```go
func TestControlPlaneV2_ShareSecurityPolicy(t *testing.T) {
    // 1. Create share with allow_auth_sys=true
    // 2. Mount with AUTH_SYS -> should work
    // 3. Update share to allow_auth_sys=false
    // 4. New mount attempt with AUTH_SYS -> should fail
    // Note: This requires the adapter to actually enforce the policy
    // If enforcement is not yet wired, mark as TODO with skip
}
```

**Test 8: Delegation Policy**:
```go
func TestControlPlaneV2_DelegationPolicy(t *testing.T) {
    // 1. Verify delegations_enabled=true (default)
    // 2. Set delegations_enabled=false
    // 3. Open file via NFS -> verify no delegation granted
    // Note: Delegation grant is hard to observe from client side
    // If not observable, skip and document
}
```

All tests should:
- Use `t.Parallel()` where safe (different shares/netgroups)
- Clean up resources (shares, netgroups) via t.Cleanup
- Use the existing E2E test infrastructure (server startup, mount helpers)
- Respect `//go:build e2e` tag
- Be fast enough for CI (each test < 30s, total < 5 min)
- Skip gracefully if NFS mount not available (like existing E2E tests)
  </action>
  <verify>
`go build -tags=e2e ./test/e2e/...` compiles.
`sudo go test -tags=e2e -v -run TestControlPlaneV2 ./test/e2e/...` passes (when run with appropriate privileges).
  </verify>
  <done>
8 E2E test scenarios covering: full lifecycle, settings hot-reload, validation (422 errors, force, dry_run), PATCH vs PUT, netgroup CRUD, netgroup in-use protection, share security policy, delegation policy. All compile with e2e build tag.
  </done>
</task>

</tasks>

<verification>
- `go build -tags=e2e ./test/e2e/...` compiles
- E2E tests pass when run with NFS mount capabilities
- Tests complete within 5 minutes total
- No test pollution (each test creates/cleans its own resources)
</verification>

<success_criteria>
Complete E2E test suite verifying control plane v2.0 end-to-end. Full lifecycle test covers adapter -> settings -> share -> mount -> verify. Focused tests cover validation, hot-reload, netgroup access, and security policy. All tests are CI-ready.
</success_criteria>

<output>
After completion, create `.planning/phases/14-control-plane-v2-0/14-07-SUMMARY.md`
</output>
