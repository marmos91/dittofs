---
phase: 04-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - k8s/dittofs-operator/api/v1alpha1/dittoserver_types.go
  - k8s/dittofs-operator/api/v1alpha1/dittoserver_types_builder.go
  - k8s/dittofs-operator/api/v1alpha1/dittoserver_webhook.go
  - k8s/dittofs-operator/api/v1alpha1/zz_generated.deepcopy.go
  - k8s/dittofs-operator/internal/controller/dittoserver_controller.go
  - k8s/dittofs-operator/internal/controller/dittoserver_controller_test.go
  - k8s/dittofs-operator/utils/nfs/nfs.go
  - k8s/dittofs-operator/utils/smb/smb.go
  - k8s/dittofs-operator/config/crd/bases/dittofs.dittofs.com_dittoservers.yaml
  - k8s/dittofs-operator/chart/crds/dittoservers.yaml
autonomous: true

must_haves:
  truths:
    - "DittoServer CRD has no spec.nfsPort or spec.smb fields"
    - "Operator does not emit adapter sections in generated DittoFS YAML config"
    - "Static -file Service is no longer created or reconciled"
    - "Headless Service uses API port (8080) instead of NFS port"
    - "Static NFS and SMB container ports are no longer emitted in the StatefulSet"
    - "NFSEndpoint status field is removed"
    - "Webhook validation no longer references NFS or SMB port fields"
    - "All existing tests pass after field removal"
  artifacts:
    - path: "k8s/dittofs-operator/api/v1alpha1/dittoserver_types.go"
      provides: "CRD spec without NFSPort and SMB fields"
      contains: "DittoServerSpec struct"
    - path: "k8s/dittofs-operator/internal/controller/dittoserver_controller.go"
      provides: "Controller without static adapter logic"
      min_lines: 900
  key_links:
    - from: "k8s/dittofs-operator/internal/controller/dittoserver_controller.go"
      to: "buildContainerPorts"
      via: "Only emits api + metrics ports, no static nfs/smb"
      pattern: "buildContainerPorts"
    - from: "k8s/dittofs-operator/internal/controller/dittoserver_controller.go"
      to: "reconcileHeadlessService"
      via: "Uses getAPIPort instead of nfs.GetNFSPort"
      pattern: "getAPIPort.*dittoServer"
---

<objective>
Remove static adapter fields (spec.nfsPort, spec.smb) from the DittoServer CRD, delete the -file Service, update the headless Service to use the API port, and clean up all associated code. After this plan, adapter configuration is entirely dynamic via the REST API.

Purpose: Satisfies SECU-01 (static fields removed) and SECU-02 (no adapter config in generated YAML). Eliminates the legacy static adapter approach now that Phase 3 provides dynamic per-adapter Services and container ports.
Output: Updated CRD types, controller, webhook, regenerated CRD manifests, deleted utility packages.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-security-hardening/04-RESEARCH.md
@k8s/dittofs-operator/api/v1alpha1/dittoserver_types.go
@k8s/dittofs-operator/api/v1alpha1/dittoserver_types_builder.go
@k8s/dittofs-operator/api/v1alpha1/dittoserver_webhook.go
@k8s/dittofs-operator/api/v1alpha1/helpers.go
@k8s/dittofs-operator/internal/controller/dittoserver_controller.go
@k8s/dittofs-operator/internal/controller/dittoserver_controller_test.go
@k8s/dittofs-operator/internal/controller/service_reconciler.go
@k8s/dittofs-operator/utils/nfs/nfs.go
@k8s/dittofs-operator/utils/smb/smb.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove static adapter fields from CRD types and builder</name>
  <files>
    k8s/dittofs-operator/api/v1alpha1/dittoserver_types.go
    k8s/dittofs-operator/api/v1alpha1/dittoserver_types_builder.go
  </files>
  <action>
In `dittoserver_types.go`:
1. Remove the `NFSPort *int32` field from `DittoServerSpec` (lines 56-60, including the kubebuilder comments).
2. Remove the `SMB *SMBAdapterSpec` field from `DittoServerSpec` (lines 62-64, including the kubebuilder comments).
3. Remove the entire `SMBAdapterSpec` struct definition (lines 177-214).
4. Remove the entire `SMBTimeoutsSpec` struct definition (lines 216-237).
5. Remove the entire `SMBCreditsSpec` struct definition (lines 239-288).
6. Remove the `NFSEndpoint string` field from `DittoServerStatus` (lines 390-392, including the comment).

In `dittoserver_types_builder.go`:
1. Remove `WithNFSPort` function (lines 96-101).
2. Remove `WithSMB` function (lines 103-108).
3. Remove `WithNFSEndpoint` function (lines 149-154).

Do NOT remove S3, Percona, Identity, AdapterDiscovery, AdapterServices, or any other fields -- only NFSPort, SMB (and its sub-types), and NFSEndpoint.
  </action>
  <verify>
Run `go build ./...` from `k8s/dittofs-operator/` -- expect compilation errors from references to removed fields. These will be fixed in Task 2. At this stage, verify the types file and builder file have the correct removals by reading them.
  </verify>
  <done>
DittoServerSpec has no NFSPort or SMB fields. DittoServerStatus has no NFSEndpoint field. SMBAdapterSpec, SMBTimeoutsSpec, and SMBCreditsSpec types are gone. Builder functions WithNFSPort, WithSMB, WithNFSEndpoint are gone.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove all static adapter references from controller, webhook, utils, and tests</name>
  <files>
    k8s/dittofs-operator/internal/controller/dittoserver_controller.go
    k8s/dittofs-operator/internal/controller/dittoserver_controller_test.go
    k8s/dittofs-operator/api/v1alpha1/dittoserver_webhook.go
    k8s/dittofs-operator/utils/nfs/nfs.go
    k8s/dittofs-operator/utils/smb/smb.go
  </files>
  <action>
This task systematically removes all code referencing the deleted fields. Use the Go compiler as a guide: after Task 1 removed the fields, `go build` will show every broken reference.

**In `dittoserver_controller.go`:**

1. Remove the `nfs` and `smb` import lines:
   - `"github.com/marmos91/dittofs/k8s/dittofs-operator/utils/nfs"`
   - `"github.com/marmos91/dittofs/k8s/dittofs-operator/utils/smb"`

2. **Remove the entire `reconcileFileService()` function** (~25 lines, starting at `func (r *DittoServerReconciler) reconcileFileService`). The static `-file` Service is replaced by per-adapter Services from Phase 3.

3. **Remove the `reconcileFileService` call from `Reconcile()`** (the `if err := r.reconcileFileService(ctx, dittoServer)` block around line 182-187).

4. **Update `reconcileHeadlessService()`**: Replace the NFS port usage with the API port. Change:
   - Remove `nfsPort := nfs.GetNFSPort(dittoServer)` line
   - Change `.AddTCPPort("nfs", nfsPort)` to `.AddTCPPort("api", getAPIPort(dittoServer))`
   The headless Service only needs a port for StatefulSet DNS resolution; the API port is always available.

5. **Update `buildContainerPorts()`**: Remove static NFS and SMB ports. The function should ONLY return the API port, and optionally the metrics port. Remove:
   - The `nfsPort := nfs.GetNFSPort(dittoServer)` line and the NFS port entry from the initial `ports` slice
   - The SMB port `if` block (`if dittoServer.Spec.SMB != nil && dittoServer.Spec.SMB.Enabled`)
   - Start the `ports` slice with the API port as the first entry instead of NFS
   Dynamic adapter ports are handled by `reconcileContainerPorts()` in `service_reconciler.go`.

6. **Update `updateStatus()`**: Remove the `NFSEndpoint` line:
   - Delete `dittoServerCopy.Status.NFSEndpoint = fmt.Sprintf(...)` (line 337-338)

**In `dittoserver_webhook.go`:**

1. Remove the `defaultNFSPort` and `defaultSMBPort` constants (lines 25, 27). Keep `defaultAPIPort` and `defaultMetricsPort`.

2. In `validateDittoServer()`: Remove the NFS port range validation block (lines 99-104, the `if r.Spec.NFSPort != nil` block). Remove the SMB port range validation block (lines 106-111, the `if r.Spec.SMB != nil` block).

3. In `validatePorts()`: Remove `portOrDefault(r.Spec.NFSPort, defaultNFSPort)` from the initial `ports` map. Start the ports map with only the API port. Remove the SMB port uniqueness check (the `if r.Spec.SMB != nil` block, lines 143-147).

**Delete utility packages:**

1. Delete `k8s/dittofs-operator/utils/nfs/nfs.go` (entire file -- the package becomes empty).
2. Delete `k8s/dittofs-operator/utils/smb/smb.go` (entire file -- all functions reference removed CRD fields).
3. Remove the `utils/nfs/` and `utils/smb/` directories if they are now empty.

**In `dittoserver_controller_test.go`:**

1. Find and remove the assertion checking `NFSEndpoint` (around line 666-668): remove the `if dittoServer.Status.NFSEndpoint == ""` block.

**After all changes, run:**
```bash
cd k8s/dittofs-operator && go build ./...
```
The build MUST succeed with zero errors. If there are remaining references, trace and fix them.

**Then regenerate CRD manifests and deepcopy:**
```bash
cd k8s/dittofs-operator && make generate manifests
```
This updates `zz_generated.deepcopy.go` and `config/crd/bases/dittofs.dittofs.com_dittoservers.yaml`.

**Then copy the updated CRD to the Helm chart:**
```bash
cp k8s/dittofs-operator/config/crd/bases/dittofs.dittofs.com_dittoservers.yaml k8s/dittofs-operator/chart/crds/dittoservers.yaml
```

**Then run tests:**
```bash
cd k8s/dittofs-operator && go test ./...
```
All tests MUST pass.
  </action>
  <verify>
```bash
cd k8s/dittofs-operator && go build ./... && go test ./...
```
Both commands pass with zero errors and zero test failures. Additionally:
- `grep -r "NFSPort\|nfsPort\|GetNFSPort\|GetSMBPort\|reconcileFileService\|NFSEndpoint\|nfsEndpoint" k8s/dittofs-operator/ --include="*.go"` returns NO matches (only comments are acceptable).
- `grep -r "utils/nfs\|utils/smb" k8s/dittofs-operator/ --include="*.go"` returns NO matches.
- The files `k8s/dittofs-operator/utils/nfs/nfs.go` and `k8s/dittofs-operator/utils/smb/smb.go` do not exist.
  </verify>
  <done>
All static adapter references are removed. `go build ./...` succeeds. `go test ./...` passes. The utils/nfs and utils/smb packages are deleted. CRD manifests and deepcopy are regenerated. The Helm chart CRD is updated.
  </done>
</task>

</tasks>

<verification>
1. `cd k8s/dittofs-operator && go build ./...` -- zero compilation errors
2. `cd k8s/dittofs-operator && go test ./...` -- all tests pass
3. `grep -rn "NFSPort\|spec.nfsPort\|spec.smb\|NFSEndpoint\|nfsEndpoint" k8s/dittofs-operator/api/ k8s/dittofs-operator/internal/ --include="*.go"` -- no matches (only YAML/comments acceptable)
4. `grep -rn "utils/nfs\|utils/smb" k8s/dittofs-operator/ --include="*.go"` -- no matches
5. `ls k8s/dittofs-operator/utils/nfs/ k8s/dittofs-operator/utils/smb/` -- directories do not exist
6. Config generation (`config.go`) has no adapter sections (already true, but verify no regressions)
</verification>

<success_criteria>
- SECU-01: `spec.nfsPort` and `spec.smb` fields do not exist in `dittoserver_types.go`
- SECU-02: `config.go` generates infrastructure-only YAML (no adapter config) -- already satisfied, verified no regression
- Static `-file` Service is no longer created
- Headless Service uses API port (8080)
- `buildContainerPorts()` emits only `api` and optionally `metrics` ports
- NFSEndpoint removed from DittoServerStatus
- All Go code compiles and all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-security-hardening/04-01-SUMMARY.md`
</output>
