---
phase: 33-smb3-dialect-negotiation-preauth-integrity
plan: 03
type: execute
wave: 3
depends_on:
  - 33-01
  - 33-02
files_modified:
  - internal/adapter/smb/v2/handlers/ioctl_dispatch.go
  - internal/adapter/smb/v2/handlers/ioctl_validate_negotiate.go
  - internal/adapter/smb/v2/handlers/ioctl_validate_negotiate_test.go
  - internal/adapter/smb/v2/handlers/stub_handlers.go
  - internal/adapter/smb/v2/handlers/session_setup.go
  - internal/adapter/smb/v2/handlers/tree_connect.go
  - internal/adapter/smb/v2/handlers/create.go
  - internal/adapter/smb/v2/handlers/close.go
  - internal/adapter/smb/v2/handlers/read.go
  - internal/adapter/smb/v2/handlers/write.go
  - internal/adapter/smb/v2/handlers/query_info.go
  - internal/adapter/smb/v2/handlers/set_info.go
  - internal/adapter/smb/v2/handlers/query_directory.go
  - internal/adapter/smb/v2/handlers/logoff.go
  - internal/adapter/smb/v2/handlers/echo.go
  - internal/adapter/smb/v2/handlers/flush.go
  - internal/adapter/smb/v2/handlers/lock.go
  - pkg/controlplane/models/adapter_settings.go
autonomous: true
requirements:
  - SDIAL-01
  - ARCH-02
  - NEG-01
  - NEG-03

must_haves:
  truths:
    - "FSCTL_VALIDATE_NEGOTIATE_INFO validates all 4 fields (Capabilities, ServerGUID, SecurityMode, Dialect) against ConnectionCryptoState"
    - "FSCTL_VALIDATE_NEGOTIATE_INFO on SMB 3.1.1 connection drops TCP connection without response"
    - "IOCTL dispatch uses map-based dispatch table instead of switch statement"
    - "All existing SMB handlers use smbenc codec for binary encoding/decoding (no raw binary.LittleEndian calls in handlers)"
    - "SMB internal package contains only protocol encoding/decoding/framing with no business logic"
    - "SMBAdapterSettings has DirectoryLeasingEnabled field for capability configuration"
  artifacts:
    - path: "internal/adapter/smb/v2/handlers/ioctl_dispatch.go"
      provides: "Map-based IOCTL dispatch table"
      exports: ["IOCTLHandler", "ioctlDispatch"]
    - path: "internal/adapter/smb/v2/handlers/ioctl_validate_negotiate.go"
      provides: "VALIDATE_NEGOTIATE_INFO handler reading from CryptoState"
      min_lines: 50
    - path: "internal/adapter/smb/v2/handlers/stub_handlers.go"
      provides: "Refactored IOCTL handler using dispatch table (handleValidateNegotiateInfo extracted)"
  key_links:
    - from: "internal/adapter/smb/v2/handlers/ioctl_validate_negotiate.go"
      to: "internal/adapter/smb/crypto_state.go"
      via: "Reads negotiate params from CryptoState instead of re-computing"
      pattern: "CryptoState\\.Server|CryptoState\\.Dialect"
    - from: "internal/adapter/smb/v2/handlers/ioctl_dispatch.go"
      to: "internal/adapter/smb/v2/handlers/ioctl_validate_negotiate.go"
      via: "Dispatch table maps FsctlValidateNegotiateInfo to handler"
      pattern: "FsctlValidateNegotiateInfo.*handleValidateNegotiateInfo"
---

<objective>
Extract IOCTL dispatch table, refactor VALIDATE_NEGOTIATE_INFO to use CryptoState, migrate all handlers to smbenc codec, and enforce ARCH-02 boundary.

Purpose: Completes Phase 33 by implementing secure dialect validation (SDIAL-01), enforcing clean protocol boundaries (ARCH-02), and ensuring all handlers use the new smbenc codec consistently. The IOCTL dispatch table follows the same map-based pattern as the main command dispatch, and VALIDATE_NEGOTIATE_INFO reads from CryptoState instead of duplicating negotiate logic.

Output: Refactored IOCTL handling, all handlers using smbenc, ARCH-02 compliance.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-smb3-dialect-negotiation-preauth-integrity/33-CONTEXT.md
@.planning/phases/33-smb3-dialect-negotiation-preauth-integrity/33-RESEARCH.md
@.planning/phases/33-smb3-dialect-negotiation-preauth-integrity/33-01-SUMMARY.md
@.planning/phases/33-smb3-dialect-negotiation-preauth-integrity/33-02-SUMMARY.md

<interfaces>
<!-- From Plan 01 and 02 outputs -->

From internal/adapter/smb/smbenc/reader.go:
```go
func NewReader(data []byte) *Reader
// All Read/Skip/Expect/EnsureRemaining methods
```

From internal/adapter/smb/smbenc/writer.go:
```go
func NewWriter(capacity int) *Writer
// All Write/Pad/WriteAt methods
```

From internal/adapter/smb/crypto_state.go:
```go
type ConnectionCryptoState struct {
    Dialect            types.Dialect
    CipherId           uint16
    SigningAlgorithmId  uint16
    ServerGUID         [16]byte
    ServerCapabilities uint32
    ServerSecurityMode uint16
    ClientCapabilities uint32
    ClientGUID         [16]byte
    ClientSecurityMode uint16
    ClientDialects     []uint16
    PreauthIntegrityHashId uint16
    // ... hash fields
}
```

From internal/adapter/smb/v2/handlers/context.go:
```go
type SMBHandlerContext struct {
    Context     context.Context
    ClientAddr  string
    SessionID   uint64
    TreeID      uint32
    MessageID   uint64
    ShareName   string
    IsGuest     bool
    Username    string
    Domain      string
    User        *models.User
    Permission  models.SharePermission
    AsyncNotifyCallback AsyncResponseCallback
    CryptoState *smb.ConnectionCryptoState  // Added in Plan 02
}
```

From internal/adapter/smb/v2/handlers/result.go:
```go
type HandlerResult struct {
    Data           []byte
    Status         types.Status
    DropConnection bool  // Added in Plan 02
}
```

From internal/adapter/smb/v2/handlers/stub_handlers.go:
```go
// Current IOCTL handler with switch statement -- to be refactored
func (h *Handler) Ioctl(ctx *SMBHandlerContext, body []byte) (*HandlerResult, error)
// Current handleValidateNegotiateInfo -- to be extracted
func (h *Handler) handleValidateNegotiateInfo(ctx *SMBHandlerContext, body []byte) (*HandlerResult, error)
```
</interfaces>
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: IOCTL dispatch table and VALIDATE_NEGOTIATE_INFO refactor</name>
  <files>
    internal/adapter/smb/v2/handlers/ioctl_dispatch.go,
    internal/adapter/smb/v2/handlers/ioctl_validate_negotiate.go,
    internal/adapter/smb/v2/handlers/ioctl_validate_negotiate_test.go,
    internal/adapter/smb/v2/handlers/stub_handlers.go
  </files>
  <behavior>
    IOCTL dispatch table:
    - Map[uint32]IOCTLHandler where IOCTLHandler = func(h *Handler, ctx *SMBHandlerContext, body []byte) (*HandlerResult, error)
    - Populated in init() with all existing FSCTL handlers
    - Ioctl() method looks up ctlCode in dispatch table, calls handler or returns STATUS_NOT_SUPPORTED
    - Existing IOCTL switch statement replaced by table lookup
    VALIDATE_NEGOTIATE_INFO:
    - For 3.1.1 connections: drop TCP connection (DropConnection=true), log WARN with client IP
    - For 3.0/3.0.2: validate all 4 fields against ConnectionCryptoState (not re-compute)
    - Capabilities match: CryptoState.ServerCapabilities == clientCapabilities
    - ServerGUID match: CryptoState.ServerGUID == clientGUID
    - SecurityMode match: CryptoState.ServerSecurityMode == clientSecurityMode
    - Dialect match: CryptoState.Dialect == selectedDialect (re-select from client dialects using same algorithm)
    - On mismatch: log WARN with mismatch details + client IP, drop TCP connection (DropConnection=true)
    - On success: return 24-byte response with server Capabilities, GUID, SecurityMode, Dialect
    - Uses smbenc for all binary encoding/decoding
  </behavior>
  <action>
    **1. Create IOCTL dispatch table** in `internal/adapter/smb/v2/handlers/ioctl_dispatch.go`:
    - Define `IOCTLHandler` type: `func(h *Handler, ctx *SMBHandlerContext, body []byte) (*HandlerResult, error)`
    - Package-level `ioctlDispatch map[uint32]IOCTLHandler`
    - `init()` populates the map with all existing FSCTL handlers:
      - FsctlValidateNegotiateInfo -> handleValidateNegotiateInfo (from new file)
      - FsctlGetReparsePoint -> handleGetReparsePoint (stays in stub_handlers.go)
      - FsctlSrvEnumerateSnapshots -> handleEnumerateSnapshots (inline or stays)
      - FsctlPipeTransceive -> handlePipeTransceive (stays in stub_handlers.go)
      - FsctlGetNtfsVolumeData -> handleGetNtfsVolumeData (stays)
      - FsctlReadFileUsnData -> handleReadFileUsnData (stays)
    - Note: Some handlers need to become package-level functions instead of methods to fit the IOCTLHandler signature, OR keep them as methods and adapt. Best approach: keep them as methods on Handler (they already are), and use the signature `func(h *Handler, ctx *SMBHandlerContext, body []byte) (*HandlerResult, error)`. The handler methods already have receiver `h *Handler`, so wrap them in the dispatch table.

    **2. Refactor Ioctl()** in `internal/adapter/smb/v2/handlers/stub_handlers.go`:
    - Replace the switch statement with dispatch table lookup:
      ```go
      handler, ok := ioctlDispatch[ctlCode]
      if !ok {
          return NewErrorResult(types.StatusNotSupported), nil
      }
      return handler(h, ctx, body)
      ```
    - Keep the ctlCode parsing and logging

    **3. Extract VALIDATE_NEGOTIATE_INFO** to `internal/adapter/smb/v2/handlers/ioctl_validate_negotiate.go`:
    - Remove handleValidateNegotiateInfo from stub_handlers.go
    - Create new file with the handler
    - Use smbenc for parsing the request and building the response
    - Read validation values from `ctx.CryptoState` instead of re-computing
    - For dialect = 3.1.1: immediately return DropConnection=true per MS-SMB2 section 3.3.5.15.12
    - For 3.0/3.0.2: validate all 4 fields
    - On any mismatch: log WARN with specific field that mismatched, return DropConnection=true
    - On success: return 24-byte response using smbenc Writer
    - Parse request using smbenc Reader: Capabilities(4), ClientGUID(16), SecurityMode(2), DialectCount(2), Dialects(2*N)

    **4. Tests** in `internal/adapter/smb/v2/handlers/ioctl_validate_negotiate_test.go`:
    - Test VNEG on 3.1.1 connection -> DropConnection
    - Test VNEG on 3.0 connection, matching params -> success response with correct values
    - Test VNEG on 3.0.2 connection, mismatched capabilities -> DropConnection
    - Test VNEG on 3.0 connection, mismatched GUID -> DropConnection
    - Test VNEG on 3.0 connection, mismatched SecurityMode -> DropConnection
    - Test VNEG on 3.0 connection, mismatched dialect -> DropConnection
    - Test VNEG success response contains correct CryptoState values
    - Test IOCTL dispatch table routes correctly
    - Build test payloads using smbenc Writer per CONTEXT.md decision
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs-phase-30 && go test ./internal/adapter/smb/v2/handlers/ -v -count=1 -run "ValidateNeg|Ioctl"</automated>
  </verify>
  <done>
    IOCTL uses map-based dispatch table. VALIDATE_NEGOTIATE_INFO reads from CryptoState. 3.1.1 connections drop on VNEG. 3.0/3.0.2 validate all 4 fields. Mismatches drop connection. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate all handlers to smbenc codec and enforce ARCH-02</name>
  <files>
    internal/adapter/smb/v2/handlers/session_setup.go,
    internal/adapter/smb/v2/handlers/tree_connect.go,
    internal/adapter/smb/v2/handlers/create.go,
    internal/adapter/smb/v2/handlers/close.go,
    internal/adapter/smb/v2/handlers/read.go,
    internal/adapter/smb/v2/handlers/write.go,
    internal/adapter/smb/v2/handlers/query_info.go,
    internal/adapter/smb/v2/handlers/set_info.go,
    internal/adapter/smb/v2/handlers/query_directory.go,
    internal/adapter/smb/v2/handlers/logoff.go,
    internal/adapter/smb/v2/handlers/echo.go,
    internal/adapter/smb/v2/handlers/flush.go,
    internal/adapter/smb/v2/handlers/lock.go,
    internal/adapter/smb/v2/handlers/stub_handlers.go,
    pkg/controlplane/models/adapter_settings.go
  </files>
  <action>
    **1. Migrate ALL existing handlers to use smbenc codec** per CONTEXT.md locked decision:
    "Refactor ALL existing SMB handlers (negotiate, session_setup, etc.) to use the codec -- not just new SMB3 code"

    For each handler file, replace `binary.LittleEndian.Uint16/32/64` reads with `smbenc.NewReader` and `binary.LittleEndian.PutUint16/32/64` writes with `smbenc.NewWriter`. This is a mechanical refactor:

    **session_setup.go**: Replace request parsing and response building with smbenc Reader/Writer.
    **tree_connect.go**: Replace request parsing (path extraction) and response building.
    **create.go**: Replace request parsing (file name, create options, create contexts) and response building.
    **close.go**: Replace request parsing and response building.
    **read.go**: Replace request parsing and response building.
    **write.go**: Replace request parsing and response building.
    **query_info.go**: Replace request/response binary encoding.
    **set_info.go**: Replace request parsing.
    **query_directory.go**: Replace request parsing and response building.
    **logoff.go**: Replace request parsing and response building (already simple).
    **echo.go**: Replace request/response encoding.
    **flush.go**: Replace request parsing and response building.
    **lock.go**: Replace request parsing and response building.
    **stub_handlers.go**: Replace remaining IOCTL handlers' binary encoding (handleGetReparsePoint, buildSymlinkReparseBuffer, buildIoctlResponse, handleGetNtfsVolumeData, handleReadFileUsnData, handlePipeTransceive) with smbenc.

    Guidelines for migration:
    - Replace `if len(body) < N` bounds checks with smbenc.EnsureRemaining(N) at the start
    - Replace `binary.LittleEndian.Uint16(body[offset:])` with `r.ReadUint16()` (sequential reads)
    - Replace `binary.LittleEndian.PutUint16(buf[offset:], val)` with `w.WriteUint16(val)`
    - Check `r.Err()` after parsing, return StatusInvalidParameter if error
    - Check `w.Err()` after building, return StatusInternalError if error
    - Keep the same logic and behavior -- this is purely a codec migration, not a logic change
    - Do NOT change any business logic, error handling semantics, or protocol behavior
    - For handlers that use `Decode*Request` pattern (logoff, close, flush, etc.), migrate the Decode functions too

    **2. ARCH-02 audit**:
    After migration, verify no `encoding/binary` direct usage remains in handler files:
    - `grep -r "encoding/binary" internal/adapter/smb/v2/handlers/` should return zero results
    - All binary encoding/decoding goes through smbenc
    - Verify no business logic exists in handlers (permission checks, share resolution, state management should all be in runtime/metadata layer). The handlers should only:
      1. Parse request using smbenc
      2. Call runtime/metadata methods
      3. Build response using smbenc
    - If any business logic is found in handlers, note it but don't move it in this plan (that would be scope creep; document for future cleanup)

    **3. Add DirectoryLeasingEnabled** to SMBAdapterSettings:
    - Add `DirectoryLeasingEnabled bool` field with `gorm:"default:true"` tag
    - Update NewDefaultSMBSettings to set DirectoryLeasingEnabled=true
    - This field is read by the negotiate handler (from Plan 02) for capability gating

    **4. Add SMB 3.0.2 dialect string**:
    - The existing ValidSMBDialects = ["SMB2.0", "SMB2.1", "SMB3.0", "SMB3.1.1"] is missing "SMB3.0.2"
    - Add "SMB3.0.2" to ValidSMBDialects
    - Ensure dialect string parsing maps "SMB3.0.2" -> Dialect0302

    **5. Update existing handler tests** per CONTEXT.md:
    "Update existing handler tests to use codec for building test payloads"
    - For the test files that directly construct binary payloads (negotiate_test.go already updated in Plan 02), update stub_handlers_test.go, session_setup_test.go, tree_connect_test.go, and any other test files that build wire-format test data manually

    Note: This is a large but mechanical task. Each handler migration follows the exact same pattern. The key risk is regression -- ensure all existing tests continue to pass after migration.
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs-phase-30 && go test ./internal/adapter/smb/... ./pkg/adapter/smb/... -count=1 -timeout 5m && go vet ./internal/adapter/smb/... ./pkg/adapter/smb/...</automated>
  </verify>
  <done>
    All handlers use smbenc for binary encoding/decoding. No direct encoding/binary usage in handler files. IOCTL dispatch table working. VALIDATE_NEGOTIATE_INFO reads from CryptoState. DirectoryLeasingEnabled added to SMBAdapterSettings. SMB3.0.2 dialect string added. All tests pass. ARCH-02 boundary enforced.
  </done>
</task>

</tasks>

<verification>
```bash
# All handler tests pass after migration
cd /Users/marmos91/Projects/dittofs-phase-30
go test ./internal/adapter/smb/... -v -count=1 -timeout 5m
go test ./pkg/adapter/smb/... -v -count=1

# ARCH-02: No direct encoding/binary in handlers
grep -r "encoding/binary" internal/adapter/smb/v2/handlers/ | grep -v "_test.go" | grep -v "// " || echo "ARCH-02 PASS: no encoding/binary in handlers"

# Full build and test suite
go build ./...
go test ./... -count=1 -timeout 10m
go vet ./...
```
</verification>

<success_criteria>
1. FSCTL_VALIDATE_NEGOTIATE_INFO validates all 4 fields from CryptoState (not re-computed)
2. VNEG on 3.1.1 drops TCP connection per spec
3. VNEG mismatch drops connection with WARN log
4. IOCTL uses map-based dispatch table
5. All handlers migrated to smbenc (no encoding/binary in handler files)
6. DirectoryLeasingEnabled field added to SMBAdapterSettings
7. SMB3.0.2 dialect string supported
8. All existing tests pass after migration
9. ARCH-02 boundary verified
</success_criteria>

<output>
After completion, create `.planning/phases/33-smb3-dialect-negotiation-preauth-integrity/33-03-SUMMARY.md`
</output>
