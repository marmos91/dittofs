---
phase: 32-windows-integration-testing
plan: 03
type: execute
wave: 2
depends_on:
  - 32-01
  - 32-02
files_modified:
  - docs/WINDOWS_TESTING.md
  - test/smb-conformance/KNOWN_FAILURES.md
autonomous: true
requirements:
  - WIN-09

must_haves:
  truths:
    - "A formal versioned validation checklist exists for Windows 11 testing"
    - "Windows VM setup guide documents how to configure a Windows 11 VM for DittoFS testing"
    - "Checklist covers Explorer, cmd.exe, PowerShell, Office, VS Code, and NFS client"
    - "Known limitations (no ADS, no Change Notify, no SMB3) are documented"
    - "KNOWN_FAILURES.md is updated to reflect current WPTS baseline status"
  artifacts:
    - path: "docs/WINDOWS_TESTING.md"
      provides: "Windows VM setup guide + formal validation checklist"
      min_lines: 100
      contains: "Explorer"
    - path: "test/smb-conformance/KNOWN_FAILURES.md"
      provides: "Updated WPTS known failures with current status"
      contains: "BVT"
  key_links:
    - from: "docs/WINDOWS_TESTING.md"
      to: "test/smb-conformance/"
      via: "References smbtorture and WPTS test infrastructure"
      pattern: "smbtorture|WPTS"
---

<objective>
Create a formal Windows 11 validation checklist and VM setup guide, and reconcile KNOWN_FAILURES.md with the current conformance test baseline from Phases 30-31.

Purpose: The validation checklist is a reusable template that grows with each milestone (v3.8, v4.0). It documents what works, what doesn't, and how to set up a Windows 11 VM for testing DittoFS. The KNOWN_FAILURES.md update ensures the WPTS baseline reflects fixes from Phases 30-31.

Output: docs/WINDOWS_TESTING.md (setup guide + checklist), updated test/smb-conformance/KNOWN_FAILURES.md.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-windows-integration-testing/32-CONTEXT.md
@.planning/phases/32-windows-integration-testing/32-01-SUMMARY.md
@.planning/phases/32-windows-integration-testing/32-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Windows VM setup guide and formal validation checklist</name>
  <files>
    docs/WINDOWS_TESTING.md
  </files>
  <action>
Create `docs/WINDOWS_TESTING.md` with the following structure:

**1. Header and version info:**
```markdown
# Windows Testing Guide

**Version:** 1.0 (v3.6 milestone)
**Last validated:** YYYY-MM-DD
**Windows version tested:** Windows 11 [version TBD during manual testing]
**DittoFS version:** [current git describe]
```

**2. Windows VM Setup Guide:**
Document how to set up a Windows 11 VM for testing DittoFS:

- **Option A: UTM (macOS ARM host)** -- UTM with Windows 11 ARM ISO, recommended for Apple Silicon Macs
- **Option B: VirtualBox/Hyper-V** -- standard x86 VM setup
- Network configuration: bridged networking so VM can reach host (or host-only network)
- Required Windows features: "Services for NFS" (for NFS client testing), already-installed SMB client
- Optional: Install VS Code, Microsoft Office (for extended app testing)
- **Guest auth GPO configuration:** Document that Windows 11 24H2 blocks insecure guest logons by default. To enable: `gpedit.msc` -> Computer Configuration -> Administrative Templates -> Network -> Lanman Workstation -> "Enable insecure guest logons" -> Enabled. Or registry: `HKLM\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters\AllowInsecureGuestAuth` = 1 (DWORD).
- DittoFS server setup: how to start DittoFS on the macOS/Linux host and connect from Windows VM

**3. SMB Validation Checklist:**
Formal checklist with pass/fail/skip columns. Per user decisions, test both mapped drives AND UNC paths.

Categories:
- **Connection:** `net use Z: \\host\smbbasic /user:wpts-admin TestPassword01!`, UNC path `\\host\smbbasic`
- **Explorer operations:** Create file, create folder, rename, delete, copy, move, drag-and-drop, view properties (Security tab)
- **cmd.exe operations:** dir, type, copy, move, ren, del, mkdir, rmdir, icacls, attrib, fsutil
- **PowerShell operations:** Get-Item, Set-Item, Get-ChildItem, New-Item, Remove-Item, Get-Acl, Set-Acl, Copy-Item, Move-Item
- **Office testing:** Word (create/save/reopen .docx), Excel (create/save/reopen .xlsx with formulas), save 10MB+ file
- **VS Code testing:** Open folder from share, create/edit/save files, Git operations if .git on share
- **File size testing:** 1MB, 10MB, 50MB, 100MB+ files (per user decision on realistic sizes)
- **NFS client testing:** Mount via Windows NFS client (`mount -o anon \\host\export Z:`), basic file operations, verify read/write

**4. Known Limitations Section:**
Per user decision, explicitly document what does NOT work:
- No Alternate Data Streams (ADS) -- NTFS streams not supported
- No Change Notify -- Explorer won't auto-refresh (manual F5 required)
- No SMB3 encryption/signing upgrade -- SMB 2.0.2/2.1 only
- No durable handles -- reconnection after network interruption not supported
- No server-side copy -- FSCTL_SRV_COPYCHUNK not implemented
- NFS from Windows may have limited functionality (best-effort per user decision)

**5. Troubleshooting Section:**
Common issues and solutions:
- "Access denied" -> Check share permissions, verify user credentials
- Explorer shows "Everyone: Full Control" -> Verify Phase 31 SD synthesis is working
- "Cannot connect" -> Check firewall, verify port 12445/445 is accessible
- NFS mount fails -> Ensure Services for NFS feature is enabled in Windows features

**6. Conformance Test Results Section:**
Reference to WPTS and smbtorture test suites with links to KNOWN_FAILURES.md files:
- WPTS BVT baseline: X/240 passing (link to test/smb-conformance/KNOWN_FAILURES.md)
- smbtorture baseline: Y tests passing (link to test/smb-conformance/smbtorture/KNOWN_FAILURES.md)
- How to run conformance tests locally
  </action>
  <verify>
    <automated>test -f /Users/marmos91/Projects/dittofs-phase-30/docs/WINDOWS_TESTING.md && wc -l /Users/marmos91/Projects/dittofs-phase-30/docs/WINDOWS_TESTING.md | awk '{if ($1 >= 100) print "OK: "$1" lines"; else print "FAIL: only "$1" lines"}'</automated>
  </verify>
  <done>
    - docs/WINDOWS_TESTING.md exists with 100+ lines
    - Windows VM setup guide covers UTM/VirtualBox, networking, guest auth GPO
    - Validation checklist covers Explorer, cmd.exe, PowerShell, Office, VS Code, NFS
    - Both mapped drives and UNC paths documented in checklist
    - Known limitations section lists no-ADS, no-Change-Notify, no-SMB3
    - Troubleshooting section covers common connection and permission issues
    - File size testing with realistic sizes (1-100MB+) included
  </done>
</task>

<task type="auto">
  <name>Task 2: Update WPTS KNOWN_FAILURES.md with current baseline</name>
  <files>
    test/smb-conformance/KNOWN_FAILURES.md
  </files>
  <action>
Update the existing `test/smb-conformance/KNOWN_FAILURES.md` to reflect the current state after Phases 30-31 fixes:

**1. Review current entries:**
Read the existing KNOWN_FAILURES.md. It was created in Phase 29.8 with initial expected failures.

**2. Update status of entries that may have been fixed:**
Phases 30-31 added:
- Sparse file READ fix (BUG-01) -- may fix some WPTS tests
- Renamed directory listing fix (BUG-02) -- may fix QueryDirectory tests
- Parent dir navigation fix (BUG-03) -- may fix path traversal tests
- Security Descriptor synthesis (SD-01 through SD-08) -- may fix ACL-related tests
- Oplock break wiring (BUG-04) -- may fix oplock tests
- NumberOfLinks fix (BUG-05) -- may fix FileStandardInfo tests

**3. Add notes about new protocol support:**
Phase 32 Plan 01 adds:
- MxAc create context -- may fix tests expecting maximal access
- QFid create context -- may fix tests expecting on-disk ID
- FileCompressionInformation handler -- may fix compression info queries
- FileAttributeTagInformation handler -- may fix attribute tag queries
- Updated capability flags -- may affect FileFsAttributeInformation tests

**4. Update the "Last updated" timestamp and add Phase 30-32 notes.**

**5. Add a "Changelog" section at the bottom:**
```markdown
## Changelog

- v3.6 Phase 32: Updated baseline after bug fixes, ACL support, and protocol enhancements
- v3.6 Phase 29.8: Initial baseline (133/240 BVT tests passing)
```

Do NOT invent specific test names or pass/fail counts -- document what was fixed and note that the baseline should be re-measured after running the full suite. Mark entries as "Potentially fixed" where applicable.
  </action>
  <verify>
    <automated>test -f /Users/marmos91/Projects/dittofs-phase-30/test/smb-conformance/KNOWN_FAILURES.md && grep -q "Phase 32" /Users/marmos91/Projects/dittofs-phase-30/test/smb-conformance/KNOWN_FAILURES.md && grep -q "Changelog" /Users/marmos91/Projects/dittofs-phase-30/test/smb-conformance/KNOWN_FAILURES.md</automated>
  </verify>
  <done>
    - KNOWN_FAILURES.md updated with Phase 30-32 fix notes
    - Entries that may be fixed by bug fixes/ACL support marked as "Potentially fixed"
    - Changelog section documents baseline evolution
    - No fabricated test names or pass/fail counts
    - Timestamp updated
  </done>
</task>

</tasks>

<verification>
1. docs/WINDOWS_TESTING.md exists with comprehensive setup guide and checklist
2. test/smb-conformance/KNOWN_FAILURES.md updated with current status
3. Both documents reference each other and the smbtorture infrastructure
4. No broken markdown formatting
</verification>

<success_criteria>
- Formal versioned validation checklist ready for Phase 32.5 manual testing
- Windows VM setup guide enables any developer to set up a test environment
- Both mapped drives and UNC paths covered in checklist
- Office + VS Code testing documented (per user decision)
- Known limitations explicitly documented (no ADS, no Change Notify, no SMB3)
- KNOWN_FAILURES.md reflects current state after v3.6 fixes
- Documents are reusable and extensible for future milestones
</success_criteria>

<output>
After completion, create `.planning/phases/32-windows-integration-testing/32-03-SUMMARY.md`
</output>
