---
phase: 32-windows-integration-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - test/smb-conformance/docker-compose.yml
  - test/smb-conformance/smbtorture/run.sh
  - test/smb-conformance/smbtorture/parse-results.sh
  - test/smb-conformance/smbtorture/KNOWN_FAILURES.md
  - test/smb-conformance/smbtorture/Makefile
  - test/smb-conformance/Makefile
  - .github/workflows/smb-conformance.yml
autonomous: true
requirements:
  - TEST-01
  - TEST-02
  - TEST-03

must_haves:
  truths:
    - "smbtorture runs the full smb2 suite against DittoFS in a Docker container"
    - "smbtorture results are parsed into pass/fail/skip counts with known-failure classification"
    - "CI runs smbtorture alongside WPTS in the same workflow with unified artifacts"
    - "KNOWN_FAILURES.md documents baseline pass/fail status for smbtorture tests"
    - "GPL compliance maintained -- smbtorture only accessed via Docker container boundary"
  artifacts:
    - path: "test/smb-conformance/smbtorture/run.sh"
      provides: "smbtorture orchestrator script"
      min_lines: 50
    - path: "test/smb-conformance/smbtorture/parse-results.sh"
      provides: "smbtorture output parser with known-failure classification"
      min_lines: 30
    - path: "test/smb-conformance/smbtorture/KNOWN_FAILURES.md"
      provides: "Baseline known failures for smbtorture"
      contains: "smb2"
    - path: "test/smb-conformance/smbtorture/Makefile"
      provides: "Local dev convenience targets"
      contains: "smbtorture"
    - path: ".github/workflows/smb-conformance.yml"
      provides: "CI workflow with smbtorture job alongside WPTS"
      contains: "smbtorture"
  key_links:
    - from: "test/smb-conformance/smbtorture/run.sh"
      to: "test/smb-conformance/docker-compose.yml"
      via: "docker compose --profile smbtorture"
      pattern: "docker.*compose.*smbtorture"
    - from: ".github/workflows/smb-conformance.yml"
      to: "test/smb-conformance/smbtorture/run.sh"
      via: "CI job executing run.sh"
      pattern: "smbtorture/run.sh"
    - from: "test/smb-conformance/smbtorture/run.sh"
      to: "test/smb-conformance/smbtorture/parse-results.sh"
      via: "Result parsing after test execution"
      pattern: "parse-results"
---

<objective>
Integrate Samba smbtorture SMB2 test suite into the existing SMB conformance infrastructure, running the full smb2.* suite against DittoFS in a Docker-isolated container to establish a conformance baseline.

Purpose: smbtorture tests real SMB client behavior (complementing WPTS wire-protocol conformance). The baseline documents current DittoFS compatibility with actual Samba client operations. Per user decisions, this is baseline documentation only -- fixing failures is deferred to v3.8.

Output: smbtorture Docker infrastructure, run/parse scripts, KNOWN_FAILURES.md baseline, CI workflow integration alongside WPTS.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-windows-integration-testing/32-RESEARCH.md
@.planning/phases/29.8-ms-protocol-test-suite-ci/29.8-02-SUMMARY.md

<interfaces>
<!-- Key infrastructure from Phase 29.8 that this plan mirrors -->

From test/smb-conformance/docker-compose.yml (existing):
- dittofs service with healthcheck, bootstrap.sh volume mount
- wpts service with profile-based activation
- Shared network for container-to-container communication
- Pattern: `network_mode: "service:dittofs"` for test runners

From test/smb-conformance/run.sh (existing WPTS pattern):
- Compose mode (fully containerized) and local mode
- --profile, --filter, --keep, --dry-run, --verbose flags
- Bootstrap DittoFS via docker compose exec
- Run test container and collect results

From test/smb-conformance/parse-results.sh (existing WPTS pattern):
- Classifies test outcomes as PASS/KNOWN/FAIL/SKIP
- Reads KNOWN_FAILURES.md to identify expected failures
- Exit code = count of NEW failures (0 = CI green)
- Color-coded output

From test/smb-conformance/KNOWN_FAILURES.md (existing WPTS pattern):
- Markdown table format: | Test Name | Category | Issue | Status |
- Parsed by parse-results.sh via pipe-separated field extraction

From .github/workflows/smb-conformance.yml (existing):
- Triggers on SMB adapter path changes
- Tiered matrix (memory on PRs, full on push/cron)
- Artifact upload for results
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: smbtorture Docker infrastructure and run script</name>
  <files>
    test/smb-conformance/docker-compose.yml
    test/smb-conformance/smbtorture/run.sh
  </files>
  <action>
**1. Add smbtorture service to docker-compose.yml:**
Add a new service under the existing `services:` section:
```yaml
smbtorture:
    image: quay.io/samba.org/samba-toolbox:v0.8
    platform: linux/amd64
    depends_on:
      dittofs:
        condition: service_healthy
    network_mode: "service:dittofs"
    entrypoint: ["smbtorture"]
    command:
      - "//localhost/smbbasic"
      - "-U"
      - "wpts-admin%TestPassword01!"
      - "--option=client min protocol=SMB2_02"
      - "--option=client max protocol=SMB3"
      - "smb2"
    profiles:
      - smbtorture
```

Notes:
- Use `network_mode: "service:dittofs"` so smbtorture sees DittoFS on localhost (same pattern as WPTS)
- `quay.io/samba.org/samba-toolbox:v0.8` per user decision (pinned tag, official Samba image)
- `platform: linux/amd64` since samba-toolbox may not have ARM images
- Default command runs full `smb2` suite per user decision
- Authentication matches bootstrap.sh user credentials
- Profile-based activation prevents automatic startup

**2. Create test/smb-conformance/smbtorture/run.sh:**
Mirror the structure of the existing `test/smb-conformance/run.sh` but for smbtorture:

```bash
#!/usr/bin/env bash
# smbtorture test runner for DittoFS SMB conformance
# GPL compliance: smbtorture runs inside Docker container only
```

Implement:
- `--profile` flag (default: memory) for DittoFS storage backend
- `--filter` flag for running specific smb2.* sub-tests
- `--keep` flag to keep containers running after test
- `--verbose` flag for detailed output
- `--dry-run` flag to show commands without executing

Flow:
1. Start DittoFS container with specified profile
2. Wait for healthcheck
3. Bootstrap DittoFS (exec bootstrap.sh inside container)
4. Run smbtorture container, capture output to results file
5. Parse results with parse-results.sh
6. Print summary and exit with appropriate code

Results directory: `test/smb-conformance/results/smbtorture-YYYY-MM-DD_HHMMSS/`
Output file: `smbtorture-output.txt` (raw smbtorture stdout/stderr)

The run script should:
- Use `docker compose run --rm smbtorture` to execute the test
- Override the command when --filter is provided to run specific tests
- Capture both stdout and stderr (smbtorture may write to either)
- Call `parse-results.sh` on the output file
- Return parse-results.sh exit code

Make the script executable (chmod +x).
  </action>
  <verify>
    <automated>test -f /Users/marmos91/Projects/dittofs-phase-30/test/smb-conformance/smbtorture/run.sh && test -x /Users/marmos91/Projects/dittofs-phase-30/test/smb-conformance/smbtorture/run.sh && bash -n /Users/marmos91/Projects/dittofs-phase-30/test/smb-conformance/smbtorture/run.sh && grep -q "smbtorture" /Users/marmos91/Projects/dittofs-phase-30/test/smb-conformance/docker-compose.yml</automated>
  </verify>
  <done>
    - docker-compose.yml has smbtorture service with pinned samba-toolbox:v0.8 image
    - smbtorture service uses network_mode: "service:dittofs" for localhost access
    - run.sh supports --profile, --filter, --keep, --verbose, --dry-run flags
    - run.sh captures output to timestamped results directory
    - Script is syntactically valid bash
  </done>
</task>

<task type="auto">
  <name>Task 2: Result parser, KNOWN_FAILURES.md, CI workflow, and Makefile</name>
  <files>
    test/smb-conformance/smbtorture/parse-results.sh
    test/smb-conformance/smbtorture/KNOWN_FAILURES.md
    test/smb-conformance/smbtorture/Makefile
    test/smb-conformance/Makefile
    .github/workflows/smb-conformance.yml
  </files>
  <action>
**1. Create test/smb-conformance/smbtorture/parse-results.sh:**

Parse smbtorture output to classify results. smbtorture outputs lines like:
```
success: smb2.connect.connect1
failure: smb2.lock.lock1 [STATUS_NOT_SUPPORTED at ...]
skip: smb2.multichannel.interface_info [not supported]
```

The parser should:
- Read the smbtorture output file from $1 argument
- Count lines matching `^success:`, `^failure:`, `^skip:` (or `^error:`)
- Also handle alternative formats: ` ok$`, ` FAILED`, ` SKIP` at end of lines
- Load KNOWN_FAILURES.md to classify failures as KNOWN or NEW
- Print colored summary: PASS (green), KNOWN (yellow), FAIL (red), SKIP (cyan)
- List any NEW failures (not in KNOWN_FAILURES.md)
- Exit with count of NEW failures (0 = CI green, >0 = new unexpected failures)

Pattern: Match the exact behavior of the existing `test/smb-conformance/parse-results.sh` but adapted for smbtorture's text output instead of WPTS TRX XML.

Make executable (chmod +x).

**2. Create test/smb-conformance/smbtorture/KNOWN_FAILURES.md:**

Initial baseline document (empty baseline since we haven't run it yet):

```markdown
# smbtorture Known Failures

Last updated: YYYY-MM-DD (Phase 32 initial baseline)

Tests listed here are expected to fail and will NOT cause CI to report failure.
Only NEW failures (not in this list) will cause CI to fail.

## Expected Failures

| Test Name | Category | Reason | Issue |
|-----------|----------|--------|-------|
| smb2.durable-open.* | Durable handles | Not implemented (v3.8) | - |
| smb2.durable-v2-open.* | Durable handles v2 | Not implemented (v3.8) | - |
| smb2.multichannel.* | Multi-channel | Not implemented (v3.8) | - |
| smb2.replay.* | Replay detection | Not implemented (v3.8) | - |
| smb2.notify.* | Change Notify | Not implemented (v3.8 Phase 40.5) | - |
| smb2.compound.* | Compound requests | Limited support | - |

## Notes

- smbtorture image: quay.io/samba.org/samba-toolbox:v0.8 (Samba 4.22.6)
- DittoFS implements SMB 2.0.2/2.1 (not SMB 3.x yet)
- Many tests may fail due to missing SMB3 features
- Fixing failures is deferred to v3.8 milestone
- Update this file after first smbtorture run with actual test names
```

**3. Create test/smb-conformance/smbtorture/Makefile:**
Convenience targets for local development:
```makefile
.PHONY: test test-quick test-full clean help

test: ## Run smbtorture with memory profile
	./run.sh --profile memory

test-quick: ## Run smbtorture connect test only
	./run.sh --profile memory --filter smb2.connect

test-full: ## Run smbtorture with all profiles
	@for profile in memory memory-fs badger-fs; do \
		echo "=== Profile: $$profile ==="; \
		./run.sh --profile $$profile; \
	done

clean: ## Remove results
	rm -rf ../results/smbtorture-*

help: ## Show this help
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}'
```

**4. Update test/smb-conformance/Makefile:**
Add smbtorture targets to the existing top-level Makefile:
```makefile
smbtorture: ## Run smbtorture tests
	cd smbtorture && $(MAKE) test

smbtorture-quick: ## Run smbtorture connect test only
	cd smbtorture && $(MAKE) test-quick
```

**5. Update .github/workflows/smb-conformance.yml (CI):**
Add a new `smbtorture` job alongside the existing `smb-conformance` job:

```yaml
smbtorture:
    name: smbtorture / ${{ matrix.profile }}
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        profile: >-
          ${{
            github.event_name == 'pull_request'
              && fromJson('["memory"]')
            || github.event_name == 'workflow_dispatch'
              && fromJson(format('["{0}"]', inputs.profile))
            || fromJson('["memory", "memory-fs", "badger-fs"]')
          }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run smbtorture tests
        run: |
          cd test/smb-conformance/smbtorture
          ./run.sh --profile ${{ matrix.profile }} --verbose

      - name: Add step summary
        if: always()
        run: |
          RESULTS_DIR=$(ls -td test/smb-conformance/results/smbtorture-*/ 2>/dev/null | head -1)
          if [ -n "$RESULTS_DIR" ] && [ -f "$RESULTS_DIR/summary.txt" ]; then
            echo "## smbtorture: ${{ matrix.profile }}" >> "$GITHUB_STEP_SUMMARY"
            cat "$RESULTS_DIR/summary.txt" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## smbtorture: ${{ matrix.profile }}" >> "$GITHUB_STEP_SUMMARY"
            echo "No results found." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smbtorture-${{ matrix.profile }}
          path: test/smb-conformance/results/smbtorture-*/
          retention-days: 30
```

Per user decision: unified CI artifacts (both WPTS and smbtorture in same workflow), advisory mode (known-failures model), same triggers as WPTS, parallel jobs. Note: exclude S3 profiles for smbtorture as they require localstack setup that adds unnecessary complexity.
  </action>
  <verify>
    <automated>test -f /Users/marmos91/Projects/dittofs-phase-30/test/smb-conformance/smbtorture/parse-results.sh && test -x /Users/marmos91/Projects/dittofs-phase-30/test/smb-conformance/smbtorture/parse-results.sh && bash -n /Users/marmos91/Projects/dittofs-phase-30/test/smb-conformance/smbtorture/parse-results.sh && test -f /Users/marmos91/Projects/dittofs-phase-30/test/smb-conformance/smbtorture/KNOWN_FAILURES.md && test -f /Users/marmos91/Projects/dittofs-phase-30/test/smb-conformance/smbtorture/Makefile && grep -q "smbtorture" /Users/marmos91/Projects/dittofs-phase-30/.github/workflows/smb-conformance.yml</automated>
  </verify>
  <done>
    - parse-results.sh parses smbtorture output, classifies as PASS/KNOWN/FAIL/SKIP
    - parse-results.sh exit code = count of NEW failures (0 = green)
    - KNOWN_FAILURES.md has initial expected failure categories for unimplemented features
    - smbtorture/Makefile has test, test-quick, test-full, clean targets
    - Parent Makefile has smbtorture and smbtorture-quick targets
    - CI workflow has smbtorture job alongside existing WPTS job
    - CI uses same tiered matrix pattern (memory on PRs, full on push/cron)
    - All shell scripts are syntactically valid
  </done>
</task>

</tasks>

<verification>
1. All shell scripts pass `bash -n` syntax validation
2. docker-compose.yml has valid smbtorture service definition
3. CI workflow YAML is valid (no syntax errors)
4. KNOWN_FAILURES.md exists with expected failure categories
5. parse-results.sh correctly classifies success/failure/skip output
6. Makefile targets reference correct paths
</verification>

<success_criteria>
- smbtorture Docker infrastructure mirrors the proven WPTS pattern
- Full smb2.* suite configured as default test scope (per user decision)
- GPL compliance maintained (smbtorture only in Docker container)
- Advisory CI model (known-failures, not blocking on expected failures)
- Same CI workflow as WPTS with parallel jobs and unified artifacts
- Scripts are executable and syntactically valid
</success_criteria>

<output>
After completion, create `.planning/phases/32-windows-integration-testing/32-02-SUMMARY.md`
</output>
