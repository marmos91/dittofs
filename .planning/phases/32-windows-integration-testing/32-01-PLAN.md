---
phase: 32-windows-integration-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/adapter/smb/v2/handlers/create.go
  - internal/adapter/smb/v2/handlers/create_test.go
  - internal/adapter/smb/v2/handlers/query_info.go
  - internal/adapter/smb/v2/handlers/query_info_test.go
  - internal/adapter/smb/types/constants.go
  - internal/adapter/smb/v2/handlers/session_setup.go
  - pkg/config/config.go
  - pkg/config/config_test.go
  - pkg/controlplane/store/gorm.go
  - pkg/controlplane/store/store_test.go
  - .github/workflows/windows-build.yml
autonomous: true
requirements:
  - WIN-02
  - WIN-03
  - WIN-05
  - WIN-06
  - WIN-07
  - WIN-08
  - WIN-10

must_haves:
  truths:
    - "Windows 11 CREATE requests with MxAc context receive maximal access mask in response"
    - "Windows 11 CREATE requests with QFid context receive on-disk file ID in response"
    - "QUERY_INFO for FileCompressionInformation returns valid 16-byte response instead of STATUS_NOT_SUPPORTED"
    - "QUERY_INFO for FileAttributeTagInformation returns valid 8-byte response instead of STATUS_NOT_SUPPORTED"
    - "FileFsAttributeInformation flags include FILE_SUPPORTS_SPARSE_FILES"
    - "Guest sessions do not require signing and return SESSION_FLAG_IS_GUEST"
    - "DittoFS server starts on Windows using %APPDATA% for config and database paths"
    - "Windows CI workflow builds and runs unit tests with -race flag"
  artifacts:
    - path: "internal/adapter/smb/v2/handlers/create.go"
      provides: "MxAc and QFid create context response encoding"
      contains: "MxAc"
    - path: "internal/adapter/smb/v2/handlers/query_info.go"
      provides: "FileCompressionInformation and FileAttributeTagInformation handlers"
      contains: "FileCompressionInformation"
    - path: "internal/adapter/smb/types/constants.go"
      provides: "FileCompressionInformation and FileAttributeTagInformation enum values"
      contains: "FileCompressionInformation"
    - path: "pkg/config/config.go"
      provides: "Windows APPDATA path support in getConfigDir"
      contains: "APPDATA"
    - path: "pkg/controlplane/store/gorm.go"
      provides: "Windows APPDATA path support in SQLite default path"
      contains: "APPDATA"
  key_links:
    - from: "internal/adapter/smb/v2/handlers/create.go"
      to: "internal/adapter/smb/v2/handlers/lease_context.go"
      via: "FindCreateContext + EncodeCreateContexts"
      pattern: "FindCreateContext.*MxAc"
    - from: "internal/adapter/smb/v2/handlers/query_info.go"
      to: "internal/adapter/smb/types/constants.go"
      via: "FileInfoClass switch cases"
      pattern: "FileCompressionInformation"
---

<objective>
Implement Windows 11 protocol compatibility fixes (MxAc/QFid create contexts, remaining FileInfoClass handlers, guest signing, capability flags) and cross-platform path fixes so DittoFS builds and runs correctly on Windows.

Purpose: These protocol-level fixes are required for Windows 11 Explorer and cmd.exe to interact with DittoFS shares without errors. The cross-platform path fixes enable DittoFS to run as a server on Windows hosts.

Output: Updated SMB handlers with MxAc/QFid support, FileCompressionInformation/FileAttributeTagInformation handlers, updated capability flags, verified guest signing, Windows-compatible config paths, enhanced Windows CI.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-windows-integration-testing/32-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From internal/adapter/smb/v2/handlers/create.go:
```go
type CreateContext struct {
    Name string   // "MxAc", "QFid", "RqLs", etc.
    Data []byte
}

type CreateResponse struct {
    SMBResponseBase
    OplockLevel    uint8
    CreateAction   uint32
    CreationTime   uint64
    // ... other fields
    CreateContexts []CreateContext
}
```

From internal/adapter/smb/v2/handlers/lease_context.go:
```go
func FindCreateContext(contexts []CreateContext, name string) *CreateContext
func EncodeCreateContexts(contexts []CreateContext) ([]byte, uint32, uint32)
```

From internal/adapter/smb/types/constants.go:
```go
type FileInfoClass uint8
const (
    FileBasicInformation           FileInfoClass = 4
    FileStandardInformation        FileInfoClass = 5
    // ... existing classes (no 28 or 35 yet)
    FileNetworkOpenInformation     FileInfoClass = 34
)
```

From internal/adapter/smb/v2/handlers/query_info.go:
```go
func (h *Handler) buildFileInfoFromStore(file *metadata.File, openFile *OpenFile, class types.FileInfoClass) ([]byte, error)
// Switch on class, returns encoded bytes. Add new cases here.

// FS info switch (case 5 = FileFsAttributeInformation):
// Currently: 0x0000008F flags. Need to add FILE_SUPPORTS_SPARSE_FILES (0x40).
```

From pkg/config/config.go:
```go
func getConfigDir() string  // Currently Unix-only, needs Windows %APPDATA% support
```

From pkg/controlplane/store/gorm.go:
```go
func (c *Config) ApplyDefaults()  // SQLite path defaults, needs Windows %APPDATA% support
```

From internal/cli/credentials/store.go (REFERENCE PATTERN):
```go
func getConfigPath() (string, error) {
    if runtime.GOOS == "windows" {
        configHome = os.Getenv("APPDATA")
        // ... fallback to UserHomeDir + AppData/Roaming
    } else {
        configHome = os.Getenv("XDG_CONFIG_HOME")
        // ... fallback to UserHomeDir + .config
    }
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MxAc/QFid create contexts, FileInfoClass handlers, and capability flags</name>
  <files>
    internal/adapter/smb/v2/handlers/create.go
    internal/adapter/smb/v2/handlers/create_test.go
    internal/adapter/smb/v2/handlers/query_info.go
    internal/adapter/smb/v2/handlers/query_info_test.go
    internal/adapter/smb/types/constants.go
    internal/adapter/smb/v2/handlers/session_setup.go
  </files>
  <action>
**1. MxAc create context (WIN-02):**
In `handleCreate()` in create.go, after the lease response context block (after line ~604 "Step 10b"), add MxAc processing:
- Check `FindCreateContext(req.CreateContexts, "MxAc")` for non-nil
- Build 8-byte response: QueryStatus (uint32 = 0 for STATUS_SUCCESS) + MaximalAccess (uint32)
- MaximalAccess computation: For the file owner (compare auth context UID with file.UID), grant `0x001F01FF` (GENERIC_ALL). For others, compute from POSIX mode bits: read=`0x00120089`, write=`0x00120116`, execute=`0x001200A0`. Combine applicable bits. Use the file's FileAttr.Mode and auth context.
- Append `CreateContext{Name: "MxAc", Data: mxAcResp}` to `resp.CreateContexts`

**2. QFid create context (WIN-03):**
In the same location in `handleCreate()`, add QFid processing:
- Check `FindCreateContext(req.CreateContexts, "QFid")` for non-nil
- Build 32-byte response: DiskFileId (16 bytes from file.ID[:16]) + VolumeId (16 bytes, use h.ServerGUID if available, otherwise zeros)
- Append `CreateContext{Name: "QFid", Data: qfidResp}` to `resp.CreateContexts`

**3. FileCompressionInformation (WIN-05):**
In `types/constants.go`, add:
```go
FileCompressionInformation     FileInfoClass = 28
FileAttributeTagInformation    FileInfoClass = 35
```

In `query_info.go` `buildFileInfoFromStore()` switch, add before the `default` case:
```go
case types.FileCompressionInformation:
    // [MS-FSCC] 2.4.9 - 16 bytes
    info := make([]byte, 16)
    binary.LittleEndian.PutUint64(info[0:8], file.Size) // CompressedFileSize = EndOfFile
    // CompressionFormat(2) + shifts(3) + Reserved(3) all zero = COMPRESSION_FORMAT_NONE
    return info, nil
```

**4. FileAttributeTagInformation (WIN-05):**
Add to the same switch:
```go
case types.FileAttributeTagInformation:
    // [MS-FSCC] 2.4.6 - 8 bytes
    info := make([]byte, 8)
    attrs := FileAttrToSMBAttributes(&file.FileAttr)
    binary.LittleEndian.PutUint32(info[0:4], attrs)
    // ReparseTag = 0 for non-reparse points
    return info, nil
```

**5. FileFsAttributeInformation flags (WIN-07):**
In `query_info.go` case 5 (FileFsAttributeInformation), update the flags from `0x0000008F` to `0x000000CF`:
- Add FILE_SUPPORTS_SPARSE_FILES (0x40) since DittoFS supports sparse file read/write (Phase 30 zero-fill fix)
- This gives: 0x01 | 0x02 | 0x04 | 0x08 | 0x40 | 0x80 = 0xCF
- Do NOT add FILE_NAMED_STREAMS (0x40000) -- while we have a ::$DATA stream stub, advertising this may cause Windows to try ADS operations

**6. Guest signing verification (WIN-06):**
Verify in `session_setup.go` that guest sessions already work correctly:
- `createGuestSession` and `createGuestSessionWithID` already set `SMB2SessionFlagIsGuest` flag
- Already skip signing configuration for guest sessions (comment at line ~593-594)
- Add a code comment documenting that Windows 11 24H2 blocks insecure guest logons by default and users must enable `AllowInsecureGuestAuth` GPO

**7. Tests:**
In `create_test.go`, add:
- `TestHandleCreate_MxAcContext`: Verify MxAc response is 8 bytes with STATUS_SUCCESS + access mask
- `TestHandleCreate_QFidContext`: Verify QFid response is 32 bytes with file ID + volume ID

In `query_info_test.go`, add:
- `TestFileCompressionInformation`: Verify 16-byte response with file size at offset 0
- `TestFileAttributeTagInformation`: Verify 8-byte response with file attributes at offset 0
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs-phase-30 && go build ./... && go test ./internal/adapter/smb/... -run "TestHandleCreate_MxAc|TestHandleCreate_QFid|TestFileCompression|TestFileAttributeTag" -v -count=1</automated>
  </verify>
  <done>
    - MxAc create context returns 8-byte response with maximal access mask computed from file permissions
    - QFid create context returns 32-byte response with file ID and volume ID
    - FileCompressionInformation (class 28) returns 16-byte response with file size as compressed size
    - FileAttributeTagInformation (class 35) returns 8-byte response with file attributes and zero reparse tag
    - FileFsAttributeInformation flags updated to include FILE_SUPPORTS_SPARSE_FILES
    - Guest signing behavior documented with Windows 11 24H2 GPO note
    - All new tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Cross-platform path fixes and Windows CI enhancement</name>
  <files>
    pkg/config/config.go
    pkg/config/config_test.go
    pkg/controlplane/store/gorm.go
    pkg/controlplane/store/store_test.go
    .github/workflows/windows-build.yml
  </files>
  <action>
**1. Fix getConfigDir() in pkg/config/config.go (WIN-10):**
Mirror the pattern from `internal/cli/credentials/store.go` lines 107-127. Add `"runtime"` import. Update `getConfigDir()`:
```go
func getConfigDir() string {
    if runtime.GOOS == "windows" {
        // On Windows, use %APPDATA%\dittofs
        appData := os.Getenv("APPDATA")
        if appData != "" {
            return filepath.Join(appData, "dittofs")
        }
        home, err := os.UserHomeDir()
        if err == nil {
            return filepath.Join(home, "AppData", "Roaming", "dittofs")
        }
        return "."
    }

    // Unix: XDG_CONFIG_HOME or ~/.config
    if xdgConfig := os.Getenv("XDG_CONFIG_HOME"); xdgConfig != "" {
        return filepath.Join(xdgConfig, "dittofs")
    }
    home, err := os.UserHomeDir()
    if err != nil {
        return "."
    }
    return filepath.Join(home, ".config", "dittofs")
}
```

**2. Fix ApplyDefaults() in pkg/controlplane/store/gorm.go (WIN-10):**
Add `"runtime"` import. Update the SQLite path default:
```go
if c.Type == DatabaseTypeSQLite && c.SQLite.Path == "" {
    var configDir string
    if runtime.GOOS == "windows" {
        configDir = os.Getenv("APPDATA")
        if configDir == "" {
            homeDir, _ := os.UserHomeDir()
            configDir = filepath.Join(homeDir, "AppData", "Roaming")
        }
    } else {
        configDir = os.Getenv("XDG_CONFIG_HOME")
        if configDir == "" {
            homeDir, _ := os.UserHomeDir()
            configDir = filepath.Join(homeDir, ".config")
        }
    }
    c.SQLite.Path = filepath.Join(configDir, "dittofs", "controlplane.db")
}
```

**3. Add tests:**
In `pkg/config/config_test.go`, add `TestGetConfigDir_WindowsEnv` that sets/unsets APPDATA and XDG_CONFIG_HOME env vars and verifies correct path resolution on the current platform (conditional assertions based on runtime.GOOS).

In `pkg/controlplane/store/store_test.go`, add `TestApplyDefaults_WindowsPath` with similar env var manipulation.

**4. Windows CI enhancement (WIN-08):**
In `.github/workflows/windows-build.yml`:
- Add `-race` flag to the unit test step: `go test -short -race -v ./...`
- Add a step summary with build status
- Verify it already triggers on PRs to develop and main (it does)
  </action>
  <verify>
    <automated>cd /Users/marmos91/Projects/dittofs-phase-30 && go build ./... && go test ./pkg/config/ -run "TestGetConfigDir" -v -count=1 && go test ./pkg/controlplane/store/ -run "TestApplyDefaults" -v -count=1</automated>
  </verify>
  <done>
    - getConfigDir() uses %APPDATA% on Windows, XDG_CONFIG_HOME on Unix
    - SQLite default path uses %APPDATA% on Windows
    - Both follow the same pattern as credentials/store.go
    - Tests verify path resolution on current platform
    - Windows CI workflow includes -race flag on unit tests
    - go build ./... succeeds (no import cycle from runtime import)
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` succeeds with no errors
2. `go test ./internal/adapter/smb/... -count=1` passes (all existing + new tests)
3. `go test ./pkg/config/ -count=1` passes
4. `go test ./pkg/controlplane/store/ -count=1` passes
5. `go vet ./...` reports no issues
</verification>

<success_criteria>
- MxAc and QFid create context responses properly encoded in CREATE responses
- FileCompressionInformation and FileAttributeTagInformation return valid fixed-size buffers
- FileFsAttributeInformation flags include FILE_SUPPORTS_SPARSE_FILES
- Guest signing behavior verified correct and documented
- DittoFS config paths resolve correctly on Windows
- All tests pass, no build errors
</success_criteria>

<output>
After completion, create `.planning/phases/32-windows-integration-testing/32-01-SUMMARY.md`
</output>
