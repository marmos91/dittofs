---
phase: 20-sequence-and-compound-bifurcation
plan: 02
type: execute
wave: 2
depends_on: [20-01]
files_modified:
  - internal/protocol/nfs/v4/state/sequence_metrics.go
  - internal/protocol/nfs/v4/handlers/compound.go
  - internal/protocol/nfs/v4/handlers/sequence_handler.go
  - internal/protocol/nfs/v4/handlers/compound_test.go
  - internal/protocol/nfs/v4/handlers/sequence_handler_test.go
  - pkg/controlplane/models/adapter_settings.go
  - internal/controlplane/api/handlers/settings.go
  - pkg/apiclient/settings.go
  - cmd/dfsctl/commands/adapter/nfs_settings.go
  - internal/protocol/CLAUDE.md
autonomous: true
requirements: [COEX-02]

must_haves:
  truths:
    - "Prometheus metrics track SEQUENCE operations (total, errors by type, replay hits, slot utilization, cache memory)"
    - "Minor version range is configurable per NFS adapter via control plane (REST API and dfsctl)"
    - "v4.0 clients continue working unchanged through the bifurcated dispatcher"
    - "Concurrent v4.0 and v4.1 COMPOUNDs on the same TCP connection work without interference"
    - "v4.0 OPEN/CLOSE/LOCK seqid validation still works correctly (no bypass regression)"
  artifacts:
    - path: "internal/protocol/nfs/v4/state/sequence_metrics.go"
      provides: "SequenceMetrics with nil-safe receivers following SessionMetrics pattern"
      min_lines: 60
    - path: "pkg/controlplane/models/adapter_settings.go"
      provides: "V4MinMinorVersion and V4MaxMinorVersion fields on NFSAdapterSettings"
      contains: "V4MinMinorVersion"
    - path: "internal/protocol/nfs/v4/handlers/compound_test.go"
      provides: "v4.0 regression tests and coexistence tests"
      contains: "TestCompound_V40_Regression"
  key_links:
    - from: "internal/protocol/nfs/v4/handlers/sequence_handler.go"
      to: "internal/protocol/nfs/v4/state/sequence_metrics.go"
      via: "SequenceMetrics recording on SEQUENCE handler success/error/replay"
      pattern: "sequenceMetrics"
    - from: "internal/protocol/nfs/v4/handlers/compound.go"
      to: "pkg/controlplane/models/adapter_settings.go"
      via: "Minor version range gating in ProcessCompound"
      pattern: "minMinorVersion|maxMinorVersion"
---

<objective>
Add Prometheus observability, configurable minor version range, and comprehensive v4.0 regression and coexistence tests to ensure the COMPOUND bifurcation is production-ready.

Purpose: Observability (metrics) enables production monitoring of SEQUENCE operations. Version range configuration allows operators to control which minor versions are accepted. Regression and coexistence tests provide confidence that v4.0 clients are unaffected by the v4.1 dispatch path changes.
Output: SequenceMetrics, version range in NFSAdapterSettings (full stack), v4.0 regression test suite, concurrent mixed-traffic tests, benchmark.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-sequence-and-compound-bifurcation/20-CONTEXT.md
@.planning/phases/20-sequence-and-compound-bifurcation/20-RESEARCH.md
@.planning/phases/20-sequence-and-compound-bifurcation/20-01-SUMMARY.md

@internal/protocol/nfs/v4/state/session_metrics.go
@internal/protocol/nfs/v4/handlers/compound.go
@internal/protocol/nfs/v4/handlers/compound_test.go
@internal/protocol/nfs/v4/handlers/sequence_handler.go
@pkg/controlplane/models/adapter_settings.go
@internal/controlplane/api/handlers/settings.go
@pkg/apiclient/settings.go
@cmd/dfsctl/commands/adapter/nfs_settings.go
@internal/protocol/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prometheus metrics and version range configuration</name>
  <files>
    internal/protocol/nfs/v4/state/sequence_metrics.go
    internal/protocol/nfs/v4/handlers/sequence_handler.go
    internal/protocol/nfs/v4/handlers/compound.go
    internal/protocol/nfs/v4/handlers/handler.go
    internal/protocol/nfs/v4/state/manager.go
    pkg/controlplane/models/adapter_settings.go
    internal/controlplane/api/handlers/settings.go
    pkg/apiclient/settings.go
    cmd/dfsctl/commands/adapter/nfs_settings.go
  </files>
  <action>
    **1. Create SequenceMetrics** (state/sequence_metrics.go):
    Follow the exact SessionMetrics pattern from session_metrics.go. All methods use nil-safe receivers (no explicit nil check needed in callers).

    Metrics per CONTEXT decisions:
    - `dittofs_nfs_sequence_total` (Counter): total SEQUENCE operations processed
    - `dittofs_nfs_sequence_errors_total` (CounterVec, label: error_type): per-error-type counters. Label values: "bad_session", "seq_misordered", "replay_hit", "slot_busy", "bad_xdr", "bad_slot", "retry_uncached"
    - `dittofs_nfs_replay_hits_total` (Counter): successful replay cache hits (cached response returned)
    - `dittofs_nfs_slots_in_use` (GaugeVec, label: session_id): slots currently in use per session. Note: session_id as label is fine for limited cardinality (max ~16 sessions per client)
    - `dittofs_nfs_replay_cache_bytes` (Gauge): total bytes consumed by cached responses across all sessions

    Add `NewSequenceMetrics(registerer prometheus.Registerer) *SequenceMetrics` constructor.
    Add nil-safe methods: `RecordSequence()`, `RecordError(errType string)`, `RecordReplayHit()`, `SetSlotsInUse(sessionID string, count float64)`, `SetReplayCacheBytes(bytes float64)`.

    **2. Wire metrics into SEQUENCE handler** (handlers/sequence_handler.go):
    Add `sequenceMetrics *SequenceMetrics` to Handler struct (set in NewHandler or via setter).
    In handleSequenceOp:
    - On every call: `h.sequenceMetrics.RecordSequence()`
    - On error: `h.sequenceMetrics.RecordError(errorType)` where errorType matches label values above
    - On replay hit: `h.sequenceMetrics.RecordReplayHit()`
    - After slot acquire: update `h.sequenceMetrics.SetSlotsInUse(sessionIDHex, count)`
    - Periodically or on change: `h.sequenceMetrics.SetReplayCacheBytes(totalBytes)` -- compute from session's slot table

    **3. Add version range to NFSAdapterSettings** (models/adapter_settings.go):
    Add two new fields:
    ```go
    V4MinMinorVersion int `gorm:"default:0" json:"v4_min_minor_version"` // minimum NFSv4 minor version (0=v4.0, 1=v4.1)
    V4MaxMinorVersion int `gorm:"default:1" json:"v4_max_minor_version"` // maximum NFSv4 minor version
    ```

    Add getter methods: `GetV4MinMinorVersion() uint32`, `GetV4MaxMinorVersion() uint32`.

    **4. Wire version range into ProcessCompound** (compound.go):
    Add `minMinorVersion uint32` and `maxMinorVersion uint32` fields to Handler struct.
    Add `SetMinorVersionRange(min, max uint32)` method.
    In ProcessCompound, before the minorVersion switch, add:
    ```go
    if minorVersion < h.minMinorVersion || minorVersion > h.maxMinorVersion {
        return encodeCompoundResponse(types.NFS4ERR_MINOR_VERS_MISMATCH, tag, nil)
    }
    ```
    Default: min=0, max=1 (both v4.0 and v4.1 enabled).

    **5. REST API for version range** (handlers/settings.go):
    Add `v4_min_minor_version` and `v4_max_minor_version` to the NFS settings update/get endpoints (they already handle NFSAdapterSettings fields). These fields should be included in the existing settings CRUD pattern.

    **6. dfsctl version range** (adapter/nfs_settings.go):
    Add `--v4-min-minor-version` and `--v4-max-minor-version` flags to the `dfsctl adapter nfs settings update` command. Display in `dfsctl adapter nfs settings show`.

    **7. apiclient support** (apiclient/settings.go):
    Ensure the apiclient settings methods include the new fields in serialization/deserialization.
  </action>
  <verify>
    `cd /Users/marmos91/Projects/dittofs && go build ./...` compiles.
    `cd /Users/marmos91/Projects/dittofs && go vet ./...` passes.
    `cd /Users/marmos91/Projects/dittofs && go test -race -count=1 ./internal/protocol/nfs/v4/state/...` passes.
  </verify>
  <done>
    SequenceMetrics records all SEQUENCE outcomes with per-error-type counters. Minor version range is configurable via REST API and dfsctl. ProcessCompound gates on version range. All existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: v4.0 regression, coexistence, concurrent mixed traffic tests, and benchmark</name>
  <files>
    internal/protocol/nfs/v4/handlers/compound_test.go
    internal/protocol/nfs/v4/handlers/sequence_handler_test.go
    internal/protocol/CLAUDE.md
  </files>
  <action>
    **1. v4.0 regression tests** (compound_test.go):
    Add test group `TestCompound_V40_Regression` that runs ALL existing v4.0 COMPOUND scenarios through the dispatcher to verify zero regressions. Tests should:
    - v4.0 PUTFH + GETATTR: still works as before
    - v4.0 OPEN with seqid validation: seqid still checked (SkipOwnerSeqid is false)
    - v4.0 CLOSE with seqid replay: replay detection still works
    - v4.0 LOCK with seqid: seqid validation unchanged
    - v4.0 SETCLIENTID + SETCLIENTID_CONFIRM flow: unchanged
    - v4.0 RENEW: unchanged
    - v4.0 with blocked operation: still returns NFS4ERR_NOTSUPP
    - v4.0 with unknown opcode: still returns appropriate error

    **2. Coexistence tests** (compound_test.go):
    Add test group `TestCompound_V40_V41_Coexistence`:
    - Send v4.0 COMPOUND then v4.1 COMPOUND (with SEQUENCE) sequentially on same handler: both succeed
    - Send v4.1 COMPOUND with SEQUENCE + v4.0 ops (PUTFH, GETATTR via fallback): works, seqid bypassed
    - v4.1 COMPOUND with SEQUENCE + OPEN: open-owner seqid=0 bypass works
    - Mixed minor versions: alternate v4.0 and v4.1 COMPOUNDs on same handler

    **3. Concurrent mixed traffic tests** (compound_test.go):
    Add `TestCompound_ConcurrentMixedTraffic`:
    - Launch N goroutines (e.g., 10) each sending COMPOUNDs with random minor version (0 or 1)
    - Each goroutine sends 100 COMPOUNDs
    - Verify: no panics, no data races (-race flag), all responses valid
    - Use unique sessions per goroutine for v4.1 COMPOUNDs (register separate clients)

    **4. Version range gating tests** (compound_test.go):
    - Set minMinorVersion=1, maxMinorVersion=1: v4.0 COMPOUND returns NFS4ERR_MINOR_VERS_MISMATCH
    - Set minMinorVersion=0, maxMinorVersion=0: v4.1 COMPOUND returns NFS4ERR_MINOR_VERS_MISMATCH
    - Default (0, 1): both versions work

    **5. Benchmark test** (sequence_handler_test.go):
    Add `BenchmarkSequenceValidation` and `BenchmarkCompoundDispatch`:
    - Benchmark SEQUENCE validation throughput (create session, send SEQUENCE ops in loop)
    - Benchmark full COMPOUND dispatch (SEQUENCE + PUTFH + GETATTR)
    - Report ns/op for both

    **6. Update protocol CLAUDE.md** (internal/protocol/CLAUDE.md):
    Add a section documenting:
    - SEQUENCE-gated dispatch pattern
    - isSessionExemptOp convention
    - Seqid bypass via SkipOwnerSeqid flag (seqid=0 convention)
    - Replay cache at COMPOUND level (cached response bytes in slot)
    - SequenceMetrics pattern
    - Minor version range configuration
  </action>
  <verify>
    `cd /Users/marmos91/Projects/dittofs && go test -race -count=1 ./internal/protocol/nfs/v4/handlers/...` passes all new and existing tests.
    `cd /Users/marmos91/Projects/dittofs && go test -race -count=1 ./...` passes (full test suite).
    `cd /Users/marmos91/Projects/dittofs && go test -bench=. -benchmem ./internal/protocol/nfs/v4/handlers/...` runs benchmarks.
  </verify>
  <done>
    v4.0 regression suite confirms zero regressions from COMPOUND bifurcation. Coexistence tests verify v4.0 and v4.1 clients work simultaneously. Concurrent mixed traffic tests verify thread safety. Version range gating tests verify configuration. Benchmark establishes performance baseline. Protocol CLAUDE.md documents new patterns.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` -- entire project compiles
2. `go test -race -count=1 ./internal/protocol/nfs/v4/...` -- all v4 tests pass with race detection
3. `go test -race -count=1 ./...` -- full test suite passes (no regressions)
4. `go vet ./...` -- no static analysis issues
5. `go test -bench=. -benchmem ./internal/protocol/nfs/v4/handlers/...` -- benchmarks run
6. Prometheus metrics are registered without panics (no duplicate registration)
</verification>

<success_criteria>
- SequenceMetrics tracks all SEQUENCE outcomes with labeled error counters
- Minor version range is configurable per adapter via REST API and dfsctl
- v4.0 regression tests pass (seqid validation, replay detection, blocked ops)
- Coexistence tests pass (mixed v4.0/v4.1 on same handler)
- Concurrent mixed traffic tests pass with -race (no data races)
- Version range gating works (NFS4ERR_MINOR_VERS_MISMATCH for out-of-range)
- Benchmark baseline established for SEQUENCE validation throughput
- Protocol CLAUDE.md documents SEQUENCE patterns
</success_criteria>

<output>
After completion, create `.planning/phases/20-sequence-and-compound-bifurcation/20-02-SUMMARY.md`
</output>
