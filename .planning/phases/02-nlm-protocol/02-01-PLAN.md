---
phase: 02-nlm-protocol
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/protocol/xdr/decode.go
  - internal/protocol/xdr/encode.go
  - internal/protocol/xdr/types.go
  - internal/protocol/nlm/constants.go
  - internal/protocol/nlm/types.go
  - internal/protocol/nlm/xdr/decode.go
  - internal/protocol/nlm/xdr/encode.go
  - internal/protocol/nfs/xdr/decode.go
  - internal/protocol/nfs/xdr/encode.go
autonomous: true

must_haves:
  truths:
    - "Shared XDR utilities available in internal/protocol/xdr/"
    - "NLM constants defined (program number, procedure numbers, status codes)"
    - "NLM XDR types match Open Group specification"
    - "NFS XDR packages import shared utilities without breaking existing code"
  artifacts:
    - path: "internal/protocol/xdr/decode.go"
      provides: "Shared DecodeOpaque, DecodeString functions"
      exports: ["DecodeOpaque", "DecodeString"]
    - path: "internal/protocol/xdr/encode.go"
      provides: "Shared WriteXDROpaque, WriteXDRString, WriteXDRPadding functions"
      exports: ["WriteXDROpaque", "WriteXDRString", "WriteXDRPadding"]
    - path: "internal/protocol/nlm/constants.go"
      provides: "NLM program number (100021), procedure numbers, status codes"
      exports: ["ProgramNLM", "NLMVersion4", "NLMProcNull", "NLMProcTest", "NLMProcLock", "NLMProcCancel", "NLMProcUnlock", "NLMProcGranted", "NLM4Granted", "NLM4Denied", "NLM4DeniedNoLocks", "NLM4Blocked", "NLM4DeniedGrace", "NLM4Deadlock", "NLM4StaleFH", "NLM4Failed"]
    - path: "internal/protocol/nlm/types.go"
      provides: "NLM4Lock, NLM4Holder, NLM4LockArgs, NLM4UnlockArgs, NLM4TestArgs, NLM4CancelArgs, NLM4Res, NLM4TestRes"
      min_lines: 100
    - path: "internal/protocol/nlm/xdr/decode.go"
      provides: "NLM request decoders"
      exports: ["DecodeNLM4LockArgs", "DecodeNLM4UnlockArgs", "DecodeNLM4TestArgs", "DecodeNLM4CancelArgs"]
    - path: "internal/protocol/nlm/xdr/encode.go"
      provides: "NLM response encoders"
      exports: ["EncodeNLM4Res", "EncodeNLM4TestRes"]
  key_links:
    - from: "internal/protocol/nlm/xdr/decode.go"
      to: "internal/protocol/xdr"
      via: "import for shared utilities"
      pattern: "import.*internal/protocol/xdr"
    - from: "internal/protocol/nfs/xdr/decode.go"
      to: "internal/protocol/xdr"
      via: "import for shared utilities"
      pattern: "import.*internal/protocol/xdr"
---

<objective>
Extract shared XDR utilities and create NLM protocol types and constants.

Purpose: Establish the foundation for NLM protocol implementation by extracting reusable XDR encoding/decoding utilities to a shared location and defining all NLM-specific types per the Open Group NLM v4 specification.

Output:
- Shared XDR package at internal/protocol/xdr/
- NLM constants and types at internal/protocol/nlm/
- NLM XDR encoders/decoders at internal/protocol/nlm/xdr/
- Updated NFS XDR to import shared utilities
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-nlm-protocol/02-CONTEXT.md
@.planning/phases/02-nlm-protocol/02-RESEARCH.md
@internal/protocol/nfs/xdr/decode.go
@internal/protocol/nfs/xdr/encode.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared XDR utilities package</name>
  <files>
    internal/protocol/xdr/decode.go
    internal/protocol/xdr/encode.go
    internal/protocol/xdr/types.go
  </files>
  <action>
Create the shared XDR utilities package at internal/protocol/xdr/ by extracting generic functions from internal/protocol/nfs/xdr/:

1. Create internal/protocol/xdr/decode.go with:
   - DecodeOpaque(reader io.Reader) ([]byte, error) - variable-length opaque data
   - DecodeString(reader io.Reader) (string, error) - XDR string (calls DecodeOpaque)
   - DecodeUint32(reader io.Reader) (uint32, error) - fixed uint32
   - DecodeUint64(reader io.Reader) (uint64, error) - fixed uint64
   - DecodeInt32(reader io.Reader) (int32, error) - fixed int32
   - DecodeBool(reader io.Reader) (bool, error) - XDR boolean (uint32 where 0=false)

2. Create internal/protocol/xdr/encode.go with:
   - WriteXDROpaque(buf *bytes.Buffer, data []byte) error
   - WriteXDRString(buf *bytes.Buffer, s string) error
   - WriteXDRPadding(buf *bytes.Buffer, dataLen uint32) error
   - WriteUint32(buf *bytes.Buffer, v uint32) error
   - WriteUint64(buf *bytes.Buffer, v uint64) error
   - WriteInt32(buf *bytes.Buffer, v int32) error
   - WriteBool(buf *bytes.Buffer, v bool) error

3. Create internal/protocol/xdr/types.go with package doc comment explaining XDR (RFC 4506).

These are GENERIC utilities that DO NOT import any DittoFS packages (no logger, no metadata, no nfs/types). Only Go stdlib imports (encoding/binary, bytes, io, fmt).
  </action>
  <verify>
Run: `go build ./internal/protocol/xdr/...` - compiles without errors
Run: `go vet ./internal/protocol/xdr/...` - no issues
  </verify>
  <done>
Shared XDR package exists at internal/protocol/xdr/ with all basic encode/decode functions. No dependencies on DittoFS packages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update NFS XDR to use shared utilities</name>
  <files>
    internal/protocol/nfs/xdr/decode.go
    internal/protocol/nfs/xdr/encode.go
  </files>
  <action>
Refactor existing NFS XDR packages to import and delegate to the shared XDR package:

1. In internal/protocol/nfs/xdr/decode.go:
   - Add import: "github.com/marmos91/dittofs/internal/protocol/xdr"
   - Replace DecodeOpaque body with: return xdr.DecodeOpaque(reader)
   - Replace DecodeString body with: return xdr.DecodeString(reader)
   - Keep NFS-specific functions (DecodeSetAttrs, etc.) that depend on metadata types

2. In internal/protocol/nfs/xdr/encode.go:
   - Add import: "github.com/marmos91/dittofs/internal/protocol/xdr"
   - Replace WriteXDROpaque body with: return xdr.WriteXDROpaque(buf, data)
   - Replace WriteXDRString body with: return xdr.WriteXDRString(buf, s)
   - Replace WriteXDRPadding body with: return xdr.WriteXDRPadding(buf, dataLen)
   - Keep NFS-specific functions (EncodeFileAttr, EncodeWccData, etc.)

This is a PURE REFACTOR - all existing tests must continue to pass. The public API of internal/protocol/nfs/xdr remains unchanged.
  </action>
  <verify>
Run: `go test ./internal/protocol/nfs/xdr/...` - all existing tests pass
Run: `go test ./...` - entire test suite passes (no regressions)
  </verify>
  <done>
NFS XDR packages delegate to shared utilities. All existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create NLM constants and types</name>
  <files>
    internal/protocol/nlm/constants.go
    internal/protocol/nlm/types.go
    internal/protocol/nlm/xdr/decode.go
    internal/protocol/nlm/xdr/encode.go
  </files>
  <action>
Create the NLM protocol types and constants per Open Group NLM v4 specification:

1. Create internal/protocol/nlm/constants.go:
```go
package nlm

// NLM RPC Program and Version
const (
    ProgramNLM  uint32 = 100021
    NLMVersion4 uint32 = 4
)

// NLM v4 Procedure Numbers (synchronous only per CONTEXT.md)
const (
    NLMProcNull    uint32 = 0  // NULL - ping
    NLMProcTest    uint32 = 1  // TEST - check lock availability
    NLMProcLock    uint32 = 2  // LOCK - acquire lock
    NLMProcCancel  uint32 = 3  // CANCEL - cancel pending lock
    NLMProcUnlock  uint32 = 4  // UNLOCK - release lock
    NLMProcGranted uint32 = 5  // GRANTED - callback notification
)

// NLM v4 Status Codes
const (
    NLM4Granted       uint32 = 0  // Success
    NLM4Denied        uint32 = 1  // Lock denied (conflict)
    NLM4DeniedNoLocks uint32 = 2  // No resources (queue full)
    NLM4Blocked       uint32 = 3  // Blocking - will callback
    NLM4DeniedGrace   uint32 = 4  // Grace period active
    NLM4Deadlock      uint32 = 5  // Would cause deadlock
    NLM4ROFS          uint32 = 6  // Read-only filesystem
    NLM4StaleFH       uint32 = 7  // Stale file handle
    NLM4FBIG          uint32 = 8  // Offset too big
    NLM4Failed        uint32 = 9  // General failure
)
```

2. Create internal/protocol/nlm/types.go with NLM v4 structures:
   - NLM4Lock struct: CallerName, FH, OH, Svid, Offset, Length
   - NLM4Holder struct: Exclusive, Svid, OH, Offset, Length
   - NLM4LockArgs struct: Cookie, Block, Exclusive, Lock, Reclaim, State
   - NLM4UnlockArgs struct: Cookie, Lock
   - NLM4TestArgs struct: Cookie, Exclusive, Lock
   - NLM4CancelArgs struct: Cookie, Block, Exclusive, Lock
   - NLM4Res struct: Cookie, Status
   - NLM4TestRes struct: Cookie, Status, Holder (pointer, nil if granted)
   - NLM4GrantedArgs struct: Cookie, Exclusive, Lock (for callbacks)

3. Create internal/protocol/nlm/xdr/decode.go:
   - DecodeNLM4Lock(r io.Reader) (*nlm.NLM4Lock, error)
   - DecodeNLM4LockArgs(r io.Reader) (*nlm.NLM4LockArgs, error)
   - DecodeNLM4UnlockArgs(r io.Reader) (*nlm.NLM4UnlockArgs, error)
   - DecodeNLM4TestArgs(r io.Reader) (*nlm.NLM4TestArgs, error)
   - DecodeNLM4CancelArgs(r io.Reader) (*nlm.NLM4CancelArgs, error)
   Import shared xdr package for DecodeOpaque, DecodeString, etc.

4. Create internal/protocol/nlm/xdr/encode.go:
   - EncodeNLM4Res(buf *bytes.Buffer, res *nlm.NLM4Res) error
   - EncodeNLM4TestRes(buf *bytes.Buffer, res *nlm.NLM4TestRes) error
   - EncodeNLM4Holder(buf *bytes.Buffer, holder *nlm.NLM4Holder) error
   - EncodeNLM4GrantedArgs(buf *bytes.Buffer, args *nlm.NLM4GrantedArgs) error (for callback)
   Import shared xdr package for WriteXDROpaque, WriteXDRString, etc.

All lengths/offsets are uint64 (NLM v4, not v3).
  </action>
  <verify>
Run: `go build ./internal/protocol/nlm/...` - compiles without errors
Run: `go vet ./internal/protocol/nlm/...` - no issues
  </verify>
  <done>
NLM package exists with all constants, types, and XDR encode/decode functions.
  </done>
</task>

</tasks>

<verification>
Overall verification for Plan 02-01:

1. Shared XDR package:
   - `ls internal/protocol/xdr/` shows decode.go, encode.go, types.go
   - `go build ./internal/protocol/xdr/...` compiles

2. NFS XDR refactored:
   - `grep -r "internal/protocol/xdr" internal/protocol/nfs/xdr/` shows imports
   - `go test ./internal/protocol/nfs/xdr/...` passes

3. NLM package created:
   - `ls internal/protocol/nlm/` shows constants.go, types.go
   - `ls internal/protocol/nlm/xdr/` shows decode.go, encode.go
   - `go build ./internal/protocol/nlm/...` compiles

4. Full test suite:
   - `go test ./...` passes (no regressions)
</verification>

<success_criteria>
- Shared XDR utilities exist at internal/protocol/xdr/ with no DittoFS dependencies
- NFS XDR packages import shared utilities without breaking any tests
- NLM constants match Open Group NLM v4 specification
- NLM types support all synchronous procedures (NULL, TEST, LOCK, CANCEL, UNLOCK, GRANTED)
- NLM XDR decoders handle all request types
- NLM XDR encoders handle all response types including conflict holder info
- Full test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-nlm-protocol/02-01-SUMMARY.md`
</output>
