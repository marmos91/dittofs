---
phase: 05-adapters-auxiliary
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - test/e2e/helpers/cli.go
  - test/e2e/adapters_test.go
autonomous: true

must_haves:
  truths:
    - "Admin can enable NFS adapter via CLI and it starts listening"
    - "Admin can disable NFS adapter via CLI and it stops"
    - "Admin can enable SMB adapter via CLI and it starts listening"
    - "Admin can disable SMB adapter via CLI and it stops"
    - "Adapter port change takes effect without full server restart"
    - "Invalid adapter config is rejected with clear error"
  artifacts:
    - path: "test/e2e/helpers/cli.go"
      provides: "Adapter helper methods"
      contains: "func (r *CLIRunner) ListAdapters"
    - path: "test/e2e/adapters_test.go"
      provides: "Adapter lifecycle E2E tests"
      contains: "TestAdapterLifecycle"
  key_links:
    - from: "test/e2e/adapters_test.go"
      to: "test/e2e/helpers/cli.go"
      via: "CLIRunner.EnableAdapter, CLIRunner.DisableAdapter"
      pattern: "runner\\.EnableAdapter|runner\\.DisableAdapter"
---

<objective>
Implement E2E tests for protocol adapter lifecycle management (NFS and SMB enable/disable with hot reload).

Purpose: Validates that adapters can be dynamically controlled via CLI without full server restart (ADP-01 through ADP-08).
Output: Adapter helper methods in cli.go and comprehensive adapter_test.go suite.
</objective>

<execution_context>
@/Users/marmos91/.claude/get-shit-done/workflows/execute-plan.md
@/Users/marmos91/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-adapters-auxiliary/05-CONTEXT.md
@.planning/phases/05-adapters-auxiliary/05-RESEARCH.md
@test/e2e/helpers/cli.go
@test/e2e/server_test.go
@cmd/dittofsctl/commands/adapter/list.go
@cmd/dittofsctl/commands/adapter/enable.go
@cmd/dittofsctl/commands/adapter/disable.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Adapter helper methods to CLIRunner</name>
  <files>test/e2e/helpers/cli.go</files>
  <action>
Add adapter management types and methods to cli.go following the established pattern from prior phases:

1. Add Adapter type matching API response:
```go
type Adapter struct {
    Type    string `json:"type"`
    Port    int    `json:"port"`
    Enabled bool   `json:"enabled"`
}
```

2. Add AdapterOption functional options pattern:
```go
type AdapterOption func(*adapterOptions)

type adapterOptions struct {
    port *int
}

func WithAdapterPort(port int) AdapterOption
```

3. Add CLIRunner methods:
- `ListAdapters() ([]*Adapter, error)` - runs `adapter list`
- `GetAdapter(adapterType string) (*Adapter, error)` - list + filter (no dedicated get command)
- `EnableAdapter(adapterType string, opts ...AdapterOption) error` - runs `adapter enable {type} [--port N]`
- `DisableAdapter(adapterType string) error` - runs `adapter disable {type}`
- `EditAdapter(adapterType string, opts ...AdapterOption) (*Adapter, error)` - runs `adapter edit {type}`

4. Add WaitForAdapterStatus helper for polling:
```go
func WaitForAdapterStatus(t *testing.T, runner *CLIRunner, adapterType string, enabled bool, timeout time.Duration) error
```

Follow patterns established in prior phases (ParseJSONResponse, error wrapping with output).
  </action>
  <verify>
Run `go build ./test/e2e/helpers/` to verify compilation. Run `go vet ./test/e2e/helpers/` for static analysis.
  </verify>
  <done>
Adapter type and all five CLIRunner methods compile successfully. Methods follow established patterns from prior phases.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write adapter lifecycle E2E tests</name>
  <files>test/e2e/adapters_test.go</files>
  <action>
Create test/e2e/adapters_test.go with comprehensive adapter lifecycle tests covering requirements ADP-01 through ADP-08.

Test structure:
```go
//go:build e2e

package e2e

func TestAdapterLifecycle(t *testing.T) {
    // Test suite - each subtest uses shared server but runs sequentially
    // to avoid port conflicts
}
```

Subtests to implement:

1. **ADP-01/ADP-02 NFS enable/disable cycle**:
   - Start with server
   - List adapters, verify NFS state
   - Disable NFS adapter
   - Verify disabled via list
   - Re-enable NFS adapter
   - Verify enabled and listening (check health endpoint shows adapter)

2. **ADP-03/ADP-04 SMB enable/disable cycle**:
   - Similar to NFS but for SMB adapter

3. **ADP-05 Port configuration change**:
   - Enable adapter on port A
   - Edit adapter to change to port B
   - Verify port change took effect

4. **ADP-06 Hot reload** (port change takes effect without restart):
   - Track server PID before change
   - Change adapter port
   - Verify server PID unchanged (no full restart)
   - Verify new port is active

5. **ADP-07 Adapter restart** (stop/start cleanly):
   - Disable adapter
   - Re-enable adapter
   - Verify clean operation (no errors, adapter functional)

6. **ADP-08 Invalid config rejection**:
   - Try to enable adapter on invalid port (e.g., negative, > 65535)
   - Verify error returned with clear message
   - Try to enable unknown adapter type
   - Verify error returned

Key implementation notes:
- Run tests sequentially (not t.Parallel()) to avoid port conflicts
- Use unique ports via helpers.FindFreePort() when enabling adapters
- Use WaitForAdapterStatus for async operations
- Clean up adapter state after each test
  </action>
  <verify>
Run `go test -tags=e2e -v ./test/e2e/ -run TestAdapterLifecycle -count=1` with a running server to verify tests pass.
  </verify>
  <done>
All 8 ADP requirements covered by tests. Tests pass with a clean server. Test file has //go:build e2e tag.
  </done>
</task>

</tasks>

<verification>
1. `go build ./test/e2e/helpers/` compiles successfully
2. `go vet ./test/e2e/...` passes
3. `go test -tags=e2e -v ./test/e2e/ -run TestAdapterLifecycle` passes
4. Each ADP requirement (01-08) has at least one test covering it
</verification>

<success_criteria>
- Adapter type and CLIRunner methods exist in cli.go
- adapters_test.go exists with TestAdapterLifecycle suite
- All ADP-01 through ADP-08 requirements have test coverage
- Tests run successfully against a fresh server
</success_criteria>

<output>
After completion, create `.planning/phases/05-adapters-auxiliary/05-01-SUMMARY.md`
</output>
