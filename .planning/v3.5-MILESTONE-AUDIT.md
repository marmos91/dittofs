---
milestone: v3.5
audited: 2026-02-25T12:00:00Z
status: gaps_found
scores:
  requirements: 2/6
  phases: 1/4
  integration: 6/7
  flows: 6/7
gaps:
  requirements:
    - id: "REF-03"
      status: "unsatisfied"
      phase: "27"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 27 (NFS Adapter Restructuring) has no directory, no plans, no implementation"
    - id: "REF-04"
      status: "unsatisfied"
      phase: "28"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 28 (SMB Adapter Restructuring) has no directory, no plans, no implementation"
    - id: "REF-05"
      status: "unsatisfied"
      phase: "29"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 29 (Core Layer Decomposition) has no directory, no plans, no implementation"
    - id: "REF-06"
      status: "unsatisfied"
      phase: "29"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "missing"
      evidence: "Phase 29 (Code Quality Improvements) has no directory, no plans, no implementation"
  integration:
    - from: "Phase 26 (NFS v3 handlers)"
      to: "Phase 26 (LockManager)"
      issue: "4 TODO placeholders in NFS v3 handlers (write.go, read.go, remove.go, rename.go) — cross-protocol oplock break calls not wired"
      requirements: ["REF-01.5", "REF-02.2"]
  flows:
    - name: "Cross-Protocol Oplock Break"
      breaks_at: "NFS v3 WRITE/READ/REMOVE/RENAME handlers — TODO placeholders instead of CheckAndBreakOpLocksFor*() calls"
      requirements: ["REF-01.5", "REF-01.8"]
tech_debt:
  - phase: 26-generic-lock-interface-protocol-leak-purge
    items:
      - "TODO: 4 NFS v3 handler placeholders for cross-protocol oplock break (write.go:368, read.go:323, remove.go:279, rename.go:395)"
      - "TODO: SMB adapter BreakCallbacks registration (smb_adapter.go:187)"
      - "Partial: REF-01.8 SMB adapter translation layer not explicitly verified"
      - "Partial: REF-01.9 NFSv4 adapter translation layer not explicitly verified"
      - "Stale: REQUIREMENTS.md traceability table shows REF-01 as 'Not started' and REF-02 as '3/11 done' — both are actually complete"
---

# v3.5 Milestone Audit: Adapter + Core Refactoring

**Audited:** 2026-02-25T12:00:00Z
**Status:** gaps_found
**Score:** 2/6 requirements satisfied

## Milestone Scope

**Goal:** Clean separation of protocol-specific code from generic layers, unified lock model, restructured NFS/SMB adapters with shared infrastructure, and decomposed core objects.

**Phases:**
| Phase | Name | Status | Verified |
|-------|------|--------|----------|
| 26 | Generic Lock Interface & Protocol Leak Purge | Complete | PASSED (10/10) |
| 27 | NFS Adapter Restructuring | Not started | N/A |
| 28 | SMB Adapter Restructuring | Not started | N/A |
| 29 | Core Layer Decomposition | Not started | N/A |

## Requirements Coverage (3-Source Cross-Reference)

### Source 1: Phase VERIFICATION.md

| Requirement | Phase | VERIFICATION Status | Evidence |
|-------------|-------|-------------------|----------|
| REF-01 | 26 | passed (10/10 sub-reqs, 2 partial) | 26-VERIFICATION.md confirms all truths |
| REF-02 | 26 | passed (11/11 sub-reqs) | 26-VERIFICATION.md confirms all truths |
| REF-03 | 27 | missing | No phase directory exists |
| REF-04 | 28 | missing | No phase directory exists |
| REF-05 | 29 | missing | No phase directory exists |
| REF-06 | 29 | missing | No phase directory exists |

### Source 2: SUMMARY.md Frontmatter

Phase 26 SUMMARY files (26-01 through 26-05) do not include `requirements-completed` frontmatter fields. Requirements coverage derived from `provides:` sections and VERIFICATION.md cross-check.

### Source 3: REQUIREMENTS.md Traceability Table

| Requirement | Traceability Status | Actual Status | Note |
|-------------|-------------------|---------------|------|
| REF-01 | "Not started" | **Satisfied** | Traceability table is stale |
| REF-02 | "In progress (3/11)" | **Satisfied** | Traceability table is stale |
| REF-03 | "Not started" | **Unsatisfied** | Accurate |
| REF-04 | "Not started" | **Unsatisfied** | Accurate |
| REF-05 | "Not started" | **Unsatisfied** | Accurate |
| REF-06 | "Not started" | **Unsatisfied** | Accurate |

### Final Status Determination

| REQ-ID | VERIFICATION | SUMMARY | REQUIREMENTS.md | Final Status |
|--------|-------------|---------|-----------------|--------------|
| REF-01 | passed | (no field) | stale | **satisfied** |
| REF-02 | passed | (no field) | stale | **satisfied** |
| REF-03 | missing | missing | Not started | **unsatisfied** |
| REF-04 | missing | missing | Not started | **unsatisfied** |
| REF-05 | missing | missing | Not started | **unsatisfied** |
| REF-06 | missing | missing | Not started | **unsatisfied** |

**Orphaned Requirements:** None. All 6 requirements are assigned to phases in the ROADMAP.

## Phase 26 Verification Summary

**Status:** PASSED with tech debt

Phase 26 achieved its core goal: generic layers are now protocol-agnostic. All 10 success criteria verified:

1. UnifiedLock renamed with OpLock and AccessMode
2. SMB lock types removed from pkg/metadata/lock/
3. SMB lease methods removed from MetadataService
4. NLM methods moved to NFS adapter
5. GracePeriodManager stays generic
6. Share model cleaned of protocol-specific fields
7. SquashMode/Netgroup/IdentityMapping extracted
8. NFS-specific API handlers, runtime fields, pkg/identity/ moved
9. All existing tests pass
10. Centralized conflict detection handles all 4 cases

**Sub-requirement coverage:** 21/21 (19 complete, 2 partial — REF-01.8/REF-01.9 adapter translation layers)

## Integration Check Results

**Checker:** gsd-integration-checker (sonnet)

### Internal Wiring (Phase 26)

| Connection | Status |
|-----------|--------|
| UnifiedLock → Manager.AddUnifiedLock → NLM/SMB handlers | WIRED |
| ShareAdapterConfig → Store CRUD → Runtime.LoadSharesFromStore | WIRED |
| LockManager interface → NLMService, SMB adapter | WIRED |
| NLMService → NLM handlers via NLMLockService | WIRED |
| MountTracker → Runtime, API router | WIRED |
| NFS identity → pkg/adapter/nfs/identity/ | WIRED |
| NFS v3 handlers → LockManager break calls | **BROKEN** (TODO placeholders) |

### E2E Flows

| Flow | Status | Break Point |
|------|--------|------------|
| NLM Lock Acquisition | Complete | — |
| Share Adapter Config Creation | Complete | — |
| Unified Mount Tracking | Complete | — |
| NFS v3 READ/WRITE path | Complete | — |
| API route access (JWT protected) | Complete | — |
| Identity resolution (NFS) | Complete | — |
| Cross-Protocol Oplock Break | **BROKEN** | NFS v3 handlers have TODO placeholders instead of calling LockManager |

### Cross-Phase Readiness

Phase 26 leaves clean extension points for future phases:
- LockManager interface is stable and generic
- ShareAdapterConfig pattern supports new adapter types
- /adapters/{type}/ API route pattern established
- NFS identity is self-contained in pkg/adapter/nfs/identity/

## Tech Debt

### Phase 26

| Item | Location | Severity |
|------|----------|----------|
| Cross-protocol oplock break not wired | write.go:368, read.go:323, remove.go:279, rename.go:395 | Medium |
| SMB BreakCallbacks not registered | smb_adapter.go:187 | Medium |
| REF-01.8 SMB translation layer partial | pkg/adapter/smb/ | Low |
| REF-01.9 NFSv4 translation layer partial | internal/protocol/nfs/v4/ | Low |
| REQUIREMENTS.md traceability table stale | .planning/REQUIREMENTS.md | Low |

**Total:** 5 items in 1 phase

## Unsatisfied Requirements

### REF-03: NFS Adapter Restructuring (Phase 27)
- `internal/protocol/` not renamed to `internal/adapter/`
- Generic XDR, NLM, NSM, portmapper not consolidated
- No dispatch consolidation, no v4/v4.1 split
- 0/11 sub-requirements satisfied

### REF-04: SMB Adapter Restructuring (Phase 28)
- No BaseAdapter extracted
- No framing/signing/dispatch restructuring
- No Authenticator interface
- 0/11 sub-requirements satisfied

### REF-05: Core Object Decomposition (Phase 29)
- Store interface not decomposed (still 60+ methods)
- Runtime not split (still 1,258 lines)
- TransferManager not renamed to Offloader
- 0/8 sub-requirements satisfied

### REF-06: Code Quality Improvements (Phase 29)
- No structured PayloadError type
- No generic GORM helpers
- file.go (1,217 lines) and authentication.go (796 lines) not split
- 0/9 sub-requirements satisfied

---

_Audited: 2026-02-25T12:00:00Z_
_Auditor: Claude (audit-milestone workflow)_
