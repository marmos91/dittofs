---
milestone: v4.2
name: "NFSv4.1 Sessions (v3.0)"
audited: 2026-02-21T12:00:00Z
status: gaps_found
scores:
  requirements: 8/32
  phases: 4/10
  integration: 9/10
  flows: 3/4
gaps:
  requirements:
    - id: "SESS-04"
      status: "orphaned"
      phase: "Phase 20"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 20 not started — no directory, no plans, no code"
    - id: "COEX-01"
      status: "orphaned"
      phase: "Phase 20"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 20 not started — v4.1 dispatch routing exists from Phase 16 but SEQUENCE enforcement missing"
    - id: "COEX-02"
      status: "orphaned"
      phase: "Phase 20"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 20 not started"
    - id: "COEX-03"
      status: "orphaned"
      phase: "Phase 20"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 20 not started"
    - id: "BACK-01"
      status: "orphaned"
      phase: "Phase 22"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 22 not started"
    - id: "BACK-02"
      status: "orphaned"
      phase: "Phase 21"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 21 not started"
    - id: "BACK-03"
      status: "orphaned"
      phase: "Phase 22"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 22 not started"
    - id: "BACK-04"
      status: "orphaned"
      phase: "Phase 22"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 22 not started"
    - id: "TRUNK-01"
      status: "orphaned"
      phase: "Phase 21"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 21 not started"
    - id: "LIFE-01"
      status: "orphaned"
      phase: "Phase 23"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 23 not started"
    - id: "LIFE-02"
      status: "orphaned"
      phase: "Phase 23"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 23 not started"
    - id: "LIFE-03"
      status: "orphaned"
      phase: "Phase 23"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 23 not started"
    - id: "LIFE-04"
      status: "orphaned"
      phase: "Phase 23"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 23 not started"
    - id: "LIFE-05"
      status: "orphaned"
      phase: "Phase 23"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 23 not started"
    - id: "DDELEG-01"
      status: "orphaned"
      phase: "Phase 24"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 24 not started"
    - id: "DDELEG-02"
      status: "orphaned"
      phase: "Phase 24"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 24 not started"
    - id: "DDELEG-03"
      status: "orphaned"
      phase: "Phase 24"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 24 not started"
    - id: "SMBKRB-01"
      status: "orphaned"
      phase: "Phase 25"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 25 not started"
    - id: "SMBKRB-02"
      status: "orphaned"
      phase: "Phase 25"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 25 not started"
    - id: "TEST-01"
      status: "orphaned"
      phase: "Phase 25"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 25 not started"
    - id: "TEST-02"
      status: "orphaned"
      phase: "Phase 25"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 25 not started"
    - id: "TEST-03"
      status: "orphaned"
      phase: "Phase 25"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 25 not started"
    - id: "TEST-04"
      status: "orphaned"
      phase: "Phase 25"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 25 not started"
    - id: "TEST-05"
      status: "orphaned"
      phase: "Phase 25"
      claimed_by_plans: []
      completed_by_plans: []
      verification_status: "orphaned"
      evidence: "Phase 25 not started"
  integration:
    - from: "Phase 19 (Session Reaper)"
      to: "NFS Adapter (Serve)"
      issue: "StartSessionReaper() goroutine implemented but never started — sessions for expired clients will leak"
      affected_requirements: ["SESS-03"]
  flows:
    - flow: "Session Reaper Background Cleanup"
      breaks_at: "NFS adapter Serve() never calls StateManager.StartSessionReaper(ctx)"
      affected_requirements: ["SESS-03"]
tech_debt:
  - phase: "18-exchange-id-and-client-registration"
    items:
      - "TODO in v41_client.go:326 — forward reference to Phase 19 sessions in EvictV41Client (now resolved, TODO can be removed)"
  - phase: "19-session-lifecycle"
    items:
      - "V4MaxSessionSlots/V4MaxSessionsPerClient config fields added but not wired to StateManager (settings watcher deferred)"
      - "Session reaper StartSessionReaper() never called in NFS adapter Serve() — memory leak risk"
  - phase: "v2.0-inherited"
    items:
      - "DEBT-01: ACL enforcement in metadata CheckAccess (deferred from v2.0)"
      - "DEBT-02: Delegation Prometheus metrics (log scraping workaround in v2.0)"
      - "DEBT-03: Netgroup mount enforcement (CRUD works, enforcement deferred)"
---

# Milestone Audit: v4.2 — NFSv4.1 Sessions (v3.0)

**Audited:** 2026-02-21
**Status:** gaps_found (milestone in progress — 4/10 phases complete)

## Executive Summary

Milestone v3.0 "NFSv4.1 Sessions" has completed 4 of 10 phases, delivering the session infrastructure foundation: types/XDR (Phase 16), slot tables (Phase 17), EXCHANGE_ID client registration (Phase 18), and CREATE_SESSION/DESTROY_SESSION lifecycle (Phase 19). All completed phases passed verification with excellent scores. Cross-phase integration is strong with 1 gap (session reaper not started). **24 requirements remain unsatisfied** in unstarted phases 20-25.

## Requirements Coverage (3-Source Cross-Reference)

### Satisfied (8/32)

| REQ-ID | Description | Phase | VERIFICATION | SUMMARY | REQUIREMENTS | Status |
|--------|-------------|-------|-------------|---------|--------------|--------|
| SESS-01 | EXCHANGE_ID client registration with owner/impl tracking | Phase 18 | passed | listed | [x] | **satisfied** |
| SESS-02 | CREATE_SESSION with negotiated channel attributes | Phase 19 | passed | listed | [x] | **satisfied** |
| SESS-03 | DESTROY_SESSION tears down sessions | Phase 19 | passed | listed | [x] | **satisfied** |
| SESS-05 | NFSv4.1 constants, types, XDR structures | Phase 16 | passed | listed | [x] | **satisfied** |
| EOS-01 | Slot table caches COMPOUND response for replay | Phase 17 | passed | listed | [x] | **satisfied** |
| EOS-02 | Sequence ID validation (retries, misordered, stale) | Phase 17 | passed | listed | [x] | **satisfied** |
| EOS-03 | Dynamic slot count via target_highest_slotid | Phase 17 | passed | listed | [x] | **satisfied** |
| TRUNK-02 | Consistent server_owner for trunking detection | Phase 18 | passed | listed | [x] | **satisfied** |

### Unsatisfied (24/32) — All in Unstarted Phases

| REQ-ID | Description | Assigned Phase | Reason |
|--------|-------------|---------------|--------|
| SESS-04 | SEQUENCE as gating operation with lease renewal | Phase 20 | Not started |
| COEX-01 | v4.0/v4.1 COMPOUND routing with SEQUENCE enforcement | Phase 20 | Not started |
| COEX-02 | v4.0 clients work unchanged with v4.1 enabled | Phase 20 | Not started |
| COEX-03 | Per-owner seqid bypassed for v4.1 | Phase 20 | Not started |
| BACK-01 | CB_SEQUENCE over existing TCP | Phase 22 | Not started |
| BACK-02 | BIND_CONN_TO_SESSION | Phase 21 | Not started |
| BACK-03 | BACKCHANNEL_CTL | Phase 22 | Not started |
| BACK-04 | CB_RECALL over backchannel for v4.1 | Phase 22 | Not started |
| TRUNK-01 | Multiple connections per session | Phase 21 | Not started |
| LIFE-01 | DESTROY_CLIENTID | Phase 23 | Not started |
| LIFE-02 | RECLAIM_COMPLETE | Phase 23 | Not started |
| LIFE-03 | FREE_STATEID | Phase 23 | Not started |
| LIFE-04 | TEST_STATEID | Phase 23 | Not started |
| LIFE-05 | v4.0-only ops return NOTSUPP for v4.1 | Phase 23 | Not started |
| DDELEG-01 | GET_DIR_DELEGATION | Phase 24 | Not started |
| DDELEG-02 | CB_NOTIFY for directory changes | Phase 24 | Not started |
| DDELEG-03 | Directory delegation state tracking | Phase 24 | Not started |
| SMBKRB-01 | SMB SPNEGO/Kerberos via shared layer | Phase 25 | Not started |
| SMBKRB-02 | Kerberos principal maps to identity for SMB | Phase 25 | Not started |
| TEST-01 | E2E with Linux NFS client vers=4.1 | Phase 25 | Not started |
| TEST-02 | EOS replay verification E2E | Phase 25 | Not started |
| TEST-03 | Backchannel delegation recall E2E | Phase 25 | Not started |
| TEST-04 | v4.0/v4.1 coexistence E2E | Phase 25 | Not started |
| TEST-05 | Directory delegation notification E2E | Phase 25 | Not started |

## Phase Verification Status

| Phase | Name | Verification | Score | Status |
|-------|------|-------------|-------|--------|
| 16 | NFSv4.1 Types and Constants | 16-VERIFICATION.md | 9/9 | **PASSED** |
| 17 | Slot Table and Session Data Structures | 17-VERIFICATION.md | 4/4 | **PASSED** |
| 18 | EXCHANGE_ID and Client Registration | 18-VERIFICATION.md | 11/11 | **PASSED** |
| 19 | Session Lifecycle | 19-VERIFICATION.md | 8/8 | **PASSED** |
| 20 | SEQUENCE and COMPOUND Bifurcation | — | — | Not started |
| 21 | Connection Management and Trunking | — | — | Not started |
| 22 | Backchannel Multiplexing | — | — | Not started |
| 23 | Client Lifecycle and Cleanup | — | — | Not started |
| 24 | Directory Delegations | — | — | Not started |
| 25 | v3.0 Integration Testing | — | — | Not started |

## Cross-Phase Integration (Completed Phases 16-19)

### Verified Connections (9/10)

| From | To | Via | Status |
|------|----|----|--------|
| Phase 16 (types) | Phase 17 (session) | SessionId4, ChannelAttrs imports | **WIRED** |
| Phase 16 (types) | Phase 18 (EXCHANGE_ID) | ExchangeIdArgs/Res types | **WIRED** |
| Phase 16 (types) | Phase 19 (CREATE_SESSION) | CreateSessionArgs/Res types | **WIRED** |
| Phase 16 (dispatch) | Phase 18/19 (handlers) | v41DispatchTable registration | **WIRED** |
| Phase 17 (slot table) | Phase 19 (CREATE_SESSION) | NewSession -> SlotTable | **WIRED** |
| Phase 18 (EXCHANGE_ID) | Phase 19 (CREATE_SESSION) | V41ClientRecord lookup | **WIRED** |
| Phase 19 (StateManager) | REST API | ListSessions, ForceDestroy routes | **WIRED** |
| Phase 19 (REST API) | dfsctl CLI | apiclient methods | **WIRED** |
| NFS Adapter | API | SetNFSClientProvider -> /health | **WIRED** |

### Integration Gap (1)

| From | To | Issue | Severity |
|------|----|----|----------|
| Phase 19 Session Reaper | NFS Adapter Serve() | `StartSessionReaper()` implemented but never called — expired sessions leak | **CRITICAL** |

**Fix:** Add 1 line in `pkg/adapter/nfs/nfs_adapter.go:Serve()` after NSM startup:
```go
if s.v4Handler != nil && s.v4Handler.StateManager != nil {
    s.v4Handler.StateManager.StartSessionReaper(ctx)
}
```

## E2E Flows

| Flow | Path | Status |
|------|------|--------|
| NFSv4.1 Client Registration | COMPOUND -> dispatchV41 -> handleExchangeID -> StateManager.ExchangeID -> API /clients | **COMPLETE** |
| Session Creation | COMPOUND -> handleCreateSession -> StateManager.CreateSession -> NewSession -> slot tables | **COMPLETE** |
| Session Destruction | COMPOUND -> handleDestroySession -> StateManager.DestroySession -> cleanup maps | **COMPLETE** |
| Session Reaper Cleanup | StartSessionReaper -> reapExpiredSessions -> purgeV41Client | **BROKEN** (reaper never started) |

## Tech Debt

### Phase 18: EXCHANGE_ID
- Stale TODO in `v41_client.go:326` — forward reference to Phase 19 sessions in EvictV41Client (Phase 19 now complete, TODO should be cleaned up)

### Phase 19: Session Lifecycle
- `V4MaxSessionSlots`/`V4MaxSessionsPerClient` config fields added but not wired to StateManager (settings watcher deferred)
- **Session reaper never started** — `StartSessionReaper()` exists but `Serve()` doesn't call it

### Inherited from v2.0
- DEBT-01: ACL enforcement in metadata CheckAccess
- DEBT-02: Delegation Prometheus metrics (log scraping workaround)
- DEBT-03: Netgroup mount enforcement (CRUD works, enforcement deferred)

## Anti-Patterns

| Phase | Issues Found |
|-------|-------------|
| 16 | None |
| 17 | None |
| 18 | 1 info-level TODO (forward reference, not a blocker) |
| 19 | None |

## Conclusion

The completed foundation (Phases 16-19) is solid with 32/32 success criteria passing across all 4 phases, excellent cross-phase integration, and comprehensive test coverage (55+ tests passing with `-race`). One critical integration gap (session reaper startup) should be fixed in the next phase. **24 requirements remain in 6 unstarted phases** (20-25) — the milestone is approximately 25% complete.

---
*Audited: 2026-02-21*
*Previous audit: 2026-02-20 (2 phases complete, 4/32 requirements)*
*Auditor: Claude (gsd-audit-milestone)*
