# POSIX Compliance Tests for DittoFS
#
# Runs pjdfstest (8,789 tests) to validate filesystem behavior against POSIX standards.
# Tests all metadata store backends: Memory, BadgerDB, PostgreSQL.

name: POSIX Compliance Tests

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [develop, main]
  schedule:
    # Nightly at 4 AM UTC
    - cron: '0 4 * * *'
  workflow_dispatch:

env:
  DITTOFS_MOUNT: /tmp/dittofs-test

jobs:
  posix-memory:
    name: Memory Store
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Install NFS client utilities
        run: sudo apt-get update && sudo apt-get install -y nfs-common

      - name: Build DittoFS
        run: nix develop .#ci --command go build -o dittofs cmd/dittofs/main.go

      - name: Start DittoFS (Memory)
        run: |
          ./dittofs start --config test/posix/configs/config-memory.yaml &
          sleep 3
          nc -zv localhost 12049 || (echo "DittoFS failed to start"; exit 1)

      - name: Mount NFS share
        run: |
          sudo mkdir -p $DITTOFS_MOUNT
          sudo mount -t nfs -o nfsvers=3,tcp,port=12049,mountport=12049,nolock,actimeo=0 \
            localhost:/export $DITTOFS_MOUNT
          mount | grep dittofs-test

      - name: Run POSIX tests
        run: |
          PJDFSTEST=$(nix build .#pjdfstest --print-out-paths)
          TESTS_DIR="$PJDFSTEST/share/pjdfstest/tests"

          cd $DITTOFS_MOUNT
          sudo env PATH="$PJDFSTEST/bin:$PATH" prove -rv --timer "$TESTS_DIR" \
            2>&1 | tee ~/posix-memory.log || true

          # Extract summary
          echo "## Memory Store Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -30 ~/posix-memory.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Verify pass rate
        run: |
          # Expected: 8788/8789 pass (1 known failure: utimensat/09.t test 5 - NFSv3 timestamp limit)
          if grep -q "All tests successful" ~/posix-memory.log; then
            echo "✓ All tests passed!"
          elif grep -q "Failed 1/" ~/posix-memory.log; then
            echo "✓ Expected failure count (1 test - NFSv3 timestamp limit)"
          else
            echo "✗ Unexpected test failures detected!"
            echo "::error::POSIX tests failed with more than 1 expected failure"
            tail -50 ~/posix-memory.log
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          sudo umount $DITTOFS_MOUNT || true
          pkill dittofs || true

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: posix-memory-results
          path: ~/posix-memory.log
          retention-days: 30

  posix-badger:
    name: BadgerDB Store
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Install NFS client utilities
        run: sudo apt-get update && sudo apt-get install -y nfs-common

      - name: Build DittoFS
        run: nix develop .#ci --command go build -o dittofs cmd/dittofs/main.go

      - name: Start DittoFS (BadgerDB)
        run: |
          ./dittofs start --config test/posix/configs/config-badger.yaml &
          sleep 3
          nc -zv localhost 12049 || (echo "DittoFS failed to start"; exit 1)

      - name: Mount NFS share
        run: |
          sudo mkdir -p $DITTOFS_MOUNT
          sudo mount -t nfs -o nfsvers=3,tcp,port=12049,mountport=12049,nolock,actimeo=0 \
            localhost:/export $DITTOFS_MOUNT
          mount | grep dittofs-test

      - name: Run POSIX tests
        run: |
          PJDFSTEST=$(nix build .#pjdfstest --print-out-paths)
          TESTS_DIR="$PJDFSTEST/share/pjdfstest/tests"

          cd $DITTOFS_MOUNT
          sudo env PATH="$PJDFSTEST/bin:$PATH" prove -rv --timer "$TESTS_DIR" \
            2>&1 | tee ~/posix-badger.log || true

          echo "## BadgerDB Store Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -30 ~/posix-badger.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Verify pass rate
        run: |
          # Expected: 8788/8789 pass (1 known failure: utimensat/09.t test 5 - NFSv3 timestamp limit)
          if grep -q "All tests successful" ~/posix-badger.log; then
            echo "✓ All tests passed!"
          elif grep -q "Failed 1/" ~/posix-badger.log; then
            echo "✓ Expected failure count (1 test - NFSv3 timestamp limit)"
          else
            echo "✗ Unexpected test failures detected!"
            echo "::error::POSIX tests failed with more than 1 expected failure"
            tail -50 ~/posix-badger.log
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          sudo umount $DITTOFS_MOUNT || true
          pkill dittofs || true
          rm -rf /tmp/dittofs-metadata-badger /tmp/dittofs-content-badger || true

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: posix-badger-results
          path: ~/posix-badger.log
          retention-days: 30

  posix-postgres:
    name: PostgreSQL Store
    runs-on: ubuntu-latest
    timeout-minutes: 60

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: dittofs
          POSTGRES_PASSWORD: dittofs
          POSTGRES_DB: dittofs_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Install NFS client utilities
        run: sudo apt-get update && sudo apt-get install -y nfs-common

      - name: Build DittoFS
        run: nix develop .#ci --command go build -o dittofs cmd/dittofs/main.go

      - name: Start DittoFS (PostgreSQL)
        run: |
          ./dittofs start --config test/posix/configs/config-postgres.yaml &
          sleep 5
          nc -zv localhost 12049 || (echo "DittoFS failed to start"; exit 1)

      - name: Mount NFS share
        run: |
          sudo mkdir -p $DITTOFS_MOUNT
          sudo mount -t nfs -o nfsvers=3,tcp,port=12049,mountport=12049,nolock,actimeo=0 \
            localhost:/export $DITTOFS_MOUNT
          mount | grep dittofs-test

      - name: Run POSIX tests
        run: |
          PJDFSTEST=$(nix build .#pjdfstest --print-out-paths)
          TESTS_DIR="$PJDFSTEST/share/pjdfstest/tests"

          cd $DITTOFS_MOUNT
          sudo env PATH="$PJDFSTEST/bin:$PATH" prove -rv --timer "$TESTS_DIR" \
            2>&1 | tee ~/posix-postgres.log || true

          echo "## PostgreSQL Store Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -30 ~/posix-postgres.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Verify pass rate
        run: |
          # Expected: 8788/8789 pass (1 known failure: utimensat/09.t test 5 - NFSv3 timestamp limit)
          if grep -q "All tests successful" ~/posix-postgres.log; then
            echo "✓ All tests passed!"
          elif grep -q "Failed 1/" ~/posix-postgres.log; then
            echo "✓ Expected failure count (1 test - NFSv3 timestamp limit)"
          else
            echo "✗ Unexpected test failures detected!"
            echo "::error::POSIX tests failed with more than 1 expected failure"
            tail -50 ~/posix-postgres.log
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          sudo umount $DITTOFS_MOUNT || true
          pkill dittofs || true

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: posix-postgres-results
          path: ~/posix-postgres.log
          retention-days: 30

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [posix-memory, posix-badger, posix-postgres]
    if: always()

    steps:
      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          path: results

      - name: Generate summary
        run: |
          echo "# POSIX Compliance Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Store | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          for store in memory badger postgres; do
            if [ -f "results/posix-${store}-results/posix-${store}.log" ]; then
              if grep -q "All tests successful" "results/posix-${store}-results/posix-${store}.log" || \
                 grep -q "Failed 1/" "results/posix-${store}-results/posix-${store}.log"; then
                echo "| ${store^} | :white_check_mark: Pass |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| ${store^} | :x: Fail |" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "| ${store^} | :warning: No results |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Expected: 8788/8789 tests pass (99.99%)" >> $GITHUB_STEP_SUMMARY
          echo "Known failure: utimensat/09.t test #5 (NFSv3 32-bit timestamp limit)" >> $GITHUB_STEP_SUMMARY
