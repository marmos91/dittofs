# End-to-End Tests for DittoFS
#
# Tests aspects NOT covered by pjdfstest POSIX compliance:
# - Scalability (large files, many files)
# - Store interoperability (all 8 configurations)
# - Protocol interoperability (NFSâ†”SMB)
# - Cache behavior
# - Server configurations
#
# See test/e2e/README.md for test philosophy and structure.

name: E2E Tests

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [develop, main]
  workflow_dispatch:
    inputs:
      mode:
        description: 'Test mode'
        required: true
        default: 'quick'
        type: choice
        options:
          - quick
          - full

jobs:
  # Quick e2e tests - runs on every PR (skip when full mode explicitly requested)
  e2e-quick:
    name: E2E Quick (Local Configs)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.mode == 'quick'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nfs-common cifs-utils smbclient

      - name: Build DittoFS
        run: nix develop .#ci --command go build -o dittofs cmd/dittofs/main.go

      - name: Run E2E tests (Quick mode)
        run: |
          # Quick mode: local configs only, smaller file sizes
          sudo nix develop .#ci --command go test -tags=e2e -v -short -timeout 10m ./test/e2e/... \
            2>&1 | tee "$GITHUB_WORKSPACE/e2e-quick.log"

      - name: Generate summary
        if: always()
        run: |
          echo "## E2E Quick Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if grep -qE "^ok[[:space:]]" "$GITHUB_WORKSPACE/e2e-quick.log" && ! grep -qE "^FAIL" "$GITHUB_WORKSPACE/e2e-quick.log"; then
            echo ":white_check_mark: All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo ":x: Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Test Output (last 100 lines)</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -100 "$GITHUB_WORKSPACE/e2e-quick.log" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-quick-logs
          path: ${{ github.workspace }}/e2e-quick.log
          retention-days: 7

  # Full e2e tests - runs on PRs, main branch, and on-demand
  e2e-full:
    name: E2E Full (All Configs)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    # Run on: PRs, pushes to main/develop, or workflow_dispatch with mode=full
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'full')

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: dittofs
          POSTGRES_PASSWORD: dittofs
          POSTGRES_DB: dittofs_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      localstack:
        image: localstack/localstack:3.0
        env:
          SERVICES: s3
          EAGER_SERVICE_LOADING: "1"
          GATEWAY_LISTEN: "0.0.0.0:4566"  # Force HTTP mode (no TLS)
        ports:
          - 4566:4566
        options: >-
          --health-cmd "wget -qO- http://localhost:4566/_localstack/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      # Tell tests to use pre-existing services instead of starting containers
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
      POSTGRES_DATABASE: dittofs_test
      POSTGRES_USER: dittofs
      POSTGRES_PASSWORD: dittofs
      LOCALSTACK_ENDPOINT: http://localhost:4566

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y nfs-common cifs-utils smbclient

      - name: Build DittoFS
        run: nix develop .#ci --command go build -o dittofs cmd/dittofs/main.go

      - name: Run E2E tests (Full mode)
        run: |
          # Full mode: all configurations including Docker-based stores
          # Pass environment variables through sudo for external service detection
          sudo -E nix develop .#ci --command go test -tags=e2e -v -timeout 30m ./test/e2e/... \
            2>&1 | tee "$GITHUB_WORKSPACE/e2e-full.log"

      - name: Generate summary
        if: always()
        run: |
          echo "## E2E Full Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if grep -qE "^ok[[:space:]]" "$GITHUB_WORKSPACE/e2e-full.log" && ! grep -qE "^FAIL" "$GITHUB_WORKSPACE/e2e-full.log"; then
            echo ":white_check_mark: All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo ":x: Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Suites" >> $GITHUB_STEP_SUMMARY
          echo "| Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          for suite in Server Users Groups Shares Permissions MetadataStores PayloadStores Adapters Backup Context FileOperations CrossProtocol StoreMatrix; do
            if grep -q "Test${suite}.*PASS" "$GITHUB_WORKSPACE/e2e-full.log"; then
              echo "| ${suite} | :white_check_mark: |" >> $GITHUB_STEP_SUMMARY
            elif grep -q "Test${suite}.*FAIL" "$GITHUB_WORKSPACE/e2e-full.log"; then
              echo "| ${suite} | :x: |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ${suite} | :grey_question: |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Full Test Output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat "$GITHUB_WORKSPACE/e2e-full.log" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-full-logs
          path: ${{ github.workspace }}/e2e-full.log
          retention-days: 30
