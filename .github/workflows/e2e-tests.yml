# End-to-End Tests for DittoFS
#
# Tests aspects NOT covered by pjdfstest POSIX compliance:
# - Scalability (large files, many files)
# - Store interoperability (all 8 configurations)
# - Protocol interoperability (NFSâ†”SMB)
# - Cache behavior
# - Server configurations
#
# See test/e2e/README.md for test philosophy and structure.

name: E2E Tests

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [develop, main]
  workflow_dispatch:

jobs:
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: dittofs
          POSTGRES_PASSWORD: dittofs
          POSTGRES_DB: dittofs_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      localstack:
        image: localstack/localstack:4.13.1
        env:
          SERVICES: s3
          EAGER_SERVICE_LOADING: "1"
          GATEWAY_LISTEN: "0.0.0.0:4566"
          DISABLE_CORS_CHECKS: "1"
          DISABLE_CUSTOM_CORS_S3: "1"
          DEBUG: "0"
          LOCALSTACK_HOST: localhost:4566
        ports:
          - 4566:4566
        options: >-
          --health-cmd "curl -sf https://localhost:4566/_localstack/health -k || curl -sf http://localhost:4566/_localstack/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    env:
      # Tell tests to use pre-existing services instead of starting containers
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
      POSTGRES_DATABASE: dittofs_test
      POSTGRES_USER: dittofs
      POSTGRES_PASSWORD: dittofs
      LOCALSTACK_ENDPOINT: http://localhost:4566

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Install system dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get install -y nfs-common cifs-utils smbclient krb5-user
          # Start rpc-gssd for Kerberos NFS tests
          sudo systemctl start rpc-gssd || true

      - name: Build DittoFS
        run: nix develop .#ci --command go build -o dfs cmd/dfs/main.go

      - name: Run E2E tests
        run: |
          # Full mode: all configurations including Docker-based stores
          # Pass environment variables through sudo for external service detection
          sudo -E nix develop .#ci --command go test -tags=e2e -v -timeout 30m ./test/e2e/... \
            2>&1 | tee "$GITHUB_WORKSPACE/e2e.log"

      - name: Generate summary
        if: always()
        run: |
          echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if grep -qE "^ok[[:space:]]" "$GITHUB_WORKSPACE/e2e.log" && ! grep -qE "^FAIL" "$GITHUB_WORKSPACE/e2e.log"; then
            echo ":white_check_mark: All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo ":x: Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Suites" >> $GITHUB_STEP_SUMMARY
          echo "| Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          for suite in Server Users Groups Shares Permissions MetadataStores PayloadStores Adapters Portmapper Backup Context FileOperations CrossProtocol StoreMatrix Kerberos; do
            if grep -q "Test${suite}.*PASS" "$GITHUB_WORKSPACE/e2e.log"; then
              echo "| ${suite} | :white_check_mark: |" >> $GITHUB_STEP_SUMMARY
            elif grep -q "Test${suite}.*FAIL" "$GITHUB_WORKSPACE/e2e.log"; then
              echo "| ${suite} | :x: |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| ${suite} | :grey_question: |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Full Test Output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat "$GITHUB_WORKSPACE/e2e.log" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs
          path: ${{ github.workspace }}/e2e.log
          retention-days: 30
