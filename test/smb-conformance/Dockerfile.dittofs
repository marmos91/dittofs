# DittoFS Docker image for SMB Conformance Testing
# Extends the production Dockerfile to include both dfs and dfsctl binaries.
# dfsctl is needed by bootstrap.sh to create stores, shares, and users.

# Build stage
FROM --platform=$BUILDPLATFORM golang:1.25-alpine AS builder

# Build arguments for cross-compilation
ARG TARGETOS
ARG TARGETARCH

# Build arguments for version info
ARG VERSION=dev
ARG COMMIT=unknown
ARG BUILD_DATE=unknown

RUN apk add --no-cache git ca-certificates tzdata

WORKDIR /build

# Copy dependency files first for better layer caching
COPY go.mod go.sum ./
RUN go mod download

COPY . .

# Build both binaries in a single layer to share compiler cache
RUN CGO_ENABLED=0 GOOS=${TARGETOS:-linux} GOARCH=${TARGETARCH:-amd64} go build \
    -ldflags="-w -s -X main.version=${VERSION} -X main.commit=${COMMIT} -X main.date=${BUILD_DATE}" \
    -o dfs cmd/dfs/main.go && \
    CGO_ENABLED=0 GOOS=${TARGETOS:-linux} GOARCH=${TARGETARCH:-amd64} go build \
    -ldflags="-w -s" \
    -o dfsctl cmd/dfsctl/main.go

# Runtime stage - Alpine for healthcheck support via wget
FROM alpine:3.21

LABEL org.opencontainers.image.title="DittoFS (SMB Conformance)" \
      org.opencontainers.image.description="DittoFS with dfs+dfsctl for SMB conformance testing"

RUN apk add --no-cache ca-certificates tzdata curl && \
    addgroup -g 65532 -S dittofs && \
    adduser -u 65532 -S -G dittofs -h /app dittofs

WORKDIR /app

COPY --from=builder --chown=65532:65532 /build/dfs /app/dfs
COPY --from=builder --chown=65532:65532 /build/dfsctl /app/dfsctl

RUN apk add --no-cache libcap && \
    mkdir -p /data/metadata /data/content /data/cache /config && \
    chown -R 65532:65532 /data /config

# Grant CAP_NET_BIND_SERVICE so the non-root user can bind to port 445 (required by WPTS)
RUN setcap cap_net_bind_service=+ep /app/dfs

USER 65532:65532

EXPOSE 445/tcp 8080/tcp
HEALTHCHECK --interval=2s --timeout=5s --start-period=5s --retries=15 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8080/health/ready || exit 1

ENTRYPOINT ["/app/dfs"]
CMD ["start", "--foreground", "--config", "/config/config.yaml"]
